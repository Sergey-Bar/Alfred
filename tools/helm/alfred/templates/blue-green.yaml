#AlfredBlue-GreenDeploymentPipeline#---#───BlueDeployment(SlotA)───────────────────────────────apiVersion:apps/v1kind:Deploymentmetadata:name:alfred-backend-bluenamespace:alfredlabels:app:alfred-backendslot:blueapp.kubernetes.io/name:alfred-backendapp.kubernetes.io/component:backendapp.kubernetes.io/part-of:alfredspec:replicas:2selector:matchLabels:app:alfred-backendslot:bluestrategy:type:RollingUpdaterollingUpdate:maxUnavailable:0maxSurge:1template:metadata:labels:app:alfred-backendslot:blueannotations:prometheus.io/scrape:"true"prometheus.io/port:"8000"prometheus.io/path:"/metrics"spec:serviceAccountName:alfredsecurityContext:runAsNonRoot:truerunAsUser:1000fsGroup:1000terminationGracePeriodSeconds:60containers:-name:backendimage:alfredai/backend:VERSION_BLUEimagePullPolicy:IfNotPresentports:-name:httpcontainerPort:8000protocol:TCPenv:-name:DATABASE_URLvalueFrom:secretKeyRef:name:alfred-secretskey:database-url-name:REDIS_URLvalueFrom:secretKeyRef:name:alfred-secretskey:redis-url-name:JWT_SECRETvalueFrom:secretKeyRef:name:alfred-secretskey:jwt-secret-name:LOG_LEVELvalue:"INFO"-name:WORKERSvalue:"4"-name:SLOTvalue:"blue"readinessProbe:httpGet:path:/healthport:8000initialDelaySeconds:5periodSeconds:5failureThreshold:3livenessProbe:httpGet:path:/healthport:8000initialDelaySeconds:10periodSeconds:10failureThreshold:5startupProbe:httpGet:path:/healthport:8000initialDelaySeconds:3periodSeconds:3failureThreshold:30resources:requests:cpu:500mmemory:512Milimits:cpu:"2"memory:2GisecurityContext:allowPrivilegeEscalation:falsecapabilities:drop:["ALL"]readOnlyRootFilesystem:truevolumeMounts:-name:tmpmountPath:/tmpvolumes:-name:tmpemptyDir:{}---#───GreenDeployment(SlotB)──────────────────────────────apiVersion:apps/v1kind:Deploymentmetadata:name:alfred-backend-greennamespace:alfredlabels:app:alfred-backendslot:greenapp.kubernetes.io/name:alfred-backendapp.kubernetes.io/component:backendapp.kubernetes.io/part-of:alfredspec:replicas:2selector:matchLabels:app:alfred-backendslot:greenstrategy:type:RollingUpdaterollingUpdate:maxUnavailable:0maxSurge:1template:metadata:labels:app:alfred-backendslot:greenannotations:prometheus.io/scrape:"true"prometheus.io/port:"8000"prometheus.io/path:"/metrics"spec:serviceAccountName:alfredsecurityContext:runAsNonRoot:truerunAsUser:1000fsGroup:1000terminationGracePeriodSeconds:60containers:-name:backendimage:alfredai/backend:VERSION_GREENimagePullPolicy:IfNotPresentports:-name:httpcontainerPort:8000protocol:TCPenv:-name:DATABASE_URLvalueFrom:secretKeyRef:name:alfred-secretskey:database-url-name:REDIS_URLvalueFrom:secretKeyRef:name:alfred-secretskey:redis-url-name:JWT_SECRETvalueFrom:secretKeyRef:name:alfred-secretskey:jwt-secret-name:LOG_LEVELvalue:"INFO"-name:WORKERSvalue:"4"-name:SLOTvalue:"green"readinessProbe:httpGet:path:/healthport:8000initialDelaySeconds:5periodSeconds:5failureThreshold:3livenessProbe:httpGet:path:/healthport:8000initialDelaySeconds:10periodSeconds:10failureThreshold:5startupProbe:httpGet:path:/healthport:8000initialDelaySeconds:3periodSeconds:3failureThreshold:30resources:requests:cpu:500mmemory:512Milimits:cpu:"2"memory:2GisecurityContext:allowPrivilegeEscalation:falsecapabilities:drop:["ALL"]readOnlyRootFilesystem:truevolumeMounts:-name:tmpmountPath:/tmpvolumes:-name:tmpemptyDir:{}---#───ProductionService(routestoactiveslot)─────────────#Switchbetweenblue/greenbychangingthe`slot`selectorapiVersion:v1kind:Servicemetadata:name:alfred-backendnamespace:alfredlabels:app:alfred-backendapp.kubernetes.io/name:alfred-backendapp.kubernetes.io/component:backendapp.kubernetes.io/part-of:alfredspec:type:ClusterIPselector:app:alfred-backendslot:blue#←Changeto"green"toswitchtrafficports:-name:httpport:8000targetPort:httpprotocol:TCP---#───GatewayBlueDeployment────────────────────────────────apiVersion:apps/v1kind:Deploymentmetadata:name:alfred-gateway-bluenamespace:alfredlabels:app:alfred-gatewayslot:blueapp.kubernetes.io/name:alfred-gatewayapp.kubernetes.io/component:gatewayapp.kubernetes.io/part-of:alfredspec:replicas:3selector:matchLabels:app:alfred-gatewayslot:bluestrategy:type:RollingUpdaterollingUpdate:maxUnavailable:0maxSurge:1template:metadata:labels:app:alfred-gatewayslot:blueannotations:prometheus.io/scrape:"true"prometheus.io/port:"8080"prometheus.io/path:"/metrics"spec:serviceAccountName:alfredsecurityContext:runAsNonRoot:truerunAsUser:1000terminationGracePeriodSeconds:30containers:-name:gatewayimage:alfredai/gateway:VERSION_BLUEimagePullPolicy:IfNotPresentports:-name:httpcontainerPort:8080protocol:TCPenv:-name:GATEWAY_ADDRvalue:":8080"-name:BACKEND_URLvalue:"http://alfred-backend:8000"-name:DATABASE_URLvalueFrom:secretKeyRef:name:alfred-secretskey:database-url-name:REDIS_URLvalueFrom:secretKeyRef:name:alfred-secretskey:redis-url-name:SLOTvalue:"blue"readinessProbe:httpGet:path:/readyport:8080initialDelaySeconds:3periodSeconds:5failureThreshold:3livenessProbe:httpGet:path:/healthzport:8080initialDelaySeconds:5periodSeconds:10failureThreshold:5resources:requests:cpu:200mmemory:128Milimits:cpu:"1"memory:512MisecurityContext:allowPrivilegeEscalation:falsecapabilities:drop:["ALL"]readOnlyRootFilesystem:true---#───GatewayGreenDeployment───────────────────────────────apiVersion:apps/v1kind:Deploymentmetadata:name:alfred-gateway-greennamespace:alfredlabels:app:alfred-gatewayslot:greenapp.kubernetes.io/name:alfred-gatewayapp.kubernetes.io/component:gatewayapp.kubernetes.io/part-of:alfredspec:replicas:3selector:matchLabels:app:alfred-gatewayslot:greenstrategy:type:RollingUpdaterollingUpdate:maxUnavailable:0maxSurge:1template:metadata:labels:app:alfred-gatewayslot:greenannotations:prometheus.io/scrape:"true"prometheus.io/port:"8080"prometheus.io/path:"/metrics"spec:serviceAccountName:alfredsecurityContext:runAsNonRoot:truerunAsUser:1000terminationGracePeriodSeconds:30containers:-name:gatewayimage:alfredai/gateway:VERSION_GREENimagePullPolicy:IfNotPresentports:-name:httpcontainerPort:8080protocol:TCPenv:-name:GATEWAY_ADDRvalue:":8080"-name:BACKEND_URLvalue:"http://alfred-backend:8000"-name:DATABASE_URLvalueFrom:secretKeyRef:name:alfred-secretskey:database-url-name:REDIS_URLvalueFrom:secretKeyRef:name:alfred-secretskey:redis-url-name:SLOTvalue:"green"readinessProbe:httpGet:path:/readyport:8080initialDelaySeconds:3periodSeconds:5failureThreshold:3livenessProbe:httpGet:path:/healthzport:8080initialDelaySeconds:5periodSeconds:10failureThreshold:5resources:requests:cpu:200mmemory:128Milimits:cpu:"1"memory:512MisecurityContext:allowPrivilegeEscalation:falsecapabilities:drop:["ALL"]readOnlyRootFilesystem:true---#───GatewayProductionService─────────────────────────────apiVersion:v1kind:Servicemetadata:name:alfred-gatewaynamespace:alfredlabels:app:alfred-gatewayapp.kubernetes.io/name:alfred-gatewayapp.kubernetes.io/component:gatewayapp.kubernetes.io/part-of:alfredspec:type:ClusterIPselector:app:alfred-gatewayslot:blue#←Changeto"green"toswitchtrafficports:-name:httpport:8080targetPort:httpprotocol:TCP---#───PodDisruptionBudgets(HAduringrollout)───────────────apiVersion:policy/v1kind:PodDisruptionBudgetmetadata:name:alfred-backend-pdbnamespace:alfredspec:minAvailable:1selector:matchLabels:app:alfred-backend---apiVersion:policy/v1kind:PodDisruptionBudgetmetadata:name:alfred-gateway-pdbnamespace:alfredspec:minAvailable:2selector:matchLabels:app:alfred-gateway