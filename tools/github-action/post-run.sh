#!/bin/bash#set-e#ConfigurationfromenvironmentALFRED_API_KEY="${ALFRED_API_KEY:-}"ALFRED_API_URL="${ALFRED_API_URL:-https://api.alfred.ai}"BUDGET_LIMIT="${ALFRED_BUDGET_LIMIT:-5.00}"FAIL_ON_EXCEEDED="${ALFRED_FAIL_ON_EXCEEDED:-true}"START_BALANCE="${ALFRED_START_BALANCE:-0}"REPORT_USAGE="${REPORT_USAGE:-true}"echo"ðŸ“ŠAlfredCostGate-Post-RunCheck"echo"======================================"#GetcurrentbalanceRESPONSE=$(curl-s\-H"Authorization:Bearer$ALFRED_API_KEY"\-H"Content-Type:application/json"\"$ALFRED_API_URL/v1/wallets/me")END_BALANCE=$(echo"$RESPONSE"|jq-r'.balance//0')#CalculatecostRUN_COST=$(echo"$START_BALANCE-$END_BALANCE"|bc-l)#Handlenegative(refundsorcreditsduringrun)if(($(echo"$RUN_COST<0"|bc-l)));thenRUN_COST="0"fiBUDGET_REMAINING=$(echo"$BUDGET_LIMIT-$RUN_COST"|bc-l)echo"ðŸ’°RunStatistics:"echo"StartBalance:\$$START_BALANCE"echo"EndBalance:\$$END_BALANCE"echo"RunCost:\$$RUN_COST"echo"BudgetLimit:\$$BUDGET_LIMIT"echo"BudgetUsed:$(echo"scale=1;$RUN_COST/$BUDGET_LIMIT*100"|bc)%"#Setoutputsecho"run-cost=$RUN_COST">>$GITHUB_OUTPUTecho"budget-remaining=$BUDGET_REMAINING">>$GITHUB_OUTPUTecho"balance=$END_BALANCE">>$GITHUB_OUTPUT#Checkifbudgetexceededif(($(echo"$RUN_COST>$BUDGET_LIMIT"|bc-l)));thenecho"âš ï¸Budgetexceeded:\$$RUN_COST>\$$BUDGET_LIMIT"echo"status=failed">>$GITHUB_OUTPUTif["$FAIL_ON_EXCEEDED"="true"];thenecho"âŒFailingworkflowduetobudgetexceeded"exit1elseecho"âš ï¸Continuingdespitebudgetexceeded(fail-on-exceeded=false)"fielif(($(echo"$RUN_COST>$BUDGET_LIMIT*0.8"|bc-l)));thenecho"âš ï¸Warning:Used80%+ofbudget"echo"status=warning">>$GITHUB_OUTPUTelseecho"âœ…Budgetcheckpassed"echo"status=passed">>$GITHUB_OUTPUTfi#GeneratePRcommentifinPRcontextif[-n"$GITHUB_EVENT_PATH"]&&["$REPORT_USAGE"="true"];thenPR_NUMBER=$(jq-r'.pull_request.number//empty'"$GITHUB_EVENT_PATH"2>/dev/null||true)if[-n"$PR_NUMBER"];thenecho"ðŸ“PostingusagereporttoPR#$PR_NUMBER..."COMMENT_BODY="##ðŸ¤–AlfredAICostReport|Metric|Value||--------|-------||RunCost|\\\$$RUN_COST||BudgetLimit|\\\$$BUDGET_LIMIT||BudgetRemaining|\\\$$BUDGET_REMAINING||WalletBalance|\\\$$END_BALANCE|---_Generatedby[AlfredCostGate](https://alfred.ai)_"curl-s-XPOST\-H"Authorization:token$GITHUB_TOKEN"\-H"Content-Type:application/json"\-d"{\"body\":\"$COMMENT_BODY\"}"\"https://api.github.com/repos/$GITHUB_REPOSITORY/issues/$PR_NUMBER/comments">/dev/null2>&1||trueecho"âœ…Usagereportposted"fifiecho""echo"âœ…AlfredCostGatecheckcomplete"