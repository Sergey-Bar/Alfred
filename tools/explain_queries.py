"""LightweightEXPLAINbenchmarkforrepresentativequeries.Runlocallywith:`pythontools/explain_queries.py`(ensure`DATABASE_URL`envvarpointstoyourDB)."""importloggingimportosfromsqlalchemyimporttextfromsqlmodelimportcreate_enginelogger=logging.getLogger(__name__)DATABASE_URL=os.environ.get("DATABASE_URL","sqlite:///./dev.db")engine=create_engine(DATABASE_URL,echo=False)QUERIES={"teams_batch_count":"SELECTteam_member_links.team_id,COUNT(team_member_links.user_id)AScntFROMteam_member_linksWHEREteam_member_links.team_idIN(SELECTidFROMteamsLIMIT10)GROUPBYteam_member_links.team_id;","leaderboard_aggregate":"SELECTCAST(request_logs.user_idASTEXT)asuid,SUM(request_logs.prompt_tokens)assum_prompt,SUM(request_logs.completion_tokens)assum_completion,COUNT(request_logs.id)ascntFROMrequest_logsWHERErequest_logs.created_at>=DATE('now','-30days')GROUPBYCAST(request_logs.user_idASTEXT)LIMIT50;","pending_approvals_for_team_admin":"SELECTapproval_request.*FROMapproval_requestWHEREapproval_request.status='pending'ANDapproval_request.user_idIN(SELECTuser_idFROMteam_member_linksWHEREteam_idIN(SELECTteam_idFROMteam_member_linksWHEREuser_id=?));",}defrun_explain(sql:str,params=None):withengine.connect()asconn:try:ifengine.url.drivername.startswith("sqlite"):#SQLiteusesEXPLAINQUERYPLANplan=conn.execute(text("EXPLAINQUERYPLAN"+sql),paramsor{}).fetchall()else:plan=conn.execute(text("EXPLAIN"+sql),paramsor{}).fetchall()returnplanexceptExceptionase:returnf"EXPLAINfailed:{e}"if__name__=="__main__":logger.info("RunningEXPLAINagainst:%s",DATABASE_URL)forname,qinQUERIES.items():logger.info("---%s---",name)plan=run_explain(q,params=None)logger.info("%s",plan)logger.info("Done.")