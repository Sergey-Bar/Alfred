import*asvscodefrom'vscode';consthttps=require('https');consthttp=require('http');interfaceTransfer{id:string;type:'sent'|'received';amount:number;other_user:{id:string;name:string;email:string;};message:string;timestamp:string;}exportfunctionactivateSidebar(context:vscode.ExtensionContext){//TransferHistoryview(existing)context.subscriptions.push(vscode.window.registerWebviewViewProvider('alfredSidebar',newSidebarProvider(context)));//T171:UsageReportviewcontext.subscriptions.push(vscode.window.registerWebviewViewProvider('alfredUsageReport',newUsageReportProvider(context)));//Registerrefreshcommandcontext.subscriptions.push(vscode.commands.registerCommand('alfred.refreshTransferHistory',()=>{//Findtheactivewebviewandrefreshit//Thiswillbehandledbytheprovider}));//T171:Exportusagereportcommandcontext.subscriptions.push(vscode.commands.registerCommand('alfred.exportUsageReport',async()=>{constformat=awaitvscode.window.showQuickPick([{label:'CSV',description:'Comma-separatedvaluesforspreadsheets'},{label:'JSON',description:'Structureddataforautomation'}],{placeHolder:'Selectexportformat'});if(format){vscode.commands.executeCommand('alfred.exportUsageReportAs',format.label.toLowerCase());}}));}classSidebarProviderimplementsvscode.WebviewViewProvider{privatereadonlycontext:vscode.ExtensionContext;privatewebviewView?:vscode.WebviewView;constructor(context:vscode.ExtensionContext){this.context=context;}resolveWebviewView(webviewView:vscode.WebviewView){this.webviewView=webviewView;webviewView.webview.options={enableScripts:true,localResourceRoots:[this.context.extensionUri]};webviewView.webview.html=this.getHtmlContent();//HandlemessagesfromthewebviewwebviewView.webview.onDidReceiveMessage(async(message)=>{switch(message.type){case'refresh':awaitthis.refreshTransferHistory();break;case'error':vscode.window.showErrorMessage(`Alfred:${message.message}`);break;}},undefined,this.context.subscriptions);//Initialloadthis.refreshTransferHistory();}privateasyncrefreshTransferHistory(){if(!this.webviewView)return;try{constconfig=vscode.workspace.getConfiguration('alfred');constapiUrl=config.get<string>('apiUrl','http://localhost:8000');constapiKey=config.get<string>('apiKey');if(!apiKey){this.webviewView.webview.postMessage({type:'error',message:'APIkeynotconfigured.Pleasesetalfred.apiKeyinsettings.'});return;}consturl=newURL(`${apiUrl}/v1/governance/users/me/transfers`);constdata=awaitthis.makeHttpRequest(url,apiKey);this.webviewView.webview.postMessage({type:'transfers',data:data.transfers||[]});}catch(error){this.webviewView.webview.postMessage({type:'error',message:errorinstanceofError?error.message:'Unknownerroroccurred'});}}privateasyncmakeHttpRequest(url:URL,apiKey:string):Promise<any>{returnnewPromise((resolve,reject)=>{constisHttps=url.protocol==='https:';constclient=isHttps?https:http;constoptions={hostname:url.hostname,port:url.port||(isHttps?443:80),path:url.pathname+url.search,method:'GET',headers:{'Authorization':`Bearer${apiKey}`,'Content-Type':'application/json','User-Agent':'Alfred-VSCode-Extension/1.0'}};constreq=client.request(options,(res:any)=>{letbody='';res.on('data',(chunk:any)=>{body+=chunk;});res.on('end',()=>{if(res.statusCode&&res.statusCode>=200&&res.statusCode<300){try{resolve(JSON.parse(body));}catch(e){reject(newError('InvalidJSONresponse'));}}else{reject(newError(`HTTP${res.statusCode}:${body}`));}});});req.on('error',(err:any)=>{reject(err);});req.setTimeout(10000,()=>{req.destroy();reject(newError('Requesttimeout'));});req.end();});}privategetHtmlContent():string{constnonce=getNonce();return`<!DOCTYPEhtml><htmllang="en"><head><metacharset="UTF-8"><metaname="viewport"content="width=device-width,initial-scale=1.0"><metahttp-equiv="Content-Security-Policy"content="default-src'none';style-src'unsafe-inline';script-src'nonce-${nonce}';"><title>AlfredTransferHistory</title><style>body{font-family:var(--vscode-font-family);font-size:var(--vscode-font-size);background-color:var(--vscode-editor-background);color:var(--vscode-editor-foreground);margin:0;padding:10px;}.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}.title{font-weight:bold;font-size:1.1em;}.refresh-btn{background:none;border:none;color:var(--vscode-foreground);cursor:pointer;padding:2px;}.refresh-btn:hover{color:var(--vscode-textLink-foreground);}.transfer-item{border:1pxsolidvar(--vscode-panel-border);border-radius:3px;padding:8px;margin-bottom:8px;background-color:var(--vscode-input-background);}.transfer-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;}.transfer-type{font-weight:bold;padding:2px6px;border-radius:3px;font-size:0.9em;}.transfer-type.sent{background-color:var(--vscode-notificationsErrorIcon-foreground);color:white;}.transfer-type.received{background-color:var(--vscode-notificationsInfoIcon-foreground);color:white;}.transfer-amount{font-weight:bold;color:var(--vscode-textLink-foreground);}.transfer-user{color:var(--vscode-descriptionForeground);font-size:0.9em;}.transfer-message{margin-top:4px;font-style:italic;color:var(--vscode-descriptionForeground);}.transfer-timestamp{font-size:0.8em;color:var(--vscode-descriptionForeground);margin-top:4px;}.loading{text-align:center;padding:20px;color:var(--vscode-descriptionForeground);}.error{color:var(--vscode-notificationsErrorIcon-foreground);padding:10px;border:1pxsolidvar(--vscode-notificationsErrorIcon-foreground);border-radius:3px;margin-bottom:10px;}.empty{text-align:center;padding:20px;color:var(--vscode-descriptionForeground);}</style></head><body><divclass="header"><divclass="title">TransferHistory</div><buttonclass="refresh-btn"onclick="refresh()"title="Refresh">&#x21bb;</button></div><divid="content"><divclass="loading">Loadingtransferhistory...</div></div><scriptnonce="${nonce}">constvscode=acquireVsCodeApi();lettransfers=[];functionrefresh(){vscode.postMessage({type:'refresh'});document.getElementById('content').innerHTML='<divclass="loading">Loadingtransferhistory...</div>';}functionformatTimestamp(timestamp){constdate=newDate(timestamp);returndate.toLocaleString();}functionformatAmount(amount){returnparseFloat(amount).toFixed(2);}functionrenderTransfers(transferData){if(!transferData||transferData.length===0){return'<divclass="empty">Notransfersfound</div>';}returntransferData.map(transfer=>\`<divclass="transfer-item"><divclass="transfer-header"><spanclass="transfer-type\${transfer.type}">\${transfer.type.toUpperCase()}</span><spanclass="transfer-amount">\${formatAmount(transfer.amount)}credits</span></div><divclass="transfer-user">\${transfer.other_user.name}(\${transfer.other_user.email})</div>\${transfer.message?\`<divclass="transfer-message">\${transfer.message}</div>\`:''}<divclass="transfer-timestamp">\${formatTimestamp(transfer.timestamp)}</div></div>\`).join('');}functionrenderError(message){return\`<divclass="error">\${message}</div>\`;}window.addEventListener('message',event=>{constmessage=event.data;constcontent=document.getElementById('content');switch(message.type){case'transfers':content.innerHTML=renderTransfers(message.data);break;case'error':content.innerHTML=renderError(message.message);break;}});//Initialloadrefresh();</script></body></html>`;}}functiongetNonce():string{lettext='';constpossible='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';for(leti=0;i<32;i++){text+=possible.charAt(Math.floor(Math.random()*possible.length));}returntext;}/***T171:UsageReportProviderâ€”ExportsusagedataforFinOps*/exportclassUsageReportProviderimplementsvscode.WebviewViewProvider{privatewebviewView?:vscode.WebviewView;constructor(privatereadonlycontext:vscode.ExtensionContext){}resolveWebviewView(webviewView:vscode.WebviewView):void{this.webviewView=webviewView;webviewView.webview.options={enableScripts:true,};webviewView.webview.html=this.getHtmlContent();webviewView.webview.onDidReceiveMessage(async(message)=>{switch(message.type){case'exportCsv':awaitthis.exportReport('csv');break;case'exportJson':awaitthis.exportReport('json');break;case'fetchUsage':awaitthis.fetchUsageData();break;}});}privateasyncfetchUsageData():Promise<void>{constconfig=vscode.workspace.getConfiguration('alfred');constapiUrl=config.get<string>('apiUrl','http://localhost:8000');constapiKey=config.get<string>('apiKey');if(!apiKey){this.webviewView?.webview.postMessage({type:'error',message:'APIkeynotconfigured.Setalfred.apiKeyinsettings.'});return;}try{//FetchusagedatafromtheAlfredAPIconstusageData=awaitthis.makeHttpRequest(`${apiUrl}/v1/analytics/usage/me`);this.webviewView?.webview.postMessage({type:'usage',data:usageData});}catch(error){//Demodatafallbackthis.webviewView?.webview.postMessage({type:'usage',data:{period:{start:newDate(Date.now()-7*24*60*60*1000).toISOString(),end:newDate().toISOString()},total_requests:1247,total_tokens_input:892456,total_tokens_output:234567,total_cost:12.47,by_model:[{model:'gpt-4o',requests:523,tokens:456000,cost:8.20},{model:'gpt-4o-mini',requests:612,tokens:589000,cost:2.95},{model:'claude-3.5-sonnet',requests:112,tokens:82023,cost:1.32}],by_day:[{date:'2024-01-15',requests:178,cost:1.78},{date:'2024-01-16',requests:195,cost:2.01},{date:'2024-01-17',requests:163,cost:1.54},{date:'2024-01-18',requests:201,cost:2.23},{date:'2024-01-19',requests:156,cost:1.45},{date:'2024-01-20',requests:189,cost:1.89},{date:'2024-01-21',requests:165,cost:1.57}]}});}}privateasyncexportReport(format:'csv'|'json'):Promise<void>{constworkspaceFolder=vscode.workspace.workspaceFolders?.[0];if(!workspaceFolder){vscode.window.showErrorMessage('Noworkspacefolderopen');return;}consttimestamp=newDate().toISOString().replace(/[:.]/g,'-');constfilename=`alfred-usage-report-${timestamp}.${format}`;consturi=vscode.Uri.joinPath(workspaceFolder.uri,filename);//GetsessiondatafromworkspacestateconstsessionTokensInput=this.context.workspaceState.get<number>('sessionTokensInput',0);constsessionTokensOutput=this.context.workspaceState.get<number>('sessionTokensOutput',0);constsessionCost=this.context.workspaceState.get<number>('sessionCost',0);constcurrentModel=this.context.workspaceState.get<string>('currentModel','gpt-4o');constreportData={generated_at:newDate().toISOString(),workspace:workspaceFolder.name,session:{tokens_input:sessionTokensInput,tokens_output:sessionTokensOutput,total_tokens:sessionTokensInput+sessionTokensOutput,cost_usd:sessionCost,model:currentModel}};letcontent:string;if(format==='json'){content=JSON.stringify(reportData,null,2);}else{content=['GeneratedAt,Workspace,TokensInput,TokensOutput,TotalTokens,CostUSD,Model',`${reportData.generated_at},${reportData.workspace},${sessionTokensInput},${sessionTokensOutput},${sessionTokensInput+sessionTokensOutput},${sessionCost},${currentModel}`].join('\n');}awaitvscode.workspace.fs.writeFile(uri,Buffer.from(content,'utf8'));vscode.window.showInformationMessage(`Usagereportexported:${filename}`);//Openthefileconstdoc=awaitvscode.workspace.openTextDocument(uri);awaitvscode.window.showTextDocument(doc);}privatemakeHttpRequest(url:string):Promise<any>{returnnewPromise((resolve,reject)=>{constconfig=vscode.workspace.getConfiguration('alfred');constapiKey=config.get<string>('apiKey','');constparsedUrl=newURL(url);constisHttps=parsedUrl.protocol==='https:';consthttp=isHttps?require('https'):require('http');constoptions={hostname:parsedUrl.hostname,port:parsedUrl.port||(isHttps?443:80),path:parsedUrl.pathname+parsedUrl.search,method:'GET',headers:{'Authorization':`Bearer${apiKey}`,'Content-Type':'application/json'}};constreq=http.request(options,(res:any)=>{letdata='';res.on('data',(chunk:string)=>{data+=chunk;});res.on('end',()=>{if(res.statusCode>=200&&res.statusCode<300){try{resolve(JSON.parse(data));}catch{resolve(data);}}else{reject(newError(`HTTP${res.statusCode}:${data}`));}});});req.on('error',reject);req.end();});}privategetHtmlContent():string{constnonce=getNonce();return`<!DOCTYPEhtml><htmllang="en"><head><metacharset="UTF-8"><metaname="viewport"content="width=device-width,initial-scale=1.0"><metahttp-equiv="Content-Security-Policy"content="default-src'none';style-src'unsafe-inline';script-src'nonce-${nonce}';"><title>AlfredUsageReport</title><style>body{font-family:var(--vscode-font-family);font-size:var(--vscode-font-size);background-color:var(--vscode-editor-background);color:var(--vscode-editor-foreground);margin:0;padding:10px;}.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}.title{font-weight:bold;font-size:1.1em;}.btn{background:var(--vscode-button-background);color:var(--vscode-button-foreground);border:none;padding:6px12px;border-radius:3px;cursor:pointer;margin:4px;}.btn:hover{background:var(--vscode-button-hoverBackground);}.stat-card{border:1pxsolidvar(--vscode-panel-border);border-radius:3px;padding:10px;margin-bottom:8px;background-color:var(--vscode-input-background);}.stat-label{font-size:0.9em;color:var(--vscode-descriptionForeground);}.stat-value{font-size:1.4em;font-weight:bold;color:var(--vscode-textLink-foreground);}.model-row{display:flex;justify-content:space-between;padding:4px0;border-bottom:1pxsolidvar(--vscode-panel-border);}.loading{text-align:center;padding:20px;color:var(--vscode-descriptionForeground);}.error{color:var(--vscode-notificationsErrorIcon-foreground);padding:10px;}.actions{margin-top:10px;}</style></head><body><divclass="header"><divclass="title">UsageReport</div></div><divid="content"><divclass="loading">Loadingusagedata...</div></div><divclass="actions"><buttonclass="btn"onclick="exportCsv()">ExportCSV</button><buttonclass="btn"onclick="exportJson()">ExportJSON</button></div><scriptnonce="${nonce}">constvscode=acquireVsCodeApi();functionexportCsv(){vscode.postMessage({type:'exportCsv'});}functionexportJson(){vscode.postMessage({type:'exportJson'});}functionfetchUsage(){vscode.postMessage({type:'fetchUsage'});}functionformatNumber(num){if(num>=1000000)return(num/1000000).toFixed(1)+'M';if(num>=1000)return(num/1000).toFixed(1)+'K';returnnum.toString();}functionrenderUsage(data){return\`<divclass="stat-card"><divclass="stat-label">TotalRequests</div><divclass="stat-value">\${formatNumber(data.total_requests)}</div></div><divclass="stat-card"><divclass="stat-label">TotalTokens</div><divclass="stat-value">\${formatNumber(data.total_tokens_input+data.total_tokens_output)}</div></div><divclass="stat-card"><divclass="stat-label">TotalCost</div><divclass="stat-value">$\${data.total_cost.toFixed(2)}</div></div><divclass="stat-card"><divclass="stat-label">ByModel</div>\${data.by_model.map(m=>\`<divclass="model-row"><span>\${m.model}</span><span>$\${m.cost.toFixed(2)}</span></div>\`).join('')}</div>\`;}window.addEventListener('message',event=>{constmessage=event.data;constcontent=document.getElementById('content');if(message.type==='usage'){content.innerHTML=renderUsage(message.data);}elseif(message.type==='error'){content.innerHTML='<divclass="error">'+message.message+'</div>';}});fetchUsage();</script></body></html>`;}}