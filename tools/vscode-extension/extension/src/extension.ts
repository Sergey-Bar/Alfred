import*asvscodefrom'vscode';import{activateSidebar}from'./sidebar';//SessiontrackingstateletsessionTokensInput=0;letsessionTokensOutput=0;letsessionCost=0;letcurrentModel='gpt-4o';letcurrentEnvironment:'development'|'production'='development';letstatusBarTokens:vscode.StatusBarItem;letstatusBarCost:vscode.StatusBarItem;letstatusBarModel:vscode.StatusBarItem;letstatusBarEnv:vscode.StatusBarItem;exportfunctionactivate(context:vscode.ExtensionContext){//Activatesidebar(TransferHistory‚ÄîT165baseline)activateSidebar(context);//T166:StatusbartokencounterstatusBarTokens=vscode.window.createStatusBarItem(vscode.StatusBarAlignment.Right,100);statusBarTokens.command='alfred.showSessionDetails';updateTokensStatusBar();statusBarTokens.show();context.subscriptions.push(statusBarTokens);//T167:SessioncostgaugestatusBarCost=vscode.window.createStatusBarItem(vscode.StatusBarAlignment.Right,99);statusBarCost.command='alfred.showCostBreakdown';updateCostStatusBar();statusBarCost.show();context.subscriptions.push(statusBarCost);//T168:ModelselectorstatusBarModel=vscode.window.createStatusBarItem(vscode.StatusBarAlignment.Right,98);statusBarModel.command='alfred.selectModel';updateModelStatusBar();statusBarModel.show();context.subscriptions.push(statusBarModel);//T169:Dev/prodenvironmenttogglestatusBarEnv=vscode.window.createStatusBarItem(vscode.StatusBarAlignment.Right,97);statusBarEnv.command='alfred.toggleEnvironment';updateEnvStatusBar();statusBarEnv.show();context.subscriptions.push(statusBarEnv);//Registercommandscontext.subscriptions.push(vscode.commands.registerCommand('alfred.showSessionDetails',showSessionDetails),vscode.commands.registerCommand('alfred.showCostBreakdown',showCostBreakdown),vscode.commands.registerCommand('alfred.selectModel',selectModel),vscode.commands.registerCommand('alfred.toggleEnvironment',toggleEnvironment),vscode.commands.registerCommand('alfred.resetSession',resetSession),vscode.commands.registerCommand('alfred.checkBudget',checkBudget),vscode.commands.registerCommand('alfred.trackRequest',trackRequest),);//T170:Budgetalerts‚ÄîcheckperiodicallyconstbudgetCheckInterval=setInterval(()=>{checkBudgetAlerts(context);},60000);//Checkeveryminutecontext.subscriptions.push({dispose:()=>clearInterval(budgetCheckInterval)});//InitialbudgetcheckcheckBudgetAlerts(context);//T171:Per-repotracking‚ÄîstoresessiondataperworkspacerestoreSessionFromWorkspace(context);vscode.window.showInformationMessage('AlfredAIextensionactivated');}functionupdateTokensStatusBar(){consttotal=sessionTokensInput+sessionTokensOutput;statusBarTokens.text=`$(symbol-number)${formatNumber(total)}tokens`;statusBarTokens.tooltip=`Sessiontokens:${formatNumber(sessionTokensInput)}in/${formatNumber(sessionTokensOutput)}out`;}functionupdateCostStatusBar(){statusBarCost.text=`$(credit-card)$${sessionCost.toFixed(4)}`;statusBarCost.tooltip=`Sessioncost:$${sessionCost.toFixed(4)}USD`;//Colorbasedoncostthresholdconstconfig=vscode.workspace.getConfiguration('alfred');constwarnThreshold=config.get<number>('sessionCostWarningThreshold',1.0);if(sessionCost>warnThreshold){statusBarCost.backgroundColor=newvscode.ThemeColor('statusBarItem.warningBackground');}else{statusBarCost.backgroundColor=undefined;}}functionupdateModelStatusBar(){statusBarModel.text=`$(hubot)${currentModel}`;statusBarModel.tooltip=`Currentmodel:${currentModel}.Clicktochange.`;}functionupdateEnvStatusBar(){consticon=currentEnvironment==='production'?'$(globe)':'$(beaker)';statusBarEnv.text=`${icon}${currentEnvironment}`;statusBarEnv.tooltip=`Environment:${currentEnvironment}.Clicktotoggle.`;if(currentEnvironment==='production'){statusBarEnv.backgroundColor=newvscode.ThemeColor('statusBarItem.errorBackground');}else{statusBarEnv.backgroundColor=undefined;}}asyncfunctionshowSessionDetails(){constmessage=`üìäAlfredSessionDetailsInputTokens:${formatNumber(sessionTokensInput)}OutputTokens:${formatNumber(sessionTokensOutput)}TotalTokens:${formatNumber(sessionTokensInput+sessionTokensOutput)}SessionCost:$${sessionCost.toFixed(4)}CurrentModel:${currentModel}Environment:${currentEnvironment}`.trim();constaction=awaitvscode.window.showInformationMessage(message,'ResetSession','ViewDashboard');if(action==='ResetSession'){resetSession();}elseif(action==='ViewDashboard'){constconfig=vscode.workspace.getConfiguration('alfred');constapiUrl=config.get<string>('apiUrl','http://localhost:3000');vscode.env.openExternal(vscode.Uri.parse(apiUrl));}}asyncfunctionshowCostBreakdown(){constconfig=vscode.workspace.getConfiguration('alfred');constbudget=config.get<number>('dailyBudget',10.0);constremaining=Math.max(0,budget-sessionCost);constpercentUsed=(sessionCost/budget)*100;vscode.window.showInformationMessage(`Session:$${sessionCost.toFixed(4)}|DailyBudget:$${budget.toFixed(2)}|Remaining:$${remaining.toFixed(2)}(${percentUsed.toFixed(1)}%used)`);}asyncfunctionselectModel(){constmodels=[{label:'gpt-4o',description:'OpenAIGPT-4o‚ÄîBestquality'},{label:'gpt-4o-mini',description:'OpenAIGPT-4oMini‚ÄîFast&cheap'},{label:'gpt-3.5-turbo',description:'OpenAIGPT-3.5Turbo‚ÄîEconomy'},{label:'claude-3.5-sonnet',description:'AnthropicClaude3.5Sonnet‚ÄîStrongreasoning'},{label:'claude-3-haiku',description:'AnthropicClaude3Haiku‚ÄîFast'},{label:'gemini-1.5-pro',description:'GoogleGemini1.5Pro‚ÄîLongcontext'},{label:'gemini-1.5-flash',description:'GoogleGemini1.5Flash‚ÄîSpeed'},{label:'mistral-large',description:'MistralLarge‚ÄîEuropeanhosting'},];constselected=awaitvscode.window.showQuickPick(models,{placeHolder:'SelectAImodelforrequests',title:'Alfred:SelectModel'});if(selected){currentModel=selected.label;updateModelStatusBar();vscode.window.showInformationMessage(`Alfred:Modelsetto${currentModel}`);}}asyncfunctiontoggleEnvironment(){currentEnvironment=currentEnvironment==='development'?'production':'development';updateEnvStatusBar();if(currentEnvironment==='production'){constconfirm=awaitvscode.window.showWarningMessage('YouarenowinPRODUCTIONmode.APIcallswilluseproductioncredentialsandbebilledaccordingly.','KeepProduction','SwitchtoDev');if(confirm==='SwitchtoDev'){currentEnvironment='development';updateEnvStatusBar();}}else{vscode.window.showInformationMessage('Switchedtodevelopmentenvironment');}}functionresetSession(){sessionTokensInput=0;sessionTokensOutput=0;sessionCost=0;updateTokensStatusBar();updateCostStatusBar();vscode.window.showInformationMessage('Alfred:Sessionreset');}asyncfunctioncheckBudget(){constconfig=vscode.workspace.getConfiguration('alfred');constbudget=config.get<number>('dailyBudget',10.0);constapiUrl=config.get<string>('apiUrl','http://localhost:8000');constapiKey=config.get<string>('apiKey');if(!apiKey){vscode.window.showWarningMessage('Alfred:APIkeynotconfigured');return;}//FetchbudgetfromAPItry{//Inproduction:fetchfromAlfredAPIvscode.window.showInformationMessage(`Budget:$${budget.toFixed(2)}daily|Session:$${sessionCost.toFixed(4)}`);}catch(error){vscode.window.showErrorMessage(`Failedtocheckbudget:${error}`);}}//T170:BudgetalertsasyncfunctioncheckBudgetAlerts(context:vscode.ExtensionContext){constconfig=vscode.workspace.getConfiguration('alfred');constbudget=config.get<number>('dailyBudget',10.0);constwarnAt=config.get<number>('budgetWarningPercent',80);constpercentUsed=(sessionCost/budget)*100;constlastWarning=context.workspaceState.get<number>('lastBudgetWarning',0);constnow=Date.now();//Warnatmostonceperhourif(percentUsed>=warnAt&&(now-lastWarning)>3600000){vscode.window.showWarningMessage(`‚ö†Ô∏èAlfredBudgetAlert:You'veused${percentUsed.toFixed(1)}%ofyourdailyAIbudget($${sessionCost.toFixed(2)}/$${budget.toFixed(2)})`,'ViewDetails');context.workspaceState.update('lastBudgetWarning',now);}}//T171:Per-repotrackingfunctionrestoreSessionFromWorkspace(context:vscode.ExtensionContext){conststoredTokensIn=context.workspaceState.get<number>('sessionTokensInput',0);conststoredTokensOut=context.workspaceState.get<number>('sessionTokensOutput',0);conststoredCost=context.workspaceState.get<number>('sessionCost',0);conststoredModel=context.workspaceState.get<string>('currentModel','gpt-4o');conststoredEnv=context.workspaceState.get<'development'|'production'>('currentEnvironment','development');sessionTokensInput=storedTokensIn;sessionTokensOutput=storedTokensOut;sessionCost=storedCost;currentModel=storedModel;currentEnvironment=storedEnv;updateTokensStatusBar();updateCostStatusBar();updateModelStatusBar();updateEnvStatusBar();}functionsaveSessionToWorkspace(context:vscode.ExtensionContext){context.workspaceState.update('sessionTokensInput',sessionTokensInput);context.workspaceState.update('sessionTokensOutput',sessionTokensOutput);context.workspaceState.update('sessionCost',sessionCost);context.workspaceState.update('currentModel',currentModel);context.workspaceState.update('currentEnvironment',currentEnvironment);}//PublicAPIfortrackingrequests(canbecalledfromotherextensions)functiontrackRequest(inputTokens:number,outputTokens:number,cost:number){sessionTokensInput+=inputTokens;sessionTokensOutput+=outputTokens;sessionCost+=cost;updateTokensStatusBar();updateCostStatusBar();}functionformatNumber(num:number):string{if(num>=1000000)return(num/1000000).toFixed(1)+'M';if(num>=1000)return(num/1000).toFixed(1)+'K';returnnum.toString();}exportfunctiondeactivate(){//Statusbarsaredisposedviasubscriptions}