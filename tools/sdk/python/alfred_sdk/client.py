importtimeimportjsonfromtypingimportOptional,Dict,Any,List,Iterator,Unionfromurllib.parseimporturljoinimporthttpxfrom.modelsimport(User,Team,Wallet,Transaction,Transfer,APIKey,Provider,Policy,Experiment,UsageReport,CostBreakdown,CompletionRequest,CompletionResponse,PaginatedResponse,)from.exceptionsimport(AlfredError,AuthenticationError,AuthorizationError,NotFoundError,ValidationError,QuotaExceededError,RateLimitError,ProviderError,PolicyViolationError,)classAlfredClient:"""AlfredSDKClientâ€”typedinterfacetotheAlfredAICreditGovernancePlatform.Usage:>>>fromalfred_sdkimportAlfredClient>>>client=AlfredClient(api_key="ak_...")>>>>>>#Checkwalletbalance>>>wallet=client.get_wallet()>>>print(f"Balance:${wallet.balance:.2f}")>>>>>>#MakeanAIrequest>>>response=client.chat_completion(...model="gpt-4o",...messages=[{"role":"user","content":"Hello!"}]...)>>>print(response.choices[0]["message"]["content"])"""DEFAULT_BASE_URL="http://localhost:8000"DEFAULT_TIMEOUT=60.0MAX_RETRIES=3def__init__(self,api_key:str,base_url:Optional[str]=None,timeout:float=DEFAULT_TIMEOUT,max_retries:int=MAX_RETRIES,):"""InitializetheAlfredclient.Args:api_key:AlfredAPIkey(startswith'ak_')base_url:APIbaseURL(default:http://localhost:8000)timeout:Requesttimeoutinsecondsmax_retries:Numberofretriesontransientfailures"""self.api_key=api_keyself.base_url=(base_urlorself.DEFAULT_BASE_URL).rstrip("/")self.timeout=timeoutself.max_retries=max_retriesself._client=httpx.Client(base_url=self.base_url,headers={"Authorization":f"Bearer{api_key}","Content-Type":"application/json","User-Agent":"alfred-sdk-python/1.0.0",},timeout=timeout,)defclose(self)->None:"""ClosetheHTTPclient."""self._client.close()def__enter__(self)->"AlfredClient":returnselfdef__exit__(self,*args)->None:self.close()#========================================================#InternalHTTPmethods#========================================================def_request(self,method:str,path:str,params:Optional[Dict[str,Any]]=None,json_data:Optional[Dict[str,Any]]=None,)->Dict[str,Any]:"""MakeanHTTPrequestwithretriesanderrorhandling."""last_error:Optional[Exception]=Noneforattemptinrange(self.max_retries):try:response=self._client.request(method=method,url=path,params=params,json=json_data,)returnself._handle_response(response)excepthttpx.HTTPStatusErrorase:last_error=self._handle_http_error(e)ifnotself._should_retry(e.response.status_code):raiselast_errorexcepthttpx.RequestErrorase:last_error=AlfredError(f"Requestfailed:{e}")#Exponentialbackoffifattempt<self.max_retries-1:time.sleep(2**attempt)raiselast_errororAlfredError("Maxretriesexceeded")def_handle_response(self,response:httpx.Response)->Dict[str,Any]:"""HandleHTTPresponseandraiseappropriateerrors."""ifresponse.status_code>=400:self._raise_for_status(response)ifresponse.status_code==204:return{}returnresponse.json()def_raise_for_status(self,response:httpx.Response)->None:"""Raiseappropriateexceptionbasedonstatuscode."""status=response.status_codetry:data=response.json()exceptjson.JSONDecodeError:data={"detail":response.text}message=data.get("detail",data.get("message","Unknownerror"))ifstatus==401:raiseAuthenticationError(message,status,data)elifstatus==403:raiseAuthorizationError(message,status,data)elifstatus==404:raiseNotFoundError(message,status,data)elifstatus==422:raiseValidationError(message,errors=data.get("errors"),status_code=status,response=data)elifstatus==429:retry_after=response.headers.get("Retry-After")if"quota"inmessage.lower()or"credit"inmessage.lower():raiseQuotaExceededError(message,status_code=status,response=data)raiseRateLimitError(message,retry_after=int(retry_after)ifretry_afterelseNone,status_code=status,response=data,)elifstatus>=500:raiseProviderError(message,status_code=status,response=data)else:raiseAlfredError(message,status,data)def_handle_http_error(self,error:httpx.HTTPStatusError)->AlfredError:"""ConverthttpxerrortoAlfrederror."""self._raise_for_status(error.response)returnAlfredError(str(error))#Shouldnotreachheredef_should_retry(self,status_code:int)->bool:"""Checkifrequestshouldberetriedbasedonstatuscode."""returnstatus_codein(429,500,502,503,504)#========================================================#UserManagement#========================================================defget_me(self)->User:"""Getcurrentuserprofile."""data=self._request("GET","/v1/users/me")returnUser(**data)defupdate_me(self,name:Optional[str]=None)->User:"""Updatecurrentuserprofile."""payload={}ifnameisnotNone:payload["name"]=namedata=self._request("PATCH","/v1/users/me",json_data=payload)returnUser(**data)deflist_users(self,page:int=1,page_size:int=20)->PaginatedResponse:"""Listusers(adminonly)."""data=self._request("GET","/v1/users",params={"page":page,"page_size":page_size})returnPaginatedResponse(**data)defget_user(self,user_id:str)->User:"""GetuserbyID."""data=self._request("GET",f"/v1/users/{user_id}")returnUser(**data)#========================================================#TeamManagement#========================================================deflist_teams(self,page:int=1,page_size:int=20)->PaginatedResponse:"""Listteams."""data=self._request("GET","/v1/teams",params={"page":page,"page_size":page_size})returnPaginatedResponse(**data)defget_team(self,team_id:str)->Team:"""GetteambyID."""data=self._request("GET",f"/v1/teams/{team_id}")returnTeam(**data)defcreate_team(self,name:str,description:Optional[str]=None)->Team:"""Createanewteam."""data=self._request("POST","/v1/teams",json_data={"name":name,"description":description,})returnTeam(**data)defadd_team_member(self,team_id:str,user_id:str,role:str="member")->Dict[str,Any]:"""Addamembertoateam."""returnself._request("POST",f"/v1/teams/{team_id}/members",json_data={"user_id":user_id,"role":role,})defremove_team_member(self,team_id:str,user_id:str)->None:"""Removeamemberfromateam."""self._request("DELETE",f"/v1/teams/{team_id}/members/{user_id}")#========================================================#Wallet&Credits#========================================================defget_wallet(self)->Wallet:"""Getcurrentuser'swallet."""data=self._request("GET","/v1/wallets/me")returnWallet(**data)defget_wallet_by_id(self,wallet_id:str)->Wallet:"""GetwalletbyID."""data=self._request("GET",f"/v1/wallets/{wallet_id}")returnWallet(**data)defadd_credits(self,wallet_id:str,amount:float,description:Optional[str]=None)->Transaction:"""Addcreditstoawallet(adminonly)."""data=self._request("POST",f"/v1/wallets/{wallet_id}/credit",json_data={"amount":amount,"description":description,})returnTransaction(**data)defget_transactions(self,wallet_id:Optional[str]=None,page:int=1,page_size:int=20,)->PaginatedResponse:"""Getwallettransactions."""path=f"/v1/wallets/{wallet_id}/transactions"ifwallet_idelse"/v1/wallets/me/transactions"data=self._request("GET",path,params={"page":page,"page_size":page_size})returnPaginatedResponse(**data)#========================================================#Transfers#========================================================deftransfer_credits(self,to_user_id:str,amount:float,message:Optional[str]=None,)->Transfer:"""Transfercreditstoanotheruser."""data=self._request("POST","/v1/transfers",json_data={"to_user_id":to_user_id,"amount":amount,"message":message,})returnTransfer(**data)defget_transfers(self,page:int=1,page_size:int=20)->PaginatedResponse:"""Gettransferhistory."""data=self._request("GET","/v1/transfers",params={"page":page,"page_size":page_size})returnPaginatedResponse(**data)#========================================================#APIKeys#========================================================deflist_api_keys(self)->List[APIKey]:"""Listuser'sAPIkeys."""data=self._request("GET","/v1/api-keys")return[APIKey(**k)forkindata.get("items",data)]defcreate_api_key(self,name:str,scopes:Optional[List[str]]=None,expires_in_days:Optional[int]=None,)->Dict[str,Any]:"""CreateanewAPIkey.Returnsthefullkeyonlyonce."""returnself._request("POST","/v1/api-keys",json_data={"name":name,"scopes":scopesor[],"expires_in_days":expires_in_days,})defrevoke_api_key(self,key_id:str)->None:"""RevokeanAPIkey."""self._request("DELETE",f"/v1/api-keys/{key_id}")defrotate_api_key(self,key_id:str)->Dict[str,Any]:"""RotateanAPIkey.Returnsthenewkey."""returnself._request("POST",f"/v1/api-keys/{key_id}/rotate")#========================================================#AICompletions#========================================================defchat_completion(self,model:str,messages:List[Dict[str,str]],temperature:float=0.7,max_tokens:Optional[int]=None,stream:bool=False,**kwargs,)->Union[CompletionResponse,Iterator[str]]:"""Createachatcompletion(OpenAI-compatible).Args:model:Modelidentifier(e.g.,'gpt-4o','claude-3.5-sonnet')messages:Listofmessageobjectswith'role'and'content'temperature:Samplingtemperature(0-2)max_tokens:Maximumtokenstogeneratestream:Whethertostreamtheresponse**kwargs:AdditionalparameterspassedtotheAPIReturns:CompletionResponseoriteratorofchunksifstreaming"""payload={"model":model,"messages":messages,"temperature":temperature,"stream":stream,**kwargs,}ifmax_tokens:payload["max_tokens"]=max_tokensifstream:returnself._stream_completion(payload)data=self._request("POST","/v1/chat/completions",json_data=payload)returnCompletionResponse(**data)def_stream_completion(self,payload:Dict[str,Any])->Iterator[str]:"""Streamachatcompletion."""withself._client.stream("POST","/v1/chat/completions",json=payload,)asresponse:forlineinresponse.iter_lines():ifline.startswith("data:"):chunk=line[6:]ifchunk=="[DONE]":breakyieldchunk#========================================================#Providers#========================================================deflist_providers(self)->List[Provider]:"""ListavailableLLMproviders."""data=self._request("GET","/v1/providers")return[Provider(**p)forpindata.get("items",data)]defget_provider_health(self)->Dict[str,Any]:"""Gethealthstatusofallproviders."""returnself._request("GET","/v1/providers/health")#========================================================#Policies#========================================================deflist_policies(self)->List[Policy]:"""Listgovernancepolicies."""data=self._request("GET","/v1/policies")return[Policy(**p)forpindata.get("items",data)]defget_policy(self,policy_id:str)->Policy:"""GetpolicybyID."""data=self._request("GET",f"/v1/policies/{policy_id}")returnPolicy(**data)defcreate_policy(self,name:str,rules:Dict[str,Any],action:str="deny",description:Optional[str]=None,)->Policy:"""Createagovernancepolicy."""data=self._request("POST","/v1/policies",json_data={"name":name,"rules":rules,"action":action,"description":description,})returnPolicy(**data)#========================================================#Experiments#========================================================deflist_experiments(self)->List[Experiment]:"""ListA/Bexperiments."""data=self._request("GET","/v1/experiments")return[Experiment(**e)foreindata.get("items",data)]defget_experiment(self,experiment_id:str)->Experiment:"""GetexperimentbyID."""data=self._request("GET",f"/v1/experiments/{experiment_id}")returnExperiment(**data)defcreate_experiment(self,name:str,variants:List[Dict[str,Any]],traffic_split:Dict[str,float],description:Optional[str]=None,)->Experiment:"""CreateanA/Bexperiment."""data=self._request("POST","/v1/experiments",json_data={"name":name,"variants":variants,"traffic_split":traffic_split,"description":description,})returnExperiment(**data)defstart_experiment(self,experiment_id:str)->Experiment:"""Startanexperiment."""data=self._request("POST",f"/v1/experiments/{experiment_id}/start")returnExperiment(**data)defconclude_experiment(self,experiment_id:str,winner:str)->Experiment:"""Concludeanexperimentwithawinner."""data=self._request("POST",f"/v1/experiments/{experiment_id}/conclude",json_data={"winner":winner,})returnExperiment(**data)#========================================================#Analytics#========================================================defget_usage_report(self,start_date:Optional[str]=None,end_date:Optional[str]=None,)->UsageReport:"""Getusagereportforthecurrentuser."""params={}ifstart_date:params["start_date"]=start_dateifend_date:params["end_date"]=end_datedata=self._request("GET","/v1/analytics/usage/me",params=params)returnUsageReport(**data)defget_cost_breakdown(self,start_date:Optional[str]=None,end_date:Optional[str]=None,)->CostBreakdown:"""Getcostbreakdownforthecurrentuser."""params={}ifstart_date:params["start_date"]=start_dateifend_date:params["end_date"]=end_datedata=self._request("GET","/v1/analytics/costs/me",params=params)returnCostBreakdown(**data)