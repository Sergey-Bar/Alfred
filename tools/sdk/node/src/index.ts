//============================================================//Types//============================================================exportinterfaceAlfredConfig{apiKey:string;baseUrl?:string;timeout?:number;maxRetries?:number;}exportinterfaceUser{id:string;email:string;name:string;role:'user'|'admin'|'team_admin'|'super_admin';teamId?:string;isActive:boolean;createdAt:string;updatedAt?:string;}exportinterfaceTeam{id:string;name:string;description?:string;ownerId:string;memberCount:number;createdAt:string;updatedAt?:string;}exportinterfaceWallet{id:string;ownerId:string;ownerType:'user'|'team';balance:number;hardLimit:number;softLimit:number;currency:string;createdAt:string;updatedAt?:string;}exportinterfaceTransaction{id:string;walletId:string;type:'deduction'|'refund'|'credit'|'transfer_in'|'transfer_out'|'chargeback';amount:number;balanceAfter:number;description?:string;metadata:Record<string,unknown>;createdAt:string;idempotencyKey?:string;}exportinterfaceTransfer{id:string;fromWalletId:string;toWalletId:string;amount:number;message?:string;status:'pending'|'completed'|'cancelled'|'rejected';requiresApproval:boolean;approvedBy?:string;createdAt:string;completedAt?:string;}exportinterfaceAPIKey{id:string;name:string;keyPrefix:string;userId:string;scopes:string[];isActive:boolean;lastUsedAt?:string;expiresAt?:string;createdAt:string;}exportinterfaceProvider{id:string;name:string;type:string;isEnabled:boolean;priority:number;rateLimit?:number;models:string[];healthStatus:string;lastHealthCheck?:string;}exportinterfacePolicy{id:string;name:string;description?:string;rules:Record<string,unknown>;action:'allow'|'deny'|'warn'|'audit';isActive:boolean;isDryRun:boolean;priority:number;createdAt:string;updatedAt?:string;}exportinterfaceExperiment{id:string;name:string;description?:string;status:'draft'|'running'|'paused'|'concluded';variants:Record<string,unknown>[];trafficSplit:Record<string,number>;metrics:Record<string,unknown>;startTime?:string;endTime?:string;createdAt:string;}exportinterfaceMessage{role:'system'|'user'|'assistant';content:string;}exportinterfaceCompletionOptions{model:string;messages:Message[];temperature?:number;maxTokens?:number;stream?:boolean;[key:string]:unknown;}exportinterfaceCompletionResponse{id:string;model:string;choices:Array<{index:number;message:Message;finish_reason:string;}>;usage:{prompt_tokens:number;completion_tokens:number;total_tokens:number;};created:number;cost?:number;cached?:boolean;}exportinterfaceUsageReport{periodStart:string;periodEnd:string;totalRequests:number;totalTokensInput:number;totalTokensOutput:number;totalCost:number;byModel:Array<{model:string;requests:number;tokens:number;cost:number}>;byDay:Array<{date:string;requests:number;cost:number}>;}exportinterfacePaginatedResponse<T>{items:T[];total:number;page:number;pageSize:number;hasMore:boolean;}//============================================================//Errors//============================================================exportclassAlfredErrorextendsError{constructor(message:string,publicstatusCode?:number,publicresponse?:Record<string,unknown>){super(message);this.name='AlfredError';}}exportclassAuthenticationErrorextendsAlfredError{constructor(message:string,response?:Record<string,unknown>){super(message,401,response);this.name='AuthenticationError';}}exportclassQuotaExceededErrorextendsAlfredError{constructor(message:string,publiccurrentBalance?:number,publicrequired?:number){super(message,429);this.name='QuotaExceededError';}}exportclassRateLimitErrorextendsAlfredError{constructor(message:string,publicretryAfter?:number){super(message,429);this.name='RateLimitError';}}exportclassValidationErrorextendsAlfredError{constructor(message:string,publicerrors?:unknown[]){super(message,422);this.name='ValidationError';}}exportclassNotFoundErrorextendsAlfredError{constructor(message:string){super(message,404);this.name='NotFoundError';}}//============================================================//Client//============================================================exportclassAlfredClient{privatereadonlyapiKey:string;privatereadonlybaseUrl:string;privatereadonlytimeout:number;privatereadonlymaxRetries:number;constructor(config:AlfredConfig){this.apiKey=config.apiKey;this.baseUrl=(config.baseUrl||'http://localhost:8000').replace(/\/$/,'');this.timeout=config.timeout||60000;this.maxRetries=config.maxRetries||3;}//========================================================//InternalHTTPmethods//========================================================privateasyncrequest<T>(method:string,path:string,options:{params?:Record<string,string|number>;body?:unknown;}={}):Promise<T>{letlastError:Error|undefined;for(letattempt=0;attempt<this.maxRetries;attempt++){try{leturl=`${this.baseUrl}${path}`;if(options.params){constsearchParams=newURLSearchParams();for(const[key,value]ofObject.entries(options.params)){searchParams.set(key,String(value));}url+=`?${searchParams.toString()}`;}constcontroller=newAbortController();consttimeoutId=setTimeout(()=>controller.abort(),this.timeout);constresponse=awaitfetch(url,{method,headers:{'Authorization':`Bearer${this.apiKey}`,'Content-Type':'application/json','User-Agent':'alfred-sdk-node/1.0.0',},body:options.body?JSON.stringify(options.body):undefined,signal:controller.signal,});clearTimeout(timeoutId);if(!response.ok){awaitthis.handleError(response);}if(response.status===204){return{}asT;}returnawaitresponse.json()asT;}catch(error){lastError=errorasError;if(!this.shouldRetry(error)){throwerror;}awaitthis.sleep(Math.pow(2,attempt)*1000);}}throwlastError||newAlfredError('Maxretriesexceeded');}privateasynchandleError(response:Response):Promise<never>{letdata:Record<string,unknown>={};try{data=awaitresponse.json();}catch{data={detail:awaitresponse.text()};}constmessage=(data.detail||data.message||'Unknownerror')asstring;switch(response.status){case401:thrownewAuthenticationError(message,data);case403:thrownewAlfredError(message,403,data);case404:thrownewNotFoundError(message);case422:thrownewValidationError(message,data.errorsasunknown[]);case429:if(message.toLowerCase().includes('quota')||message.toLowerCase().includes('credit')){thrownewQuotaExceededError(message);}constretryAfter=response.headers.get('Retry-After');thrownewRateLimitError(message,retryAfter?parseInt(retryAfter):undefined);default:thrownewAlfredError(message,response.status,data);}}privateshouldRetry(error:unknown):boolean{if(errorinstanceofAlfredError){returnerror.statusCode!==undefined&&[429,500,502,503,504].includes(error.statusCode);}returnfalse;}privatesleep(ms:number):Promise<void>{returnnewPromise(resolve=>setTimeout(resolve,ms));}//========================================================//UserManagement//========================================================asyncgetMe():Promise<User>{returnthis.request<User>('GET','/v1/users/me');}asyncupdateMe(data:{name?:string}):Promise<User>{returnthis.request<User>('PATCH','/v1/users/me',{body:data});}asynclistUsers(page=1,pageSize=20):Promise<PaginatedResponse<User>>{returnthis.request<PaginatedResponse<User>>('GET','/v1/users',{params:{page,page_size:pageSize}});}asyncgetUser(userId:string):Promise<User>{returnthis.request<User>('GET',`/v1/users/${userId}`);}//========================================================//TeamManagement//========================================================asynclistTeams(page=1,pageSize=20):Promise<PaginatedResponse<Team>>{returnthis.request<PaginatedResponse<Team>>('GET','/v1/teams',{params:{page,page_size:pageSize}});}asyncgetTeam(teamId:string):Promise<Team>{returnthis.request<Team>('GET',`/v1/teams/${teamId}`);}asynccreateTeam(data:{name:string;description?:string}):Promise<Team>{returnthis.request<Team>('POST','/v1/teams',{body:data});}asyncaddTeamMember(teamId:string,userId:string,role='member'):Promise<unknown>{returnthis.request('POST',`/v1/teams/${teamId}/members`,{body:{user_id:userId,role}});}asyncremoveTeamMember(teamId:string,userId:string):Promise<void>{awaitthis.request('DELETE',`/v1/teams/${teamId}/members/${userId}`);}//========================================================//Wallet&Credits//========================================================asyncgetWallet():Promise<Wallet>{returnthis.request<Wallet>('GET','/v1/wallets/me');}asyncgetWalletById(walletId:string):Promise<Wallet>{returnthis.request<Wallet>('GET',`/v1/wallets/${walletId}`);}asyncaddCredits(walletId:string,amount:number,description?:string):Promise<Transaction>{returnthis.request<Transaction>('POST',`/v1/wallets/${walletId}/credit`,{body:{amount,description}});}asyncgetTransactions(walletId?:string,page=1,pageSize=20):Promise<PaginatedResponse<Transaction>>{constpath=walletId?`/v1/wallets/${walletId}/transactions`:'/v1/wallets/me/transactions';returnthis.request<PaginatedResponse<Transaction>>('GET',path,{params:{page,page_size:pageSize}});}//========================================================//Transfers//========================================================asynctransferCredits(toUserId:string,amount:number,message?:string):Promise<Transfer>{returnthis.request<Transfer>('POST','/v1/transfers',{body:{to_user_id:toUserId,amount,message}});}asyncgetTransfers(page=1,pageSize=20):Promise<PaginatedResponse<Transfer>>{returnthis.request<PaginatedResponse<Transfer>>('GET','/v1/transfers',{params:{page,page_size:pageSize}});}//========================================================//APIKeys//========================================================asynclistApiKeys():Promise<APIKey[]>{constdata=awaitthis.request<{items:APIKey[]}|APIKey[]>('GET','/v1/api-keys');returnArray.isArray(data)?data:data.items;}asynccreateApiKey(data:{name:string;scopes?:string[];expiresInDays?:number}):Promise<{key:string;id:string}>{returnthis.request('POST','/v1/api-keys',{body:{name:data.name,scopes:data.scopes||[],expires_in_days:data.expiresInDays}});}asyncrevokeApiKey(keyId:string):Promise<void>{awaitthis.request('DELETE',`/v1/api-keys/${keyId}`);}asyncrotateApiKey(keyId:string):Promise<{key:string}>{returnthis.request('POST',`/v1/api-keys/${keyId}/rotate`);}//========================================================//AICompletions//========================================================asyncchatCompletion(options:CompletionOptions):Promise<CompletionResponse>{constpayload={model:options.model,messages:options.messages,temperature:options.temperature??0.7,max_tokens:options.maxTokens,stream:options.stream??false,...Object.fromEntries(Object.entries(options).filter(([k])=>!['model','messages','temperature','maxTokens','stream'].includes(k))),};returnthis.request<CompletionResponse>('POST','/v1/chat/completions',{body:payload});}//Streamingrequiresadifferentapproachâ€”fornow,returnsasyncgeneratorplaceholderasync*streamCompletion(options:CompletionOptions):AsyncGenerator<string,void,undefined>{consturl=`${this.baseUrl}/v1/chat/completions`;constresponse=awaitfetch(url,{method:'POST',headers:{'Authorization':`Bearer${this.apiKey}`,'Content-Type':'application/json',},body:JSON.stringify({...options,stream:true}),});if(!response.ok){awaitthis.handleError(response);}constreader=response.body?.getReader();if(!reader)thrownewAlfredError('Streamnotavailable');constdecoder=newTextDecoder();while(true){const{done,value}=awaitreader.read();if(done)break;constchunk=decoder.decode(value);constlines=chunk.split('\n');for(constlineoflines){if(line.startsWith('data:')){constdata=line.slice(6);if(data==='[DONE]')return;yielddata;}}}}//========================================================//Providers//========================================================asynclistProviders():Promise<Provider[]>{constdata=awaitthis.request<{items:Provider[]}|Provider[]>('GET','/v1/providers');returnArray.isArray(data)?data:data.items;}asyncgetProviderHealth():Promise<Record<string,unknown>>{returnthis.request('GET','/v1/providers/health');}//========================================================//Policies//========================================================asynclistPolicies():Promise<Policy[]>{constdata=awaitthis.request<{items:Policy[]}|Policy[]>('GET','/v1/policies');returnArray.isArray(data)?data:data.items;}asyncgetPolicy(policyId:string):Promise<Policy>{returnthis.request<Policy>('GET',`/v1/policies/${policyId}`);}asynccreatePolicy(data:{name:string;rules:Record<string,unknown>;action?:string;description?:string}):Promise<Policy>{returnthis.request<Policy>('POST','/v1/policies',{body:data});}//========================================================//Experiments//========================================================asynclistExperiments():Promise<Experiment[]>{constdata=awaitthis.request<{items:Experiment[]}|Experiment[]>('GET','/v1/experiments');returnArray.isArray(data)?data:data.items;}asyncgetExperiment(experimentId:string):Promise<Experiment>{returnthis.request<Experiment>('GET',`/v1/experiments/${experimentId}`);}asynccreateExperiment(data:{name:string;variants:unknown[];trafficSplit:Record<string,number>;description?:string}):Promise<Experiment>{returnthis.request<Experiment>('POST','/v1/experiments',{body:{name:data.name,variants:data.variants,traffic_split:data.trafficSplit,description:data.description}});}asyncstartExperiment(experimentId:string):Promise<Experiment>{returnthis.request<Experiment>('POST',`/v1/experiments/${experimentId}/start`);}asyncconcludeExperiment(experimentId:string,winner:string):Promise<Experiment>{returnthis.request<Experiment>('POST',`/v1/experiments/${experimentId}/conclude`,{body:{winner}});}//========================================================//Analytics//========================================================asyncgetUsageReport(startDate?:string,endDate?:string):Promise<UsageReport>{constparams:Record<string,string>={};if(startDate)params.start_date=startDate;if(endDate)params.end_date=endDate;returnthis.request<UsageReport>('GET','/v1/analytics/usage/me',{params});}}exportdefaultAlfredClient;