#!/usr/bin/envpython3importargparseimportjsonimportsysfrompathlibimportPathdefget_openapi_spec():"""ExtractOpenAPIspecfromFastAPIapp."""#Addbackendtopathbackend_path=Path(__file__).parent.parent/"src"/"backend"sys.path.insert(0,str(backend_path))try:fromapp.mainimportappreturnapp.openapi()exceptExceptionase:print(f"ERROR:CouldnotloadFastAPIapp:{e}",file=sys.stderr)returnNonedefvalidate_spec(spec:dict)->list[dict]:"""ValidateOpenAPIspecforcompletenessandquality."""issues=[]#1.Checkinfosectioninfo=spec.get("info",{})ifnotinfo.get("title"):issues.append({"level":"error","message":"MissingAPItitleininfosection"})ifnotinfo.get("version"):issues.append({"level":"error","message":"MissingAPIversionininfosection"})ifnotinfo.get("description"):issues.append({"level":"warn","message":"MissingAPIdescriptionininfosection"})#2.Checkpathshavedescriptionspaths=spec.get("paths",{})forpath,methodsinpaths.items():formethod,operationinmethods.items():ifmethod.startswith("x-"):continueop_id=operation.get("operationId",f"{method.upper()}{path}")ifnotoperation.get("summary")andnotoperation.get("description"):issues.append({"level":"warn","message":f"Endpoint{op_id}missingsummary/description","path":path,"method":method,})#Checkresponseschemasresponses=operation.get("responses",{})ifnotresponses:issues.append({"level":"warn","message":f"Endpoint{op_id}hasnoresponsedefinitions","path":path,"method":method,})#Checkfor422validationerrorresponse(FastAPIstandard)ifmethodin("post","put","patch")and"422"notinresponses:issues.append({"level":"info","message":f"Endpoint{op_id}missing422validationerrorresponse","path":path,"method":method,})#3.Checksecurityschemescomponents=spec.get("components",{})security_schemes=components.get("securitySchemes",{})ifnotsecurity_schemes:issues.append({"level":"warn","message":"Nosecurityschemesdefined—APImayappearunauthenticatedindocs",})#4.Checkschemasexistschemas=components.get("schemas",{})iflen(schemas)<5:issues.append({"level":"warn","message":f"Only{len(schemas)}schemasdefined—expectedmoreforacompleteAPI",})#5.Statsendpoint_count=sum(1forpath,methodsinpaths.items()formethodinmethodsifnotmethod.startswith("x-"))returnissues,{"endpoints":endpoint_count,"schemas":len(schemas),"paths":len(paths),"has_security":bool(security_schemes),}defvalidate_gateway_spec(spec_path:str)->list[dict]:"""ValidategatewayOpenAPIspecfromJSONfile."""try:withopen(spec_path)asf:spec=json.load(f)except(FileNotFoundError,json.JSONDecodeError)ase:return[{"level":"error","message":f"Cannotreadgatewayspec:{e}"}],{}returnvalidate_spec(spec)defmain():parser=argparse.ArgumentParser(description="AlfredOpenAPISpecValidator")parser.add_argument("--export",type=str,help="ExportspectoJSONfile")parser.add_argument("--gateway-spec",type=str,help="PathtogatewayOpenAPIJSON")parser.add_argument("--check-coverage",action="store_true",help="Checkendpointdocumentationcoverage")parser.add_argument("--strict",action="store_true",help="Treatwarningsaserrors")args=parser.parse_args()exit_code=0#Backendspecprint("="*60)print("AlfredBackend—OpenAPIValidation")print("="*60)spec=get_openapi_spec()ifspec:ifargs.export:export_path=Path(args.export)export_path.parent.mkdir(parents=True,exist_ok=True)withopen(export_path,"w")asf:json.dump(spec,f,indent=2,default=str)print(f"Exportedto{export_path}")issues,stats=validate_spec(spec)print(f"\nEndpoints:{stats['endpoints']}")print(f"Schemas:{stats['schemas']}")print(f"Paths:{stats['paths']}")print(f"Security:{'Yes'ifstats['has_security']else'No'}")errors=[iforiinissuesifi["level"]=="error"]warns=[iforiinissuesifi["level"]=="warn"]infos=[iforiinissuesifi["level"]=="info"]iferrors:print(f"\n❌Errors({len(errors)}):")forissueinerrors:print(f"ERROR:{issue['message']}")exit_code=1ifwarns:print(f"\n⚠️Warnings({len(warns)}):")forissueinwarns:print(f"WARN:{issue['message']}")ifargs.strict:exit_code=1ifinfos:print(f"\nℹ️Info({len(infos)}):")forissueininfos[:10]:#Capdisplayprint(f"INFO:{issue['message']}")ifnoterrorsandnot(args.strictandwarns):print("\n✅BackendOpenAPIspecisvalid")else:print("⚠️Couldnotloadbackendapp—skippingbackendvalidation")#Gatewayspecifargs.gateway_spec:print(f"\n{'='*60}")print("AlfredGateway—OpenAPIValidation")print("="*60)gw_issues,gw_stats=validate_gateway_spec(args.gateway_spec)ifgw_stats:print(f"\nEndpoints:{gw_stats.get('endpoints','N/A')}")print(f"Schemas:{gw_stats.get('schemas','N/A')}")gw_errors=[iforiingw_issuesifi["level"]=="error"]ifgw_errors:forissueingw_errors:print(f"ERROR:{issue['message']}")exit_code=1else:print("\n✅GatewayOpenAPIspecisvalid")sys.exit(exit_code)if__name__=="__main__":main()