#!/usr/bin/envpython3"""AlfredCLI-Command-lineinterfaceforAlfredplatform.ProvidesterminalaccesstoAlfred'sfeaturesincluding:-APIkeymanagement-Quotaandwalletoperations-Teammanagement-Usageanalytics-SystemhealthchecksUsage:alfred--helpalfredkeyslistalfredquotaget--user-idUSER"""importosimportsysimportjsonfromdatetimeimportdatetimefromtypingimportOptionalimportclickimporthttpxfromrich.consoleimportConsolefromrich.tableimportTablefromrich.panelimportPanelfromrich.progressimportProgressconsole=Console()#ConfigurationDEFAULT_API_URL="http://localhost:8000"CONFIG_FILE=os.path.expanduser("~/.alfred/config.json")defget_config()->dict:"""Loadconfigurationfromfileorenvironment."""config={"api_url":os.environ.get("ALFRED_API_URL",DEFAULT_API_URL),"api_key":os.environ.get("ALFRED_API_KEY",""),}ifos.path.exists(CONFIG_FILE):try:withopen(CONFIG_FILE)asf:file_config=json.load(f)config.update(file_config)exceptException:passreturnconfigdefsave_config(config:dict)->None:"""Saveconfigurationtofile."""os.makedirs(os.path.dirname(CONFIG_FILE),exist_ok=True)withopen(CONFIG_FILE,"w")asf:json.dump(config,f,indent=2)defget_client()->httpx.Client:"""CreateanHTTPclientwithauthheaders."""config=get_config()ifnotconfig.get("api_key"):console.print("[red]Error:APIkeynotconfigured.Run'alfredconfigure'first.[/red]")sys.exit(1)returnhttpx.Client(base_url=config["api_url"],headers={"Authorization":f"Bearer{config['api_key']}","Content-Type":"application/json","User-Agent":"alfred-cli/1.0.0",},timeout=60.0,)defhandle_error(response:httpx.Response)->None:"""HandleAPIerrors."""try:data=response.json()message=data.get("detail",data.get("message","Unknownerror"))exceptException:message=response.textconsole.print(f"[red]Error({response.status_code}):{message}[/red]")sys.exit(1)#============================================================#MainCLIGroup#============================================================@click.group()@click.version_option(version="1.0.0",prog_name="alfred")defcli():"""AlfredAICreditGovernancePlatformCLIManageAIcredits,runcompletions,andmonitorusagefromthecommandline."""pass#============================================================#ConfigurationCommands#============================================================@cli.command()@click.option("--api-key",prompt="APIKey",help="YourAlfredAPIkey")@click.option("--api-url",default=DEFAULT_API_URL,help="AlfredAPIURL")defconfigure(api_key:str,api_url:str):"""ConfigureAlfredCLIwithyourcredentials."""config={"api_key":api_key,"api_url":api_url,}save_config(config)console.print("[green]Configurationsavedto~/.alfred/config.json[/green]")@cli.command()defwhoami():"""Showcurrentuserinformation."""withget_client()asclient:response=client.get("/v1/users/me")ifresponse.status_code!=200:handle_error(response)user=response.json()console.print(Panel(f"[bold]Name:[/bold]{user.get('name','N/A')}\n"f"[bold]Email:[/bold]{user.get('email','N/A')}\n"f"[bold]Role:[/bold]{user.get('role','user')}\n"f"[bold]ID:[/bold]{user.get('id','N/A')}",title="CurrentUser"))#============================================================#WalletCommands#============================================================@cli.group()defwallet():"""Manageyourcreditwallet."""pass@wallet.command("balance")defwallet_balance():"""Checkyourwalletbalance."""withget_client()asclient:response=client.get("/v1/wallets/me")ifresponse.status_code!=200:handle_error(response)data=response.json()balance=float(data.get("balance",0))soft_limit=float(data.get("soft_limit",0))hard_limit=float(data.get("hard_limit",0))#Colorbasedonremainingbalancecolor="green"ifbalance>soft_limit*0.5else("yellow"ifbalance>0else"red")console.print(Panel(f"[{color}]Balance:${balance:.4f}[/{color}]\n"f"SoftLimit:${soft_limit:.2f}\n"f"HardLimit:${hard_limit:.2f}",title="WalletBalance"))@wallet.command("transactions")@click.option("--limit","-n",default=10,help="Numberoftransactionstoshow")defwallet_transactions(limit:int):"""Listrecenttransactions."""withget_client()asclient:response=client.get("/v1/wallets/me/transactions",params={"page_size":limit})ifresponse.status_code!=200:handle_error(response)data=response.json()items=data.get("items",data)ifisinstance(data,dict)elsedatatable=Table(title="RecentTransactions")table.add_column("Type",style="cyan")table.add_column("Amount",justify="right")table.add_column("BalanceAfter",justify="right")table.add_column("Timestamp")table.add_column("Description")fortxinitems[:limit]:amount=float(tx.get("amount",0))color="green"ifamount>0else"red"table.add_row(tx.get("type",""),f"[{color}]${amount:+.4f}[/{color}]",f"${float(tx.get('balance_after',0)):.4f}",tx.get("created_at","")[:19],tx.get("description","")[:30],)console.print(table)#============================================================#CompletionCommands#============================================================@cli.command()@click.argument("prompt")@click.option("--model","-m",default="gpt-4o",help="Modeltouse")@click.option("--temperature","-t",default=0.7,type=float,help="Samplingtemperature")@click.option("--max-tokens","-n",default=None,type=int,help="Maximumtokens")@click.option("--system","-s",default=None,help="Systemmessage")@click.option("--json","as_json",is_flag=True,help="OutputrawJSON")defchat(prompt:str,model:str,temperature:float,max_tokens:Optional[int],system:Optional[str],as_json:bool):"""Sendachatcompletionrequest.Example:alfredchat"WhatisthecapitalofFrance?""""messages=[]ifsystem:messages.append({"role":"system","content":system})messages.append({"role":"user","content":prompt})payload={"model":model,"messages":messages,"temperature":temperature,}ifmax_tokens:payload["max_tokens"]=max_tokenswithget_client()asclient:withProgress()asprogress:task=progress.add_task("Generating...",total=None)response=client.post("/v1/chat/completions",json=payload)progress.update(task,completed=True)ifresponse.status_code!=200:handle_error(response)data=response.json()ifas_json:console.print_json(json.dumps(data,indent=2))return#Prettyoutputcontent=data.get("choices",[{}])[0].get("message",{}).get("content","")usage=data.get("usage",{})cost=data.get("cost")console.print(Panel(content,title=f"Response({model})"))stats=f"Tokens:{usage.get('total_tokens',0)}(in:{usage.get('prompt_tokens',0)},out:{usage.get('completion_tokens',0)})"ifcost:stats+=f"|Cost:${cost:.4f}"console.print(f"[dim]{stats}[/dim]")@cli.command()@click.argument("input_file",type=click.File("r"))@click.option("--model","-m",default="gpt-4o",help="Modeltouse")@click.option("--output","-o",type=click.File("w"),help="Outputfile")defbatch(input_file,model:str,output):"""Processabatchofpromptsfromafile.Inputfileshouldhaveonepromptperline."""prompts=[line.strip()forlineininput_fileifline.strip()]ifnotprompts:console.print("[red]Nopromptsfoundininputfile[/red]")returnresults=[]withget_client()asclient:withProgress()asprogress:task=progress.add_task("Processing...",total=len(prompts))forpromptinprompts:payload={"model":model,"messages":[{"role":"user","content":prompt}],}response=client.post("/v1/chat/completions",json=payload)ifresponse.status_code==200:data=response.json()content=data.get("choices",[{}])[0].get("message",{}).get("content","")results.append({"prompt":prompt,"response":content,"tokens":data.get("usage",{}).get("total_tokens",0),"cost":data.get("cost"),})else:results.append({"prompt":prompt,"error":response.text,})progress.advance(task)ifoutput:json.dump(results,output,indent=2)console.print(f"[green]Resultssavedto{output.name}[/green]")else:forrinresults:console.print(Panel(r.get("response",r.get("error","")),title=r["prompt"][:50]))#============================================================#AnalyticsCommands#============================================================@cli.group()defanalytics():"""Viewusageanalytics."""pass@analytics.command("usage")@click.option("--start",help="Startdate(YYYY-MM-DD)")@click.option("--end",help="Enddate(YYYY-MM-DD)")defanalytics_usage(start:Optional[str],end:Optional[str]):"""Showusagereport."""params={}ifstart:params["start_date"]=startifend:params["end_date"]=endwithget_client()asclient:response=client.get("/v1/analytics/usage/me",params=params)ifresponse.status_code!=200:handle_error(response)data=response.json()console.print(Panel(f"[bold]TotalRequests:[/bold]{data.get('total_requests',0):,}\n"f"[bold]TotalTokens:[/bold]{data.get('total_tokens_input',0)+data.get('total_tokens_output',0):,}\n"f"[bold]TotalCost:[/bold]${float(data.get('total_cost',0)):.2f}",title="UsageSummary"))#Bymodelbreakdownby_model=data.get("by_model",[])ifby_model:table=Table(title="ByModel")table.add_column("Model")table.add_column("Requests",justify="right")table.add_column("Tokens",justify="right")table.add_column("Cost",justify="right")forminby_model:table.add_row(m.get("model",""),f"{m.get('requests',0):,}",f"{m.get('tokens',0):,}",f"${float(m.get('cost',0)):.2f}",)console.print(table)@analytics.command("export")@click.option("--format","fmt",type=click.Choice(["csv","json"]),default="csv")@click.option("--output","-o",required=True,help="Outputfilepath")defanalytics_export(fmt:str,output:str):"""Exportusagedata."""withget_client()asclient:response=client.get("/v1/analytics/usage/me")ifresponse.status_code!=200:handle_error(response)data=response.json()iffmt=="json":withopen(output,"w")asf:json.dump(data,f,indent=2)else:#csvimportcsvwithopen(output,"w",newline="")asf:writer=csv.writer(f)writer.writerow(["Model","Requests","Tokens","Cost"])formindata.get("by_model",[]):writer.writerow([m.get("model",""),m.get("requests",0),m.get("tokens",0),m.get("cost",0),])console.print(f"[green]Exportedto{output}[/green]")#============================================================#TransferCommands#============================================================@cli.group()deftransfer():"""Managecredittransfers."""pass@transfer.command("send")@click.argument("to_user_id")@click.argument("amount",type=float)@click.option("--message","-m",help="Transfermessage")deftransfer_send(to_user_id:str,amount:float,message:Optional[str]):"""Sendcreditstoanotheruser."""withget_client()asclient:payload={"to_user_id":to_user_id,"amount":amount,}ifmessage:payload["message"]=messageresponse=client.post("/v1/transfers",json=payload)ifresponse.status_codenotin(200,201):handle_error(response)console.print(f"[green]Successfullytransferred${amount:.2f}to{to_user_id}[/green]")@transfer.command("list")@click.option("--limit","-n",default=10,help="Numberoftransferstoshow")deftransfer_list(limit:int):"""Listrecenttransfers."""withget_client()asclient:response=client.get("/v1/transfers",params={"page_size":limit})ifresponse.status_code!=200:handle_error(response)data=response.json()items=data.get("items",data)ifisinstance(data,dict)elsedatatable=Table(title="RecentTransfers")table.add_column("Type",style="cyan")table.add_column("Amount",justify="right")table.add_column("With",style="dim")table.add_column("Status")table.add_column("Timestamp")fortinitems[:limit]:color="red"ift.get("type")=="sent"else"green"table.add_row(t.get("type","").upper(),f"[{color}]${float(t.get('amount',0)):.2f}[/{color}]",str(t.get("other_user",{}).get("email",""))[:30],t.get("status",""),t.get("created_at","")[:19],)console.print(table)#============================================================#APIKeyCommands#============================================================@cli.group()defkeys():"""ManageAPIkeys."""pass@keys.command("list")defkeys_list():"""ListyourAPIkeys."""withget_client()asclient:response=client.get("/v1/api-keys")ifresponse.status_code!=200:handle_error(response)data=response.json()items=data.get("items",data)ifisinstance(data,dict)elsedatatable=Table(title="APIKeys")table.add_column("Name")table.add_column("Prefix")table.add_column("Created")table.add_column("LastUsed")table.add_column("Status")forkeyinitems:status="[green]Active[/green]"ifkey.get("is_active")else"[red]Revoked[/red]"table.add_row(key.get("name",""),key.get("key_prefix","")[:8]+"...",key.get("created_at","")[:10],(key.get("last_used_at")or"Never")[:10],status,)console.print(table)@keys.command("create")@click.argument("name")@click.option("--scopes","-s",multiple=True,help="Keyscopes")@click.option("--expires",type=int,help="Expirationindays")defkeys_create(name:str,scopes:tuple,expires:Optional[int]):"""CreateanewAPIkey."""withget_client()asclient:payload={"name":name,"scopes":list(scopes)or[],}ifexpires:payload["expires_in_days"]=expiresresponse=client.post("/v1/api-keys",json=payload)ifresponse.status_codenotin(200,201):handle_error(response)data=response.json()console.print(Panel(f"[boldgreen]APIKeyCreated[/boldgreen]\n\n"f"[bold]Key:[/bold]{data.get('key','N/A')}\n\n"f"[yellow]⚠️Savethiskeynow—youwon'tbeabletoseeitagain![/yellow]",title="NewAPIKey"))@keys.command("revoke")@click.argument("key_id")@click.confirmation_option(prompt="Areyousureyouwanttorevokethiskey?")defkeys_revoke(key_id:str):"""RevokeanAPIkey."""withget_client()asclient:response=client.delete(f"/v1/api-keys/{key_id}")ifresponse.status_codenotin(200,204):handle_error(response)console.print(f"[green]APIkey{key_id}revoked[/green]")#============================================================#ProviderCommands#============================================================@cli.command()defproviders():"""ListavailableLLMprovidersandhealthstatus."""withget_client()asclient:response=client.get("/v1/providers")ifresponse.status_code!=200:handle_error(response)data=response.json()items=data.get("items",data)ifisinstance(data,dict)elsedatatable=Table(title="LLMProviders")table.add_column("Name")table.add_column("Type")table.add_column("Status")table.add_column("Models")forpinitems:status=p.get("health_status","unknown")status_color="green"ifstatus=="healthy"else("yellow"ifstatus=="degraded"else"red")models=",".join(p.get("models",[])[:3])iflen(p.get("models",[]))>3:models+=f"+{len(p['models'])-3}more"table.add_row(p.get("name",""),p.get("type",""),f"[{status_color}]{status}[/{status_color}]",models,)console.print(table)if__name__=="__main__":cli()