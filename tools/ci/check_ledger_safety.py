#!/usr/bin/envpython3importreimportsysimportos#PatternsthatindicateriskyledgeroperationsRISKY_PATTERNS=[(r"\.delete\(.*audit","DELETEonaudittable‚Äîauditlogsmustbeimmutable"),(r"UPDATE.*audit_log","UPDATEonaudit_log‚Äîauditlogsarewrite-once"),(r"\.update\(.*audit","UPDATEonauditrecords‚Äîauditlogsarewrite-once"),(r"credit.*-=|balance.*-=|wallet.*-=","Directcreditmutation‚Äîusetransactionaldeduction"),(r"\.commit\(\)(?!.*begin)","Barecommit()withouttransactioncontext‚Äîuseasyncwithdb.begin()"),]#Patternsthatshouldbepresentinledgerfiles(safeguards)SAFEGUARD_PATTERNS=[(r"(asyncwith|with)\s+\w+\.begin\(\)","transactionalcontext"),(r"rollback|ROLLBACK","rollbackhandling"),]L4_FILES={"logic.py","wallets.py","transfers.py","finops.py","audit.py",}defcheck_file(filepath:str)->list[str]:"""Checkaledgerfileforsafetyviolations.Returnsalistofwarningmessages."""warnings=[]basename=os.path.basename(filepath)ifbasenamenotinL4_FILES:return[]try:withopen(filepath,"r",encoding="utf-8",errors="replace")asf:content=f.read()except(OSError,IOError):return[]#Checkforriskypatternsforpattern,descriptioninRISKY_PATTERNS:matches=re.findall(pattern,content,re.IGNORECASE)ifmatches:warnings.append(f"{filepath}:‚ö†Ô∏è{description}(found{len(matches)}occurrence(s))")#Checkformissingsafeguardshas_mutations=bool(re.search(r"(INSERT|UPDATE|DELETE|\.add\(|\.delete\()",content,re.IGNORECASE))ifhas_mutations:forpattern,nameinSAFEGUARD_PATTERNS:ifnotre.search(pattern,content,re.IGNORECASE):warnings.append(f"{filepath}:Missingsafeguard‚Äîno{name}foundinfilewithmutations")returnwarningsdefmain()->int:iflen(sys.argv)<2:print("Usage:check_ledger_safety.py<file1>[file2]...")return0files=sys.argv[1:]all_warnings:list[str]=[]forfilepathinfiles:ifnotos.path.isfile(filepath):continuewarnings=check_file(filepath)all_warnings.extend(warnings)ifall_warnings:print("üî¥LEDGERSAFETY‚ÄîL4ReviewRequired")print("="*50)forwinall_warnings:print(f"{w}")print()print("Thesefilestouchledger/wallet/creditlogic.")print("PertheSergeyBarGovernanceProtocol:")print("1.ThisisALWAYSL4‚ÄîuseClaudeOpus4.6orequivalent")print("2.Allmutationsmustbetransactional(asyncwithdb.begin())")print("3.Auditlogsarewrite-once‚ÄînoUPDATEorDELETE")print("4.FlagSergeyBarbeforeopeningthePR")return1#Evenifnowarnings,printareminderforL4filesl4_touched=[fforfinfilesifos.path.basename(f)inL4_FILESandos.path.isfile(f)]ifl4_touched:print(f"‚ÑπÔ∏èL4filesmodified:{','.join(l4_touched)}")print("Remember:FlagSergeyBarforreviewbeforemerging.")return0if__name__=="__main__":sys.exit(main())