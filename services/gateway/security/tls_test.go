packagesecurity_testimport("crypto/tls""testing""time""github.com/AlfredDev/alfred/services/gateway/security")//──DefaultTLSConfig─────────────────────────────────────────funcTestDefaultTLSConfig_EnforcesTLS13(t*testing.T){cfg:=security.DefaultTLSConfig()ifcfg.MinVersion!=tls.VersionTLS13{t.Errorf("defaultMinVersionshouldbeTLS1.3(%#x),got%#x",tls.VersionTLS13,cfg.MinVersion)}}funcTestDefaultTLSConfig_DisabledByDefault(t*testing.T){cfg:=security.DefaultTLSConfig()ifcfg.Enabled{t.Error("TLSshouldbedisabledbydefault(enabledviaconfig)")}}funcTestDefaultTLSConfig_ReloadInterval(t*testing.T){cfg:=security.DefaultTLSConfig()ifcfg.ReloadInterval!=5*time.Minute{t.Errorf("expected5mreloadinterval,got%v",cfg.ReloadInterval)}}funcTestDefaultTLSConfig_SessionTicketRotation(t*testing.T){cfg:=security.DefaultTLSConfig()ifcfg.SessionTicketRotation!=6*time.Hour{t.Errorf("expected6hsessionticketrotation,got%v",cfg.SessionTicketRotation)}}funcTestDefaultTLSConfig_OCSPStaplingEnabled(t*testing.T){cfg:=security.DefaultTLSConfig()if!cfg.OCSPStapling{t.Error("OCSPstaplingshouldbeenabledbydefault")}}funcTestDefaultTLSConfig_NoClientCert(t*testing.T){cfg:=security.DefaultTLSConfig()ifcfg.ClientAuth!=tls.NoClientCert{t.Errorf("expectedNoClientCert,got%d",cfg.ClientAuth)}}//──NewTLSManager────────────────────────────────────────────funcTestNewTLSManager_DisabledSucceeds(t*testing.T){cfg:=security.TLSConfig{Enabled:false}mgr,err:=security.NewTLSManager(cfg)iferr!=nil{t.Fatalf("disabledTLSmanagershouldnoterror:%v",err)}ifmgr==nil{t.Fatal("expectednon-nilmanager")}}funcTestNewTLSManager_RejectsTLS12(t*testing.T){cfg:=security.TLSConfig{Enabled:true,MinVersion:tls.VersionTLS12,CertFile:"nonexistent.pem",KeyFile:"nonexistent.key",}_,err:=security.NewTLSManager(cfg)iferr==nil{t.Fatal("shouldrejectTLS1.2asminimumversion")}}funcTestNewTLSManager_RejectsTLS11(t*testing.T){cfg:=security.TLSConfig{Enabled:true,MinVersion:tls.VersionTLS11,}_,err:=security.NewTLSManager(cfg)iferr==nil{t.Fatal("shouldrejectTLS1.1asminimumversion")}}funcTestNewTLSManager_RejectsTLS10(t*testing.T){cfg:=security.TLSConfig{Enabled:true,MinVersion:tls.VersionTLS10,}_,err:=security.NewTLSManager(cfg)iferr==nil{t.Fatal("shouldrejectTLS1.0asminimumversion")}}//──HealthCheck──────────────────────────────────────────────funcTestHealthCheck_DisabledReturnsNil(t*testing.T){mgr,_:=security.NewTLSManager(security.TLSConfig{Enabled:false})iferr:=mgr.HealthCheck();err!=nil{t.Errorf("disabledTLSshouldreturnnilhealthcheck,got%v",err)}}//──TLSVersionString─────────────────────────────────────────funcTestTLSVersionString(t*testing.T){tests:=[]struct{versionuint16expectedstring}{{tls.VersionTLS10,"TLS1.0"},{tls.VersionTLS11,"TLS1.1"},{tls.VersionTLS12,"TLS1.2"},{tls.VersionTLS13,"TLS1.3"},{0x0000,"Unknown(0x0)"},}for_,tt:=rangetests{result:=security.TLSVersionString(tt.version)ifresult!=tt.expected{t.Errorf("TLSVersionString(%#x)=%q,want%q",tt.version,result,tt.expected)}}}//──ValidateTLSConnection────────────────────────────────────funcTestValidateTLSConnection_NilState(t*testing.T){err:=security.ValidateTLSConnection(nil)iferr==nil{t.Error("nilconnectionstateshouldberejected")}}funcTestValidateTLSConnection_TLS13Accepted(t*testing.T){state:=&tls.ConnectionState{Version:tls.VersionTLS13,}err:=security.ValidateTLSConnection(state)iferr!=nil{t.Errorf("TLS1.3shouldbeaccepted:%v",err)}}funcTestValidateTLSConnection_TLS12Rejected(t*testing.T){state:=&tls.ConnectionState{Version:tls.VersionTLS12,}err:=security.ValidateTLSConnection(state)iferr==nil{t.Error("TLS1.2shouldberejected")}}funcTestValidateTLSConnection_TLS11Rejected(t*testing.T){state:=&tls.ConnectionState{Version:tls.VersionTLS11,}err:=security.ValidateTLSConnection(state)iferr==nil{t.Error("TLS1.1shouldberejected")}}//──TLSConfigForServer(disabledmanager)────────────────────funcTestTLSConfigForServer_EnforcesTLS13(t*testing.T){//CreatedisabledmanagerjusttotestTLSConfigForServeroutputmgr,_:=security.NewTLSManager(security.TLSConfig{Enabled:false,})tlsCfg:=mgr.TLSConfigForServer()iftlsCfg.MinVersion!=tls.VersionTLS13{t.Errorf("MinVersionshouldbeTLS1.3,got%#x",tlsCfg.MinVersion)}iftlsCfg.MaxVersion!=tls.VersionTLS13{t.Errorf("MaxVersionshouldbeTLS1.3,got%#x",tlsCfg.MaxVersion)}}funcTestTLSConfigForServer_PrefersCurves(t*testing.T){mgr,_:=security.NewTLSManager(security.TLSConfig{Enabled:false})tlsCfg:=mgr.TLSConfigForServer()iflen(tlsCfg.CurvePreferences)<2{t.Fatal("expectedatleast2curvepreferences")}iftlsCfg.CurvePreferences[0]!=tls.X25519{t.Error("X25519shouldbefirstcurvepreference")}iftlsCfg.CurvePreferences[1]!=tls.CurveP256{t.Error("CurveP256shouldbesecondcurvepreference")}}funcTestTLSConfigForServer_DisablesRenegotiation(t*testing.T){mgr,_:=security.NewTLSManager(security.TLSConfig{Enabled:false})tlsCfg:=mgr.TLSConfigForServer()iftlsCfg.Renegotiation!=tls.RenegotiateNever{t.Error("renegotiationshouldbedisabled")}}funcTestTLSConfigForServer_SessionTicketsEnabled(t*testing.T){mgr,_:=security.NewTLSManager(security.TLSConfig{Enabled:false})tlsCfg:=mgr.TLSConfigForServer()iftlsCfg.SessionTicketsDisabled{t.Error("sessionticketsshouldbeenabled")}}