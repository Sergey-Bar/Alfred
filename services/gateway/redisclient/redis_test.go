packageredisclientimport("context""sync/atomic""testing""time""github.com/AlfredDev/alfred/services/gateway/config""github.com/rs/zerolog")//───Helper:createaclientpointingatanunreachableaddress─────funcnewTestClient(t*testing.T,addrstring,cc...CircuitConfig)*Client{t.Helper()cfg:=&config.Config{RedisURL:"redis://"+addr+"/0"}logger:=zerolog.Nop()circuitCfg:=CircuitConfig{FailureThreshold:3,HalfOpenTimeout:100*time.Millisecond,OperationTimeout:200*time.Millisecond,ReconnectInterval:50*time.Millisecond,MaxReconnectBackoff:200*time.Millisecond,}iflen(cc)>0{circuitCfg=cc[0]}cl,err:=New(cfg,logger,circuitCfg)iferr!=nil{t.Fatalf("New()failed:%v",err)}t.Cleanup(func(){_=cl.Close()})returncl}//───CircuitBreakerStateTests────────────────────────────funcTestCircuitState_String(t*testing.T){tests:=[]struct{statecircuitStatewantstring}{{stateClosed,"closed"},{stateOpen,"open"},{stateHalfOpen,"half-open"},{circuitState(99),"unknown"},}for_,tt:=rangetests{ifgot:=tt.state.String();got!=tt.want{t.Errorf("circuitState(%d).String()=%q,want%q",tt.state,got,tt.want)}}}funcTestDefaultCircuitConfig(t*testing.T){cc:=DefaultCircuitConfig()ifcc.FailureThreshold!=5{t.Errorf("FailureThreshold=%d,want5",cc.FailureThreshold)}ifcc.HalfOpenTimeout!=30*time.Second{t.Errorf("HalfOpenTimeout=%v,want30s",cc.HalfOpenTimeout)}ifcc.OperationTimeout!=2*time.Second{t.Errorf("OperationTimeout=%v,want2s",cc.OperationTimeout)}ifcc.ReconnectInterval!=5*time.Second{t.Errorf("ReconnectInterval=%v,want5s",cc.ReconnectInterval)}ifcc.MaxReconnectBackoff!=2*time.Minute{t.Errorf("MaxReconnectBackoff=%v,want2m",cc.MaxReconnectBackoff)}}//───GracefulDegradationTests─────────────────────────────funcTestGet_DegradedMode_ReturnsEmpty(t*testing.T){//Pointatanon-existentRedis—shoulddegradegracefullycl:=newTestClient(t,"127.0.0.1:1")//port1=unreachableval,found,err:=cl.Get(context.Background(),"key")iferr!=nil{t.Errorf("Get()error=%v,wantnil(gracefuldegradation)",err)}iffound{t.Error("Get()found=true,wantfalseindegradedmode")}ifval!=""{t.Errorf("Get()val=%q,wantempty",val)}}funcTestSet_DegradedMode_ReturnsNil(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1")err:=cl.Set(context.Background(),"key","value",time.Minute)iferr!=nil{t.Errorf("Set()error=%v,wantnil(gracefuldegradation)",err)}}funcTestDel_DegradedMode_ReturnsZero(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1")n,err:=cl.Del(context.Background(),"key1","key2")iferr!=nil{t.Errorf("Del()error=%v,wantnil",err)}ifn!=0{t.Errorf("Del()=%d,want0",n)}}funcTestExists_DegradedMode_ReturnsFalse(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1")exists,err:=cl.Exists(context.Background(),"key")iferr!=nil{t.Errorf("Exists()error=%v,wantnil",err)}ifexists{t.Error("Exists()=true,wantfalseindegradedmode")}}funcTestSetNX_DegradedMode_ReturnsFalse(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1")ok,err:=cl.SetNX(context.Background(),"lock","val",time.Minute)iferr!=nil{t.Errorf("SetNX()error=%v,wantnil",err)}ifok{t.Error("SetNX()=true,wantfalseindegradedmode")}}funcTestIncr_DegradedMode_ReturnsZero(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1")n,err:=cl.Incr(context.Background(),"counter")iferr!=nil{t.Errorf("Incr()error=%v,wantnil",err)}ifn!=0{t.Errorf("Incr()=%d,want0",n)}}funcTestExpire_DegradedMode_ReturnsNil(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1")err:=cl.Expire(context.Background(),"key",time.Minute)iferr!=nil{t.Errorf("Expire()error=%v,wantnil",err)}}//───CircuitBreakerTransitionTests───────────────────────funcTestCircuitBreaker_TripsAfterThreshold(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1",CircuitConfig{FailureThreshold:3,HalfOpenTimeout:100*time.Millisecond,OperationTimeout:50*time.Millisecond,ReconnectInterval:1*time.Hour,//disablereconnectloopMaxReconnectBackoff:1*time.Hour,})//First3operationsshouldattempttoconnect(circuitclosed)//After3failures,circuitshouldopenfori:=0;i<5;i++{_,_,_=cl.Get(context.Background(),"key")}st:=circuitState(cl.state.Load())ifst!=stateOpen{t.Errorf("circuitstate=%vafter%dfailures,wantopen",st,cl.consecFail.Load())}ifcl.IsHealthy(){t.Error("IsHealthy()=truewhencircuitisopen")}}funcTestCircuitBreaker_AllowRequest_Closed(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1")cl.state.Store(int32(stateClosed))if!cl.allowRequest(){t.Error("allowRequest()=falsewhencircuitisclosed")}}funcTestCircuitBreaker_AllowRequest_Open_NotExpired(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1")cl.state.Store(int32(stateOpen))cl.trippedAt.Store(time.Now().UnixNano())//justtrippedifcl.allowRequest(){t.Error("allowRequest()=truewhencircuitisopenandnotexpired")}}funcTestCircuitBreaker_AllowRequest_Open_Expired(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1",CircuitConfig{FailureThreshold:3,HalfOpenTimeout:10*time.Millisecond,OperationTimeout:50*time.Millisecond,ReconnectInterval:1*time.Hour,MaxReconnectBackoff:1*time.Hour,})cl.state.Store(int32(stateOpen))cl.trippedAt.Store(time.Now().Add(-50*time.Millisecond).UnixNano())//tripped50msago,thresholdis10msif!cl.allowRequest(){t.Error("allowRequest()=falsewhencircuitisopenbutexpired(shouldtransitiontohalf-open)")}st:=circuitState(cl.state.Load())ifst!=stateHalfOpen{t.Errorf("state=%vafterexpiredopen,wanthalf-open",st)}}funcTestCircuitBreaker_HalfOpen_SuccessCloses(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1")cl.state.Store(int32(stateHalfOpen))cl.recordSuccess()st:=circuitState(cl.state.Load())ifst!=stateClosed{t.Errorf("state=%vaftersuccessinhalf-open,wantclosed",st)}}funcTestCircuitBreaker_HalfOpen_FailureReopens(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1")cl.state.Store(int32(stateHalfOpen))cl.recordFailure(context.DeadlineExceeded)st:=circuitState(cl.state.Load())ifst!=stateOpen{t.Errorf("state=%vafterfailureinhalf-open,wantopen",st)}}//───HealthReportingTests─────────────────────────────────funcTestHealth_ReportsCorrectState(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1")h:=cl.Health()ifh.CircuitState!="closed"&&h.CircuitState!="open"{t.Errorf("Health().CircuitState=%q,wantclosedoropen",h.CircuitState)}//Afterpointingatunreachableserver,shouldhavefailuresifh.TotalFailures==0&&!h.Connected{//Mayhavefailuresfrominitialping}}funcTestHealth_DegradedMode(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1")cl.state.Store(int32(stateOpen))cl.connected.Store(false)h:=cl.Health()if!h.DegradedMode{t.Error("Health().DegradedMode=falsewhencircuitisopen")}ifh.Connected{t.Error("Health().Connected=truewhenmarkeddisconnected")}}funcTestHealth_UptimePercentage(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1")cl.totalOK.Store(90)cl.totalFail.Store(10)h:=cl.Health()ifh.UptimePct!=90.0{t.Errorf("Health().UptimePct=%f,want90.0",h.UptimePct)}}funcTestHealth_UptimeZeroOps(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1")cl.totalOK.Store(0)cl.totalFail.Store(0)h:=cl.Health()ifh.UptimePct!=0{t.Errorf("Health().UptimePct=%fwithzeroops,want0",h.UptimePct)}}funcTestHealth_LastError(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1")cl.recordFailure(context.DeadlineExceeded)h:=cl.Health()ifh.LastError==""{t.Error("Health().LastErroremptyafterrecordFailure")}}//───RecordSuccess/FailureTests─────────────────────────funcTestRecordSuccess_ResetsConsecutiveFailures(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1")cl.consecFail.Store(5)cl.recordSuccess()ifcl.consecFail.Load()!=0{t.Errorf("consecFail=%dafterrecordSuccess,want0",cl.consecFail.Load())}if!cl.connected.Load(){t.Error("connected=falseafterrecordSuccess")}}funcTestRecordFailure_IncrementsCounters(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1")initialFail:=cl.totalFail.Load()cl.recordFailure(context.DeadlineExceeded)ifcl.totalFail.Load()!=initialFail+1{t.Errorf("totalFail=%d,want%d",cl.totalFail.Load(),initialFail+1)}}funcTestRecordSuccess_ReconnectAttemptResets(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1")cl.state.Store(int32(stateHalfOpen))cl.reconnAttempt.Store(5)cl.recordSuccess()ifcl.reconnAttempt.Load()!=0{t.Errorf("reconnAttempt=%dafterrecovery,want0",cl.reconnAttempt.Load())}}//───New()Tests────────────────────────────────────────────funcTestNew_InvalidURL_ReturnsError(t*testing.T){cfg:=&config.Config{RedisURL:"not-a-valid-url"}logger:=zerolog.Nop()_,err:=New(cfg,logger)iferr==nil{t.Error("New()withinvalidURLshouldreturnerror")}}funcTestNew_UnreachableHost_StartsInDegradedMode(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1")//Shouldnotbenil—clientcreateddespitepingfailureifcl==nil{t.Fatal("New()returnednilforunreachablehost")}}//───IsHealthyTests────────────────────────────────────────funcTestIsHealthy_TrueWhenClosedAndConnected(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1")cl.state.Store(int32(stateClosed))cl.connected.Store(true)if!cl.IsHealthy(){t.Error("IsHealthy()=falsewhenclosed+connected")}}funcTestIsHealthy_FalseWhenOpen(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1")cl.state.Store(int32(stateOpen))cl.connected.Store(true)ifcl.IsHealthy(){t.Error("IsHealthy()=truewhencircuitisopen")}}funcTestIsHealthy_FalseWhenDisconnected(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1")cl.state.Store(int32(stateClosed))cl.connected.Store(false)ifcl.IsHealthy(){t.Error("IsHealthy()=truewhendisconnected")}}//───ConcurrentAccessTest─────────────────────────────────funcTestConcurrentOperations_NoPanic(t*testing.T){cl:=newTestClient(t,"127.0.0.1:1",CircuitConfig{FailureThreshold:3,HalfOpenTimeout:10*time.Millisecond,OperationTimeout:50*time.Millisecond,ReconnectInterval:1*time.Hour,MaxReconnectBackoff:1*time.Hour,})done:=make(chanstruct{})varopsatomic.Int64//Launch20goroutinesdoingconcurrentoperationsfori:=0;i<20;i++{gofunc(){ctx:=context.Background()for{select{case<-done:returndefault:}_,_,_=cl.Get(ctx,"key")_=cl.Set(ctx,"key","val",time.Minute)_,_=cl.Exists(ctx,"key")_=cl.Health()_=cl.IsHealthy()ops.Add(5)}}()}time.Sleep(200*time.Millisecond)close(done)ifops.Load()<20{t.Errorf("only%dopscompleted,expectedmore",ops.Load())}}