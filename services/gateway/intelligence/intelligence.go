packageintelligenceimport("fmt""math""sort""strings""sync""time")//───T155:AIUsageClassification──────────────────────────typeRequestCategorystringconst(CategoryCodeGenRequestCategory="code_generation"CategorySummarizationRequestCategory="summarization"CategoryLegalRequestCategory="legal_reasoning"CategorySupportRequestCategory="customer_support"CategoryContentRequestCategory="content_creation"CategoryExtractionRequestCategory="data_extraction"CategoryReasoningRequestCategory="reasoning"CategoryEmbeddingsRequestCategory="embeddings"CategoryOtherRequestCategory="other")//ClassificationRuleisakeyword-basedclassifierrule.typeClassificationRulestruct{CategoryRequestCategoryKeywords[]stringWeightfloat64}vardefaultRules=[]ClassificationRule{{CategoryCodeGen,[]string{"code","function","implement","debug","refactor","programming","compile","syntax","algorithm","class","method","variable","api","endpoint"},1.0},{CategorySummarization,[]string{"summarize","summary","tldr","keypoints","brief","condense","overview","digest"},1.0},{CategoryLegal,[]string{"legal","contract","compliance","regulation","clause","liability","indemnity","jurisdiction","statute"},1.0},{CategorySupport,[]string{"customer","support","ticket","help","issue","complaint","troubleshoot","faq"},1.0},{CategoryContent,[]string{"write","blog","article","copy","marketing","email","newsletter","documentation","draft"},0.8},{CategoryExtraction,[]string{"extract","parse","classify","tag","categorize","entity","ner","sentiment","label"},1.0},{CategoryReasoning,[]string{"analyze","reason","evaluate","compare","proscons","decision","planning","strategy","research"},0.8},{CategoryEmbeddings,[]string{"embed","embedding","vector","similarity","search","clustering"},1.0},}typeClassifierstruct{rules[]ClassificationRule}funcNewClassifier()*Classifier{return&Classifier{rules:defaultRules}}//Classifyreturnsthemostlikelycategoryforthegivenprompt.func(c*Classifier)Classify(promptstring)RequestCategory{lower:=strings.ToLower(prompt)scores:=make(map[RequestCategory]float64)for_,rule:=rangec.rules{for_,kw:=rangerule.Keywords{ifstrings.Contains(lower,kw){scores[rule.Category]+=rule.Weight}}}iflen(scores)==0{returnCategoryOther}best:=CategoryOtherbestScore:=0.0forcat,score:=rangescores{ifscore>bestScore{bestScore=scorebest=cat}}returnbest}//ClassifyWithScoresreturnsallcategoryscoresforanalysis.func(c*Classifier)ClassifyWithScores(promptstring)map[RequestCategory]float64{lower:=strings.ToLower(prompt)scores:=make(map[RequestCategory]float64)for_,rule:=rangec.rules{for_,kw:=rangerule.Keywords{ifstrings.Contains(lower,kw){scores[rule.Category]+=rule.Weight}}}returnscores}//───T156:BudgetForecasting(LinearRegression)───────────typeSpendDataPointstruct{Datetime.Time`json:"date"`Amountfloat64`json:"amount"`}typeForecastResultstruct{PredictedDailyfloat64`json:"predicted_daily"`PredictedMonthlyfloat64`json:"predicted_monthly"`DaysUntilExhaustint`json:"days_until_exhaust"`ExhaustDate*time.Time`json:"exhaust_date,omitempty"`Trendstring`json:"trend"`//increasing,decreasing,stableConfidencefloat64`json:"confidence"`//R²Forecast[]SpendDataPoint`json:"forecast"`}typeForecasterstruct{windowDaysint}funcNewForecaster(windowDaysint)*Forecaster{ifwindowDays<=0{windowDays=14}return&Forecaster{windowDays:windowDays}}//Forecastuseslinearregressiononhistoricalspendtopredictfutureusage.func(f*Forecaster)Forecast(history[]SpendDataPoint,budgetRemainingfloat64)*ForecastResult{iflen(history)<3{return&ForecastResult{Trend:"insufficient_data",Confidence:0}}//Sortbydatesorted:=make([]SpendDataPoint,len(history))copy(sorted,history)sort.Slice(sorted,func(i,jint)bool{returnsorted[i].Date.Before(sorted[j].Date)})//UselastNdaysiflen(sorted)>f.windowDays{sorted=sorted[len(sorted)-f.windowDays:]}//Linearregression:y=mx+bn:=float64(len(sorted))varsumX,sumY,sumXY,sumX2float64baseDate:=sorted[0].Datefori,dp:=rangesorted{x:=float64(i)y:=dp.AmountsumX+=xsumY+=ysumXY+=x*ysumX2+=x*x}denom:=n*sumX2-sumX*sumXifdenom==0{avg:=sumY/nreturn&ForecastResult{PredictedDaily:avg,PredictedMonthly:avg*30,Trend:"stable",Confidence:1.0,}}slope:=(n*sumXY-sumX*sumY)/denomintercept:=(sumY-slope*sumX)/n//R²calculationmeanY:=sumY/nvarssRes,ssTotfloat64fori,dp:=rangesorted{predicted:=slope*float64(i)+interceptssRes+=(dp.Amount-predicted)*(dp.Amount-predicted)ssTot+=(dp.Amount-meanY)*(dp.Amount-meanY)}rSquared:=0.0ifssTot>0{rSquared=1-ssRes/ssTot}//Predictnext30daysvarforecast[]SpendDataPointnextDay:=int(n)fori:=0;i<30;i++{predicted:=slope*float64(nextDay+i)+interceptifpredicted<0{predicted=0}forecast=append(forecast,SpendDataPoint{Date:baseDate.AddDate(0,0,nextDay+i),Amount:predicted,})}predictedDaily:=slope*float64(nextDay)+interceptifpredictedDaily<0{predictedDaily=0}trend:="stable"ifslope>0.01*meanY{trend="increasing"}elseifslope<-0.01*meanY{trend="decreasing"}result:=&ForecastResult{PredictedDaily:predictedDaily,PredictedMonthly:predictedDaily*30,Trend:trend,Confidence:math.Max(0,rSquared),Forecast:forecast,}//DaysuntilbudgetexhaustedifpredictedDaily>0&&budgetRemaining>0{days:=int(budgetRemaining/predictedDaily)result.DaysUntilExhaust=daysexhaustDate:=time.Now().AddDate(0,0,days)result.ExhaustDate=&exhaustDate}returnresult}//───T157:AnomalyDetection(Z-Score)──────────────────────typeAnomalyResultstruct{IsAnomalybool`json:"is_anomaly"`ZScorefloat64`json:"z_score"`Valuefloat64`json:"value"`Meanfloat64`json:"mean"`StdDevfloat64`json:"std_dev"`Thresholdfloat64`json:"threshold"`Directionstring`json:"direction"`//"spike"or"drop"}typeAnomalyDetectorstruct{musync.RWMutexwindowSizeintthresholdfloat64//Z-scorethreshold(default:2.0=2σ)historymap[string][]float64//key->rollingvalues}funcNewAnomalyDetector(windowSizeint,thresholdfloat64)*AnomalyDetector{ifwindowSize<=0{windowSize=24//24hours}ifthreshold<=0{threshold=2.0}return&AnomalyDetector{windowSize:windowSize,threshold:threshold,history:make(map[string][]float64),}}//Checkevaluateswhetheranewdatapointisanomalous.func(d*AnomalyDetector)Check(keystring,valuefloat64)*AnomalyResult{d.mu.Lock()deferd.mu.Unlock()h:=d.history[key]h=append(h,value)//Maintainrollingwindowiflen(h)>d.windowSize{h=h[len(h)-d.windowSize:]}d.history[key]=hiflen(h)<5{return&AnomalyResult{IsAnomaly:false,Value:value,Threshold:d.threshold}}//Calculatemeanandstddev(excludingthenewvalue)n:=float64(len(h)-1)varsumfloat64for_,v:=rangeh[:len(h)-1]{sum+=v}mean:=sum/nvarvariancefloat64for_,v:=rangeh[:len(h)-1]{diff:=v-meanvariance+=diff*diff}stdDev:=math.Sqrt(variance/n)ifstdDev==0{return&AnomalyResult{IsAnomaly:false,Value:value,Mean:mean,StdDev:0,Threshold:d.threshold}}zScore:=(value-mean)/stdDevdirection:="spike"ifzScore<0{direction="drop"}return&AnomalyResult{IsAnomaly:math.Abs(zScore)>d.threshold,ZScore:zScore,Value:value,Mean:mean,StdDev:stdDev,Threshold:d.threshold,Direction:direction,}}//───T159:CostPerFeatureAttribution─────────────────────typeFeatureCoststruct{FeatureIDstring`json:"feature_id"`FeatureNamestring`json:"feature_name"`TotalCostfloat64`json:"total_cost"`Requestsint64`json:"requests"`AvgCostfloat64`json:"avg_cost"`TotalTokensint64`json:"total_tokens"`}typeFeatureTrackerstruct{musync.RWMutexfeaturesmap[string]*FeatureCost}funcNewFeatureTracker()*FeatureTracker{return&FeatureTracker{features:make(map[string]*FeatureCost),}}func(t*FeatureTracker)Record(featureID,featureNamestring,costfloat64,tokensint64){t.mu.Lock()defert.mu.Unlock()fc,ok:=t.features[featureID]if!ok{fc=&FeatureCost{FeatureID:featureID,FeatureName:featureName}t.features[featureID]=fc}fc.FeatureName=featureNamefc.TotalCost+=costfc.Requests++fc.TotalTokens+=tokensfc.AvgCost=fc.TotalCost/float64(fc.Requests)}func(t*FeatureTracker)GetAll()[]FeatureCost{t.mu.RLock()defert.mu.RUnlock()result:=make([]FeatureCost,0,len(t.features))for_,fc:=ranget.features{result=append(result,*fc)}sort.Slice(result,func(i,jint)bool{returnresult[i].TotalCost>result[j].TotalCost})returnresult}func(t*FeatureTracker)Get(featureIDstring)(*FeatureCost,error){t.mu.RLock()defert.mu.RUnlock()fc,ok:=t.features[featureID]if!ok{returnnil,fmt.Errorf("feature%snotfound",featureID)}cp:=*fcreturn&cp,nil}//───T160:AIROIScoring───────────────────────────────────typeROIInputstruct{FeatureIDstring`json:"feature_id"`AISpendfloat64`json:"ai_spend"`RevenueImpactfloat64`json:"revenue_impact"`//$/monthattributedProductivityGainfloat64`json:"productivity_gain"`//hourssaved/monthHourlyRatefloat64`json:"hourly_rate"`//$/hourforproductivity}typeROIResultstruct{FeatureIDstring`json:"feature_id"`ROIScorefloat64`json:"roi_score"`//ratioMonthlyReturnfloat64`json:"monthly_return"`//$valuegeneratedMonthlySpendfloat64`json:"monthly_spend"`NetValuefloat64`json:"net_value"`PaybackDaysint`json:"payback_days"`Recommendationstring`json:"recommendation"`}funcCalculateROI(inputROIInput)*ROIResult{monthlyReturn:=input.RevenueImpact+(input.ProductivityGain*input.HourlyRate)netValue:=monthlyReturn-input.AISpendroiScore:=0.0ifinput.AISpend>0{roiScore=monthlyReturn/input.AISpend}paybackDays:=0ifmonthlyReturn>0{paybackDays=int(input.AISpend/(monthlyReturn/30))}rec:="invest_more"ifroiScore<0.5{rec="reduce_or_eliminate"}elseifroiScore<1.0{rec="optimize"}elseifroiScore<3.0{rec="maintain"}return&ROIResult{FeatureID:input.FeatureID,ROIScore:roiScore,MonthlyReturn:monthlyReturn,MonthlySpend:input.AISpend,NetValue:netValue,PaybackDays:paybackDays,Recommendation:rec,}}//───T161:TokenEfficiencyScore───────────────────────────typeEfficiencyScorestruct{TeamIDstring`json:"team_id"`TeamNamestring`json:"team_name"`TotalTokensint64`json:"total_tokens"`UsefulTokensint64`json:"useful_tokens"`//outputtokensonlyTotalCostfloat64`json:"total_cost"`Requestsint64`json:"requests"`EfficiencyScorefloat64`json:"efficiency_score"`//0-100Rankint`json:"rank"`}funcCalculateEfficiency(totalTokens,usefulTokensint64,costfloat64,requestsint64)float64{iftotalTokens==0||cost==0{return0}//Score=(useful_tokens/total_tokens)*(1/cost_per_1k)*normalizationratio:=float64(usefulTokens)/float64(totalTokens)costPer1k:=(cost/float64(totalTokens))*1000ifcostPer1k==0{return100}//Normalize:higherratioandlowercost=better//Scorecappedat100score:=ratio*(1.0/costPer1k)*10//scalingfactorifscore>100{score=100}returnscore}//───T163:Cross-ModelCostArbitrage───────────────────────typeModelPricestruct{Providerstring`json:"provider"`Modelstring`json:"model"`InputPer1Kfloat64`json:"input_per_1k"`OutputPer1Kfloat64`json:"output_per_1k"`UpdatedAttime.Time`json:"updated_at"`}typeArbitrageOpportunitystruct{CurrentProviderstring`json:"current_provider"`CurrentModelstring`json:"current_model"`CurrentCostfloat64`json:"current_cost"`BetterProviderstring`json:"better_provider"`BetterModelstring`json:"better_model"`BetterCostfloat64`json:"better_cost"`SavingsPercentfloat64`json:"savings_percent"`}typeArbitrageEnginestruct{musync.RWMutexprices[]ModelPriceminSavingsfloat64//minimumsavings%totrigger(default10%)equivalencesmap[string][]string//modelcapabilitygroups}funcNewArbitrageEngine(minSavingsPercentfloat64)*ArbitrageEngine{ifminSavingsPercent<=0{minSavingsPercent=10.0}return&ArbitrageEngine{minSavings:minSavingsPercent,equivalences:map[string][]string{"premium":{"gpt-4","gpt-4-turbo","gpt-4o","claude-3-opus","claude-opus-4","gemini-1.5-pro"},"standard":{"gpt-3.5-turbo","claude-3-sonnet","claude-sonnet-4","gemini-1.5-flash","mistral-large"},"fast":{"gpt-3.5-turbo","claude-3-haiku","claude-haiku-4.5","mistral-small","groq-mixtral"},"embed":{"text-embedding-3-small","text-embedding-3-large","voyage-3","cohere-embed-v3"},},}}func(e*ArbitrageEngine)UpdatePrices(prices[]ModelPrice){e.mu.Lock()defere.mu.Unlock()e.prices=prices}//FindOpportunitiesidentifiescheaperalternativesforagivenmodel.func(e*ArbitrageEngine)FindOpportunities(currentProvider,currentModelstring,avgInputTokens,avgOutputTokensint)[]ArbitrageOpportunity{e.mu.RLock()defere.mu.RUnlock()//FindcurrentcostvarcurrentPrice*ModelPricefori,p:=rangee.prices{ifp.Provider==currentProvider&&p.Model==currentModel{currentPrice=&e.prices[i]break}}ifcurrentPrice==nil{returnnil}currentCost:=(currentPrice.InputPer1K*float64(avgInputTokens)/1000)+(currentPrice.OutputPer1K*float64(avgOutputTokens)/1000)//Findequivalentmodelsvargroupstringforg,models:=rangee.equivalences{for_,m:=rangemodels{ifm==currentModel{group=gbreak}}}varopportunities[]ArbitrageOpportunityequivalents:=e.equivalences[group]for_,p:=rangee.prices{ifp.Provider==currentProvider&&p.Model==currentModel{continue}isEquivalent:=falsefor_,eq:=rangeequivalents{ifeq==p.Model{isEquivalent=truebreak}}if!isEquivalent&&group!=""{continue}altCost:=(p.InputPer1K*float64(avgInputTokens)/1000)+(p.OutputPer1K*float64(avgOutputTokens)/1000)ifcurrentCost>0{savings:=((currentCost-altCost)/currentCost)*100ifsavings>=e.minSavings{opportunities=append(opportunities,ArbitrageOpportunity{CurrentProvider:currentProvider,CurrentModel:currentModel,CurrentCost:currentCost,BetterProvider:p.Provider,BetterModel:p.Model,BetterCost:altCost,SavingsPercent:savings,})}}}sort.Slice(opportunities,func(i,jint)bool{returnopportunities[i].SavingsPercent>opportunities[j].SavingsPercent})returnopportunities}//───T164:AITrafficReplay&Simulation───────────────────typeRecordedRequeststruct{IDstring`json:"id"`Timestamptime.Time`json:"timestamp"`Modelstring`json:"model"`Providerstring`json:"provider"`Promptstring`json:"prompt"`Tokensint64`json:"tokens"`Costfloat64`json:"cost"`LatencyMsfloat64`json:"latency_ms"`Metadatamap[string]string`json:"metadata"`}typeSimulationResultstruct{OriginalModelstring`json:"original_model"`OriginalCostfloat64`json:"original_total_cost"`OriginalLatencyfloat64`json:"original_avg_latency_ms"`SimulatedModelstring`json:"simulated_model"`SimulatedCostfloat64`json:"simulated_total_cost"`SimulatedLatencyfloat64`json:"simulated_avg_latency_ms"`CostDifffloat64`json:"cost_diff"`CostDiffPercentfloat64`json:"cost_diff_percent"`LatencyDifffloat64`json:"latency_diff"`RequestCountint`json:"request_count"`}typeTrafficRecorderstruct{musync.RWMutexbuffer[]RecordedRequestmaxSizeint}funcNewTrafficRecorder(maxSizeint)*TrafficRecorder{ifmaxSize<=0{maxSize=10000}return&TrafficRecorder{buffer:make([]RecordedRequest,0,maxSize),maxSize:maxSize,}}func(r*TrafficRecorder)Record(reqRecordedRequest){r.mu.Lock()deferr.mu.Unlock()r.buffer=append(r.buffer,req)iflen(r.buffer)>r.maxSize{r.buffer=r.buffer[len(r.buffer)-r.maxSize:]}}func(r*TrafficRecorder)GetRecordings(limitint)[]RecordedRequest{r.mu.RLock()deferr.mu.RUnlock()iflimit<=0||limit>len(r.buffer){limit=len(r.buffer)}result:=make([]RecordedRequest,limit)copy(result,r.buffer[len(r.buffer)-limit:])returnresult}//Simulateestimateswhat-ifcostandlatencyforadifferentmodel.func(r*TrafficRecorder)Simulate(targetModelstring,pricesmap[string]ModelPrice,latencyEstimateMsfloat64)*SimulationResult{r.mu.RLock()records:=make([]RecordedRequest,len(r.buffer))copy(records,r.buffer)r.mu.RUnlock()iflen(records)==0{return&SimulationResult{SimulatedModel:targetModel}}varorigTotalCost,origTotalLatencyfloat64varsimTotalCostfloat64targetPrice,hasPrice:=prices[targetModel]for_,rec:=rangerecords{origTotalCost+=rec.CostorigTotalLatency+=rec.LatencyMsifhasPrice{//Estimate:usesametokencountwithtargetmodelpricingsimCost:=(targetPrice.InputPer1K*float64(rec.Tokens)*0.7/1000)+//~70%input(targetPrice.OutputPer1K*float64(rec.Tokens)*0.3/1000)//~30%outputsimTotalCost+=simCost}}n:=float64(len(records))return&SimulationResult{OriginalModel:records[0].Model,OriginalCost:origTotalCost,OriginalLatency:origTotalLatency/n,SimulatedModel:targetModel,SimulatedCost:simTotalCost,SimulatedLatency:latencyEstimateMs,CostDiff:simTotalCost-origTotalCost,CostDiffPercent:((simTotalCost-origTotalCost)/origTotalCost)*100,LatencyDiff:latencyEstimateMs-origTotalLatency/n,RequestCount:len(records),}}