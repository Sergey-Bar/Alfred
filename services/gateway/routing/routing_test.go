packagerouting_testimport("context""sync""testing""time""github.com/AlfredDev/alfred/services/gateway/routing""github.com/rs/zerolog")funcnewTestEngine()*routing.Engine{returnrouting.NewEngine(zerolog.Nop())}//──RuleCRUD────────────────────────────────────────────────funcTestEngine_AddRule(t*testing.T){e:=newTestEngine()e.AddRule(routing.Rule{ID:"r1",Name:"test-rule",Priority:10,Enabled:true,Action:routing.ActionRoute,Target:"openai",})rules:=e.ListRules()iflen(rules)!=1{t.Fatalf("expected1rule,got%d",len(rules))}ifrules[0].ID!="r1"{t.Errorf("expectedruleID'r1',got%q",rules[0].ID)}ifrules[0].UpdatedAt.IsZero(){t.Error("UpdatedAtshouldbesetautomatically")}}funcTestEngine_GetRule(t*testing.T){e:=newTestEngine()e.AddRule(routing.Rule{ID:"r1",Name:"first",Enabled:true})e.AddRule(routing.Rule{ID:"r2",Name:"second",Enabled:true})rule,found:=e.GetRule("r2")if!found{t.Fatal("ruler2notfound")}ifrule.Name!="second"{t.Errorf("expected'second',got%q",rule.Name)}_,found=e.GetRule("nonexistent")iffound{t.Error("nonexistentruleshouldnotbefound")}}funcTestEngine_UpdateRule(t*testing.T){e:=newTestEngine()e.AddRule(routing.Rule{ID:"r1",Name:"original",Priority:10,Enabled:true})err:=e.UpdateRule(routing.Rule{ID:"r1",Name:"updated",Priority:5,Enabled:true})iferr!=nil{t.Fatalf("updatefailed:%v",err)}rule,_:=e.GetRule("r1")ifrule.Name!="updated"{t.Errorf("expected'updated',got%q",rule.Name)}ifrule.Priority!=5{t.Errorf("expectedpriority5,got%d",rule.Priority)}}funcTestEngine_UpdateRule_NotFound(t*testing.T){e:=newTestEngine()err:=e.UpdateRule(routing.Rule{ID:"nonexistent"})iferr==nil{t.Error("expectederrorfornonexistentrule")}}funcTestEngine_DeleteRule(t*testing.T){e:=newTestEngine()e.AddRule(routing.Rule{ID:"r1",Enabled:true})e.AddRule(routing.Rule{ID:"r2",Enabled:true})err:=e.DeleteRule("r1")iferr!=nil{t.Fatalf("deletefailed:%v",err)}iflen(e.ListRules())!=1{t.Error("expected1ruleafterdeletion")}}funcTestEngine_DeleteRule_NotFound(t*testing.T){e:=newTestEngine()err:=e.DeleteRule("nonexistent")iferr==nil{t.Error("expectederrorfornonexistentrule")}}//──PriorityOrdering─────────────────────────────────────────funcTestEngine_PriorityOrdering(t*testing.T){e:=newTestEngine()e.AddRule(routing.Rule{ID:"low",Priority:100,Enabled:true})e.AddRule(routing.Rule{ID:"high",Priority:1,Enabled:true})e.AddRule(routing.Rule{ID:"mid",Priority:50,Enabled:true})rules:=e.ListRules()ifrules[0].ID!="high"||rules[1].ID!="mid"||rules[2].ID!="low"{t.Errorf("rulesnotsortedbypriority:%v,%v,%v",rules[0].ID,rules[1].ID,rules[2].ID)}}//──Evaluate—ConditionOperators────────────────────────────funcTestEvaluate_EqualsCondition(t*testing.T){e:=newTestEngine()e.AddRule(routing.Rule{ID:"eq-rule",Name:"match-gpt4",Priority:1,Enabled:true,Action:routing.ActionRoute,Target:"openai",Conditions:[]routing.Condition{{Field:"model",Operator:routing.OpEquals,Value:"gpt-4"},},})decision:=e.Evaluate(context.Background(),routing.RoutingContext{Model:"gpt-4",})ifdecision.RuleID!="eq-rule"{t.Errorf("expectedeq-rule,got%q",decision.RuleID)}ifdecision.Provider!="openai"{t.Errorf("expectedprovider'openai',got%q",decision.Provider)}}funcTestEvaluate_NotEqualsCondition(t*testing.T){e:=newTestEngine()e.AddRule(routing.Rule{ID:"neq-rule",Priority:1,Enabled:true,Action:routing.ActionBlock,Conditions:[]routing.Condition{{Field:"model",Operator:routing.OpNotEquals,Value:"gpt-4"},},})//Non-matchingmodelshouldtriggerruledecision:=e.Evaluate(context.Background(),routing.RoutingContext{Model:"claude-3",})ifdecision.RuleID!="neq-rule"{t.Error("neqruleshouldmatchfordifferentmodel")}//MatchingmodelshouldNOTtriggerruledecision=e.Evaluate(context.Background(),routing.RoutingContext{Model:"gpt-4",})ifdecision.RuleID=="neq-rule"{t.Error("neqruleshouldnotmatchforsamemodel")}}funcTestEvaluate_ContainsCondition(t*testing.T){e:=newTestEngine()e.AddRule(routing.Rule{ID:"contains-rule",Priority:1,Enabled:true,Action:routing.ActionRoute,Target:"anthropic",Conditions:[]routing.Condition{{Field:"model",Operator:routing.OpContains,Value:"claude"},},})decision:=e.Evaluate(context.Background(),routing.RoutingContext{Model:"claude-3-sonnet",})ifdecision.RuleID!="contains-rule"{t.Error("containsruleshouldmatch'claude-3-sonnet'")}}funcTestEvaluate_StartsWithCondition(t*testing.T){e:=newTestEngine()e.AddRule(routing.Rule{ID:"sw-rule",Priority:1,Enabled:true,Action:routing.ActionRoute,Target:"openai",Conditions:[]routing.Condition{{Field:"model",Operator:routing.OpStartsWith,Value:"gpt"},},})decision:=e.Evaluate(context.Background(),routing.RoutingContext{Model:"gpt-4-turbo",})ifdecision.RuleID!="sw-rule"{t.Error("starts_withruleshouldmatch'gpt-4-turbo'")}decision=e.Evaluate(context.Background(),routing.RoutingContext{Model:"claude-3",})ifdecision.RuleID=="sw-rule"{t.Error("starts_withruleshouldnotmatch'claude-3'")}}funcTestEvaluate_NumericComparisons(t*testing.T){e:=newTestEngine()e.AddRule(routing.Rule{ID:"large-req",Priority:1,Enabled:true,Action:routing.ActionRoute,Target:"anthropic",Conditions:[]routing.Condition{{Field:"token_estimate",Operator:routing.OpGT,Value:1000},},})//Largerequestmatchesdecision:=e.Evaluate(context.Background(),routing.RoutingContext{TokenEstimate:5000,})ifdecision.RuleID!="large-req"{t.Error("GTruleshouldmatchtoken_estimate=5000>1000")}//Smallrequestdoesn'tmatchdecision=e.Evaluate(context.Background(),routing.RoutingContext{TokenEstimate:500,})ifdecision.RuleID=="large-req"{t.Error("GTruleshouldnotmatchtoken_estimate=500<=1000")}}funcTestEvaluate_LTECondition(t*testing.T){e:=newTestEngine()e.AddRule(routing.Rule{ID:"small-req",Priority:1,Enabled:true,Action:routing.ActionRoute,Target:"groq",Conditions:[]routing.Condition{{Field:"token_estimate",Operator:routing.OpLTE,Value:100},},})decision:=e.Evaluate(context.Background(),routing.RoutingContext{TokenEstimate:100,})ifdecision.RuleID!="small-req"{t.Error("LTEruleshouldmatchtoken_estimate=100")}decision=e.Evaluate(context.Background(),routing.RoutingContext{TokenEstimate:101,})ifdecision.RuleID=="small-req"{t.Error("LTEruleshouldnotmatchtoken_estimate=101")}}funcTestEvaluate_InCondition(t*testing.T){e:=newTestEngine()e.AddRule(routing.Rule{ID:"team-rule",Priority:1,Enabled:true,Action:routing.ActionRoute,Target:"openai",Conditions:[]routing.Condition{{Field:"team_id",Operator:routing.OpIn,Value:[]interface{}{"team-a","team-b","team-c"}},},})decision:=e.Evaluate(context.Background(),routing.RoutingContext{TeamID:"team-b",})ifdecision.RuleID!="team-rule"{t.Error("INruleshouldmatchteam-bin[team-a,team-b,team-c]")}decision=e.Evaluate(context.Background(),routing.RoutingContext{TeamID:"team-x",})ifdecision.RuleID=="team-rule"{t.Error("INruleshouldnotmatchteam-x")}}funcTestEvaluate_NotInCondition(t*testing.T){e:=newTestEngine()e.AddRule(routing.Rule{ID:"exclude-rule",Priority:1,Enabled:true,Action:routing.ActionBlock,Conditions:[]routing.Condition{{Field:"model",Operator:routing.OpNotIn,Value:[]interface{}{"gpt-4","claude-3"}},},})decision:=e.Evaluate(context.Background(),routing.RoutingContext{Model:"llama-2",})ifdecision.RuleID!="exclude-rule"{t.Error("NOT_INshouldmatchllama-2notin[gpt-4,claude-3]")}decision=e.Evaluate(context.Background(),routing.RoutingContext{Model:"gpt-4",})ifdecision.RuleID=="exclude-rule"{t.Error("NOT_INshouldnotmatchgpt-4whichisinthelist")}}//──MultipleConditions(ANDLogic)──────────────────────────funcTestEvaluate_MultipleConditionsAND(t*testing.T){e:=newTestEngine()e.AddRule(routing.Rule{ID:"complex-rule",Priority:1,Enabled:true,Action:routing.ActionRoute,Target:"anthropic",Conditions:[]routing.Condition{{Field:"model",Operator:routing.OpContains,Value:"claude"},{Field:"team_id",Operator:routing.OpEquals,Value:"premium"},{Field:"token_estimate",Operator:routing.OpGTE,Value:500},},})//Allconditionsmatchdecision:=e.Evaluate(context.Background(),routing.RoutingContext{Model:"claude-3-sonnet",TeamID:"premium",TokenEstimate:1000,})ifdecision.RuleID!="complex-rule"{t.Error("allconditionsmatch,shouldtriggerrule")}//Oneconditionfailsdecision=e.Evaluate(context.Background(),routing.RoutingContext{Model:"claude-3-sonnet",TeamID:"basic",TokenEstimate:1000,})ifdecision.RuleID=="complex-rule"{t.Error("team_idmismatch,shouldnottriggerrule")}}//──DisabledRules───────────────────────────────────────────funcTestEvaluate_SkipsDisabledRules(t*testing.T){e:=newTestEngine()e.AddRule(routing.Rule{ID:"disabled",Priority:1,Enabled:false,Action:routing.ActionBlock,})decision:=e.Evaluate(context.Background(),routing.RoutingContext{Model:"anything",})ifdecision.RuleID=="disabled"{t.Error("disabledruleshouldbeskipped")}}//──NoMatchingRules────────────────────────────────────────funcTestEvaluate_DefaultDecisionWhenNoMatch(t*testing.T){e:=newTestEngine()e.AddRule(routing.Rule{ID:"specific",Priority:1,Enabled:true,Action:routing.ActionRoute,Target:"openai",Conditions:[]routing.Condition{{Field:"model",Operator:routing.OpEquals,Value:"gpt-4"},},})decision:=e.Evaluate(context.Background(),routing.RoutingContext{Model:"claude-3",Provider:"anthropic",})ifdecision.RuleID!=""{t.Errorf("expectedemptyruleID,got%q",decision.RuleID)}ifdecision.Provider!="anthropic"{t.Errorf("expecteddefaultprovider'anthropic',got%q",decision.Provider)}ifdecision.Reason==""{t.Error("defaultdecisionshouldhaveareason")}}//──Time-BasedConditions─────────────────────────────────────funcTestEvaluate_HourCondition(t*testing.T){e:=newTestEngine()e.AddRule(routing.Rule{ID:"night-rule",Priority:1,Enabled:true,Action:routing.ActionRoute,Target:"cheap-provider",Conditions:[]routing.Condition{{Field:"hour",Operator:routing.OpGTE,Value:22},},})//11PMmatchesdecision:=e.Evaluate(context.Background(),routing.RoutingContext{RequestTime:time.Date(2026,2,20,23,0,0,0,time.UTC),})ifdecision.RuleID!="night-rule"{t.Error("hour=23shouldmatch>=22")}//2PMdoesn'tmatchdecision=e.Evaluate(context.Background(),routing.RoutingContext{RequestTime:time.Date(2026,2,20,14,0,0,0,time.UTC),})ifdecision.RuleID=="night-rule"{t.Error("hour=14shouldnotmatch>=22")}}//──Tag-BasedConditions─────────────────────────────────────funcTestEvaluate_TagCondition(t*testing.T){e:=newTestEngine()e.AddRule(routing.Rule{ID:"tag-rule",Priority:1,Enabled:true,Action:routing.ActionRoute,Target:"specialized",Conditions:[]routing.Condition{{Field:"tag.environment",Operator:routing.OpEquals,Value:"production"},},})decision:=e.Evaluate(context.Background(),routing.RoutingContext{Tags:map[string]string{"environment":"production"},})ifdecision.RuleID!="tag-rule"{t.Error("tag.environment=productionshouldmatch")}}//──Actions──────────────────────────────────────────────────funcTestEvaluate_BlockAction(t*testing.T){e:=newTestEngine()e.AddRule(routing.Rule{ID:"block-rule",Priority:1,Enabled:true,Action:routing.ActionBlock,Conditions:[]routing.Condition{{Field:"model",Operator:routing.OpEquals,Value:"dangerous-model"},},})decision:=e.Evaluate(context.Background(),routing.RoutingContext{Model:"dangerous-model",})ifdecision.Action!=routing.ActionBlock{t.Errorf("expectedblockaction,got%q",decision.Action)}}funcTestEvaluate_FallbackAction(t*testing.T){e:=newTestEngine()e.AddRule(routing.Rule{ID:"fb-rule",Priority:1,Enabled:true,Action:routing.ActionFallback,Target:"openai",Fallbacks:[]string{"anthropic","google"},})decision:=e.Evaluate(context.Background(),routing.RoutingContext{})ifdecision.Action!=routing.ActionFallback{t.Errorf("expectedfallbackaction,got%q",decision.Action)}iflen(decision.Fallbacks)!=2{t.Errorf("expected2fallbacks,got%d",len(decision.Fallbacks))}}//──FailoverState────────────────────────────────────────────funcTestFailoverState_HealthyByDefault(t*testing.T){fs:=routing.NewFailoverState(3,30*time.Second)if!fs.IsHealthy("openai"){t.Error("providershouldbehealthybydefault")}}funcTestFailoverState_UnhealthyAfterThreshold(t*testing.T){fs:=routing.NewFailoverState(3,30*time.Second)fs.RecordFailure("openai")fs.RecordFailure("openai")if!fs.IsHealthy("openai"){t.Error("shouldstillbehealthywith2failures(threshold=3)")}fs.RecordFailure("openai")iffs.IsHealthy("openai"){t.Error("shouldbeunhealthyafter3failures")}}funcTestFailoverState_SuccessResetsCounter(t*testing.T){fs:=routing.NewFailoverState(3,30*time.Second)fs.RecordFailure("openai")fs.RecordFailure("openai")fs.RecordSuccess("openai")//Aftersuccess,failuresresetfs.RecordFailure("openai")fs.RecordFailure("openai")if!fs.IsHealthy("openai"){t.Error("shouldbehealthy—successresetthecounter")}}funcTestFailoverState_SelectProvider_Preferred(t*testing.T){fs:=routing.NewFailoverState(3,30*time.Second)result:=fs.SelectProvider("openai",[]string{"anthropic","google"})ifresult!="openai"{t.Errorf("expectedpreferred'openai',got%q",result)}}funcTestFailoverState_SelectProvider_Fallback(t*testing.T){fs:=routing.NewFailoverState(1,1*time.Hour)//Markpreferredasunhealthyfs.RecordFailure("openai")result:=fs.SelectProvider("openai",[]string{"anthropic","google"})ifresult!="anthropic"{t.Errorf("expectedfirsthealthyfallback'anthropic',got%q",result)}}funcTestFailoverState_SelectProvider_AllUnhealthy(t*testing.T){fs:=routing.NewFailoverState(1,1*time.Hour)fs.RecordFailure("openai")fs.RecordFailure("anthropic")fs.RecordFailure("google")result:=fs.SelectProvider("openai",[]string{"anthropic","google"})ifresult!="openai"{t.Errorf("allunhealthy—expectedpreferred'openai'asfallback,got%q",result)}}//──ConcurrentAccess─────────────────────────────────────────funcTestEngine_ConcurrentEvaluate(t*testing.T){e:=newTestEngine()e.AddRule(routing.Rule{ID:"concurrent-rule",Priority:1,Enabled:true,Action:routing.ActionRoute,Target:"openai",Conditions:[]routing.Condition{{Field:"model",Operator:routing.OpEquals,Value:"gpt-4"},},})varwgsync.WaitGroupfori:=0;i<100;i++{wg.Add(1)gofunc(){deferwg.Done()e.Evaluate(context.Background(),routing.RoutingContext{Model:"gpt-4"})}()}wg.Wait()}funcTestFailoverState_ConcurrentAccess(t*testing.T){fs:=routing.NewFailoverState(5,30*time.Second)varwgsync.WaitGroupfori:=0;i<100;i++{wg.Add(1)gofunc(){deferwg.Done()fs.RecordFailure("openai")fs.IsHealthy("openai")fs.RecordSuccess("openai")}()}wg.Wait()}//──DecisionMetadata─────────────────────────────────────────funcTestEvaluate_DecisionContainsMetadata(t*testing.T){e:=newTestEngine()e.AddRule(routing.Rule{ID:"meta-rule",Name:"metadata-test",Priority:5,Enabled:true,Action:routing.ActionRoute,Target:"openai",Conditions:[]routing.Condition{{Field:"model",Operator:routing.OpEquals,Value:"gpt-4"},},})decision:=e.Evaluate(context.Background(),routing.RoutingContext{Model:"gpt-4"})ifdecision.RuleID!="meta-rule"{t.Errorf("expectedruleID'meta-rule',got%q",decision.RuleID)}ifdecision.RuleName!="metadata-test"{t.Errorf("expectedrulename'metadata-test',got%q",decision.RuleName)}ifdecision.Reason==""{t.Error("reasonshouldbepopulated")}}