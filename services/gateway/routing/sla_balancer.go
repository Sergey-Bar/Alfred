packageroutingimport("math""sort""sync""time""github.com/rs/zerolog")//SLATargetdefinestheSLAthresholdsforaprovider.typeSLATargetstruct{//MaxP95LatencyMsistheP95latencyceilinginms.Exceedingthisdegradesthescore.MaxP95LatencyMsfloat64`json:"max_p95_latency_ms"`//MaxErrorRateistheacceptableerrorrate(0-1).E.g.,0.01=1%.MaxErrorRatefloat64`json:"max_error_rate"`//MinAvailabilityistheminimumuptimeratio(0-1).E.g.,0.999=99.9%.MinAvailabilityfloat64`json:"min_availability"`//Weightisastaticpreferenceweight(1.0=neutral,>1=preferred).Weightfloat64`json:"weight"`}//DefaultSLATargetreturnsastandardSLAtarget.funcDefaultSLATarget()SLATarget{returnSLATarget{MaxP95LatencyMs:5000,MaxErrorRate:0.05,MinAvailability:0.99,Weight:1.0,}}//ProviderHealthtracksreal-timehealthmetricsforaprovider.typeProviderHealthstruct{musync.Mutex//Exponentialweightedmovingaveragelatency(ms)ewmaLatencyMsfloat64ewmaAlphafloat64//smoothingfactor(default:0.3)//SlidingwindowerrortrackingtotalRequestsint64totalErrorsint64windowStarttime.TimewindowSizetime.Duration//AvailabilitytrackinglastHealthChecktime.TimehealthyboolfailedChecksinttotalChecksint//Penalty:temporaryscorereduction(decaysovertime)penaltyfloat64penaltyTimetime.Time}//NewProviderHealthcreatesfreshhealthtrackingforaprovider.funcNewProviderHealth()*ProviderHealth{return&ProviderHealth{ewmaAlpha:0.3,healthy:true,windowStart:time.Now(),windowSize:5*time.Minute,}}//RecordLatencyrecordsarequestlatencyobservation.func(ph*ProviderHealth)RecordLatency(msfloat64){ph.mu.Lock()deferph.mu.Unlock()ifph.ewmaLatencyMs==0{ph.ewmaLatencyMs=ms}else{ph.ewmaLatencyMs=ph.ewmaAlpha*ms+(1-ph.ewmaAlpha)*ph.ewmaLatencyMs}ph.totalRequests++}//RecordErrorrecordsafailedrequest.func(ph*ProviderHealth)RecordError(){ph.mu.Lock()deferph.mu.Unlock()ph.totalErrors++ph.totalRequests++}//RecordHealthCheckrecordsahealthcheckresult.func(ph*ProviderHealth)RecordHealthCheck(healthybool){ph.mu.Lock()deferph.mu.Unlock()ph.lastHealthCheck=time.Now()ph.totalChecks++ph.healthy=healthyif!healthy{ph.failedChecks++}}//AddPenaltyappliesatemporaryscorepenalty(0-1).func(ph*ProviderHealth)AddPenalty(amountfloat64){ph.mu.Lock()deferph.mu.Unlock()ph.penalty=math.Min(1.0,ph.penalty+amount)ph.penaltyTime=time.Now()}//snapshotreturnsacopyofcurrentmetrics.func(ph*ProviderHealth)snapshot()providerSnapshot{ph.mu.Lock()deferph.mu.Unlock()//Resetwindowifexpirediftime.Since(ph.windowStart)>ph.windowSize{ph.totalRequests=0ph.totalErrors=0ph.windowStart=time.Now()}//Decaypenaltyover5minutescurrentPenalty:=ph.penaltyifcurrentPenalty>0&&!ph.penaltyTime.IsZero(){elapsed:=time.Since(ph.penaltyTime).Minutes()currentPenalty=ph.penalty*math.Exp(-elapsed/5.0)ifcurrentPenalty<0.01{currentPenalty=0}}errorRate:=0.0ifph.totalRequests>0{errorRate=float64(ph.totalErrors)/float64(ph.totalRequests)}availability:=1.0ifph.totalChecks>0{availability=1.0-float64(ph.failedChecks)/float64(ph.totalChecks)}returnproviderSnapshot{ewmaLatencyMs:ph.ewmaLatencyMs,errorRate:errorRate,availability:availability,healthy:ph.healthy,penalty:currentPenalty,totalRequests:ph.totalRequests,}}typeproviderSnapshotstruct{ewmaLatencyMsfloat64errorRatefloat64availabilityfloat64healthyboolpenaltyfloat64totalRequestsint64}//───SLA-AwareLoadBalancer────────────────────────────────//SLABalancerroutesrequeststothebestavailableprovider//basedonlatency,errorrate,availability,andSLAtargets.typeSLABalancerstruct{musync.RWMutexprovidersmap[string]*ProviderHealthtargetsmap[string]SLATargetloggerzerolog.Logger}//NewSLABalancercreatesanewSLA-awareloadbalancer.funcNewSLABalancer(loggerzerolog.Logger)*SLABalancer{return&SLABalancer{providers:make(map[string]*ProviderHealth),targets:make(map[string]SLATarget),logger:logger.With().Str("component","sla-balancer").Logger(),}}//RegisterProviderregistersaproviderwithanSLAtarget.func(lb*SLABalancer)RegisterProvider(namestring,targetSLATarget){lb.mu.Lock()deferlb.mu.Unlock()lb.providers[name]=NewProviderHealth()lb.targets[name]=target}//GetHealthreturnsthehealthtrackerforaprovider.func(lb*SLABalancer)GetHealth(namestring)*ProviderHealth{lb.mu.RLock()deferlb.mu.RUnlock()returnlb.providers[name]}//───Scoring────────────────────────────────────────────────//providerScoreholdsthecomputedscoreandmetadataforranking.typeproviderScorestruct{NamestringScorefloat64snapproviderSnapshot}//SelectProviderpicksthebestproviderfromthegivencandidates.//Ifcandidatesisempty,considersallregisteredproviders.//Returnstheprovidernameandthecomputedscore.func(lb*SLABalancer)SelectProvider(candidates[]string)(string,float64){lb.mu.RLock()deferlb.mu.RUnlock()iflen(candidates)==0{candidates=make([]string,0,len(lb.providers))forname:=rangelb.providers{candidates=append(candidates,name)}}scores:=make([]providerScore,0,len(candidates))for_,name:=rangecandidates{health,ok:=lb.providers[name]if!ok{continue}target,ok:=lb.targets[name]if!ok{target=DefaultSLATarget()}snap:=health.snapshot()score:=lb.computeScore(snap,target)scores=append(scores,providerScore{Name:name,Score:score,snap:snap})}iflen(scores)==0{return"",0}//Sortdescendingbyscore(highest=best)sort.Slice(scores,func(i,jint)bool{returnscores[i].Score>scores[j].Score})best:=scores[0]lb.logger.Debug().Str("selected",best.Name).Float64("score",best.Score).Float64("latency_ms",best.snap.ewmaLatencyMs).Float64("error_rate",best.snap.errorRate).Int("candidates",len(scores)).Msg("SLAbalancerselectedprovider")returnbest.Name,best.Score}//computeScorecalculatesa0-1compositescoreforaprovider.////Formula:////score=weight×(latencyScore×0.35+errorScore×0.30+availScore×0.25+freshnessScore×0.10)×(1-penalty)////Eachsub-scoreis0-1.Higherisbetter.func(lb*SLABalancer)computeScore(snapproviderSnapshot,targetSLATarget)float64{//Ifunhealthy,scoreis0(circuit-breakstyle)if!snap.healthy{return0}//1.Latencyscore:1.0whenat/belowtarget,degradesaslatencyriseslatencyScore:=1.0ifsnap.ewmaLatencyMs>0&&target.MaxP95LatencyMs>0{ratio:=snap.ewmaLatencyMs/target.MaxP95LatencyMsifratio>1.0{//ExponentialpenaltybeyondSLAlatencyScore=math.Exp(-(ratio-1.0)*2.0)}else{latencyScore=1.0}}//2.Errorratescore:1.0whenat/belowtargeterrorScore:=1.0ifsnap.totalRequests>10{//Needminimumsampleiftarget.MaxErrorRate>0{ratio:=snap.errorRate/target.MaxErrorRateifratio>1.0{errorScore=math.Exp(-(ratio-1.0)*3.0)}}elseifsnap.errorRate>0{errorScore=1.0-snap.errorRate}}//3.Availabilityscore:binary-ish—sharpdropoffbelowSLAavailScore:=1.0ifsnap.availability<target.MinAvailability{availScore=snap.availability/target.MinAvailability}//4.Freshnessscore:preferproviderswithmorerecentdatafreshnessScore:=1.0ifsnap.totalRequests==0{freshnessScore=0.5//Unknownquality—givemoderatescore}//Weightedcompositecomposite:=latencyScore*0.35+errorScore*0.30+availScore*0.25+freshnessScore*0.10//Applystaticpreferenceweightweight:=target.Weightifweight<=0{weight=1.0}//ApplypenaltypenaltyMult:=1.0-snap.penaltyreturncomposite*weight*penaltyMult}//GetScoresreturnsthecurrentscoresforallregisteredproviders.//Usefulfordashboarddisplayanddebugging.func(lb*SLABalancer)GetScores()[]providerScore{lb.mu.RLock()deferlb.mu.RUnlock()scores:=make([]providerScore,0,len(lb.providers))forname,health:=rangelb.providers{target,ok:=lb.targets[name]if!ok{target=DefaultSLATarget()}snap:=health.snapshot()score:=lb.computeScore(snap,target)scores=append(scores,providerScore{Name:name,Score:score,snap:snap})}sort.Slice(scores,func(i,jint)bool{returnscores[i].Score>scores[j].Score})returnscores}//RecordSuccessrecordsasuccessfulrequesttothenamedprovider.func(lb*SLABalancer)RecordSuccess(providerstring,latencyMsfloat64){lb.mu.RLock()health:=lb.providers[provider]lb.mu.RUnlock()ifhealth!=nil{health.RecordLatency(latencyMs)}}//RecordFailurerecordsafailedrequest.func(lb*SLABalancer)RecordFailure(providerstring){lb.mu.RLock()health:=lb.providers[provider]lb.mu.RUnlock()ifhealth!=nil{health.RecordError()}}