packageroutingimport("context""encoding/json""fmt""sort""strings""sync""time""github.com/rs/zerolog")//RuleActiondefineswhathappenswhenarulematches.typeRuleActionstringconst(ActionRouteRuleAction="route"//RoutetoaspecificproviderActionBlockRuleAction="block"//BlocktherequestActionRedirectRuleAction="redirect"//RedirecttoadifferentmodelActionFallbackRuleAction="fallback"//Usefallbackchain)//ConditionOpdefinesconditioncomparisonoperators.typeConditionOpstringconst(OpEqualsConditionOp="eq"OpNotEqualsConditionOp="neq"OpContainsConditionOp="contains"OpStartsWithConditionOp="starts_with"OpGTConditionOp="gt"OpLTConditionOp="lt"OpGTEConditionOp="gte"OpLTEConditionOp="lte"OpInConditionOp="in"OpNotInConditionOp="not_in")//Conditionrepresentsasinglerulecondition.typeConditionstruct{Fieldstring`json:"field"`//e.g.,"model","team_id","user_id","hour","token_estimate"OperatorConditionOp`json:"operator"`//e.g.,"eq","gt","in"Valueinterface{}`json:"value"`//Comparisonvalue}//Rulerepresentsaroutingrule.typeRulestruct{IDstring`json:"id"`Namestring`json:"name"`Descriptionstring`json:"description,omitempty"`Priorityint`json:"priority"`//Lower=higherpriorityEnabledbool`json:"enabled"`Conditions[]Condition`json:"conditions"`//Allconditionsmustmatch(AND)ActionRuleAction`json:"action"`Targetstring`json:"target,omitempty"`//TargetproviderormodelFallbacks[]string`json:"fallbacks,omitempty"`//Fallbackproviders(T094)MaxRetriesint`json:"max_retries,omitempty"`CreatedAttime.Time`json:"created_at"`UpdatedAttime.Time`json:"updated_at"`}//RoutingContextcontainsrequestmetadatausedforruleevaluation.typeRoutingContextstruct{Modelstring`json:"model"`Providerstring`json:"provider"`TeamIDstring`json:"team_id"`UserIDstring`json:"user_id"`TokenEstimateint`json:"token_estimate"`MaxTokensint`json:"max_tokens"`IsFreeModelbool`json:"is_free_model"`Tagsmap[string]string`json:"tags"`RequestTimetime.Time`json:"request_time"`}//RoutingDecisionistheresultofruleevaluation.typeRoutingDecisionstruct{RuleIDstring`json:"rule_id"`RuleNamestring`json:"rule_name"`ActionRuleAction`json:"action"`Providerstring`json:"provider"`Modelstring`json:"model,omitempty"`Fallbacks[]string`json:"fallbacks,omitempty"`Reasonstring`json:"reason"`//T098:whythisrulematchedEvalTimeNsint64`json:"eval_time_ns"`}//Engineistheroutingruleevaluationengine.typeEnginestruct{musync.RWMutexrules[]Ruleloggerzerolog.Logger}//NewEnginecreatesanewroutingengine.funcNewEngine(loggerzerolog.Logger)*Engine{return&Engine{rules:make([]Rule,0),logger:logger.With().Str("component","routing-engine").Logger(),}}//AddRuleaddsaroutingruleandre-sortsbypriority.func(e*Engine)AddRule(ruleRule){e.mu.Lock()defere.mu.Unlock()ifrule.CreatedAt.IsZero(){rule.CreatedAt=time.Now().UTC()}rule.UpdatedAt=time.Now().UTC()e.rules=append(e.rules,rule)e.sortRulesLocked()}//UpdateRuleupdatesanexistingrulebyID.func(e*Engine)UpdateRule(ruleRule)error{e.mu.Lock()defere.mu.Unlock()fori,r:=rangee.rules{ifr.ID==rule.ID{rule.CreatedAt=r.CreatedAtrule.UpdatedAt=time.Now().UTC()e.rules[i]=rulee.sortRulesLocked()returnnil}}returnfmt.Errorf("rule%snotfound",rule.ID)}//DeleteRuleremovesarulebyID.func(e*Engine)DeleteRule(idstring)error{e.mu.Lock()defere.mu.Unlock()fori,r:=rangee.rules{ifr.ID==id{e.rules=append(e.rules[:i],e.rules[i+1:]...)returnnil}}returnfmt.Errorf("rule%snotfound",id)}//GetRulereturnsarulebyID.func(e*Engine)GetRule(idstring)(Rule,bool){e.mu.RLock()defere.mu.RUnlock()for_,r:=rangee.rules{ifr.ID==id{returnr,true}}returnRule{},false}//ListRulesreturnsallrulessortedbypriority.func(e*Engine)ListRules()[]Rule{e.mu.RLock()defere.mu.RUnlock()result:=make([]Rule,len(e.rules))copy(result,e.rules)returnresult}//Evaluateprocessesrulesagainstaroutingcontext(T092).//Returnsthefirstmatchingrule'sdecision,ornilifnorulesmatch.func(e*Engine)Evaluate(ctxcontext.Context,rcRoutingContext)*RoutingDecision{start:=time.Now()e.mu.RLock()defere.mu.RUnlock()for_,rule:=rangee.rules{if!rule.Enabled{continue}ife.matchesAllConditions(rule.Conditions,rc){decision:=&RoutingDecision{RuleID:rule.ID,RuleName:rule.Name,Action:rule.Action,Provider:rule.Target,Fallbacks:rule.Fallbacks,EvalTimeNs:time.Since(start).Nanoseconds(),Reason:fmt.Sprintf("matchedrule'%s'(priority=%d,conditions=%d)",rule.Name,rule.Priority,len(rule.Conditions)),}//T098:Logroutingdecision.e.logger.Info().Str("rule_id",rule.ID).Str("rule_name",rule.Name).Str("action",string(rule.Action)).Str("target",rule.Target).Str("model",rc.Model).Str("team",rc.TeamID).Int64("eval_ns",decision.EvalTimeNs).Msg("routingdecisionmade")returndecision}}//Norulematched—defaultrouting.return&RoutingDecision{Action:ActionRoute,Provider:rc.Provider,Reason:"norulesmatched;usingdefaultprovider",EvalTimeNs:time.Since(start).Nanoseconds(),}}//matchesAllConditionschecksifALLconditionsinarulearesatisfied.func(e*Engine)matchesAllConditions(conditions[]Condition,rcRoutingContext)bool{for_,cond:=rangeconditions{if!e.matchCondition(cond,rc){returnfalse}}returntrue}//matchConditionevaluatesasingleconditionagainsttheroutingcontext.func(e*Engine)matchCondition(condCondition,rcRoutingContext)bool{fieldValue:=e.resolveField(cond.Field,rc)switchcond.Operator{caseOpEquals:returnfmt.Sprintf("%v",fieldValue)==fmt.Sprintf("%v",cond.Value)caseOpNotEquals:returnfmt.Sprintf("%v",fieldValue)!=fmt.Sprintf("%v",cond.Value)caseOpContains:returnstrings.Contains(fmt.Sprintf("%v",fieldValue),fmt.Sprintf("%v",cond.Value),)caseOpStartsWith:returnstrings.HasPrefix(fmt.Sprintf("%v",fieldValue),fmt.Sprintf("%v",cond.Value),)caseOpGT,OpGTE,OpLT,OpLTE:returne.compareNumeric(cond.Operator,fieldValue,cond.Value)caseOpIn,OpNotIn:returne.matchIn(cond.Operator,fieldValue,cond.Value)default:e.logger.Warn().Str("op",string(cond.Operator)).Msg("unknownconditionoperator")returnfalse}}//resolveFieldextractsavaluefromtheroutingcontextbyfieldname.func(e*Engine)resolveField(fieldstring,rcRoutingContext)interface{}{switchfield{case"model":returnrc.Modelcase"provider":returnrc.Providercase"team_id":returnrc.TeamIDcase"user_id":returnrc.UserIDcase"token_estimate":returnrc.TokenEstimatecase"max_tokens":returnrc.MaxTokenscase"is_free_model":returnrc.IsFreeModelcase"hour":returnrc.RequestTime.Hour()case"day_of_week":returnint(rc.RequestTime.Weekday())default://Checktags.ifstrings.HasPrefix(field,"tag."){tagKey:=strings.TrimPrefix(field,"tag.")ifval,ok:=rc.Tags[tagKey];ok{returnval}}return""}}//compareNumerichandlesnumericcomparisonoperators.func(e*Engine)compareNumeric(opConditionOp,fieldVal,condValinterface{})bool{fv:=toFloat64(fieldVal)cv:=toFloat64(condVal)switchop{caseOpGT:returnfv>cvcaseOpGTE:returnfv>=cvcaseOpLT:returnfv<cvcaseOpLTE:returnfv<=cvdefault:returnfalse}}//matchInchecksifafieldvalueisin(ornotin)alist.func(e*Engine)matchIn(opConditionOp,fieldVal,condValinterface{})bool{fieldStr:=fmt.Sprintf("%v",fieldVal)//condValshouldbeaslice.varlist[]stringswitchv:=condVal.(type){case[]string:list=vcase[]interface{}:for_,item:=rangev{list=append(list,fmt.Sprintf("%v",item))}casestring://TryJSONparse.iferr:=json.Unmarshal([]byte(v),&list);err!=nil{list=strings.Split(v,",")}default:returnfalse}found:=falsefor_,item:=rangelist{ifstrings.TrimSpace(item)==fieldStr{found=truebreak}}ifop==OpIn{returnfound}return!found//OpNotIn}func(e*Engine)sortRulesLocked(){sort.Slice(e.rules,func(i,jint)bool{returne.rules[i].Priority<e.rules[j].Priority})}//toFloat64convertsvariousnumerictypestofloat64.functoFloat64(vinterface{})float64{switchn:=v.(type){caseint:returnfloat64(n)caseint64:returnfloat64(n)casefloat64:returnncasefloat32:returnfloat64(n)casejson.Number:f,_:=n.Float64()returnfdefault:return0}}//---ProviderFailover(T094)---//FailoverStatetracksproviderhealthforfailoverdecisions.typeFailoverStatestruct{musync.RWMutexfailuresmap[string]int//provider→consecutivefailurecountlastFailmap[string]time.Time//provider→lastfailuretimethresholdint//failuresbeforemarkingunhealthycooldowntime.Duration//howlongtowaitbeforeretryingfailedprovider}//NewFailoverStatecreatesafailovertracker.funcNewFailoverState(thresholdint,cooldowntime.Duration)*FailoverState{return&FailoverState{failures:make(map[string]int),lastFail:make(map[string]time.Time),threshold:threshold,cooldown:cooldown,}}//RecordFailurerecordsaproviderfailure.func(fs*FailoverState)RecordFailure(providerstring){fs.mu.Lock()deferfs.mu.Unlock()fs.failures[provider]++fs.lastFail[provider]=time.Now()}//RecordSuccessresetsthefailurecounterforaprovider.func(fs*FailoverState)RecordSuccess(providerstring){fs.mu.Lock()deferfs.mu.Unlock()fs.failures[provider]=0}//IsHealthychecksifaproviderisconsideredhealthy.func(fs*FailoverState)IsHealthy(providerstring)bool{fs.mu.RLock()deferfs.mu.RUnlock()count:=fs.failures[provider]ifcount<fs.threshold{returntrue}//Checkcooldown—maybeit'stimetoretry.lastFail,ok:=fs.lastFail[provider]if!ok{returntrue}returntime.Since(lastFail)>fs.cooldown}//SelectProviderpicksthefirsthealthyproviderfromthelist(T094).func(fs*FailoverState)SelectProvider(preferredstring,fallbacks[]string)string{iffs.IsHealthy(preferred){returnpreferred}for_,fb:=rangefallbacks{iffs.IsHealthy(fb){returnfb}}//Allunhealthy—returnpreferredandhopeforthebest.returnpreferred}