packageroutingimport("crypto/sha256""encoding/binary""fmt""math""sync""time")//───T099:ExperimentDataModel────────────────────────────typeExperimentStatusstringconst(ExperimentDraftExperimentStatus="draft"ExperimentRunningExperimentStatus="running"ExperimentPausedExperimentStatus="paused"ExperimentConcludedExperimentStatus="concluded")typeExperimentVariantstruct{Namestring`json:"name"`Modelstring`json:"model"`Providerstring`json:"provider"`TrafficWeightfloat64`json:"traffic_weight"`//0.0–1.0,mustsumto1.0}typeExperimentstruct{IDstring`json:"id"`Namestring`json:"name"`Descriptionstring`json:"description"`StatusExperimentStatus`json:"status"`Variants[]ExperimentVariant`json:"variants"`CreatedAttime.Time`json:"created_at"`StartedAt*time.Time`json:"started_at,omitempty"`ConcludedAt*time.Time`json:"concluded_at,omitempty"`WinnerIdxint`json:"winner_idx"`//Auto-switchconfigAutoSwitchbool`json:"auto_switch"`SignificanceThresholdfloat64`json:"significance_threshold"`//default0.95MinSampleSizeint`json:"min_sample_size"`//default100}//───T101:MetricAggregation───────────────────────────────typeVariantMetricsstruct{Requestsint64`json:"requests"`Errorsint64`json:"errors"`TotalCostfloat64`json:"total_cost"`TotalLatencytime.Duration`json:"-"`TotalTokensint64`json:"total_tokens"`//DerivedAvgCostfloat64`json:"avg_cost"`AvgLatencyfloat64`json:"avg_latency_ms"`ErrorRatefloat64`json:"error_rate"`AvgTokensfloat64`json:"avg_tokens"`//Forz-test:tracksumofsquaredlatenciesforvarianceSumLatencySqfloat64`json:"-"`}func(m*VariantMetrics)Recalculate(){ifm.Requests>0{m.AvgCost=m.TotalCost/float64(m.Requests)m.AvgLatency=float64(m.TotalLatency.Milliseconds())/float64(m.Requests)m.ErrorRate=float64(m.Errors)/float64(m.Requests)m.AvgTokens=float64(m.TotalTokens)/float64(m.Requests)}}func(m*VariantMetrics)LatencyVariance()float64{ifm.Requests<2{return0}mean:=m.AvgLatencyreturnm.SumLatencySq/float64(m.Requests)-mean*mean}//───T100:A/BTrafficSplitting(ConsistentHashing)──────typeExperimentEnginestruct{musync.RWMutexexperimentsmap[string]*Experimentmetricsmap[string][]VariantMetrics//experimentID->per-variantmetrics}funcNewExperimentEngine()*ExperimentEngine{return&ExperimentEngine{experiments:make(map[string]*Experiment),metrics:make(map[string][]VariantMetrics),}}//CreateExperimentregistersanewexperiment.func(e*ExperimentEngine)CreateExperiment(exp*Experiment)error{e.mu.Lock()defere.mu.Unlock()if_,exists:=e.experiments[exp.ID];exists{returnfmt.Errorf("experiment%salreadyexists",exp.ID)}//Validatetrafficweightssumto1.0vartotalWeightfloat64for_,v:=rangeexp.Variants{totalWeight+=v.TrafficWeight}ifmath.Abs(totalWeight-1.0)>0.01{returnfmt.Errorf("varianttrafficweightsmustsumto1.0,got%.3f",totalWeight)}ifexp.SignificanceThreshold==0{exp.SignificanceThreshold=0.95}ifexp.MinSampleSize==0{exp.MinSampleSize=100}exp.Status=ExperimentDraftexp.CreatedAt=time.Now()exp.WinnerIdx=-1e.experiments[exp.ID]=expe.metrics[exp.ID]=make([]VariantMetrics,len(exp.Variants))returnnil}//StartExperimenttransitionstorunningstatus.func(e*ExperimentEngine)StartExperiment(idstring)error{e.mu.Lock()defere.mu.Unlock()exp,ok:=e.experiments[id]if!ok{returnfmt.Errorf("experiment%snotfound",id)}ifexp.Status!=ExperimentDraft&&exp.Status!=ExperimentPaused{returnfmt.Errorf("experiment%sis%s,cannotstart",id,exp.Status)}now:=time.Now()exp.StartedAt=&nowexp.Status=ExperimentRunningreturnnil}//AssignVariantdetermineswhichvarianttouseforagivenrequestkey//usingconsistenthashing(SHA-256ofthekeymappedtotrafficweights).func(e*ExperimentEngine)AssignVariant(experimentID,requestKeystring)(*ExperimentVariant,int,error){e.mu.RLock()defere.mu.RUnlock()exp,ok:=e.experiments[experimentID]if!ok{returnnil,-1,fmt.Errorf("experiment%snotfound",experimentID)}ifexp.Status!=ExperimentRunning{returnnil,-1,fmt.Errorf("experiment%sisnotrunning",experimentID)}//Consistenthash:SHA-256of(experimentID+requestKey)→[0.0,1.0)hash:=sha256.Sum256([]byte(experimentID+":"+requestKey))hashVal:=float64(binary.BigEndian.Uint64(hash[:8]))/float64(math.MaxUint64)//Maptovariantbasedoncumulativeweightscumulative:=0.0fori,v:=rangeexp.Variants{cumulative+=v.TrafficWeightifhashVal<cumulative{return&v,i,nil}}//Fallbacktolastvariant(floatingpointedgecase)last:=len(exp.Variants)-1return&exp.Variants[last],last,nil}//RecordResultrecordstheoutcomeofarequestassignedtoavariant.func(e*ExperimentEngine)RecordResult(experimentIDstring,variantIdxint,costfloat64,latencytime.Duration,tokensint64,isErrorbool){e.mu.Lock()defere.mu.Unlock()metrics,ok:=e.metrics[experimentID]if!ok||variantIdx<0||variantIdx>=len(metrics){return}m:=&metrics[variantIdx]m.Requests++m.TotalCost+=costm.TotalLatency+=latencym.TotalTokens+=tokenslatMs:=float64(latency.Milliseconds())m.SumLatencySq+=latMs*latMsifisError{m.Errors++}m.Recalculate()//T103:Checkauto-switchafterrecordingexp:=e.experiments[experimentID]ifexp!=nil&&exp.AutoSwitch&&exp.Status==ExperimentRunning{e.checkAutoSwitch(exp,metrics)}}//───T102:StatisticalSignificanceDetection(Z-Test)─────//ZTestResultcontainstheresultofatwo-proportionz-test.typeZTestResultstruct{ZScorefloat64`json:"z_score"`PValuefloat64`json:"p_value"`Significantbool`json:"significant"`BetterIdxint`json:"better_idx"`Metricstring`json:"metric"`}//CompareErrorRatesperformsatwo-proportionz-testonerrorrates.func(e*ExperimentEngine)CompareErrorRates(experimentIDstring)(*ZTestResult,error){e.mu.RLock()defere.mu.RUnlock()metrics,ok:=e.metrics[experimentID]if!ok{returnnil,fmt.Errorf("experiment%snotfound",experimentID)}iflen(metrics)<2{returnnil,fmt.Errorf("needatleast2variants")}exp:=e.experiments[experimentID]//Comparefirsttwovariants(controlvstreatment)m0,m1:=metrics[0],metrics[1]ifm0.Requests<int64(exp.MinSampleSize)||m1.Requests<int64(exp.MinSampleSize){return&ZTestResult{Significant:false,Metric:"error_rate"},nil}p1:=m0.ErrorRatep2:=m1.ErrorRaten1:=float64(m0.Requests)n2:=float64(m1.Requests)//PooledproportionpPool:=(float64(m0.Errors)+float64(m1.Errors))/(n1+n2)ifpPool==0||pPool==1{return&ZTestResult{Significant:false,Metric:"error_rate"},nil}se:=math.Sqrt(pPool*(1-pPool)*(1/n1+1/n2))ifse==0{return&ZTestResult{Significant:false,Metric:"error_rate"},nil}z:=(p1-p2)/sepValue:=2*normalCDF(-math.Abs(z))//two-tailedbetterIdx:=0ifp2<p1{betterIdx=1}return&ZTestResult{ZScore:z,PValue:pValue,Significant:pValue<(1-exp.SignificanceThreshold),BetterIdx:betterIdx,Metric:"error_rate",},nil}//CompareCostsperformsatwo-samplez-testonaveragecosts.func(e*ExperimentEngine)CompareCosts(experimentIDstring)(*ZTestResult,error){e.mu.RLock()defere.mu.RUnlock()metrics,ok:=e.metrics[experimentID]if!ok{returnnil,fmt.Errorf("experiment%snotfound",experimentID)}iflen(metrics)<2{returnnil,fmt.Errorf("needatleast2variants")}exp:=e.experiments[experimentID]m0,m1:=metrics[0],metrics[1]ifm0.Requests<int64(exp.MinSampleSize)||m1.Requests<int64(exp.MinSampleSize){return&ZTestResult{Significant:false,Metric:"cost"},nil}//Uselatencyvarianceasproxyforcostvariancevar0:=m0.LatencyVariance()var1:=m1.LatencyVariance()n1,n2:=float64(m0.Requests),float64(m1.Requests)se:=math.Sqrt(var0/n1+var1/n2)ifse==0{return&ZTestResult{Significant:false,Metric:"cost"},nil}z:=(m0.AvgCost-m1.AvgCost)/sepValue:=2*normalCDF(-math.Abs(z))betterIdx:=0ifm1.AvgCost<m0.AvgCost{betterIdx=1}return&ZTestResult{ZScore:z,PValue:pValue,Significant:pValue<(1-exp.SignificanceThreshold),BetterIdx:betterIdx,Metric:"cost",},nil}//───T103:Auto-SwitchonThreshold─────────────────────────//checkAutoSwitchpromotesthewinningvariantifstatisticallysignificant.//Mustbecalledwithe.muheld.func(e*ExperimentEngine)checkAutoSwitch(exp*Experiment,metrics[]VariantMetrics){iflen(metrics)<2{return}//Checkminimumsamplesizeforallvariantsfor_,m:=rangemetrics{ifm.Requests<int64(exp.MinSampleSize){return}}//Findbestvariantbycompositescore(lowererrorrate+lowercost)bestIdx:=0bestScore:=math.MaxFloat64fori,m:=rangemetrics{//Composite:costweight0.6,errorrateweight0.4score:=m.AvgCost*0.6+m.ErrorRate*100*0.4ifscore<bestScore{bestScore=scorebestIdx=i}}//Verifywithz-testonerrorratesbetweenbestandothersp1:=metrics[bestIdx].ErrorRaten1:=float64(metrics[bestIdx].Requests)fori,m:=rangemetrics{ifi==bestIdx{continue}p2:=m.ErrorRaten2:=float64(m.Requests)pPool:=(float64(metrics[bestIdx].Errors)+float64(m.Errors))/(n1+n2)ifpPool==0||pPool==1{continue}se:=math.Sqrt(pPool*(1-pPool)*(1/n1+1/n2))ifse==0{continue}z:=(p2-p1)/sepValue:=normalCDF(-z)//one-tailed:isbestIdxbetter?ifpValue>(1-exp.SignificanceThreshold){return//notsignificantenough}}//Promotewinnernow:=time.Now()exp.ConcludedAt=&nowexp.Status=ExperimentConcludedexp.WinnerIdx=bestIdx}//GetExperimentreturnsanexperimentbyID.func(e*ExperimentEngine)GetExperiment(idstring)(*Experiment,[]VariantMetrics,error){e.mu.RLock()defere.mu.RUnlock()exp,ok:=e.experiments[id]if!ok{returnnil,nil,fmt.Errorf("experiment%snotfound",id)}metricsCopy:=make([]VariantMetrics,len(e.metrics[id]))copy(metricsCopy,e.metrics[id])returnexp,metricsCopy,nil}//ListExperimentsreturnsallexperiments.func(e*ExperimentEngine)ListExperiments()[]*Experiment{e.mu.RLock()defere.mu.RUnlock()result:=make([]*Experiment,0,len(e.experiments))for_,exp:=rangee.experiments{result=append(result,exp)}returnresult}//ConcludeExperimentmanuallyconcludesanexperiment.func(e*ExperimentEngine)ConcludeExperiment(idstring,winnerIdxint)error{e.mu.Lock()defere.mu.Unlock()exp,ok:=e.experiments[id]if!ok{returnfmt.Errorf("experiment%snotfound",id)}ifwinnerIdx<0||winnerIdx>=len(exp.Variants){returnfmt.Errorf("invalidwinnerindex%d",winnerIdx)}now:=time.Now()exp.ConcludedAt=&nowexp.Status=ExperimentConcludedexp.WinnerIdx=winnerIdxreturnnil}//DeleteExperimentremovesanexperiment.func(e*ExperimentEngine)DeleteExperiment(idstring)error{e.mu.Lock()defere.mu.Unlock()if_,ok:=e.experiments[id];!ok{returnfmt.Errorf("experiment%snotfound",id)}delete(e.experiments,id)delete(e.metrics,id)returnnil}//───Helper:NormalCDFapproximation──────────────────────//normalCDFapproximatesthecumulativedistributionfunction//ofthestandardnormaldistributionusingtheAbramowitz&Stegunformula.funcnormalCDF(xfloat64)float64{ifx<-8{return0}ifx>8{return1}t:=1.0/(1.0+0.2316419*math.Abs(x))d:=0.3989422804014327//1/sqrt(2*pi)prob:=d*math.Exp(-x*x/2.0)*(t*(0.3193815+t*(-0.3565638+t*(1.781478+t*(-1.821256+t*1.330274)))))ifx>0{return1-prob}returnprob}