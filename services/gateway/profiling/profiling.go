packageprofilingimport("fmt""net/http""net/http/pprof""os""runtime"runtimepprof"runtime/pprof""runtime/trace""time""github.com/rs/zerolog")//ProfileServerprovidessecurepprofendpointsandautomaticprofilingtypeProfileServerstruct{logzerolog.LoggerenabledboolauthTokenstringlatencyTargettime.DurationautoProfilebool}//ConfigholdsprofilingconfigurationtypeConfigstruct{EnabledboolAuthTokenstring//Bearertokenfor/debug/pprofaccessLatencyTargettime.Duration//Auto-profileifP95exceedsthisAutoProfilebool//EnableautomaticprofilingonSLAbreachPortint//Profilingserverport(default:6060)}//NewcreatesanewprofileserverfuncNew(logzerolog.Logger,cfgConfig)*ProfileServer{ifcfg.Port==0{cfg.Port=6060}ifcfg.LatencyTarget==0{cfg.LatencyTarget=100*time.Millisecond}return&ProfileServer{log:log,enabled:cfg.Enabled,authToken:cfg.AuthToken,latencyTarget:cfg.LatencyTarget,autoProfile:cfg.AutoProfile,}}//StartstartsthepprofHTTPserveronaseparateportfunc(ps*ProfileServer)Start(portint)error{if!ps.enabled{ps.log.Info().Msg("profilingdisabled")returnnil}mux:=http.NewServeMux()//Registerpprofhandlerswithauthmiddlewaremux.Handle("/debug/pprof/",ps.authMiddleware(http.HandlerFunc(pprof.Index)))mux.Handle("/debug/pprof/cmdline",ps.authMiddleware(http.HandlerFunc(pprof.Cmdline)))mux.Handle("/debug/pprof/profile",ps.authMiddleware(http.HandlerFunc(pprof.Profile)))mux.Handle("/debug/pprof/symbol",ps.authMiddleware(http.HandlerFunc(pprof.Symbol)))mux.Handle("/debug/pprof/trace",ps.authMiddleware(http.HandlerFunc(pprof.Trace)))//Customhandlersforspecificprofilesmux.Handle("/debug/pprof/heap",ps.authMiddleware(pprof.Handler("heap")))mux.Handle("/debug/pprof/goroutine",ps.authMiddleware(pprof.Handler("goroutine")))mux.Handle("/debug/pprof/threadcreate",ps.authMiddleware(pprof.Handler("threadcreate")))mux.Handle("/debug/pprof/block",ps.authMiddleware(pprof.Handler("block")))mux.Handle("/debug/pprof/mutex",ps.authMiddleware(pprof.Handler("mutex")))mux.Handle("/debug/pprof/allocs",ps.authMiddleware(pprof.Handler("allocs")))//Healthendpointmux.HandleFunc("/health",func(whttp.ResponseWriter,r*http.Request){w.WriteHeader(http.StatusOK)fmt.Fprintf(w,"profilingserverOK\n")})addr:=fmt.Sprintf(":%d",port)ps.log.Info().Int("port",port).Msg("startingprofilingserver")//Startserveringoroutinegofunc(){iferr:=http.ListenAndServe(addr,mux);err!=nil{ps.log.Error().Err(err).Msg("profilingserverfailed")}}()returnnil}//authMiddlewareprotectspprofendpointswithtokenauthenticationfunc(ps*ProfileServer)authMiddleware(nexthttp.Handler)http.Handler{returnhttp.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){//Checkenvironmentforprofilingaccessifos.Getenv("ALFRED_PROFILING_UNSAFE")=="true"{//Allowaccessindevelopmentwithoutauthnext.ServeHTTP(w,r)return}//Requireauthtokeninproductiontoken:=r.Header.Get("Authorization")expectedToken:="Bearer"+ps.authTokeniftoken!=expectedToken{ps.log.Warn().Str("path",r.URL.Path).Str("remote_addr",r.RemoteAddr).Msg("unauthorizedprofilingaccessattempt")http.Error(w,"Unauthorized",http.StatusUnauthorized)return}next.ServeHTTP(w,r)})}//TriggerCPUProfilecapturesaCPUprofileforthespecifieddurationfunc(ps*ProfileServer)TriggerCPUProfile(durationtime.Duration,reasonstring)error{if!ps.enabled{returnfmt.Errorf("profilingdisabled")}filename:=fmt.Sprintf("cpu_profile_%s_%d.prof",reason,time.Now().Unix())f,err:=os.Create(filename)iferr!=nil{returnfmt.Errorf("createprofilefile:%w",err)}deferf.Close()ps.log.Info().Str("reason",reason).Dur("duration",duration).Str("file",filename).Msg("startingCPUprofilecapture")runtime.SetCPUProfileRate(100)//Hziferr:=runtimepprof.StartCPUProfile(f);err!=nil{returnfmt.Errorf("startCPUprofile:%w",err)}time.Sleep(duration)runtimepprof.StopCPUProfile()ps.log.Info().Str("file",filename).Msg("CPUprofilesaved")returnnil}//TriggerHeapProfilecapturesaheapmemoryprofilefunc(ps*ProfileServer)TriggerHeapProfile(reasonstring)error{if!ps.enabled{returnfmt.Errorf("profilingdisabled")}filename:=fmt.Sprintf("heap_profile_%s_%d.prof",reason,time.Now().Unix())f,err:=os.Create(filename)iferr!=nil{returnfmt.Errorf("createprofilefile:%w",err)}deferf.Close()ps.log.Info().Str("reason",reason).Str("file",filename).Msg("capturingheapprofile")runtime.GC()//ForceGCbeforeprofilingiferr:=runtimepprof.WriteHeapProfile(f);err!=nil{returnfmt.Errorf("writeheapprofile:%w",err)}ps.log.Info().Str("file",filename).Msg("heapprofilesaved")returnnil}//TriggerTracecapturesanexecutiontracefunc(ps*ProfileServer)TriggerTrace(durationtime.Duration,reasonstring)error{if!ps.enabled{returnfmt.Errorf("profilingdisabled")}filename:=fmt.Sprintf("trace_%s_%d.out",reason,time.Now().Unix())f,err:=os.Create(filename)iferr!=nil{returnfmt.Errorf("createtracefile:%w",err)}deferf.Close()ps.log.Info().Str("reason",reason).Dur("duration",duration).Str("file",filename).Msg("startingexecutiontrace")iferr:=trace.Start(f);err!=nil{returnfmt.Errorf("starttrace:%w",err)}time.Sleep(duration)trace.Stop()ps.log.Info().Str("file",filename).Msg("executiontracesaved")returnnil}//GetRuntimeStatsreturnscurrentruntimestatisticsfunc(ps*ProfileServer)GetRuntimeStats()map[string]interface{}{varmruntime.MemStatsruntime.ReadMemStats(&m)returnmap[string]interface{}{"goroutines":runtime.NumGoroutine(),"alloc_bytes":m.Alloc,"total_alloc":m.TotalAlloc,"sys_bytes":m.Sys,"heap_alloc":m.HeapAlloc,"heap_sys":m.HeapSys,"heap_objects":m.HeapObjects,"gc_runs":m.NumGC,"gc_pause_ns":m.PauseNs[(m.NumGC+255)%256],"next_gc":m.NextGC,"num_cpu":runtime.NumCPU(),"gomaxprocs":runtime.GOMAXPROCS(0),}}