packageproviderimport("bytes""context""encoding/json""fmt""io""net/http""time")constvllmDefaultBaseURL="http://localhost:8000"//VLLMProviderimplementstheProviderinterfaceforvLLM.typeVLLMProviderstruct{configProviderConfigclient*http.Client}//NewVLLMProvidercreatesanewvLLMproviderconnector.funcNewVLLMProvider(cfgProviderConfig)*VLLMProvider{ifcfg.BaseURL==""{cfg.BaseURL=vllmDefaultBaseURL}ifcfg.Timeout==0{cfg.Timeout=120*time.Second}ifcfg.MaxRetries==0{cfg.MaxRetries=2}transport:=&http.Transport{MaxIdleConns:100,MaxIdleConnsPerHost:20,IdleConnTimeout:90*time.Second,}return&VLLMProvider{config:cfg,client:&http.Client{Transport:transport,Timeout:cfg.Timeout,},}}func(p*VLLMProvider)Name()string{return"vllm"}func(p*VLLMProvider)Models()[]string{iflen(p.config.Models)>0{returnp.config.Models}return[]string{"meta-llama/Meta-Llama-3.1-70B-Instruct","meta-llama/Meta-Llama-3.1-8B-Instruct","mistralai/Mistral-7B-Instruct-v0.3","Qwen/Qwen2-72B-Instruct",}}func(p*VLLMProvider)ChatCompletion(ctxcontext.Context,req*ChatRequest)(*ChatResponse,error){req.Stream=falsebody,err:=json.Marshal(req)iferr!=nil{returnnil,fmt.Errorf("marshalrequest:%w",err)}httpReq,err:=http.NewRequestWithContext(ctx,http.MethodPost,p.config.BaseURL+"/v1/chat/completions",bytes.NewReader(body))iferr!=nil{returnnil,fmt.Errorf("createrequest:%w",err)}p.setHeaders(httpReq)resp,err:=p.client.Do(httpReq)iferr!=nil{returnnil,fmt.Errorf("vllmrequestfailed:%w",err)}deferresp.Body.Close()ifresp.StatusCode!=http.StatusOK{respBody,_:=io.ReadAll(resp.Body)returnnil,fmt.Errorf("vllmreturnedstatus%d:%s",resp.StatusCode,string(respBody))}varchatRespChatResponseiferr:=json.NewDecoder(resp.Body).Decode(&chatResp);err!=nil{returnnil,fmt.Errorf("decoderesponse:%w",err)}return&chatResp,nil}func(p*VLLMProvider)ChatCompletionStream(ctxcontext.Context,req*ChatRequest)(Stream,error){req.Stream=truebody,err:=json.Marshal(req)iferr!=nil{returnnil,fmt.Errorf("marshalrequest:%w",err)}httpReq,err:=http.NewRequestWithContext(ctx,http.MethodPost,p.config.BaseURL+"/v1/chat/completions",bytes.NewReader(body))iferr!=nil{returnnil,fmt.Errorf("createrequest:%w",err)}p.setHeaders(httpReq)resp,err:=p.client.Do(httpReq)iferr!=nil{returnnil,fmt.Errorf("vllmstreamrequestfailed:%w",err)}ifresp.StatusCode!=http.StatusOK{respBody,_:=io.ReadAll(resp.Body)resp.Body.Close()returnnil,fmt.Errorf("vllmreturnedstatus%d:%s",resp.StatusCode,string(respBody))}returnNewHTTPStream(resp),nil}func(p*VLLMProvider)Embeddings(ctxcontext.Context,req*EmbeddingsRequest)(*EmbeddingsResponse,error){body,err:=json.Marshal(req)iferr!=nil{returnnil,fmt.Errorf("marshalrequest:%w",err)}httpReq,err:=http.NewRequestWithContext(ctx,http.MethodPost,p.config.BaseURL+"/v1/embeddings",bytes.NewReader(body))iferr!=nil{returnnil,fmt.Errorf("createrequest:%w",err)}p.setHeaders(httpReq)resp,err:=p.client.Do(httpReq)iferr!=nil{returnnil,fmt.Errorf("vllmembeddingsrequestfailed:%w",err)}deferresp.Body.Close()ifresp.StatusCode!=http.StatusOK{respBody,_:=io.ReadAll(resp.Body)returnnil,fmt.Errorf("vllmreturnedstatus%d:%s",resp.StatusCode,string(respBody))}varembRespEmbeddingsResponseiferr:=json.NewDecoder(resp.Body).Decode(&embResp);err!=nil{returnnil,fmt.Errorf("decoderesponse:%w",err)}return&embResp,nil}func(p*VLLMProvider)HealthCheck(ctxcontext.Context)HealthStatus{start:=time.Now()//vLLMserveshealthat/healthor/v1/modelshttpReq,err:=http.NewRequestWithContext(ctx,http.MethodGet,p.config.BaseURL+"/health",nil)iferr!=nil{returnHealthStatus{Healthy:false,Error:err.Error(),LastCheck:time.Now()}}resp,err:=p.client.Do(httpReq)latency:=time.Since(start)iferr!=nil{returnHealthStatus{Healthy:false,Latency:latency,Error:err.Error(),LastCheck:time.Now()}}deferresp.Body.Close()healthy:=resp.StatusCode==http.StatusOKerrMsg:=""if!healthy{errMsg=fmt.Sprintf("status%d",resp.StatusCode)}returnHealthStatus{Healthy:healthy,Latency:latency,LastCheck:time.Now(),Error:errMsg}}func(p*VLLMProvider)setHeaders(req*http.Request){req.Header.Set("Content-Type","application/json")ifp.config.APIKey!=""{req.Header.Set("Authorization","Bearer"+p.config.APIKey)}fork,v:=rangep.config.Headers{req.Header.Set(k,v)}}