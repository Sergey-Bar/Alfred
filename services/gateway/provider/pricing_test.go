packageprovider_testimport("math""sync""testing""github.com/AlfredDev/alfred/services/gateway/provider")//──DefaultPricing──────────────────────────────────────────funcTestDefaultPricing_ContainsOpenAI(t*testing.T){pc:=provider.DefaultPricing()pricing,found:=pc.GetPricing("openai","gpt-4o")if!found{t.Fatal("openai/gpt-4oshouldexistindefaultpricing")}ifpricing.InputPer1M!=2.50{t.Errorf("gpt-4oinputpriceexpected2.50,got%f",pricing.InputPer1M)}ifpricing.OutputPer1M!=10.00{t.Errorf("gpt-4ooutputpriceexpected10.00,got%f",pricing.OutputPer1M)}}funcTestDefaultPricing_ContainsAnthropic(t*testing.T){pc:=provider.DefaultPricing()pricing,found:=pc.GetPricing("anthropic","claude-3-5-sonnet-20241022")if!found{t.Fatal("anthropic/claude-3-5-sonnet-20241022shouldexist")}ifpricing.InputPer1M!=3.00{t.Errorf("expected3.00,got%f",pricing.InputPer1M)}}funcTestDefaultPricing_ContainsFreeModel(t*testing.T){pc:=provider.DefaultPricing()pricing,found:=pc.GetPricing("google","gemini-2.0-flash-lite")if!found{t.Fatal("google/gemini-2.0-flash-liteshouldexist")}if!pricing.Free{t.Error("gemini-2.0-flash-liteshouldbemarkedasfree")}}//──GetPricing──────────────────────────────────────────────funcTestGetPricing_ExactMatch(t*testing.T){pc:=provider.DefaultPricing()_,found:=pc.GetPricing("openai","gpt-4o-mini")if!found{t.Error("exactmatchopenai/gpt-4o-minishouldbefound")}}funcTestGetPricing_FallbackByModel(t*testing.T){pc:=provider.DefaultPricing()//Searchwithemptyprovider—shouldfallbacktomodelnamesearchpricing,found:=pc.GetPricing("","gpt-4o")if!found{t.Error("fallbacksearchbymodelname'gpt-4o'shouldwork")}ifpricing.InputPer1M==0{t.Error("expectednon-zeropricingfromfallbackmatch")}}funcTestGetPricing_NotFound(t*testing.T){pc:=provider.DefaultPricing()_,found:=pc.GetPricing("unknown","nonexistent-model")iffound{t.Error("nonexistentmodelshouldnotbefound")}}//──CalculateCost───────────────────────────────────────────funcTestCalculateCost_OpenAI(t*testing.T){pc:=provider.DefaultPricing()//gpt-4o:$2.50/1Minput,$10.00/1Moutputcost:=pc.CalculateCost("openai","gpt-4o",1000,500)//Expected:(1000/1M)*2.50+(500/1M)*10.00=0.0025+0.005=0.0075expected:=0.0075ifmath.Abs(cost-expected)>0.00000001{t.Errorf("expectedcost%f,got%f",expected,cost)}}funcTestCalculateCost_FreeModel(t*testing.T){pc:=provider.DefaultPricing()cost:=pc.CalculateCost("google","gemini-2.0-flash-lite",10000,5000)ifcost!=0.0{t.Errorf("freemodelshouldcost0,got%f",cost)}}funcTestCalculateCost_UnknownModel(t*testing.T){pc:=provider.DefaultPricing()cost:=pc.CalculateCost("unknown","nonexistent",10000,5000)ifcost!=0.0{t.Errorf("unknownmodelshouldcost0,got%f",cost)}}funcTestCalculateCost_ZeroTokens(t*testing.T){pc:=provider.DefaultPricing()cost:=pc.CalculateCost("openai","gpt-4o",0,0)ifcost!=0.0{t.Errorf("zerotokensshouldcost0,got%f",cost)}}funcTestCalculateCost_LargeRequest(t*testing.T){pc:=provider.DefaultPricing()//1Minput+1Moutputofgpt-4o=$2.50+$10.00=$12.50cost:=pc.CalculateCost("openai","gpt-4o",1_000_000,1_000_000)expected:=12.50ifmath.Abs(cost-expected)>0.01{t.Errorf("expectedcost%f,got%f",expected,cost)}}//──IsFreeModel─────────────────────────────────────────────funcTestIsFreeModel_True(t*testing.T){pc:=provider.DefaultPricing()if!pc.IsFreeModel("google","gemini-2.0-flash-lite"){t.Error("gemini-2.0-flash-liteshouldbefree")}}funcTestIsFreeModel_False(t*testing.T){pc:=provider.DefaultPricing()ifpc.IsFreeModel("openai","gpt-4o"){t.Error("gpt-4oshouldnotbefree")}}funcTestIsFreeModel_Unknown(t*testing.T){pc:=provider.DefaultPricing()ifpc.IsFreeModel("unknown","model"){t.Error("unknownmodelshouldnotbefree")}}//──SetPricing─────────────────────────────────────────────funcTestSetPricing_NewModel(t*testing.T){pc:=provider.DefaultPricing()pc.SetPricing("custom/my-model",provider.ModelPricing{InputPer1M:1.00,OutputPer1M:2.00,})pricing,found:=pc.GetPricing("custom","my-model")if!found{t.Fatal("custommodelshouldbefoundafterSetPricing")}ifpricing.InputPer1M!=1.00{t.Errorf("expected1.00,got%f",pricing.InputPer1M)}}funcTestSetPricing_OverrideExisting(t*testing.T){pc:=provider.DefaultPricing()pc.SetPricing("openai/gpt-4o",provider.ModelPricing{InputPer1M:99.99,OutputPer1M:99.99,})pricing,_:=pc.GetPricing("openai","gpt-4o")ifpricing.InputPer1M!=99.99{t.Errorf("expectedoverriddenprice99.99,got%f",pricing.InputPer1M)}}//──AllPricing──────────────────────────────────────────────funcTestAllPricing_ReturnsAll(t*testing.T){pc:=provider.DefaultPricing()all:=pc.AllPricing()iflen(all)<20{t.Errorf("expectedatleast20pricingentries,got%d",len(all))}}funcTestAllPricing_ReturnsCopy(t*testing.T){pc:=provider.DefaultPricing()all:=pc.AllPricing()all["openai/gpt-4o"]=provider.ModelPricing{InputPer1M:999}//Originalshouldbeunchangedpricing,_:=pc.GetPricing("openai","gpt-4o")ifpricing.InputPer1M==999{t.Error("AllPricingshouldreturnacopy,notareference")}}//──ConcurrentAccess───────────────────────────────────────funcTestPricingConfig_ConcurrentReadWrite(t*testing.T){pc:=provider.DefaultPricing()varwgsync.WaitGroupfori:=0;i<100;i++{wg.Add(2)gofunc(){deferwg.Done()pc.GetPricing("openai","gpt-4o")}()gofunc(){deferwg.Done()pc.CalculateCost("openai","gpt-4o",1000,500)}()}wg.Wait()}//──EstimateCost────────────────────────────────────────────funcTestEstimateCost_SameAsCalculate(t*testing.T){pc:=provider.DefaultPricing()calc:=pc.CalculateCost("openai","gpt-4o",1000,4096)est:=pc.EstimateCost("openai","gpt-4o",1000,4096)ifcalc!=est{t.Errorf("EstimateCost(%f)shouldequalCalculateCost(%f)",est,calc)}}