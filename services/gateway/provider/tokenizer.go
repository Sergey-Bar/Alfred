packageproviderimport("strings""unicode/utf8")//TokenCounterprovidesper-providertokencountingstrategies.typeTokenCounterstruct{strategyTokenStrategy}//TokenStrategydefinesthecountingalgorithmforaprovider.typeTokenStrategyintconst(//StrategyTiktokenistheBPE-basedtokenizerusedbyOpenAImodels.StrategyTiktokenTokenStrategy=iota//StrategyAnthropicusesAnthropic'scountingrules(~3.5chars/token).StrategyAnthropic//StrategyGeminiusesGoogle'scounting(~4chars/tokenwithdifferentoverhead).StrategyGemini//StrategyMistralusesMistral'sSentencePiecevariant(~3.8chars/token).StrategyMistral//StrategyDefaultusesaconservative4chars/tokenestimate.StrategyDefault)//TokenCountResultholdstheresultofatokencountingoperation.typeTokenCountResultstruct{PromptTokensint`json:"prompt_tokens"`EstimatedOutputint`json:"estimated_output_tokens"`Strategystring`json:"strategy"`IsEstimatebool`json:"is_estimate"`}//NewTokenCountercreatesacounterforthegivenprovidername.funcNewTokenCounter(providerNamestring)*TokenCounter{strategy:=resolveStrategy(providerName)return&TokenCounter{strategy:strategy}}//resolveStrategymapsprovidernamestotheirtokencountingstrategy.funcresolveStrategy(namestring)TokenStrategy{normalized:=strings.ToLower(name)switch{casestrings.Contains(normalized,"openai"):returnStrategyTiktokencasestrings.Contains(normalized,"anthropic"),strings.Contains(normalized,"claude"):returnStrategyAnthropiccasestrings.Contains(normalized,"gemini"),strings.Contains(normalized,"google"):returnStrategyGeminicasestrings.Contains(normalized,"mistral"):returnStrategyMistralcasestrings.Contains(normalized,"groq")://GroqservesOpenAI-compatiblemodels,usestiktoken-equivalentreturnStrategyTiktokencasestrings.Contains(normalized,"together")://TogetherAIservesvariousmodels;usedefaultreturnStrategyDefaultcasestrings.Contains(normalized,"azure")://AzureOpenAIusesthesametokenizerasOpenAIreturnStrategyTiktokendefault:returnStrategyDefault}}//CountMessagesestimatestokencountforasliceofchatmessages.func(tc*TokenCounter)CountMessages(messages[]ChatMessage)TokenCountResult{total:=0for_,msg:=rangemessages{total+=tc.countMessage(msg)}returnTokenCountResult{PromptTokens:total,EstimatedOutput:0,Strategy:tc.strategyName(),IsEstimate:true,}}//CountTextestimatestokencountforrawtext.func(tc*TokenCounter)CountText(textstring)int{returntc.estimateTokens(text)}//countMessageestimatestokensforasinglemessageincluding//theper-messageoverheadthateachprovideradds.func(tc*TokenCounter)countMessage(msgChatMessage)int{tokens:=0//Per-messageoverheadvariesbyprovidertokens+=tc.messageOverhead()//Roletoken(always1)tokens+=1//Contenttokensswitchcontent:=msg.Content.(type){casestring:tokens+=tc.estimateTokens(content)case[]interface{}://Multi-modalcontentparts(e.g.,text+image)for_,part:=rangecontent{ifm,ok:=part.(map[string]interface{});ok{iftext,exists:=m["text"];exists{ifs,ok:=text.(string);ok{tokens+=tc.estimateTokens(s)}}ifm["type"]=="image_url"{//Imagetokensvarybyresolution;useconservativeestimatetokens+=tc.imageTokenEstimate()}}}}//Namefieldifmsg.Name!=""{tokens+=tc.estimateTokens(msg.Name)+1//+1forseparator}//Toolcallsfor_,tc2:=rangemsg.ToolCalls{tokens+=tc.estimateTokens(tc2.Function.Name)tokens+=tc.estimateTokens(tc2.Function.Arguments)tokens+=4//overheadfortoolcallstructure}//ToolcallIDifmsg.ToolCallID!=""{tokens+=tc.estimateTokens(msg.ToolCallID)}returntokens}//estimateTokensappliestheprovider-specificchars-per-tokenratio.func(tc*TokenCounter)estimateTokens(textstring)int{iftext==""{return0}charCount:=utf8.RuneCountInString(text)switchtc.strategy{caseStrategyTiktoken://OpenAIBPE:~3.3charspertokenforEnglish,~1.5forCJK//Use3.3asaverage,withminimumof1tokentokens:=int(float64(charCount)/3.3)iftokens==0{return1}returntokenscaseStrategyAnthropic://Anthropic:typically~3.5charspertokentokens:=int(float64(charCount)/3.5)iftokens==0{return1}returntokenscaseStrategyGemini://Gemini:~4charspertoken,slightlydifferentencodingtokens:=int(float64(charCount)/4.0)iftokens==0{return1}returntokenscaseStrategyMistral://MistralSentencePiece:~3.8charspertokentokens:=int(float64(charCount)/3.8)iftokens==0{return1}returntokensdefault://Conservative:4charspertokentokens:=charCount/4iftokens==0{return1}returntokens}}//messageOverheadreturnstheper-messagetokenoverheadfortheprovider.//OpenAIadds~4tokenspermessage,Anthropicadds~3,etc.func(tc*TokenCounter)messageOverhead()int{switchtc.strategy{caseStrategyTiktoken:return4//<|im_start|>role\n...content<|im_end|>\ncaseStrategyAnthropic:return3//\n\nHuman:/\n\nAssistant:caseStrategyGemini:return3caseStrategyMistral:return4//similartoOpenAIformatdefault:return4}}//imageTokenEstimatereturnsaconservativetokenestimateforanimage.func(tc*TokenCounter)imageTokenEstimate()int{switchtc.strategy{caseStrategyTiktoken:return85//OpenAI:85tokensforlow-res,upto1105forhigh-rescaseStrategyAnthropic:return1024//Anthropiccharges~1024tokensperimagecaseStrategyGemini:return258//Gemini:258tokensperimagedefault:return512//conservativedefault}}//strategyNamereturnsahuman-readablenameforthecurrentstrategy.func(tc*TokenCounter)strategyName()string{switchtc.strategy{caseStrategyTiktoken:return"tiktoken"caseStrategyAnthropic:return"anthropic"caseStrategyGemini:return"gemini"caseStrategyMistral:return"mistral"default:return"default"}}//CountToolDefinitionsestimatestokencountfortool/functiondefinitions.//Tooldefinitionsaddtokenstothesystempromptarea.func(tc*TokenCounter)CountToolDefinitions(tools[]Tool)int{iflen(tools)==0{return0}tokens:=0for_,tool:=rangetools{tokens+=tc.estimateTokens(tool.Function.Name)tokens+=tc.estimateTokens(tool.Function.Description)iftool.Function.Parameters!=nil{tokens+=tc.estimateTokens(string(tool.Function.Parameters))}tokens+=8//overheadpertooldefinition}tokens+=12//system-leveltooloverheadreturntokens}//EstimateChatRequestprovidesacompletetokenestimateforachatrequest.func(tc*TokenCounter)EstimateChatRequest(req*ChatRequest)TokenCountResult{result:=tc.CountMessages(req.Messages)//Addtooldefinitionsiflen(req.Tools)>0{result.PromptTokens+=tc.CountToolDefinitions(req.Tools)}//Addassistantreplypriming(3tokensforeachprovider)result.PromptTokens+=3//Estimateoutputtokensbasedonmax_tokensordefaultifreq.MaxTokens!=nil{result.EstimatedOutput=*req.MaxTokens}else{result.EstimatedOutput=1024//defaultassumption}returnresult}