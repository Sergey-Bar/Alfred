packageprovider_testimport("testing""github.com/AlfredDev/alfred/services/gateway/provider")//──StrategyResolution─────────────────────────────────────funcTestNewTokenCounter_OpenAI(t*testing.T){tc:=provider.NewTokenCounter("openai")result:=tc.CountText("Hello,world!")ifresult<=0{t.Error("openaishouldcountatleast1token")}}funcTestNewTokenCounter_Anthropic(t*testing.T){tc:=provider.NewTokenCounter("anthropic")result:=tc.CountText("Hello,world!")ifresult<=0{t.Error("anthropicshouldcountatleast1token")}}funcTestNewTokenCounter_Gemini(t*testing.T){tc:=provider.NewTokenCounter("google")result:=tc.CountText("Hello,world!")ifresult<=0{t.Error("geminishouldcountatleast1token")}}funcTestNewTokenCounter_Mistral(t*testing.T){tc:=provider.NewTokenCounter("mistral")result:=tc.CountText("Hello,world!")ifresult<=0{t.Error("mistralshouldcountatleast1token")}}funcTestNewTokenCounter_Groq_UsesTiktoken(t*testing.T){tc:=provider.NewTokenCounter("groq")//Groqusestiktoken-equivalent,shouldmatchopenaiopenai:=provider.NewTokenCounter("openai")text:="Thequickbrownfoxjumpsoverthelazydog"iftc.CountText(text)!=openai.CountText(text){t.Error("groqshouldusesamestrategyasopenai")}}funcTestNewTokenCounter_Azure_UsesTiktoken(t*testing.T){tc:=provider.NewTokenCounter("azure")openai:=provider.NewTokenCounter("openai")text:="Helloworld"iftc.CountText(text)!=openai.CountText(text){t.Error("azureshouldusesamestrategyasopenai")}}funcTestNewTokenCounter_Unknown_UsesDefault(t*testing.T){tc:=provider.NewTokenCounter("some-unknown-provider")result:=tc.CountText("testtext")ifresult<=0{t.Error("unknownprovidershouldstillcounttokens")}}//──TokenEstimationAccuracy─────────────────────────────funcTestCountText_EmptyString(t*testing.T){tc:=provider.NewTokenCounter("openai")iftc.CountText("")!=0{t.Error("emptystringshouldbe0tokens")}}funcTestCountText_SingleChar(t*testing.T){tc:=provider.NewTokenCounter("openai")result:=tc.CountText("a")ifresult<1{t.Error("singlecharshouldbeatleast1token")}}funcTestCountText_ProviderDifferences(t*testing.T){//Longertexttoshowdifferentcountingstrategiestext:="ThisisareasonablylongtextthatshoulddemonstratedifferencesbetweentokenizerstrategiesacrossdifferentAIproviders."openai:=provider.NewTokenCounter("openai").CountText(text)anthropic:=provider.NewTokenCounter("anthropic").CountText(text)gemini:=provider.NewTokenCounter("google").CountText(text)//OpenAI~3.3chars/token,Anthropic~3.5,Gemini~4.0//So:OpenAIshouldproducemoretokensthanGeminiforsametextifopenai<=gemini{t.Errorf("openai(%d)shouldproducemoretokensthangemini(%d)forsametext",openai,gemini)}ifanthropic<=gemini{t.Errorf("anthropic(%d)shouldproducemoretokensthangemini(%d)",anthropic,gemini)}}//──CountMessages───────────────────────────────────────────funcTestCountMessages_SingleMessage(t*testing.T){tc:=provider.NewTokenCounter("openai")result:=tc.CountMessages([]provider.ChatMessage{{Role:"user",Content:"Hello"},})ifresult.PromptTokens<=0{t.Error("singlemessageshouldhave>0prompttokens")}if!result.IsEstimate{t.Error("shouldbemarkedasestimate")}ifresult.Strategy!="tiktoken"{t.Errorf("expectedstrategy'tiktoken',got%q",result.Strategy)}}funcTestCountMessages_MultipleMessages(t*testing.T){tc:=provider.NewTokenCounter("openai")single:=tc.CountMessages([]provider.ChatMessage{{Role:"user",Content:"Hello"},})multi:=tc.CountMessages([]provider.ChatMessage{{Role:"system",Content:"Youareahelpfulassistant."},{Role:"user",Content:"Hello"},{Role:"assistant",Content:"Hithere!"},})ifmulti.PromptTokens<=single.PromptTokens{t.Error("multiplemessagesshouldproducemoretokensthansingle")}}funcTestCountMessages_WithName(t*testing.T){tc:=provider.NewTokenCounter("openai")without:=tc.CountMessages([]provider.ChatMessage{{Role:"user",Content:"Hello"},})with:=tc.CountMessages([]provider.ChatMessage{{Role:"user",Content:"Hello",Name:"Alice"},})ifwith.PromptTokens<=without.PromptTokens{t.Error("messagewithnameshouldhavemoretokens")}}//──EstimateChatRequest─────────────────────────────────────funcTestEstimateChatRequest_Basic(t*testing.T){tc:=provider.NewTokenCounter("openai")maxTokens:=1024result:=tc.EstimateChatRequest(&provider.ChatRequest{Messages:[]provider.ChatMessage{{Role:"user",Content:"Hello"},},MaxTokens:&maxTokens,})ifresult.PromptTokens<=0{t.Error("prompttokensshouldbe>0")}ifresult.EstimatedOutput!=1024{t.Errorf("expectedestimatedoutputof1024,got%d",result.EstimatedOutput)}}funcTestEstimateChatRequest_DefaultMaxTokens(t*testing.T){tc:=provider.NewTokenCounter("openai")result:=tc.EstimateChatRequest(&provider.ChatRequest{Messages:[]provider.ChatMessage{{Role:"user",Content:"Hello"},},})//Defaultestimatedoutputshouldbe1024ifresult.EstimatedOutput!=1024{t.Errorf("expecteddefault1024estimatedoutput,got%d",result.EstimatedOutput)}}funcTestEstimateChatRequest_WithTools(t*testing.T){tc:=provider.NewTokenCounter("openai")withoutTools:=tc.EstimateChatRequest(&provider.ChatRequest{Messages:[]provider.ChatMessage{{Role:"user",Content:"What'stheweather?"},},})withTools:=tc.EstimateChatRequest(&provider.ChatRequest{Messages:[]provider.ChatMessage{{Role:"user",Content:"What'stheweather?"},},Tools:[]provider.Tool{{Type:"function",Function:provider.Function{Name:"get_weather",Description:"Getcurrentweatherforalocation",},},},})ifwithTools.PromptTokens<=withoutTools.PromptTokens{t.Error("requestwithtoolsshouldhavemoreprompttokens")}}//──StrategyNames──────────────────────────────────────────funcTestCountMessages_StrategyName(t*testing.T){tests:=[]struct{providerstringexpectedstring}{{"openai","tiktoken"},{"anthropic","anthropic"},{"google","gemini"},{"mistral","mistral"},{"unknown","default"},}for_,tt:=rangetests{tc:=provider.NewTokenCounter(tt.provider)result:=tc.CountMessages([]provider.ChatMessage{{Role:"user",Content:"test"},})ifresult.Strategy!=tt.expected{t.Errorf("provider%q:expectedstrategy%q,got%q",tt.provider,tt.expected,result.Strategy)}}}