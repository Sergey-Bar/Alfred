packageproviderimport("bytes""context""encoding/json""fmt""io""net/http""time")const(openAIBaseURL="https://api.openai.com/v1")//OpenAIProviderimplementstheProviderinterfaceforOpenAI.typeOpenAIProviderstruct{configProviderConfigclient*http.Client}//NewOpenAIProvidercreatesanewOpenAIproviderconnector.funcNewOpenAIProvider(cfgProviderConfig)*OpenAIProvider{ifcfg.BaseURL==""{cfg.BaseURL=openAIBaseURL}ifcfg.Timeout==0{cfg.Timeout=120*time.Second}ifcfg.MaxRetries==0{cfg.MaxRetries=2}transport:=&http.Transport{MaxIdleConns:100,MaxIdleConnsPerHost:20,IdleConnTimeout:90*time.Second,}return&OpenAIProvider{config:cfg,client:&http.Client{Transport:transport,Timeout:cfg.Timeout,},}}func(p*OpenAIProvider)Name()string{return"openai"}func(p*OpenAIProvider)Models()[]string{iflen(p.config.Models)>0{returnp.config.Models}return[]string{"gpt-4o","gpt-4o-mini","gpt-4-turbo","gpt-4","gpt-3.5-turbo","text-embedding-3-small","text-embedding-3-large","text-embedding-ada-002",}}func(p*OpenAIProvider)ChatCompletion(ctxcontext.Context,req*ChatRequest)(*ChatResponse,error){req.Stream=falsebody,err:=json.Marshal(req)iferr!=nil{returnnil,fmt.Errorf("marshalrequest:%w",err)}httpReq,err:=http.NewRequestWithContext(ctx,http.MethodPost,p.config.BaseURL+"/chat/completions",bytes.NewReader(body))iferr!=nil{returnnil,fmt.Errorf("createrequest:%w",err)}p.setHeaders(httpReq)resp,err:=p.client.Do(httpReq)iferr!=nil{returnnil,fmt.Errorf("openairequestfailed:%w",err)}deferresp.Body.Close()ifresp.StatusCode!=http.StatusOK{respBody,_:=io.ReadAll(resp.Body)returnnil,fmt.Errorf("openaireturnedstatus%d:%s",resp.StatusCode,string(respBody))}varchatRespChatResponseiferr:=json.NewDecoder(resp.Body).Decode(&chatResp);err!=nil{returnnil,fmt.Errorf("decoderesponse:%w",err)}return&chatResp,nil}func(p*OpenAIProvider)ChatCompletionStream(ctxcontext.Context,req*ChatRequest)(Stream,error){req.Stream=truebody,err:=json.Marshal(req)iferr!=nil{returnnil,fmt.Errorf("marshalrequest:%w",err)}httpReq,err:=http.NewRequestWithContext(ctx,http.MethodPost,p.config.BaseURL+"/chat/completions",bytes.NewReader(body))iferr!=nil{returnnil,fmt.Errorf("createrequest:%w",err)}p.setHeaders(httpReq)resp,err:=p.client.Do(httpReq)iferr!=nil{returnnil,fmt.Errorf("openaistreamrequestfailed:%w",err)}ifresp.StatusCode!=http.StatusOK{respBody,_:=io.ReadAll(resp.Body)resp.Body.Close()returnnil,fmt.Errorf("openaireturnedstatus%d:%s",resp.StatusCode,string(respBody))}returnNewHTTPStream(resp),nil}func(p*OpenAIProvider)Embeddings(ctxcontext.Context,req*EmbeddingsRequest)(*EmbeddingsResponse,error){body,err:=json.Marshal(req)iferr!=nil{returnnil,fmt.Errorf("marshalrequest:%w",err)}httpReq,err:=http.NewRequestWithContext(ctx,http.MethodPost,p.config.BaseURL+"/embeddings",bytes.NewReader(body))iferr!=nil{returnnil,fmt.Errorf("createrequest:%w",err)}p.setHeaders(httpReq)resp,err:=p.client.Do(httpReq)iferr!=nil{returnnil,fmt.Errorf("openaiembeddingsrequestfailed:%w",err)}deferresp.Body.Close()ifresp.StatusCode!=http.StatusOK{respBody,_:=io.ReadAll(resp.Body)returnnil,fmt.Errorf("openaireturnedstatus%d:%s",resp.StatusCode,string(respBody))}varembRespEmbeddingsResponseiferr:=json.NewDecoder(resp.Body).Decode(&embResp);err!=nil{returnnil,fmt.Errorf("decoderesponse:%w",err)}return&embResp,nil}func(p*OpenAIProvider)HealthCheck(ctxcontext.Context)HealthStatus{start:=time.Now()httpReq,err:=http.NewRequestWithContext(ctx,http.MethodGet,p.config.BaseURL+"/models",nil)iferr!=nil{returnHealthStatus{Healthy:false,Error:err.Error(),LastCheck:time.Now()}}p.setHeaders(httpReq)resp,err:=p.client.Do(httpReq)latency:=time.Since(start)iferr!=nil{returnHealthStatus{Healthy:false,Latency:latency,Error:err.Error(),LastCheck:time.Now()}}deferresp.Body.Close()healthy:=resp.StatusCode==http.StatusOKerrMsg:=""if!healthy{errMsg=fmt.Sprintf("status%d",resp.StatusCode)}returnHealthStatus{Healthy:healthy,Latency:latency,LastCheck:time.Now(),Error:errMsg}}func(p*OpenAIProvider)setHeaders(req*http.Request){req.Header.Set("Content-Type","application/json")req.Header.Set("Authorization","Bearer"+p.config.APIKey)fork,v:=rangep.config.Headers{req.Header.Set(k,v)}}