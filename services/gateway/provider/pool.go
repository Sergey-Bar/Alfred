packageproviderimport("crypto/tls""net""net/http""sync""sync/atomic""time")//PoolConfigholdsconnectionpoolconfiguration.typePoolConfigstruct{//MaxIdleConnsisthemaximumnumberofidleconnectionsacrossallhosts.MaxIdleConnsint`json:"max_idle_conns"`//MaxIdleConnsPerHostisthemaximumidleconnectionsperhost.MaxIdleConnsPerHostint`json:"max_idle_conns_per_host"`//MaxConnsPerHostlimitstotalconnectionsperhost(0=unlimited).MaxConnsPerHostint`json:"max_conns_per_host"`//IdleConnTimeoutishowlongidleconnectionsremaininthepool.IdleConnTimeouttime.Duration`json:"idle_conn_timeout"`//TLSHandshakeTimeoutlimitsTLShandshaketime.TLSHandshakeTimeouttime.Duration`json:"tls_handshake_timeout"`//DialTimeoutlimitsTCPconnectionestablishmenttime.DialTimeouttime.Duration`json:"dial_timeout"`//KeepAlivesetstheintervalforTCPkeep-aliveprobes.KeepAlivetime.Duration`json:"keep_alive"`//ResponseHeaderTimeoutlimitstimewaitingforresponseheaders.ResponseHeaderTimeouttime.Duration`json:"response_header_timeout"`//ExpectContinueTimeoutlimitstimewaitingfor100-continue.ExpectContinueTimeouttime.Duration`json:"expect_continue_timeout"`//DisableCompressiondisablestransportcompression.DisableCompressionbool`json:"disable_compression"`//ForceHTTP2forcesHTTP/2negotiationviaALPN.ForceHTTP2bool`json:"force_http2"`}//DefaultPoolConfigreturnsproduction-gradepooldefaults.funcDefaultPoolConfig()PoolConfig{returnPoolConfig{MaxIdleConns:256,MaxIdleConnsPerHost:32,MaxConnsPerHost:64,IdleConnTimeout:90*time.Second,TLSHandshakeTimeout:10*time.Second,DialTimeout:10*time.Second,KeepAlive:30*time.Second,ResponseHeaderTimeout:0,//handledbycontextdeadlineperrequestExpectContinueTimeout:1*time.Second,DisableCompression:false,ForceHTTP2:true,}}//PoolMetricstracksconnectionpoolutilizationmetrics.typePoolMetricsstruct{//ActiveConnectionsisthecurrentnumberofin-flightrequestsperprovider.ActiveConnectionssync.Map//map[string]*int64//TotalRequestsisthecumulativerequestcountperprovider.TotalRequestssync.Map//map[string]*int64//TotalErrorsisthecumulativeerrorcountperprovider.TotalErrorssync.Map//map[string]*int64//ConnectionReusescountshowmanyrequestsreusedanidleconnection.ConnectionReusessync.Map//map[string]*int64}//ConnectionPoolmanagessharedHTTPtransportsandclientsforproviders.typeConnectionPoolstruct{musync.RWMutextransportsmap[string]*http.Transportclientsmap[string]*http.Clientconfigsmap[string]PoolConfigdefaultsPoolConfigmetrics*PoolMetrics}//NewConnectionPoolcreatesanewconnectionpoolmanager.funcNewConnectionPool(defaultsPoolConfig)*ConnectionPool{return&ConnectionPool{transports:make(map[string]*http.Transport),clients:make(map[string]*http.Client),configs:make(map[string]PoolConfig),defaults:defaults,metrics:&PoolMetrics{},}}//DefaultConnectionPoolreturnsapoolwithproductiondefaults.funcDefaultConnectionPool()*ConnectionPool{returnNewConnectionPool(DefaultPoolConfig())}//Configuresetsacustompoolconfigurationforaspecificprovider.func(p*ConnectionPool)Configure(providerNamestring,cfgPoolConfig){p.mu.Lock()deferp.mu.Unlock()p.configs[providerName]=cfg//Invalidateexistingtransportsoitgetsrecreatedwithnewconfig.delete(p.transports,providerName)delete(p.clients,providerName)}//GetTransportreturnsthesharedHTTPtransportforaprovider.//Createsoneonfirstaccessusingtheprovider'sconfig(ordefaults).func(p*ConnectionPool)GetTransport(providerNamestring)*http.Transport{p.mu.RLock()ift,ok:=p.transports[providerName];ok{p.mu.RUnlock()returnt}p.mu.RUnlock()//Upgradetowritelocktocreatetransport.p.mu.Lock()deferp.mu.Unlock()//Double-checkafteracquiringwritelock.ift,ok:=p.transports[providerName];ok{returnt}cfg:=p.configFor(providerName)t:=p.createTransport(cfg)p.transports[providerName]=treturnt}//GetClientreturnsasharedHTTPclientforaproviderwiththegiventimeout.//Theclientusestheprovider'ssharedtransport.func(p*ConnectionPool)GetClient(providerNamestring,timeouttime.Duration)*http.Client{p.mu.RLock()ifc,ok:=p.clients[providerName];ok{p.mu.RUnlock()returnc}p.mu.RUnlock()p.mu.Lock()deferp.mu.Unlock()ifc,ok:=p.clients[providerName];ok{returnc}cfg:=p.configFor(providerName)transport:=p.createTransport(cfg)p.transports[providerName]=transportclient:=&http.Client{Transport:&metricsRoundTripper{inner:transport,providerName:providerName,metrics:p.metrics,},Timeout:timeout,}p.clients[providerName]=clientreturnclient}//Metricsreturnsthecurrentpoolmetricssnapshot.func(p*ConnectionPool)Metrics()map[string]map[string]int64{result:=make(map[string]map[string]int64)p.metrics.TotalRequests.Range(func(key,valueinterface{})bool{name:=key.(string)if_,ok:=result[name];!ok{result[name]=make(map[string]int64)}result[name]["total_requests"]=atomic.LoadInt64(value.(*int64))returntrue})p.metrics.TotalErrors.Range(func(key,valueinterface{})bool{name:=key.(string)if_,ok:=result[name];!ok{result[name]=make(map[string]int64)}result[name]["total_errors"]=atomic.LoadInt64(value.(*int64))returntrue})p.metrics.ActiveConnections.Range(func(key,valueinterface{})bool{name:=key.(string)if_,ok:=result[name];!ok{result[name]=make(map[string]int64)}result[name]["active_connections"]=atomic.LoadInt64(value.(*int64))returntrue})p.metrics.ConnectionReuses.Range(func(key,valueinterface{})bool{name:=key.(string)if_,ok:=result[name];!ok{result[name]=make(map[string]int64)}result[name]["connection_reuses"]=atomic.LoadInt64(value.(*int64))returntrue})returnresult}//Closegracefullyclosesallidleconnections.func(p*ConnectionPool)Close(){p.mu.Lock()deferp.mu.Unlock()for_,t:=rangep.transports{t.CloseIdleConnections()}}//configForreturnsthepoolconfigforaprovider,fallingbacktodefaults.func(p*ConnectionPool)configFor(providerNamestring)PoolConfig{ifcfg,ok:=p.configs[providerName];ok{returncfg}returnp.defaults}//createTransportbuildsanhttp.Transportfrompoolconfig.func(p*ConnectionPool)createTransport(cfgPoolConfig)*http.Transport{dialer:=&net.Dialer{Timeout:cfg.DialTimeout,KeepAlive:cfg.KeepAlive,}t:=&http.Transport{DialContext:dialer.DialContext,MaxIdleConns:cfg.MaxIdleConns,MaxIdleConnsPerHost:cfg.MaxIdleConnsPerHost,MaxConnsPerHost:cfg.MaxConnsPerHost,IdleConnTimeout:cfg.IdleConnTimeout,TLSHandshakeTimeout:cfg.TLSHandshakeTimeout,ResponseHeaderTimeout:cfg.ResponseHeaderTimeout,ExpectContinueTimeout:cfg.ExpectContinueTimeout,DisableCompression:cfg.DisableCompression,}ifcfg.ForceHTTP2{t.TLSClientConfig=&tls.Config{NextProtos:[]string{"h2","http/1.1"},MinVersion:tls.VersionTLS12,}t.ForceAttemptHTTP2=true}returnt}//metricsRoundTripperwrapsanhttp.RoundTrippertotrackconnectionmetrics.typemetricsRoundTripperstruct{innerhttp.RoundTripperproviderNamestringmetrics*PoolMetrics}func(m*metricsRoundTripper)RoundTrip(req*http.Request)(*http.Response,error){//Incrementactiveconnections.active:=m.getOrCreateCounter(&m.metrics.ActiveConnections,m.providerName)atomic.AddInt64(active,1)deferatomic.AddInt64(active,-1)//Incrementtotalrequests.total:=m.getOrCreateCounter(&m.metrics.TotalRequests,m.providerName)atomic.AddInt64(total,1)resp,err:=m.inner.RoundTrip(req)iferr!=nil{errCount:=m.getOrCreateCounter(&m.metrics.TotalErrors,m.providerName)atomic.AddInt64(errCount,1)returnnil,err}//Trackconnectionreuseviaresponseheader.if!resp.Close{reuses:=m.getOrCreateCounter(&m.metrics.ConnectionReuses,m.providerName)atomic.AddInt64(reuses,1)}returnresp,nil}func(m*metricsRoundTripper)getOrCreateCounter(store*sync.Map,keystring)*int64{ifval,ok:=store.Load(key);ok{returnval.(*int64)}counter:=new(int64)actual,_:=store.LoadOrStore(key,counter)returnactual.(*int64)}