packageproviderimport("bytes""context""encoding/json""fmt""io""net/http""time")constcohereBaseURL="https://api.cohere.com/v1"//CohereProviderimplementstheProviderinterfaceforCohere.typeCohereProviderstruct{configProviderConfigclient*http.Client}//NewCohereProvidercreatesanewCohereproviderconnector.funcNewCohereProvider(cfgProviderConfig)*CohereProvider{ifcfg.BaseURL==""{cfg.BaseURL=cohereBaseURL}ifcfg.Timeout==0{cfg.Timeout=120*time.Second}ifcfg.MaxRetries==0{cfg.MaxRetries=2}transport:=&http.Transport{MaxIdleConns:50,MaxIdleConnsPerHost:10,IdleConnTimeout:90*time.Second,}return&CohereProvider{config:cfg,client:&http.Client{Transport:transport,Timeout:cfg.Timeout,},}}func(p*CohereProvider)Name()string{return"cohere"}func(p*CohereProvider)Models()[]string{iflen(p.config.Models)>0{returnp.config.Models}return[]string{"command-r-plus","command-r","command-light","command","embed-english-v3.0","embed-multilingual-v3.0","embed-english-light-v3.0","embed-multilingual-light-v3.0",}}//───Cohere-specificrequest/responsetypes─────────────────typecohereChatRequeststruct{Modelstring`json:"model"`Messagestring`json:"message"`ChatHistory[]cohereChatMessage`json:"chat_history,omitempty"`Streambool`json:"stream,omitempty"`MaxTokens*int`json:"max_tokens,omitempty"`Temperature*float64`json:"temperature,omitempty"`TopP*float64`json:"p,omitempty"`StopSeqs[]string`json:"stop_sequences,omitempty"`}typecohereChatMessagestruct{Rolestring`json:"role"`//USERorCHATBOTMessagestring`json:"message"`}typecohereChatResponsestruct{ResponseIDstring`json:"response_id"`Textstring`json:"text"`GenerationIDstring`json:"generation_id"`TokenCount*cohereTokenCount`json:"token_count,omitempty"`Metamap[string]interface{}`json:"meta,omitempty"`FinishReasonstring`json:"finish_reason"`}typecohereTokenCountstruct{PromptTokensint`json:"prompt_tokens"`ResponseTokensint`json:"response_tokens"`TotalTokensint`json:"total_tokens"`}typecohereEmbedRequeststruct{Texts[]string`json:"texts"`Modelstring`json:"model"`InputTypestring`json:"input_type"`//search_document,search_query,classification,clustering}typecohereEmbedResponsestruct{IDstring`json:"id"`Embeddings[][]float64`json:"embeddings"`Texts[]string`json:"texts"`Meta*struct{BilledUnits*struct{InputTokensint`json:"input_tokens"`}`json:"billed_units,omitempty"`}`json:"meta,omitempty"`}//───Providerinterfaceimplementation──────────────────────func(p*CohereProvider)ChatCompletion(ctxcontext.Context,req*ChatRequest)(*ChatResponse,error){cohReq:=p.toCohereChat(req)cohReq.Stream=falsebody,err:=json.Marshal(cohReq)iferr!=nil{returnnil,fmt.Errorf("marshalcohererequest:%w",err)}httpReq,err:=http.NewRequestWithContext(ctx,http.MethodPost,p.config.BaseURL+"/chat",bytes.NewReader(body))iferr!=nil{returnnil,fmt.Errorf("createrequest:%w",err)}p.setHeaders(httpReq)resp,err:=p.client.Do(httpReq)iferr!=nil{returnnil,fmt.Errorf("cohererequestfailed:%w",err)}deferresp.Body.Close()ifresp.StatusCode!=http.StatusOK{respBody,_:=io.ReadAll(resp.Body)returnnil,fmt.Errorf("coherereturnedstatus%d:%s",resp.StatusCode,string(respBody))}varcohRespcohereChatResponseiferr:=json.NewDecoder(resp.Body).Decode(&cohResp);err!=nil{returnnil,fmt.Errorf("decodecohereresponse:%w",err)}returnp.toOpenAIResponse(&cohResp,req.Model),nil}func(p*CohereProvider)ChatCompletionStream(ctxcontext.Context,req*ChatRequest)(Stream,error){cohReq:=p.toCohereChat(req)cohReq.Stream=truebody,err:=json.Marshal(cohReq)iferr!=nil{returnnil,fmt.Errorf("marshalcohererequest:%w",err)}httpReq,err:=http.NewRequestWithContext(ctx,http.MethodPost,p.config.BaseURL+"/chat",bytes.NewReader(body))iferr!=nil{returnnil,fmt.Errorf("createrequest:%w",err)}p.setHeaders(httpReq)resp,err:=p.client.Do(httpReq)iferr!=nil{returnnil,fmt.Errorf("coherestreamrequestfailed:%w",err)}ifresp.StatusCode!=http.StatusOK{respBody,_:=io.ReadAll(resp.Body)resp.Body.Close()returnnil,fmt.Errorf("coherereturnedstatus%d:%s",resp.StatusCode,string(respBody))}returnNewHTTPStream(resp),nil}func(p*CohereProvider)Embeddings(ctxcontext.Context,req*EmbeddingsRequest)(*EmbeddingsResponse,error){texts:=inputToStrings(req.Input)cohReq:=cohereEmbedRequest{Texts:texts,Model:req.Model,InputType:"search_document",}body,err:=json.Marshal(cohReq)iferr!=nil{returnnil,fmt.Errorf("marshalcohereembedrequest:%w",err)}httpReq,err:=http.NewRequestWithContext(ctx,http.MethodPost,p.config.BaseURL+"/embed",bytes.NewReader(body))iferr!=nil{returnnil,fmt.Errorf("createrequest:%w",err)}p.setHeaders(httpReq)resp,err:=p.client.Do(httpReq)iferr!=nil{returnnil,fmt.Errorf("cohereembedrequestfailed:%w",err)}deferresp.Body.Close()ifresp.StatusCode!=http.StatusOK{respBody,_:=io.ReadAll(resp.Body)returnnil,fmt.Errorf("coherereturnedstatus%d:%s",resp.StatusCode,string(respBody))}varcohRespcohereEmbedResponseiferr:=json.NewDecoder(resp.Body).Decode(&cohResp);err!=nil{returnnil,fmt.Errorf("decodecohereembedresponse:%w",err)}data:=make([]EmbeddingData,len(cohResp.Embeddings))fori,emb:=rangecohResp.Embeddings{data[i]=EmbeddingData{Object:"embedding",Embedding:emb,Index:i,}}promptTokens:=0ifcohResp.Meta!=nil&&cohResp.Meta.BilledUnits!=nil{promptTokens=cohResp.Meta.BilledUnits.InputTokens}return&EmbeddingsResponse{Object:"list",Data:data,Model:req.Model,Usage:EmbeddingsUsage{PromptTokens:promptTokens,TotalTokens:promptTokens,},},nil}func(p*CohereProvider)HealthCheck(ctxcontext.Context)HealthStatus{start:=time.Now()httpReq,err:=http.NewRequestWithContext(ctx,http.MethodGet,p.config.BaseURL+"/models",nil)iferr!=nil{returnHealthStatus{Healthy:false,Error:err.Error(),LastCheck:time.Now()}}p.setHeaders(httpReq)resp,err:=p.client.Do(httpReq)latency:=time.Since(start)iferr!=nil{returnHealthStatus{Healthy:false,Latency:latency,Error:err.Error(),LastCheck:time.Now()}}deferresp.Body.Close()healthy:=resp.StatusCode==http.StatusOKerrMsg:=""if!healthy{errMsg=fmt.Sprintf("status%d",resp.StatusCode)}returnHealthStatus{Healthy:healthy,Latency:latency,LastCheck:time.Now(),Error:errMsg}}//───Helpers────────────────────────────────────────────────func(p*CohereProvider)setHeaders(req*http.Request){req.Header.Set("Content-Type","application/json")req.Header.Set("Authorization","Bearer"+p.config.APIKey)req.Header.Set("X-Client-Name","alfred-gateway")fork,v:=rangep.config.Headers{req.Header.Set(k,v)}}//toCohereChatconvertsanOpenAI-compatibleChatRequesttoCohere'sformat.func(p*CohereProvider)toCohereChat(req*ChatRequest)cohereChatRequest{varhistory[]cohereChatMessagevarlastMessagestringfori,msg:=rangereq.Messages{content:=""switchv:=msg.Content.(type){casestring:content=vdefault:b,_:=json.Marshal(v)content=string(b)}ifi==len(req.Messages)-1&&msg.Role=="user"{lastMessage=content}else{role:="USER"ifmsg.Role=="assistant"{role="CHATBOT"}elseifmsg.Role=="system"{role="SYSTEM"}history=append(history,cohereChatMessage{Role:role,Message:content})}}returncohereChatRequest{Model:req.Model,Message:lastMessage,ChatHistory:history,MaxTokens:req.MaxTokens,Temperature:req.Temperature,TopP:req.TopP,StopSeqs:req.Stop,}}//toOpenAIResponseconvertsaCohereresponsetoOpenAI-compatibleformat.func(p*CohereProvider)toOpenAIResponse(cohResp*cohereChatResponse,modelstring)*ChatResponse{usage:=Usage{}ifcohResp.TokenCount!=nil{usage.PromptTokens=cohResp.TokenCount.PromptTokensusage.CompletionTokens=cohResp.TokenCount.ResponseTokensusage.TotalTokens=cohResp.TokenCount.TotalTokens}return&ChatResponse{ID:cohResp.ResponseID,Object:"chat.completion",Created:time.Now().Unix(),Model:model,Choices:[]Choice{{Index:0,Message:ChatMessage{Role:"assistant",Content:cohResp.Text,},FinishReason:p.mapFinishReason(cohResp.FinishReason),},},Usage:usage,}}func(p*CohereProvider)mapFinishReason(reasonstring)string{switchreason{case"COMPLETE":return"stop"case"MAX_TOKENS":return"length"case"ERROR","ERROR_TOXIC","ERROR_LIMIT":return"stop"default:return"stop"}}//inputToStringsconvertstheembeddingsInputfieldtoastringslice.funcinputToStrings(inputinterface{})[]string{switchv:=input.(type){casestring:return[]string{v}case[]interface{}:result:=make([]string,0,len(v))for_,item:=rangev{ifs,ok:=item.(string);ok{result=append(result,s)}}returnresultcase[]string:returnvdefault:return[]string{fmt.Sprintf("%v",input)}}}