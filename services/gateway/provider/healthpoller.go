packageproviderimport("context""sync""time""github.com/rs/zerolog")//HealthPollercontinuouslymonitorsproviderhealthinthebackground.typeHealthPollerstruct{registry*Registryloggerzerolog.Loggerintervaltime.Duration//Cachedlast-knownstatusfortransitiondetectionmusync.RWMutexlastStatusmap[string]bool//providername→washealthystatusChangeCBfunc(providerstring,healthybool,statusHealthStatus)cancelcontext.CancelFuncdonechanstruct{}}//NewHealthPollercreatesapollerthatchecksallprovidersatthe//giveninterval(minimum5seconds).funcNewHealthPoller(registry*Registry,loggerzerolog.Logger,intervaltime.Duration,)*HealthPoller{ifinterval<5*time.Second{interval=5*time.Second}return&HealthPoller{registry:registry,logger:logger.With().Str("component","health_poller").Logger(),interval:interval,lastStatus:make(map[string]bool),done:make(chanstruct{}),}}//OnStatusChangeregistersacallbackinvokedwhenaprovider'shealth//statustransitions(healthy→unhealthyorviceversa).func(hp*HealthPoller)OnStatusChange(cbfunc(providerstring,healthybool,statusHealthStatus)){hp.statusChangeCB=cb}//Startbeginsthebackgroundpollingloop.//CallStop()toshutitdowngracefully.func(hp*HealthPoller)Start(){ctx,cancel:=context.WithCancel(context.Background())hp.cancel=cancelhp.logger.Info().Dur("interval",hp.interval).Msg("startingproviderhealthpoller")gohp.pollLoop(ctx)}//Stopgracefullyshutsdownthepollerandwaitsforittofinish.func(hp*HealthPoller)Stop(){ifhp.cancel!=nil{hp.cancel()}<-hp.donehp.logger.Info().Msg("healthpollerstopped")}func(hp*HealthPoller)pollLoop(ctxcontext.Context){deferclose(hp.done)//Runimmediatelyonstarthp.poll(ctx)ticker:=time.NewTicker(hp.interval)deferticker.Stop()for{select{case<-ctx.Done():returncase<-ticker.C:hp.poll(ctx)}}}func(hp*HealthPoller)poll(ctxcontext.Context){//Useaper-polltimeoutsoasingleslowproviderdoesn'tblockthecyclepollCtx,cancel:=context.WithTimeout(ctx,hp.interval/2)defercancel()results:=hp.registry.HealthCheckAll(pollCtx)hp.mu.Lock()deferhp.mu.Unlock()healthy:=0unhealthy:=0forname,status:=rangeresults{//DetecttransitionswasHealthy,known:=hp.lastStatus[name]ifknown&&wasHealthy!=status.Healthy{transition:="recovered"if!status.Healthy{transition="degraded"}hp.logger.Warn().Str("provider",name).Str("transition",transition).Str("error",status.Error).Dur("latency",status.Latency).Msg("providerstatuschange")ifhp.statusChangeCB!=nil{hp.statusChangeCB(name,status.Healthy,status)}}hp.lastStatus[name]=status.Healthyifstatus.Healthy{healthy++}else{unhealthy++}}hp.logger.Debug().Int("healthy",healthy).Int("unhealthy",unhealthy).Int("total",len(results)).Msg("healthpollcomplete")}//Statusreturnsthelatestcachedhealthstatusforallproviders.func(hp*HealthPoller)Status()map[string]HealthStatus{returnhp.registry.HealthCheckAll(context.Background())}//IsHealthyreturnswhetheraspecificproviderwashealthyatlastcheck.func(hp*HealthPoller)IsHealthy(namestring)bool{hp.mu.RLock()deferhp.mu.RUnlock()healthy,ok:=hp.lastStatus[name]returnok&&healthy}//HealthyProvidersreturnsonlythenamesofcurrentlyhealthyproviders.func(hp*HealthPoller)HealthyProviders()[]string{hp.mu.RLock()deferhp.mu.RUnlock()varnames[]stringforname,healthy:=rangehp.lastStatus{ifhealthy{names=append(names,name)}}returnnames}