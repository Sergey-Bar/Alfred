packageproviderimport("bytes""context""encoding/json""fmt""io""net/http""time")constollamaDefaultBaseURL="http://localhost:11434"//OllamaProviderimplementstheProviderinterfaceforOllama.typeOllamaProviderstruct{configProviderConfigclient*http.Client}//NewOllamaProvidercreatesanewOllamaproviderconnector.funcNewOllamaProvider(cfgProviderConfig)*OllamaProvider{ifcfg.BaseURL==""{cfg.BaseURL=ollamaDefaultBaseURL}ifcfg.Timeout==0{cfg.Timeout=300*time.Second//Localmodelscanbeslow}ifcfg.MaxRetries==0{cfg.MaxRetries=1}transport:=&http.Transport{MaxIdleConns:20,MaxIdleConnsPerHost:10,IdleConnTimeout:90*time.Second,}return&OllamaProvider{config:cfg,client:&http.Client{Transport:transport,Timeout:cfg.Timeout,},}}func(p*OllamaProvider)Name()string{return"ollama"}func(p*OllamaProvider)Models()[]string{iflen(p.config.Models)>0{returnp.config.Models}return[]string{"llama3.1","llama3.1:70b","llama3.1:8b","codellama","mistral","mixtral","phi3","gemma2","qwen2",}}func(p*OllamaProvider)ChatCompletion(ctxcontext.Context,req*ChatRequest)(*ChatResponse,error){//OllamasupportsOpenAI-compatible/v1/chat/completionsreq.Stream=falsebody,err:=json.Marshal(req)iferr!=nil{returnnil,fmt.Errorf("marshalrequest:%w",err)}httpReq,err:=http.NewRequestWithContext(ctx,http.MethodPost,p.config.BaseURL+"/v1/chat/completions",bytes.NewReader(body))iferr!=nil{returnnil,fmt.Errorf("createrequest:%w",err)}p.setHeaders(httpReq)resp,err:=p.client.Do(httpReq)iferr!=nil{returnnil,fmt.Errorf("ollamarequestfailed:%w",err)}deferresp.Body.Close()ifresp.StatusCode!=http.StatusOK{respBody,_:=io.ReadAll(resp.Body)returnnil,fmt.Errorf("ollamareturnedstatus%d:%s",resp.StatusCode,string(respBody))}varchatRespChatResponseiferr:=json.NewDecoder(resp.Body).Decode(&chatResp);err!=nil{returnnil,fmt.Errorf("decoderesponse:%w",err)}return&chatResp,nil}func(p*OllamaProvider)ChatCompletionStream(ctxcontext.Context,req*ChatRequest)(Stream,error){req.Stream=truebody,err:=json.Marshal(req)iferr!=nil{returnnil,fmt.Errorf("marshalrequest:%w",err)}httpReq,err:=http.NewRequestWithContext(ctx,http.MethodPost,p.config.BaseURL+"/v1/chat/completions",bytes.NewReader(body))iferr!=nil{returnnil,fmt.Errorf("createrequest:%w",err)}p.setHeaders(httpReq)resp,err:=p.client.Do(httpReq)iferr!=nil{returnnil,fmt.Errorf("ollamastreamrequestfailed:%w",err)}ifresp.StatusCode!=http.StatusOK{respBody,_:=io.ReadAll(resp.Body)resp.Body.Close()returnnil,fmt.Errorf("ollamareturnedstatus%d:%s",resp.StatusCode,string(respBody))}returnNewHTTPStream(resp),nil}func(p*OllamaProvider)Embeddings(ctxcontext.Context,req*EmbeddingsRequest)(*EmbeddingsResponse,error){body,err:=json.Marshal(req)iferr!=nil{returnnil,fmt.Errorf("marshalrequest:%w",err)}httpReq,err:=http.NewRequestWithContext(ctx,http.MethodPost,p.config.BaseURL+"/v1/embeddings",bytes.NewReader(body))iferr!=nil{returnnil,fmt.Errorf("createrequest:%w",err)}p.setHeaders(httpReq)resp,err:=p.client.Do(httpReq)iferr!=nil{returnnil,fmt.Errorf("ollamaembeddingsrequestfailed:%w",err)}deferresp.Body.Close()ifresp.StatusCode!=http.StatusOK{respBody,_:=io.ReadAll(resp.Body)returnnil,fmt.Errorf("ollamareturnedstatus%d:%s",resp.StatusCode,string(respBody))}varembRespEmbeddingsResponseiferr:=json.NewDecoder(resp.Body).Decode(&embResp);err!=nil{returnnil,fmt.Errorf("decoderesponse:%w",err)}return&embResp,nil}func(p*OllamaProvider)HealthCheck(ctxcontext.Context)HealthStatus{start:=time.Now()httpReq,err:=http.NewRequestWithContext(ctx,http.MethodGet,p.config.BaseURL+"/api/tags",nil)iferr!=nil{returnHealthStatus{Healthy:false,Error:err.Error(),LastCheck:time.Now()}}resp,err:=p.client.Do(httpReq)latency:=time.Since(start)iferr!=nil{returnHealthStatus{Healthy:false,Latency:latency,Error:err.Error(),LastCheck:time.Now()}}deferresp.Body.Close()healthy:=resp.StatusCode==http.StatusOKerrMsg:=""if!healthy{errMsg=fmt.Sprintf("status%d",resp.StatusCode)}returnHealthStatus{Healthy:healthy,Latency:latency,LastCheck:time.Now(),Error:errMsg}}func(p*OllamaProvider)setHeaders(req*http.Request){req.Header.Set("Content-Type","application/json")//Ollamadoesn'trequireauthbydefault,butsupportcustomheadersifp.config.APIKey!=""{req.Header.Set("Authorization","Bearer"+p.config.APIKey)}fork,v:=rangep.config.Headers{req.Header.Set(k,v)}}