packageproviderimport("bytes""context""encoding/json""fmt""io""net/http""strings""time")const(geminiBaseURL="https://generativelanguage.googleapis.com/v1beta")//GeminiProviderimplementstheProviderinterfaceforGoogleGemini.typeGeminiProviderstruct{configProviderConfigclient*http.Client}//NewGeminiProvidercreatesanewGoogleGeminiproviderconnector.funcNewGeminiProvider(cfgProviderConfig)*GeminiProvider{ifcfg.BaseURL==""{cfg.BaseURL=geminiBaseURL}ifcfg.Timeout==0{cfg.Timeout=120*time.Second}ifcfg.MaxRetries==0{cfg.MaxRetries=2}transport:=&http.Transport{MaxIdleConns:100,MaxIdleConnsPerHost:20,IdleConnTimeout:90*time.Second,}return&GeminiProvider{config:cfg,client:&http.Client{Transport:transport,Timeout:cfg.Timeout,},}}func(p*GeminiProvider)Name()string{return"google"}func(p*GeminiProvider)Models()[]string{iflen(p.config.Models)>0{returnp.config.Models}return[]string{"gemini-2.0-flash","gemini-1.5-pro","gemini-1.5-flash","gemini-2.0-flash-lite","text-embedding-004",}}//---Gemini-specificrequest/responsetypes---typegeminiRequeststruct{Contents[]geminiContent`json:"contents"`GenerationConfig*geminiGenerationConfig`json:"generationConfig,omitempty"`SafetySettings[]geminiSafetySetting`json:"safetySettings,omitempty"`}typegeminiContentstruct{Rolestring`json:"role"`Parts[]geminiPart`json:"parts"`}typegeminiPartstruct{Textstring`json:"text,omitempty"`}typegeminiGenerationConfigstruct{MaxOutputTokens*int`json:"maxOutputTokens,omitempty"`Temperature*float64`json:"temperature,omitempty"`TopP*float64`json:"topP,omitempty"`StopSequences[]string`json:"stopSequences,omitempty"`}typegeminiSafetySettingstruct{Categorystring`json:"category"`Thresholdstring`json:"threshold"`}typegeminiResponsestruct{Candidates[]geminiCandidate`json:"candidates"`UsageMetadata*geminiUsageMetadata`json:"usageMetadata,omitempty"`}typegeminiCandidatestruct{ContentgeminiContent`json:"content"`FinishReasonstring`json:"finishReason"`Indexint`json:"index"`}typegeminiUsageMetadatastruct{PromptTokenCountint`json:"promptTokenCount"`CandidatesTokenCountint`json:"candidatesTokenCount"`TotalTokenCountint`json:"totalTokenCount"`}//---Translationhelpers---funcopenAIRoleToGemini(rolestring)string{switchrole{case"assistant":return"model"case"system":return"user"//Geminihandlessystempromptsviasystem_instructionorasusercontextdefault:returnrole}}funcgeminiRoleToOpenAI(rolestring)string{switchrole{case"model":return"assistant"default:returnrole}}func(p*GeminiProvider)toGeminiRequest(req*ChatRequest)geminiRequest{contents:=make([]geminiContent,0,len(req.Messages))for_,msg:=rangereq.Messages{text:=""switchv:=msg.Content.(type){casestring:text=vdefault:b,_:=json.Marshal(v)text=string(b)}contents=append(contents,geminiContent{Role:openAIRoleToGemini(msg.Role),Parts:[]geminiPart{{Text:text}},})}gemReq:=geminiRequest{Contents:contents}ifreq.MaxTokens!=nil||req.Temperature!=nil||req.TopP!=nil||len(req.Stop)>0{gemReq.GenerationConfig=&geminiGenerationConfig{MaxOutputTokens:req.MaxTokens,Temperature:req.Temperature,TopP:req.TopP,StopSequences:req.Stop,}}returngemReq}func(p*GeminiProvider)toOpenAIResponse(gemResp*geminiResponse,modelstring)*ChatResponse{choices:=make([]Choice,0,len(gemResp.Candidates))for_,c:=rangegemResp.Candidates{text:=""for_,part:=rangec.Content.Parts{text+=part.Text}finishReason:=strings.ToLower(c.FinishReason)iffinishReason=="stop"||finishReason==""{finishReason="stop"}elseiffinishReason=="max_tokens"{finishReason="length"}choices=append(choices,Choice{Index:c.Index,Message:ChatMessage{Role:geminiRoleToOpenAI(c.Content.Role),Content:text,},FinishReason:finishReason,})}usage:=Usage{}ifgemResp.UsageMetadata!=nil{usage.PromptTokens=gemResp.UsageMetadata.PromptTokenCountusage.CompletionTokens=gemResp.UsageMetadata.CandidatesTokenCountusage.TotalTokens=gemResp.UsageMetadata.TotalTokenCount}return&ChatResponse{ID:fmt.Sprintf("gemini-%d",time.Now().UnixNano()),Object:"chat.completion",Created:time.Now().Unix(),Model:model,Choices:choices,Usage:usage,}}//---Providerinterfaceimplementation---func(p*GeminiProvider)ChatCompletion(ctxcontext.Context,req*ChatRequest)(*ChatResponse,error){gemReq:=p.toGeminiRequest(req)body,err:=json.Marshal(gemReq)iferr!=nil{returnnil,fmt.Errorf("marshalgeminirequest:%w",err)}model:=req.Modelurl:=fmt.Sprintf("%s/models/%s:generateContent?key=%s",p.config.BaseURL,model,p.config.APIKey)httpReq,err:=http.NewRequestWithContext(ctx,http.MethodPost,url,bytes.NewReader(body))iferr!=nil{returnnil,fmt.Errorf("createrequest:%w",err)}httpReq.Header.Set("Content-Type","application/json")resp,err:=p.client.Do(httpReq)iferr!=nil{returnnil,fmt.Errorf("geminirequestfailed:%w",err)}deferresp.Body.Close()ifresp.StatusCode!=http.StatusOK{respBody,_:=io.ReadAll(resp.Body)returnnil,fmt.Errorf("geminireturnedstatus%d:%s",resp.StatusCode,string(respBody))}vargemRespgeminiResponseiferr:=json.NewDecoder(resp.Body).Decode(&gemResp);err!=nil{returnnil,fmt.Errorf("decodegeminiresponse:%w",err)}returnp.toOpenAIResponse(&gemResp,model),nil}func(p*GeminiProvider)ChatCompletionStream(ctxcontext.Context,req*ChatRequest)(Stream,error){gemReq:=p.toGeminiRequest(req)body,err:=json.Marshal(gemReq)iferr!=nil{returnnil,fmt.Errorf("marshalgeminirequest:%w",err)}model:=req.Modelurl:=fmt.Sprintf("%s/models/%s:streamGenerateContent?key=%s&alt=sse",p.config.BaseURL,model,p.config.APIKey)httpReq,err:=http.NewRequestWithContext(ctx,http.MethodPost,url,bytes.NewReader(body))iferr!=nil{returnnil,fmt.Errorf("createrequest:%w",err)}httpReq.Header.Set("Content-Type","application/json")resp,err:=p.client.Do(httpReq)iferr!=nil{returnnil,fmt.Errorf("geministreamrequestfailed:%w",err)}ifresp.StatusCode!=http.StatusOK{respBody,_:=io.ReadAll(resp.Body)resp.Body.Close()returnnil,fmt.Errorf("geminireturnedstatus%d:%s",resp.StatusCode,string(respBody))}returnNewHTTPStream(resp),nil}func(p*GeminiProvider)Embeddings(ctxcontext.Context,req*EmbeddingsRequest)(*EmbeddingsResponse,error){//Geminiusesadifferentembeddingsendpointinput:=""switchv:=req.Input.(type){casestring:input=vcase[]interface{}:iflen(v)>0{ifs,ok:=v[0].(string);ok{input=s}}}gemEmbReq:=map[string]interface{}{"model":"models/"+req.Model,"content":map[string]interface{}{"parts":[]map[string]string{{"text":input},},},}body,err:=json.Marshal(gemEmbReq)iferr!=nil{returnnil,fmt.Errorf("marshalembeddingrequest:%w",err)}model:=req.Modelurl:=fmt.Sprintf("%s/models/%s:embedContent?key=%s",p.config.BaseURL,model,p.config.APIKey)httpReq,err:=http.NewRequestWithContext(ctx,http.MethodPost,url,bytes.NewReader(body))iferr!=nil{returnnil,fmt.Errorf("createrequest:%w",err)}httpReq.Header.Set("Content-Type","application/json")resp,err:=p.client.Do(httpReq)iferr!=nil{returnnil,fmt.Errorf("geminiembeddingsrequestfailed:%w",err)}deferresp.Body.Close()ifresp.StatusCode!=http.StatusOK{respBody,_:=io.ReadAll(resp.Body)returnnil,fmt.Errorf("geminireturnedstatus%d:%s",resp.StatusCode,string(respBody))}//ParseGeminiembeddingresponsevargemEmbRespstruct{Embeddingstruct{Values[]float64`json:"values"`}`json:"embedding"`}iferr:=json.NewDecoder(resp.Body).Decode(&gemEmbResp);err!=nil{returnnil,fmt.Errorf("decodeembeddingresponse:%w",err)}return&EmbeddingsResponse{Object:"list",Data:[]EmbeddingData{{Object:"embedding",Embedding:gemEmbResp.Embedding.Values,Index:0,}},Model:model,Usage:EmbeddingsUsage{PromptTokens:0,//Geminidoesn'talwaysreturntokencountsforembeddingsTotalTokens:0,},},nil}func(p*GeminiProvider)HealthCheck(ctxcontext.Context)HealthStatus{start:=time.Now()url:=fmt.Sprintf("%s/models?key=%s",p.config.BaseURL,p.config.APIKey)httpReq,err:=http.NewRequestWithContext(ctx,http.MethodGet,url,nil)iferr!=nil{returnHealthStatus{Healthy:false,Error:err.Error(),LastCheck:time.Now()}}resp,err:=p.client.Do(httpReq)latency:=time.Since(start)iferr!=nil{returnHealthStatus{Healthy:false,Latency:latency,Error:err.Error(),LastCheck:time.Now()}}deferresp.Body.Close()healthy:=resp.StatusCode==http.StatusOKerrMsg:=""if!healthy{errMsg=fmt.Sprintf("status%d",resp.StatusCode)}returnHealthStatus{Healthy:healthy,Latency:latency,LastCheck:time.Now(),Error:errMsg}}