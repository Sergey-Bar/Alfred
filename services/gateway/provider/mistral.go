packageproviderimport("bytes""context""encoding/json""fmt""io""net/http")const(mistralBaseURL="https://api.mistral.ai/v1")//MistralProviderimplementstheProviderinterfaceforMistralAI.typeMistralProviderstruct{configProviderConfigclient*http.Client}//NewMistralProvidercreatesanewMistralproviderconnector.funcNewMistralProvider(cfgProviderConfig)*MistralProvider{ifcfg.BaseURL==""{cfg.BaseURL=mistralBaseURL}return&MistralProvider{config:cfg,client:&http.Client{Timeout:cfg.Timeout},}}func(p*MistralProvider)Name()string{return"mistral"}func(p*MistralProvider)Models()[]string{return[]string{"mistral-large-latest","mistral-medium-latest","mistral-small-latest","codestral-latest","mistral-embed","open-mistral-nemo","open-mixtral-8x22b",}}func(p*MistralProvider)HealthCheck(ctxcontext.Context)HealthStatus{req,err:=http.NewRequestWithContext(ctx,http.MethodGet,p.config.BaseURL+"/models",nil)iferr!=nil{returnHealthStatus{Healthy:false,Error:err.Error()}}req.Header.Set("Authorization","Bearer"+p.config.APIKey)resp,err:=p.client.Do(req)iferr!=nil{returnHealthStatus{Healthy:false,Error:err.Error()}}deferresp.Body.Close()returnHealthStatus{Healthy:resp.StatusCode==http.StatusOK,Error:fmt.Sprintf("status=%d",resp.StatusCode),}}func(p*MistralProvider)ChatCompletion(ctxcontext.Context,req*ChatRequest)(*ChatResponse,error){body,err:=json.Marshal(req)iferr!=nil{returnnil,fmt.Errorf("mistral:marshalrequest:%w",err)}httpReq,err:=http.NewRequestWithContext(ctx,http.MethodPost,p.config.BaseURL+"/chat/completions",bytes.NewReader(body))iferr!=nil{returnnil,fmt.Errorf("mistral:createrequest:%w",err)}httpReq.Header.Set("Content-Type","application/json")httpReq.Header.Set("Authorization","Bearer"+p.config.APIKey)resp,err:=p.client.Do(httpReq)iferr!=nil{returnnil,fmt.Errorf("mistral:requestfailed:%w",err)}deferresp.Body.Close()ifresp.StatusCode!=http.StatusOK{respBody,_:=io.ReadAll(resp.Body)returnnil,fmt.Errorf("mistral:APIerror%d:%s",resp.StatusCode,string(respBody))}varresultChatResponseiferr:=json.NewDecoder(resp.Body).Decode(&result);err!=nil{returnnil,fmt.Errorf("mistral:decoderesponse:%w",err)}return&result,nil}func(p*MistralProvider)ChatCompletionStream(ctxcontext.Context,req*ChatRequest)(Stream,error){req.Stream=truebody,err:=json.Marshal(req)iferr!=nil{returnnil,fmt.Errorf("mistral:marshalstreamrequest:%w",err)}httpReq,err:=http.NewRequestWithContext(ctx,http.MethodPost,p.config.BaseURL+"/chat/completions",bytes.NewReader(body))iferr!=nil{returnnil,fmt.Errorf("mistral:createstreamrequest:%w",err)}httpReq.Header.Set("Content-Type","application/json")httpReq.Header.Set("Authorization","Bearer"+p.config.APIKey)resp,err:=p.client.Do(httpReq)iferr!=nil{returnnil,fmt.Errorf("mistral:streamrequestfailed:%w",err)}ifresp.StatusCode!=http.StatusOK{respBody,_:=io.ReadAll(resp.Body)resp.Body.Close()returnnil,fmt.Errorf("mistral:streamAPIerror%d:%s",resp.StatusCode,string(respBody))}returnNewHTTPStream(resp),nil}func(p*MistralProvider)Embeddings(ctxcontext.Context,req*EmbeddingsRequest)(*EmbeddingsResponse,error){body,err:=json.Marshal(req)iferr!=nil{returnnil,fmt.Errorf("mistral:marshalembeddingrequest:%w",err)}httpReq,err:=http.NewRequestWithContext(ctx,http.MethodPost,p.config.BaseURL+"/embeddings",bytes.NewReader(body))iferr!=nil{returnnil,fmt.Errorf("mistral:createembeddingrequest:%w",err)}httpReq.Header.Set("Content-Type","application/json")httpReq.Header.Set("Authorization","Bearer"+p.config.APIKey)resp,err:=p.client.Do(httpReq)iferr!=nil{returnnil,fmt.Errorf("mistral:embeddingrequestfailed:%w",err)}deferresp.Body.Close()ifresp.StatusCode!=http.StatusOK{respBody,_:=io.ReadAll(resp.Body)returnnil,fmt.Errorf("mistral:embeddingAPIerror%d:%s",resp.StatusCode,string(respBody))}varresultEmbeddingsResponseiferr:=json.NewDecoder(resp.Body).Decode(&result);err!=nil{returnnil,fmt.Errorf("mistral:decodeembeddingresponse:%w",err)}return&result,nil}