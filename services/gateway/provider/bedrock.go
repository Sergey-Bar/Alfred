packageproviderimport("bytes""context""crypto/hmac""crypto/sha256""encoding/hex""encoding/json""fmt""io""net/http""strings""time")//BedrockProviderimplementstheProviderinterfaceforAWSBedrock.typeBedrockProviderstruct{configProviderConfigregionstringaccessKeystringsecretKeystringclient*http.Client}//BedrockConfigholdsAWS-specificconfiguration.typeBedrockConfigstruct{ProviderConfigRegionstring`json:"region"`AccessKeystring`json:"-"`SecretKeystring`json:"-"`}//NewBedrockProvidercreatesanewAWSBedrockproviderconnector.funcNewBedrockProvider(cfgBedrockConfig)*BedrockProvider{region:=cfg.Regionifregion==""{region="us-east-1"}ifcfg.BaseURL==""{cfg.BaseURL=fmt.Sprintf("https://bedrock-runtime.%s.amazonaws.com",region)}ifcfg.Timeout==0{cfg.Timeout=120*time.Second}ifcfg.MaxRetries==0{cfg.MaxRetries=2}transport:=&http.Transport{MaxIdleConns:50,MaxIdleConnsPerHost:10,IdleConnTimeout:90*time.Second,}return&BedrockProvider{config:cfg.ProviderConfig,region:region,accessKey:cfg.AccessKey,secretKey:cfg.SecretKey,client:&http.Client{Transport:transport,Timeout:cfg.Timeout,},}}func(p*BedrockProvider)Name()string{return"bedrock"}func(p*BedrockProvider)Models()[]string{iflen(p.config.Models)>0{returnp.config.Models}return[]string{"anthropic.claude-3-5-sonnet-20241022-v2:0","anthropic.claude-3-haiku-20240307-v1:0","anthropic.claude-3-opus-20240229-v1:0","amazon.titan-text-express-v1","amazon.titan-text-lite-v1","amazon.titan-embed-text-v2:0","meta.llama3-1-70b-instruct-v1:0","meta.llama3-1-8b-instruct-v1:0","cohere.command-r-plus-v1:0","mistral.mistral-large-2407-v1:0",}}//───Bedrockrequest/responsetypes─────────────────────────typebedrockInvokeBodystruct{Messages[]bedrockMessage`json:"messages"`Systemstring`json:"system,omitempty"`MaxTokensint`json:"max_tokens,omitempty"`Temperature*float64`json:"temperature,omitempty"`TopP*float64`json:"top_p,omitempty"`StopSequences[]string`json:"stop_sequences,omitempty"`//Anthropic-on-BedrockspecificAnthropicVersionstring`json:"anthropic_version,omitempty"`}typebedrockMessagestruct{Rolestring`json:"role"`Contentstring`json:"content"`}typebedrockResponsestruct{IDstring`json:"id"`Typestring`json:"type"`Rolestring`json:"role"`Content[]bedrockBlock`json:"content"`Modelstring`json:"model"`Usage*bedrockUsage`json:"usage,omitempty"`Stopstring`json:"stop_reason,omitempty"`}typebedrockBlockstruct{Typestring`json:"type"`Textstring`json:"text"`}typebedrockUsagestruct{InputTokensint`json:"input_tokens"`OutputTokensint`json:"output_tokens"`}//───Providerinterfaceimplementation──────────────────────func(p*BedrockProvider)ChatCompletion(ctxcontext.Context,req*ChatRequest)(*ChatResponse,error){modelID:=req.Modelbody:=p.buildInvokeBody(req)payload,err:=json.Marshal(body)iferr!=nil{returnnil,fmt.Errorf("marshalbedrockrequest:%w",err)}endpoint:=fmt.Sprintf("%s/model/%s/invoke",p.config.BaseURL,modelID)httpReq,err:=http.NewRequestWithContext(ctx,http.MethodPost,endpoint,bytes.NewReader(payload))iferr!=nil{returnnil,fmt.Errorf("createrequest:%w",err)}p.signRequest(httpReq,payload)resp,err:=p.client.Do(httpReq)iferr!=nil{returnnil,fmt.Errorf("bedrockrequestfailed:%w",err)}deferresp.Body.Close()ifresp.StatusCode!=http.StatusOK{respBody,_:=io.ReadAll(resp.Body)returnnil,fmt.Errorf("bedrockreturnedstatus%d:%s",resp.StatusCode,string(respBody))}varbrRespbedrockResponseiferr:=json.NewDecoder(resp.Body).Decode(&brResp);err!=nil{returnnil,fmt.Errorf("decodebedrockresponse:%w",err)}returnp.toOpenAIResponse(&brResp,modelID),nil}func(p*BedrockProvider)ChatCompletionStream(ctxcontext.Context,req*ChatRequest)(Stream,error){modelID:=req.Modelbody:=p.buildInvokeBody(req)payload,err:=json.Marshal(body)iferr!=nil{returnnil,fmt.Errorf("marshalbedrockrequest:%w",err)}endpoint:=fmt.Sprintf("%s/model/%s/invoke-with-response-stream",p.config.BaseURL,modelID)httpReq,err:=http.NewRequestWithContext(ctx,http.MethodPost,endpoint,bytes.NewReader(payload))iferr!=nil{returnnil,fmt.Errorf("createrequest:%w",err)}p.signRequest(httpReq,payload)resp,err:=p.client.Do(httpReq)iferr!=nil{returnnil,fmt.Errorf("bedrockstreamrequestfailed:%w",err)}ifresp.StatusCode!=http.StatusOK{respBody,_:=io.ReadAll(resp.Body)resp.Body.Close()returnnil,fmt.Errorf("bedrockreturnedstatus%d:%s",resp.StatusCode,string(respBody))}returnNewHTTPStream(resp),nil}func(p*BedrockProvider)Embeddings(ctxcontext.Context,req*EmbeddingsRequest)(*EmbeddingsResponse,error){texts:=inputToStrings(req.Input)modelID:=req.Model//BedrockTitanembeddings:onetextatatimevarallData[]EmbeddingDatatotalTokens:=0fori,text:=rangetexts{embedBody:=map[string]interface{}{"inputText":text,}payload,err:=json.Marshal(embedBody)iferr!=nil{returnnil,fmt.Errorf("marshalbedrockembedrequest:%w",err)}endpoint:=fmt.Sprintf("%s/model/%s/invoke",p.config.BaseURL,modelID)httpReq,err:=http.NewRequestWithContext(ctx,http.MethodPost,endpoint,bytes.NewReader(payload))iferr!=nil{returnnil,fmt.Errorf("createrequest:%w",err)}p.signRequest(httpReq,payload)resp,err:=p.client.Do(httpReq)iferr!=nil{returnnil,fmt.Errorf("bedrockembedrequestfailed:%w",err)}ifresp.StatusCode!=http.StatusOK{respBody,_:=io.ReadAll(resp.Body)resp.Body.Close()returnnil,fmt.Errorf("bedrockreturnedstatus%d:%s",resp.StatusCode,string(respBody))}varembedRespstruct{Embedding[]float64`json:"embedding"`InputTextTokenCountint`json:"inputTextTokenCount"`}iferr:=json.NewDecoder(resp.Body).Decode(&embedResp);err!=nil{resp.Body.Close()returnnil,fmt.Errorf("decodebedrockembedresponse:%w",err)}resp.Body.Close()allData=append(allData,EmbeddingData{Object:"embedding",Embedding:embedResp.Embedding,Index:i,})totalTokens+=embedResp.InputTextTokenCount}return&EmbeddingsResponse{Object:"list",Data:allData,Model:modelID,Usage:EmbeddingsUsage{PromptTokens:totalTokens,TotalTokens:totalTokens,},},nil}func(p*BedrockProvider)HealthCheck(ctxcontext.Context)HealthStatus{start:=time.Now()//Listfoundationmodelstoverifyconnectivityendpoint:=strings.Replace(p.config.BaseURL,"bedrock-runtime","bedrock",1)+"/foundation-models"httpReq,err:=http.NewRequestWithContext(ctx,http.MethodGet,endpoint,nil)iferr!=nil{returnHealthStatus{Healthy:false,Error:err.Error(),LastCheck:time.Now()}}p.signRequest(httpReq,nil)resp,err:=p.client.Do(httpReq)latency:=time.Since(start)iferr!=nil{returnHealthStatus{Healthy:false,Latency:latency,Error:err.Error(),LastCheck:time.Now()}}deferresp.Body.Close()healthy:=resp.StatusCode==http.StatusOKerrMsg:=""if!healthy{errMsg=fmt.Sprintf("status%d",resp.StatusCode)}returnHealthStatus{Healthy:healthy,Latency:latency,LastCheck:time.Now(),Error:errMsg}}//───Helpers────────────────────────────────────────────────func(p*BedrockProvider)buildInvokeBody(req*ChatRequest)bedrockInvokeBody{varmessages[]bedrockMessagevarsystemstringfor_,msg:=rangereq.Messages{content:=""switchv:=msg.Content.(type){casestring:content=vdefault:b,_:=json.Marshal(v)content=string(b)}ifmsg.Role=="system"{system=contentcontinue}messages=append(messages,bedrockMessage{Role:msg.Role,Content:content,})}maxTokens:=4096ifreq.MaxTokens!=nil{maxTokens=*req.MaxTokens}returnbedrockInvokeBody{Messages:messages,System:system,MaxTokens:maxTokens,Temperature:req.Temperature,TopP:req.TopP,StopSequences:req.Stop,AnthropicVersion:"bedrock-2023-05-31",}}func(p*BedrockProvider)toOpenAIResponse(brResp*bedrockResponse,modelstring)*ChatResponse{text:=""for_,block:=rangebrResp.Content{ifblock.Type=="text"{text+=block.Text}}usage:=Usage{}ifbrResp.Usage!=nil{usage.PromptTokens=brResp.Usage.InputTokensusage.CompletionTokens=brResp.Usage.OutputTokensusage.TotalTokens=brResp.Usage.InputTokens+brResp.Usage.OutputTokens}finishReason:="stop"ifbrResp.Stop=="max_tokens"{finishReason="length"}return&ChatResponse{ID:brResp.ID,Object:"chat.completion",Created:time.Now().Unix(),Model:model,Choices:[]Choice{{Index:0,Message:ChatMessage{Role:"assistant",Content:text,},FinishReason:finishReason,},},Usage:usage,}}//signRequestappliesAWSSignatureV4totheHTTPrequest.//ThisisasimplifiedimplementationforBedrock.func(p*BedrockProvider)signRequest(req*http.Request,payload[]byte){now:=time.Now().UTC()dateStamp:=now.Format("20060102")amzDate:=now.Format("20060102T150405Z")req.Header.Set("Content-Type","application/json")req.Header.Set("X-Amz-Date",amzDate)iflen(payload)==0{payload=[]byte{}}//CanonicalrequestcomponentspayloadHash:=sha256Hex(payload)req.Header.Set("X-Amz-Content-Sha256",payloadHash)service:="bedrock"ifstrings.Contains(req.URL.Host,"bedrock-runtime"){service="bedrock-runtime"}credentialScope:=fmt.Sprintf("%s/%s/%s/aws4_request",dateStamp,p.region,service)signedHeaders:="content-type;host;x-amz-content-sha256;x-amz-date"canonicalHeaders:=fmt.Sprintf("content-type:%s\nhost:%s\nx-amz-content-sha256:%s\nx-amz-date:%s\n",req.Header.Get("Content-Type"),req.URL.Host,payloadHash,amzDate,)canonicalRequest:=fmt.Sprintf("%s\n%s\n%s\n%s\n%s\n%s",req.Method,req.URL.Path,req.URL.RawQuery,canonicalHeaders,signedHeaders,payloadHash,)stringToSign:=fmt.Sprintf("AWS4-HMAC-SHA256\n%s\n%s\n%s",amzDate,credentialScope,sha256Hex([]byte(canonicalRequest)),)//DerivesigningkeykDate:=hmacSHA256([]byte("AWS4"+p.secretKey),[]byte(dateStamp))kRegion:=hmacSHA256(kDate,[]byte(p.region))kService:=hmacSHA256(kRegion,[]byte(service))kSigning:=hmacSHA256(kService,[]byte("aws4_request"))signature:=hex.EncodeToString(hmacSHA256(kSigning,[]byte(stringToSign)))authHeader:=fmt.Sprintf("AWS4-HMAC-SHA256Credential=%s/%s,SignedHeaders=%s,Signature=%s",p.accessKey,credentialScope,signedHeaders,signature,)req.Header.Set("Authorization",authHeader)}funcsha256Hex(data[]byte)string{h:=sha256.Sum256(data)returnhex.EncodeToString(h[:])}funchmacSHA256(key,data[]byte)[]byte{h:=hmac.New(sha256.New,key)h.Write(data)returnh.Sum(nil)}