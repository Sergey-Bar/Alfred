packageproviderimport("encoding/json""fmt")//---AnthropicToolTypes---//AnthropicToolrepresentsatooldefinitioninAnthropic'sformat.typeAnthropicToolstruct{Namestring`json:"name"`Descriptionstring`json:"description,omitempty"`InputSchemajson.RawMessage`json:"input_schema"`}//AnthropicToolChoicerepresentsAnthropic'stool_choiceparameter.typeAnthropicToolChoicestruct{Typestring`json:"type"`//"auto","any","tool"Namestring`json:"name,omitempty"`//onlywhentype="tool"}//AnthropicContentBlockrepresentsacontentblockinAnthropicresponses.typeAnthropicContentBlockstruct{Typestring`json:"type"`//"text","tool_use"Textstring`json:"text,omitempty"`//fortype="text"IDstring`json:"id,omitempty"`//fortype="tool_use"Namestring`json:"name,omitempty"`//fortype="tool_use"Inputjson.RawMessage`json:"input,omitempty"`//fortype="tool_use"}//AnthropicToolResultrepresentsatool_resultcontentblockforAnthropic.typeAnthropicToolResultstruct{Typestring`json:"type"`//"tool_result"ToolUseIDstring`json:"tool_use_id"`Contentstring`json:"content"`}//---GeminiToolTypes---//GeminiToolrepresentsatool(functiondeclaration)inGemini'sformat.typeGeminiToolstruct{FunctionDeclarations[]GeminiFunctionDeclaration`json:"function_declarations"`}//GeminiFunctionDeclarationrepresentsafunctiondeclarationinGemini'sformat.typeGeminiFunctionDeclarationstruct{Namestring`json:"name"`Descriptionstring`json:"description"`Parametersjson.RawMessage`json:"parameters"`//JSONSchemasubset}//GeminiFunctionCallrepresentsafunctioncallinGeminiresponses.typeGeminiFunctionCallstruct{Namestring`json:"name"`Argsjson.RawMessage`json:"args"`}//GeminiFunctionResponserepresentsafunctionresponsetosendback.typeGeminiFunctionResponsestruct{Namestring`json:"name"`Responsejson.RawMessage`json:"response"`}//---ConversionFunctions---//ConvertToolsToAnthropicconvertsOpenAItooldefinitionstoAnthropicformat.funcConvertToolsToAnthropic(tools[]Tool)[]AnthropicTool{iflen(tools)==0{returnnil}result:=make([]AnthropicTool,0,len(tools))for_,t:=rangetools{ift.Type!="function"{continue}result=append(result,AnthropicTool{Name:t.Function.Name,Description:t.Function.Description,InputSchema:t.Function.Parameters,})}returnresult}//ConvertToolChoiceToAnthropicconvertsOpenAItool_choicetoAnthropicformat.funcConvertToolChoiceToAnthropic(toolChoiceinterface{})*AnthropicToolChoice{iftoolChoice==nil{returnnil}switchv:=toolChoice.(type){casestring:switchv{case"auto":return&AnthropicToolChoice{Type:"auto"}case"none":returnnil//Anthropicdoesn'thave"none"â€”omittoolscase"required":return&AnthropicToolChoice{Type:"any"}default:return&AnthropicToolChoice{Type:"auto"}}casemap[string]interface{}://OpenAIformat:{"type":"function","function":{"name":"fn_name"}}iffn,ok:=v["function"].(map[string]interface{});ok{ifname,ok:=fn["name"].(string);ok{return&AnthropicToolChoice{Type:"tool",Name:name}}}}return&AnthropicToolChoice{Type:"auto"}}//ConvertAnthropicToolCallsToOpenAIconvertsAnthropictool_usecontentblocks//toOpenAI-formattoolcalls.funcConvertAnthropicToolCallsToOpenAI(contentBlocks[]AnthropicContentBlock)(string,[]ToolCall){vartextContentstringvartoolCalls[]ToolCallfor_,block:=rangecontentBlocks{switchblock.Type{case"text":textContent+=block.Textcase"tool_use":args,_:=json.Marshal(block.Input)toolCalls=append(toolCalls,ToolCall{ID:block.ID,Type:"function",Function:FunctionCall{Name:block.Name,Arguments:string(args),},})}}returntextContent,toolCalls}//ConvertToolResultToAnthropicMessageconvertsanOpenAI-formattoolresponse//messagetoAnthropic'stool_resultcontentblockformat.funcConvertToolResultToAnthropicMessage(msgChatMessage)map[string]interface{}{content:=""ifc,ok:=msg.Content.(string);ok{content=c}returnmap[string]interface{}{"role":"user","content":[]map[string]interface{}{{"type":"tool_result","tool_use_id":msg.ToolCallID,"content":content,},},}}//ConvertToolsToGeminiconvertsOpenAItooldefinitionstoGeminiformat.funcConvertToolsToGemini(tools[]Tool)[]GeminiTool{iflen(tools)==0{returnnil}declarations:=make([]GeminiFunctionDeclaration,0,len(tools))for_,t:=rangetools{ift.Type!="function"{continue}declarations=append(declarations,GeminiFunctionDeclaration{Name:t.Function.Name,Description:t.Function.Description,Parameters:t.Function.Parameters,})}return[]GeminiTool{{FunctionDeclarations:declarations}}}//ConvertGeminiFunctionCallToOpenAIconvertsaGeminifunctioncalltoOpenAIformat.funcConvertGeminiFunctionCallToOpenAI(fcGeminiFunctionCall,callIDstring)ToolCall{args,_:=json.Marshal(fc.Args)returnToolCall{ID:callID,Type:"function",Function:FunctionCall{Name:fc.Name,Arguments:string(args),},}}//HasToolCallschecksifaChatRequestcontainstooldefinitions.funcHasToolCalls(req*ChatRequest)bool{returnlen(req.Tools)>0}//HasToolMessageschecksifanymessagesintherequestaretoolresponses.funcHasToolMessages(req*ChatRequest)bool{for_,msg:=rangereq.Messages{ifmsg.Role=="tool"||msg.ToolCallID!=""{returntrue}}returnfalse}//ValidateToolDefinitionschecksthattooldefinitionsarewell-formed.funcValidateToolDefinitions(tools[]Tool)error{seen:=make(map[string]bool)fori,t:=rangetools{ift.Type!="function"{returnfmt.Errorf("tool[%d]:unsupportedtype%q(only'function'issupported)",i,t.Type)}ift.Function.Name==""{returnfmt.Errorf("tool[%d]:functionnameisrequired",i)}ifseen[t.Function.Name]{returnfmt.Errorf("tool[%d]:duplicatefunctionname%q",i,t.Function.Name)}seen[t.Function.Name]=true//ValidateparametersisvalidJSONifpresent.iflen(t.Function.Parameters)>0{varjsjson.RawMessageiferr:=json.Unmarshal(t.Function.Parameters,&js);err!=nil{returnfmt.Errorf("tool[%d]%q:parametersisnotvalidJSON:%w",i,t.Function.Name,err)}}}returnnil}