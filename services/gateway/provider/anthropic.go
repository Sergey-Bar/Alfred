packageproviderimport("bytes""context""encoding/json""fmt""io""net/http""time")const(anthropicBaseURL="https://api.anthropic.com/v1"anthropicVersion="2023-06-01")//AnthropicProviderimplementstheProviderinterfaceforAnthropic.typeAnthropicProviderstruct{configProviderConfigclient*http.Client}//anthropicRequestrepresentsanAnthropicMessagesAPIrequest.typeanthropicRequeststruct{Modelstring`json:"model"`MaxTokensint`json:"max_tokens"`Messages[]anthropicMessage`json:"messages"`Systemstring`json:"system,omitempty"`Temperature*float64`json:"temperature,omitempty"`TopP*float64`json:"top_p,omitempty"`Streambool`json:"stream,omitempty"`StopSeqs[]string`json:"stop_sequences,omitempty"`Tools[]AnthropicTool`json:"tools,omitempty"`ToolChoice*AnthropicToolChoice`json:"tool_choice,omitempty"`}typeanthropicMessagestruct{Rolestring`json:"role"`Contentinterface{}`json:"content"`//stringor[]AnthropicContentBlock}//anthropicResponserepresentsanAnthropicMessagesAPIresponse.typeanthropicResponsestruct{IDstring`json:"id"`Typestring`json:"type"`Rolestring`json:"role"`Modelstring`json:"model"`Content[]struct{Typestring`json:"type"`//"text"or"tool_use"Textstring`json:"text,omitempty"`//fortype="text"IDstring`json:"id,omitempty"`//fortype="tool_use"Namestring`json:"name,omitempty"`//fortype="tool_use"Inputjson.RawMessage`json:"input,omitempty"`//fortype="tool_use"}`json:"content"`StopReasonstring`json:"stop_reason"`Usagestruct{InputTokensint`json:"input_tokens"`OutputTokensint`json:"output_tokens"`}`json:"usage"`}//NewAnthropicProvidercreatesanewAnthropicproviderconnector.funcNewAnthropicProvider(cfgProviderConfig)*AnthropicProvider{ifcfg.BaseURL==""{cfg.BaseURL=anthropicBaseURL}ifcfg.Timeout==0{cfg.Timeout=120*time.Second}transport:=&http.Transport{MaxIdleConns:50,MaxIdleConnsPerHost:10,IdleConnTimeout:90*time.Second,}return&AnthropicProvider{config:cfg,client:&http.Client{Transport:transport,Timeout:cfg.Timeout,},}}func(p*AnthropicProvider)Name()string{return"anthropic"}func(p*AnthropicProvider)Models()[]string{iflen(p.config.Models)>0{returnp.config.Models}return[]string{"claude-3-opus-20240229","claude-3-sonnet-20240229","claude-3-haiku-20240307","claude-3-5-sonnet-20241022",}}func(p*AnthropicProvider)ChatCompletion(ctxcontext.Context,req*ChatRequest)(*ChatResponse,error){aReq:=p.convertRequest(req)aReq.Stream=falsebody,err:=json.Marshal(aReq)iferr!=nil{returnnil,fmt.Errorf("marshalrequest:%w",err)}httpReq,err:=http.NewRequestWithContext(ctx,http.MethodPost,p.config.BaseURL+"/messages",bytes.NewReader(body))iferr!=nil{returnnil,fmt.Errorf("createrequest:%w",err)}p.setHeaders(httpReq)resp,err:=p.client.Do(httpReq)iferr!=nil{returnnil,fmt.Errorf("anthropicrequestfailed:%w",err)}deferresp.Body.Close()ifresp.StatusCode!=http.StatusOK{respBody,_:=io.ReadAll(resp.Body)returnnil,fmt.Errorf("anthropicreturnedstatus%d:%s",resp.StatusCode,string(respBody))}varaRespanthropicResponseiferr:=json.NewDecoder(resp.Body).Decode(&aResp);err!=nil{returnnil,fmt.Errorf("decoderesponse:%w",err)}returnp.convertResponse(&aResp),nil}func(p*AnthropicProvider)ChatCompletionStream(ctxcontext.Context,req*ChatRequest)(Stream,error){aReq:=p.convertRequest(req)aReq.Stream=truebody,err:=json.Marshal(aReq)iferr!=nil{returnnil,fmt.Errorf("marshalrequest:%w",err)}httpReq,err:=http.NewRequestWithContext(ctx,http.MethodPost,p.config.BaseURL+"/messages",bytes.NewReader(body))iferr!=nil{returnnil,fmt.Errorf("createrequest:%w",err)}p.setHeaders(httpReq)resp,err:=p.client.Do(httpReq)iferr!=nil{returnnil,fmt.Errorf("anthropicstreamrequestfailed:%w",err)}ifresp.StatusCode!=http.StatusOK{respBody,_:=io.ReadAll(resp.Body)resp.Body.Close()returnnil,fmt.Errorf("anthropicreturnedstatus%d:%s",resp.StatusCode,string(respBody))}returnNewHTTPStream(resp),nil}func(p*AnthropicProvider)Embeddings(ctxcontext.Context,req*EmbeddingsRequest)(*EmbeddingsResponse,error){returnnil,fmt.Errorf("anthropicdoesnotsupportembeddings")}func(p*AnthropicProvider)HealthCheck(ctxcontext.Context)HealthStatus{start:=time.Now()//Anthropicdoesn'thaveamodelsendpointâ€”useaminimalrequesthttpReq,err:=http.NewRequestWithContext(ctx,http.MethodGet,p.config.BaseURL+"/models",nil)iferr!=nil{returnHealthStatus{Healthy:false,Error:err.Error(),LastCheck:time.Now()}}p.setHeaders(httpReq)resp,err:=p.client.Do(httpReq)latency:=time.Since(start)iferr!=nil{returnHealthStatus{Healthy:false,Latency:latency,Error:err.Error(),LastCheck:time.Now()}}deferresp.Body.Close()//Anynon-5xxresponseindicatestheserviceisreachablehealthy:=resp.StatusCode<500errMsg:=""if!healthy{errMsg=fmt.Sprintf("status%d",resp.StatusCode)}returnHealthStatus{Healthy:healthy,Latency:latency,LastCheck:time.Now(),Error:errMsg}}func(p*AnthropicProvider)convertRequest(req*ChatRequest)*anthropicRequest{aReq:=&anthropicRequest{Model:req.Model,MaxTokens:1024,Temperature:req.Temperature,TopP:req.TopP,StopSeqs:req.Stop,}ifreq.MaxTokens!=nil{aReq.MaxTokens=*req.MaxTokens}//Converttoolsifpresent(T017functioncallingpass-through).iflen(req.Tools)>0{aReq.Tools=ConvertToolsToAnthropic(req.Tools)aReq.ToolChoice=ConvertToolChoiceToAnthropic(req.ToolChoice)}for_,msg:=rangereq.Messages{ifmsg.Role=="system"{ifcontent,ok:=msg.Content.(string);ok{aReq.System=content}continue}//Handletoolresultmessages(role="tool"inOpenAIformat).ifmsg.Role=="tool"&&msg.ToolCallID!=""{content:=""ifc,ok:=msg.Content.(string);ok{content=c}aReq.Messages=append(aReq.Messages,anthropicMessage{Role:"user",Content:[]map[string]interface{}{{"type":"tool_result","tool_use_id":msg.ToolCallID,"content":content,},},})continue}//Handleassistantmessageswithtoolcalls.ifmsg.Role=="assistant"&&len(msg.ToolCalls)>0{blocks:=make([]map[string]interface{},0,len(msg.ToolCalls)+1)ifcontent,ok:=msg.Content.(string);ok&&content!=""{blocks=append(blocks,map[string]interface{}{"type":"text","text":content,})}for_,tc:=rangemsg.ToolCalls{varinputjson.RawMessage_=json.Unmarshal([]byte(tc.Function.Arguments),&input)blocks=append(blocks,map[string]interface{}{"type":"tool_use","id":tc.ID,"name":tc.Function.Name,"input":input,})}aReq.Messages=append(aReq.Messages,anthropicMessage{Role:"assistant",Content:blocks,})continue}//Standardtextmessages.content:=""ifc,ok:=msg.Content.(string);ok{content=c}aReq.Messages=append(aReq.Messages,anthropicMessage{Role:msg.Role,Content:content,})}returnaReq}func(p*AnthropicProvider)convertResponse(aResp*anthropicResponse)*ChatResponse{//Parsecontentblocksforbothtextandtool_use.vartextContentstringvartoolCalls[]ToolCallfor_,block:=rangeaResp.Content{switchblock.Type{case"text":textContent+=block.Textcase"tool_use":args,_:=json.Marshal(block.Input)toolCalls=append(toolCalls,ToolCall{ID:block.ID,Type:"function",Function:FunctionCall{Name:block.Name,Arguments:string(args),},})}}finishReason:=mapStopReason(aResp.StopReason)iflen(toolCalls)>0&&aResp.StopReason=="tool_use"{finishReason="tool_calls"}return&ChatResponse{ID:aResp.ID,Object:"chat.completion",Created:time.Now().Unix(),Model:aResp.Model,Choices:[]Choice{{Index:0,Message:ChatMessage{Role:"assistant",Content:textContent,ToolCalls:toolCalls,},FinishReason:finishReason,},},Usage:Usage{PromptTokens:aResp.Usage.InputTokens,CompletionTokens:aResp.Usage.OutputTokens,TotalTokens:aResp.Usage.InputTokens+aResp.Usage.OutputTokens,},}}funcmapStopReason(reasonstring)string{switchreason{case"end_turn":return"stop"case"max_tokens":return"length"case"stop_sequence":return"stop"default:returnreason}}func(p*AnthropicProvider)setHeaders(req*http.Request){req.Header.Set("Content-Type","application/json")req.Header.Set("x-api-key",p.config.APIKey)req.Header.Set("anthropic-version",anthropicVersion)fork,v:=rangep.config.Headers{req.Header.Set(k,v)}}