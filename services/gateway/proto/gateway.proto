//──────────────────────────────────────────────────────────────//Model:ClaudeOpus4.6//Tier:L3//Logic:ProtobufservicedefinitionsforAlfredgatewayinternal//communication.Definesserver-sidestreamingRPCsfor//chatcompletions,embeddings,andmeteringevents.//RootCause:SprinttaskT207—gRPCstreamingoptimization.//Context:ReplacesJSONserializationwithbinaryProtobuffor//internalservice-to-servicecalls.~10xlowerlatency//and~3xsmallerpayloadsvsJSON.//Suitability:L3—protocoldesignwithstreamingsemantics.//──────────────────────────────────────────────────────────────syntax="proto3";packagealfred.gateway.v1;optiongo_package="github.com/AlfredDev/alfred/services/gateway/pb";//───ChatCompletionService─────────────────────────────────//GatewayServiceprovidesthecoreAIproxyRPCs.serviceGatewayService{//ChatCompletionperformsaunarychatcompletionrequest.rpcChatCompletion(ChatRequest)returns(ChatResponse);//ChatCompletionStreamperformsaserver-sidestreamingchatcompletion.//EachStreamChunkcontainsadeltaoftheresponse.rpcChatCompletionStream(ChatRequest)returns(streamStreamChunk);//Embeddingsgeneratesvectorembeddingsforinputtext.rpcEmbeddings(EmbeddingsRequest)returns(EmbeddingsResponse);//HealthCheckreturnsthehealthstatusofaprovider.rpcHealthCheck(HealthCheckRequest)returns(HealthCheckResponse);}//───MeteringService────────────────────────────────────────//MeteringServicehandlestokencountingandcosttracking.serviceMeteringService{//RecordUsagerecordstokenusageforacompletedrequest.rpcRecordUsage(UsageEvent)returns(UsageAck);//StreamUsageacceptsastreamofchunk-levelusageevents//duringastreamingrequestandreturnsasummary.rpcStreamUsage(streamChunkUsage)returns(UsageSummary);//EstimateCostreturnsestimatedcostbeforeexecution.rpcEstimateCost(CostEstimateRequest)returns(CostEstimateResponse);}//───WalletService──────────────────────────────────────────//WalletServicehandlescreditreservationandsettlement.serviceWalletService{//Reserveplacesaholdoncreditsbeforerequestexecution.rpcReserve(ReservationRequest)returns(ReservationResponse);//Settlefinalizesareservationwithactualusage.rpcSettle(SettlementRequest)returns(SettlementResponse);//Refundreleasesreservedcreditsonprovidererror.rpcRefund(RefundRequest)returns(RefundResponse);}//───MessageTypes───────────────────────────────────────────messageChatMessage{stringrole=1;stringcontent=2;stringname=3;repeatedToolCalltool_calls=4;}messageToolCall{stringid=1;stringtype=2;FunctionCallfunction=3;}messageFunctionCall{stringname=1;stringarguments=2;}messageChatRequest{stringrequest_id=1;stringmodel=2;repeatedChatMessagemessages=3;doubletemperature=4;int32max_tokens=5;doubletop_p=6;boolstream=7;stringuser=8;int64timestamp_ns=9;}messageChatResponse{stringid=1;stringobject=2;int64created=3;stringmodel=4;repeatedChoicechoices=5;TokenUsageusage=6;stringprovider=7;int64latency_ms=8;}messageChoice{int32index=1;ChatMessagemessage=2;stringfinish_reason=3;}messageStreamChunk{stringid=1;stringobject=2;int64created=3;stringmodel=4;repeatedStreamChoicechoices=5;int32chunk_index=6;}messageStreamChoice{int32index=1;ChatMessagedelta=2;stringfinish_reason=3;}messageTokenUsage{int32prompt_tokens=1;int32completion_tokens=2;int32total_tokens=3;}//───Embeddings──────────────────────────────────────────────messageEmbeddingsRequest{stringmodel=1;repeatedstringinput=2;stringuser=3;stringrequest_id=4;}messageEmbeddingsResponse{stringobject=1;repeatedEmbeddingDatadata=2;stringmodel=3;TokenUsageusage=4;}messageEmbeddingData{stringobject=1;repeatedfloatembedding=2;int32index=3;}//───Health──────────────────────────────────────────────────messageHealthCheckRequest{stringprovider=1;}messageHealthCheckResponse{map<string,ProviderHealth>providers=1;}messageProviderHealth{boolhealthy=1;int64latency_ms=2;int64last_check_unix=3;stringerror=4;}//───MeteringMessages──────────────────────────────────────messageUsageEvent{stringrequest_id=1;stringprovider=2;stringmodel=3;int32prompt_tokens=4;int32completion_tokens=5;int64latency_ms=6;int64cost_microdollars=7;boolcached=8;stringuser_id=9;stringteam_id=10;int64timestamp_ns=11;}messageUsageAck{boolok=1;stringerror=2;}messageChunkUsage{stringrequest_id=1;int32chunk_index=2;int32estimated_tokens=3;int64timestamp_ns=4;}messageUsageSummary{stringrequest_id=1;int32total_chunks=2;int32estimated_output_tokens=3;int64duration_ms=4;int64cost_microdollars=5;}messageCostEstimateRequest{stringmodel=1;int32input_tokens=2;int32output_tokens=3;}messageCostEstimateResponse{stringmodel=1;int64estimated_cost_microdollars=2;doubleinput_cost_per_1k=3;doubleoutput_cost_per_1k=4;}//───WalletMessages─────────────────────────────────────────messageReservationRequest{stringuser_id=1;stringteam_id=2;int64amount_microdollars=3;stringrequest_id=4;stringmodel=5;}messageReservationResponse{stringreservation_id=1;boolapproved=2;stringreason=3;int64remaining_balance=4;}messageSettlementRequest{stringreservation_id=1;int64actual_cost_microdollars=2;stringrequest_id=3;}messageSettlementResponse{boolok=1;int64refunded_microdollars=2;}messageRefundRequest{stringreservation_id=1;stringreason=2;}messageRefundResponse{boolok=1;int64refunded_microdollars=2;}