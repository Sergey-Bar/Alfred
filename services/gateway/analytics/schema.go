packageanalytics//───ClickHouseSchemaSQL──────────────────────────────────//RequestLogSchemaistheDDLforthemainrequestlogtable.//CaptureseveryLLMrequestprocessedbythegateway.constRequestLogSchema=`CREATETABLEIFNOTEXISTSrequest_log(--identityrequest_idString,trace_idString,org_idString,team_idString,user_idString,api_key_hashString,--requestmetadatamodelString,providerString,endpointString,--/v1/chat/completions,/v1/embeddingsmethodString,--POST,GET--tokensprompt_tokensUInt32,completion_tokensUInt32,total_tokensUInt32,--cost(inmicrodollars:$0.01=10000)cost_microdollarsInt64,currencyStringDEFAULT'USD',--performancelatency_msUInt32,ttfb_msUInt32,--timetofirstbyte(streaming)provider_latency_msUInt32,--upstreamproviderlatency--statusstatus_codeUInt16,error_typeString,is_cachedUInt8,--1=cachehit,0=misscache_similarityFloat32,--routingrouting_rule_idString,was_failoverUInt8,--safetysafety_blockedUInt8,safety_violationsUInt16,--timestampscreated_atDateTime64(3)DEFAULTnow64(3),event_dateDateDEFAULTtoDate(created_at))ENGINE=MergeTree()PARTITIONBYtoYYYYMM(event_date)ORDERBY(org_id,team_id,created_at,request_id)TTLevent_date+INTERVAL365DAYSETTINGSindex_granularity=8192;`//CostEventSchematrackscredit/costeventsforFinOpsreporting.constCostEventSchema=`CREATETABLEIFNOTEXISTScost_events(event_idString,org_idString,team_idString,user_idString,wallet_idString,--costbreakdownmodelString,providerString,prompt_tokensUInt32,completion_tokensUInt32,cost_microdollarsInt64,--walletimpactbalance_beforeInt64,balance_afterInt64,wallet_typeString,--user,team,org--metadatarequest_idString,event_typeString,--deduction,refund,topup,transferdescriptionString,created_atDateTime64(3)DEFAULTnow64(3),event_dateDateDEFAULTtoDate(created_at))ENGINE=MergeTree()PARTITIONBYtoYYYYMM(event_date)ORDERBY(org_id,team_id,wallet_id,created_at)TTLevent_date+INTERVAL730DAYSETTINGSindex_granularity=8192;`//WalletEventSchematrackswalletlifecycleevents.constWalletEventSchema=`CREATETABLEIFNOTEXISTSwallet_events(event_idString,wallet_idString,org_idString,team_idString,user_idString,event_typeString,--created,limit_changed,reset,suspended,activatedold_valueString,new_valueString,actor_idString,--whomadethechangeactor_typeString,--admin,system,croncreated_atDateTime64(3)DEFAULTnow64(3),event_dateDateDEFAULTtoDate(created_at))ENGINE=MergeTree()PARTITIONBYtoYYYYMM(event_date)ORDERBY(org_id,wallet_id,created_at)TTLevent_date+INTERVAL730DAYSETTINGSindex_granularity=8192;`//───MaterializedViews(T121)──────────────────────────────//DailyCostMVaggregatescostbyorg/team/modelperday.constDailyCostMV=`CREATEMATERIALIZEDVIEWIFNOTEXISTSdaily_cost_mvENGINE=SummingMergeTree()PARTITIONBYtoYYYYMM(event_date)ORDERBY(org_id,team_id,model,event_date)ASSELECTorg_id,team_id,model,provider,toDate(created_at)ASevent_date,count()ASrequest_count,sum(prompt_tokens)AStotal_prompt_tokens,sum(completion_tokens)AStotal_completion_tokens,sum(total_tokens)AStotal_tokens,sum(cost_microdollars)AStotal_cost_microdollars,sum(latency_ms)ASsum_latency_ms,sum(is_cached)AScache_hitsFROMrequest_logGROUPBYorg_id,team_id,model,provider,event_date;`//HourlyCostMVprovidesfiner-grainedcostvisibility.constHourlyCostMV=`CREATEMATERIALIZEDVIEWIFNOTEXISTShourly_cost_mvENGINE=SummingMergeTree()PARTITIONBYtoYYYYMM(event_date)ORDERBY(org_id,team_id,event_hour)ASSELECTorg_id,team_id,toStartOfHour(created_at)ASevent_hour,toDate(created_at)ASevent_date,count()ASrequest_count,sum(total_tokens)AStotal_tokens,sum(cost_microdollars)AStotal_cost_microdollars,sum(is_cached)AScache_hitsFROMrequest_logGROUPBYorg_id,team_id,event_hour,event_date;`//AllSchemasreturnsallDDLstatementsincreationorder.funcAllSchemas()[]string{return[]string{RequestLogSchema,CostEventSchema,WalletEventSchema,DailyCostMV,HourlyCostMV,}}