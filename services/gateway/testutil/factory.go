packagetestutilimport("bytes""encoding/json""fmt""net/http""net/http/httptest""time")//───ChatRequests────────────────────────────────────────//ChatRequestOptionconfiguresachatrequest.typeChatRequestOptionfunc(map[string]interface{})//WithModelsetsthemodelfield.funcWithModel(modelstring)ChatRequestOption{returnfunc(mmap[string]interface{}){m["model"]=model}}//WithMessagessetsthemessagesfield.funcWithMessages(messages[]map[string]interface{})ChatRequestOption{returnfunc(mmap[string]interface{}){m["messages"]=messages}}//WithStreamenablesordisablesstreaming.funcWithStream(streambool)ChatRequestOption{returnfunc(mmap[string]interface{}){m["stream"]=stream}}//WithMaxTokenssetsthemax_tokensfield.funcWithMaxTokens(nint)ChatRequestOption{returnfunc(mmap[string]interface{}){m["max_tokens"]=n}}//WithTemperaturesetsthetemperaturefield.funcWithTemperature(tfloat64)ChatRequestOption{returnfunc(mmap[string]interface{}){m["temperature"]=t}}//WithToolsaddstooldefinitionstotherequest.funcWithTools(tools[]map[string]interface{})ChatRequestOption{returnfunc(mmap[string]interface{}){m["tools"]=tools}}//ChatRequestcreatesarealisticOpenAI-compatiblechatrequestbody.funcChatRequest(opts...ChatRequestOption)map[string]interface{}{req:=map[string]interface{}{"model":"gpt-4o","messages":[]map[string]interface{}{{"role":"system","content":"Youareahelpfulassistant."},{"role":"user","content":"WhatisthecapitalofFrance?"},},"temperature":0.7,"max_tokens":256,"stream":false,}for_,opt:=rangeopts{opt(req)}returnreq}//StreamingChatRequestcreatesastreamingchatrequest.funcStreamingChatRequest(opts...ChatRequestOption)map[string]interface{}{returnChatRequest(append([]ChatRequestOption{WithStream(true)},opts...)...)}//MultiTurnRequestcreatesamulti-turnconversationrequest.funcMultiTurnRequest(turnsint,opts...ChatRequestOption)map[string]interface{}{userMsgs:=[]string{"HowdoIcreateaRESTAPIinPython?","Canyouaddauthenticationtoit?","Howaboutratelimiting?","Nowaddtestsforeverything.",}assistantMsgs:=[]string{"YoucanuseFastAPI...","Forauth,IrecommendJWTtokens...","Youcanuseslowapi...","Here'sapytestsetup...",}messages:=[]map[string]interface{}{{"role":"system","content":"Youareahelpfulcodingassistant."},}fori:=0;i<turns&&i<len(userMsgs);i++{messages=append(messages,map[string]interface{}{"role":"user","content":userMsgs[i],})ifi<turns-1&&i<len(assistantMsgs){messages=append(messages,map[string]interface{}{"role":"assistant","content":assistantMsgs[i],})}}returnChatRequest(append([]ChatRequestOption{WithMessages(messages)},opts...)...)}//───EmbeddingRequests───────────────────────────────────//EmbeddingRequestcreatesanOpenAI-compatibleembeddingsrequest.funcEmbeddingRequest(opts...ChatRequestOption)map[string]interface{}{req:=map[string]interface{}{"model":"text-embedding-ada-002","input":"AlfredisanenterpriseAIcreditgovernanceplatform.",}for_,opt:=rangeopts{opt(req)}returnreq}//───ChatResponses(forprovidermocks)──────────────────//ChatResponsecreatesarealisticchatcompletionresponse.funcChatResponse(contentstring)map[string]interface{}{returnmap[string]interface{}{"id":fmt.Sprintf("chatcmpl-test-%d",time.Now().UnixNano()),"object":"chat.completion","created":time.Now().Unix(),"model":"gpt-4o-2024-08-06","choices":[]map[string]interface{}{{"index":0,"message":map[string]interface{}{"role":"assistant","content":content,},"finish_reason":"stop",},},"usage":map[string]interface{}{"prompt_tokens":25,"completion_tokens":8,"total_tokens":33,},}}//EmbeddingResponsecreatesarealisticembeddingsresponse.funcEmbeddingResponse(dimensionsint)map[string]interface{}{embedding:=make([]float64,dimensions)fori:=rangeembedding{embedding[i]=0.001}returnmap[string]interface{}{"object":"list","data":[]map[string]interface{}{{"object":"embedding","index":0,"embedding":embedding,},},"model":"text-embedding-ada-002","usage":map[string]interface{}{"prompt_tokens":8,"total_tokens":8,},}}//───HTTPHelpers─────────────────────────────────────────//JSONBodyencodesamaptoa*bytes.ReaderforuseasanHTTPrequestbody.funcJSONBody(datamap[string]interface{})*bytes.Reader{b,_:=json.Marshal(data)returnbytes.NewReader(b)}//NewChatRequestcreatesanhttptestrequestforPOST/v1/chat/completions.funcNewChatRequest(bodymap[string]interface{},apiKeystring)*http.Request{req:=httptest.NewRequest(http.MethodPost,"/v1/chat/completions",JSONBody(body))req.Header.Set("Content-Type","application/json")ifapiKey!=""{req.Header.Set("Authorization","Bearer"+apiKey)}req.Header.Set("X-Request-ID",fmt.Sprintf("test-req-%d",time.Now().UnixNano()))returnreq}//NewEmbeddingRequestcreatesanhttptestrequestforPOST/v1/embeddings.funcNewEmbeddingRequest(bodymap[string]interface{},apiKeystring)*http.Request{req:=httptest.NewRequest(http.MethodPost,"/v1/embeddings",JSONBody(body))req.Header.Set("Content-Type","application/json")ifapiKey!=""{req.Header.Set("Authorization","Bearer"+apiKey)}req.Header.Set("X-Request-ID",fmt.Sprintf("test-req-%d",time.Now().UnixNano()))returnreq}//───MockProviderServer─────────────────────────────────//MockProviderServercreatesanhttptest.Serverthatreturnsafixedchatresponse.funcMockProviderServer(responseBodymap[string]interface{})*httptest.Server{returnhttptest.NewServer(http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){w.Header().Set("Content-Type","application/json")w.WriteHeader(http.StatusOK)json.NewEncoder(w).Encode(responseBody)}))}//MockErrorServercreatesanhttptest.Serverthatreturnsthegivenstatuscode.funcMockErrorServer(statusCodeint,errMsgstring)*httptest.Server{returnhttptest.NewServer(http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){w.Header().Set("Content-Type","application/json")w.WriteHeader(statusCode)json.NewEncoder(w).Encode(map[string]interface{}{"error":map[string]interface{}{"type":"server_error","message":errMsg,},})}))}//MockSlowServercreatesanhttptest.Serverthatdelaysbeforeresponding.funcMockSlowServer(delaytime.Duration,responseBodymap[string]interface{})*httptest.Server{returnhttptest.NewServer(http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){time.Sleep(delay)w.Header().Set("Content-Type","application/json")w.WriteHeader(http.StatusOK)json.NewEncoder(w).Encode(responseBody)}))}