#!/bin/bash##SprintT204:ComparePerformanceProfiles##Comparesbefore/afterprofilestomeasureoptimizationimpact#set-eSCRIPT_DIR="$(cd"$(dirname"${BASH_SOURCE[0]}")"&&pwd)"RESULTS_DIR="$SCRIPT_DIR/results"#ColorsRED='\033[0;31m'GREEN='\033[0;32m'YELLOW='\033[1;33m'BLUE='\033[0;34m'NC='\033[0m'echo-e"${BLUE}üìäProfileComparisonTool${NC}"echo"============================"echo""#Checkargumentsif["$#"-ne2];thenecho"Usage:./compare-profiles.sh<baseline-dir><optimized-dir>"echo""echo"Example:"echo"./compare-profiles.shresults/profiles_20260219_140000results/profiles_20260219_150000"echo""echo"Availableprofiledirectories:"ls-d"$RESULTS_DIR"/profiles_*2>/dev/null||echo"(nonefound)"exit1fiBASELINE_DIR="$1"OPTIMIZED_DIR="$2"#Validatedirectoriesif[!-d"$BASELINE_DIR"];thenecho-e"${RED}‚ùåBaselinedirectorynotfound:$BASELINE_DIR${NC}"exit1fiif[!-d"$OPTIMIZED_DIR"];thenecho-e"${RED}‚ùåOptimizeddirectorynotfound:$OPTIMIZED_DIR${NC}"exit1fi#Checkforrequiredprofilesif[!-f"$BASELINE_DIR/cpu.prof"];thenecho-e"${RED}‚ùåBaselineCPUprofilenotfound${NC}"exit1fiif[!-f"$OPTIMIZED_DIR/cpu.prof"];thenecho-e"${RED}‚ùåOptimizedCPUprofilenotfound${NC}"exit1fiecho-e"${GREEN}‚úÖProfiledirectoriesvalid${NC}"echo""#CreatecomparisonreportdirectoryCOMPARISON_DIR="$RESULTS_DIR/comparison_$(date+%Y%m%d_%H%M%S)"mkdir-p"$COMPARISON_DIR"echo-e"${YELLOW}üîçComparingCPUprofiles...${NC}"#GenerateCPUcomparisongotoolpprof\-base="$BASELINE_DIR/cpu.prof"\-top\-cum\"$OPTIMIZED_DIR/cpu.prof"\>"$COMPARISON_DIR/cpu_diff.txt"2>&1echo-e"${GREEN}‚úÖCPUcomparisonsavedtocpu_diff.txt${NC}"echo""#Compareheapprofilesifavailableif[-f"$BASELINE_DIR/heap.prof"]&&[-f"$OPTIMIZED_DIR/heap.prof"];thenecho-e"${YELLOW}üîçComparingheapprofiles...${NC}"gotoolpprof\-base="$BASELINE_DIR/heap.prof"\-top\-alloc_space\"$OPTIMIZED_DIR/heap.prof"\>"$COMPARISON_DIR/heap_diff.txt"2>&1echo-e"${GREEN}‚úÖHeapcomparisonsavedtoheap_diff.txt${NC}"echo""fi#Compareloadtestresultsifavailableif[-f"$BASELINE_DIR/load_test.json"]&&[-f"$OPTIMIZED_DIR/load_test.json"];thenecho-e"${YELLOW}üîçComparingloadtestmetrics...${NC}"ifcommand-vjq&>/dev/null;thenBASELINE_SUMMARY=$(tail-1"$BASELINE_DIR/load_test.json")OPTIMIZED_SUMMARY=$(tail-1"$OPTIMIZED_DIR/load_test.json")BASELINE_P95=$(echo"$BASELINE_SUMMARY"|jq-r'.metrics.http_req_duration.values["p(95)"]'2>/dev/null)OPTIMIZED_P95=$(echo"$OPTIMIZED_SUMMARY"|jq-r'.metrics.http_req_duration.values["p(95)"]'2>/dev/null)BASELINE_P99=$(echo"$BASELINE_SUMMARY"|jq-r'.metrics.http_req_duration.values["p(99)"]'2>/dev/null)OPTIMIZED_P99=$(echo"$OPTIMIZED_SUMMARY"|jq-r'.metrics.http_req_duration.values["p(99)"]'2>/dev/null)BASELINE_ERROR=$(echo"$BASELINE_SUMMARY"|jq-r'.metrics.errors.values.rate'2>/dev/null)OPTIMIZED_ERROR=$(echo"$OPTIMIZED_SUMMARY"|jq-r'.metrics.errors.values.rate'2>/dev/null)#Calculateimprovementsif["$BASELINE_P95"!="null"]&&["$OPTIMIZED_P95"!="null"];thenP95_IMPROVEMENT=$(echo"scale=2;(($BASELINE_P95-$OPTIMIZED_P95)/$BASELINE_P95)*100"|bc)fiif["$BASELINE_P99"!="null"]&&["$OPTIMIZED_P99"!="null"];thenP99_IMPROVEMENT=$(echo"scale=2;(($BASELINE_P99-$OPTIMIZED_P99)/$BASELINE_P99)*100"|bc)fi#CreatemetricscomparisonreportMETRICS_REPORT="$COMPARISON_DIR/metrics_comparison.txt"cat>"$METRICS_REPORT"<<EOFPerformanceMetricsComparison==============================Baseline:$BASELINE_DIROptimized:$OPTIMIZED_DIRLatencyMetrics:---------------P95Latency:Baseline:${BASELINE_P95}msOptimized:${OPTIMIZED_P95}msChange:${P95_IMPROVEMENT:-N/A}%$([$(echo"$P95_IMPROVEMENT>0"|bc-l2>/dev/null||echo0)-eq1]&&echo"‚úÖimprovement"||echo"‚ùåregression")P99Latency:Baseline:${BASELINE_P99}msOptimized:${OPTIMIZED_P99}msChange:${P99_IMPROVEMENT:-N/A}%$([$(echo"$P99_IMPROVEMENT>0"|bc-l2>/dev/null||echo0)-eq1]&&echo"‚úÖimprovement"||echo"‚ùåregression")ErrorRate:Baseline:${BASELINE_ERROR}Optimized:${OPTIMIZED_ERROR}Status:-------EOFif(($(echo"$P95_IMPROVEMENT>10"|bc-l2>/dev/null||echo0)));thenecho"üéâSIGNIFICANTIMPROVEMENT(>10%P95reduction)">>"$METRICS_REPORT"elif(($(echo"$P95_IMPROVEMENT>0"|bc-l2>/dev/null||echo0)));thenecho"‚úÖIMPROVEMENTDETECTED">>"$METRICS_REPORT"elif(($(echo"$P95_IMPROVEMENT<-5"|bc-l2>/dev/null||echo0)));thenecho"‚ùåPERFORMANCEREGRESSION-DONOTMERGE">>"$METRICS_REPORT"elseecho"‚ûñNOSIGNIFICANTCHANGE">>"$METRICS_REPORT"ficat"$METRICS_REPORT"echo-e"${GREEN}‚úÖMetricscomparisonsavedtometrics_comparison.txt${NC}"echo""elseecho-e"${YELLOW}‚ö†Ô∏èjqnotinstalled-skippingmetricscomparison${NC}"fifi#Generatevisualcomparisonreportecho-e"${YELLOW}üé®Generatingvisualcomparison...${NC}"REPORT_FILE="$COMPARISON_DIR/COMPARISON_REPORT.md"cat>"$REPORT_FILE"<<EOF#PerformanceProfileComparisonReport**Generated:**$(date)##DirectoriesCompared-**Baseline:**\`$BASELINE_DIR\`-**Optimized:**\`$OPTIMIZED_DIR\`##CPUProfileDifferences\`\`\`$(cat"$COMPARISON_DIR/cpu_diff.txt"|head-30)\`\`\`EOFif[-f"$COMPARISON_DIR/heap_diff.txt"];thencat>>"$REPORT_FILE"<<EOF##HeapProfileDifferences\`\`\`$(cat"$COMPARISON_DIR/heap_diff.txt"|head-30)\`\`\`EOFfiif[-f"$COMPARISON_DIR/metrics_comparison.txt"];thencat>>"$REPORT_FILE"<<EOF##LoadTestMetrics\`\`\`$(cat"$COMPARISON_DIR/metrics_comparison.txt")\`\`\`EOFficat>>"$REPORT_FILE"<<EOF##InteractiveAnalysisCommands###ViewCPUDifferences\`\`\`bashgotoolpprof-base=$BASELINE_DIR/cpu.prof-http=:8081$OPTIMIZED_DIR/cpu.prof\`\`\`###ViewHeapDifferences\`\`\`bashgotoolpprof-base=$BASELINE_DIR/heap.prof-http=:8082$OPTIMIZED_DIR/heap.prof\`\`\`###ViewSide-by-SideFlameGraphs\`\`\`bash#Baselinegotoolpprof-http=:8081$BASELINE_DIR/cpu.prof#Optimizedgotoolpprof-http=:8082$OPTIMIZED_DIR/cpu.prof\`\`\`##NextSteps1.Reviewtopfunctionsshowingimprovement/regression2.Validatechangeswithadditionalloadtests3.UpdateSprint.mdwithresults4.CreatePRwithoptimizationifimprovement>10%EOFecho-e"${GREEN}‚úÖComparisonreportsavedtoCOMPARISON_REPORT.md${NC}"echo""echo-e"${BLUE}üìÅComparisonresultssavedto:${NC}"echo"$COMPARISON_DIR/"echo""echo-e"${YELLOW}üí°Viewinteractivecomparison:${NC}"echo"gotoolpprof-base=$BASELINE_DIR/cpu.prof-http=:8081$OPTIMIZED_DIR/cpu.prof"echo""echo-e"${GREEN}‚úÖComparisoncomplete!${NC}"#Displaysummaryifmetricsavailableif[-f"$COMPARISON_DIR/metrics_comparison.txt"];thenecho""echo-e"${BLUE}üìäSummary:${NC}"grep-A20"Status:""$COMPARISON_DIR/metrics_comparison.txt"||truefi