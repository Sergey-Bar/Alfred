#!/bin/bash##SprintT204:CompletePerformanceTestingWorkflow##Thisscriptrunsthecompleteperformanceanalysisworkflow:#1.Establishbaseline#2.Profileunderload#3.Generaterecommendations#set-eSCRIPT_DIR="$(cd"$(dirname"${BASH_SOURCE[0]}")"&&pwd)"#ColorsRED='\033[0;31m'GREEN='\033[0;32m'YELLOW='\033[1;33m'BLUE='\033[0;34m'MAGENTA='\033[0;35m'CYAN='\033[0;36m'NC='\033[0m'clearcat<<"EOF"____________________/\|||___|_\|____|_\/_\||||_||_)|_|||||/___\|||_||_<||___||_||/_/\_\_||_||_|\_|_____|____/GatewayPerformanceAnalysisWorkflow======================================EOFecho""echo-e"${BLUE}SprintT204:GatewayLatencyProfiling${NC}"echo-e"${BLUE}Target:Sub-100msP95@10Kreq/min${NC}"echo""#CheckifrunningonWindows(GitBash/WSL)if[["$OSTYPE"=="msys"]]||[["$OSTYPE"=="cygwin"]]||grep-qimicrosoft/proc/version2>/dev/null;thenecho-e"${YELLOW}âš ï¸DetectedWindowsenvironment${NC}"echo-e"${YELLOW}RecommendrunninginWSLorGitBashforbestexperience${NC}"echo""fi#Step1:Prerequisitescheckecho-e"${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"echo-e"${MAGENTA}Step1/4:PrerequisitesCheck${NC}"echo-e"${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"echo""MISSING_TOOLS=()if!command-vgo&>/dev/null;thenMISSING_TOOLS+=("go")fiif!command-vk6&>/dev/null;thenMISSING_TOOLS+=("k6")fiif!command-vjq&>/dev/null;thenecho-e"${YELLOW}âš ï¸jqnotinstalled(optionalbutrecommended)${NC}"fiif[${#MISSING_TOOLS[@]}-gt0];thenecho-e"${RED}âŒMissingrequiredtools:${MISSING_TOOLS[*]}${NC}"echo""echo"Installinstructions:"fortoolin"${MISSING_TOOLS[@]}";docase$toolingo)echo"-Go:https://golang.org/dl/";;k6)echo"-k6:https://k6.io/docs/getting-started/installation/"echo"macOS:brewinstallk6"echo"Windows:chocoinstallk6";;esacdoneexit1fiecho-e"${GREEN}âœ…Allrequiredtoolsinstalled${NC}"echo""#Checkenvironmentvariablesif[-z"$ALFRED_PROFILING_TOKEN"];thenecho-e"${YELLOW}âš ï¸ALFRED_PROFILING_TOKENnotset${NC}"echo-e"${YELLOW}Profilingwillnotbeavailable${NC}"echo""echo"Generateatokenwith:"echo"exportALFRED_PROFILING_TOKEN=\$(opensslrand-hex32)"echo""read-p"Generatetokennow?(y/n)"-n1-rechoif[[$REPLY=~^[Yy]$]];thenifcommand-vopenssl&>/dev/null;thenexportALFRED_PROFILING_TOKEN=$(opensslrand-hex32)echo-e"${GREEN}âœ…Generatedtoken:$ALFRED_PROFILING_TOKEN${NC}"echo""elseexportALFRED_PROFILING_TOKEN="development-token-$(date+%s)"echo-e"${YELLOW}âš ï¸opensslnotfound,usingsimpletoken${NC}"echo-e"${YELLOW}Token:$ALFRED_PROFILING_TOKEN${NC}"echo""fififi#CheckifgatewayisrunningGATEWAY_URL="${GATEWAY_URL:-http://localhost:8080}"ifcurl-s-f"$GATEWAY_URL/health">/dev/null2>&1;thenecho-e"${GREEN}âœ…Gatewayisrunningat$GATEWAY_URL${NC}"elseecho-e"${YELLOW}âš ï¸Gatewaynotrespondingat$GATEWAY_URL${NC}"echo""echo"Startthegatewaywith:"echo"cd$SCRIPT_DIR/.."echo"exportALFRED_PROFILING_ENABLED=true"echo"exportALFRED_PROFILING_TOKEN=\$ALFRED_PROFILING_TOKEN"echo"gorunmain.go"echo""read-p"Startgatewaynow?(y/n)"-n1-rechoif[[$REPLY=~^[Yy]$]];thenecho-e"${BLUE}Startinggatewayinbackground...${NC}"cd"$SCRIPT_DIR/.."ALFRED_PROFILING_ENABLED=trueALFRED_PROFILING_TOKEN="$ALFRED_PROFILING_TOKEN"\gorunmain.go>"$SCRIPT_DIR/results/gateway.log"2>&1&GATEWAY_PID=$!echo"$GATEWAY_PID">"$SCRIPT_DIR/results/gateway.pid"echo-e"${GREEN}âœ…Gatewaystarted(PID:$GATEWAY_PID)${NC}"echo""echo"Waiting5sforstartup..."sleep5cd"$SCRIPT_DIR"elseecho-e"${RED}âŒCannotproceedwithoutrunninggateway${NC}"exit1fifiecho""#Step2:BaselineAnalysisecho-e"${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"echo-e"${MAGENTA}Step2/4:BaselinePerformanceAnalysis${NC}"echo-e"${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"echo""./analyze-performance.shecho""#Step3:ProfileUnderLoadecho-e"${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"echo-e"${MAGENTA}Step3/4:ProfileUnderLoad${NC}"echo-e"${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"echo""if[-n"$ALFRED_PROFILING_TOKEN"];then./profile-under-load.shelseecho-e"${YELLOW}âš ï¸Skippingprofiling(ALFRED_PROFILING_TOKENnotset)${NC}"fiecho""#Step4:GenerateRecommendationsecho-e"${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"echo-e"${MAGENTA}Step4/4:GenerateOptimizationRecommendations${NC}"echo-e"${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"echo""LATEST_PROFILE=$(ls-tdresults/profiles_*2>/dev/null|head-1)if[-n"$LATEST_PROFILE"]&&[-f"$LATEST_PROFILE/cpu.prof"];thenecho-e"${YELLOW}ðŸ“ŠAnalyzingCPUprofileforoptimizationopportunities...${NC}"#Gettop10functionsbycumulativetimeCPU_TOP=$(gotoolpprof-top-cum"$LATEST_PROFILE/cpu.prof"2>/dev/null|head-15)RECOMMENDATIONS_FILE="$LATEST_PROFILE/RECOMMENDATIONS.md"cat>"$RECOMMENDATIONS_FILE"<<EOF#PerformanceOptimizationRecommendations**Generated:**$(date)**Profile:**$LATEST_PROFILE##TopCPUConsumers\`\`\`$CPU_TOP\`\`\`##RecommendedOptimizationsBasedontheprofileanalysis,hereareoptimizationpriorities:###HighImpact(ImplementFirst)EOF#Checkforcommonbottlenecksandaddrecommendationsifecho"$CPU_TOP"|grep-q"runtime.mallocgc";thencat>>"$RECOMMENDATIONS_FILE"<<EOF1.**ReduceMemoryAllocations**-**Finding:**High\`runtime.mallocgc\`timeindicatesexcessiveallocations-**Impact:**ReducesGCpressure,improveslatency-**Actions:**-Use\`sync.Pool\`forfrequentlyallocatedobjects-ReusebuffersforJSONmarshaling-Pre-allocatesliceswithknowncapacity-**SprintTask:**T208-MemoryallocationoptimizationEOFfiifecho"$CPU_TOP"|grep-q"encoding/json";thencat>>"$RECOMMENDATIONS_FILE"<<EOF2.**OptimizeJSONSerialization**-**Finding:**Significanttimein\`encoding/json\`-**Impact:**20-30%latencyimprovementpossible-**Actions:**-Use\`json.Marshal\`pool-Consider\`github.com/json-iterator/go\`forfasterJSON-Cacheserializedresponseswherepossible-**SprintTask:**T206-RequestpipelineoptimizationEOFfiifecho"$CPU_TOP"|grep-q"net/http";thencat>>"$RECOMMENDATIONS_FILE"<<EOF3.**HTTPHandlerOptimization**-**Finding:**High\`net/http\`overhead-**Impact:**10-15%latencyimprovement-**Actions:**-Minimizemiddlewarechain-Useresponsebufferpooling-Optimizeheaderparsing-**SprintTask:**T206-RequestpipelineoptimizationEOFfiifecho"$CPU_TOP"|grep-q"redis\|database/sql";thencat>>"$RECOMMENDATIONS_FILE"<<EOF4.**ConnectionPoolTuning**-**Finding:**Database/Redisoverheaddetected-**Impact:**ReducesI/Owaittime-**Actions:**-Increaseconnectionpoolsize-Implementconnectionwarmuponstartup-Addquerycachinglayer-**SprintTask:**T205-ConnectionpooltuningEOFficat>>"$RECOMMENDATIONS_FILE"<<EOF###MediumImpact5.**EnableResponseCompression**-Reducespayloadsizeforlargeresponses-Trade-off:addsCPUoverheadbutreducesnetworktime6.**ImplementRequestBatching**-Groupsimilarrequeststogether-Reducesper-requestoverhead7.**AddSemanticCaching**-Cacheresponsesforsimilarprompts-Target:30%+cachehitrate###LowImpact(NicetoHave)8.**MetricsCollectionOptimization**-Movemetricstoasyncgoroutine-Reducesamplingrateinproduction##NextSteps1.**ReviewFullProfile:**\`\`\`bashgotoolpprof-http=:8081$LATEST_PROFILE/cpu.prof\`\`\`2.**ImplementTop3Optimizations**-CreatefeaturebranchesforT205,T206,T208-Implementfixeswithproperbenchmarks-Run\`compare-profiles.sh\`tovalidateimprovements3.**TargetMetrics:**-P95latency:<100ms-Throughput:10Kreq/min-Memory:<512MBperinstance4.**UpdateSprint.md:**-MarkT204ascomplete-Addfindingstotasknotes-Prioritizeoptimizationtasksbasedonimpact##ProfileAnalysisCommands###InteractiveCPUAnalysis\`\`\`bashgotoolpprof-http=:8081$LATEST_PROFILE/cpu.prof\`\`\`###MemoryAnalysis\`\`\`bashgotoolpprof-http=:8082$LATEST_PROFILE/heap.prof\`\`\`###GoroutineAnalysis\`\`\`bashgotoolpprof-top$LATEST_PROFILE/goroutine.prof\`\`\`---**Sprint:**ExcellenceEdition(Feb19-Mar4,2026)**Task:**T204-GatewayLatencyProfilingEOFcat"$RECOMMENDATIONS_FILE"echo""echo-e"${GREEN}âœ…Recommendationssavedto:$RECOMMENDATIONS_FILE${NC}"elseecho-e"${YELLOW}âš ï¸Noprofiledataavailable${NC}"fiecho""#FinalSummaryecho-e"${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"echo-e"${MAGENTA}ðŸŽ‰PerformanceAnalysisComplete!${NC}"echo-e"${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"echo""if[-n"$LATEST_PROFILE"];thenecho-e"${BLUE}ðŸ“ResultsLocation:${NC}"echo"$LATEST_PROFILE/"echo""echo-e"${BLUE}ðŸ“ŠNextSteps:${NC}"echo"1.Reviewrecommendations:cat$LATEST_PROFILE/RECOMMENDATIONS.md"echo"2.Analyzeprofiles:gotoolpprof-http=:8081$LATEST_PROFILE/cpu.prof"echo"3.UpdateSprint.mdwithfindings"echo"4.Createoptimizationtasks(T205-T208)"echo""echo-e"${YELLOW}ðŸ’¡QuickCommands:${NC}"echo"#ViewCPUprofile"echo"gotoolpprof-http=:8081$LATEST_PROFILE/cpu.prof"echo""echo"#Viewmemoryprofile"echo"gotoolpprof-http=:8082$LATEST_PROFILE/heap.prof"echo""echo"#Afteroptimization,compare:"echo"./compare-profiles.sh$LATEST_PROFILEresults/profiles_<new>/"fiecho""#Cleanuppromptif[-f"$SCRIPT_DIR/results/gateway.pid"];thenGATEWAY_PID=$(cat"$SCRIPT_DIR/results/gateway.pid")echo-e"${YELLOW}Gatewayisrunning(PID:$GATEWAY_PID)${NC}"read-p"Stopgateway?(y/n)"-n1-rechoif[[$REPLY=~^[Yy]$]];thenkill"$GATEWAY_PID"2>/dev/null||truerm"$SCRIPT_DIR/results/gateway.pid"echo-e"${GREEN}âœ…Gatewaystopped${NC}"fifiecho""echo-e"${GREEN}ðŸš€Readytooptimize!${NC}"