#!/bin/bash##SprintT204:ProfileGatewayUnderLoad##CapturesCPU,memory,andgoroutineprofileswhilerunningloadtest.#Usethistoidentifyperformancebottlenecks.#set-eSCRIPT_DIR="$(cd"$(dirname"${BASH_SOURCE[0]}")"&&pwd)"RESULTS_DIR="$SCRIPT_DIR/results"TIMESTAMP=$(date+%Y%m%d_%H%M%S)PROFILE_DIR="$RESULTS_DIR/profiles_${TIMESTAMP}"#ColorsRED='\033[0;31m'GREEN='\033[0;32m'YELLOW='\033[1;33m'BLUE='\033[0;34m'NC='\033[0m'echo-e"${BLUE}ðŸ”¬GatewayProfilingUnderLoad${NC}"echo"================================="echo""#Createprofiledirectorymkdir-p"$PROFILE_DIR"#Checkprerequisitesecho-e"${YELLOW}ðŸ“‹Checkingprerequisites...${NC}"if!command-vk6&>/dev/null;thenecho-e"${RED}âŒk6notfound${NC}"exit1fi#CheckifgatewayisrunningGATEWAY_URL="${GATEWAY_URL:-http://localhost:8080}"if!curl-s-f"$GATEWAY_URL/health">/dev/null2>&1;thenecho-e"${RED}âŒGatewaynotrespondingat$GATEWAY_URL${NC}"exit1fi#CheckifprofilingendpointisavailablePROFILING_URL="${PROFILING_URL:-http://localhost:6060}"PROFILING_TOKEN="${ALFRED_PROFILING_TOKEN:-}"if[-z"$PROFILING_TOKEN"];thenecho-e"${RED}âŒALFRED_PROFILING_TOKENnotset${NC}"echo"Setwith:exportALFRED_PROFILING_TOKEN=your-secret-token"exit1fiif!curl-s-H"Authorization:Bearer$PROFILING_TOKEN"\-f"$PROFILING_URL/debug/pprof/">/dev/null2>&1;thenecho-e"${RED}âŒProfilingservernotaccessibleat$PROFILING_URL${NC}"echo"Startgatewaywith:ALFRED_PROFILING_ENABLED=truegorunmain.go"exit1fiecho-e"${GREEN}âœ…PrerequisitesOK${NC}"echo""#Startloadtestinbackgroundecho-e"${YELLOW}ðŸš€Startingloadtest(100VUsfor5minutes)...${NC}"k6run\--vus100\--duration5m\--outjson="$PROFILE_DIR/load_test.json"\"$SCRIPT_DIR/load-test.js"\>"$PROFILE_DIR/load_test.log"2>&1&LOAD_TEST_PID=$!echo-e"${GREEN}âœ…Loadteststarted(PID:$LOAD_TEST_PID)${NC}"echo""#Waitforloadtostabilizeecho-e"${YELLOW}â³Waiting30sforloadtostabilize...${NC}"sleep30#Capturebaselineruntimestatsecho-e"${YELLOW}ðŸ“ŠCapturingbaselineruntimestats...${NC}"curl-s-H"Authorization:Bearer$PROFILING_TOKEN"\"$PROFILING_URL/debug/pprof/stats"\>"$PROFILE_DIR/runtime_stats_start.json"echo-e"${GREEN}âœ…Baselinestatscaptured${NC}"echo""#CaptureCPUprofile(60seconds)echo-e"${YELLOW}ðŸ”¥CapturingCPUprofile(60seconds)...${NC}"curl-s-H"Authorization:Bearer$PROFILING_TOKEN"\"$PROFILING_URL/debug/pprof/profile?seconds=60"\-o"$PROFILE_DIR/cpu.prof"echo-e"${GREEN}âœ…CPUprofilesavedtocpu.prof${NC}"echo""#Captureheapprofileecho-e"${YELLOW}ðŸ’¾Capturingheapprofile...${NC}"curl-s-H"Authorization:Bearer$PROFILING_TOKEN"\"$PROFILING_URL/debug/pprof/heap"\-o"$PROFILE_DIR/heap.prof"echo-e"${GREEN}âœ…Heapprofilesavedtoheap.prof${NC}"echo""#Capturegoroutineprofileecho-e"${YELLOW}ðŸ§µCapturinggoroutineprofile...${NC}"curl-s-H"Authorization:Bearer$PROFILING_TOKEN"\"$PROFILING_URL/debug/pprof/goroutine"\-o"$PROFILE_DIR/goroutine.prof"echo-e"${GREEN}âœ…Goroutineprofilesavedtogoroutine.prof${NC}"echo""#Captureallocationprofileecho-e"${YELLOW}ðŸ—‘ï¸Capturingallocationprofile...${NC}"curl-s-H"Authorization:Bearer$PROFILING_TOKEN"\"$PROFILING_URL/debug/pprof/allocs"\-o"$PROFILE_DIR/allocs.prof"echo-e"${GREEN}âœ…Allocationprofilesavedtoallocs.prof${NC}"echo""#Capturemutexprofileecho-e"${YELLOW}ðŸ”’Capturingmutexprofile...${NC}"curl-s-H"Authorization:Bearer$PROFILING_TOKEN"\"$PROFILING_URL/debug/pprof/mutex"\-o"$PROFILE_DIR/mutex.prof"echo-e"${GREEN}âœ…Mutexprofilesavedtomutex.prof${NC}"echo""#Captureblockprofileecho-e"${YELLOW}â¸ï¸Capturingblockprofile...${NC}"curl-s-H"Authorization:Bearer$PROFILING_TOKEN"\"$PROFILING_URL/debug/pprof/block"\-o"$PROFILE_DIR/block.prof"echo-e"${GREEN}âœ…Blockprofilesavedtoblock.prof${NC}"echo""#Capturefinalruntimestatsecho-e"${YELLOW}ðŸ“ŠCapturingfinalruntimestats...${NC}"curl-s-H"Authorization:Bearer$PROFILING_TOKEN"\"$PROFILING_URL/debug/pprof/stats"\>"$PROFILE_DIR/runtime_stats_end.json"echo-e"${GREEN}âœ…Finalstatscaptured${NC}"echo""#Waitforloadtesttocompleteecho-e"${YELLOW}â³Waitingforloadtesttocomplete...${NC}"wait$LOAD_TEST_PIDecho-e"${GREEN}âœ…Loadtestcomplete${NC}"echo""#GenerateanalysiscommandsANALYSIS_FILE="$PROFILE_DIR/ANALYSIS_COMMANDS.txt"cat>"$ANALYSIS_FILE"<<EOFGatewayProfileAnalysisCommands=================================ProfileDirectory:$PROFILE_DIRTop10CPUConsumers:---------------------gotoolpprof-top-cum$PROFILE_DIR/cpu.profInteractiveCPUAnalysis:------------------------gotoolpprof-http=:8081$PROFILE_DIR/cpu.prof#Thennavigateto:#-FlameGraph:visualizecallstack#-Source:seeannotatedsourcecode#-Top:listfunctionsbytimeTop10MemoryAllocators:-------------------------gotoolpprof-top-alloc_space$PROFILE_DIR/heap.profHeapAnalysis(in-usememory):------------------------------gotoolpprof-http=:8082-inuse_space$PROFILE_DIR/heap.profGoroutineLeakDetection:------------------------gotoolpprof-top$PROFILE_DIR/goroutine.prof#LookforunexpectedhighgoroutinecountsMutexContention:----------------gotoolpprof-top$PROFILE_DIR/mutex.prof#HighvaluesindicatelockcontentionBlockProfiling:---------------gotoolpprof-top$PROFILE_DIR/block.prof#ShowswheregoroutinesblockCompareProfiles(beforevsafteroptimization):-----------------------------------------------gotoolpprof-base=baseline_cpu.profoptimized_cpu.profgotoolpprof-base=baseline_heap.prof-diff_baseoptimized_heap.profGenerateFlameGraph:--------------------gotoolpprof-http=:8081$PROFILE_DIR/cpu.prof#Navigateto"View>FlameGraph"CommonBottleneckstoCheck:---------------------------1.runtime.mallocgc-excessiveallocations2.runtime.gcBgMarkWorker-GCpressure3.encoding/json-JSONserialization4.net/http-HTTPhandlingoverhead5.sync.(*Mutex).Lock-lockcontention6.syscall.Syscall-systemcalloverheadNextSteps:----------1.Run:gotoolpprof-http=:8081$PROFILE_DIR/cpu.prof2.Identifytop5functionsbycumulativetime3.DocumentbottlenecksinSprint.md(T204)4.Createoptimizationtasks(T205-T208)5.Implementfixes6.Re-runthisscriptandcompareresultsEOFcat"$ANALYSIS_FILE"echo""echo-e"${BLUE}ðŸ“Allprofilessavedto:${NC}"echo"$PROFILE_DIR/"echo""echo-e"${YELLOW}ðŸ’¡QuickAnalysis:${NC}"echo"gotoolpprof-http=:8081$PROFILE_DIR/cpu.prof"echo""echo-e"${GREEN}âœ…Profilingcomplete!${NC}"echo""#Auto-openCPUprofileanalysisifonmacOS/LinuxwithGUIif[["$OSTYPE"=="darwin"*]]||[["$OSTYPE"=="linux-gnu"*]];thenecho-e"${YELLOW}ðŸŒStartinginteractiveCPUprofileanalysisonhttp://localhost:8081...${NC}"gotoolpprof-http=:8081"$PROFILE_DIR/cpu.prof"&sleep2ifcommand-vopen&>/dev/null;thenopenhttp://localhost:8081elifcommand-vxdg-open&>/dev/null;thenxdg-openhttp://localhost:8081fifi