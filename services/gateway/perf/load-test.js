/*SprintT204:GatewayPerformanceLoadTestingThisk6scriptteststheAlfredAIGatewayunderrealisticloadto:1.Establishperformancebaseline(P50,P95,P99latency)2.Identifybottlenecksandscalinglimits3.Validatesub-100msP95latencytarget4.TestfailoveranderrorhandlingunderstressTarget:10,000requests/minutesustainedwithP95<100ms*/import{check,sleep}from'k6';importhttpfrom'k6/http';import{Counter,Rate,Trend}from'k6/metrics';//CustommetricsconsterrorRate=newRate('errors');constlatencyTrend=newTrend('request_latency');constrequestCount=newCounter('requests_total');constcacheHitRate=newRate('cache_hits');//Testconfigurationexportconstoptions={//Ramp-uptest:graduallyincreaseloadstages:[{duration:'2m',target:50},//Warm-up:50VUs{duration:'5m',target:100},//Rampto100VUs(~1Kreq/min){duration:'10m',target:500},//Rampto500VUs(~5Kreq/min){duration:'10m',target:1000},//Target:1000VUs(~10Kreq/min){duration:'5m',target:1000},//Sustainpeakload{duration:'5m',target:0},//Rampdown],//SLAthresholdsthresholds:{'http_req_duration':['p(50)<50',//50%ofrequestsmustcompletein<50ms'p(95)<100',//95%ofrequestsmustcompletein<100ms(KEYMETRIC)'p(99)<200',//99%ofrequestsmustcompletein<200ms],'errors':['rate<0.01'],//Errorratemustbe<1%'http_req_failed':['rate<0.01'],},//Testenvironmentext:{loadimpact:{projectID:3000000,name:'AlfredGatewayPerformanceTest'}}};//Gatewayendpoint(configureviaenvironmentvariable)constBASE_URL=__ENV.GATEWAY_URL||'http://localhost:8080';constAPI_KEY=__ENV.TEST_API_KEY||'test-api-key';//TestscenarioswithrealisticrequestpatternsconstSCENARIOS=[{name:'chat_completion',endpoint:'/v1/chat/completions',weight:70,//70%oftrafficpayload:{model:'gpt-4o',messages:[{role:'system',content:'Youareahelpfulassistant.'},{role:'user',content:'WhatisthecapitalofFrance?'}],max_tokens:100}},{name:'embedding',endpoint:'/v1/embeddings',weight:20,//20%oftrafficpayload:{model:'text-embedding-3-small',input:'Thisisatestembeddingrequestforperformanceanalysis.'}},{name:'streaming_chat',endpoint:'/v1/chat/completions',weight:10,//10%oftrafficpayload:{model:'gpt-4o-mini',messages:[{role:'user',content:'Tellmeashortstory.'}],stream:true,max_tokens:200}}];//SelectrequesttypebasedonweightdistributionfunctionselectScenario(){constrand=Math.random()*100;letcumulative=0;for(constscenarioofSCENARIOS){cumulative+=scenario.weight;if(rand<cumulative){returnscenario;}}returnSCENARIOS[0];//Fallback}exportdefaultfunction(){constscenario=selectScenario();constparams={headers:{'Content-Type':'application/json','Authorization':`Bearer${API_KEY}`,'X-Trace-ID':`k6-test-${__VU}-${__ITER}`,},timeout:'30s',};conststartTime=Date.now();constresponse=http.post(`${BASE_URL}${scenario.endpoint}`,JSON.stringify(scenario.payload),params);constduration=Date.now()-startTime;//RecordmetricsrequestCount.add(1);latencyTrend.add(duration);//Checkresponseconstsuccess=check(response,{'statusis200':(r)=>r.status===200,'responsetime<100ms':(r)=>r.timings.duration<100,'responsehasbody':(r)=>r.body.length>0,'noerrorinresponse':(r)=>!r.body.includes('error'),});if(!success){errorRate.add(1);console.error(`Requestfailed:${scenario.name},status=${response.status},duration=${duration}ms`);}else{errorRate.add(0);}//CheckforcachehitconstcacheHit=response.headers['X-Cache-Hit']==='true';cacheHitRate.add(cacheHit?1:0);//Realisticthinktime(100-300msbetweenrequestsperuser)sleep(Math.random()*0.2+0.1);}//Lifecyclehooksexportfunctionsetup(){console.log(`ðŸš€StartingAlfredGatewayloadtest`);console.log(`Target:${BASE_URL}`);console.log(`Goal:10,000req/minwithP95<100ms`);//Warm-up:sendafewrequeststowakeupservicesfor(leti=0;i<10;i++){http.post(`${BASE_URL}/v1/chat/completions`,JSON.stringify({model:'gpt-4o-mini',messages:[{role:'user',content:'warmup'}],max_tokens:10}),{headers:{'Content-Type':'application/json','Authorization':`Bearer${API_KEY}`,}});}console.log(`âœ…Warm-upcomplete`);}exportfunctionteardown(data){console.log(`âœ…Loadtestcomplete`);}//HandlesummaryoutputexportfunctionhandleSummary(data){constp95=data.metrics.http_req_duration.values['p(95)'];constp99=data.metrics.http_req_duration.values['p(99)'];consterrorRate=data.metrics.errors?data.metrics.errors.values.rate:0;constcacheRate=data.metrics.cache_hits?data.metrics.cache_hits.values.rate:0;console.log(`\nðŸ“ŠPerformanceSummary:`);console.log(`P95Latency:${p95.toFixed(2)}ms${p95<100?'âœ…':'âŒ'}`);console.log(`P99Latency:${p99.toFixed(2)}ms${p99<200?'âœ…':'âŒ'}`);console.log(`ErrorRate:${(errorRate*100).toFixed(2)}%${errorRate<0.01?'âœ…':'âŒ'}`);console.log(`CacheHitRate:${(cacheRate*100).toFixed(2)}%`);return{'performance-report.html':htmlReport(data),'stdout':textSummary(data,{indent:'',enableColors:true}),};}functionhtmlReport(data){//GenerateHTMLreport(simplified)return`<!DOCTYPEhtml><html><head><title>AlfredGatewayPerformanceReport</title><style>body{font-family:system-ui;max-width:1200px;margin:40pxauto;padding:20px;}.metric{background:#f5f5f5;padding:15px;margin:10px0;border-radius:8px;}.success{color:#22c55e;}.failure{color:#ef4444;}h1{color:#1e293b;}</style></head><body><h1>ðŸš€AlfredGatewayPerformanceReport</h1><divclass="metric"><h3>P95Latency</h3><pclass="${data.metrics.http_req_duration.values['p(95)']<100?'success':'failure'}">${data.metrics.http_req_duration.values['p(95)'].toFixed(2)}ms(Target:<100ms)</p></div><divclass="metric"><h3>TotalRequests</h3><p>${data.metrics.requests_total?data.metrics.requests_total.values.count:'N/A'}</p></div></body></html>`;}