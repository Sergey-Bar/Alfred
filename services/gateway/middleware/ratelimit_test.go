packagemiddleware_testimport("net/http""net/http/httptest""strconv""testing""github.com/AlfredDev/alfred/services/gateway/middleware""github.com/rs/zerolog")funcnewTestRateLimiter(enabledbool,rpm,burstint)*middleware.RateLimiter{logger:=zerolog.Nop()returnmiddleware.NewRateLimiter(logger,enabled,rpm,burst)}//──BasicRateLimiting──────────────────────────────────────funcTestRateLimiter_Disabled(t*testing.T){rl:=newTestRateLimiter(false,5,0)handler:=rl.Handler(okHandler)//Shouldpassallrequeststhroughwhendisabledfori:=0;i<100;i++{req:=httptest.NewRequest("GET","/test",nil)rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)ifrr.Code!=http.StatusOK{t.Fatalf("request%d:expected200,got%d",i,rr.Code)}}}funcTestRateLimiter_AllowsWithinLimit(t*testing.T){rl:=newTestRateLimiter(true,10,0)handler:=rl.Handler(okHandler)fori:=0;i<10;i++{req:=httptest.NewRequest("GET","/test",nil)req.RemoteAddr="192.168.1.1:12345"rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)ifrr.Code!=http.StatusOK{t.Fatalf("request%d:expected200,got%d",i,rr.Code)}}}funcTestRateLimiter_BlocksOverLimit(t*testing.T){rl:=newTestRateLimiter(true,5,0)handler:=rl.Handler(okHandler)//First5shouldpassfori:=0;i<5;i++{req:=httptest.NewRequest("GET","/test",nil)req.RemoteAddr="10.0.0.1:1234"rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)ifrr.Code!=http.StatusOK{t.Fatalf("request%d:expected200,got%d",i,rr.Code)}}//6thshouldberatelimitedreq:=httptest.NewRequest("GET","/test",nil)req.RemoteAddr="10.0.0.1:1234"rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)ifrr.Code!=http.StatusTooManyRequests{t.Errorf("expected429,got%d",rr.Code)}}//──HeaderInjection─────────────────────────────────────────funcTestRateLimiter_SetsRateLimitHeaders(t*testing.T){rl:=newTestRateLimiter(true,100,0)handler:=rl.Handler(okHandler)req:=httptest.NewRequest("GET","/test",nil)req.RemoteAddr="10.0.0.2:5678"rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)iflimit:=rr.Header().Get("X-RateLimit-Limit");limit!="100"{t.Errorf("expectedX-RateLimit-Limit=100,got%q",limit)}remaining:=rr.Header().Get("X-RateLimit-Remaining")ifremaining==""{t.Error("X-RateLimit-Remainingheadermissing")}rem,_:=strconv.Atoi(remaining)ifrem!=99{t.Errorf("expectedremaining=99,got%d",rem)}ifreset:=rr.Header().Get("X-RateLimit-Reset");reset==""{t.Error("X-RateLimit-Resetheadermissing")}}funcTestRateLimiter_RetryAfterOnBlock(t*testing.T){rl:=newTestRateLimiter(true,1,0)handler:=rl.Handler(okHandler)//Firstrequestpassesreq:=httptest.NewRequest("GET","/test",nil)req.RemoteAddr="10.0.0.3:9999"rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)//SecondisblockedwithRetry-Afterreq=httptest.NewRequest("GET","/test",nil)req.RemoteAddr="10.0.0.3:9999"rr=httptest.NewRecorder()handler.ServeHTTP(rr,req)ifrr.Code!=http.StatusTooManyRequests{t.Fatalf("expected429,got%d",rr.Code)}ifretryAfter:=rr.Header().Get("Retry-After");retryAfter==""{t.Error("Retry-Afterheadermissingon429response")}}//──Per-KeyIsolation─────────────────────────────────────────funcTestRateLimiter_PerKeyIsolation(t*testing.T){rl:=newTestRateLimiter(true,2,0)handler:=rl.Handler(okHandler)//ClientAuses2requestsfori:=0;i<2;i++{req:=httptest.NewRequest("GET","/test",nil)req.RemoteAddr="10.0.0.10:1111"rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)ifrr.Code!=http.StatusOK{t.Fatalf("clientA,req%d:expected200,got%d",i,rr.Code)}}//ClientBshouldstillbeallowedreq:=httptest.NewRequest("GET","/test",nil)req.RemoteAddr="10.0.0.20:2222"rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)ifrr.Code!=http.StatusOK{t.Errorf("clientB:expected200,got%d",rr.Code)}//ClientAshouldbeblockedreq=httptest.NewRequest("GET","/test",nil)req.RemoteAddr="10.0.0.10:1111"rr=httptest.NewRecorder()handler.ServeHTTP(rr,req)ifrr.Code!=http.StatusTooManyRequests{t.Errorf("clientAover-limit:expected429,got%d",rr.Code)}}//──APIKeyBasedLimiting───────────────────────────────────funcTestRateLimiter_UsesAPIKeyFromContext(t*testing.T){rl:=newTestRateLimiter(true,2,0)//WrapwithauthmiddlewaretosetAPIkeyincontextam:=middleware.NewAuthMiddleware(zerolog.Nop(),"")handler:=am.Handler(rl.Handler(okHandler))//BothfromsameIPbutdifferentAPIkeys→separatelimitsfori:=0;i<2;i++{req:=httptest.NewRequest("GET","/test",nil)req.RemoteAddr="same-ip:1234"req.Header.Set("Authorization","Bearerkey-alpha")rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)ifrr.Code!=http.StatusOK{t.Fatalf("key-alphareq%d:expected200,got%d",i,rr.Code)}}//key-betashouldhaveitsownlimitreq:=httptest.NewRequest("GET","/test",nil)req.RemoteAddr="same-ip:1234"req.Header.Set("Authorization","Bearerkey-beta")rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)ifrr.Code!=http.StatusOK{t.Errorf("key-beta:expected200,got%d",rr.Code)}}//──Cleanup──────────────────────────────────────────────────funcTestRateLimiter_Cleanup(t*testing.T){rl:=newTestRateLimiter(true,100,0)//Makesomerequestshandler:=rl.Handler(okHandler)fori:=0;i<5;i++{req:=httptest.NewRequest("GET","/test",nil)req.RemoteAddr="cleanup-client:1234"rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)}//Cleanupshouldnotpanicrl.Cleanup()}//──ErrorResponseBody──────────────────────────────────────funcTestRateLimiter_ErrorResponseContainsJSON(t*testing.T){rl:=newTestRateLimiter(true,1,0)handler:=rl.Handler(okHandler)//Firstpassesreq:=httptest.NewRequest("GET","/test",nil)req.RemoteAddr="json-test:1234"rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)//Secondblockedreq=httptest.NewRequest("GET","/test",nil)req.RemoteAddr="json-test:1234"rr=httptest.NewRecorder()handler.ServeHTTP(rr,req)body:=rr.Body.String()iflen(body)==0{t.Error("expectednon-emptyerrorbody")}//ShouldcontainJSONwitherrorandmessagefieldsif!contains(body,"rate_limit_exceeded"){t.Errorf("expected'rate_limit_exceeded'inbody,got%q",body)}}funccontains(s,substrstring)bool{returnlen(s)>=len(substr)&&(s==substr||len(s)>0&&containsStr(s,substr))}funccontainsStr(s,substring)bool{fori:=0;i<=len(s)-len(sub);i++{ifs[i:i+len(sub)]==sub{returntrue}}returnfalse}