packagemiddleware_testimport("net/http""net/http/httptest""sync""sync/atomic""testing""time""github.com/AlfredDev/alfred/services/gateway/middleware""github.com/rs/zerolog")//──KeyedMutexTests─────────────────────────────────────────funcTestKeyedMutex_BasicLockUnlock(t*testing.T){km:=middleware.NewKeyedMutex()unlock:=km.Lock("wallet-123")//Shouldnotdeadlockunlock()}funcTestKeyedMutex_DifferentKeysNoBlock(t*testing.T){km:=middleware.NewKeyedMutex()done:=make(chanstruct{})unlock1:=km.Lock("key-a")gofunc(){unlock2:=km.Lock("key-b")unlock2()close(done)}()//key-bshouldacquireimmediatelysinceit'sadifferentkeyselect{case<-done://OKcase<-time.After(1*time.Second):t.Fatal("key-bblockedwaitingforkey-a—shouldbeindependent")}unlock1()}funcTestKeyedMutex_SameKeySerializes(t*testing.T){km:=middleware.NewKeyedMutex()varcounterint64constn=10varwgsync.WaitGroupwg.Add(n)fori:=0;i<n;i++{gofunc(){deferwg.Done()unlock:=km.Lock("same-key")//Simulatecriticalsectioncurrent:=atomic.LoadInt64(&counter)time.Sleep(time.Millisecond)atomic.StoreInt64(&counter,current+1)unlock()}()}wg.Wait()ifgot:=atomic.LoadInt64(&counter);got!=int64(n){t.Errorf("expectedcounter=%d(serialized),got%d",n,got)}}funcTestKeyedMutex_CleanupAfterNoWaiters(t*testing.T){km:=middleware.NewKeyedMutex()unlock:=km.Lock("temp-key")unlock()//Afterunlockwithnowaiters,keyshouldbecleanedup//(internalimplementationdetail—justverifynopanic)unlock2:=km.Lock("temp-key")unlock2()}//──SemaphoreTests──────────────────────────────────────────funcTestSemaphore_AcquireRelease(t*testing.T){s:=middleware.NewSemaphore(3)if!s.Acquire("org-1",100*time.Millisecond){t.Fatal("firstacquireshouldsucceed")}if!s.Acquire("org-1",100*time.Millisecond){t.Fatal("secondacquireshouldsucceed")}if!s.Acquire("org-1",100*time.Millisecond){t.Fatal("thirdacquireshouldsucceed")}//4thshouldfail(limit=3)ifs.Acquire("org-1",50*time.Millisecond){t.Error("4thacquireshouldfail—limitis3")}//Releaseone,thenacquireshouldsucceeds.Release("org-1")if!s.Acquire("org-1",100*time.Millisecond){t.Error("acquireafterreleaseshouldsucceed")}}funcTestSemaphore_PerKeyIsolation(t*testing.T){s:=middleware.NewSemaphore(1)if!s.Acquire("org-a",50*time.Millisecond){t.Fatal("org-ashouldacquire")}//org-bhasitsownlimitif!s.Acquire("org-b",50*time.Millisecond){t.Error("org-bshouldnotbeblockedbyorg-a")}s.Release("org-a")s.Release("org-b")}funcTestSemaphore_ActiveCount(t*testing.T){s:=middleware.NewSemaphore(10)ifcount:=s.ActiveCount("org-x");count!=0{t.Errorf("expected0active,got%d",count)}s.Acquire("org-x",50*time.Millisecond)s.Acquire("org-x",50*time.Millisecond)ifcount:=s.ActiveCount("org-x");count!=2{t.Errorf("expected2active,got%d",count)}s.Release("org-x")ifcount:=s.ActiveCount("org-x");count!=1{t.Errorf("expected1activeafterrelease,got%d",count)}}funcTestSemaphore_DefaultLimit(t*testing.T){//Zerolimitshoulddefaultto100s:=middleware.NewSemaphore(0)fori:=0;i<100;i++{if!s.Acquire("default-test",10*time.Millisecond){t.Fatalf("acquire%dshouldsucceedwithdefaultlimit",i)}}//101stshouldfailifs.Acquire("default-test",10*time.Millisecond){t.Error("101stacquireshouldfailwithdefaultlimitof100")}}funcTestSemaphore_ReleaseUnacquired(t*testing.T){s:=middleware.NewSemaphore(5)//Releaseonnon-existentkeyshouldnotpanics.Release("never-acquired")}//──DeduplicatorTests───────────────────────────────────────funcTestFingerprint_Deterministic(t*testing.T){fp1:=middleware.Fingerprint("key1","gpt-4","hash-abc")fp2:=middleware.Fingerprint("key1","gpt-4","hash-abc")iffp1!=fp2{t.Errorf("sameinputsshouldproducesamefingerprint:%q!=%q",fp1,fp2)}}funcTestFingerprint_DifferentInputs(t*testing.T){fp1:=middleware.Fingerprint("key1","gpt-4","hash-abc")fp2:=middleware.Fingerprint("key2","gpt-4","hash-abc")fp3:=middleware.Fingerprint("key1","claude-3","hash-abc")fp4:=middleware.Fingerprint("key1","gpt-4","hash-xyz")iffp1==fp2||fp1==fp3||fp1==fp4{t.Error("differentinputsshouldproducedifferentfingerprints")}}funcTestDeduplicator_NewRequest(t*testing.T){d:=middleware.NewDeduplicator()entry,isNew:=d.TryStart("fp-new")if!isNew{t.Fatal("firstrequestshouldbenew")}ifentry==nil{t.Fatal("entryshouldnotbenil")}d.Complete("fp-new",[]byte("response"),200,nil)}funcTestDeduplicator_DuplicateRequest(t*testing.T){d:=middleware.NewDeduplicator()//Startfirstrequest_,isNew:=d.TryStart("fp-dup")if!isNew{t.Fatal("firstshouldbenew")}//Secondrequestwithsamefingerprint_,isNew2:=d.TryStart("fp-dup")ifisNew2{t.Error("duplicaterequestshouldnotbenew")}d.Complete("fp-dup",[]byte("response"),200,nil)}funcTestDeduplicator_InFlightCount(t*testing.T){d:=middleware.NewDeduplicator()ifcount:=d.InFlightCount();count!=0{t.Errorf("expected0inflight,got%d",count)}d.TryStart("fp-1")d.TryStart("fp-2")ifcount:=d.InFlightCount();count!=2{t.Errorf("expected2inflight,got%d",count)}d.Complete("fp-1",nil,200,nil)ifcount:=d.InFlightCount();count!=1{t.Errorf("expected1inflightaftercomplete,got%d",count)}}funcTestDeduplicator_CompleteNotifiesWaiters(t*testing.T){d:=middleware.NewDeduplicator()_,_=d.TryStart("fp-wait")_,isNew:=d.TryStart("fp-wait")ifisNew{t.Fatal("secondshouldnotbenew")}//Completeshouldnotpanicd.Complete("fp-wait",[]byte("done"),200,nil)//Aftercompletion,inflightcountshouldbe0ifcount:=d.InFlightCount();count!=0{t.Errorf("expected0inflightaftercomplete,got%d",count)}}//──AtomicCounterTests──────────────────────────────────────funcTestAtomicCounter_Inc(t*testing.T){varcmiddleware.AtomicCounterifv:=c.Inc();v!=1{t.Errorf("expected1,got%d",v)}ifv:=c.Inc();v!=2{t.Errorf("expected2,got%d",v)}}funcTestAtomicCounter_Add(t*testing.T){varcmiddleware.AtomicCounterifv:=c.Add(10);v!=10{t.Errorf("expected10,got%d",v)}ifv:=c.Add(5);v!=15{t.Errorf("expected15,got%d",v)}}funcTestAtomicCounter_Get(t*testing.T){varcmiddleware.AtomicCounterc.Add(42)ifv:=c.Get();v!=42{t.Errorf("expected42,got%d",v)}}funcTestAtomicCounter_Reset(t*testing.T){varcmiddleware.AtomicCounterc.Add(100)old:=c.Reset()ifold!=100{t.Errorf("expectedold=100,got%d",old)}ifv:=c.Get();v!=0{t.Errorf("expected0afterreset,got%d",v)}}funcTestAtomicCounter_ConcurrentAccess(t*testing.T){varcmiddleware.AtomicCounterconstgoroutines=100constiterations=1000varwgsync.WaitGroupwg.Add(goroutines)fori:=0;i<goroutines;i++{gofunc(){deferwg.Done()forj:=0;j<iterations;j++{c.Inc()}}()}wg.Wait()expected:=int64(goroutines*iterations)ifgot:=c.Get();got!=expected{t.Errorf("expected%d,got%d(racecondition?)",expected,got)}}//──ConcurrencyGuardMiddlewareTests─────────────────────────funcTestConcurrencyGuard_AllowsWithinLimit(t*testing.T){cg:=middleware.NewConcurrencyGuard(10,1*time.Second,zerolog.Nop())handler:=cg.Middleware(okHandler)req:=httptest.NewRequest("GET","/test",nil)req.Header.Set("X-Alfred-Org-ID","org-test")rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)ifrr.Code!=http.StatusOK{t.Errorf("expected200,got%d",rr.Code)}}funcTestConcurrencyGuard_RejectsOverLimit(t*testing.T){cg:=middleware.NewConcurrencyGuard(1,50*time.Millisecond,zerolog.Nop())//CreateaslowhandlertoholdthesemaphoreslowHandler:=http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){time.Sleep(200*time.Millisecond)w.WriteHeader(http.StatusOK)})handler:=cg.Middleware(slowHandler)//Startfirstrequest(holdstheslot)varwgsync.WaitGroupwg.Add(1)gofunc(){deferwg.Done()req:=httptest.NewRequest("GET","/test",nil)req.Header.Set("X-Alfred-Org-ID","org-limit")rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)}()//Givefirstrequesttimetoacquiretime.Sleep(20*time.Millisecond)//Secondrequestshouldberejectedreq:=httptest.NewRequest("GET","/test",nil)req.Header.Set("X-Alfred-Org-ID","org-limit")rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)ifrr.Code!=http.StatusTooManyRequests{t.Errorf("expected429,got%d",rr.Code)}wg.Wait()}funcTestConcurrencyGuard_DefaultOrgKey(t*testing.T){cg:=middleware.NewConcurrencyGuard(100,1*time.Second,zerolog.Nop())handler:=cg.Middleware(okHandler)//Noorgheader,noAPIkey→shoulduse"default"req:=httptest.NewRequest("GET","/test",nil)rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)ifrr.Code!=http.StatusOK{t.Errorf("expected200,got%d",rr.Code)}}funcTestConcurrencyGuard_Stats(t*testing.T){cg:=middleware.NewConcurrencyGuard(50,1*time.Second,zerolog.Nop())stats:=cg.Stats()iflimit,ok:=stats["configured_limit"];!ok||limit!=50{t.Errorf("expectedconfigured_limit=50,got%v",stats)}}//──GetConcurrencyActive─────────────────────────────────────funcTestGetConcurrencyActive_FromContext(t*testing.T){cg:=middleware.NewConcurrencyGuard(100,1*time.Second,zerolog.Nop())varcapturedinthandler:=cg.Middleware(http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){captured=middleware.GetConcurrencyActive(r.Context())w.WriteHeader(http.StatusOK)}))req:=httptest.NewRequest("GET","/test",nil)req.Header.Set("X-Alfred-Org-ID","active-test")rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)//Shouldhaveatleast1active(thisrequest)ifcaptured<0{t.Errorf("expectednon-negativeactivecount,got%d",captured)}}