packagemiddleware_testimport("context""net/http""net/http/httptest""testing""time""github.com/AlfredDev/alfred/services/gateway/middleware""github.com/rs/zerolog")//okHandlerwrites200OKwiththeapi_keyfromcontext.varokHandler=http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){key:=middleware.GetAPIKey(r.Context())w.Write([]byte("ok:"+key))})funcnewTestAuthMiddleware()*middleware.AuthMiddleware{logger:=zerolog.Nop()returnmiddleware.NewAuthMiddleware(logger,"")}//──HeaderExtractionTests─────────────────────────────────funcTestAuthMiddleware_MissingHeader(t*testing.T){am:=newTestAuthMiddleware()handler:=am.Handler(okHandler)req:=httptest.NewRequest("GET","/v1/chat/completions",nil)rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)ifrr.Code!=http.StatusUnauthorized{t.Errorf("expected401,got%d",rr.Code)}ifbody:=rr.Body.String();body==""{t.Error("expectederrorbody,gotemptyresponse")}}funcTestAuthMiddleware_EmptyBearerToken(t*testing.T){am:=newTestAuthMiddleware()handler:=am.Handler(okHandler)req:=httptest.NewRequest("GET","/v1/chat/completions",nil)req.Header.Set("Authorization","Bearer")rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)ifrr.Code!=http.StatusUnauthorized{t.Errorf("expected401,got%d",rr.Code)}}funcTestAuthMiddleware_ValidBearerToken(t*testing.T){am:=newTestAuthMiddleware()handler:=am.Handler(okHandler)req:=httptest.NewRequest("GET","/v1/chat/completions",nil)req.Header.Set("Authorization","Bearersk-test-key-12345")rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)ifrr.Code!=http.StatusOK{t.Errorf("expected200,got%d",rr.Code)}ifbody:=rr.Body.String();body!="ok:sk-test-key-12345"{t.Errorf("expected'ok:sk-test-key-12345',got%q",body)}}funcTestAuthMiddleware_RawKeyWithoutBearerPrefix(t*testing.T){am:=newTestAuthMiddleware()handler:=am.Handler(okHandler)req:=httptest.NewRequest("GET","/test",nil)req.Header.Set("Authorization","sk-raw-api-key")rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)ifrr.Code!=http.StatusOK{t.Errorf("expected200,got%d",rr.Code)}ifbody:=rr.Body.String();body!="ok:sk-raw-api-key"{t.Errorf("expected'ok:sk-raw-api-key',got%q",body)}}funcTestAuthMiddleware_CaseInsensitiveBearerPrefix(t*testing.T){am:=newTestAuthMiddleware()handler:=am.Handler(okHandler)req:=httptest.NewRequest("GET","/test",nil)req.Header.Set("Authorization","BEARERsk-upper-case")rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)ifrr.Code!=http.StatusOK{t.Errorf("expected200,got%d",rr.Code)}ifbody:=rr.Body.String();body!="ok:sk-upper-case"{t.Errorf("expected'ok:sk-upper-case',got%q",body)}}//──CustomHeaderKey────────────────────────────────────────funcTestAuthMiddleware_CustomHeaderKey(t*testing.T){logger:=zerolog.Nop()am:=middleware.NewAuthMiddleware(logger,"X-API-Key")handler:=am.Handler(okHandler)req:=httptest.NewRequest("GET","/test",nil)req.Header.Set("X-API-Key","custom-key-value")rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)ifrr.Code!=http.StatusOK{t.Errorf("expected200,got%d",rr.Code)}}funcTestAuthMiddleware_DefaultHeaderKey(t*testing.T){logger:=zerolog.Nop()am:=middleware.NewAuthMiddleware(logger,"")//Defaultheadershouldbe"Authorization"handler:=am.Handler(okHandler)req:=httptest.NewRequest("GET","/test",nil)req.Header.Set("Authorization","Bearerdefault-key")rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)ifrr.Code!=http.StatusOK{t.Errorf("expected200,got%d",rr.Code)}}//──CacheValidationTests───────────────────────────────────funcTestAuthMiddleware_CacheHit(t*testing.T){am:=newTestAuthMiddleware()//Pre-populatecacheam.CacheValidation("cached-key-123","user-abc")handler:=am.Handler(http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){key:=middleware.GetAPIKey(r.Context())uid:=middleware.GetUserID(r.Context())w.Write([]byte(key+":"+uid))}))req:=httptest.NewRequest("GET","/test",nil)req.Header.Set("Authorization","cached-key-123")rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)ifrr.Code!=http.StatusOK{t.Errorf("expected200,got%d",rr.Code)}ifbody:=rr.Body.String();body!="cached-key-123:user-abc"{t.Errorf("expected'cached-key-123:user-abc',got%q",body)}}funcTestAuthMiddleware_CacheExpired(t*testing.T){logger:=zerolog.Nop()am:=middleware.NewAuthMiddleware(logger,"Authorization")//Cacheakey,thencheckitworksam.CacheValidation("expired-key","user-xyz")//Wecan'teasilytestexpirationwithoutmanipulatingtime,//butwecanverifythekeyisincacheinitiallyhandler:=am.Handler(http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){uid:=middleware.GetUserID(r.Context())ifuid==""{w.Write([]byte("no-uid"))}else{w.Write([]byte("uid:"+uid))}}))req:=httptest.NewRequest("GET","/test",nil)req.Header.Set("Authorization","expired-key")rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)ifbody:=rr.Body.String();body!="uid:user-xyz"{t.Errorf("expectedcacheduserID,got%q",body)}}funcTestAuthMiddleware_CacheMultipleKeys(t*testing.T){am:=newTestAuthMiddleware()am.CacheValidation("key-1","user-1")am.CacheValidation("key-2","user-2")am.CacheValidation("key-3","user-3")for_,tc:=range[]struct{keystringexpectedstring}{{"key-1","user-1"},{"key-2","user-2"},{"key-3","user-3"},}{handler:=am.Handler(http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){uid:=middleware.GetUserID(r.Context())w.Write([]byte(uid))}))req:=httptest.NewRequest("GET","/test",nil)req.Header.Set("Authorization",tc.key)rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)ifbody:=rr.Body.String();body!=tc.expected{t.Errorf("key=%s:expected%q,got%q",tc.key,tc.expected,body)}}}//──ContextHelperTests─────────────────────────────────────funcTestGetAPIKey_FromContext(t*testing.T){ctx:=context.WithValue(context.Background(),middleware.APIKeyContextKey,"test-key")ifgot:=middleware.GetAPIKey(ctx);got!="test-key"{t.Errorf("expected'test-key',got%q",got)}}funcTestGetAPIKey_EmptyContext(t*testing.T){ifgot:=middleware.GetAPIKey(context.Background());got!=""{t.Errorf("expectedemptystring,got%q",got)}}funcTestGetUserID_FromContext(t*testing.T){ctx:=context.WithValue(context.Background(),middleware.UserIDContextKey,"user-123")ifgot:=middleware.GetUserID(ctx);got!="user-123"{t.Errorf("expected'user-123',got%q",got)}}funcTestGetUserID_EmptyContext(t*testing.T){ifgot:=middleware.GetUserID(context.Background());got!=""{t.Errorf("expectedemptystring,got%q",got)}}funcTestGetAPIKey_WrongType(t*testing.T){ctx:=context.WithValue(context.Background(),middleware.APIKeyContextKey,12345)ifgot:=middleware.GetAPIKey(ctx);got!=""{t.Errorf("expectedemptystringforwrongtype,got%q",got)}}//──ErrorResponseTests─────────────────────────────────────funcTestAuthMiddleware_ErrorResponseFormat(t*testing.T){am:=newTestAuthMiddleware()handler:=am.Handler(okHandler)req:=httptest.NewRequest("POST","/v1/chat/completions",nil)rr:=httptest.NewRecorder()handler.ServeHTTP(rr,req)ifct:=rr.Header().Get("Content-Type");ct==""{//http.Errorsetstext/plainbydefault}ifrr.Code!=http.StatusUnauthorized{t.Errorf("expected401,got%d",rr.Code)}}//──ConcurrencySafety───────────────────────────────────────funcTestAuthMiddleware_ConcurrentCacheAccess(t*testing.T){am:=newTestAuthMiddleware()//Populatecacheconcurrentlydone:=make(chanstruct{})fori:=0;i<50;i++{gofunc(nint){key:="concurrent-key-"+time.Now().String()am.CacheValidation(key,"user")<-done}(i)}close(done)}