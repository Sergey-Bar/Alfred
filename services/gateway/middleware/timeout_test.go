packagemiddleware_testimport("encoding/json""net/http""net/http/httptest""testing""time""github.com/AlfredDev/alfred/services/gateway/config""github.com/AlfredDev/alfred/services/gateway/middleware""github.com/rs/zerolog")funcnewTestConfig()*config.Config{return&config.Config{DefaultTimeout:30*time.Second,ProviderTimeouts:map[string]time.Duration{"openai":120*time.Second,"anthropic":90*time.Second,"groq":15*time.Second,},}}funcTestTimeoutMiddleware_PassesThrough_WhenNoTimeout(t*testing.T){cfg:=newTestConfig()cfg.DefaultTimeout=0//disabledefaulttimeouttm:=middleware.NewTimeoutMiddleware(zerolog.Nop(),cfg)handler:=tm.Handler(http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){w.WriteHeader(http.StatusOK)w.Write([]byte(`{"ok":true}`))}))req:=httptest.NewRequest("GET","/v1/models",nil)rec:=httptest.NewRecorder()handler.ServeHTTP(rec,req)ifrec.Code!=http.StatusOK{t.Errorf("expected200,got%d",rec.Code)}}funcTestTimeoutMiddleware_UsesHeaderTimeout(t*testing.T){cfg:=newTestConfig()tm:=middleware.NewTimeoutMiddleware(zerolog.Nop(),cfg)handler:=tm.Handler(http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){//Verifycontexthasadeadlinedeadline,ok:=r.Context().Deadline()if!ok{t.Error("expectedcontexttohavedeadlinefromX-Alfred-Timeoutheader")return}remaining:=time.Until(deadline)//Headersays10s,shouldbecloseto10s(minusprocessingtime)ifremaining>11*time.Second||remaining<8*time.Second{t.Errorf("expected~10sdeadline,got%v",remaining)}w.WriteHeader(http.StatusOK)}))req:=httptest.NewRequest("POST","/v1/chat/completions",nil)req.Header.Set("X-Alfred-Timeout","10")rec:=httptest.NewRecorder()handler.ServeHTTP(rec,req)}funcTestTimeoutMiddleware_CapsHeaderTimeoutAt5Min(t*testing.T){cfg:=newTestConfig()tm:=middleware.NewTimeoutMiddleware(zerolog.Nop(),cfg)handler:=tm.Handler(http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){deadline,ok:=r.Context().Deadline()if!ok{t.Error("expectedcontexttohavedeadline")return}remaining:=time.Until(deadline)//600srequested,cappedto300sifremaining>301*time.Second{t.Errorf("expectedtimeoutcappedat5min,got%v",remaining)}w.WriteHeader(http.StatusOK)}))req:=httptest.NewRequest("POST","/v1/chat/completions",nil)req.Header.Set("X-Alfred-Timeout","600")//10minutes,shouldbecappedrec:=httptest.NewRecorder()handler.ServeHTTP(rec,req)}funcTestTimeoutMiddleware_ReturnsGatewayTimeout(t*testing.T){cfg:=newTestConfig()cfg.DefaultTimeout=50*time.Millisecond//veryshorttimeouttm:=middleware.NewTimeoutMiddleware(zerolog.Nop(),cfg)handler:=tm.Handler(http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){//Simulateslowhandlerselect{case<-r.Context().Done():returncase<-time.After(5*time.Second):w.WriteHeader(http.StatusOK)}}))req:=httptest.NewRequest("GET","/v1/models",nil)rec:=httptest.NewRecorder()handler.ServeHTTP(rec,req)ifrec.Code!=http.StatusGatewayTimeout{t.Errorf("expected504GatewayTimeout,got%d",rec.Code)}//VerifyJSONerrorresponsevarbodymap[string]interface{}iferr:=json.Unmarshal(rec.Body.Bytes(),&body);err!=nil{t.Fatalf("responsebodyisnotvalidJSON:%v",err)}if_,ok:=body["error"];!ok{t.Error("expected'error'fieldintimeoutresponse")}}funcTestTimeoutMiddleware_ProviderTimeout_ViaQueryParam(t*testing.T){cfg:=newTestConfig()tm:=middleware.NewTimeoutMiddleware(zerolog.Nop(),cfg)handler:=tm.Handler(http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){deadline,ok:=r.Context().Deadline()if!ok{t.Error("expectedcontexttohavedeadlinefromproviderconfig")return}remaining:=time.Until(deadline)//groqtimeout=15sifremaining>16*time.Second||remaining<13*time.Second{t.Errorf("expected~15sdeadlineforgroq,got%v",remaining)}w.WriteHeader(http.StatusOK)}))req:=httptest.NewRequest("POST","/v1/chat/completions?provider=groq",nil)rec:=httptest.NewRecorder()handler.ServeHTTP(rec,req)}funcTestTimeoutMiddleware_InvalidHeaderIgnored(t*testing.T){cfg:=newTestConfig()tm:=middleware.NewTimeoutMiddleware(zerolog.Nop(),cfg)handler:=tm.Handler(http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){deadline,ok:=r.Context().Deadline()if!ok{//WithdefaultTimeout=30s,thereshouldbeadeadlinet.Error("expectedcontexttohavedeadlinefromdefaultconfig")return}remaining:=time.Until(deadline)ifremaining>31*time.Second||remaining<28*time.Second{t.Errorf("expected~30sdefaultdeadline,got%v",remaining)}w.WriteHeader(http.StatusOK)}))req:=httptest.NewRequest("POST","/v1/chat/completions",nil)req.Header.Set("X-Alfred-Timeout","not-a-number")rec:=httptest.NewRecorder()handler.ServeHTTP(rec,req)}funcTestTimeoutMiddleware_NegativeHeaderIgnored(t*testing.T){cfg:=newTestConfig()tm:=middleware.NewTimeoutMiddleware(zerolog.Nop(),cfg)handler:=tm.Handler(http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){w.WriteHeader(http.StatusOK)}))req:=httptest.NewRequest("POST","/v1/chat/completions",nil)req.Header.Set("X-Alfred-Timeout","-5")rec:=httptest.NewRecorder()handler.ServeHTTP(rec,req)ifrec.Code!=http.StatusOK{t.Errorf("expected200withnegativetimeoutignored,got%d",rec.Code)}}