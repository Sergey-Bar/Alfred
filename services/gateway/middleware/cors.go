packagemiddlewareimport("math/rand""net/http""strconv""time")//CORSMiddlewarehandlesCross-OriginResourceSharing.funcCORSMiddleware(allowedOrigins[]string)func(http.Handler)http.Handler{originsMap:=make(map[string]bool)allowAll:=falsefor_,o:=rangeallowedOrigins{ifo=="*"{allowAll=true}originsMap[o]=true}returnfunc(nexthttp.Handler)http.Handler{returnhttp.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){origin:=r.Header.Get("Origin")ifallowAll||originsMap[origin]{w.Header().Set("Access-Control-Allow-Origin",origin)}w.Header().Set("Access-Control-Allow-Methods","GET,POST,PUT,PATCH,DELETE,OPTIONS")w.Header().Set("Access-Control-Allow-Headers","Accept,Authorization,Content-Type,X-Request-ID,X-Project-Priority,X-Alfred-Model")w.Header().Set("Access-Control-Expose-Headers","X-Request-ID,X-RateLimit-Limit,X-RateLimit-Remaining,X-RateLimit-Reset,X-Alfred-Model")w.Header().Set("Access-Control-Max-Age","3600")//OnlysetAllow-CredentialswhenoriginisNOTwildcard//(specforbidscredentialswithwildcardorigin)if!allowAll{w.Header().Set("Access-Control-Allow-Credentials","true")}ifr.Method==http.MethodOptions{w.WriteHeader(http.StatusNoContent)return}next.ServeHTTP(w,r)})}}//SecurityHeadersMiddlewareaddsstandardsecurityheaders.funcSecurityHeadersMiddleware(nexthttp.Handler)http.Handler{returnhttp.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){w.Header().Set("X-Content-Type-Options","nosniff")w.Header().Set("X-Frame-Options","DENY")w.Header().Set("X-XSS-Protection","1;mode=block")w.Header().Set("Referrer-Policy","strict-origin-when-cross-origin")w.Header().Set("Strict-Transport-Security","max-age=31536000;includeSubDomains")w.Header().Set("Content-Security-Policy","default-src'self'")next.ServeHTTP(w,r)})}//RequestIDMiddlewareensureseveryrequesthasacorrelationID.funcRequestIDMiddleware(nexthttp.Handler)http.Handler{returnhttp.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){reqID:=r.Header.Get("X-Request-ID")ifreqID==""{reqID=generateRequestID()}w.Header().Set("X-Request-ID",reqID)r.Header.Set("X-Request-ID",reqID)next.ServeHTTP(w,r)})}//T208:Usestrconv.AppendIntwithastack-allocatedbuffer(avoidsfmt.Sprintfalloc)funcgenerateRequestID()string{varbuf[32]byteb:=buf[:0]b=append(b,"gw-"...)b=strconv.AppendInt(b,time.Now().UnixMilli(),10)b=append(b,'-')n:=rand.Intn(999999)//Zero-padto6digitsifn<100000{b=append(b,'0')}ifn<10000{b=append(b,'0')}ifn<1000{b=append(b,'0')}ifn<100{b=append(b,'0')}ifn<10{b=append(b,'0')}b=strconv.AppendInt(b,int64(n),10)returnstring(b)}