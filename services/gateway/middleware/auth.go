packagemiddlewareimport("context""net/http""strings""sync""time""github.com/rs/zerolog")typecontextKeystringconst(//APIKeyContextKeystoresthevalidatedAPIkeyinrequestcontext.APIKeyContextKeycontextKey="api_key"//UserIDContextKeystorestheauthenticateduserIDinrequestcontext.UserIDContextKeycontextKey="user_id")//AuthMiddlewarevalidatesAPIkeysonincomingrequests.typeAuthMiddlewarestruct{loggerzerolog.Loggercachesync.Map//simplein-memorycacheforvalidatedkeyscacheTTLtime.DurationheaderKeystring}typecachedAuthstruct{userIDstringexpiresAttime.Time}//NewAuthMiddlewarecreatesanewauthenticationmiddleware.funcNewAuthMiddleware(loggerzerolog.Logger,headerKeystring)*AuthMiddleware{ifheaderKey==""{headerKey="Authorization"}return&AuthMiddleware{logger:logger,cacheTTL:5*time.Minute,headerKey:headerKey,}}//Handlerreturnsthemiddlewarehandlerfunction.func(am*AuthMiddleware)Handler(nexthttp.Handler)http.Handler{returnhttp.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){//ExtractAPIkeyfromheaderauthHeader:=r.Header.Get(am.headerKey)ifauthHeader==""{http.Error(w,`{"error":"missingauthentication","message":"Authorizationheaderrequired"}`,http.StatusUnauthorized)return}apiKey:=authHeader//T208:useEqualFoldinsteadofToLower(avoidsstringalloc)iflen(authHeader)>=7&&strings.EqualFold(authHeader[:7],"bearer"){apiKey=authHeader[7:]}ifapiKey==""{http.Error(w,`{"error":"invalidauthentication","message":"APIkeycannotbeempty"}`,http.StatusUnauthorized)return}//Checkcachefirstifcached,ok:=am.cache.Load(apiKey);ok{ca:=cached.(*cachedAuth)iftime.Now().Before(ca.expiresAt){ctx:=context.WithValue(r.Context(),APIKeyContextKey,apiKey)ctx=context.WithValue(ctx,UserIDContextKey,ca.userID)next.ServeHTTP(w,r.WithContext(ctx))return}am.cache.Delete(apiKey)}//Fornow,passtheAPIkeydownstreamâ€”thebackendvalidatesit.//Inproduction,we'dvalidateagainstalocalDBorthebackend/v1/users/me.ctx:=context.WithValue(r.Context(),APIKeyContextKey,apiKey)next.ServeHTTP(w,r.WithContext(ctx))})}//CacheValidationstoresavalidatedkeyinthelocalcache.func(am*AuthMiddleware)CacheValidation(apiKey,userIDstring){am.cache.Store(apiKey,&cachedAuth{userID:userID,expiresAt:time.Now().Add(am.cacheTTL),})}//GetAPIKeyextractstheAPIkeyfromtherequestcontext.funcGetAPIKey(ctxcontext.Context)string{ifv,ok:=ctx.Value(APIKeyContextKey).(string);ok{returnv}return""}//GetUserIDextractstheuserIDfromtherequestcontext.funcGetUserID(ctxcontext.Context)string{ifv,ok:=ctx.Value(UserIDContextKey).(string);ok{returnv}return""}