packagemiddlewareimport("net/http""strings""github.com/rs/zerolog")//HeaderNormalizationperformsrequestandresponseheadernormalization.typeHeaderNormalizationstruct{loggerzerolog.Logger}//NewHeaderNormalizationcreatesanewheadernormalizationmiddleware.funcNewHeaderNormalization(loggerzerolog.Logger)*HeaderNormalization{return&HeaderNormalization{logger:logger}}//headersToStripFromRequestareprovider-specificheadersthatclients//shouldnotsetdirectly—Alfredmanagesthese.varheadersToStripFromRequest=[]string{"x-api-key",//Anthropicauth—managedbygateway"anthropic-version",//AnthropicAPIversion—managedbyconnector"anthropic-beta",//Anthropicbetafeatures"openai-organization",//OpenAIorg—managedperkey"openai-project",//OpenAIproject"helicone-auth",//Third-partyproxyheaders"x-stainless-lang",//SDKtelemetry"x-stainless-os",//SDKtelemetry"x-stainless-runtime",//SDKtelemetry"x-stainless-arch",//SDKtelemetry"x-stainless-package-version",//SDKtelemetry}//headersToStripFromResponseareupstreamheadersthatshouldnot//leaktotheclient.varheadersToStripFromResponse=[]string{"x-api-key","anthropic-version","openai-organization","openai-processing-ms","x-ratelimit-limit-requests","x-ratelimit-limit-tokens","x-ratelimit-remaining-requests","x-ratelimit-remaining-tokens","x-ratelimit-reset-requests","x-ratelimit-reset-tokens","cf-ray",//Cloudflareheaders"cf-cache-status","server",//Don'tleakprovider'sserversoftware"x-request-id",//Provider'sinternalrequestID}//alfredResponseHeadersareheadersAlfredalwayssetsonresponses.varalfredResponseHeaders=map[string]string{"X-Alfred-Gateway":"true","X-Powered-By":"AlfredAIGateway",}//HandlerreturnstheHTTPmiddlewarehandler.func(h*HeaderNormalization)Handler(nexthttp.Handler)http.Handler{returnhttp.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){//===Requestnormalization===//Stripprovider-specificheadersthatclientsshouldn'tsend.for_,header:=rangeheadersToStripFromRequest{ifr.Header.Get(header)!=""{h.logger.Debug().Str("header",header).Str("path",r.URL.Path).Msg("strippedproviderheaderfromrequest")r.Header.Del(header)}}//Normalizecontent-typeforJSONbodies.ct:=r.Header.Get("Content-Type")ifct!=""&&strings.Contains(ct,"json")&&ct!="application/json"{r.Header.Set("Content-Type","application/json")}//EnsureAcceptheaderissetforAPIrequests.ifr.Header.Get("Accept")==""{r.Header.Set("Accept","application/json")}//Propagatetracecontextifpresent.//(CorrelationIDishandledbytherouter,thisjustensures//standardW3CTraceContextheaderspassthrough.)//===Responsenormalizationviawrapper===wrapped:=&headerNormWriter{ResponseWriter:w,logger:h.logger,}next.ServeHTTP(wrapped,r)})}//headerNormWriterwrapshttp.ResponseWritertonormalizeresponseheaders.typeheaderNormWriterstruct{http.ResponseWriterloggerzerolog.LoggerwroteHeaderbool}func(hw*headerNormWriter)WriteHeader(codeint){ifhw.wroteHeader{return}hw.wroteHeader=true//Stripupstreamproviderheaders.for_,header:=rangeheadersToStripFromResponse{hw.ResponseWriter.Header().Del(header)}//SetAlfredstandardheaders.fork,v:=rangealfredResponseHeaders{hw.ResponseWriter.Header().Set(k,v)}hw.ResponseWriter.WriteHeader(code)}func(hw*headerNormWriter)Write(b[]byte)(int,error){if!hw.wroteHeader{hw.WriteHeader(http.StatusOK)}returnhw.ResponseWriter.Write(b)}//Flushsupportsstreamingbydelegatingtotheunderlyingwriter.func(hw*headerNormWriter)Flush(){iff,ok:=hw.ResponseWriter.(http.Flusher);ok{f.Flush()}}