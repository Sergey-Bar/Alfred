packagemiddlewareimport("context""crypto/sha256""encoding/hex""fmt""hash""net/http""sync""sync/atomic""time""github.com/rs/zerolog")//T208:PooledSHA-256hasherstoavoidper-requestallocationofhashstate.varhasherPool=sync.Pool{New:func()any{returnsha256.New()},}//──────────────────────────────────────────────────────────────//1.Per-KeyMutex—serializewalletmutationsforsameorg/user//──────────────────────────────────────────────────────────────//KeyedMutexprovidesper-keylockingtoserializeaccesstoshared//resources(e.g.,walletbalances)withoutagloballock.//Thispreventsdouble-spendonconcurrentrequestsfromthesameuser.typeKeyedMutexstruct{musync.Mutexlocksmap[string]*keyEntry}typekeyEntrystruct{musync.Mutexwaitersint32}//NewKeyedMutexcreatesanewper-keymutexmanager.funcNewKeyedMutex()*KeyedMutex{return&KeyedMutex{locks:make(map[string]*keyEntry),}}//Lockacquiresalockforthegivenkey.Returnsanunlockfunction.func(km*KeyedMutex)Lock(keystring)func(){km.mu.Lock()entry,ok:=km.locks[key]if!ok{entry=&keyEntry{}km.locks[key]=entry}atomic.AddInt32(&entry.waiters,1)km.mu.Unlock()entry.mu.Lock()returnfunc(){entry.mu.Unlock()km.mu.Lock()ifatomic.AddInt32(&entry.waiters,-1)==0{delete(km.locks,key)}km.mu.Unlock()}}//──────────────────────────────────────────────────────────────//2.Semaphore—per-orgconcurrencylimiting//──────────────────────────────────────────────────────────────//Semaphoreprovidesboundedconcurrencycontrolperkey(org/team).//Thispreventsanysingletenantfrommonopolizinggatewaycapacity.typeSemaphorestruct{musync.Mutexsemasmap[string]chanstruct{}limitint}//NewSemaphorecreatesanewper-keysemaphorewiththegivenconcurrencylimit.funcNewSemaphore(limitint)*Semaphore{iflimit<=0{limit=100//default}return&Semaphore{semas:make(map[string]chanstruct{}),limit:limit,}}//Acquireattemptstoacquireaslotforthegivenkey.//Returnstrueifacquired,falseifthelimitisreached.//ThecallermustcallReleasewhendone.func(s*Semaphore)Acquire(keystring,timeouttime.Duration)bool{s.mu.Lock()ch,ok:=s.semas[key]if!ok{ch=make(chanstruct{},s.limit)s.semas[key]=ch}s.mu.Unlock()select{casech<-struct{}{}:returntruecase<-time.After(timeout):returnfalse}}//Releasereleasesaslotforthegivenkey.func(s*Semaphore)Release(keystring){s.mu.Lock()ch,ok:=s.semas[key]s.mu.Unlock()ifok{select{case<-ch:default:}}}//ActiveCountreturnsthenumberofactiverequestsforakey.func(s*Semaphore)ActiveCount(keystring)int{s.mu.Lock()ch,ok:=s.semas[key]s.mu.Unlock()if!ok{return0}returnlen(ch)}//──────────────────────────────────────────────────────────────//3.RequestDeduplication—preventduplicatein-flightrequests//──────────────────────────────────────────────────────────────//Deduplicatorpreventsduplicatein-flightrequestsbyfingerprinting//requestcontentandcollapsingidenticalconcurrentrequestsintoone.typeDeduplicatorstruct{musync.Mutexinflightmap[string]*inflightEntry}typeinflightEntrystruct{donechanstruct{}resp[]bytecodeinterrerror}//NewDeduplicatorcreatesanewrequestdeduplicator.funcNewDeduplicator()*Deduplicator{return&Deduplicator{inflight:make(map[string]*inflightEntry),}}//Fingerprintgeneratesarequestfingerprintfromkeyfields.//T208:Usespooledhasher+stack-allocatedhexbuffer.funcFingerprint(apiKey,model,contentHashstring)string{h:=hasherPool.Get().(hash.Hash)h.Reset()h.Write([]byte(apiKey))h.Write([]byte{'|'})h.Write([]byte(model))h.Write([]byte{'|'})h.Write([]byte(contentHash))varsum[32]byteh.Sum(sum[:0])hasherPool.Put(h)//Encodefirst16bytestohexusingstackbuffervarhexBuf[32]bytehex.Encode(hexBuf[:],sum[:16])returnstring(hexBuf[:32])//128-bitfingerprint}//TryStartchecksifanidenticalrequestisalreadyin-flight.//Returns(entry,isNew).IfisNewisfalse,waitonentry.done.func(d*Deduplicator)TryStart(fingerprintstring)(*inflightEntry,bool){d.mu.Lock()deferd.mu.Unlock()ifentry,exists:=d.inflight[fingerprint];exists{returnentry,false}entry:=&inflightEntry{done:make(chanstruct{}),}d.inflight[fingerprint]=entryreturnentry,true}//Completemarksarequestasfinishedandremovesitfromtracking.func(d*Deduplicator)Complete(fingerprintstring,resp[]byte,codeint,errerror){d.mu.Lock()entry,exists:=d.inflight[fingerprint]delete(d.inflight,fingerprint)d.mu.Unlock()ifexists{entry.resp=respentry.code=codeentry.err=errclose(entry.done)}}//InFlightCountreturnsthenumberofin-flightdeduplicatedrequests.func(d*Deduplicator)InFlightCount()int{d.mu.Lock()deferd.mu.Unlock()returnlen(d.inflight)}//──────────────────────────────────────────────────────────────//4.AtomicCounters—thread-saferequest/costtracking//──────────────────────────────────────────────────────────────//AtomicCounterprovidesathread-safecounterusingatomicoperations.typeAtomicCounterstruct{valueint64}//Incincrementsthecounterby1andreturnsthenewvalue.func(c*AtomicCounter)Inc()int64{returnatomic.AddInt64(&c.value,1)}//Addincrementsthecounterbynandreturnsthenewvalue.func(c*AtomicCounter)Add(nint64)int64{returnatomic.AddInt64(&c.value,n)}//Getreturnsthecurrentvalue.func(c*AtomicCounter)Get()int64{returnatomic.LoadInt64(&c.value)}//Resetsetsthecounterto0andreturnstheoldvalue.func(c*AtomicCounter)Reset()int64{returnatomic.SwapInt64(&c.value,0)}//──────────────────────────────────────────────────────────────//5.ConcurrencyMiddleware—chi-compatibleHTTPmiddleware//──────────────────────────────────────────────────────────────//ConcurrencyGuardisthecombinedconcurrencycontrolmiddleware.typeConcurrencyGuardstruct{semaphore*Semaphoreloggerzerolog.Loggertimeouttime.Duration}//NewConcurrencyGuardcreatesanewconcurrencyguardmiddleware.funcNewConcurrencyGuard(maxConcurrentPerOrgint,timeouttime.Duration,loggerzerolog.Logger)*ConcurrencyGuard{return&ConcurrencyGuard{semaphore:NewSemaphore(maxConcurrentPerOrg),logger:logger,timeout:timeout,}}//Middlewarereturnsanhttp.Handlermiddlewarethatenforcesper-org//concurrencylimits.Iftheorgexceedsthelimit,requestsgeta429.func(cg*ConcurrencyGuard)Middleware(nexthttp.Handler)http.Handler{returnhttp.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){//Extractorgkeyfromcontext(setbyauthmiddleware)orgKey:=extractOrgKey(r)iforgKey==""{orgKey="default"}//Trytoacquireaslotif!cg.semaphore.Acquire(orgKey,cg.timeout){cg.logger.Warn().Str("org",orgKey).Int("active",cg.semaphore.ActiveCount(orgKey)).Msg("concurrencylimitreached—rejectingrequest")w.Header().Set("Content-Type","application/json")w.Header().Set("Retry-After","1")w.WriteHeader(http.StatusTooManyRequests)fmt.Fprintf(w,`{"error":{"type":"rate_limit","message":"Toomanyconcurrentrequestsforthisorganization"}}`)return}defercg.semaphore.Release(orgKey)//Injectactivecountintocontextfordownstreamloggingctx:=context.WithValue(r.Context(),concurrencyActiveKey,cg.semaphore.ActiveCount(orgKey))next.ServeHTTP(w,r.WithContext(ctx))})}//Statsreturnscurrentconcurrencystatistics.func(cg*ConcurrencyGuard)Stats()map[string]int{//Returncurrentsemaphorestate—inproductionthiswould//iteratetrackedkeys.Fornowreturnaggregatemetrics.returnmap[string]int{"configured_limit":cg.semaphore.limit,}}constconcurrencyActiveKeycontextKey="concurrency_active"//extractOrgKeygetstheorgidentifierfromtherequestforconcurrencybucketing.funcextractOrgKey(r*http.Request)string{//Tryorgfromcontext(setbyauthmiddleware)iforgID:=r.Header.Get("X-Alfred-Org-ID");orgID!=""{returnorgID}//Fallback:usehashedAPIkeyprefixasorgidentifier.//T208:pooledhasher+stack-allocatedhexbufferapiKey:=GetAPIKey(r.Context())iflen(apiKey)>0{h:=hasherPool.Get().(hash.Hash)h.Reset()h.Write([]byte(apiKey))varsum[32]byteh.Sum(sum[:0])hasherPool.Put(h)varhexBuf[16]bytehex.Encode(hexBuf[:],sum[:8])return"keyhash:"+string(hexBuf[:])}return""}//GetConcurrencyActiveretrievestheactiveconcurrentrequestcount//fromtherequestcontext.funcGetConcurrencyActive(ctxcontext.Context)int{ifv,ok:=ctx.Value(concurrencyActiveKey).(int);ok{returnv}return0}