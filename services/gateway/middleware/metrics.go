packagemiddlewareimport("net/http""strconv""strings""sync""time""github.com/AlfredDev/alfred/services/gateway/observability""github.com/rs/zerolog")//MetricsMiddlewarerecordsPrometheusmetricsforeveryHTTPrequest.typeMetricsMiddlewarestruct{loggerzerolog.Loggermetrics*observability.Metrics}//NewMetricsMiddlewarecreatesanewmetricsrecordingmiddleware.funcNewMetricsMiddleware(loggerzerolog.Logger,metrics*observability.Metrics)*MetricsMiddleware{return&MetricsMiddleware{logger:logger.With().Str("component","metrics-middleware").Logger(),metrics:metrics,}}//Handlerreturnsthemiddlewarehandler.func(mm*MetricsMiddleware)Handler(nexthttp.Handler)http.Handler{returnhttp.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){ifmm.metrics==nil{next.ServeHTTP(w,r)return}start:=time.Now()//Trackactiveconnectionsmm.metrics.GaugeInc("alfred_gateway_active_connections",nil)defermm.metrics.GaugeDec("alfred_gateway_active_connections",nil)//Wrapresponsewritertocapturestatuscodeandbyteswritten//T208:PooltheresponseRecordertoavoidheapallocperrequestrw:=recorderPool.Get().(*responseRecorder)rw.ResponseWriter=wrw.statusCode=http.StatusOKrw.bytesWritten=0rw.wroteHeader=false//Servetherequestnext.ServeHTTP(rw,r)//Recordmetricsduration:=time.Since(start)durationMs:=float64(duration.Milliseconds())endpoint:=normalizeEndpoint(r.URL.Path)method:=r.Methodstatus:=strconv.Itoa(rw.statusCode)statusClass:=strconv.Itoa(rw.statusCode/100)+"xx"scInt:=rw.statusCode//capturebeforereturningtopoolbw:=rw.bytesWritten//ReturnrecordertopoolimmediatelyrecorderPool.Put(rw)labels:=map[string]string{"method":method,"endpoint":endpoint,"status":status,"status_class":statusClass,}//Requestcountermm.metrics.CounterInc("alfred_gateway_http_requests_total",labels)//Durationhistogrammm.metrics.HistogramObserve("alfred_gateway_http_request_duration_ms",labels,durationMs)//Responsesizemm.metrics.CounterAdd("alfred_gateway_http_response_bytes_total",labels,int64(bw))//Errorcounter(4xx,5xx)ifscInt>=400{mm.metrics.CounterInc("alfred_gateway_http_errors_total",labels)}//RatelimitcounterifscInt==http.StatusTooManyRequests{mm.metrics.CounterInc("alfred_gateway_rate_limited_total",map[string]string{"endpoint":endpoint,})}//AuthfailurecounterifscInt==http.StatusUnauthorized||scInt==http.StatusForbidden{mm.metrics.CounterInc("alfred_gateway_auth_failures_total",map[string]string{"endpoint":endpoint,"status":status,})}})}//recorderPoolprovidespooledresponseRecorderstructs(T208).varrecorderPool=sync.Pool{New:func()any{return&responseRecorder{}},}//responseRecorderwrapshttp.ResponseWritertocapturethestatuscodeandbyteswritten.typeresponseRecorderstruct{http.ResponseWriterstatusCodeintbytesWrittenintwroteHeaderbool}func(rr*responseRecorder)WriteHeader(codeint){if!rr.wroteHeader{rr.statusCode=coderr.wroteHeader=true}rr.ResponseWriter.WriteHeader(code)}func(rr*responseRecorder)Write(b[]byte)(int,error){if!rr.wroteHeader{rr.wroteHeader=true}n,err:=rr.ResponseWriter.Write(b)rr.bytesWritten+=nreturnn,err}//Flushimplementshttp.Flusherforstreamingresponses.func(rr*responseRecorder)Flush(){iff,ok:=rr.ResponseWriter.(http.Flusher);ok{f.Flush()}}//normalizeEndpointcollapsespathparametersintoplaceholders//toavoidhigh-cardinalitymetriclabels.funcnormalizeEndpoint(pathstring)string{//Handlewell-knownAPIroutesparts:=strings.Split(strings.Trim(path,"/"),"/")iflen(parts)==0{return"/"}//Health&metaendpointsswitchparts[0]{case"healthz","ready","health","metrics","openapi.json","docs":return"/"+parts[0]}///v1/...APIroutesifparts[0]=="v1"&&len(parts)>=2{switchparts[1]{case"chat":return"/v1/chat/completions"case"embeddings":return"/v1/embeddings"case"models":return"/v1/models"case"providers":iflen(parts)>=3{switchparts[2]{case"health","pricing","estimate":return"/v1/providers/"+parts[2]default:///v1/providers/{name}/...â†’/v1/providers/:nameiflen(parts)>=4{return"/v1/providers/:name/"+parts[3]}return"/v1/providers/:name"}}return"/v1/providers"case"cache":iflen(parts)>=3{return"/v1/cache/:id"}return"/v1/cache"case"analytics":iflen(parts)>=3{return"/v1/analytics/"+parts[2]}return"/v1/analytics"}return"/v1/"+parts[1]}return"/"+parts[0]}