packagemiddlewareimport("context""encoding/json""net/http""strconv""sync""time""github.com/AlfredDev/alfred/services/gateway/config""github.com/rs/zerolog")//TimeoutMiddlewareappliesper-providerconfigurabletimeoutstorequests.typeTimeoutMiddlewarestruct{loggerzerolog.Loggercfg*config.Config}//NewTimeoutMiddlewarecreatesanewtimeoutmiddleware.funcNewTimeoutMiddleware(loggerzerolog.Logger,cfg*config.Config)*TimeoutMiddleware{return&TimeoutMiddleware{logger:logger,cfg:cfg,}}//HandlerreturnstheHTTPmiddlewarehandler.func(t*TimeoutMiddleware)Handler(nexthttp.Handler)http.Handler{returnhttp.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){timeout:=t.resolveTimeout(r)iftimeout<=0{//Notimeout—passthrough.next.ServeHTTP(w,r)return}ctx,cancel:=context.WithTimeout(r.Context(),timeout)defercancel()//Trackwhetherthehandlercompletedortimedout.//T208:PoolthedonechannelandtimeoutWriterdone:=chanPool.Get().(chanstruct{})tw:=twPool.Get().(*timeoutWriter)tw.ResponseWriter=wtw.wroteHeader=falsetw.timedOut=falsegofunc(){next.ServeHTTP(tw,r.WithContext(ctx))//T208:Sendinsteadofclose;pooledchannelsarereuseddone<-struct{}{}}()select{case<-done://Handlercompletednormally.Checkitwasn'talsotimedout.tw.mu.Lock()alreadyTimedOut:=tw.timedOuttw.mu.Unlock()ifalreadyTimedOut{t.logger.Debug().Str("path",r.URL.Path).Msg("handlergoroutinefinishedaftertimeout")}//Returnpooledresources(drainchannelfirst)select{case<-done:default:}twPool.Put(tw)chanPool.Put(done)returncase<-ctx.Done()://Contextdeadlineexceeded—marktimedOuttosuppressfurther//writesfromthestill-runninghandlergoroutine.tw.mu.Lock()tw.timedOut=trueif!tw.wroteHeader{w.Header().Set("Content-Type","application/json")w.WriteHeader(http.StatusGatewayTimeout)//T208:typedstructinsteadofmap[string]interface{}_=json.NewEncoder(w).Encode(timeoutErrorResp{Error:timeoutErrorDetail{Type:"timeout",Message:"Requesttimedoutafter"+timeout.String(),},})tw.wroteHeader=true}tw.mu.Unlock()t.logger.Warn().Str("path",r.URL.Path).Dur("timeout",timeout).Msg("requesttimedout—handlergoroutinestillrunningwithcancelledcontext")//Waitforthehandlergoroutinetofinish.Thecancelledcontext//shouldcausewell-behavedhandlerstoreturnpromptly.<-done//Returnpooledresources(drainchannelfirst)select{case<-done:default:}twPool.Put(tw)chanPool.Put(done)}})}//resolveTimeoutdeterminesthetimeoutforthisrequest.//Priority:X-Alfred-Timeoutheader>providerconfig>default.func(t*TimeoutMiddleware)resolveTimeout(r*http.Request)time.Duration{//1.Client-specifiedtimeoutviaheader(cappedat5minutes).ifheaderVal:=r.Header.Get("X-Alfred-Timeout");headerVal!=""{ifseconds,err:=strconv.Atoi(headerVal);err==nil&&seconds>0{timeout:=time.Duration(seconds)*time.SecondmaxTimeout:=5*time.Minuteiftimeout>maxTimeout{timeout=maxTimeout}returntimeout}}//2.Per-providertimeoutfromconfig.//Weneedtopeekatthemodeltodeterminetheprovider.//Fornon-chatendpoints,usedefaulttimeout.ifr.URL.Path=="/v1/chat/completions"||r.URL.Path=="/v1/embeddings"{//Trytodetermineproviderfromqueryparamordefault.provider:=r.URL.Query().Get("provider")ifprovider!=""{returnt.cfg.ProviderTimeout(provider)}}//3.Defaulttimeout.returnt.cfg.DefaultTimeout}//timeoutWriterwrapshttp.ResponseWriterforsafeconcurrentaccess//betweenthehandlergoroutineandthetimeoutgoroutine.typetimeoutWriterstruct{http.ResponseWritermusync.MutexwroteHeaderbooltimedOutbool//setwhencontextdeadlineexceeded;suppressesfurtherwrites}//T208:PoolsfortimeoutWriteranddonechannelsvartwPool=sync.Pool{New:func()any{return&timeoutWriter{}},}varchanPool=sync.Pool{New:func()any{returnmake(chanstruct{},1)},//bufferedtoavoidgoroutineleak}//timeoutErrorRespisthetypedresponsefortimeouterrors(T208).typetimeoutErrorRespstruct{ErrortimeoutErrorDetail`json:"error"`}typetimeoutErrorDetailstruct{Typestring`json:"type"`Messagestring`json:"message"`}func(tw*timeoutWriter)WriteHeader(codeint){tw.mu.Lock()defertw.mu.Unlock()iftw.timedOut||tw.wroteHeader{return}tw.wroteHeader=truetw.ResponseWriter.WriteHeader(code)}func(tw*timeoutWriter)Write(b[]byte)(int,error){tw.mu.Lock()defertw.mu.Unlock()iftw.timedOut{//Suppresswritesfromthehandlergoroutineaftertimeout.return0,context.DeadlineExceeded}if!tw.wroteHeader{tw.wroteHeader=truetw.ResponseWriter.WriteHeader(http.StatusOK)}returntw.ResponseWriter.Write(b)}func(tw*timeoutWriter)Flush(){tw.mu.Lock()defertw.mu.Unlock()iff,ok:=tw.ResponseWriter.(http.Flusher);ok{f.Flush()}}