packagemiddleware_testimport("io""net/http""net/http/httptest""strings""testing""github.com/AlfredDev/alfred/services/gateway/middleware""github.com/AlfredDev/alfred/services/gateway/observability""github.com/rs/zerolog")funcnewTestLogger()zerolog.Logger{returnzerolog.New(io.Discard)}funcnewTestMetrics()*observability.Metrics{returnobservability.NewMetrics(newTestLogger())}//───EndpointNormalizationTests───────────────────────────funcTestNormalizeEndpoint(t*testing.T){//ThenormalizeEndpointfunctionisunexported,sowetestit//indirectlythroughthemiddlewarerecordingbehavior.//Thesetestsverifythemiddlewarerecordscorrectendpointlabels.tests:=[]struct{namestringpathstringwantPathstring//weverifyviathemetricslabel}{{"health","/healthz","/healthz"},{"ready","/ready","/ready"},{"metrics","/metrics","/metrics"},{"chatcompletions","/v1/chat/completions","/v1/chat/completions"},{"embeddings","/v1/embeddings","/v1/embeddings"},{"models","/v1/models","/v1/models"},{"providerslist","/v1/providers","/v1/providers"},{"providershealth","/v1/providers/health","/v1/providers/health"},{"cachestats","/v1/cache","/v1/cache"},{"analyticscost","/v1/analytics/cost","/v1/analytics/cost"},}for_,tt:=rangetests{t.Run(tt.name,func(t*testing.T){metrics:=newTestMetrics()mm:=middleware.NewMetricsMiddleware(newTestLogger(),metrics)handler:=mm.Handler(http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){w.WriteHeader(http.StatusOK)_,_=w.Write([]byte(`{"status":"ok"}`))}))req:=httptest.NewRequest("GET",tt.path,nil)rec:=httptest.NewRecorder()handler.ServeHTTP(rec,req)ifrec.Code!=http.StatusOK{t.Errorf("expectedstatus200,got%d",rec.Code)}//Verifymetricswererecordedbychecking/metricsoutputmetricsHandler:=metrics.Handler()metricsReq:=httptest.NewRequest("GET","/metrics",nil)metricsRec:=httptest.NewRecorder()metricsHandler.ServeHTTP(metricsRec,metricsReq)body:=metricsRec.Body.String()if!strings.Contains(body,"alfred_gateway_http_requests_total"){t.Error("expectedalfred_gateway_http_requests_totalinmetricsoutput")}})}}//───RequestCounterTests──────────────────────────────────funcTestMetricsMiddleware_RequestCounter(t*testing.T){metrics:=newTestMetrics()mm:=middleware.NewMetricsMiddleware(newTestLogger(),metrics)handler:=mm.Handler(http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){w.WriteHeader(http.StatusOK)}))//Make3requestsfori:=0;i<3;i++{req:=httptest.NewRequest("GET","/healthz",nil)rec:=httptest.NewRecorder()handler.ServeHTTP(rec,req)}//Checkmetricsoutputhascount3metricsRec:=httptest.NewRecorder()metrics.Handler().ServeHTTP(metricsRec,httptest.NewRequest("GET","/metrics",nil))body:=metricsRec.Body.String()if!strings.Contains(body,"alfred_gateway_http_requests_total"){t.Error("expectedalfred_gateway_http_requests_totalinoutput")}//Thecountershouldshow3if!strings.Contains(body,"}3"){t.Logf("metricsoutput:\n%s",body)//Countervaluemaybeformatteddifferently;justverifyit'spresent}}//───ErrorCounterTests────────────────────────────────────funcTestMetricsMiddleware_ErrorCounter(t*testing.T){metrics:=newTestMetrics()mm:=middleware.NewMetricsMiddleware(newTestLogger(),metrics)//Return500errorhandler:=mm.Handler(http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){w.WriteHeader(http.StatusInternalServerError)}))req:=httptest.NewRequest("GET","/v1/chat/completions",nil)rec:=httptest.NewRecorder()handler.ServeHTTP(rec,req)metricsRec:=httptest.NewRecorder()metrics.Handler().ServeHTTP(metricsRec,httptest.NewRequest("GET","/metrics",nil))body:=metricsRec.Body.String()if!strings.Contains(body,"alfred_gateway_http_errors_total"){t.Error("expectedalfred_gateway_http_errors_totalfor500response")}}//───RateLimitCounterTests───────────────────────────────funcTestMetricsMiddleware_RateLimitCounter(t*testing.T){metrics:=newTestMetrics()mm:=middleware.NewMetricsMiddleware(newTestLogger(),metrics)handler:=mm.Handler(http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){w.WriteHeader(http.StatusTooManyRequests)}))req:=httptest.NewRequest("POST","/v1/chat/completions",nil)rec:=httptest.NewRecorder()handler.ServeHTTP(rec,req)metricsRec:=httptest.NewRecorder()metrics.Handler().ServeHTTP(metricsRec,httptest.NewRequest("GET","/metrics",nil))body:=metricsRec.Body.String()if!strings.Contains(body,"alfred_gateway_rate_limited_total"){t.Error("expectedalfred_gateway_rate_limited_totalfor429response")}}//───AuthFailureCounterTests─────────────────────────────funcTestMetricsMiddleware_AuthFailureCounter(t*testing.T){metrics:=newTestMetrics()mm:=middleware.NewMetricsMiddleware(newTestLogger(),metrics)handler:=mm.Handler(http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){w.WriteHeader(http.StatusUnauthorized)}))req:=httptest.NewRequest("GET","/v1/models",nil)rec:=httptest.NewRecorder()handler.ServeHTTP(rec,req)metricsRec:=httptest.NewRecorder()metrics.Handler().ServeHTTP(metricsRec,httptest.NewRequest("GET","/metrics",nil))body:=metricsRec.Body.String()if!strings.Contains(body,"alfred_gateway_auth_failures_total"){t.Error("expectedalfred_gateway_auth_failures_totalfor401response")}}//───DurationHistogramTest────────────────────────────────funcTestMetricsMiddleware_DurationHistogram(t*testing.T){metrics:=newTestMetrics()mm:=middleware.NewMetricsMiddleware(newTestLogger(),metrics)handler:=mm.Handler(http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){w.WriteHeader(http.StatusOK)}))req:=httptest.NewRequest("POST","/v1/embeddings",nil)rec:=httptest.NewRecorder()handler.ServeHTTP(rec,req)metricsRec:=httptest.NewRecorder()metrics.Handler().ServeHTTP(metricsRec,httptest.NewRequest("GET","/metrics",nil))body:=metricsRec.Body.String()if!strings.Contains(body,"alfred_gateway_http_request_duration_ms"){t.Error("expectedalfred_gateway_http_request_duration_mshistogram")}if!strings.Contains(body,"_bucket"){t.Error("expectedhistogrambucketsinoutput")}if!strings.Contains(body,"_count"){t.Error("expectedhistogramcountinoutput")}}//───ResponseSizeCounterTest─────────────────────────────funcTestMetricsMiddleware_ResponseSize(t*testing.T){metrics:=newTestMetrics()mm:=middleware.NewMetricsMiddleware(newTestLogger(),metrics)handler:=mm.Handler(http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){w.WriteHeader(http.StatusOK)_,_=w.Write([]byte(`{"data":"testresponsebody"}`))}))req:=httptest.NewRequest("GET","/v1/models",nil)rec:=httptest.NewRecorder()handler.ServeHTTP(rec,req)metricsRec:=httptest.NewRecorder()metrics.Handler().ServeHTTP(metricsRec,httptest.NewRequest("GET","/metrics",nil))body:=metricsRec.Body.String()if!strings.Contains(body,"alfred_gateway_http_response_bytes_total"){t.Error("expectedalfred_gateway_http_response_bytes_total")}}//───ActiveConnectionsGaugeTest──────────────────────────funcTestMetricsMiddleware_ActiveConnections(t*testing.T){metrics:=newTestMetrics()mm:=middleware.NewMetricsMiddleware(newTestLogger(),metrics)//Trackthatconnectionsarecorrectlyincremented/decrementedhandler:=mm.Handler(http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){//Whileinsidethehandler,activeconnectionsshouldbe>0w.WriteHeader(http.StatusOK)}))req:=httptest.NewRequest("GET","/healthz",nil)rec:=httptest.NewRecorder()handler.ServeHTTP(rec,req)//Afterrequestcompletes,activeconnectionsgaugeshouldbebackto0metricsRec:=httptest.NewRecorder()metrics.Handler().ServeHTTP(metricsRec,httptest.NewRequest("GET","/metrics",nil))body:=metricsRec.Body.String()if!strings.Contains(body,"alfred_gateway_active_connections"){t.Error("expectedalfred_gateway_active_connectionsgauge")}}//───NilMetricsSafetyTest────────────────────────────────funcTestMetricsMiddleware_NilMetrics(t*testing.T){//Ensuremiddlewaredoesn'tpanicwithnilmetricsmm:=middleware.NewMetricsMiddleware(newTestLogger(),nil)handler:=mm.Handler(http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){w.WriteHeader(http.StatusOK)}))req:=httptest.NewRequest("GET","/healthz",nil)rec:=httptest.NewRecorder()//Shouldnotpanichandler.ServeHTTP(rec,req)ifrec.Code!=http.StatusOK{t.Errorf("expected200,got%d",rec.Code)}}//───StreamingFlushSupportTest───────────────────────────funcTestMetricsMiddleware_FlushSupport(t*testing.T){metrics:=newTestMetrics()mm:=middleware.NewMetricsMiddleware(newTestLogger(),metrics)handler:=mm.Handler(http.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){w.WriteHeader(http.StatusOK)_,_=w.Write([]byte("chunk1"))iff,ok:=w.(http.Flusher);ok{f.Flush()}_,_=w.Write([]byte("chunk2"))}))req:=httptest.NewRequest("POST","/v1/chat/completions",nil)rec:=httptest.NewRecorder()handler.ServeHTTP(rec,req)ifrec.Body.String()!="chunk1chunk2"{t.Errorf("expected'chunk1chunk2',got'%s'",rec.Body.String())}}//───MetricsRegistryTests─────────────────────────────────funcTestMetricsRegistry_Counter(t*testing.T){m:=newTestMetrics()m.CounterInc("test_counter",map[string]string{"label":"a"})m.CounterInc("test_counter",map[string]string{"label":"a"})m.CounterAdd("test_counter",map[string]string{"label":"b"},5)rec:=httptest.NewRecorder()m.Handler().ServeHTTP(rec,httptest.NewRequest("GET","/metrics",nil))body:=rec.Body.String()if!strings.Contains(body,"test_counter"){t.Error("expectedtest_counterinmetricsoutput")}}funcTestMetricsRegistry_Gauge(t*testing.T){m:=newTestMetrics()m.GaugeSet("test_gauge",map[string]string{"label":"x"},42.5)rec:=httptest.NewRecorder()m.Handler().ServeHTTP(rec,httptest.NewRequest("GET","/metrics",nil))body:=rec.Body.String()if!strings.Contains(body,"test_gauge"){t.Error("expectedtest_gaugeinmetricsoutput")}}funcTestMetricsRegistry_Histogram(t*testing.T){m:=newTestMetrics()m.HistogramObserve("test_histogram",nil,25.0)m.HistogramObserve("test_histogram",nil,150.0)m.HistogramObserve("test_histogram",nil,5000.0)rec:=httptest.NewRecorder()m.Handler().ServeHTTP(rec,httptest.NewRequest("GET","/metrics",nil))body:=rec.Body.String()if!strings.Contains(body,"test_histogram"){t.Error("expectedtest_histograminmetricsoutput")}if!strings.Contains(body,"test_histogram_count3"){t.Error("expectedhistogramcountof3")}if!strings.Contains(body,"_bucket"){t.Error("expectedhistogrambuckets")}}funcTestMetricsRegistry_TrackRequest(t*testing.T){m:=newTestMetrics()m.TrackRequest("openai","gpt-4","/v1/chat/completions",200,150.0,1500,false)m.TrackRequest("anthropic","claude-3","/v1/chat/completions",200,250.0,2000,true)rec:=httptest.NewRecorder()m.Handler().ServeHTTP(rec,httptest.NewRequest("GET","/metrics",nil))body:=rec.Body.String()if!strings.Contains(body,"alfred_gateway_requests_total"){t.Error("expectedalfred_gateway_requests_total")}if!strings.Contains(body,"alfred_gateway_request_duration_ms"){t.Error("expectedalfred_gateway_request_duration_ms")}if!strings.Contains(body,"alfred_gateway_tokens_total"){t.Error("expectedalfred_gateway_tokens_total")}if!strings.Contains(body,"alfred_gateway_cache_hits_total"){t.Error("expectedalfred_gateway_cache_hits_totalforcachedrequest")}}funcTestMetricsRegistry_TrackProviderHealth(t*testing.T){m:=newTestMetrics()m.TrackProviderHealth("openai",true)m.TrackProviderHealth("anthropic",false)rec:=httptest.NewRecorder()m.Handler().ServeHTTP(rec,httptest.NewRequest("GET","/metrics",nil))body:=rec.Body.String()if!strings.Contains(body,"alfred_provider_healthy"){t.Error("expectedalfred_provider_healthy")}}funcTestMetricsHandler_PrometheusFormat(t*testing.T){m:=newTestMetrics()m.CounterInc("alfred_test",map[string]string{"env":"test"})rec:=httptest.NewRecorder()m.Handler().ServeHTTP(rec,httptest.NewRequest("GET","/metrics",nil))//VerifyContent-Typect:=rec.Header().Get("Content-Type")if!strings.Contains(ct,"text/plain"){t.Errorf("expectedtext/plaincontenttype,got%s",ct)}body:=rec.Body.String()//ShouldhaveTYPEdeclarationsif!strings.Contains(body,"#TYPE"){t.Error("expectedTYPEdeclarationsinPrometheusformat")}//Shouldhavelabelformattingif!strings.Contains(body,`env="test"`){t.Error("expectedlabelenv=testinoutput")}}