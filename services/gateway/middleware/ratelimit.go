packagemiddlewareimport("net/http""strconv""sync""time""github.com/rs/zerolog")//RateLimiterimplementsaper-keyslidingwindowratelimiter.//Usesin-memorystorage.Fordistributedsetups,extendwithRedis.typeRateLimiterstruct{loggerzerolog.LoggerenabledboolrpmintburstintrpmStrstring//T208:pre-computedstrconvforheadermusync.Mutexwindowsmap[string]*slidingWindow}typeslidingWindowstruct{tokens[]time.TimelastCleantime.Time}//NewRateLimitercreatesanewratelimiter.funcNewRateLimiter(loggerzerolog.Logger,enabledbool,rpm,burstint)*RateLimiter{return&RateLimiter{logger:logger,enabled:enabled,rpm:rpm,burst:burst,rpmStr:strconv.Itoa(rpm),//T208:pre-computeoncewindows:make(map[string]*slidingWindow),}}//Handlerreturnstheratelimitingmiddlewarehandler.func(rl*RateLimiter)Handler(nexthttp.Handler)http.Handler{returnhttp.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){if!rl.enabled{next.ServeHTTP(w,r)return}//UseAPIkeyasratelimitkey,fallbacktoIPkey:=GetAPIKey(r.Context())ifkey==""{key=r.RemoteAddr}allowed,remaining,resetAt:=rl.allow(key)//T208:usepre-computedstringforlimit(neverchanges)w.Header().Set("X-RateLimit-Limit",rl.rpmStr)w.Header().Set("X-RateLimit-Remaining",strconv.Itoa(remaining))w.Header().Set("X-RateLimit-Reset",strconv.FormatInt(resetAt.Unix(),10))if!allowed{retryAfter:=strconv.Itoa(int(time.Until(resetAt).Seconds())+1)w.Header().Set("Retry-After",retryAfter)//T208:stringconcatinsteadoffmt.Sprintf(avoidsalloc)http.Error(w,`{"error":"rate_limit_exceeded","message":"Ratelimitof`+rl.rpmStr+`requestsperminuteexceeded","retry_after":`+retryAfter+`}`,http.StatusTooManyRequests)rl.logger.Warn().Str("key",key[:8]+"...").Int("limit",rl.rpm).Msg("ratelimitexceeded")return}next.ServeHTTP(w,r)})}func(rl*RateLimiter)allow(keystring)(bool,int,time.Time){rl.mu.Lock()deferrl.mu.Unlock()now:=time.Now()windowStart:=now.Add(-1*time.Minute)resetAt:=now.Add(1*time.Minute)sw,exists:=rl.windows[key]if!exists{sw=&slidingWindow{tokens:make([]time.Time,0,rl.rpm),lastClean:now,}rl.windows[key]=sw}//Cleanexpiredtokensâ€”T208:in-placecompaction(zeroalloc)ifnow.Sub(sw.lastClean)>10*time.Second{n:=0for_,t:=rangesw.tokens{ift.After(windowStart){sw.tokens[n]=tn++}}sw.tokens=sw.tokens[:n]sw.lastClean=now}//Counttokensincurrentwindowcount:=0for_,t:=rangesw.tokens{ift.After(windowStart){count++}}remaining:=rl.rpm-countifremaining<=0{//Findearliesttokenexpiryforresettimeiflen(sw.tokens)>0{resetAt=sw.tokens[0].Add(1*time.Minute)}returnfalse,0,resetAt}//Addnewtokensw.tokens=append(sw.tokens,now)returntrue,remaining-1,resetAt}//Cleanupremovesstaleentries.Callperiodically.func(rl*RateLimiter)Cleanup(){rl.mu.Lock()deferrl.mu.Unlock()cutoff:=time.Now().Add(-2*time.Minute)forkey,sw:=rangerl.windows{iflen(sw.tokens)==0||sw.tokens[len(sw.tokens)-1].Before(cutoff){delete(rl.windows,key)}}}