packagemiddlewareimport("net/http""time""github.com/rs/zerolog")//LatencyTrackertracksrequestlatencyandcalculatespercentilestypeLatencyTrackerstruct{logzerolog.Loggerp95Thresholdtime.Durationp99Thresholdtime.DurationslowLogEnabledbool}//NewLatencyTrackercreatesanewlatencytrackingmiddlewarefuncNewLatencyTracker(logzerolog.Logger,p95Target,p99Targettime.Duration)*LatencyTracker{return&LatencyTracker{log:log,p95Threshold:p95Target,p99Threshold:p99Target,slowLogEnabled:true,}}//Middlewarereturnsamiddlewarefunctionthattracksrequestlatencyfunc(lt*LatencyTracker)Middleware(nexthttp.Handler)http.Handler{returnhttp.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){start:=time.Now()//Wrapresponsewritertocapturestatuscodewrapped:=&responseWriter{ResponseWriter:w,statusCode:http.StatusOK,}//Processrequestnext.ServeHTTP(wrapped,r)//Calculatelatencyduration:=time.Since(start)//LogrequestdetailslogEntry:=lt.log.Debug().Str("method",r.Method).Str("path",r.URL.Path).Dur("latency_ms",duration).Int("status",wrapped.statusCode)//Detectslowrequests(checkmostseverethresholdfirst)ifduration>lt.p99Threshold{logEntry=lt.log.Error().Str("method",r.Method).Str("path",r.URL.Path).Dur("latency_ms",duration).Dur("p99_target",lt.p99Threshold).Int("status",wrapped.statusCode).Str("alert","CRITICAL_SLOW_REQUEST_P99_BREACH")//AddtracecontextiftraceID:=r.Header.Get("X-Trace-ID");traceID!=""{logEntry=logEntry.Str("trace_id",traceID)}}elseifduration>lt.p95Threshold{logEntry=lt.log.Warn().Str("method",r.Method).Str("path",r.URL.Path).Dur("latency_ms",duration).Dur("p95_target",lt.p95Threshold).Int("status",wrapped.statusCode).Str("alert","SLOW_REQUEST_P95_BREACH")//AddtracecontextifavailableiftraceID:=r.Header.Get("X-Trace-ID");traceID!=""{logEntry=logEntry.Str("trace_id",traceID)}}logEntry.Msg("requestcompleted")})}//responseWriterwrapshttp.ResponseWritertocapturestatuscodetyperesponseWriterstruct{http.ResponseWriterstatusCodeint}func(rw*responseWriter)WriteHeader(codeint){rw.statusCode=coderw.ResponseWriter.WriteHeader(code)}//LatencyProfileholdslatencystatisticsforanalysistypeLatencyProfilestruct{EndpointstringCountint64P50time.DurationP95time.DurationP99time.DurationMeantime.DurationMintime.DurationMaxtime.DurationLastUpdatedtime.Time}