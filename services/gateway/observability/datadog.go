packageobservabilityimport("fmt""net""strconv""strings""sync""time""github.com/rs/zerolog")//DatadogConfigholdsDatadogAgentconnectionsettings.typeDatadogConfigstruct{//AddressoftheDogStatsDagent(default:"127.0.0.1:8125")Addressstring//Namespaceprefixforallmetrics(default:"alfred.gateway")Namespacestring//GlobaltagsaddedtoeverymetricGlobalTags[]string//FlushIntervalcontrolshowoftenbufferedmetricsship(default:10s)FlushIntervaltime.Duration//BufferSizeisthemaxnumberofmetricsbufferedbeforeflush(default:256)BufferSizeint//EnabledcontrolswhethermetricsaresentatallEnabledbool}//DefaultDatadogConfigreturnssanedefaults.funcDefaultDatadogConfig()DatadogConfig{returnDatadogConfig{Address:"127.0.0.1:8125",Namespace:"alfred.gateway",GlobalTags:nil,FlushInterval:10*time.Second,BufferSize:256,Enabled:false,}}//DatadogExportersendsmetricstoaDogStatsDagentoverUDP.typeDatadogExporterstruct{cfgDatadogConfigconnnet.Connloggerzerolog.Loggermusync.Mutexbuffer[]stringstopChchanstruct{}wgsync.WaitGroup}//NewDatadogExportercreatesandstartsaDatadogexporter.//Theexporterisano-opifcfg.Enabledisfalse.funcNewDatadogExporter(cfgDatadogConfig,loggerzerolog.Logger)(*DatadogExporter,error){dd:=&DatadogExporter{cfg:cfg,logger:logger.With().Str("component","datadog").Logger(),buffer:make([]string,0,cfg.BufferSize),stopCh:make(chanstruct{}),}if!cfg.Enabled{dd.logger.Info().Msg("Datadogexporterdisabled—metricswillnotbesent")returndd,nil}conn,err:=net.Dial("udp",cfg.Address)iferr!=nil{returnnil,fmt.Errorf("datadog:cannotconnectto%s:%w",cfg.Address,err)}dd.conn=conn//Starttheperiodicflushgoroutinedd.wg.Add(1)godd.flushLoop()dd.logger.Info().Str("address",cfg.Address).Str("namespace",cfg.Namespace).Dur("flush_interval",cfg.FlushInterval).Msg("Datadogexporterstarted")returndd,nil}//Stopgracefullyshutsdowntheexporter.func(dd*DatadogExporter)Stop(){if!dd.cfg.Enabled{return}close(dd.stopCh)dd.wg.Wait()//Finalflushdd.flush()ifdd.conn!=nil{dd.conn.Close()}dd.logger.Info().Msg("Datadogexporterstopped")}//───PublicAPI─────────────────────────────────────────────//Countsendsacountermetric.func(dd*DatadogExporter)Count(namestring,valueint64,tags...string){dd.send(name,strconv.FormatInt(value,10),"c",tags)}//Gaugesendsagaugemetric.func(dd*DatadogExporter)Gauge(namestring,valuefloat64,tags...string){dd.send(name,fmt.Sprintf("%f",value),"g",tags)}//Histogramsendsahistogram/distributionmetric.func(dd*DatadogExporter)Histogram(namestring,valuefloat64,tags...string){dd.send(name,fmt.Sprintf("%f",value),"h",tags)}//DistributionsendsaDatadogdistributionmetric(DDSketch).func(dd*DatadogExporter)Distribution(namestring,valuefloat64,tags...string){dd.send(name,fmt.Sprintf("%f",value),"d",tags)}//Timingsendsatimingmetricinmilliseconds.func(dd*DatadogExporter)Timing(namestring,durationtime.Duration,tags...string){dd.send(name,fmt.Sprintf("%f",float64(duration.Milliseconds())),"ms",tags)}//ServiceChecksendsaDatadogservicecheck.//status:0=OK,1=WARNING,2=CRITICAL,3=UNKNOWNfunc(dd*DatadogExporter)ServiceCheck(namestring,statusint,tags...string){if!dd.cfg.Enabled{return}fullName:=dd.namespaced(name)tagStr:=dd.formatTags(tags)line:=fmt.Sprintf("_sc|%s|%d%s",fullName,status,tagStr)dd.buffer_line(line)}//EventsendsaDatadogevent.func(dd*DatadogExporter)Event(title,textstring,tags...string){if!dd.cfg.Enabled{return}tagStr:=dd.formatTags(tags)line:=fmt.Sprintf("_e{%d,%d}:%s|%s%s",len(title),len(text),title,text,tagStr)dd.buffer_line(line)}//───ConvenienceWrappersforGatewayMetrics───────────────//RecordRequestrecordsagatewayrequestwithstandardtags.func(dd*DatadogExporter)RecordRequest(provider,model,statusstring,latencyMsfloat64){tags:=[]string{"provider:"+provider,"model:"+model,"status:"+status,}dd.Count("request.count",1,tags...)dd.Histogram("request.latency_ms",latencyMs,tags...)}//RecordTokensrecordstokenusage.func(dd*DatadogExporter)RecordTokens(provider,modelstring,prompt,completionint64){tags:=[]string{"provider:"+provider,"model:"+model}dd.Count("tokens.prompt",prompt,tags...)dd.Count("tokens.completion",completion,tags...)dd.Count("tokens.total",prompt+completion,tags...)}//RecordCacheResultrecordsacachehitormiss.func(dd*DatadogExporter)RecordCacheResult(hitbool){ifhit{dd.Count("cache.hits",1)}else{dd.Count("cache.misses",1)}}//RecordWalletOprecordsawalletoperation.func(dd*DatadogExporter)RecordWalletOp(opstring,successbool){status:="success"if!success{status="failure"}dd.Count("wallet.ops",1,"operation:"+op,"status:"+status)}//RecordSafetyViolationrecordsasafetypipelineviolation.func(dd*DatadogExporter)RecordSafetyViolation(category,severitystring){dd.Count("safety.violations",1,"category:"+category,"severity:"+severity)}//───Internal───────────────────────────────────────────────func(dd*DatadogExporter)send(name,value,metricTypestring,tags[]string){if!dd.cfg.Enabled{return}fullName:=dd.namespaced(name)tagStr:=dd.formatTags(tags)line:=fmt.Sprintf("%s:%s|%s%s",fullName,value,metricType,tagStr)dd.buffer_line(line)}func(dd*DatadogExporter)namespaced(namestring)string{ifdd.cfg.Namespace!=""{returndd.cfg.Namespace+"."+name}returnname}func(dd*DatadogExporter)formatTags(tags[]string)string{allTags:=make([]string,0,len(dd.cfg.GlobalTags)+len(tags))allTags=append(allTags,dd.cfg.GlobalTags...)allTags=append(allTags,tags...)iflen(allTags)==0{return""}return"|#"+strings.Join(allTags,",")}func(dd*DatadogExporter)buffer_line(linestring){dd.mu.Lock()dd.buffer=append(dd.buffer,line)shouldFlush:=len(dd.buffer)>=dd.cfg.BufferSizedd.mu.Unlock()ifshouldFlush{dd.flush()}}func(dd*DatadogExporter)flushLoop(){deferdd.wg.Done()ticker:=time.NewTicker(dd.cfg.FlushInterval)deferticker.Stop()for{select{case<-ticker.C:dd.flush()case<-dd.stopCh:return}}}func(dd*DatadogExporter)flush(){dd.mu.Lock()iflen(dd.buffer)==0{dd.mu.Unlock()return}lines:=dd.bufferdd.buffer=make([]string,0,dd.cfg.BufferSize)dd.mu.Unlock()ifdd.conn==nil{return}//DogStatsDsupportsmulti-linepayloadsseparatedby\npayload:=strings.Join(lines,"\n")_,err:=dd.conn.Write([]byte(payload))iferr!=nil{dd.logger.Warn().Err(err).Int("lines",len(lines)).Msg("FailedtosendmetricstoDatadog")}}