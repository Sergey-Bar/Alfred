packageobservabilityimport("bytes""encoding/json""fmt""io""net/http""sync""time""github.com/rs/zerolog")//SplunkConfigholdsSplunkHECconnectionsettings.typeSplunkConfigstruct{//HECURListheSplunkHECendpointURL(e.g.,"https://splunk.example.com:8088/services/collector/event")HECURLstring//TokenistheSplunkHECauthenticationtoken.Tokenstring//IndexisthetargetSplunkindex(optional,usesdefaultifempty).Indexstring//Sourceidentifiesthelogsource.Sourcestring//SourceTypeforstructuredJSONlogs.SourceTypestring//FlushIntervalcontrolsperiodicbatchflush(default:5s).FlushIntervaltime.Duration//BatchSizeisthemaxeventsperbatchbeforeflush(default:100).BatchSizeint//Enabledcontrolswhetherlogsaresent.Enabledbool//InsecureSkipVerifydisablesTLSverification(devonly).InsecureSkipVerifybool}//DefaultSplunkConfigreturnssanedefaults.funcDefaultSplunkConfig()SplunkConfig{returnSplunkConfig{HECURL:"",Token:"",Index:"alfred",Source:"alfred-gateway",SourceType:"_json",FlushInterval:5*time.Second,BatchSize:100,Enabled:false,}}//SplunkForwardersendsstructuredlogeventstoSplunkHEC.typeSplunkForwarderstruct{cfgSplunkConfigclient*http.Clientloggerzerolog.Loggermusync.Mutexbuffer[]splunkEventstopChchanstruct{}wgsync.WaitGroup}//splunkEventisasingleSplunkHECeventpayload.typesplunkEventstruct{Timefloat64`json:"time"`Hoststring`json:"host,omitempty"`Sourcestring`json:"source,omitempty"`SourceTypestring`json:"sourcetype,omitempty"`Indexstring`json:"index,omitempty"`Eventmap[string]interface{}`json:"event"`}//NewSplunkForwardercreatesandstartsaSplunkforwarder.funcNewSplunkForwarder(cfgSplunkConfig,loggerzerolog.Logger)*SplunkForwarder{sf:=&SplunkForwarder{cfg:cfg,logger:logger.With().Str("component","splunk").Logger(),buffer:make([]splunkEvent,0,cfg.BatchSize),stopCh:make(chanstruct{}),client:&http.Client{Timeout:15*time.Second},}if!cfg.Enabled{sf.logger.Info().Msg("Splunkforwarderdisabled—logswillnotbeshipped")returnsf}sf.wg.Add(1)gosf.flushLoop()sf.logger.Info().Str("hec_url",cfg.HECURL).Str("index",cfg.Index).Int("batch_size",cfg.BatchSize).Msg("Splunkforwarderstarted")returnsf}//Stopgracefullyshutsdowntheforwarder.func(sf*SplunkForwarder)Stop(){if!sf.cfg.Enabled{return}close(sf.stopCh)sf.wg.Wait()sf.flush()sf.logger.Info().Msg("Splunkforwarderstopped")}//───PublicAPI─────────────────────────────────────────────//LogsendsastructuredlogeventtoSplunk.func(sf*SplunkForwarder)Log(eventmap[string]interface{}){if!sf.cfg.Enabled{return}se:=splunkEvent{Time:float64(time.Now().UnixMilli())/1000.0,Source:sf.cfg.Source,SourceType:sf.cfg.SourceType,Index:sf.cfg.Index,Event:event,}sf.mu.Lock()sf.buffer=append(sf.buffer,se)shouldFlush:=len(sf.buffer)>=sf.cfg.BatchSizesf.mu.Unlock()ifshouldFlush{sf.flush()}}//LogRequestlogsagatewayrequestevent.func(sf*SplunkForwarder)LogRequest(provider,model,statusstring,latencyMsfloat64,tokensint64,userIDstring){sf.Log(map[string]interface{}{"event_type":"request","provider":provider,"model":model,"status":status,"latency_ms":latencyMs,"tokens":tokens,"user_id":userID,})}//LogSecurityEventlogsasafetypipelineevent.func(sf*SplunkForwarder)LogSecurityEvent(eventType,category,severity,userIDstring,detailsmap[string]interface{}){event:=map[string]interface{}{"event_type":"security","sub_type":eventType,"category":category,"severity":severity,"user_id":userID,}fork,v:=rangedetails{event[k]=v}sf.Log(event)}//LogAuditlogsanaudittrailevent.func(sf*SplunkForwarder)LogAudit(action,actorID,targetType,targetIDstring,detailsmap[string]interface{}){event:=map[string]interface{}{"event_type":"audit","action":action,"actor_id":actorID,"target_type":targetType,"target_id":targetID,}fork,v:=rangedetails{event[k]=v}sf.Log(event)}//LogWalletEventlogswalletoperations.func(sf*SplunkForwarder)LogWalletEvent(operation,walletID,userIDstring,amountfloat64){sf.Log(map[string]interface{}{"event_type":"wallet","operation":operation,"wallet_id":walletID,"user_id":userID,"amount":amount,})}//───Internal───────────────────────────────────────────────func(sf*SplunkForwarder)flushLoop(){defersf.wg.Done()ticker:=time.NewTicker(sf.cfg.FlushInterval)deferticker.Stop()for{select{case<-ticker.C:sf.flush()case<-sf.stopCh:return}}}func(sf*SplunkForwarder)flush(){sf.mu.Lock()iflen(sf.buffer)==0{sf.mu.Unlock()return}events:=sf.buffersf.buffer=make([]splunkEvent,0,sf.cfg.BatchSize)sf.mu.Unlock()//SplunkHECacceptsnewline-delimitedJSONeventsvarbufbytes.Bufferencoder:=json.NewEncoder(&buf)for_,ev:=rangeevents{iferr:=encoder.Encode(ev);err!=nil{sf.logger.Warn().Err(err).Msg("FailedtoencodeSplunkevent")}}req,err:=http.NewRequest("POST",sf.cfg.HECURL,&buf)iferr!=nil{sf.logger.Error().Err(err).Msg("FailedtocreateSplunkHECrequest")return}req.Header.Set("Authorization",fmt.Sprintf("Splunk%s",sf.cfg.Token))req.Header.Set("Content-Type","application/json")resp,err:=sf.client.Do(req)iferr!=nil{sf.logger.Error().Err(err).Int("events",len(events)).Msg("FailedtosendeventstoSplunkHEC")return}deferresp.Body.Close()io.Copy(io.Discard,resp.Body)ifresp.StatusCode>=400{sf.logger.Error().Int("status",resp.StatusCode).Int("events",len(events)).Msg("SplunkHECreturnederror")return}sf.logger.Debug().Int("events",len(events)).Msg("FlushedeventstoSplunkHEC")}