packageobservabilityimport("bytes""encoding/json""fmt""io""net/http""time""github.com/rs/zerolog")//PagerDutyConfigholdsconfigurationforPagerDutyEventsAPIv2.typePagerDutyConfigstruct{//RoutingKeyisthePagerDutyEventsAPIv2integrationkey.RoutingKeystring//Enabledcontrolswhetheralertsaresent.Enabledbool//SourceNameidentifiesthisgatewayinstance(e.g.,"alfred-gw-prod-01").SourceNamestring//HTTPTimeoutforthePagerDutyAPIcall.HTTPTimeouttime.Duration}//DefaultPagerDutyConfigreturnsdefaults.funcDefaultPagerDutyConfig()PagerDutyConfig{returnPagerDutyConfig{RoutingKey:"",Enabled:false,SourceName:"alfred-gateway",HTTPTimeout:10*time.Second,}}//PagerDutySeveritymapstoPagerDutyalertseverity.typePagerDutySeveritystringconst(PDSeverityCriticalPagerDutySeverity="critical"PDSeverityErrorPagerDutySeverity="error"PDSeverityWarningPagerDutySeverity="warning"PDSeverityInfoPagerDutySeverity="info")//PagerDutyClientsendsincidentstoPagerDutyEventsAPIv2.typePagerDutyClientstruct{cfgPagerDutyConfigclient*http.Clientloggerzerolog.Logger}constpagerDutyEventsURL="https://events.pagerduty.com/v2/enqueue"//NewPagerDutyClientcreatesaPagerDutyalertingclient.funcNewPagerDutyClient(cfgPagerDutyConfig,loggerzerolog.Logger)*PagerDutyClient{return&PagerDutyClient{cfg:cfg,client:&http.Client{Timeout:cfg.HTTPTimeout,},logger:logger.With().Str("component","pagerduty").Logger(),}}//TriggerAlertfiresaPagerDutyalert.func(pd*PagerDutyClient)TriggerAlert(severityPagerDutySeverity,summarystring,dedupKeystring,detailsmap[string]interface{},)error{if!pd.cfg.Enabled||pd.cfg.RoutingKey==""{pd.logger.Debug().Str("summary",summary).Msg("PagerDutydisabled—alertsuppressed")returnnil}payload:=map[string]interface{}{"routing_key":pd.cfg.RoutingKey,"event_action":"trigger","dedup_key":dedupKey,"payload":map[string]interface{}{"summary":summary,"severity":string(severity),"source":pd.cfg.SourceName,"component":"alfred-gateway","group":"ai-platform","class":"infrastructure","timestamp":time.Now().UTC().Format(time.RFC3339),"custom_details":details,},}body,err:=json.Marshal(payload)iferr!=nil{returnfmt.Errorf("pagerduty:marshalfailed:%w",err)}resp,err:=pd.client.Post(pagerDutyEventsURL,"application/json",bytes.NewReader(body))iferr!=nil{pd.logger.Error().Err(err).Str("dedup_key",dedupKey).Msg("PagerDutyAPIcallfailed")returnfmt.Errorf("pagerduty:APIcallfailed:%w",err)}deferresp.Body.Close()io.Copy(io.Discard,resp.Body)ifresp.StatusCode>=400{pd.logger.Error().Int("status",resp.StatusCode).Str("dedup_key",dedupKey).Msg("PagerDutyAPIerror")returnfmt.Errorf("pagerduty:HTTP%d",resp.StatusCode)}pd.logger.Info().Str("dedup_key",dedupKey).Str("severity",string(severity)).Msg("PagerDutyalerttriggered")returnnil}//ResolveAlertresolvesapreviouslytriggeredalert.func(pd*PagerDutyClient)ResolveAlert(dedupKeystring)error{if!pd.cfg.Enabled||pd.cfg.RoutingKey==""{returnnil}payload:=map[string]interface{}{"routing_key":pd.cfg.RoutingKey,"event_action":"resolve","dedup_key":dedupKey,}body,err:=json.Marshal(payload)iferr!=nil{returnfmt.Errorf("pagerduty:marshalfailed:%w",err)}resp,err:=pd.client.Post(pagerDutyEventsURL,"application/json",bytes.NewReader(body))iferr!=nil{returnfmt.Errorf("pagerduty:resolvecallfailed:%w",err)}deferresp.Body.Close()io.Copy(io.Discard,resp.Body)pd.logger.Info().Str("dedup_key",dedupKey).Msg("PagerDutyalertresolved")returnnil}//───ConvenienceWrappersforCommonAlerts─────────────────//AlertProviderDownfiresacriticalalertwhenaproviderfailshealthchecks.func(pd*PagerDutyClient)AlertProviderDown(providerstring,errorMsgstring)error{returnpd.TriggerAlert(PDSeverityCritical,fmt.Sprintf("Alfred:LLMprovider%sisDOWN",provider),fmt.Sprintf("alfred-provider-down-%s",provider),map[string]interface{}{"provider":provider,"error":errorMsg,},)}//AlertProviderRecoveredresolvesaprovider-downalert.func(pd*PagerDutyClient)AlertProviderRecovered(providerstring)error{returnpd.ResolveAlert(fmt.Sprintf("alfred-provider-down-%s",provider))}//AlertWalletExhaustedfireswhenawallethitsitshardlimit.func(pd*PagerDutyClient)AlertWalletExhausted(walletID,ownerNamestring,balancefloat64)error{returnpd.TriggerAlert(PDSeverityError,fmt.Sprintf("Alfred:Walletexhaustedfor%s(balance:$%.2f)",ownerName,balance),fmt.Sprintf("alfred-wallet-exhausted-%s",walletID),map[string]interface{}{"wallet_id":walletID,"owner":ownerName,"balance":balance,},)}//AlertHighErrorRatefireswhenthegatewayerrorrateexceedsthreshold.func(pd*PagerDutyClient)AlertHighErrorRate(errorPctfloat64,windowstring)error{returnpd.TriggerAlert(PDSeverityCritical,fmt.Sprintf("Alfred:Gatewayerrorrate%.1f%%over%s",errorPct,window),"alfred-high-error-rate",map[string]interface{}{"error_percentage":errorPct,"window":window,},)}//AlertSafetyBlockfireswhenthesafetypipelineblocksarequestwithcriticalviolations.func(pd*PagerDutyClient)AlertSafetyBlock(userIDstring,violationCountint,categories[]string)error{returnpd.TriggerAlert(PDSeverityWarning,fmt.Sprintf("Alfred:Safetypipelineblockedrequestfromuser%s(%dviolations)",userID,violationCount),fmt.Sprintf("alfred-safety-block-%s-%d",userID,time.Now().Unix()/300),//dedupper5-minwindowmap[string]interface{}{"user_id":userID,"violation_count":violationCount,"categories":categories,},)}