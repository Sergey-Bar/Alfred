packagerouterimport("io""net/http""net/http/httptest""testing""github.com/rs/zerolog""github.com/AlfredDev/alfred/services/gateway/config""github.com/AlfredDev/alfred/services/gateway/provider")functestSetup()(http.Handler,*provider.Registry){cfg:=&config.Config{Addr:":0",Env:"test",RateLimitEnabled:false,APIKeyHeader:"Authorization",MaxBodyBytes:1<<20,}log:=zerolog.New(io.Discard).With().Timestamp().Logger()reg:=provider.NewRegistry()r:=NewRouter(cfg,log,reg)returnr,reg}funcTestHealthEndpoints(t*testing.T){r,_:=testSetup()tests:=[]struct{namestringpathstringstatusint}{{"healthz","/healthz",http.StatusOK},{"ready","/ready",http.StatusOK},{"health","/health",http.StatusOK},}for_,tc:=rangetests{t.Run(tc.name,func(t*testing.T){req:=httptest.NewRequest(http.MethodGet,tc.path,nil)rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Result().StatusCode!=tc.status{t.Fatalf("expected%dfor%s,got%d",tc.status,tc.path,rw.Result().StatusCode)}})}}funcTestUnauthenticatedRouteReturns401(t*testing.T){r,_:=testSetup()///v1routesrequireauthâ€”requestwithoutAuthorizationheadershouldget401req:=httptest.NewRequest(http.MethodGet,"/v1/models",nil)rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Result().StatusCode!=http.StatusUnauthorized{t.Fatalf("expected401forunauthenticated/v1/models,got%d",rw.Result().StatusCode)}}funcTestCORSPreflight(t*testing.T){r,_:=testSetup()req:=httptest.NewRequest(http.MethodOptions,"/v1/chat/completions",nil)req.Header.Set("Origin","http://localhost:3000")req.Header.Set("Access-Control-Request-Method","POST")rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Header().Get("Access-Control-Allow-Origin")==""{t.Fatal("expectedCORSAllow-Originheaderonpreflightresponse")}}funcTestSecurityHeaders(t*testing.T){r,_:=testSetup()req:=httptest.NewRequest(http.MethodGet,"/healthz",nil)rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)headers:=[]string{"X-Content-Type-Options","X-Frame-Options","Strict-Transport-Security",}for_,h:=rangeheaders{ifrw.Header().Get(h)==""{t.Fatalf("expectedsecurityheader%stobeset",h)}}}