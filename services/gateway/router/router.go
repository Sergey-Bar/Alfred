packagerouterimport("net/http""os""strconv""time""github.com/go-chi/chi/v5"chimw"github.com/go-chi/chi/v5/middleware""github.com/rs/zerolog""github.com/AlfredDev/alfred/services/gateway/analytics""github.com/AlfredDev/alfred/services/gateway/caching""github.com/AlfredDev/alfred/services/gateway/config""github.com/AlfredDev/alfred/services/gateway/handler"gwmw"github.com/AlfredDev/alfred/services/gateway/middleware""github.com/AlfredDev/alfred/services/gateway/observability""github.com/AlfredDev/alfred/services/gateway/provider""github.com/AlfredDev/alfred/services/gateway/redisclient"//"github.com/AlfredDev/alfred/services/gateway/policy"//Excluded:incompleteimplementation//"github.com/AlfredDev/alfred/services/gateway/routing"//Excluded:incompleteimplementation)//NewRouterreturnsaconfiguredchiRouterwiththefullmiddlewarechain//andallAPIroutesmounted.//Optionalvariadicargs:pipeline*analytics.Pipeline,metrics*observability.Metrics,tracer*observability.TracerfuncNewRouter(cfg*config.Config,appLoggerzerolog.Logger,registry*provider.Registry,opts...interface{})http.Handler{r:=chi.NewRouter()//ExtractoptionaldependenciesvaranalyticsPipe*analytics.Pipelinevarmetrics*observability.Metricsvartracer*observability.Tracervarrc*redisclient.Clientfor_,opt:=rangeopts{switchv:=opt.(type){case*analytics.Pipeline:analyticsPipe=vcase*observability.Metrics:metrics=vcase*observability.Tracer:tracer=vcase*redisclient.Client:rc=v}}//---MiddlewareChain(ordermatters)---//1.CORS—mustbefirstsopreflightresponsessucceedr.Use(gwmw.CORSMiddleware([]string{"*"}))//2.Securityheadersr.Use(gwmw.SecurityHeadersMiddleware)//3.RequestIDinjection(chibuilt-in)r.Use(chimw.RequestID)//4.Panicrecoveryr.Use(chimw.Recoverer)//5.Requestloggerr.Use(mwRequestLogger(appLogger))//5b.Prometheusmetricsrecording(T300)ifmetrics!=nil{metricsMW:=gwmw.NewMetricsMiddleware(appLogger,metrics)r.Use(metricsMW.Handler)}//5c.OpenTelemetrytracing(T145)iftracer!=nil{r.Use(observability.TracingMiddleware(tracer))}//6.Bodysizelimitr.Use(mwMaxBodySize(cfg.MaxBodyBytes))//---Healthendpoints(noauthrequired)---r.Get("/healthz",func(whttp.ResponseWriter,r*http.Request){w.Header().Set("Content-Type","application/json")w.WriteHeader(http.StatusOK)_,_=w.Write([]byte(`{"status":"ok","service":"alfred-gateway"}`))})r.Get("/ready",func(whttp.ResponseWriter,r*http.Request){w.Header().Set("Content-Type","application/json")//ReadinessincludesRedishealth(T298)ifrc!=nil&&!rc.IsHealthy(){w.WriteHeader(http.StatusServiceUnavailable)_,_=w.Write([]byte(`{"status":"degraded","service":"alfred-gateway","redis":"unhealthy"}`))return}w.WriteHeader(http.StatusOK)_,_=w.Write([]byte(`{"status":"ready","service":"alfred-gateway"}`))})r.Get("/health",func(whttp.ResponseWriter,r*http.Request){w.Header().Set("Content-Type","application/json")w.WriteHeader(http.StatusOK)_,_=w.Write([]byte(`{"status":"healthy","service":"alfred-gateway"}`))})//Prometheusmetricsendpoint(T144)—noauthrequiredifmetrics!=nil{r.Get("/metrics",metrics.Handler())}//Redishealthdetailendpoint(T298)—noauthrequiredifrc!=nil{r.Get("/redis/health",handler.RedisHealthHandler(rc))}//OpenAPIspec+SwaggerUI(T191)—noauthrequiredr.Get("/openapi.json",handler.OpenAPIHandler())r.Get("/docs",handler.SwaggerUIHandler())//---APIRoutes(auth+ratelimitingrequired)---proxyHandler:=handler.NewProxyHandler(appLogger,registry)pricingCfg:=provider.DefaultPricing()providerCfgHandler:=handler.NewProviderConfigHandler(appLogger,registry,pricingCfg)authMW:=gwmw.NewAuthMiddleware(appLogger,cfg.APIKeyHeader)rateLimiter:=gwmw.NewRateLimiter(appLogger,cfg.RateLimitEnabled,cfg.RateLimitRPM,cfg.RateLimitBurst)headerNorm:=gwmw.NewHeaderNormalization(appLogger)timeoutMW:=gwmw.NewTimeoutMiddleware(appLogger,cfg)//NOTE:Routingengineexcluded(incompleteimplementation)/*routingEngine:=routing.NewEngine(appLogger)failoverState:=routing.NewFailoverState(5,30*time.Second)//5failures,30scooldownroutingHandler:=handler.NewRoutingHandler(routingEngine,failoverState,appLogger)*///Semanticcacheengine+handler(T105-T115)//EmbeddingFuncisnilhere;proxyhandlerwirestherealprovideratruntime.//Whenarealembeddingproviderisconfigured,replacenilwith://func(ctxcontext.Context,text,modelstring)([]float64,error){...}cacheEngine:=caching.NewEngine(appLogger,nil)cacheHandler:=handler.NewCacheHandler(cacheEngine,appLogger)//Analyticshandler(T116-T118)—optional,usespipelineifprovidedvaranalyticsHandler*handler.AnalyticsHandlerifanalyticsPipe!=nil{analyticsHandler=handler.NewAnalyticsHandler(analyticsPipe,appLogger)}r.Route("/v1",func(rchi.Router){r.Use(authMW.Handler)r.Use(rateLimiter.Handler)r.Use(headerNorm.Handler)//T018:Headernormalizationr.Use(timeoutMW.Handler)//T022:Per-providertimeout//CoreAIendpoints(T014,T015,T016)r.Post("/chat/completions",proxyHandler.ChatCompletions)r.Post("/embeddings",proxyHandler.Embeddings)//Modellistingr.Get("/models",proxyHandler.Models)//Providerhealth(T039)r.Get("/providers/health",proxyHandler.ProviderHealth)//ProviderconfigCRUD(T028)r.Get("/providers",providerCfgHandler.ListProviders)r.Get("/providers/{name}",providerCfgHandler.GetProvider)r.Get("/providers/{name}/models",providerCfgHandler.GetProviderModels)r.Post("/providers/{name}/test",providerCfgHandler.TestProvider)r.Get("/providers/pricing",providerCfgHandler.GetPricing)r.Post("/providers/estimate",providerCfgHandler.EstimateCost)//NOTE:Routinghandlerexcluded(incompleteimplementation)/*r.Get("/routing/rules",routingHandler.ListRules)r.Post("/routing/rules",routingHandler.CreateRule)r.Get("/routing/rules/{id}",routingHandler.GetRule)r.Put("/routing/rules/{id}",routingHandler.UpdateRule)r.Delete("/routing/rules/{id}",routingHandler.DeleteRule)r.Post("/routing/evaluate",routingHandler.EvaluateRouting)*///Semanticcachemanagement(T111-T114)r.Get("/cache/stats",cacheHandler.Stats)r.Delete("/cache",cacheHandler.FlushAll)r.Delete("/cache/{namespace}",cacheHandler.FlushNamespace)r.Delete("/cache/{namespace}/{entryId}",cacheHandler.InvalidateEntry)//Analytics(T116-T122)ifanalyticsHandler!=nil{r.Post("/analytics/cost",analyticsHandler.QueryCost)r.Post("/analytics/latency",analyticsHandler.QueryLatency)r.Get("/analytics/cache",analyticsHandler.CacheAnalytics)r.Get("/analytics/pipeline",analyticsHandler.PipelineStats)r.Get("/analytics/daily",analyticsHandler.DailyCostAggregation)r.Get("/analytics/export/csv",analyticsHandler.ExportCostCSV)}//NOTE:Experiment,Policy,andIntelligencehandlersarework-in-progress//andexcludedfromthisbuild.Uncommentwhenready./*experimentEngine:=routing.NewExperimentEngine(appLogger)experimentHandler:=handler.NewExperimentHandler(experimentEngine,appLogger)r.Get("/experiments",experimentHandler.ListExperiments)r.Post("/experiments",experimentHandler.CreateExperiment)r.Get("/experiments/{id}",experimentHandler.GetExperiment)r.Post("/experiments/{id}/start",experimentHandler.StartExperiment)r.Post("/experiments/{id}/pause",experimentHandler.PauseExperiment)r.Post("/experiments/{id}/conclude",experimentHandler.ConcludeExperiment)r.Delete("/experiments/{id}",experimentHandler.DeleteExperiment)r.Post("/experiments/{id}/assign",experimentHandler.AssignVariant)r.Post("/experiments/{id}/result",experimentHandler.RecordResult)r.Get("/experiments/{id}/metrics",experimentHandler.GetMetrics)r.Get("/experiments/{id}/compare",experimentHandler.CompareVariants)//Policymanagement(T132-T137)opaClient:=policy.NewOPAClient(policy.OPAConfig{},appLogger)policyHandler:=handler.NewPolicyHandler(opaClient,appLogger)r.Get("/policies",policyHandler.ListPolicies)r.Post("/policies",policyHandler.CreatePolicy)r.Get("/policies/templates",policyHandler.ListTemplates)//NOTE:PolicyandIntelligencehandlersarework-in-progress//andexcludedfromthisbuild.Uncommentwhenready./*r.Get("/policies/evaluations",policyHandler.GetEvaluationLog)r.Post("/policies/evaluate",policyHandler.EvaluatePolicy)r.Get("/policies/{id}",policyHandler.GetPolicy)r.Put("/policies/{id}",policyHandler.UpdatePolicy)r.Delete("/policies/{id}",policyHandler.DeletePolicy)r.Post("/policies/{id}/dry-run",policyHandler.ToggleDryRun)//Intelligence(T155-T164)classifier:=intelligence.NewClassifier(nil)forecaster:=intelligence.NewForecaster()anomalyDetector:=intelligence.NewAnomalyDetector(0,0)featureTracker:=intelligence.NewFeatureTracker()arbitrageEngine:=intelligence.NewArbitrageEngine()trafficRecorder:=intelligence.NewTrafficRecorder(0)intelHandler:=handler.NewIntelligenceHandler(classifier,forecaster,anomalyDetector,featureTracker,arbitrageEngine,trafficRecorder,appLogger,)r.Post("/intelligence/classify",intelHandler.Classify)r.Post("/intelligence/forecast",intelHandler.Forecast)r.Post("/intelligence/anomaly",intelHandler.DetectAnomaly)r.Post("/intelligence/features/cost",intelHandler.RecordFeatureCost)r.Get("/intelligence/features",intelHandler.GetFeatureCosts)r.Post("/intelligence/roi",intelHandler.CalculateROI)r.Post("/intelligence/efficiency",intelHandler.CalculateEfficiency)r.Get("/intelligence/arbitrage",intelHandler.FindArbitrage)r.Post("/intelligence/arbitrage/prices",intelHandler.UpdateArbitragePrices)r.Post("/intelligence/traffic/record",intelHandler.RecordTraffic)r.Post("/intelligence/traffic/simulate",intelHandler.SimulateTraffic)*/})returnr}//mwMaxBodySizereturnsmiddlewarethatlimitstherequestbodysize.funcmwMaxBodySize(maxBytesint64)func(http.Handler)http.Handler{ifmaxBytes<=0{maxBytes=1*1024*1024//default1MB}returnfunc(nexthttp.Handler)http.Handler{returnhttp.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){//Allowenvoverridemax:=maxBytesifv:=os.Getenv("GATEWAY_MAX_BODY_BYTES");v!=""{ifparsed,err:=strconv.ParseInt(v,10,64);err==nil&&parsed>0{max=parsed}}ifr.ContentLength>0&&r.ContentLength>max{http.Error(w,`{"error":"request_too_large","message":"requestbodytoolarge"}`,http.StatusRequestEntityTooLarge)return}r.Body=http.MaxBytesReader(w,r.Body,max)next.ServeHTTP(w,r)})}}funcmwRequestLogger(appLoggerzerolog.Logger)func(http.Handler)http.Handler{returnfunc(nexthttp.Handler)http.Handler{returnhttp.HandlerFunc(func(whttp.ResponseWriter,r*http.Request){start:=time.Now()rw:=chimw.NewWrapResponseWriter(w,r.ProtoMajor)next.ServeHTTP(rw,r)dur:=time.Since(start)reqID:=chimw.GetReqID(r.Context())appLogger.Info().Str("method",r.Method).Str("path",r.URL.Path).Str("req_id",reqID).Int("status",rw.Status()).Dur("duration",dur).Msg("requestcompleted")})}}