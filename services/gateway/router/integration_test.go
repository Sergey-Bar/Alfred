packagerouterimport("bytes""context""encoding/json""io""net/http""net/http/httptest""strings""testing""time""github.com/rs/zerolog""github.com/AlfredDev/alfred/services/gateway/config""github.com/AlfredDev/alfred/services/gateway/observability""github.com/AlfredDev/alfred/services/gateway/provider")//───TestInfrastructure─────────────────────────────────────//mockProviderimplementsprovider.Providerforintegrationtests.typemockProviderstruct{namestringmodels[]stringchatResp*provider.ChatResponseembResp*provider.EmbeddingsResponsechatErrerrorembErrerrorhealthStatusprovider.HealthStatusstreamDatastringlatencyOverlaytime.Duration}func(m*mockProvider)Name()string{returnm.name}func(m*mockProvider)Models()[]string{ifm.models!=nil{returnm.models}return[]string{"mock-model"}}func(m*mockProvider)ChatCompletion(ctxcontext.Context,req*provider.ChatRequest)(*provider.ChatResponse,error){ifm.latencyOverlay>0{time.Sleep(m.latencyOverlay)}ifm.chatErr!=nil{returnnil,m.chatErr}ifm.chatResp!=nil{returnm.chatResp,nil}return&provider.ChatResponse{ID:"test-chat-id",Model:req.Model,Choices:[]provider.Choice{{Index:0,Message:provider.ChatMessage{Role:"assistant",Content:"Hellofrommock!"},FinishReason:"stop"},},Usage:provider.Usage{PromptTokens:10,CompletionTokens:5,TotalTokens:15},},nil}func(m*mockProvider)ChatCompletionStream(ctxcontext.Context,req*provider.ChatRequest)(provider.Stream,error){data:=m.streamDataifdata==""{data="data:{\"choices\":[{\"delta\":{\"content\":\"Hi\"}}]}\n\ndata:[DONE]\n\n"}body:=io.NopCloser(strings.NewReader(data))resp:=&http.Response{StatusCode:200,Body:body}returnprovider.NewHTTPStream(resp),nil}func(m*mockProvider)Embeddings(ctxcontext.Context,req*provider.EmbeddingsRequest)(*provider.EmbeddingsResponse,error){ifm.embErr!=nil{returnnil,m.embErr}ifm.embResp!=nil{returnm.embResp,nil}return&provider.EmbeddingsResponse{Object:"list",Model:req.Model,Data:[]provider.EmbeddingData{{Embedding:[]float64{0.1,0.2,0.3},Index:0}},Usage:provider.EmbeddingsUsage{PromptTokens:5,TotalTokens:5},},nil}func(m*mockProvider)HealthCheck(ctxcontext.Context)provider.HealthStatus{ifm.healthStatus.LastCheck.IsZero(){returnprovider.HealthStatus{Healthy:true,Latency:5*time.Millisecond,LastCheck:time.Now()}}returnm.healthStatus}funcsetupIntegration(t*testing.T,opts...func(*config.Config,*provider.Registry))(http.Handler,*provider.Registry){t.Helper()cfg:=&config.Config{Addr:":0",Env:"test",RateLimitEnabled:false,APIKeyHeader:"Authorization",MaxBodyBytes:1<<20,//1MB}log:=zerolog.New(io.Discard).With().Timestamp().Logger()reg:=provider.NewRegistry()//Registeradefaultmockprovidermock:=&mockProvider{name:"openai",models:[]string{"gpt-4o","gpt-4o-mini","gpt-3.5-turbo"},}reg.Register(mock)//Allowcustomizationsfor_,opt:=rangeopts{opt(cfg,reg)}r:=NewRouter(cfg,log,reg)returnr,reg}funcauthRequest(method,pathstring,bodyio.Reader)*http.Request{req:=httptest.NewRequest(method,path,body)req.Header.Set("Authorization","Bearertest-api-key-123")req.Header.Set("Content-Type","application/json")returnreq}//───Auth&SecurityIntegrationTests───────────────────────funcTestAuthRequired_AllV1Endpoints(t*testing.T){r,_:=setupIntegration(t)paths:=[]struct{methodstringpathstring}{{http.MethodGet,"/v1/models"},{http.MethodPost,"/v1/chat/completions"},{http.MethodPost,"/v1/embeddings"},{http.MethodGet,"/v1/providers/health"},{http.MethodGet,"/v1/providers"},{http.MethodGet,"/v1/cache/stats"},}for_,tc:=rangepaths{t.Run(tc.method+""+tc.path,func(t*testing.T){req:=httptest.NewRequest(tc.method,tc.path,nil)//Noauthheaderrw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Code!=http.StatusUnauthorized{t.Errorf("%s%s:expected401,got%d",tc.method,tc.path,rw.Code)}})}}funcTestAuthPasses_WithBearerToken(t*testing.T){r,_:=setupIntegration(t)req:=authRequest(http.MethodGet,"/v1/models",nil)rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)//Shouldsucceed(200)sincemodelsdoesn'tneedaspecificproviderifrw.Code!=http.StatusOK{t.Errorf("Expected200withvalidauth,got%d:%s",rw.Code,rw.Body.String())}}//───ChatCompletionsIntegration────────────────────────────funcTestChatCompletions_Success(t*testing.T){r,_:=setupIntegration(t)body:=`{"model":"gpt-4o","messages":[{"role":"user","content":"Hello"}]}`req:=authRequest(http.MethodPost,"/v1/chat/completions",strings.NewReader(body))rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Code!=http.StatusOK{t.Fatalf("Expected200,got%d:%s",rw.Code,rw.Body.String())}varrespmap[string]interface{}iferr:=json.Unmarshal(rw.Body.Bytes(),&resp);err!=nil{t.Fatalf("Failedtodecoderesponse:%v",err)}ifresp["id"]!="test-chat-id"{t.Errorf("ResponseID=%v,wanttest-chat-id",resp["id"])}//VerifyX-Alfred-ModelheaderissetalfredModel:=rw.Header().Get("X-Alfred-Model")ifalfredModel==""{t.Error("X-Alfred-Modelheadershouldbeset")}//VerifyX-Alfred-Latency-MsheaderlatencyHeader:=rw.Header().Get("X-Alfred-Latency-Ms")iflatencyHeader==""{t.Error("X-Alfred-Latency-Msheadershouldbeset")}}funcTestChatCompletions_MissingModel(t*testing.T){r,_:=setupIntegration(t)body:=`{"messages":[{"role":"user","content":"Hello"}]}`req:=authRequest(http.MethodPost,"/v1/chat/completions",strings.NewReader(body))rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Code!=http.StatusBadRequest{t.Errorf("Expected400formissingmodel,got%d",rw.Code)}}funcTestChatCompletions_MissingMessages(t*testing.T){r,_:=setupIntegration(t)body:=`{"model":"gpt-4o"}`req:=authRequest(http.MethodPost,"/v1/chat/completions",strings.NewReader(body))rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Code!=http.StatusBadRequest{t.Errorf("Expected400formissingmessages,got%d",rw.Code)}}funcTestChatCompletions_InvalidJSON(t*testing.T){r,_:=setupIntegration(t)body:=`{invalidjson`req:=authRequest(http.MethodPost,"/v1/chat/completions",strings.NewReader(body))rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Code!=http.StatusBadRequest{t.Errorf("Expected400forinvalidJSON,got%d",rw.Code)}}funcTestChatCompletions_UnknownModel(t*testing.T){r,_:=setupIntegration(t)body:=`{"model":"nonexistent-model","messages":[{"role":"user","content":"Hello"}]}`req:=authRequest(http.MethodPost,"/v1/chat/completions",strings.NewReader(body))rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Code!=http.StatusBadRequest{t.Errorf("Expected400forunknownmodel,got%d",rw.Code)}}funcTestChatCompletions_DryRunMode(t*testing.T){r,_:=setupIntegration(t)body:=`{"model":"gpt-4o","messages":[{"role":"user","content":"Estimatethis"}]}`req:=authRequest(http.MethodPost,"/v1/chat/completions",strings.NewReader(body))req.Header.Set("X-Alfred-DryRun","true")rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Code!=http.StatusOK{t.Fatalf("Expected200fordryrun,got%d:%s",rw.Code,rw.Body.String())}varrespmap[string]interface{}iferr:=json.Unmarshal(rw.Body.Bytes(),&resp);err!=nil{t.Fatalf("Failedtodecoderesponse:%v",err)}ifresp["dry_run"]!=true{t.Error("Responseshouldindicatedry_run=true")}}//───EmbeddingsIntegration──────────────────────────────────funcTestEmbeddings_Success(t*testing.T){r,_:=setupIntegration(t)body:=`{"model":"gpt-4o","input":"Helloworld"}`req:=authRequest(http.MethodPost,"/v1/embeddings",strings.NewReader(body))rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Code!=http.StatusOK{t.Fatalf("Expected200,got%d:%s",rw.Code,rw.Body.String())}varrespmap[string]interface{}iferr:=json.Unmarshal(rw.Body.Bytes(),&resp);err!=nil{t.Fatalf("Failedtodecoderesponse:%v",err)}data,ok:=resp["data"].([]interface{})if!ok||len(data)==0{t.Error("Expectedembeddingsdatainresponse")}}funcTestEmbeddings_MissingModel(t*testing.T){r,_:=setupIntegration(t)body:=`{"input":"Hello"}`req:=authRequest(http.MethodPost,"/v1/embeddings",strings.NewReader(body))rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Code!=http.StatusBadRequest{t.Errorf("Expected400formissingmodel,got%d",rw.Code)}}//───ModelListingIntegration───────────────────────────────funcTestModels_ListsRegisteredProviders(t*testing.T){r,_:=setupIntegration(t)req:=authRequest(http.MethodGet,"/v1/models",nil)rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Code!=http.StatusOK{t.Fatalf("Expected200,got%d",rw.Code)}varrespmap[string]interface{}iferr:=json.Unmarshal(rw.Body.Bytes(),&resp);err!=nil{t.Fatalf("Failedtodecode:%v",err)}data,ok:=resp["data"].([]interface{})if!ok{t.Fatal("Expecteddataarray")}//Ourmockregisters3modelsiflen(data)<1{t.Errorf("Expectedatleast1model,got%d",len(data))}//Verifymodelstructurefirst:=data[0].(map[string]interface{})iffirst["object"]!="model"{t.Errorf("Expectedobject=model,got%v",first["object"])}iffirst["provider"]!="openai"{t.Errorf("Expectedprovider=openai,got%v",first["provider"])}}funcTestModels_MultipleProviders(t*testing.T){r,_:=setupIntegration(t,func(cfg*config.Config,reg*provider.Registry){reg.Register(&mockProvider{name:"anthropic",models:[]string{"claude-3-opus","claude-3-haiku"}})})req:=authRequest(http.MethodGet,"/v1/models",nil)rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)varrespmap[string]interface{}_=json.Unmarshal(rw.Body.Bytes(),&resp)data:=resp["data"].([]interface{})//3fromopenaimock+2fromanthropicmock=5iflen(data)!=5{t.Errorf("Expected5models,got%d",len(data))}}//───ProviderHealthIntegration─────────────────────────────funcTestProviderHealth_ReturnsStatus(t*testing.T){r,_:=setupIntegration(t)req:=authRequest(http.MethodGet,"/v1/providers/health",nil)rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Code!=http.StatusOK{t.Fatalf("Expected200,got%d",rw.Code)}varrespmap[string]interface{}iferr:=json.Unmarshal(rw.Body.Bytes(),&resp);err!=nil{t.Fatalf("Failedtodecode:%v",err)}openai,ok:=resp["openai"].(map[string]interface{})if!ok{t.Fatal("Expectedopenaiinhealthresponse")}ifopenai["healthy"]!=true{t.Error("Expectedopenaitobehealthy")}}//───ProviderConfigIntegration─────────────────────────────funcTestProviders_ListRegistered(t*testing.T){r,_:=setupIntegration(t)req:=authRequest(http.MethodGet,"/v1/providers",nil)rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Code!=http.StatusOK{t.Fatalf("Expected200,got%d:%s",rw.Code,rw.Body.String())}}//───CacheEndpointsIntegration─────────────────────────────funcTestCacheStats_ReturnsStats(t*testing.T){r,_:=setupIntegration(t)req:=authRequest(http.MethodGet,"/v1/cache/stats",nil)rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Code!=http.StatusOK{t.Fatalf("Expected200,got%d",rw.Code)}varrespmap[string]interface{}iferr:=json.Unmarshal(rw.Body.Bytes(),&resp);err!=nil{t.Fatalf("Failedtodecode:%v",err)}}funcTestCacheFlush_All(t*testing.T){r,_:=setupIntegration(t)req:=authRequest(http.MethodDelete,"/v1/cache",nil)rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)//Shouldsucceedevenwithemptycacheifrw.Code!=http.StatusOK{t.Errorf("Expected200,got%d",rw.Code)}}//───OpenAPI&DocsIntegration──────────────────────────────funcTestOpenAPISpec_Served(t*testing.T){r,_:=setupIntegration(t)req:=httptest.NewRequest(http.MethodGet,"/openapi.json",nil)rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Code!=http.StatusOK{t.Fatalf("Expected200,got%d",rw.Code)}ct:=rw.Header().Get("Content-Type")if!strings.Contains(ct,"application/json"){t.Errorf("Content-Type=%q,wantapplication/json",ct)}varspecmap[string]interface{}iferr:=json.Unmarshal(rw.Body.Bytes(),&spec);err!=nil{t.Fatalf("FailedtodecodeOpenAPIspec:%v",err)}ifspec["openapi"]==nil{t.Error("OpenAPIspecshouldcontain'openapi'field")}ifspec["info"]==nil{t.Error("OpenAPIspecshouldcontain'info'field")}}funcTestSwaggerUI_Served(t*testing.T){r,_:=setupIntegration(t)req:=httptest.NewRequest(http.MethodGet,"/docs",nil)rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Code!=http.StatusOK{t.Fatalf("Expected200,got%d",rw.Code)}ct:=rw.Header().Get("Content-Type")if!strings.Contains(ct,"text/html"){t.Errorf("Content-Type=%q,wanttext/html",ct)}body:=rw.Body.String()if!strings.Contains(body,"swagger-ui"){t.Error("ExpectedSwaggerUIHTML")}}//───RateLimitingIntegration───────────────────────────────funcTestRateLimiting_WhenEnabled(t*testing.T){r,_:=setupIntegration(t,func(cfg*config.Config,reg*provider.Registry){cfg.RateLimitEnabled=truecfg.RateLimitRPM=5cfg.RateLimitBurst=2})//Firstfewrequestsshouldsucceedfori:=0;i<2;i++{req:=authRequest(http.MethodGet,"/v1/models",nil)rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Code!=http.StatusOK{t.Fatalf("Request%d:expected200,got%d",i,rw.Code)}}//Eventuallyshouldgetratelimited(429)rateLimited:=falsefori:=0;i<20;i++{req:=authRequest(http.MethodGet,"/v1/models",nil)rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Code==http.StatusTooManyRequests{rateLimited=truebreak}}if!rateLimited{t.Error("Expectedratelimitingtokickinafterburst")}}//───BodySizeLimitIntegration─────────────────────────────funcTestBodySizeLimit_Enforced(t*testing.T){r,_:=setupIntegration(t,func(cfg*config.Config,reg*provider.Registry){cfg.MaxBodyBytes=100//100bytesmax})//Createabodylargerthan100byteslargeBody:=strings.Repeat("x",200)body:=`{"model":"gpt-4o","messages":[{"role":"user","content":"`+largeBody+`"}]}`req:=authRequest(http.MethodPost,"/v1/chat/completions",strings.NewReader(body))rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)//Shouldgeterror(413or400dependingonimplementation)ifrw.Code==http.StatusOK{t.Error("Expectederrorforoversizedbody,got200")}}//───RequestIDPropagation──────────────────────────────────funcTestRequestID_Generated(t*testing.T){r,_:=setupIntegration(t)req:=httptest.NewRequest(http.MethodGet,"/healthz",nil)rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)//chimiddlewareshouldgeneraterequestIDs//TheIDisusuallyintheresponseorloggingcontext//Atminimum,therequestshouldsucceedifrw.Code!=http.StatusOK{t.Errorf("Expected200,got%d",rw.Code)}}//───MetricsEndpointIntegration────────────────────────────funcTestMetricsEndpoint_WithMetrics(t*testing.T){log:=zerolog.New(io.Discard).With().Timestamp().Logger()metrics:=observability.NewMetrics(log)cfg:=&config.Config{Addr:":0",Env:"test",RateLimitEnabled:false,APIKeyHeader:"Authorization",MaxBodyBytes:1<<20,}reg:=provider.NewRegistry()reg.Register(&mockProvider{name:"openai",models:[]string{"gpt-4o"}})r:=NewRouter(cfg,log,reg,metrics)req:=httptest.NewRequest(http.MethodGet,"/metrics",nil)rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Code!=http.StatusOK{t.Fatalf("Expected200for/metrics,got%d",rw.Code)}body:=rw.Body.String()if!strings.Contains(body,"alfred"){t.Error("Metricsresponseshouldcontain'alfred'prefix")}}funcTestMetricsEndpoint_NoAuthRequired(t*testing.T){log:=zerolog.New(io.Discard).With().Timestamp().Logger()metrics:=observability.NewMetrics(log)cfg:=&config.Config{Addr:":0",Env:"test",RateLimitEnabled:false,APIKeyHeader:"Authorization",MaxBodyBytes:1<<20,}reg:=provider.NewRegistry()r:=NewRouter(cfg,log,reg,metrics)//Noauthheader—/metricsshouldstillworkreq:=httptest.NewRequest(http.MethodGet,"/metrics",nil)rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Code!=http.StatusOK{t.Errorf("Expected200for/metricswithoutauth,got%d",rw.Code)}}//───PricingEndpointsIntegration───────────────────────────funcTestPricingEndpoint_Success(t*testing.T){r,_:=setupIntegration(t)req:=authRequest(http.MethodGet,"/v1/providers/pricing",nil)rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Code!=http.StatusOK{t.Fatalf("Expected200,got%d",rw.Code)}}funcTestEstimateCost_Success(t*testing.T){r,_:=setupIntegration(t)body:=`{"model":"gpt-4o","input_tokens":100,"output_tokens":50}`req:=authRequest(http.MethodPost,"/v1/providers/estimate",strings.NewReader(body))rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Code!=http.StatusOK{t.Fatalf("Expected200,got%d:%s",rw.Code,rw.Body.String())}varrespmap[string]interface{}_=json.Unmarshal(rw.Body.Bytes(),&resp)ifresp["model"]!="gpt-4o"{t.Errorf("Expectedmodel=gpt-4o,got%v",resp["model"])}}//───404forUnknownRoutes──────────────────────────────────funcTestUnknownRoute_Returns404(t*testing.T){r,_:=setupIntegration(t)req:=httptest.NewRequest(http.MethodGet,"/v1/nonexistent",nil)req.Header.Set("Authorization","Bearertest-key")rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)//chireturns405forknownmethodsonunknownroutes,or404ifrw.Code!=http.StatusNotFound&&rw.Code!=http.StatusMethodNotAllowed{t.Errorf("Expected404or405,got%d",rw.Code)}}//───StreamingIntegration───────────────────────────────────funcTestChatCompletions_StreamingHeaders(t*testing.T){r,_:=setupIntegration(t)body:=`{"model":"gpt-4o","messages":[{"role":"user","content":"Hello"}],"stream":true}`req:=authRequest(http.MethodPost,"/v1/chat/completions",strings.NewReader(body))rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Code!=http.StatusOK{t.Fatalf("Expected200,got%d:%s",rw.Code,rw.Body.String())}ct:=rw.Header().Get("Content-Type")if!strings.Contains(ct,"text/event-stream"){t.Errorf("Content-Type=%q,wanttext/event-stream",ct)}//Verifystreamingdatawasreturnedifrw.Body.Len()==0{t.Error("Expectednon-emptystreamingresponsebody")}}//───ConcurrentRequestsIntegration─────────────────────────funcTestConcurrentRequests_NoRace(t*testing.T){r,_:=setupIntegration(t)done:=make(chanbool,20)fori:=0;i<20;i++{gofunc(){deferfunc(){done<-true}()body:=`{"model":"gpt-4o","messages":[{"role":"user","content":"Hello"}]}`req:=authRequest(http.MethodPost,"/v1/chat/completions",strings.NewReader(body))rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Code!=http.StatusOK{t.Errorf("Concurrentrequestfailed:%d",rw.Code)}}()}fori:=0;i<20;i++{<-done}}//───ResponseFormatConsistency─────────────────────────────funcTestErrorResponse_Format(t*testing.T){r,_:=setupIntegration(t)//Triggeravalidationerrorbody:=`{"messages":[{"role":"user","content":"Hello"}]}`req:=authRequest(http.MethodPost,"/v1/chat/completions",strings.NewReader(body))rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)varrespmap[string]interface{}iferr:=json.Unmarshal(rw.Body.Bytes(),&resp);err!=nil{t.Fatalf("ErrorresponseshouldbevalidJSON:%v",err)}errObj,ok:=resp["error"].(map[string]interface{})if!ok{t.Fatal("Errorresponseshouldcontain'error'object")}iferrObj["type"]==nil{t.Error("Errorshouldcontain'type'field")}iferrObj["message"]==nil{t.Error("Errorshouldcontain'message'field")}}//───ProviderTestEndpointIntegration──────────────────────funcTestProviderTest_Success(t*testing.T){r,_:=setupIntegration(t)req:=authRequest(http.MethodPost,"/v1/providers/openai/test",nil)//SetContent-Lengthforemptybodyreq.Header.Set("Content-Length","0")req.Body=io.NopCloser(bytes.NewReader(nil))rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)//Shouldreturneithersuccessorerror(not404)ifrw.Code==http.StatusNotFound{t.Error("Providertestendpointshouldberegistered")}}funcTestProviderModels_ListSpecificProvider(t*testing.T){r,_:=setupIntegration(t)req:=authRequest(http.MethodGet,"/v1/providers/openai/models",nil)rw:=httptest.NewRecorder()r.ServeHTTP(rw,req)ifrw.Code!=http.StatusOK{t.Fatalf("Expected200,got%d:%s",rw.Code,rw.Body.String())}}