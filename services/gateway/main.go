/*AlfredGateway-MainEntryPointThisistheentrypointfortheAlfredAPIGatewayservice.Itinitializesallsubsystems(config,logging,Redis,providers,routing)andstartsanHTTPserverwithgracefulshutdownsupport.ThegatewayactsasaproxybetweenclientsandLLMproviders,handlingquotaenforcement,caching,routing,andobservability.*/packagemainimport("context""net/http""os""os/signal""syscall""time""github.com/AlfredDev/alfred/services/gateway/analytics""github.com/AlfredDev/alfred/services/gateway/config""github.com/AlfredDev/alfred/services/gateway/logger""github.com/AlfredDev/alfred/services/gateway/observability""github.com/AlfredDev/alfred/services/gateway/profiling""github.com/AlfredDev/alfred/services/gateway/provider""github.com/AlfredDev/alfred/services/gateway/redisclient""github.com/AlfredDev/alfred/services/gateway/router""github.com/rs/zerolog")funcmain(){cfg:=config.Load()log:=logger.New(cfg)log.Info().Str("env",cfg.Env).Msg("alfredgatewaystarting")//InitializeRediswithcircuitbreaker(T298)rc,err:=redisclient.New(cfg,log)iferr!=nil{log.Warn().Err(err).Msg("redisinitfailed—continuingwithoutRedis")}//Initializeproviderregistryregistry:=provider.NewRegistry()registerProviders(cfg,registry,log)//Startanalyticspipeline(T116-T118)varanalyticsSinkanalytics.SinkifchDSN:=os.Getenv("CLICKHOUSE_DSN");chDSN!=""{chSink,err:=analytics.NewClickHouseSink(chDSN,log)iferr!=nil{log.Warn().Err(err).Msg("clickhousesinkinitfailed—fallingbacktologsink")analyticsSink=analytics.NewLogSink(log)}else{analyticsSink=chSinklog.Info().Msg("clickhouseanalyticssinkconnected")}}else{analyticsSink=analytics.NewLogSink(log)log.Info().Msg("analyticsusinglogsink(setCLICKHOUSE_DSNforproduction)")}analyticsPipeline:=analytics.NewPipeline(log,analyticsSink)analyticsPipeline.Start(context.Background())//Initializeobservability(T144-T145)metrics:=observability.NewMetrics(log)traceExporter:=observability.NewLogExporter(log)tracer:=observability.NewTracer(log,traceExporter,1.0)//sample100%indev//Initializeprofilingserver(T204-Performanceprofiling)profilingEnabled:=os.Getenv("ALFRED_PROFILING_ENABLED")=="true"profilingToken:=os.Getenv("ALFRED_PROFILING_TOKEN")ifprofilingToken==""{profilingToken="default-dev-token-change-in-production"}profiler:=profiling.New(log,profiling.Config{Enabled:profilingEnabled,AuthToken:profilingToken,LatencyTarget:100*time.Millisecond,//P95targetAutoProfile:true,Port:6060,})iferr:=profiler.Start(6060);err!=nil{log.Warn().Err(err).Msg("profilingserverstartfailed")}elseifprofilingEnabled{log.Info().Msg("profilingserverstartedon:6060")log.Info().Msg("accesswith:curl-H'Authorization:Bearer<token>'http://localhost:6060/debug/pprof/")}//Createrouterwithallmiddlewareandhandlersr:=router.NewRouter(cfg,log,registry,analyticsPipeline,metrics,tracer,rc)//CreateHTTPserverwithtimeoutssrv:=&http.Server{Addr:cfg.Addr,Handler:r,ReadTimeout:30*time.Second,WriteTimeout:cfg.DefaultTimeout+10*time.Second,//extrabufferforstreamingIdleTimeout:120*time.Second,}//Startbackgroundproviderhealthpoller(T039)healthPoller:=provider.NewHealthPoller(registry,log,30*time.Second)healthPoller.OnStatusChange(func(namestring,healthybool,statusprovider.HealthStatus){ifhealthy{log.Info().Str("provider",name).Msg("providerrecovered")}else{log.Error().Str("provider",name).Str("error",status.Error).Msg("providerdegraded")}})healthPoller.Start()//Startbackgroundmodellistsyncer(T040)modelSyncer:=provider.NewModelSyncer(registry,log,5*time.Minute)modelSyncer.Start()//Gracefulshutdownhandlingdone:=make(chanos.Signal,1)signal.Notify(done,os.Interrupt,syscall.SIGTERM)gofunc(){log.Info().Str("addr",cfg.Addr).Msg("gatewaylistening")iferr:=srv.ListenAndServe();err!=nil&&err!=http.ErrServerClosed{log.Fatal().Err(err).Msg("serverfailed")}}()<-donelog.Info().Msg("shutdownsignalreceived")//StopbackgroundtaskshealthPoller.Stop()modelSyncer.Stop()analyticsPipeline.Stop()tracer.Shutdown()//CloseRedisconnection(T298)ifrc!=nil{iferr:=rc.Close();err!=nil{log.Warn().Err(err).Msg("rediscloseerror")}}ctx,cancel:=context.WithTimeout(context.Background(),cfg.GracefulTimeout)defercancel()iferr:=srv.Shutdown(ctx);err!=nil{log.Error().Err(err).Msg("gracefulshutdownfailed")}else{log.Info().Msg("gatewaystoppedgracefully")}}funcregisterProviders(cfg*config.Config,registry*provider.Registry,logzerolog.Logger){//RegisterOpenAIproviderifAPIkeyisavailableifkey:=os.Getenv("OPENAI_API_KEY");key!=""{openai:=provider.NewOpenAIProvider(provider.ProviderConfig{Name:"openai",APIKey:key,Timeout:cfg.ProviderTimeout("openai"),})registry.Register(openai)log.Info().Msg("registeredopenaiprovider")}//RegisterAnthropicproviderifAPIkeyisavailableifkey:=os.Getenv("ANTHROPIC_API_KEY");key!=""{anthropic:=provider.NewAnthropicProvider(provider.ProviderConfig{Name:"anthropic",APIKey:key,Timeout:cfg.ProviderTimeout("anthropic"),})registry.Register(anthropic)log.Info().Msg("registeredanthropicprovider")}//RegisterGoogleGeminiproviderifAPIkeyisavailableifkey:=os.Getenv("GEMINI_API_KEY");key!=""{gemini:=provider.NewGeminiProvider(provider.ProviderConfig{Name:"google",APIKey:key,Timeout:cfg.ProviderTimeout("google"),})registry.Register(gemini)log.Info().Msg("registeredgooglegeminiprovider")}//RegisterAzureOpenAIproviderifendpointandkeyareavailableifendpoint:=os.Getenv("AZURE_OPENAI_ENDPOINT");endpoint!=""{ifkey:=os.Getenv("AZURE_OPENAI_KEY");key!=""{azure:=provider.NewAzureOpenAIProvider(provider.ProviderConfig{Name:"azure",BaseURL:endpoint,APIKey:key,Timeout:cfg.ProviderTimeout("azure"),})registry.Register(azure)log.Info().Msg("registeredazureopenaiprovider")}}//RegisterMistralprovider(T034)ifkey:=os.Getenv("MISTRAL_API_KEY");key!=""{mistral:=provider.NewMistralProvider(provider.ProviderConfig{Name:"mistral",APIKey:key,Timeout:cfg.ProviderTimeout("mistral"),})registry.Register(mistral)log.Info().Msg("registeredmistralprovider")}//RegisterTogetherAIprovider(T035)ifkey:=os.Getenv("TOGETHER_API_KEY");key!=""{together:=provider.NewTogetherProvider(provider.ProviderConfig{Name:"together",APIKey:key,Timeout:cfg.ProviderTimeout("together"),})registry.Register(together)log.Info().Msg("registeredtogetheraiprovider")}//RegisterGroqprovider(T036)ifkey:=os.Getenv("GROQ_API_KEY");key!=""{groq:=provider.NewGroqProvider(provider.ProviderConfig{Name:"groq",APIKey:key,Timeout:cfg.ProviderTimeout("groq"),})registry.Register(groq)log.Info().Msg("registeredgroqprovider")}//RegisterCohereprovider(T033)ifkey:=os.Getenv("COHERE_API_KEY");key!=""{cohere:=provider.NewCohereProvider(provider.ProviderConfig{Name:"cohere",APIKey:key,Timeout:cfg.ProviderTimeout("cohere"),})registry.Register(cohere)log.Info().Msg("registeredcohereprovider")}//RegisterAWSBedrockprovider(T032)ifaccessKey:=os.Getenv("AWS_ACCESS_KEY_ID");accessKey!=""{ifsecretKey:=os.Getenv("AWS_SECRET_ACCESS_KEY");secretKey!=""{region:=os.Getenv("AWS_REGION")ifregion==""{region="us-east-1"}bedrock:=provider.NewBedrockProvider(provider.BedrockConfig{ProviderConfig:provider.ProviderConfig{Name:"bedrock",Timeout:cfg.ProviderTimeout("bedrock"),},Region:region,AccessKey:accessKey,SecretKey:secretKey,})registry.Register(bedrock)log.Info().Str("region",region).Msg("registeredawsbedrockprovider")}}//RegisterOllamaself-hostedprovider(T037)ifbaseURL:=os.Getenv("OLLAMA_BASE_URL");baseURL!=""{ollama:=provider.NewOllamaProvider(provider.ProviderConfig{Name:"ollama",BaseURL:baseURL,Timeout:cfg.ProviderTimeout("ollama"),})registry.Register(ollama)log.Info().Str("url",baseURL).Msg("registeredollamaprovider")}//RegistervLLMself-hostedprovider(T038)ifbaseURL:=os.Getenv("VLLM_BASE_URL");baseURL!=""{vllm:=provider.NewVLLMProvider(provider.ProviderConfig{Name:"vllm",BaseURL:baseURL,Timeout:cfg.ProviderTimeout("vllm"),})registry.Register(vllm)log.Info().Str("url",baseURL).Msg("registeredvllmprovider")}log.Info().Int("providers",len(registry.List())).Msg("providerregistrationcomplete")}