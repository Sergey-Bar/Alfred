packagestreamingimport("sync")const(//DefaultChunkSizeisthebuffersizeforstreamingchunks.//SSElinesaretypically<500bytes;4KiBhandlesmulti-linechunks.DefaultChunkSize=4096//LargeChunkSizeisusedforbatch/embeddingresponses.LargeChunkSize=16384//MaxPooledSizecapsthemaximumbuffersizethatgetsreturnedtothepool.//Bufferslargerthanthisarediscardedtopreventmemorybloat.MaxPooledSize=65536)//BufferPoolprovidesasync.Pool-basedbufferallocatorforstreaming.//Insteadystate,Next()callsrequirezeroallocations.typeBufferPoolstruct{poolsync.Poolsizeint}//NewBufferPoolcreatesapoolthatdispensesbyteslicesofthegivensize.funcNewBufferPool(sizeint)*BufferPool{ifsize<=0{size=DefaultChunkSize}bp:=&BufferPool{size:size}bp.pool=sync.Pool{New:func()interface{}{b:=make([]byte,bp.size)return&b},}returnbp}//Getretrievesabufferfromthepool.ThecallermustcallPut()whendone.func(bp*BufferPool)Get()[]byte{ptr:=bp.pool.Get().(*[]byte)buf:=*ptr//Ensurethebufferisatleasttheexpectedsize(poolmayhavebeenreset).ifcap(buf)<bp.size{buf=make([]byte,bp.size)}returnbuf[:bp.size]}//Putreturnsabuffertothepool.Oversizedbuffersarediscarded.func(bp*BufferPool)Put(buf[]byte){ifcap(buf)>MaxPooledSize{return//Don'tpooloversizedbuffers}b:=buf[:cap(buf)]bp.pool.Put(&b)}//Sizereturnsthedefaultbuffersize.func(bp*BufferPool)Size()int{returnbp.size}//───GlobalPools────────────────────────────────────────────var(//ChunkPoolistheglobalbufferpoolforSSEstreamingchunks.ChunkPool=NewBufferPool(DefaultChunkSize)//LargePoolistheglobalbufferpoolforlargepayloads.LargePool=NewBufferPool(LargeChunkSize))