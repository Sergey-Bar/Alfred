packagestreamingimport("io""sync""sync/atomic""testing""time")//───BufferPoolTests───────────────────────────────────────funcTestBufferPool_GetReturnsCorrectSize(t*testing.T){pool:=NewBufferPool(1024)buf:=pool.Get()iflen(buf)!=1024{t.Errorf("Expectedbuffersize1024,got%d",len(buf))}pool.Put(buf)}funcTestBufferPool_DefaultSize(t*testing.T){pool:=NewBufferPool(0)ifpool.Size()!=DefaultChunkSize{t.Errorf("Expecteddefaultsize%d,got%d",DefaultChunkSize,pool.Size())}}funcTestBufferPool_NegativeSize(t*testing.T){pool:=NewBufferPool(-1)ifpool.Size()!=DefaultChunkSize{t.Errorf("Expecteddefaultsizefornegativeinput")}}funcTestBufferPool_PutAndGet_Reuse(t*testing.T){pool:=NewBufferPool(256)//Getandputmultipletimestowarmthepoolfori:=0;i<10;i++{buf:=pool.Get()buf[0]=byte(i)pool.Put(buf)}//Poolshouldreturnabuffer(maybereused)buf:=pool.Get()iflen(buf)!=256{t.Errorf("Expectedsize256afterreuse,got%d",len(buf))}pool.Put(buf)}funcTestBufferPool_OversizedBufferDiscarded(t*testing.T){pool:=NewBufferPool(256)//Createanoversizedbufferoversized:=make([]byte,MaxPooledSize+1)pool.Put(oversized)//Shouldbediscarded,noterror//Poolshouldstillworkbuf:=pool.Get()iflen(buf)!=256{t.Errorf("Expected256,got%d",len(buf))}pool.Put(buf)}funcTestBufferPool_ConcurrentAccess(t*testing.T){pool:=NewBufferPool(DefaultChunkSize)varwgsync.WaitGroupconstgoroutines=100constiterations=1000fori:=0;i<goroutines;i++{wg.Add(1)gofunc(){deferwg.Done()forj:=0;j<iterations;j++{buf:=pool.Get()iflen(buf)!=DefaultChunkSize{t.Errorf("Wrongsize:%d",len(buf))return}//Simulateworkbuf[0]=42pool.Put(buf)}}()}wg.Wait()}funcTestGlobalPools_Initialized(t*testing.T){ifChunkPool==nil{t.Fatal("ChunkPoolshouldbeinitialized")}ifChunkPool.Size()!=DefaultChunkSize{t.Errorf("ChunkPoolsize=%d,want%d",ChunkPool.Size(),DefaultChunkSize)}ifLargePool==nil{t.Fatal("LargePoolshouldbeinitialized")}ifLargePool.Size()!=LargeChunkSize{t.Errorf("LargePoolsize=%d,want%d",LargePool.Size(),LargeChunkSize)}}//───MockStream─────────────────────────────────────────────typemockStreamstruct{chunks[][]byteindexintclosedbool}funcnewMockStream(chunks...string)*mockStream{ms:=&mockStream{}for_,c:=rangechunks{ms.chunks=append(ms.chunks,[]byte(c))}returnms}func(ms*mockStream)Next()([]byte,error){ifms.index>=len(ms.chunks){returnnil,io.EOF}chunk:=ms.chunks[ms.index]ms.index++returnchunk,nil}func(ms*mockStream)Close()error{ms.closed=truereturnnil}//───MockObserver───────────────────────────────────────────typemockObserverstruct{chunks[][]byteindices[]intdoneboolstatsStreamStatsmusync.Mutex}func(o*mockObserver)OnChunk(chunk[]byte,indexint){o.mu.Lock()//Copychunksincewe'retoldnottoretainitc:=make([]byte,len(chunk))copy(c,chunk)o.chunks=append(o.chunks,c)o.indices=append(o.indices,index)o.mu.Unlock()}func(o*mockObserver)OnDone(statsStreamStats){o.mu.Lock()o.done=trueo.stats=statso.mu.Unlock()}//───MeteredStreamTests────────────────────────────────────funcTestMeteredStream_ReadAll(t*testing.T){inner:=newMockStream("chunk1","chunk2","chunk3")ms:=NewMeteredStream(inner)varchunks[]stringfor{chunk,err:=ms.Next()iferr==io.EOF{break}iferr!=nil{t.Fatalf("Unexpectederror:%v",err)}chunks=append(chunks,string(chunk))}iflen(chunks)!=3{t.Fatalf("Expected3chunks,got%d",len(chunks))}expected:=[]string{"chunk1","chunk2","chunk3"}fori,c:=rangechunks{ifc!=expected[i]{t.Errorf("Chunk%d=%q,want%q",i,c,expected[i])}}ms.Close()}funcTestMeteredStream_TracksStats(t*testing.T){inner:=newMockStream("hello","world")ms:=NewMeteredStream(inner)for{_,err:=ms.Next()iferr==io.EOF{break}}stats:=ms.Stats()ifstats.TotalChunks!=2{t.Errorf("TotalChunks=%d,want2",stats.TotalChunks)}ifstats.TotalBytes!=10{//"hello"+"world"t.Errorf("TotalBytes=%d,want10",stats.TotalBytes)}ifstats.Duration<0{t.Error("Durationshouldnotbenegative")}ifstats.AvgChunkBytes!=5.0{t.Errorf("AvgChunkBytes=%f,want5.0",stats.AvgChunkBytes)}ms.Close()}funcTestMeteredStream_FirstChunkTiming(t*testing.T){inner:=newMockStream("first","second")ms:=NewMeteredStream(inner)time.Sleep(5*time.Millisecond)_,_=ms.Next()//firstchunk_,_=ms.Next()_,_=ms.Next()//EOFstats:=ms.Stats()ifstats.FirstChunkAt<5*time.Millisecond{t.Errorf("FirstChunkAt=%v,expected>=5ms",stats.FirstChunkAt)}ms.Close()}funcTestMeteredStream_ObserverNotified(t*testing.T){inner:=newMockStream("data1","data2","data3")obs:=&mockObserver{}ms:=NewMeteredStream(inner,obs)for{_,err:=ms.Next()iferr==io.EOF{break}}ms.Close()iflen(obs.chunks)!=3{t.Fatalf("Observergot%dchunks,want3",len(obs.chunks))}if!obs.done{t.Error("ObservershouldhavereceivedOnDone")}ifobs.stats.TotalChunks!=3{t.Errorf("OnDonestatsTotalChunks=%d,want3",obs.stats.TotalChunks)}//Verifyindicesare1-basedandsequentialfori,idx:=rangeobs.indices{ifidx!=i+1{t.Errorf("Chunkindex%d=%d,want%d",i,idx,i+1)}}}funcTestMeteredStream_MultipleObservers(t*testing.T){inner:=newMockStream("a","b")obs1:=&mockObserver{}obs2:=&mockObserver{}ms:=NewMeteredStream(inner,obs1,obs2)for{_,err:=ms.Next()iferr==io.EOF{break}}ms.Close()iflen(obs1.chunks)!=2{t.Errorf("Observer1got%dchunks,want2",len(obs1.chunks))}iflen(obs2.chunks)!=2{t.Errorf("Observer2got%dchunks,want2",len(obs2.chunks))}}funcTestMeteredStream_AddObserverMidStream(t*testing.T){inner:=newMockStream("a","b","c")ms:=NewMeteredStream(inner)_,_=ms.Next()//"a"obs:=&mockObserver{}ms.AddObserver(obs)_,_=ms.Next()//"b"—observershouldseethis_,_=ms.Next()//"c"_,_=ms.Next()//EOFms.Close()iflen(obs.chunks)!=2{t.Errorf("Lateobservergot%dchunks,want2",len(obs.chunks))}}funcTestMeteredStream_CloseIdempotent(t*testing.T){inner:=newMockStream("data")ms:=NewMeteredStream(inner)err1:=ms.Close()err2:=ms.Close()iferr1!=nil{t.Errorf("Firstcloseerror:%v",err1)}iferr2!=nil{t.Errorf("Secondcloseerror:%v",err2)}}funcTestMeteredStream_NextAfterClose(t*testing.T){inner:=newMockStream("data")ms:=NewMeteredStream(inner)ms.Close()_,err:=ms.Next()iferr!=io.EOF{t.Errorf("NextaftercloseshouldreturnEOF,got%v",err)}}funcTestMeteredStream_EmptyStream(t*testing.T){inner:=newMockStream()//Nochunksobs:=&mockObserver{}ms:=NewMeteredStream(inner,obs)_,err:=ms.Next()iferr!=io.EOF{t.Errorf("ExpectedEOFonemptystream,got%v",err)}ms.Close()ifobs.stats.TotalChunks!=0{t.Errorf("TotalChunksshouldbe0,got%d",obs.stats.TotalChunks)}}funcTestMeteredStream_ConcurrentReads(t*testing.T){//Generatemanychunkschunks:=make([]string,100)fori:=rangechunks{chunks[i]="chunk"}inner:=newMockStream(chunks...)ms:=NewMeteredStream(inner)vartotalReadint64varwgsync.WaitGroup//Note:concurrentreadsonastreamaren'ttypicalinproduction,//butthisteststheatomiccountersafety.fori:=0;i<10;i++{wg.Add(1)gofunc(){deferwg.Done()for{_,err:=ms.Next()iferr==io.EOF{return}iferr!=nil{return}atomic.AddInt64(&totalRead,1)}}()}wg.Wait()ms.Close()stats:=ms.Stats()ifstats.TotalChunks==0{t.Error("Shouldhavereadsomechunks")}}//───SSEContentExtractionTests────────────────────────────funcTestExtractSSEContent_StandardFormat(t*testing.T){tests:=[]struct{namestringinputstringwantstring}{{name:"standarddeltacontent",input:`data:{"choices":[{"delta":{"content":"Hello"}}]}`,want:"Hello",},{name:"singleword",input:`data:{"choices":[{"delta":{"content":"World"}}]}`,want:"World",},{name:"donesignal",input:"data:[DONE]",want:"",},{name:"nocontentfield",input:`data:{"choices":[{"delta":{"role":"assistant"}}]}`,want:"",},{name:"emptycontent",input:`data:{"choices":[{"delta":{"content":""}}]}`,want:"",},{name:"multilinechunk",input:"data:{\"choices\":[{\"delta\":{\"content\":\"Hi\"}}]}\n\ndata:[DONE]\n",want:"Hi",},{name:"non-dataline",input:":keep-alive",want:"",},{name:"emptyinput",input:"",want:"",},}for_,tc:=rangetests{t.Run(tc.name,func(t*testing.T){got:=ExtractSSEContent([]byte(tc.input))ifgot!=tc.want{t.Errorf("ExtractSSEContent(%q)=%q,want%q",tc.input,got,tc.want)}})}}//───TokenEstimatorTests───────────────────────────────────funcTestTokenEstimator_EstimatesTokens(t*testing.T){te:=NewTokenEstimator()//SimulateSSEchunkswithcontentchunks:=[]string{`data:{"choices":[{"delta":{"content":"Hello"}}]}`,//5chars→2tokens`data:{"choices":[{"delta":{"content":"World"}}]}`,//5chars→2tokens`data:{"choices":[{"delta":{"content":"Streaming"}}]}`,//9chars→3tokens`data:[DONE]`,//nocontent}fori,c:=rangechunks{te.OnChunk([]byte(c),i+1)}tokens:=te.EstimatedTokens()iftokens!=7{//2+2+3t.Errorf("EstimatedTokens=%d,want7",tokens)}count:=te.ChunkCount()ifcount!=3{//3content-bearingchunks(notDONE)t.Errorf("ChunkCount=%d,want3",count)}}funcTestTokenEstimator_EmptyChunks(t*testing.T){te:=NewTokenEstimator()te.OnChunk([]byte("data:[DONE]"),1)te.OnChunk([]byte(":keep-alive"),2)ifte.EstimatedTokens()!=0{t.Errorf("Expected0tokensfornon-contentchunks")}}funcTestTokenEstimator_OnDone(t*testing.T){te:=NewTokenEstimator()//OnDoneshouldnotpanicte.OnDone(StreamStats{TotalChunks:10})}funcTestTokenEstimator_ConcurrentOnChunk(t*testing.T){te:=NewTokenEstimator()varwgsync.WaitGroupfori:=0;i<100;i++{wg.Add(1)gofunc(idxint){deferwg.Done()chunk:=`data:{"choices":[{"delta":{"content":"word"}}]}`te.OnChunk([]byte(chunk),idx)}(i)}wg.Wait()ifte.ChunkCount()!=100{t.Errorf("ChunkCount=%d,want100",te.ChunkCount())}}//───Integration:MeteredStream+TokenEstimator─────────────funcTestMeteredStream_WithTokenEstimator(t*testing.T){chunks:=[]string{`data:{"choices":[{"delta":{"content":"Hello"}}]}`+"\n\n",`data:{"choices":[{"delta":{"content":"world"}}]}`+"\n\n","data:[DONE]\n\n",}inner:=newMockStream(chunks...)te:=NewTokenEstimator()ms:=NewMeteredStream(inner,te)for{_,err:=ms.Next()iferr==io.EOF{break}}ms.Close()stats:=ms.Stats()ifstats.TotalChunks!=3{t.Errorf("TotalChunks=%d,want3",stats.TotalChunks)}tokens:=te.EstimatedTokens()iftokens<2{t.Errorf("EstimatedTokens=%d,want>=2",tokens)}}//───Benchmarks──────────────────────────────────────────────funcBenchmarkBufferPool_GetPut(b*testing.B){pool:=NewBufferPool(DefaultChunkSize)b.ResetTimer()b.RunParallel(func(pb*testing.PB){forpb.Next(){buf:=pool.Get()buf[0]=1pool.Put(buf)}})}funcBenchmarkBufferPool_vs_MakeSlice(b*testing.B){b.Run("pool",func(b*testing.B){pool:=NewBufferPool(DefaultChunkSize)fori:=0;i<b.N;i++{buf:=pool.Get()buf[0]=1pool.Put(buf)}})b.Run("make",func(b*testing.B){fori:=0;i<b.N;i++{buf:=make([]byte,DefaultChunkSize)buf[0]=1_=buf}})}funcBenchmarkMeteredStream_ReadAll(b*testing.B){fori:=0;i<b.N;i++{chunks:=make([]string,100)forj:=rangechunks{chunks[j]=`data:{"choices":[{"delta":{"content":"token"}}]}`+"\n\n"}inner:=newMockStream(chunks...)ms:=NewMeteredStream(inner,NewTokenEstimator())for{_,err:=ms.Next()iferr==io.EOF{break}}ms.Close()}}funcBenchmarkExtractSSEContent(b*testing.B){chunk:=[]byte(`data:{"choices":[{"delta":{"content":"Helloworld"}}]}`)b.ResetTimer()fori:=0;i<b.N;i++{ExtractSSEContent(chunk)}}