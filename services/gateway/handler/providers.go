packagehandlerimport("context""encoding/json""net/http""time""github.com/go-chi/chi/v5""github.com/rs/zerolog""github.com/AlfredDev/alfred/services/gateway/provider")//ProviderConfigHandlerhandlesproviderconfigurationCRUDoperations.typeProviderConfigHandlerstruct{loggerzerolog.Loggerregistry*provider.Registrypricing*provider.PricingConfig}//NewProviderConfigHandlercreatesanewproviderconfighandler.funcNewProviderConfigHandler(loggerzerolog.Logger,registry*provider.Registry,pricing*provider.PricingConfig)*ProviderConfigHandler{return&ProviderConfigHandler{logger:logger,registry:registry,pricing:pricing,}}//ProviderInforepresentsaprovider'spubliclyvisibleconfiguration.typeProviderInfostruct{Namestring`json:"name"`Models[]string`json:"models"`Healthybool`json:"healthy"`LatencyMsint64`json:"latency_ms"`LastCheckstring`json:"last_check,omitempty"`Errorstring`json:"error,omitempty"`}//ProviderPricingInforepresentspricingforasinglemodel.typeProviderPricingInfostruct{Modelstring`json:"model"`Providerstring`json:"provider"`InputPer1Mfloat64`json:"input_per_1m_usd"`OutputPer1Mfloat64`json:"output_per_1m_usd"`Freebool`json:"free"`}//ListProvidershandlesGET/v1/providers—listsallregisteredproviders.func(h*ProviderConfigHandler)ListProviders(whttp.ResponseWriter,r*http.Request){names:=h.registry.List()providers:=make([]ProviderInfo,0,len(names))//Getlatesthealthstatus.ctx,cancel:=context.WithTimeout(r.Context(),5*time.Second)defercancel()health:=h.registry.HealthCheckAll(ctx)for_,name:=rangenames{prov,ok:=h.registry.Get(name)if!ok{continue}info:=ProviderInfo{Name:name,Models:prov.Models(),}ifstatus,ok:=health[name];ok{info.Healthy=status.Healthyinfo.LatencyMs=status.Latency.Milliseconds()info.LastCheck=status.LastCheck.Format(time.RFC3339)info.Error=status.Error}providers=append(providers,info)}writeJSON(w,http.StatusOK,map[string]interface{}{"object":"list","data":providers,"total":len(providers),})}//GetProviderhandlesGET/v1/providers/{name}—getsasingleprovider'sconfig.func(h*ProviderConfigHandler)GetProvider(whttp.ResponseWriter,r*http.Request){name:=chi.URLParam(r,"name")prov,ok:=h.registry.Get(name)if!ok{writeJSON(w,http.StatusNotFound,map[string]interface{}{"error":map[string]string{"type":"not_found","message":"Provider'"+name+"'notfound",},})return}//Gethealth.ctx,cancel:=context.WithTimeout(r.Context(),5*time.Second)defercancel()status:=prov.HealthCheck(ctx)info:=ProviderInfo{Name:name,Models:prov.Models(),Healthy:status.Healthy,LatencyMs:status.Latency.Milliseconds(),LastCheck:status.LastCheck.Format(time.RFC3339),Error:status.Error,}writeJSON(w,http.StatusOK,info)}//GetProviderModelshandlesGET/v1/providers/{name}/models.func(h*ProviderConfigHandler)GetProviderModels(whttp.ResponseWriter,r*http.Request){name:=chi.URLParam(r,"name")prov,ok:=h.registry.Get(name)if!ok{writeJSON(w,http.StatusNotFound,map[string]interface{}{"error":map[string]string{"type":"not_found","message":"Provider'"+name+"'notfound",},})return}models:=make([]map[string]interface{},0)for_,model:=rangeprov.Models(){entry:=map[string]interface{}{"id":model,"provider":name,"object":"model",}//Includepricingifavailable.ifh.pricing!=nil{ifpricing,ok:=h.pricing.GetPricing(name,model);ok{entry["pricing"]=map[string]interface{}{"input_per_1m_usd":pricing.InputPer1M,"output_per_1m_usd":pricing.OutputPer1M,"free":pricing.Free,}}}models=append(models,entry)}writeJSON(w,http.StatusOK,map[string]interface{}{"object":"list","data":models,"total":len(models),"provider":name,})}//TestProviderhandlesPOST/v1/providers/{name}/test—connectivitytest.func(h*ProviderConfigHandler)TestProvider(whttp.ResponseWriter,r*http.Request){name:=chi.URLParam(r,"name")prov,ok:=h.registry.Get(name)if!ok{writeJSON(w,http.StatusNotFound,map[string]interface{}{"error":map[string]string{"type":"not_found","message":"Provider'"+name+"'notfound",},})return}ctx,cancel:=context.WithTimeout(r.Context(),10*time.Second)defercancel()start:=time.Now()status:=prov.HealthCheck(ctx)duration:=time.Since(start)result:=map[string]interface{}{"provider":name,"healthy":status.Healthy,"latency_ms":duration.Milliseconds(),"tested_at":time.Now().Format(time.RFC3339),}ifstatus.Error!=""{result["error"]=status.Error}httpStatus:=http.StatusOKif!status.Healthy{httpStatus=http.StatusServiceUnavailable}writeJSON(w,httpStatus,result)}//GetPricinghandlesGET/v1/providers/pricing—returnsallmodelpricing.func(h*ProviderConfigHandler)GetPricing(whttp.ResponseWriter,r*http.Request){ifh.pricing==nil{writeJSON(w,http.StatusOK,map[string]interface{}{"object":"list","data":[]interface{}{},})return}all:=h.pricing.AllPricing()result:=make([]ProviderPricingInfo,0)forkey,p:=rangeall{result=append(result,ProviderPricingInfo{Model:key,Provider:provider.DetectProvider(key),InputPer1M:p.InputPer1M,OutputPer1M:p.OutputPer1M,Free:p.Free,})}writeJSON(w,http.StatusOK,map[string]interface{}{"object":"list","data":result,"total":len(result),})}//EstimateCosthandlesPOST/v1/providers/estimate—costestimation.func(h*ProviderConfigHandler)EstimateCost(whttp.ResponseWriter,r*http.Request){varreqstruct{Modelstring`json:"model"`InputTokensint`json:"input_tokens"`OutputTokensint`json:"output_tokens"`}iferr:=json.NewDecoder(r.Body).Decode(&req);err!=nil{writeJSON(w,http.StatusBadRequest,map[string]interface{}{"error":map[string]string{"type":"invalid_request","message":"Invalidrequestbody:"+err.Error(),},})return}ifreq.Model==""{writeJSON(w,http.StatusBadRequest,map[string]interface{}{"error":map[string]string{"type":"invalid_request","message":"modelisrequired",},})return}providerName:=provider.DetectProvider(req.Model)ifh.pricing==nil{writeJSON(w,http.StatusOK,map[string]interface{}{"model":req.Model,"provider":providerName,"estimated_cost":0,"message":"Nopricingconfigloaded",})return}cost:=h.pricing.EstimateCost(providerName,req.Model,req.InputTokens,req.OutputTokens)writeJSON(w,http.StatusOK,map[string]interface{}{"model":req.Model,"provider":providerName,"input_tokens":req.InputTokens,"output_tokens":req.OutputTokens,"estimated_cost":cost,"currency":"USD",})}funcwriteJSON(whttp.ResponseWriter,statusint,datainterface{}){w.Header().Set("Content-Type","application/json")w.WriteHeader(status)_=json.NewEncoder(w).Encode(data)}