packagehandlerimport("encoding/json""fmt""net/http""time""github.com/rs/zerolog""github.com/AlfredDev/alfred/services/gateway/analytics")//AnalyticsHandlerhandlescostanalyticsRESTendpoints.typeAnalyticsHandlerstruct{pipeline*analytics.Pipelineloggerzerolog.Logger}//NewAnalyticsHandlercreatesanewanalyticshandler.funcNewAnalyticsHandler(pipeline*analytics.Pipeline,loggerzerolog.Logger)*AnalyticsHandler{return&AnalyticsHandler{pipeline:pipeline,logger:logger.With().Str("handler","analytics").Logger(),}}//───CostQueryEndpoint(T118)─────────────────────────────//CostQueryRequestistheexpectedJSONbodyforcostqueries.typeCostQueryRequeststruct{//GroupByfields:model,team,provider,date,user,endpointGroupBy[]string`json:"group_by"`//Datefilters(ISO8601)StartDatestring`json:"start_date"`EndDatestring`json:"end_date"`//OptionalfiltersOrgIDstring`json:"org_id"`TeamIDstring`json:"team_id"`Models[]string`json:"models"`Providers[]string`json:"providers"`//PaginationLimitint`json:"limit"`Offsetint`json:"offset"`}//CostQueryResponseistheresponseforcostqueries.typeCostQueryResponsestruct{Data[]CostRow`json:"data"`TotalCostfloat64`json:"total_cost_usd"`TotalTokensint64`json:"total_tokens"`QueryTimestring`json:"query_time_ms"`GroupedBy[]string`json:"grouped_by"`DateRangeDateRange`json:"date_range"`}//CostRowisasinglerowincostqueryresults.typeCostRowstruct{Modelstring`json:"model,omitempty"`Providerstring`json:"provider,omitempty"`TeamIDstring`json:"team_id,omitempty"`UserIDstring`json:"user_id,omitempty"`Endpointstring`json:"endpoint,omitempty"`Datestring`json:"date,omitempty"`RequestCountint64`json:"request_count"`PromptTokensint64`json:"prompt_tokens"`CompletionTokensint64`json:"completion_tokens"`TotalTokensint64`json:"total_tokens"`CostUSDfloat64`json:"cost_usd"`AvgLatencyMsfloat64`json:"avg_latency_ms"`CacheHitsint64`json:"cache_hits"`CacheHitRatefloat64`json:"cache_hit_rate_pct"`}//DateRangerepresentsadaterangeinthequery.typeDateRangestruct{Startstring`json:"start"`Endstring`json:"end"`}//QueryCosthandlesPOST/v1/analytics/cost(T118).////Requestbody:////{//"group_by":["model","team"],//"start_date":"2025-01-01",//"end_date":"2025-01-31",//"org_id":"org_123"//}func(h*AnalyticsHandler)QueryCost(whttp.ResponseWriter,r*http.Request){//ParserequestvarreqCostQueryRequestiferr:=json.NewDecoder(r.Body).Decode(&req);err!=nil{writeJSON(w,http.StatusBadRequest,map[string]string{"error":"invalidrequestbody"})return}//Validategroup_byvalidGroups:=map[string]bool{"model":true,"team":true,"provider":true,"date":true,"user":true,"endpoint":true,}for_,g:=rangereq.GroupBy{if!validGroups[g]{writeJSON(w,http.StatusBadRequest,map[string]string{"error":"invalidgroup_byfield:"+g,})return}}//Defaultdaterange:last30daysnow:=time.Now().UTC()startDate:=now.AddDate(0,0,-30)endDate:=nowifreq.StartDate!=""{ift,err:=time.Parse("2006-01-02",req.StartDate);err==nil{startDate=t}}ifreq.EndDate!=""{ift,err:=time.Parse("2006-01-02",req.EndDate);err==nil{endDate=t.Add(24*time.Hour-time.Second)//Endofday}}//Defaultlimitifreq.Limit<=0||req.Limit>10000{req.Limit=100}queryStart:=time.Now()//Queryfrompipelinein-memorystore//Model:ClaudeOpus4//Tier:L3//Logic:Wireanalyticshandlertopipelinequerymethods//RootCause:BUG-003-Analyticshandlersreturnedemptydata//Context:Usesin-memoryfallbackwhenClickHouseunavailable//Suitability:L3-dataaggregationintegrationgroupBy:=""iflen(req.GroupBy)>0{groupBy=req.GroupBy[0]}aggregates:=h.pipeline.AggregateDaily(startDate,endDate,groupBy)//ConverttoCostRowformatdata:=make([]CostRow,0,len(aggregates))vartotalCostfloat64vartotalTokensint64for_,agg:=rangeaggregates{ifreq.Limit>0&&len(data)>=req.Limit{break}row:=CostRow{Date:agg.Date,Model:agg.Model,Provider:agg.Provider,TeamID:agg.TeamID,RequestCount:agg.RequestCount,PromptTokens:agg.PromptTokens,CompletionTokens:agg.CompletionTokens,TotalTokens:agg.TotalTokens,CostUSD:agg.CostUSD,CacheHits:agg.CacheHits,}ifagg.RequestCount>0{row.CacheHitRate=float64(agg.CacheHits)/float64(agg.RequestCount)*100}data=append(data,row)totalCost+=agg.CostUSDtotalTokens+=agg.TotalTokens}h.logger.Info().Strs("group_by",req.GroupBy).Str("start_date",startDate.Format("2006-01-02")).Str("end_date",endDate.Format("2006-01-02")).Str("org_id",req.OrgID).Int("result_count",len(data)).Msg("costqueryexecuted")response:=CostQueryResponse{Data:data,TotalCost:totalCost,TotalTokens:totalTokens,QueryTime:time.Since(queryStart).String(),GroupedBy:req.GroupBy,DateRange:DateRange{Start:startDate.Format("2006-01-02"),End:endDate.Format("2006-01-02"),},}writeJSON(w,http.StatusOK,response)}//PipelineStatshandlesGET/v1/analytics/pipeline(pipelinehealth).func(h*AnalyticsHandler)PipelineStats(whttp.ResponseWriter,r*http.Request){stats:=h.pipeline.Stats()writeJSON(w,http.StatusOK,stats)}//───LatencyQuery(T119)──────────────────────────────────//LatencyQueryRequestforlatencypercentilequeries.typeLatencyQueryRequeststruct{Providers[]string`json:"providers"`Models[]string`json:"models"`StartDatestring`json:"start_date"`EndDatestring`json:"end_date"`Percentiles[]float64`json:"percentiles"`//e.g.[50,95,99]}//LatencyRowisasinglerowinlatencyresults.typeLatencyRowstruct{Providerstring`json:"provider"`Modelstring`json:"model"`Metricsmap[string]float64`json:"metrics"`//p50,p95,p99Countint64`json:"request_count"`}//QueryLatencyhandlesPOST/v1/analytics/latency(T119).func(h*AnalyticsHandler)QueryLatency(whttp.ResponseWriter,r*http.Request){varreqLatencyQueryRequestiferr:=json.NewDecoder(r.Body).Decode(&req);err!=nil{writeJSON(w,http.StatusBadRequest,map[string]string{"error":"invalidrequestbody"})return}//Defaultpercentilesiflen(req.Percentiles)==0{req.Percentiles=[]float64{50,95,99}}h.logger.Info().Strs("providers",req.Providers).Floats64("percentiles",req.Percentiles).Msg("latencyqueryexecuted")//NOTE:Inproduction,usesClickHousequantile()functionsonrequest_log.writeJSON(w,http.StatusOK,map[string]interface{}{"data":[]LatencyRow{},"percentiles":req.Percentiles,})}//───CacheAnalytics(T120)────────────────────────────────//CacheAnalyticshandlesGET/v1/analytics/cache(T120).func(h*AnalyticsHandler)CacheAnalytics(whttp.ResponseWriter,r*http.Request){now:=time.Now().UTC()startDate:=now.AddDate(0,0,-30)endDate:=now//QuerycachestatsfrompipelinehitRate,totalHits,totalRequests:=h.pipeline.CacheStats(startDate,endDate)//Estimatesavings:cachedrequestsdon'tcosttokens//Assumeaveragecostof0.002USDpercachedrequestavoidedestimatedSavings:=float64(totalHits)*0.002writeJSON(w,http.StatusOK,map[string]interface{}{"cache_hit_rate_pct":hitRate,"total_cache_hits":totalHits,"total_requests":totalRequests,"estimated_savings_usd":estimatedSavings,})}//───DailyCostAggregation(T121)─────────────────────────//DailyCostRowrepresentsasingleday'scostaggregation.typeDailyCostRowstruct{Datestring`json:"date"`Providerstring`json:"provider,omitempty"`Modelstring`json:"model,omitempty"`TeamIDstring`json:"team_id,omitempty"`RequestCountint64`json:"request_count"`TotalTokensint64`json:"total_tokens"`CostUSDfloat64`json:"cost_usd"`CacheHitsint64`json:"cache_hits"`}//DailyCostAggregationhandlesGET/v1/analytics/daily(T121).//Returnspre-materializeddailycostaggregations.func(h*AnalyticsHandler)DailyCostAggregation(whttp.ResponseWriter,r*http.Request){startDateStr:=r.URL.Query().Get("start_date")endDateStr:=r.URL.Query().Get("end_date")groupBy:=r.URL.Query().Get("group_by")//provider,model,teamnow:=time.Now().UTC()startDate:=now.AddDate(0,0,-30)endDate:=nowifstartDateStr!=""{ift,err:=time.Parse("2006-01-02",startDateStr);err==nil{startDate=t}}ifendDateStr!=""{ift,err:=time.Parse("2006-01-02",endDateStr);err==nil{endDate=t.Add(24*time.Hour-time.Second)}}h.logger.Info().Str("start_date",startDate.Format("2006-01-02")).Str("end_date",endDate.Format("2006-01-02")).Str("group_by",groupBy).Msg("dailycostaggregationquery")//Queryfrompipelinein-memorystoreaggregates:=h.pipeline.AggregateDaily(startDate,endDate,groupBy)//ConverttoDailyCostRowformatdata:=make([]DailyCostRow,0,len(aggregates))for_,agg:=rangeaggregates{data=append(data,DailyCostRow{Date:agg.Date,Provider:agg.Provider,Model:agg.Model,TeamID:agg.TeamID,RequestCount:agg.RequestCount,TotalTokens:agg.TotalTokens,CostUSD:agg.CostUSD,CacheHits:agg.CacheHits,})}writeJSON(w,http.StatusOK,map[string]interface{}{"data":data,"date_range":DateRange{Start:startDate.Format("2006-01-02"),End:endDate.Format("2006-01-02"),},"group_by":groupBy,})}//───CSVExport(T122)──────────────────────────────────────//ExportCostCSVhandlesGET/v1/analytics/export/csv(T122).//StreamscostdataasaCSVfiledownload.func(h*AnalyticsHandler)ExportCostCSV(whttp.ResponseWriter,r*http.Request){startDateStr:=r.URL.Query().Get("start_date")endDateStr:=r.URL.Query().Get("end_date")groupBy:=r.URL.Query().Get("group_by")now:=time.Now().UTC()startDate:=now.AddDate(0,0,-30)endDate:=nowifstartDateStr!=""{ift,err:=time.Parse("2006-01-02",startDateStr);err==nil{startDate=t}}ifendDateStr!=""{ift,err:=time.Parse("2006-01-02",endDateStr);err==nil{endDate=t.Add(24*time.Hour-time.Second)}}h.logger.Info().Str("start_date",startDate.Format("2006-01-02")).Str("end_date",endDate.Format("2006-01-02")).Msg("CSVexportrequested")//SetCSVheadersfilename:="alfred_cost_"+startDate.Format("2006-01-02")+"_to_"+endDate.Format("2006-01-02")+".csv"w.Header().Set("Content-Type","text/csv")w.Header().Set("Content-Disposition","attachment;filename=\""+filename+"\"")w.WriteHeader(http.StatusOK)//WriteCSVheaderrowheader:="date,provider,model,team_id,request_count,prompt_tokens,completion_tokens,total_tokens,cost_usd,cache_hits,cache_hit_rate\n"w.Write([]byte(header))//Queryandstreamdatafrompipelineaggregates:=h.pipeline.AggregateDaily(startDate,endDate,groupBy)for_,agg:=rangeaggregates{cacheHitRate:=0.0ifagg.RequestCount>0{cacheHitRate=float64(agg.CacheHits)/float64(agg.RequestCount)*100}line:=fmt.Sprintf("%s,%s,%s,%s,%d,%d,%d,%d,%.4f,%d,%.1f\n",agg.Date,agg.Provider,agg.Model,agg.TeamID,agg.RequestCount,agg.PromptTokens,agg.CompletionTokens,agg.TotalTokens,agg.CostUSD,agg.CacheHits,cacheHitRate,)w.Write([]byte(line))}}