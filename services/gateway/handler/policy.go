//go:buildpolicy//+buildpolicypackagehandlerimport("encoding/json""net/http""strconv""github.com/go-chi/chi/v5""github.com/rs/zerolog""github.com/AlfredDev/alfred/services/gateway/policy")//PolicyHandlerprovidesHTTPhandlersforpolicymanagement.typePolicyHandlerstruct{client*policy.OPAClientloggerzerolog.Logger}//NewPolicyHandlercreatesanewpolicyhandler.funcNewPolicyHandler(client*policy.OPAClient,loggerzerolog.Logger)*PolicyHandler{return&PolicyHandler{client:client,logger:logger}}//ListPolicieshandlesGET/v1/policies.func(h*PolicyHandler)ListPolicies(whttp.ResponseWriter,r*http.Request){policies:=h.client.ListPolicies()writeJSON(w,http.StatusOK,policies)}//CreatePolicyhandlesPOST/v1/policies.func(h*PolicyHandler)CreatePolicy(whttp.ResponseWriter,r*http.Request){varpolpolicy.Policyiferr:=json.NewDecoder(r.Body).Decode(&pol);err!=nil{writeError(w,http.StatusBadRequest,"invalid_json",err.Error())return}iferr:=h.client.CreatePolicy(&pol);err!=nil{writeError(w,http.StatusBadRequest,"create_failed",err.Error())return}h.logger.Info().Str("id",pol.ID).Str("name",pol.Name).Msg("policycreated")writeJSON(w,http.StatusCreated,&pol)}//GetPolicyhandlesGET/v1/policies/{id}.func(h*PolicyHandler)GetPolicy(whttp.ResponseWriter,r*http.Request){id:=chi.URLParam(r,"id")pol,err:=h.client.GetPolicy(id)iferr!=nil{writeError(w,http.StatusNotFound,"not_found",err.Error())return}writeJSON(w,http.StatusOK,pol)}//UpdatePolicyhandlesPUT/v1/policies/{id}.func(h*PolicyHandler)UpdatePolicy(whttp.ResponseWriter,r*http.Request){id:=chi.URLParam(r,"id")varpolpolicy.Policyiferr:=json.NewDecoder(r.Body).Decode(&pol);err!=nil{writeError(w,http.StatusBadRequest,"invalid_json",err.Error())return}iferr:=h.client.UpdatePolicy(id,pol.Module,pol.Active);err!=nil{writeError(w,http.StatusBadRequest,"update_failed",err.Error())return}updated,err:=h.client.GetPolicy(id)iferr!=nil{writeError(w,http.StatusInternalServerError,"not_found",err.Error())return}h.logger.Info().Str("id",id).Msg("policyupdated")writeJSON(w,http.StatusOK,updated)}//DeletePolicyhandlesDELETE/v1/policies/{id}.func(h*PolicyHandler)DeletePolicy(whttp.ResponseWriter,r*http.Request){id:=chi.URLParam(r,"id")iferr:=h.client.DeletePolicy(id);err!=nil{writeError(w,http.StatusNotFound,"not_found",err.Error())return}h.logger.Info().Str("id",id).Msg("policydeleted")w.WriteHeader(http.StatusNoContent)}//EvaluatePolicyhandlesPOST/v1/policies/evaluate.func(h*PolicyHandler)EvaluatePolicy(whttp.ResponseWriter,r*http.Request){varinputpolicy.PolicyInputiferr:=json.NewDecoder(r.Body).Decode(&input);err!=nil{writeError(w,http.StatusBadRequest,"invalid_json",err.Error())return}result,err:=h.client.Evaluate(r.Context(),input)iferr!=nil{writeError(w,http.StatusInternalServerError,"evaluation_failed",err.Error())return}writeJSON(w,http.StatusOK,result)}//GetEvaluationLoghandlesGET/v1/policies/evaluations.func(h*PolicyHandler)GetEvaluationLog(whttp.ResponseWriter,r*http.Request){limit:=100ifv:=r.URL.Query().Get("limit");v!=""{ifn,err:=strconv.Atoi(v);err==nil&&n>0{limit=n}}logs:=h.client.GetEvaluationLog(limit)writeJSON(w,http.StatusOK,logs)}//ListTemplateshandlesGET/v1/policies/templates.func(h*PolicyHandler)ListTemplates(whttp.ResponseWriter,r*http.Request){templates:=policy.BuiltInPolicies()writeJSON(w,http.StatusOK,templates)}//ToggleDryRunhandlesPOST/v1/policies/{id}/dry-run.func(h*PolicyHandler)ToggleDryRun(whttp.ResponseWriter,r*http.Request){id:=chi.URLParam(r,"id")varbodystruct{DryRunbool`json:"dry_run"`}iferr:=json.NewDecoder(r.Body).Decode(&body);err!=nil{writeError(w,http.StatusBadRequest,"invalid_json",err.Error())return}pol,err:=h.client.GetPolicy(id)iferr!=nil{writeError(w,http.StatusNotFound,"not_found",err.Error())return}pol.DryRun=body.DryRuniferr=h.client.UpdatePolicy(pol.ID,pol.Module,pol.Active);err!=nil{writeError(w,http.StatusInternalServerError,"update_failed",err.Error())return}writeJSON(w,http.StatusOK,pol)}