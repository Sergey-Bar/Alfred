//go:buildexperiment//+buildexperimentpackagehandlerimport("encoding/json""net/http""github.com/go-chi/chi/v5""github.com/rs/zerolog""github.com/AlfredDev/alfred/services/gateway/routing")//ExperimentHandlerprovidesHTTPhandlersforexperimentmanagement.typeExperimentHandlerstruct{engine*routing.ExperimentEngineloggerzerolog.Logger}//NewExperimentHandlercreatesanewexperimenthandler.funcNewExperimentHandler(engine*routing.ExperimentEngine,loggerzerolog.Logger)*ExperimentHandler{return&ExperimentHandler{engine:engine,logger:logger}}//ListExperimentshandlesGET/v1/experiments.func(h*ExperimentHandler)ListExperiments(whttp.ResponseWriter,r*http.Request){experiments:=h.engine.ListExperiments()writeJSON(w,http.StatusOK,experiments)}//CreateExperimenthandlesPOST/v1/experiments.func(h*ExperimentHandler)CreateExperiment(whttp.ResponseWriter,r*http.Request){varexprouting.Experimentiferr:=json.NewDecoder(r.Body).Decode(&exp);err!=nil{writeError(w,http.StatusBadRequest,"invalid_json",err.Error())return}created,err:=h.engine.CreateExperiment(exp)iferr!=nil{writeError(w,http.StatusBadRequest,"create_failed",err.Error())return}h.logger.Info().Str("id",created.ID).Str("name",created.Name).Msg("experimentcreated")writeJSON(w,http.StatusCreated,created)}//GetExperimenthandlesGET/v1/experiments/{id}.func(h*ExperimentHandler)GetExperiment(whttp.ResponseWriter,r*http.Request){id:=chi.URLParam(r,"id")exp,err:=h.engine.GetExperiment(id)iferr!=nil{writeError(w,http.StatusNotFound,"not_found",err.Error())return}writeJSON(w,http.StatusOK,exp)}//StartExperimenthandlesPOST/v1/experiments/{id}/start.func(h*ExperimentHandler)StartExperiment(whttp.ResponseWriter,r*http.Request){id:=chi.URLParam(r,"id")iferr:=h.engine.StartExperiment(id);err!=nil{writeError(w,http.StatusBadRequest,"start_failed",err.Error())return}h.logger.Info().Str("id",id).Msg("experimentstarted")writeJSON(w,http.StatusOK,map[string]string{"status":"running","id":id})}//PauseExperimenthandlesPOST/v1/experiments/{id}/pause.func(h*ExperimentHandler)PauseExperiment(whttp.ResponseWriter,r*http.Request){id:=chi.URLParam(r,"id")iferr:=h.engine.PauseExperiment(id);err!=nil{writeError(w,http.StatusBadRequest,"pause_failed",err.Error())return}writeJSON(w,http.StatusOK,map[string]string{"status":"paused","id":id})}//ConcludeExperimenthandlesPOST/v1/experiments/{id}/conclude.func(h*ExperimentHandler)ConcludeExperiment(whttp.ResponseWriter,r*http.Request){id:=chi.URLParam(r,"id")winner:=r.URL.Query().Get("winner")iferr:=h.engine.ConcludeExperiment(id,winner);err!=nil{writeError(w,http.StatusBadRequest,"conclude_failed",err.Error())return}h.logger.Info().Str("id",id).Str("winner",winner).Msg("experimentconcluded")writeJSON(w,http.StatusOK,map[string]string{"status":"concluded","id":id,"winner":winner})}//DeleteExperimenthandlesDELETE/v1/experiments/{id}.func(h*ExperimentHandler)DeleteExperiment(whttp.ResponseWriter,r*http.Request){id:=chi.URLParam(r,"id")iferr:=h.engine.DeleteExperiment(id);err!=nil{writeError(w,http.StatusNotFound,"not_found",err.Error())return}w.WriteHeader(http.StatusNoContent)}//AssignVarianthandlesPOST/v1/experiments/{id}/assign.func(h*ExperimentHandler)AssignVariant(whttp.ResponseWriter,r*http.Request){id:=chi.URLParam(r,"id")varbodystruct{RequestKeystring`json:"request_key"`}iferr:=json.NewDecoder(r.Body).Decode(&body);err!=nil{writeError(w,http.StatusBadRequest,"invalid_json",err.Error())return}variant,err:=h.engine.AssignVariant(id,body.RequestKey)iferr!=nil{writeError(w,http.StatusBadRequest,"assign_failed",err.Error())return}writeJSON(w,http.StatusOK,variant)}//RecordResulthandlesPOST/v1/experiments/{id}/result.func(h*ExperimentHandler)RecordResult(whttp.ResponseWriter,r*http.Request){id:=chi.URLParam(r,"id")varbodystruct{VariantNamestring`json:"variant_name"`Latencyfloat64`json:"latency_ms"`Costfloat64`json:"cost"`IsErrorbool`json:"is_error"`}iferr:=json.NewDecoder(r.Body).Decode(&body);err!=nil{writeError(w,http.StatusBadRequest,"invalid_json",err.Error())return}iferr:=h.engine.RecordResult(id,body.VariantName,body.Latency,body.Cost,body.IsError);err!=nil{writeError(w,http.StatusBadRequest,"record_failed",err.Error())return}writeJSON(w,http.StatusOK,map[string]string{"status":"recorded"})}//GetMetricshandlesGET/v1/experiments/{id}/metrics.func(h*ExperimentHandler)GetMetrics(whttp.ResponseWriter,r*http.Request){id:=chi.URLParam(r,"id")exp,err:=h.engine.GetExperiment(id)iferr!=nil{writeError(w,http.StatusNotFound,"not_found",err.Error())return}metrics:=make(map[string]interface{})metrics["experiment_id"]=idmetrics["metrics"]=exp.MetricswriteJSON(w,http.StatusOK,metrics)}//CompareVariantshandlesGET/v1/experiments/{id}/compare.func(h*ExperimentHandler)CompareVariants(whttp.ResponseWriter,r*http.Request){id:=chi.URLParam(r,"id")exp,err:=h.engine.GetExperiment(id)iferr!=nil{writeError(w,http.StatusNotFound,"not_found",err.Error())return}iflen(exp.Variants)<2{writeError(w,http.StatusBadRequest,"insufficient_variants","needatleast2variants")return}v1:=exp.Variants[0].Namev2:=exp.Variants[1].NameerrorSig,errorZScore:=h.engine.CompareErrorRates(id,v1,v2)costSig,costZScore:=h.engine.CompareCosts(id,v1,v2)writeJSON(w,http.StatusOK,map[string]interface{}{"experiment_id":id,"variant_a":v1,"variant_b":v2,"error_rate_significant":errorSig,"error_rate_z_score":errorZScore,"cost_significant":costSig,"cost_z_score":costZScore,})}