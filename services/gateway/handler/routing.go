packagehandlerimport("encoding/json""fmt""net/http""time""github.com/go-chi/chi/v5""github.com/rs/zerolog""github.com/AlfredDev/alfred/services/gateway/routing")//RoutingHandlerhandlesroutingruleRESTAPIrequests.typeRoutingHandlerstruct{engine*routing.Enginefailover*routing.FailoverStateloggerzerolog.Logger}//NewRoutingHandlercreatesanewroutinghandler.funcNewRoutingHandler(engine*routing.Engine,failover*routing.FailoverState,loggerzerolog.Logger)*RoutingHandler{return&RoutingHandler{engine:engine,failover:failover,logger:logger.With().Str("handler","routing").Logger(),}}//ListRuleshandlesGET/v1/routing/rules(T091).func(h*RoutingHandler)ListRules(whttp.ResponseWriter,r*http.Request){rules:=h.engine.ListRules()writeJSON(w,http.StatusOK,map[string]interface{}{"rules":rules,"total":len(rules),})}//CreateRulehandlesPOST/v1/routing/rules(T091).func(h*RoutingHandler)CreateRule(whttp.ResponseWriter,r*http.Request){varrulerouting.Ruleiferr:=json.NewDecoder(r.Body).Decode(&rule);err!=nil{writeJSON(w,http.StatusBadRequest,map[string]string{"error":"invalidruleJSON"})return}ifrule.ID==""||rule.Name==""{writeJSON(w,http.StatusBadRequest,map[string]string{"error":"idandnamearerequired"})return}h.engine.AddRule(rule)h.logger.Info().Str("rule_id",rule.ID).Str("name",rule.Name).Msg("routingrulecreated")writeJSON(w,http.StatusCreated,rule)}//GetRulehandlesGET/v1/routing/rules/{id}.func(h*RoutingHandler)GetRule(whttp.ResponseWriter,r*http.Request){id:=chi.URLParam(r,"id")rule,found:=h.engine.GetRule(id)if!found{writeJSON(w,http.StatusNotFound,map[string]string{"error":"rulenotfound"})return}writeJSON(w,http.StatusOK,rule)}//UpdateRulehandlesPUT/v1/routing/rules/{id}.func(h*RoutingHandler)UpdateRule(whttp.ResponseWriter,r*http.Request){id:=chi.URLParam(r,"id")varrulerouting.Ruleiferr:=json.NewDecoder(r.Body).Decode(&rule);err!=nil{writeJSON(w,http.StatusBadRequest,map[string]string{"error":"invalidruleJSON"})return}rule.ID=idiferr:=h.engine.UpdateRule(rule);err!=nil{writeJSON(w,http.StatusNotFound,map[string]string{"error":err.Error()})return}writeJSON(w,http.StatusOK,rule)}//DeleteRulehandlesDELETE/v1/routing/rules/{id}.func(h*RoutingHandler)DeleteRule(whttp.ResponseWriter,r*http.Request){id:=chi.URLParam(r,"id")iferr:=h.engine.DeleteRule(id);err!=nil{writeJSON(w,http.StatusNotFound,map[string]string{"error":err.Error()})return}w.WriteHeader(http.StatusNoContent)}//EvaluateRoutinghandlesPOST/v1/routing/evaluate(T092).//Acceptsaroutingcontextandreturnstheroutingdecision.func(h*RoutingHandler)EvaluateRouting(whttp.ResponseWriter,r*http.Request){varrcrouting.RoutingContextiferr:=json.NewDecoder(r.Body).Decode(&rc);err!=nil{writeJSON(w,http.StatusBadRequest,map[string]string{"error":"invalidcontextJSON"})return}ifrc.RequestTime.IsZero(){rc.RequestTime=time.Now().UTC()}decision:=h.engine.Evaluate(r.Context(),rc)//Applyfailoverifdecisionhasfallbacks(T094).ifdecision!=nil&&decision.Provider!=""&&h.failover!=nil{actual:=h.failover.SelectProvider(decision.Provider,decision.Fallbacks)ifactual!=decision.Provider{decision.Reason+=fmt.Sprintf(";failoverfrom%sto%s",decision.Provider,actual)decision.Provider=actual}}writeJSON(w,http.StatusOK,decision)}