packagehandlerimport("context""io""net/http""strings""sync""time""github.com/AlfredDev/alfred/services/gateway/provider""github.com/rs/zerolog")//StreamMetricscapturestoken/byteaccountingforastreamingrequest.typeStreamMetricsstruct{musync.MutexChunksSentintBytesSentint64TokensEstimatedintClientDisconnectboolDisconnectAttime.TimeTotalDurationtime.DurationFinishReasonstring}//RecordChunkrecordsachunksenttotheclient.func(sm*StreamMetrics)RecordChunk(data[]byte){sm.mu.Lock()defersm.mu.Unlock()sm.ChunksSent++sm.BytesSent+=int64(len(data))//Roughtokenestimation:~4charspertokenforEnglishtextsm.TokensEstimated+=estimateTokensFromSSE(data)}//RecordDisconnectrecordsaclientdisconnectevent.func(sm*StreamMetrics)RecordDisconnect(){sm.mu.Lock()defersm.mu.Unlock()sm.ClientDisconnect=truesm.DisconnectAt=time.Now().UTC()}//Snapshotreturnsacopyofthecurrentmetrics.func(sm*StreamMetrics)Snapshot()StreamMetrics{sm.mu.Lock()defersm.mu.Unlock()returnStreamMetrics{ChunksSent:sm.ChunksSent,BytesSent:sm.BytesSent,TokensEstimated:sm.TokensEstimated,ClientDisconnect:sm.ClientDisconnect,DisconnectAt:sm.DisconnectAt,TotalDuration:sm.TotalDuration,FinishReason:sm.FinishReason,}}//estimateTokensFromSSEextractscontentfromSSEdatalinesand//estimatesthetokencount.Thisisanapproximation—theactual//billingshouldusetheprovider'sreportedusagewhenavailable.funcestimateTokensFromSSE(data[]byte)int{s:=string(data)//SSElineslooklike"data:{json}\n\n"//Extractthecontentdeltaforaroughcounttokens:=0for_,line:=rangestrings.Split(s,"\n"){ifstrings.HasPrefix(line,"data:"){payload:=line[6:]ifpayload=="[DONE]"{continue}//Countprintablecontentbytes/4asroughtokenestimatetokens+=len(payload)/16//conservative:JSONoverheaddilutescontentiftokens==0&&len(payload)>0{tokens=1}}}returntokens}//StreamResultencapsulatestheoutcomeofastreamingproxycall.typeStreamResultstruct{MetricsStreamMetricsErrorerrorFinishedbool//trueifstreamcompletednormally(received[DONE])}//streamWithDisconnectDetectionwrapsaproviderStreamandwritesto//theclientwhiletrackingmetricsanddetectingearlydisconnects.//ThisisthecoreimplementationforSprintT047.funcstreamWithDisconnectDetection(ctxcontext.Context,whttp.ResponseWriter,streamprovider.Stream,loggerzerolog.Logger,)*StreamResult{flusher,ok:=w.(http.Flusher)if!ok{return&StreamResult{Error:io.ErrNoProgress}}result:=&StreamResult{}start:=time.Now()//MonitorclientcontextcancellationclientCtx:=ctxclientGone:=clientCtx.Done()for{select{case<-clientGone://Clientdisconnectedbeforestreamfinishedresult.Metrics.RecordDisconnect()result.Metrics.TotalDuration=time.Since(start)logger.Warn().Int("chunks_sent",result.Metrics.ChunksSent).Int64("bytes_sent",result.Metrics.BytesSent).Int("tokens_estimated",result.Metrics.TokensEstimated).Msg("clientdisconnectedmid-stream—billingfortokensalreadysent")returnresultdefault:chunk,err:=stream.Next()iferr!=nil{iferr==io.EOF{result.Finished=trueresult.Metrics.FinishReason="stop"}else{result.Error=errresult.Metrics.FinishReason="error"logger.Error().Err(err).Msg("streamreaderror")}result.Metrics.TotalDuration=time.Since(start)returnresult}//Writetoclientif_,writeErr:=w.Write(chunk);writeErr!=nil{//Writeerror→clientdisconnectedresult.Metrics.RecordDisconnect()result.Metrics.TotalDuration=time.Since(start)result.Metrics.FinishReason="client_disconnect"logger.Warn().Err(writeErr).Int("chunks_sent",result.Metrics.ChunksSent).Int("tokens_estimated",result.Metrics.TokensEstimated).Msg("writefailed—clientdisconnectdetected")returnresult}//Trackthechunkmetricsresult.Metrics.RecordChunk(chunk)flusher.Flush()}}}//DisconnectAwareStreamHandlerreplacesthebasicstreamingloopin//proxy.gowithfulldisconnectdetectionandpartialbilling.//CallthisfromhandleStreamingChatinsteadoftherawfor-loop.func(h*ProxyHandler)DisconnectAwareStreamHandler(whttp.ResponseWriter,r*http.Request,provprovider.Provider,req*provider.ChatRequest,starttime.Time,)*StreamResult{flusher,ok:=w.(http.Flusher)if!ok{h.writeError(w,http.StatusInternalServerError,"streaming_unsupported","Streamingnotsupportedbyserver")returnnil}stream,err:=prov.ChatCompletionStream(r.Context(),req)iferr!=nil{h.logger.Error().Err(err).Str("provider",prov.Name()).Str("model",req.Model).Msg("streamerror")h.writeError(w,http.StatusBadGateway,"provider_error","Upstreamproviderstreamingerror:"+err.Error())returnnil}deferstream.Close()//SetSSEheadersw.Header().Set("Content-Type","text/event-stream")w.Header().Set("Cache-Control","no-cache")w.Header().Set("Connection","keep-alive")w.Header().Set("X-Alfred-Model",prov.Name()+"/"+req.Model)w.WriteHeader(http.StatusOK)flusher.Flush()result:=streamWithDisconnectDetection(r.Context(),w,stream,h.logger)//Logfinalresulth.logger.Info().Str("provider",prov.Name()).Str("model",req.Model).Int("chunks_sent",result.Metrics.ChunksSent).Int64("bytes_sent",result.Metrics.BytesSent).Int("tokens_estimated",result.Metrics.TokensEstimated).Bool("client_disconnected",result.Metrics.ClientDisconnect).Bool("completed",result.Finished).Str("finish_reason",result.Metrics.FinishReason).Int64("latency_ms",time.Since(start).Milliseconds()).Msg("streamcompletionfinished")returnresult}