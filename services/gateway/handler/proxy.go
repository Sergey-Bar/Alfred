packagehandlerimport("encoding/json""io""net/http""strconv""strings""time""github.com/AlfredDev/alfred/services/gateway/middleware""github.com/AlfredDev/alfred/services/gateway/provider""github.com/AlfredDev/alfred/services/gateway/streaming""github.com/rs/zerolog")//ProxyHandlerhandlesAIAPIproxyrequests.typeProxyHandlerstruct{loggerzerolog.Loggerregistry*provider.Registry}//NewProxyHandlercreatesanewproxyhandler.funcNewProxyHandler(loggerzerolog.Logger,registry*provider.Registry)*ProxyHandler{return&ProxyHandler{logger:logger,registry:registry,}}//ChatCompletionshandlesPOST/v1/chat/completions.func(h*ProxyHandler)ChatCompletions(whttp.ResponseWriter,r*http.Request){start:=time.Now()reqID:=r.Header.Get("X-Request-ID")//Parserequestbodyusingpooledbuffer(T208—zero-allocdecode)varreqprovider.ChatRequestbuf:=getBuf()if_,cpErr:=io.Copy(buf,r.Body);cpErr!=nil{putBuf(buf)h.writeError(w,http.StatusBadRequest,"invalid_request","Failedtoreadrequestbody")return}iferr:=json.Unmarshal(buf.Bytes(),&req);err!=nil{putBuf(buf)h.writeError(w,http.StatusBadRequest,"invalid_request","Failedtoparserequestbody:"+err.Error())return}putBuf(buf)//Validaterequiredfieldsifreq.Model==""{h.writeError(w,http.StatusBadRequest,"invalid_request","Modelfieldisrequired")return}iflen(req.Messages)==0{h.writeError(w,http.StatusBadRequest,"invalid_request","Messagesfieldisrequiredandmustnotbeempty")return}//Validatetooldefinitionsifpresent(T017).iflen(req.Tools)>0{iferr:=provider.ValidateToolDefinitions(req.Tools);err!=nil{h.writeError(w,http.StatusBadRequest,"invalid_tools",err.Error())return}}//Checkfordry-runmodeifr.Header.Get("X-Alfred-DryRun")=="true"{h.handleDryRun(w,&req)return}//Findtheproviderforthismodelprov,err:=h.registry.GetForModel(req.Model)iferr!=nil{h.writeError(w,http.StatusBadRequest,"provider_not_found",err.Error())return}h.logger.Info().Str("req_id",reqID).Str("model",req.Model).Str("provider",prov.Name()).Bool("stream",req.Stream).Int("messages",len(req.Messages)).Msg("proxyingchatcompletion")//Routetostreamingornon-streaminghandlerifreq.Stream{h.handleStreamingChat(w,r,prov,&req,start)}else{h.handleNonStreamingChat(w,r,prov,&req,start)}}//handleNonStreamingChathandlesnon-streamingchatcompletions(T014).func(h*ProxyHandler)handleNonStreamingChat(whttp.ResponseWriter,r*http.Request,provprovider.Provider,req*provider.ChatRequest,starttime.Time){resp,err:=prov.ChatCompletion(r.Context(),req)iferr!=nil{h.logger.Error().Err(err).Str("provider",prov.Name()).Str("model",req.Model).Msg("providererror")h.writeError(w,http.StatusBadGateway,"provider_error","Upstreamprovidererror:"+err.Error())return}//Setresponseheadersw.Header().Set("Content-Type","application/json")w.Header().Set("X-Alfred-Model",prov.Name()+"/"+req.Model)w.Header().Set("X-Alfred-Latency-Ms",strconv.FormatInt(time.Since(start).Milliseconds(),10))//Encoderesponseviapooledbuffer(T208—zero-allocencode)encBuf:=getBuf()iferr:=json.NewEncoder(encBuf).Encode(resp);err!=nil{putBuf(encBuf)h.logger.Error().Err(err).Msg("failedtoencoderesponse")return}_,_=w.Write(encBuf.Bytes())putBuf(encBuf)h.logger.Info().Str("provider",prov.Name()).Str("model",req.Model).Int("prompt_tokens",resp.Usage.PromptTokens).Int("completion_tokens",resp.Usage.CompletionTokens).Int64("latency_ms",time.Since(start).Milliseconds()).Msg("chatcompletionsuccess")}//handleStreamingChathandlesSSEstreamingchatcompletions(T015).//WrapstheproviderstreamwithMeteredStreamfortokenestimation//andzero-allocationbuffering(T207gRPCstreamingoptimization).func(h*ProxyHandler)handleStreamingChat(whttp.ResponseWriter,r*http.Request,provprovider.Provider,req*provider.ChatRequest,starttime.Time){//Ensuretheresponsewritersupportsflushingflusher,ok:=w.(http.Flusher)if!ok{h.writeError(w,http.StatusInternalServerError,"streaming_unsupported","Streamingnotsupportedbyserver")return}stream,err:=prov.ChatCompletionStream(r.Context(),req)iferr!=nil{h.logger.Error().Err(err).Str("provider",prov.Name()).Str("model",req.Model).Msg("streamerror")h.writeError(w,http.StatusBadGateway,"provider_error","Upstreamproviderstreamingerror:"+err.Error())return}//Wrapwithmeteredstreamfortokenestimation(T207)tokenEstimator:=streaming.NewTokenEstimator()metered:=streaming.NewMeteredStream(stream,tokenEstimator)defermetered.Close()//SetSSEheadersw.Header().Set("Content-Type","text/event-stream")w.Header().Set("Cache-Control","no-cache")w.Header().Set("Connection","keep-alive")w.Header().Set("X-Alfred-Model",prov.Name()+"/"+req.Model)w.WriteHeader(http.StatusOK)flusher.Flush()//Streamchunkstoclientviameteredpipelinefor{chunk,err:=metered.Next()iferr!=nil{iferr==io.EOF{break}h.logger.Error().Err(err).Msg("streamreaderror")break}//Writechunkandflushimmediatelyif_,writeErr:=w.Write(chunk);writeErr!=nil{h.logger.Debug().Err(writeErr).Msg("clientdisconnectedduringstream")break}flusher.Flush()}//Logwithmeteringstats(T207)stats:=metered.Stats()h.logger.Info().Str("provider",prov.Name()).Str("model",req.Model).Int64("latency_ms",time.Since(start).Milliseconds()).Int("chunks",stats.TotalChunks).Int64("bytes",stats.TotalBytes).Int("est_output_tokens",tokenEstimator.EstimatedTokens()).Dur("ttfb",stats.FirstChunkAt).Msg("streamcompletionfinished")}//EmbeddingshandlesPOST/v1/embeddings(T016).func(h*ProxyHandler)Embeddings(whttp.ResponseWriter,r*http.Request){start:=time.Now()//Decodeviapooledbuffer(T208)varreqprovider.EmbeddingsRequestbuf:=getBuf()if_,cpErr:=io.Copy(buf,r.Body);cpErr!=nil{putBuf(buf)h.writeError(w,http.StatusBadRequest,"invalid_request","Failedtoreadrequestbody")return}iferr:=json.Unmarshal(buf.Bytes(),&req);err!=nil{putBuf(buf)h.writeError(w,http.StatusBadRequest,"invalid_request","Failedtoparserequestbody:"+err.Error())return}putBuf(buf)ifreq.Model==""{h.writeError(w,http.StatusBadRequest,"invalid_request","Modelfieldisrequired")return}prov,err:=h.registry.GetForModel(req.Model)iferr!=nil{h.writeError(w,http.StatusBadRequest,"provider_not_found",err.Error())return}resp,err:=prov.Embeddings(r.Context(),&req)iferr!=nil{h.writeError(w,http.StatusBadGateway,"provider_error","Upstreamprovidererror:"+err.Error())return}w.Header().Set("Content-Type","application/json")w.Header().Set("X-Alfred-Model",prov.Name()+"/"+req.Model)w.Header().Set("X-Alfred-Latency-Ms",strconv.FormatInt(time.Since(start).Milliseconds(),10))//Encodeviapooledbuffer(T208)encBuf:=getBuf()iferr:=json.NewEncoder(encBuf).Encode(resp);err!=nil{putBuf(encBuf)h.logger.Error().Err(err).Msg("failedtoencoderesponse")return}_,_=w.Write(encBuf.Bytes())putBuf(encBuf)}//handleDryRunestimatescostwithoutcallingtheprovider(T024).func(h*ProxyHandler)handleDryRun(whttp.ResponseWriter,req*provider.ChatRequest){providerName:=provider.DetectProvider(req.Model)//Roughtokenestimation:~4charspertokenforEnglishpromptTokens:=0for_,msg:=rangereq.Messages{ifcontent,ok:=msg.Content.(string);ok{promptTokens+=len(content)/4}}maxTokens:=1024ifreq.MaxTokens!=nil{maxTokens=*req.MaxTokens}resp:=dryRunResponse{DryRun:true,Model:req.Model,Provider:providerName,EstimatedTokens:estimatedTokensT{PromptTokens:promptTokens,MaxCompletion:maxTokens,TotalEstimate:promptTokens+maxTokens,},Message:"Dryruncomplete.Noproviderwascalled.",}w.Header().Set("Content-Type","application/json")encBuf:=getBuf()_=json.NewEncoder(encBuf).Encode(resp)_,_=w.Write(encBuf.Bytes())putBuf(encBuf)}//ModelshandlesGET/v1/models.func(h*ProxyHandler)Models(whttp.ResponseWriter,r*http.Request){providers:=h.registry.List()//Pre-allocatewithexpectedcapacity(T208—avoidrepeatedslicegrowth)models:=make([]modelEntry,0,len(providers)*4)for_,name:=rangeproviders{prov,ok:=h.registry.Get(name)if!ok{continue}for_,model:=rangeprov.Models(){models=append(models,modelEntry{ID:model,Object:"model",Provider:name,OwnedBy:name,})}}resp:=modelsResponse{Object:"list",Data:models,}w.Header().Set("Content-Type","application/json")encBuf:=getBuf()_=json.NewEncoder(encBuf).Encode(resp)_,_=w.Write(encBuf.Bytes())putBuf(encBuf)}//ProviderHealthhandlesGET/v1/providers/health.func(h*ProxyHandler)ProviderHealth(whttp.ResponseWriter,r*http.Request){health:=h.registry.HealthCheckAll(r.Context())//Usetypedstructinsteadofmap[string]interface{}(T208)resp:=make(map[string]providerHealthEntry,len(health))forname,status:=rangehealth{resp[name]=providerHealthEntry{Healthy:status.Healthy,LatencyMs:status.Latency.Milliseconds(),LastCheck:status.LastCheck.Format(time.RFC3339),Error:status.Error,}}w.Header().Set("Content-Type","application/json")encBuf:=getBuf()_=json.NewEncoder(encBuf).Encode(resp)_,_=w.Write(encBuf.Bytes())putBuf(encBuf)}func(h*ProxyHandler)writeError(whttp.ResponseWriter,statusint,errType,messagestring){code:=ErrorCode(errType)hint:=errorCatalog[code]w.Header().Set("Content-Type","application/json")w.WriteHeader(status)//Usetypedstruct+pooledbuffer(T208—eliminates3allocs)encBuf:=getBuf()_=json.NewEncoder(encBuf).Encode(errorResponse{Error:errorDetail{Type:errType,Message:message,Hint:hint,Code:errType},})_,_=w.Write(encBuf.Bytes())putBuf(encBuf)}//GetAPIKeyFromRequestextractstheAPIkeyfromtherequestcontext.funcGetAPIKeyFromRequest(r*http.Request)string{apiKey:=middleware.GetAPIKey(r.Context())ifapiKey!=""{returnapiKey}//Fallback:readfromAuthorizationheaderdirectlyauth:=r.Header.Get("Authorization")ifstrings.HasPrefix(auth,"Bearer"){returnauth[7:]}returnauth}