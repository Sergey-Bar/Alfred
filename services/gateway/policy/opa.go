packagepolicyimport("bytes""context""encoding/json""fmt""io""net/http""sync""time")//───T132:OPAServerIntegration───────────────────────────typeOPAConfigstruct{Enabledbool`json:"enabled"`Addressstring`json:"address"`//e.g.,"http://localhost:8181"Timeouttime.Duration`json:"timeout"`DryRunbool`json:"dry_run"`//T135:evaluatebutdon'tenforceLogEnabledbool`json:"log_enabled"`}typeOPAClientstruct{configOPAConfigclient*http.Clientmusync.RWMutexpoliciesmap[string]*Policy//in-memorypolicystoreevalLog[]PolicyEvaluationResult//T136:evaluationlog}typePolicystruct{IDstring`json:"id"`Namestring`json:"name"`Descriptionstring`json:"description"`Modulestring`json:"module"`//RegosourcecodeActivebool`json:"active"`DryRunbool`json:"dry_run"`CreatedAttime.Time`json:"created_at"`UpdatedAttime.Time`json:"updated_at"`}//OPAevaluationinputmirrorstherequestcontext.typePolicyInputstruct{Modelstring`json:"model"`Providerstring`json:"provider"`UserIDstring`json:"user_id"`TeamIDstring`json:"team_id"`OrgIDstring`json:"org_id"`EstimatedTokensint`json:"estimated_tokens"`RequestTimetime.Time`json:"request_time"`Metadatamap[string]string`json:"metadata"`DataClassstring`json:"data_classification"`SourceIPstring`json:"source_ip"`}//OPAdecisionresponse.typePolicyDecisionstruct{Allowbool`json:"allow"`Deny[]string`json:"deny"`Route[]string`json:"route"`Warn[]string`json:"warn"`DryRunbool`json:"dry_run"`}//───T136:PolicyEvaluationLogging────────────────────────typePolicyEvaluationResultstruct{PolicyIDstring`json:"policy_id"`PolicyNamestring`json:"policy_name"`DecisionPolicyDecision`json:"decision"`InputPolicyInput`json:"input"`Timestamptime.Time`json:"timestamp"`LatencyMsfloat64`json:"latency_ms"`DryRunbool`json:"dry_run"`}funcNewOPAClient(configOPAConfig)*OPAClient{ifconfig.Timeout==0{config.Timeout=5*time.Second}ifconfig.Address==""{config.Address="http://localhost:8181"}return&OPAClient{config:config,client:&http.Client{Timeout:config.Timeout,},policies:make(map[string]*Policy),evalLog:make([]PolicyEvaluationResult,0,1024),}}//───T133:PolicyCRUDAPI──────────────────────────────────func(c*OPAClient)CreatePolicy(p*Policy)error{c.mu.Lock()deferc.mu.Unlock()if_,exists:=c.policies[p.ID];exists{returnfmt.Errorf("policy%salreadyexists",p.ID)}now:=time.Now()p.CreatedAt=nowp.UpdatedAt=nowc.policies[p.ID]=p//SynctoOPAserverifc.config.Enabled{returnc.uploadToOPA(p)}returnnil}func(c*OPAClient)UpdatePolicy(idstring,modulestring,activebool)error{c.mu.Lock()deferc.mu.Unlock()p,ok:=c.policies[id]if!ok{returnfmt.Errorf("policy%snotfound",id)}p.Module=modulep.Active=activep.UpdatedAt=time.Now()ifc.config.Enabled{returnc.uploadToOPA(p)}returnnil}func(c*OPAClient)DeletePolicy(idstring)error{c.mu.Lock()deferc.mu.Unlock()if_,ok:=c.policies[id];!ok{returnfmt.Errorf("policy%snotfound",id)}delete(c.policies,id)ifc.config.Enabled{returnc.deleteFromOPA(id)}returnnil}func(c*OPAClient)GetPolicy(idstring)(*Policy,error){c.mu.RLock()deferc.mu.RUnlock()p,ok:=c.policies[id]if!ok{returnnil,fmt.Errorf("policy%snotfound",id)}returnp,nil}func(c*OPAClient)ListPolicies()[]*Policy{c.mu.RLock()deferc.mu.RUnlock()result:=make([]*Policy,0,len(c.policies))for_,p:=rangec.policies{result=append(result,p)}returnresult}//uploadToOPApushesaRegomoduletotheOPARESTAPI.func(c*OPAClient)uploadToOPA(p*Policy)error{url:=fmt.Sprintf("%s/v1/policies/%s",c.config.Address,p.ID)req,err:=http.NewRequest(http.MethodPut,url,bytes.NewBufferString(p.Module))iferr!=nil{returnfmt.Errorf("createrequest:%w",err)}req.Header.Set("Content-Type","text/plain")resp,err:=c.client.Do(req)iferr!=nil{returnfmt.Errorf("uploadtoOPA:%w",err)}deferresp.Body.Close()ifresp.StatusCode>=400{body,_:=io.ReadAll(resp.Body)returnfmt.Errorf("OPAuploadfailed(%d):%s",resp.StatusCode,string(body))}returnnil}func(c*OPAClient)deleteFromOPA(idstring)error{url:=fmt.Sprintf("%s/v1/policies/%s",c.config.Address,id)req,err:=http.NewRequest(http.MethodDelete,url,nil)iferr!=nil{returnfmt.Errorf("createrequest:%w",err)}resp,err:=c.client.Do(req)iferr!=nil{returnfmt.Errorf("deletefromOPA:%w",err)}deferresp.Body.Close()returnnil}//───PolicyEvaluation──────────────────────────────────────//Evaluaterunsallactivepoliciesagainstthegiveninput.func(c*OPAClient)Evaluate(ctxcontext.Context,inputPolicyInput)(*PolicyDecision,error){c.mu.RLock()activePolicies:=make([]*Policy,0)for_,p:=rangec.policies{ifp.Active{activePolicies=append(activePolicies,p)}}c.mu.RUnlock()combined:=&PolicyDecision{Allow:true}for_,p:=rangeactivePolicies{start:=time.Now()decision,err:=c.evaluatePolicy(ctx,p,input)elapsed:=time.Since(start)iferr!=nil{//Logbutdon'tblockonOPAerrorsunlessstrictmodeifc.config.LogEnabled{c.logEvaluation(p,input,&PolicyDecision{Allow:true},elapsed,p.DryRun||c.config.DryRun)}continue}isDryRun:=p.DryRun||c.config.DryRundecision.DryRun=isDryRunifc.config.LogEnabled{c.logEvaluation(p,input,decision,elapsed,isDryRun)}//T135:Indry-runmode,logbutdon'tenforceifisDryRun{combined.Warn=append(combined.Warn,decision.Deny...)combined.Warn=append(combined.Warn,decision.Warn...)continue}//Mergedenyreasonscombined.Deny=append(combined.Deny,decision.Deny...)combined.Warn=append(combined.Warn,decision.Warn...)combined.Route=append(combined.Route,decision.Route...)iflen(decision.Deny)>0{combined.Allow=false}}returncombined,nil}func(c*OPAClient)evaluatePolicy(ctxcontext.Context,p*Policy,inputPolicyInput)(*PolicyDecision,error){if!c.config.Enabled{//Localevaluationstub—inproduction,thiscallsOPADataAPIreturn&PolicyDecision{Allow:true},nil}payload:=map[string]interface{}{"input":input,}body,err:=json.Marshal(payload)iferr!=nil{returnnil,fmt.Errorf("marshalinput:%w",err)}url:=fmt.Sprintf("%s/v1/data/alfred/%s",c.config.Address,p.ID)req,err:=http.NewRequestWithContext(ctx,http.MethodPost,url,bytes.NewReader(body))iferr!=nil{returnnil,fmt.Errorf("createrequest:%w",err)}req.Header.Set("Content-Type","application/json")resp,err:=c.client.Do(req)iferr!=nil{returnnil,fmt.Errorf("OPAquery:%w",err)}deferresp.Body.Close()varresultstruct{Resultstruct{Deny[]string`json:"deny"`Route[]string`json:"route"`Warn[]string`json:"warn"`}`json:"result"`}iferr:=json.NewDecoder(resp.Body).Decode(&result);err!=nil{returnnil,fmt.Errorf("decodeOPAresponse:%w",err)}decision:=&PolicyDecision{Allow:len(result.Result.Deny)==0,Deny:result.Result.Deny,Route:result.Result.Route,Warn:result.Result.Warn,}returndecision,nil}func(c*OPAClient)logEvaluation(p*Policy,inputPolicyInput,decision*PolicyDecision,latencytime.Duration,dryRunbool){c.mu.Lock()deferc.mu.Unlock()entry:=PolicyEvaluationResult{PolicyID:p.ID,PolicyName:p.Name,Decision:*decision,Input:input,Timestamp:time.Now(),LatencyMs:float64(latency.Microseconds())/1000.0,DryRun:dryRun,}c.evalLog=append(c.evalLog,entry)//Ringbuffer—keeplast10Kentriesiflen(c.evalLog)>10000{c.evalLog=c.evalLog[len(c.evalLog)-10000:]}}//GetEvaluationLogreturnsrecentpolicyevaluationlogentries.func(c*OPAClient)GetEvaluationLog(limitint)[]PolicyEvaluationResult{c.mu.RLock()deferc.mu.RUnlock()iflimit<=0||limit>len(c.evalLog){limit=len(c.evalLog)}start:=len(c.evalLog)-limitresult:=make([]PolicyEvaluationResult,limit)copy(result,c.evalLog[start:])returnresult}//───T134:Built-inPolicyTemplates────────────────────────//BuiltInPoliciesreturnspre-builtRegopolicytemplates.funcBuiltInPolicies()[]*Policy{return[]*Policy{{ID:"premium_model_gating",Name:"PremiumModelGating",Description:"Restrictpremiummodels(GPT-4,ClaudeOpus)toapprovedteams",Active:false,Module:`packagealfred.premium_model_gatingimportfuture.keywords.inpremium_models:={"gpt-4","gpt-4-turbo","gpt-4o","claude-3-opus","claude-opus-4"}approved_teams:={"engineering-core","ml-research","security"}deny[reason]{input.modelinpremium_modelsnotinput.team_idinapproved_teamsreason:=sprintf("Team%sisnotapprovedforpremiummodel%s",[input.team_id,input.model])}`,},{ID:"token_limit",Name:"TokenLimitPolicy",Description:"Blockrequestsexceeding20Kestimatedtokens",Active:false,Module:`packagealfred.token_limitdeny[reason]{input.estimated_tokens>20000reason:=sprintf("Requestexceedstokenlimit(%d>20000)",[input.estimated_tokens])}warn[reason]{input.estimated_tokens>10000input.estimated_tokens<=20000reason:=sprintf("Largerequestwarning:%dtokensestimated",[input.estimated_tokens])}`,},{ID:"time_of_day",Name:"BusinessHoursModelRestriction",Description:"Restrictexpensivemodelstobusinesshours(9AM-6PMUTC)",Active:false,Module:`packagealfred.time_of_dayimportfuture.keywords.inexpensive_models:={"gpt-4","gpt-4-turbo","claude-3-opus"}deny[reason]{input.modelinexpensive_modelshour:=time.clock(time.now_ns())[0]hour<9reason:=sprintf("Premiummodel%srestrictedoutsidebusinesshours(before9AMUTC)",[input.model])}deny[reason]{input.modelinexpensive_modelshour:=time.clock(time.now_ns())[0]hour>=18reason:=sprintf("Premiummodel%srestrictedoutsidebusinesshours(after6PMUTC)",[input.model])}`,},{ID:"data_classification",Name:"DataClassificationRouting",Description:"Routeconfidentialdatatoself-hostedmodelsonly",Active:false,Module:`packagealfred.data_classificationimportfuture.keywords.inself_hosted_models:={"llama-3.1-70b","mistral-7b","codellama-34b"}deny[reason]{input.data_classification=="CONFIDENTIAL"notinput.modelinself_hosted_modelsreason:=sprintf("Confidentialdatamustuseself-hostedmodels,not%s",[input.model])}route[target]{input.data_classification=="CONFIDENTIAL"target:="self-hosted-llama"}`,},{ID:"rate_limit_per_user",Name:"Per-UserRateLimit",Description:"Warnwhenausermakestoomanyrequests",Active:false,Module:`packagealfred.rate_limit_per_userwarn[reason]{input.metadata.requests_last_minuteto_number(input.metadata.requests_last_minute)>60reason:=sprintf("User%sexceeding60requests/minute",[input.user_id])}`,},{ID:"geo_restriction",Name:"GeographicDataResidency",Description:"EnforceEUdataresidencyforEU-originrequests",Active:false,Module:`packagealfred.geo_restrictionimportfuture.keywords.ineu_providers:={"eu-openai","eu-anthropic","self-hosted-eu"}deny[reason]{input.metadata.region=="EU"notinput.providerineu_providersreason:=sprintf("EUdataresidencyrequiresEUprovider,not%s",[input.provider])}`,},{ID:"pii_model_restriction",Name:"PII-FlaggedRequestRestriction",Description:"RoutePII-containingrequeststoapprovedmodelsonly",Active:false,Module:`packagealfred.pii_model_restrictionimportfuture.keywords.inpii_approved:={"self-hosted-llama","azure-openai-hipaa"}deny[reason]{input.metadata.contains_pii=="true"notinput.providerinpii_approvedreason:=sprintf("PII-flaggedrequestsmustuseapprovedproviders,not%s",[input.provider])}`,},{ID:"budget_routing",Name:"Budget-AwareModelDowngrade",Description:"Routetocheapermodelswhenwalletisabove80%usage",Active:false,Module:`packagealfred.budget_routingimportfuture.keywords.inexpensive_models:={"gpt-4","gpt-4-turbo","claude-3-opus"}cheap_alternatives:={"gpt-3.5-turbo":"gpt-3.5-turbo","gpt-4":"gpt-3.5-turbo","claude-3-opus":"claude-3-haiku"}warn[reason]{input.metadata.wallet_usage_pctto_number(input.metadata.wallet_usage_pct)>80input.modelinexpensive_modelsreason:=sprintf("Walletat%s%%—considerusingcheapermodelinsteadof%s",[input.metadata.wallet_usage_pct,input.model])}`,},}}