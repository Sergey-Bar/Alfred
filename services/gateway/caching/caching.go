packagecachingimport("context""crypto/sha256""encoding/hex""encoding/json""fmt""math""strings""sync""sync/atomic""time""github.com/rs/zerolog")//───Configuration──────────────────────────────────────────//CacheConfigholdsper-teamorglobalcachesettings(T109,T110).typeCacheConfigstruct{//Similaritythreshold(0.0-1.0).Higher=strictermatching.SimilarityThresholdfloat64`json:"similarity_threshold"`//DefaultTTLforcachedentries.DefaultTTLtime.Duration`json:"default_ttl"`//Per-modelTTLoverrides(T110).ModelTTLOverridesmap[string]time.Duration`json:"model_ttl_overrides"`//Maximumcachedentriespernamespace.MaxEntriesint`json:"max_entries"`//Enable/disablecachepoisoningvalidation(T115).ValidateResponsesbool`json:"validate_responses"`//Minimumresponselengthtobeconsideredvalid.MinResponseLengthint`json:"min_response_length"`}//DefaultCacheConfigreturnsproductiondefaults.funcDefaultCacheConfig()CacheConfig{returnCacheConfig{SimilarityThreshold:0.92,DefaultTTL:24*time.Hour,ModelTTLOverrides:make(map[string]time.Duration),MaxEntries:10000,ValidateResponses:true,MinResponseLength:10,}}//───Types──────────────────────────────────────────────────//CacheEntryrepresentsastoredprompt→responsepairwithitsembedding.typeCacheEntrystruct{IDstring`json:"id"`Namespacestring`json:"namespace"`//TeamIDforisolation(T109)Modelstring`json:"model"`PromptHashstring`json:"prompt_hash"`//SHA-256ofnormalizedpromptEmbedding[]float64`json:"embedding"`//PromptembeddingvectorResponse[]byte`json:"response"`//CachedresponsebodyTokensSavedint`json:"tokens_saved"`//EstimatedtokensthiscachesavesCreatedAttime.Time`json:"created_at"`ExpiresAttime.Time`json:"expires_at"`HitCountint64`json:"hit_count"`}//CacheLookupResultrepresentstheoutcomeofacachequery.typeCacheLookupResultstruct{Hitbool`json:"hit"`Entry*CacheEntry`json:"entry,omitempty"`Similarityfloat64`json:"similarity"`Sourcestring`json:"source"`//"exact"or"semantic"}//CacheStatstrackshit/missmetrics(T113).typeCacheStatsstruct{Hitsint64`json:"hits"`Missesint64`json:"misses"`Evictionsint64`json:"evictions"`Entriesint64`json:"entries"`HitRatefloat64`json:"hit_rate_pct"`AvgSimilarityfloat64`json:"avg_similarity"`TotalSavedint64`json:"total_tokens_saved"`}//EmbeddingFuncgeneratesanembeddingvectorforatextstring.//Providedbythecaller(wrapstheproviderregistry'sembeddingendpoint).typeEmbeddingFuncfunc(ctxcontext.Context,textstring,modelstring)([]float64,error)//───SemanticCacheEngine──────────────────────────────────//Engineisthein-processsemanticcache(T105-T115).//ProductiondeploymentsshouldbackthiswithRedisVectorSearch;//thisimplementationprovidesthefullAPIcontractwithanin-memorystore.typeEnginestruct{musync.RWMutexloggerzerolog.LoggerconfigCacheConfig//namespace→entries(T109:per-teamsegmentation)storemap[string][]*CacheEntry//Exact-matchindex:namespace:promptHash→entryexactIndexmap[string]*CacheEntry//EmbeddingfunctionembedFnEmbeddingFunc//Metrics(T113)hitsint64missesint64evictionsint64totalSavedint64simSumfloat64simCountint64}//NewEnginecreatesanewsemanticcacheengine.funcNewEngine(loggerzerolog.Logger,embedFnEmbeddingFunc,config...CacheConfig)*Engine{cfg:=DefaultCacheConfig()iflen(config)>0{cfg=config[0]}return&Engine{logger:logger.With().Str("component","semantic_cache").Logger(),config:cfg,store:make(map[string][]*CacheEntry),exactIndex:make(map[string]*CacheEntry),embedFn:embedFn,}}//───T107:SimilaritySearch+Threshold────────────────────//Lookupchecksthecacheforasemanticallysimilarprompt.//ReturnsaCacheLookupResultwithhit/missstatusandsimilarityscore.////Thelookuporderis://1.Exacthashmatch(fastpath)//2.Vectorsimilaritysearch(cosinedistance)func(e*Engine)Lookup(ctxcontext.Context,namespace,model,promptstring)(*CacheLookupResult,error){promptHash:=hashPrompt(normalizePrompt(prompt))exactKey:=fmt.Sprintf("%s:%s",namespace,promptHash)//Fastpath:exactmatche.mu.RLock()ifentry,ok:=e.exactIndex[exactKey];ok&&entry.ExpiresAt.After(time.Now()){e.mu.RUnlock()atomic.AddInt64(&e.hits,1)atomic.AddInt64(&entry.HitCount,1)atomic.AddInt64(&e.totalSaved,int64(entry.TokensSaved))return&CacheLookupResult{Hit:true,Entry:entry,Similarity:1.0,Source:"exact",},nil}e.mu.RUnlock()//Generateembeddingforsimilaritysearchembedding,err:=e.embedFn(ctx,prompt,model)iferr!=nil{atomic.AddInt64(&e.misses,1)e.logger.Debug().Err(err).Msg("embeddinggenerationfailed,cachemiss")return&CacheLookupResult{Hit:false},nil}//Searchwithinnamespace(T109)e.mu.RLock()entries:=e.store[namespace]e.mu.RUnlock()varbestEntry*CacheEntryvarbestSimfloat64now:=time.Now()for_,entry:=rangeentries{//Skipexpiredentriesifentry.ExpiresAt.Before(now){continue}//Skipdifferentmodels(optional—someteamsmaywantcross-modelcaching)ifentry.Model!=model{continue}sim:=cosineSimilarity(embedding,entry.Embedding)ifsim>bestSim{bestSim=simbestEntry=entry}}//Checkthreshold(T107)ifbestEntry!=nil&&bestSim>=e.config.SimilarityThreshold{//Validateresponse(T115:cachepoisoningprevention)ife.config.ValidateResponses&&!e.validateResponse(bestEntry){e.logger.Warn().Str("entry_id",bestEntry.ID).Float64("similarity",bestSim).Msg("cachehitfailedvalidation,treatingasmiss")e.evictEntry(bestEntry)atomic.AddInt64(&e.misses,1)return&CacheLookupResult{Hit:false,Similarity:bestSim},nil}atomic.AddInt64(&e.hits,1)atomic.AddInt64(&bestEntry.HitCount,1)atomic.AddInt64(&e.totalSaved,int64(bestEntry.TokensSaved))//Tracksimilaritystatse.mu.Lock()e.simSum+=bestSime.simCount++e.mu.Unlock()return&CacheLookupResult{Hit:true,Entry:bestEntry,Similarity:bestSim,Source:"semantic",},nil}atomic.AddInt64(&e.misses,1)return&CacheLookupResult{Hit:false,Similarity:bestSim},nil}//───T108:CacheWriteonResponse──────────────────────────//Storewritesanewprompt→responsepairtothecache.func(e*Engine)Store(ctxcontext.Context,namespace,model,promptstring,response[]byte,tokensSavedint,)(*CacheEntry,error){normalized:=normalizePrompt(prompt)promptHash:=hashPrompt(normalized)//Generateembeddingembedding,err:=e.embedFn(ctx,prompt,model)iferr!=nil{returnnil,fmt.Errorf("embeddinggenerationfailed:%w",err)}//DetermineTTL(T110)ttl:=e.config.DefaultTTLifoverride,ok:=e.config.ModelTTLOverrides[model];ok{ttl=override}now:=time.Now()entry:=&CacheEntry{ID:fmt.Sprintf("%s-%s",namespace,promptHash[:12]),Namespace:namespace,Model:model,PromptHash:promptHash,Embedding:embedding,Response:response,TokensSaved:tokensSaved,CreatedAt:now,ExpiresAt:now.Add(ttl),HitCount:0,}e.mu.Lock()defere.mu.Unlock()//Checkcapacityandevictifneededentries:=e.store[namespace]iflen(entries)>=e.config.MaxEntries{e.evictOldest(namespace)}//Addtostoreandexactindexe.store[namespace]=append(e.store[namespace],entry)exactKey:=fmt.Sprintf("%s:%s",namespace,promptHash)e.exactIndex[exactKey]=entrye.logger.Debug().Str("namespace",namespace).Str("model",model).Str("entry_id",entry.ID).Int("tokens_saved",tokensSaved).Msg("cachedresponse")returnentry,nil}//───T112:CacheBypass─────────────────────────────────────//ShouldBypasschecksrequestheadersforcachebypasssignals.funcShouldBypass(headersmap[string]string)bool{ifv,ok:=headers["X-Cache-Bypass"];ok&&strings.EqualFold(v,"true"){returntrue}ifv,ok:=headers["Cache-Control"];ok&&strings.Contains(strings.ToLower(v),"no-cache"){returntrue}returnfalse}//───T114:CacheInvalidation───────────────────────────────//InvalidateremovesaspecificentrybyID.func(e*Engine)Invalidate(namespace,entryIDstring)bool{e.mu.Lock()defere.mu.Unlock()entries:=e.store[namespace]fori,entry:=rangeentries{ifentry.ID==entryID{//RemovefromexactindexexactKey:=fmt.Sprintf("%s:%s",namespace,entry.PromptHash)delete(e.exactIndex,exactKey)//Removefromstoree.store[namespace]=append(entries[:i],entries[i+1:]...)atomic.AddInt64(&e.evictions,1)returntrue}}returnfalse}//FlushNamespaceremovesallentriesforanamespace(T114).func(e*Engine)FlushNamespace(namespacestring)int{e.mu.Lock()defere.mu.Unlock()entries:=e.store[namespace]count:=len(entries)for_,entry:=rangeentries{exactKey:=fmt.Sprintf("%s:%s",namespace,entry.PromptHash)delete(e.exactIndex,exactKey)}delete(e.store,namespace)atomic.AddInt64(&e.evictions,int64(count))returncount}//FlushAllremovesallentriesfromallnamespaces.func(e*Engine)FlushAll()int{e.mu.Lock()defere.mu.Unlock()total:=0forns,entries:=rangee.store{total+=len(entries)for_,entry:=rangeentries{exactKey:=fmt.Sprintf("%s:%s",ns,entry.PromptHash)delete(e.exactIndex,exactKey)}}e.store=make(map[string][]*CacheEntry)atomic.AddInt64(&e.evictions,int64(total))returntotal}//───T113:CacheMetrics────────────────────────────────────//Statsreturnscurrentcacheperformancemetrics.func(e*Engine)Stats()CacheStats{hits:=atomic.LoadInt64(&e.hits)misses:=atomic.LoadInt64(&e.misses)evictions:=atomic.LoadInt64(&e.evictions)totalSaved:=atomic.LoadInt64(&e.totalSaved)total:=hits+misseshitRate:=float64(0)iftotal>0{hitRate=float64(hits)/float64(total)*100}e.mu.RLock()varavgSimfloat64ife.simCount>0{avgSim=e.simSum/float64(e.simCount)}varentryCountint64for_,entries:=rangee.store{entryCount+=int64(len(entries))}e.mu.RUnlock()returnCacheStats{Hits:hits,Misses:misses,Evictions:evictions,Entries:entryCount,HitRate:math.Round(hitRate*100)/100,AvgSimilarity:math.Round(avgSim*1000)/1000,TotalSaved:totalSaved,}}//───T115:CachePoisoningPrevention───────────────────────func(e*Engine)validateResponse(entry*CacheEntry)bool{//Checkminimumlengthiflen(entry.Response)<e.config.MinResponseLength{returnfalse}//ValidateJSONstructure(responsesshouldbevalidJSON)varparsedmap[string]interface{}iferr:=json.Unmarshal(entry.Response,&parsed);err!=nil{returnfalse}//Checkforerrorresponsesthatshouldn'tbecachediferrField,ok:=parsed["error"];ok&&errField!=nil{returnfalse}//Checkforemptychoicesarrayifchoices,ok:=parsed["choices"];ok{ifarr,ok:=choices.([]interface{});ok&&len(arr)==0{returnfalse}}returntrue}//───InternalHelpers───────────────────────────────────────func(e*Engine)evictEntry(entry*CacheEntry){e.mu.Lock()defere.mu.Unlock()entries:=e.store[entry.Namespace]fori,e2:=rangeentries{ife2.ID==entry.ID{exactKey:=fmt.Sprintf("%s:%s",entry.Namespace,entry.PromptHash)delete(e.exactIndex,exactKey)e.store[entry.Namespace]=append(entries[:i],entries[i+1:]...)atomic.AddInt64(&e.evictions,1)return}}}func(e*Engine)evictOldest(namespacestring){entries:=e.store[namespace]iflen(entries)==0{return}//Findoldestbycreationtimeoldest:=0fori,entry:=rangeentries{ifentry.CreatedAt.Before(entries[oldest].CreatedAt){oldest=i}}entry:=entries[oldest]exactKey:=fmt.Sprintf("%s:%s",namespace,entry.PromptHash)delete(e.exactIndex,exactKey)e.store[namespace]=append(entries[:oldest],entries[oldest+1:]...)atomic.AddInt64(&e.evictions,1)}//normalizePromptstripswhitespaceandlowercasesforconsistenthashing.funcnormalizePrompt(promptstring)string{returnstrings.ToLower(strings.TrimSpace(prompt))}//hashPromptreturnsSHA-256hexdigestofapromptstring.funchashPrompt(promptstring)string{h:=sha256.Sum256([]byte(prompt))returnhex.EncodeToString(h[:])}//cosineSimilaritycomputesthecosinesimilaritybetweentwovectors.funccosineSimilarity(a,b[]float64)float64{iflen(a)!=len(b)||len(a)==0{return0}vardotProduct,normA,normBfloat64fori:=rangea{dotProduct+=a[i]*b[i]normA+=a[i]*a[i]normB+=b[i]*b[i]}ifnormA==0||normB==0{return0}returndotProduct/(math.Sqrt(normA)*math.Sqrt(normB))}