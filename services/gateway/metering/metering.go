packagemeteringimport("context""sync""sync/atomic""time")//TokenCounterestimatesandcountstokensformeteringpurposes.//T041:Tokencounting(character-basedestimation;tiktokendeferred).typeTokenCounterstruct{//charsPerTokenistheaveragecharacterspertokenestimate.//Englishaverages~4chars/token;code~3.5;multilingual~2.5.charsPerTokenfloat64}//NewTokenCountercreatesatokencounterwithconfigurableratio.funcNewTokenCounter(charsPerTokenfloat64)*TokenCounter{ifcharsPerToken<=0{charsPerToken=4.0//default:Englishtext}return&TokenCounter{charsPerToken:charsPerToken}}//EstimateTokensestimatesthetokencountforatextstring.func(tc*TokenCounter)EstimateTokens(textstring)int{iflen(text)==0{return0}tokens:=float64(len(text))/tc.charsPerToken//Addoverheadforspecialtokens(BOS,EOS,formatting).returnint(tokens)+3}//EstimateMessagesTokensestimatestotaltokensforachatconversation.func(tc*TokenCounter)EstimateMessagesTokens(messages[]Message)int{total:=0for_,msg:=rangemessages{//Eachmessagehasoverhead:roletoken+separator.total+=4//<im_start>,role,\n,contenttotal+=tc.EstimateTokens(msg.Content)ifmsg.Name!=""{total+=tc.EstimateTokens(msg.Name)}}total+=2//<im_start>assistant,finalseparatorreturntotal}//Messagerepresentsasimplifiedchatmessagefortokencounting.typeMessagestruct{Rolestring`json:"role"`Contentstring`json:"content"`Namestring`json:"name,omitempty"`}//---CostCalculationEngine(T042)---//CostEnginecalculatesrequestcostsbasedontokenusageandpricing.typeCostEnginestruct{musync.RWMutexpricingmap[string]ModelPrice}//ModelPriceholdsper-modelpricing.typeModelPricestruct{Providerstring`json:"provider"`Modelstring`json:"model"`InputPer1Mfloat64`json:"input_per_1m"`//USDper1MinputtokensOutputPer1Mfloat64`json:"output_per_1m"`//USDper1MoutputtokensFreebool`json:"free"`}//NewCostEnginecreatesacostenginewithdefaultpricing.funcNewCostEngine()*CostEngine{return&CostEngine{pricing:defaultPricing(),}}//CalculatecomputestheUSDcostforacompletedrequest.func(ce*CostEngine)Calculate(provider,modelstring,inputTokens,outputTokensint)float64{ce.mu.RLock()deferce.mu.RUnlock()key:=provider+"/"+modelifp,ok:=ce.pricing[key];ok{ifp.Free{return0}inputCost:=float64(inputTokens)/1_000_000*p.InputPer1MoutputCost:=float64(outputTokens)/1_000_000*p.OutputPer1MreturninputCost+outputCost}//Fallback:trymodelnameonly.ifp,ok:=ce.pricing[model];ok{ifp.Free{return0}inputCost:=float64(inputTokens)/1_000_000*p.InputPer1MoutputCost:=float64(outputTokens)/1_000_000*p.OutputPer1MreturninputCost+outputCost}return0//Unknownmodel—nocost}//Estimateestimatescostbeforetherequestcompletes(T043).func(ce*CostEngine)Estimate(provider,modelstring,inputTokens,maxOutputTokensint)float64{returnce.Calculate(provider,model,inputTokens,maxOutputTokens)}//IsFreereturnstrueifthemodelisfreetouse(T049).func(ce*CostEngine)IsFree(modelstring)bool{ce.mu.RLock()deferce.mu.RUnlock()ifp,ok:=ce.pricing[model];ok{returnp.Free}returnfalse}//UpdatePricingupdatesthepricingforaspecificmodel.func(ce*CostEngine)UpdatePricing(provider,modelstring,priceModelPrice){ce.mu.Lock()deferce.mu.Unlock()ce.pricing[provider+"/"+model]=price}funcdefaultPricing()map[string]ModelPrice{returnmap[string]ModelPrice{//OpenAI"openai/gpt-4o":{Provider:"openai",Model:"gpt-4o",InputPer1M:2.50,OutputPer1M:10.00},"openai/gpt-4o-mini":{Provider:"openai",Model:"gpt-4o-mini",InputPer1M:0.15,OutputPer1M:0.60},"openai/gpt-4-turbo":{Provider:"openai",Model:"gpt-4-turbo",InputPer1M:10.00,OutputPer1M:30.00},"openai/gpt-3.5-turbo":{Provider:"openai",Model:"gpt-3.5-turbo",InputPer1M:0.50,OutputPer1M:1.50},"openai/o1":{Provider:"openai",Model:"o1",InputPer1M:15.00,OutputPer1M:60.00},"openai/o1-mini":{Provider:"openai",Model:"o1-mini",InputPer1M:3.00,OutputPer1M:12.00},//Anthropic"anthropic/claude-3-opus":{Provider:"anthropic",Model:"claude-3-opus",InputPer1M:15.00,OutputPer1M:75.00},"anthropic/claude-3-sonnet":{Provider:"anthropic",Model:"claude-3-sonnet",InputPer1M:3.00,OutputPer1M:15.00},"anthropic/claude-3-haiku":{Provider:"anthropic",Model:"claude-3-haiku",InputPer1M:0.25,OutputPer1M:1.25},"anthropic/claude-3.5-sonnet":{Provider:"anthropic",Model:"claude-3.5-sonnet",InputPer1M:3.00,OutputPer1M:15.00},//Google"google/gemini-1.5-pro":{Provider:"google",Model:"gemini-1.5-pro",InputPer1M:1.25,OutputPer1M:5.00},"google/gemini-1.5-flash":{Provider:"google",Model:"gemini-1.5-flash",InputPer1M:0.075,OutputPer1M:0.30},"google/gemini-2.0-flash":{Provider:"google",Model:"gemini-2.0-flash",InputPer1M:0.10,OutputPer1M:0.40},//Groq(freetiermodels)"groq/llama-3.1-70b":{Provider:"groq",Model:"llama-3.1-70b",Free:true},"groq/llama-3.1-8b":{Provider:"groq",Model:"llama-3.1-8b",Free:true},"groq/mixtral-8x7b":{Provider:"groq",Model:"mixtral-8x7b",Free:true},}}//---StreamingTokenCounter(T044)---//StreamMetercountstokensasSSEchunksarriveduringstreaming.typeStreamMeterstruct{counter*TokenCounterinputTokensintoutputTokensint64//atomicforconcurrentaccesschunkCountint64startTimetime.Time}//NewStreamMetercreatesastreammeterpre-loadedwithinputtokencount.funcNewStreamMeter(counter*TokenCounter,inputTokensint)*StreamMeter{return&StreamMeter{counter:counter,inputTokens:inputTokens,startTime:time.Now(),}}//AddChunkprocessesastreamingchunkandaccumulatesoutputtokens.func(sm*StreamMeter)AddChunk(textstring){tokens:=sm.counter.EstimateTokens(text)atomic.AddInt64(&sm.outputTokens,int64(tokens))atomic.AddInt64(&sm.chunkCount,1)}//InputTokensreturnsthepre-calculatedinputtokencount.func(sm*StreamMeter)InputTokens()int{returnsm.inputTokens}//OutputTokensreturnstheaccumulatedoutputtokencount.func(sm*StreamMeter)OutputTokens()int{returnint(atomic.LoadInt64(&sm.outputTokens))}//TotalTokensreturnsinput+outputtokens.func(sm*StreamMeter)TotalTokens()int{returnsm.inputTokens+sm.OutputTokens()}//ChunkCountreturnsthenumberofchunksprocessed.func(sm*StreamMeter)ChunkCount()int{returnint(atomic.LoadInt64(&sm.chunkCount))}//Durationreturnsthetimesincemeteringstarted.func(sm*StreamMeter)Duration()time.Duration{returntime.Since(sm.startTime)}//---Reserve-SettlePattern(T045)---//Reservationrepresentsapre-flightwalletholdforarequest.typeReservationstruct{IDstring`json:"id"`WalletIDstring`json:"wallet_id"`UserIDstring`json:"user_id"`Modelstring`json:"model"`Providerstring`json:"provider"`EstimatedCostfloat64`json:"estimated_cost"`ActualCostfloat64`json:"actual_cost"`InputTokensint`json:"input_tokens"`OutputTokensint`json:"output_tokens"`Statusstring`json:"status"`//"reserved","settled","refunded","expired"CreatedAttime.Time`json:"created_at"`SettledAt*time.Time`json:"settled_at,omitempty"`}//ReservationStoremanagescostreservations.typeReservationStorestruct{musync.RWMutexreservationsmap[string]*Reservation}//NewReservationStorecreatesanewreservationstore.funcNewReservationStore()*ReservationStore{return&ReservationStore{reservations:make(map[string]*Reservation),}}//Reservecreatesacostreservationbeforecallingtheprovider.func(rs*ReservationStore)Reserve(id,walletID,userID,provider,modelstring,estimatedCostfloat64,inputTokensint)*Reservation{r:=&Reservation{ID:id,WalletID:walletID,UserID:userID,Model:model,Provider:provider,EstimatedCost:estimatedCost,InputTokens:inputTokens,Status:"reserved",CreatedAt:time.Now(),}rs.mu.Lock()rs.reservations[id]=rrs.mu.Unlock()returnr}//Settlefinalizesareservationwithactualusage.func(rs*ReservationStore)Settle(idstring,actualCostfloat64,outputTokensint)(*Reservation,error){rs.mu.Lock()deferrs.mu.Unlock()r,ok:=rs.reservations[id]if!ok{returnnil,ErrReservationNotFound}ifr.Status!="reserved"{returnnil,ErrReservationAlreadySettled}now:=time.Now()r.ActualCost=actualCostr.OutputTokens=outputTokensr.Status="settled"r.SettledAt=&nowreturnr,nil}//Refundcancelsareservation(e.g.,providererror).func(rs*ReservationStore)Refund(idstring)(*Reservation,error){rs.mu.Lock()deferrs.mu.Unlock()r,ok:=rs.reservations[id]if!ok{returnnil,ErrReservationNotFound}now:=time.Now()r.Status="refunded"r.ActualCost=0r.SettledAt=&nowreturnr,nil}//GetreturnsareservationbyID.func(rs*ReservationStore)Get(idstring)(*Reservation,bool){rs.mu.RLock()deferrs.mu.RUnlock()r,ok:=rs.reservations[id]returnr,ok}//---AsyncRequestLogger(T046)---//RequestLogrepresentsacompletedrequestlogentry.typeRequestLogstruct{RequestIDstring`json:"request_id"`UserIDstring`json:"user_id"`WalletIDstring`json:"wallet_id"`Providerstring`json:"provider"`Modelstring`json:"model"`InputTokensint`json:"input_tokens"`OutputTokensint`json:"output_tokens"`TotalTokensint`json:"total_tokens"`Costfloat64`json:"cost"`LatencyMsint64`json:"latency_ms"`Streambool`json:"stream"`StatusCodeint`json:"status_code"`Errorstring`json:"error,omitempty"`CacheHitbool`json:"cache_hit"`ToolCallsint`json:"tool_calls"`CreatedAttime.Time`json:"created_at"`}//AsyncLoggerwritesrequestlogsasynchronouslyviaabufferedchannel.typeAsyncLoggerstruct{chchanRequestLogwgsync.WaitGroupwriterLogWriter}//LogWriteristheinterfaceforpersistingrequestlogs.typeLogWriterinterface{WriteLog(ctxcontext.Context,logRequestLog)errorWriteBatch(ctxcontext.Context,logs[]RequestLog)error}//NewAsyncLoggercreatesanasyncloggerwithconfigurablebuffersize.funcNewAsyncLogger(writerLogWriter,bufferSizeint)*AsyncLogger{ifbufferSize<=0{bufferSize=10000}al:=&AsyncLogger{ch:make(chanRequestLog,bufferSize),writer:writer,}al.wg.Add(1)goal.drain()returnal}//Logqueuesarequestlogentryforasyncwriting.func(al*AsyncLogger)Log(entryRequestLog){select{caseal.ch<-entry://Successfullyqueued.default://Bufferfull—dropthelog(countershouldbeincremented).}}//Closeflushespendinglogsandstopstheasyncwriter.func(al*AsyncLogger)Close(){close(al.ch)al.wg.Wait()}//drainprocesseslogentriesfromthechannelinbatches.func(al*AsyncLogger)drain(){deferal.wg.Done()batch:=make([]RequestLog,0,100)ticker:=time.NewTicker(1*time.Second)deferticker.Stop()for{select{caseentry,ok:=<-al.ch:if!ok{//Channelclosed—flushremaining.iflen(batch)>0{al.flushBatch(batch)}return}batch=append(batch,entry)iflen(batch)>=100{al.flushBatch(batch)batch=batch[:0]}case<-ticker.C:iflen(batch)>0{al.flushBatch(batch)batch=batch[:0]}}}}func(al*AsyncLogger)flushBatch(batch[]RequestLog){ctx,cancel:=context.WithTimeout(context.Background(),10*time.Second)defercancel()_=al.writer.WriteBatch(ctx,batch)}//---SentinelErrors---typemeteringErrorstringfunc(emeteringError)Error()string{returnstring(e)}const(ErrReservationNotFound=meteringError("reservationnotfound")ErrReservationAlreadySettled=meteringError("reservationalreadysettled")ErrInsufficientBalance=meteringError("insufficientwalletbalance"))