import{textSummary}from'https://jslib.k6.io/k6-summary/0.0.3/index.js';import{check,group,sleep}from'k6';importhttpfrom'k6/http';import{Counter,Gauge,Rate,Trend}from'k6/metrics';//───CustomMetrics─────────────────────────────────────────constgatewayOverhead=newTrend('alfred_gateway_overhead_ms',true);consterrorRate=newRate('alfred_error_rate');consttokensPerSec=newCounter('alfred_tokens_total');constrequestThroughput=newCounter('alfred_requests_made');constcacheHitRate=newRate('alfred_cache_hit_rate');constp95Latency=newTrend('alfred_p95_proxy_latency_ms',true);constmemoryUsageMB=newGauge('alfred_memory_usage_mb');//───Configuration──────────────────────────────────────────constBASE_URL=__ENV.ALFRED_BASE_URL||'http://localhost:8080';constAPI_KEY=__ENV.ALFRED_API_KEY||'test-api-key-load-test';constTEST_PROFILE=__ENV.TEST_PROFILE||'sustained';constheaders={'Content-Type':'application/json',Authorization:`Bearer${API_KEY}`,};//───TestProfiles──────────────────────────────────────────constprofiles={//T209:10Kreq/minsustained,P95<100msgatewayoverheadsustained:{scenarios:{sustained_10k:{executor:'ramping-arrival-rate',startRate:10,timeUnit:'1s',preAllocatedVUs:300,maxVUs:600,stages:[{duration:'30s',target:50},//warmup{duration:'1m',target:100},//ramp{duration:'2m',target:167},//10Kreq/min{duration:'5m',target:167},//sustain5min{duration:'30s',target:0},//cooldown],},},thresholds:{'alfred_gateway_overhead_ms':['p(95)<100','p(99)<200'],'alfred_error_rate':['rate<0.01'],'http_req_failed':['rate<0.02'],'http_req_duration':['p(95)<5000'],},},//T229:Stresstest—findthebreakingpointstress:{scenarios:{stress_ramp:{executor:'ramping-arrival-rate',startRate:50,timeUnit:'1s',preAllocatedVUs:500,maxVUs:1000,stages:[{duration:'2m',target:167},//10K/minbaseline{duration:'2m',target:333},//20K/min{duration:'2m',target:500},//30K/min{duration:'2m',target:667},//40K/min{duration:'2m',target:833},//50K/min{duration:'1m',target:0},//cooldown],},},thresholds:{'alfred_error_rate':['rate<0.05'],'http_req_failed':['rate<0.10'],},},//T229:Soaktest—2-hourstabilityvalidationsoak:{scenarios:{soak_2h:{executor:'constant-arrival-rate',rate:100,//6Kreq/min(moderatesteadyload)timeUnit:'1s',duration:'2h',preAllocatedVUs:200,maxVUs:400,},},thresholds:{'alfred_gateway_overhead_ms':['p(95)<100','p(99)<300'],'alfred_error_rate':['rate<0.005'],//<0.5%over2hours'http_req_failed':['rate<0.01'],},},//T229:Latencyprofiling—measureoverheadpreciselylatency_profile:{scenarios:{health_baseline:{executor:'constant-arrival-rate',rate:100,timeUnit:'1s',duration:'2m',preAllocatedVUs:50,maxVUs:100,exec:'healthOnly',},chat_latency:{executor:'constant-arrival-rate',rate:50,timeUnit:'1s',duration:'2m',preAllocatedVUs:50,maxVUs:100,startTime:'2m30s',exec:'chatOnly',},},thresholds:{'http_req_duration{scenario:health_baseline}':['p(95)<20','p(99)<50'],'alfred_gateway_overhead_ms':['p(95)<100'],},},//Quicksmoketest(CI-friendly,1minute)smoke:{scenarios:{smoke_test:{executor:'constant-arrival-rate',rate:10,timeUnit:'1s',duration:'1m',preAllocatedVUs:20,maxVUs:50,},},thresholds:{'alfred_error_rate':['rate<0.05'],'http_req_failed':['rate<0.10'],},},};//SelectactiveprofileconstactiveProfile=profiles[TEST_PROFILE]||profiles.sustained;exportconstoptions=activeProfile;//───TestData──────────────────────────────────────────────constCHAT_PROMPTS=['Explainquantumcomputinginsimpleterms','WriteaPythonfunctiontoreversealist','Whatisthetimecomplexityofquicksort?','Summarizethetheoryofrelativity','Howdoneuralnetworkslearn?','DescribetheCAPtheorem','Whatiseventualconsistency?','ExplainOAuth2.0flow','ComparegRPCandREST','Whatisacircuitbreakerpattern?','HowdoesTLS1.3work?','Explainblue-greendeployments',];constMODELS=['gpt-4o-mini','gpt-4o','claude-3-5-sonnet-20241022','claude-3-haiku-20240307','gemini-1.5-flash',];constEMBEDDING_TEXTS=['Machinelearningisasubsetofartificialintelligence','Theweathertodayissunnyandwarm','Enterprisesoftwarerequirescarefularchitecture','Kubernetesorchestratescontainerizedapplications','Prometheuscollectstime-seriesmetrics',];//───Helpers────────────────────────────────────────────────functionrandomItem(arr){returnarr[Math.floor(Math.random()*arr.length)];}functionrecordMetrics(res){constoverhead=res.headers['X-Alfred-Gateway-Latency'];if(overhead){gatewayOverhead.add(parseFloat(overhead));}constcacheHit=res.headers['X-Alfred-Cache-Hit'];if(cacheHit!==undefined){cacheHitRate.add(cacheHit==='true');}requestThroughput.add(1);}functioncheckMemory(){//Poll/metricsforprocess_resident_memory_bytesifavailabletry{constres=http.get(`${BASE_URL}/metrics`,{timeout:'2s'});if(res.status===200){constmatch=res.body.match(/process_resident_memory_bytes\s+(\d+)/);if(match){memoryUsageMB.add(parseInt(match[1])/1024/1024);}}}catch(e){//Metricsendpointmaynotexposeprocessmemory}}//───DefaultScenario(mixedworkload)──────────────────────exportdefaultfunction(){constroll=Math.random();if(roll<0.55){chatCompletion();}elseif(roll<0.70){embeddings();}elseif(roll<0.85){healthCheck();}elseif(roll<0.95){modelsList();}else{providerHealth();}//Periodicmemorycheck(1in100requests)if(Math.random()<0.01){checkMemory();}sleep(0.05);}//───NamedScenarioFunctions───────────────────────────────exportfunctionhealthOnly(){healthCheck();sleep(0.01);}exportfunctionchatOnly(){chatCompletion();sleep(0.05);}//───TestFunctions─────────────────────────────────────────functionchatCompletion(){group('ChatCompletions',()=>{constpayload=JSON.stringify({model:randomItem(MODELS),messages:[{role:'user',content:randomItem(CHAT_PROMPTS)}],max_tokens:100,temperature:0.7,});constres=http.post(`${BASE_URL}/v1/chat/completions`,payload,{headers:headers,tags:{type:'chat'},timeout:'30s',});check(res,{'chat:200OK':(r)=>r.status===200,'chat:haschoices':(r)=>{try{returnJSON.parse(r.body).choices?.length>0;}catch{returnfalse;}},'chat:hasusage':(r)=>{try{returnJSON.parse(r.body).usage?.total_tokens>0;}catch{returnfalse;}},});errorRate.add(res.status!==200);p95Latency.add(res.timings.duration);recordMetrics(res);if(res.status===200){try{constusage=JSON.parse(res.body).usage;if(usage)tokensPerSec.add(usage.total_tokens);}catch{/*ignore*/}}});}functionembeddings(){group('Embeddings',()=>{constpayload=JSON.stringify({model:'text-embedding-3-small',input:randomItem(EMBEDDING_TEXTS),});constres=http.post(`${BASE_URL}/v1/embeddings`,payload,{headers:headers,tags:{type:'embeddings'},timeout:'15s',});check(res,{'embed:200OK':(r)=>r.status===200,'embed:hasdata':(r)=>{try{returnJSON.parse(r.body).data?.length>0;}catch{returnfalse;}},});errorRate.add(res.status!==200);p95Latency.add(res.timings.duration);recordMetrics(res);});}functionhealthCheck(){group('Health',()=>{constres=http.get(`${BASE_URL}/healthz`,{tags:{type:'health'},timeout:'5s',});check(res,{'health:200OK':(r)=>r.status===200,'health:statusok':(r)=>{try{returnJSON.parse(r.body).status==='ok';}catch{returnfalse;}},});errorRate.add(res.status!==200);recordMetrics(res);});}functionmodelsList(){group('Models',()=>{constres=http.get(`${BASE_URL}/v1/models`,{headers:headers,tags:{type:'models'},timeout:'5s',});check(res,{'models:200OK':(r)=>r.status===200,});errorRate.add(res.status!==200);recordMetrics(res);});}functionproviderHealth(){group('ProviderHealth',()=>{constres=http.get(`${BASE_URL}/v1/providers/health`,{headers:headers,tags:{type:'provider_health'},timeout:'5s',});check(res,{'provider_health:200OK':(r)=>r.status===200,});errorRate.add(res.status!==200);recordMetrics(res);});}//───SummaryHandler────────────────────────────────────────exportfunctionhandleSummary(data){constnow=newDate().toISOString();constmetricsSnap={};//Extractkeymetricsfor(const[name,metric]ofObject.entries(data.metrics||{})){if(metric.values){metricsSnap[name]={...metric.values,thresholds:metric.thresholds||{},};}}constreport={timestamp:now,profile:TEST_PROFILE,duration_s:(data.state?.testRunDurationMs||0)/1000,metrics:metricsSnap,thresholds_passed:!Object.values(data.metrics||{}).some((m)=>m.thresholds&&Object.values(m.thresholds).some((t)=>!t.ok)),};return{stdout:textSummary(data,{indent:'',enableColors:true}),'qa/results/perf_sustained_report.json':JSON.stringify(report,null,2),};}