apiVersion:v1kind:ConfigMapmetadata:name:scaling-test-confignamespace:alfred-perflabels:app.kubernetes.io/name:alfredapp.kubernetes.io/component:scaling-testtask:T210data:scaling_test.js:|//k6testscript—loadedfromConfigMap//Seeqa/Performance/scaling_test.jsforfullimplementationimporthttpfrom'k6/http';import{check}from'k6';import{Counter,Rate,Trend,Gauge}from'k6/metrics';constGATEWAY_URL=__ENV.GATEWAY_URL||'http://gateway-service:8080';constNODE_COUNT=parseInt(__ENV.NODE_COUNT||'1');constTARGET_RPS=parseInt(__ENV.TARGET_RPS||'500');constgatewayOverhead=newTrend('gateway_overhead_ms',true);constsuccessRate=newRate('success_rate');exportconstoptions={scenarios:{scaling_test:{executor:'constant-arrival-rate',rate:TARGET_RPS,timeUnit:'1s',duration:'2m',preAllocatedVUs:TARGET_RPS*2,maxVUs:TARGET_RPS*5,},},thresholds:{'http_req_duration':['p(95)<500'],'success_rate':['rate>0.95'],},};exportdefaultfunction(){constendpoints=[{method:'GET',url:`${GATEWAY_URL}/v1/models`,weight:0.3},{method:'GET',url:`${GATEWAY_URL}/healthz`,weight:0.2},{method:'POST',url:`${GATEWAY_URL}/v1/chat/completions`,weight:0.4,body:JSON.stringify({model:'gpt-4o',messages:[{role:'user',content:'test'}]})},{method:'GET',url:`${GATEWAY_URL}/v1/providers/health`,weight:0.1},];constrand=Math.random();letcumWeight=0;letendpoint=endpoints[0];for(constepofendpoints){cumWeight+=ep.weight;if(rand<cumWeight){endpoint=ep;break;}}constheaders={'Authorization':'Bearertest-key','Content-Type':'application/json'};conststart=Date.now();constres=endpoint.method==='POST'?http.post(endpoint.url,endpoint.body,{headers}):http.get(endpoint.url,{headers});gatewayOverhead.add(Date.now()-start);successRate.add(res.status>=200&&res.status<500);check(res,{'statusok':(r)=>r.status>=200&&r.status<500});}---#GatewayDeployment—replicacountsetpertestphaseapiVersion:apps/v1kind:Deploymentmetadata:name:gateway-scaling-testnamespace:alfred-perflabels:app.kubernetes.io/name:alfredapp.kubernetes.io/component:gatewaytask:T210spec:replicas:1#Overrideperphase:1,2,3selector:matchLabels:app.kubernetes.io/component:gatewaytemplate:metadata:labels:app.kubernetes.io/component:gatewayannotations:prometheus.io/scrape:"true"prometheus.io/port:"8080"prometheus.io/path:"/metrics"spec:containers:-name:gatewayimage:alfredai/gateway:latestports:-containerPort:8080name:httpenv:-name:ALFRED_ADDRvalue:":8080"-name:ALFRED_ENVvalue:"perf-test"-name:ALFRED_LOG_LEVELvalue:"warn"-name:REDIS_URLvalue:"redis://redis-service:6379"resources:requests:cpu:"500m"memory:"256Mi"limits:cpu:"1000m"memory:"512Mi"readinessProbe:httpGet:path:/readyport:8080initialDelaySeconds:5periodSeconds:5livenessProbe:httpGet:path:/healthzport:8080initialDelaySeconds:10periodSeconds:10topologySpreadConstraints:-maxSkew:1topologyKey:kubernetes.io/hostnamewhenUnsatisfiable:DoNotSchedulelabelSelector:matchLabels:app.kubernetes.io/component:gateway---#GatewayService—loadbalancesacrossallreplicasapiVersion:v1kind:Servicemetadata:name:gateway-servicenamespace:alfred-perflabels:app.kubernetes.io/name:alfredapp.kubernetes.io/component:gatewaytask:T210spec:type:ClusterIPselector:app.kubernetes.io/component:gatewayports:-port:8080targetPort:8080protocol:TCP---#k6Job—runsthescalingtestagainstthegatewayservice#DeployoneJobperphase:NODE_COUNT=1,then2,then3apiVersion:batch/v1kind:Jobmetadata:name:scaling-test-phase#Append-1,-2,-3perphasenamespace:alfred-perflabels:app.kubernetes.io/name:alfredapp.kubernetes.io/component:k6-runnertask:T210spec:backoffLimit:1ttlSecondsAfterFinished:3600template:spec:restartPolicy:Nevercontainers:-name:k6image:grafana/k6:latestcommand:["k6","run","/scripts/scaling_test.js"]env:-name:GATEWAY_URLvalue:"http://gateway-service:8080"-name:NODE_COUNTvalue:"1"#Overrideperphase-name:TARGET_RPSvalue:"500"-name:TEST_DURATIONvalue:"2m"volumeMounts:-name:test-scriptsmountPath:/scriptsvolumes:-name:test-scriptsconfigMap:name:scaling-test-config---#HorizontalPodAutoscaler—referenceforproductionauto-scaling#Notusedduringthemanualtestphases,butvalidatesHPAconfigapiVersion:autoscaling/v2kind:HorizontalPodAutoscalermetadata:name:gateway-hpanamespace:alfred-perflabels:app.kubernetes.io/name:alfredtask:T210spec:scaleTargetRef:apiVersion:apps/v1kind:Deploymentname:gateway-scaling-testminReplicas:1maxReplicas:10metrics:-type:Resourceresource:name:cputarget:type:UtilizationaverageUtilization:70-type:Resourceresource:name:memorytarget:type:UtilizationaverageUtilization:80behavior:scaleUp:stabilizationWindowSeconds:30policies:-type:Podsvalue:2periodSeconds:60scaleDown:stabilizationWindowSeconds:300policies:-type:Podsvalue:1periodSeconds:120