#!/usr/bin/envbash#set-euopipefailSCRIPT_DIR="$(cd"$(dirname"${BASH_SOURCE[0]}")"&&pwd)"COMPOSE_FILE="${SCRIPT_DIR}/docker-compose.scaling.yml"RESULTS_DIR="${SCRIPT_DIR}/../results"REPORT_FILE="${RESULTS_DIR}/scaling_report.json"#DefaultsTARGET_RPS="${TARGET_RPS:-300}"TEST_DURATION="${TEST_DURATION:-2m}"WARMUP_SECONDS="${WARMUP_SECONDS:-15}"MIN_EFFICIENCY="${MIN_EFFICIENCY:-70}"#ColorsRED='\033[0;31m'GREEN='\033[0;32m'YELLOW='\033[1;33m'BLUE='\033[0;34m'NC='\033[0m'#───Helpers──────────────────────────────────────────────────log(){echo-e"${BLUE}[SCALING]${NC}$*";}ok(){echo-e"${GREEN}[✓]${NC}$*";}warn(){echo-e"${YELLOW}[!]${NC}$*";}fail(){echo-e"${RED}[✗]${NC}$*";}usage(){cat<<EOF╔══════════════════════════════════════════════════════════════╗║Alfred—HorizontalScalingValidation(T210)║╚══════════════════════════════════════════════════════════════╝USAGE:$0[OPTIONS]OPTIONS:--rpsNUMTargetrequestspersecond(default:${TARGET_RPS})--durationSPECTestdurationperphase(default:${TEST_DURATION})--warmupSECWarmupwaitafterscaling(default:${WARMUP_SECONDS})--min-efficiencyNMinimumscalingefficiency%(default:${MIN_EFFICIENCY})--phaseNRunonlyphaseN(1,2,or3)--skip-buildSkipDockerimagebuildstep--helpShowthishelpENVIRONMENTVARIABLES:TARGET_RPSSameas--rpsTEST_DURATIONSameas--durationWARMUP_SECONDSSameas--warmupMIN_EFFICIENCYSameas--min-efficiencyEXAMPLES:$0#Full3-phasetest$0--rps500--duration3m#Higherload,longerduration$0--phase1#BaselineonlyWHATITDOES:1.Starts1gatewaynode→measuresthroughputbaseline2.Scalesto2nodes→measuresthroughput3.Scalesto3nodes→measuresthroughput4.Calculatesscalingefficiency:(T_N/(T_1×N))×1005.Failsifefficiencydropsbelow${MIN_EFFICIENCY}%OUTPUT:Resultswrittento:${RESULTS_DIR}/scaling_report.jsonPer-phaseresults:${RESULTS_DIR}/scaling_N_nodes.jsonEOFexit0}#───ParseArguments──────────────────────────────────────────PHASE_ONLY=""SKIP_BUILD=falsewhile[[$#-gt0]];docase"$1"in--rps)TARGET_RPS="$2";shift2;;--duration)TEST_DURATION="$2";shift2;;--warmup)WARMUP_SECONDS="$2";shift2;;--min-efficiency)MIN_EFFICIENCY="$2";shift2;;--phase)PHASE_ONLY="$2";shift2;;--skip-build)SKIP_BUILD=true;shift;;--help)usage;;*)fail"Unknownoption:$1";usage;;esacdone#───Prerequisites────────────────────────────────────────────check_prereqs(){localmissing=()command-vdocker>/dev/null2>&1||missing+=("docker")command-vdocker-compose>/dev/null2>&1||command-v"dockercompose">/dev/null2>&1||missing+=("docker-compose")command-vjq>/dev/null2>&1||missing+=("jq")if[[${#missing[@]}-gt0]];thenfail"Missingprerequisites:${missing[*]}"echo"Installwith:brewinstall${missing[*]}(macOS)"echo"aptinstall${missing[*]}(Ubuntu)"exit1fi}#Dockercomposecommand(v1vsv2)docker_compose(){ifcommand-v"docker-compose">/dev/null2>&1;thendocker-compose-f"${COMPOSE_FILE}""$@"elsedockercompose-f"${COMPOSE_FILE}""$@"fi}#───CoreFunctions───────────────────────────────────────────cleanup(){log"Cleaningupcontainers..."docker_composedown--remove-orphans--volumes2>/dev/null||true}build_images(){if[["${SKIP_BUILD}"=="true"]];thenlog"Skippingbuild(--skip-build)"returnfilog"Buildinggatewayimage..."docker_composebuildgateway}start_cluster(){localnodes=$1log"Startingclusterwith${nodes}gatewaynode(s)..."#Startinfrastructurefirstdocker_composeup-dredissleep3#ScalegatewaytoNreplicasdocker_composeup-d--scalegateway="${nodes}"gateway#Startloadbalancerdocker_composeup-dlb#Waitforallnodestobehealthylog"Waiting${WARMUP_SECONDS}sfor${nodes}node(s)towarmup..."sleep"${WARMUP_SECONDS}"#Verifyhealthlocalhealthy=0foriin$(seq110);doifcurl-sf"http://localhost:8080/healthz">/dev/null2>&1;thenhealthy=1breakfisleep2doneif[["${healthy}"-eq0]];thenfail"Clusterfailedtobecomehealthyafter${nodes}nodes"docker_composelogsgateway|tail-20exit1fiok"Clusterhealthywith${nodes}node(s)"}run_k6_test(){localnodes=$1log"Runningk6testagainst${nodes}node(s)(${TARGET_RPS}req/sfor${TEST_DURATION})..."docker_composerun--rm\-e"GATEWAY_URL=http://lb:8080"\-e"NODE_COUNT=${nodes}"\-e"TARGET_RPS=${TARGET_RPS}"\-e"TEST_DURATION=${TEST_DURATION}"\k6run/scripts/scaling_test.jsok"Phase${nodes}testcomplete"}run_phase(){localnodes=$1echo""echo"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"log"PHASE${nodes}:Testingwith${nodes}gatewaynode(s)"echo"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"start_cluster"${nodes}"run_k6_test"${nodes}"}#───Analysis─────────────────────────────────────────────────analyze_results(){log"Analyzingscalingresults..."echo""localresults=()localphases=(123)if[[-n"${PHASE_ONLY}"]];thenphases=("${PHASE_ONLY}")fifornin"${phases[@]}";dolocalfile="${RESULTS_DIR}/scaling_${n}_nodes.json"if[[-f"${file}"]];thenresults+=("${file}")elsewarn"Missingresultsfor${n}nodes:${file}"fidoneif[[${#results[@]}-lt1]];thenfail"Noresultstoanalyze"exit1fi#Generatecombinedreportlocalreport='{"test":"horizontal_scaling_validation","task":"T210"'report+=",\"target_rps\":${TARGET_RPS}"report+=",\"test_duration\":\"${TEST_DURATION}\""report+=",\"timestamp\":\"$(date-u+%Y-%m-%dT%H:%M:%SZ)\""report+=',"phases":['localbaseline_rps=0localfirst=trueforfilein"${results[@]}";dolocaldatadata=$(cat"${file}")localnodesnodes=$(echo"${data}"|jq-r'.node_count')localtotal_reqstotal_reqs=$(echo"${data}"|jq-r'.results.total_requests')localp95p95=$(echo"${data}"|jq-r'.results.p95_latency_ms')localsuccesssuccess=$(echo"${data}"|jq-r'.results.success_rate')#CalculateactualRPSfromtotalrequests/durationlocalduration_secsduration_secs=$(echo"${TEST_DURATION}"|sed's/m/*60/;s/s//'|bc2>/dev/null||echo"120")localactual_rpsactual_rps=$(echo"${total_reqs}/${duration_secs}"|bc2>/dev/null||echo"0")if[["${nodes}"=="1"]];thenbaseline_rps="${actual_rps}"fi#Calculateefficiencylocalefficiency=100if[["${baseline_rps}"-gt0&&"${nodes}"-gt1]];thenefficiency=$(echo"scale=1;(${actual_rps}*100)/(${baseline_rps}*${nodes})"|bc2>/dev/null||echo"0")fi${first}||report+=","first=falsereport+="{"report+="\"nodes\":${nodes}"report+=",\"total_requests\":${total_reqs}"report+=",\"actual_rps\":${actual_rps}"report+=",\"p95_latency_ms\":${p95}"report+=",\"success_rate\":${success}"report+=",\"scaling_efficiency_pct\":${efficiency}"report+="}"#Printphasesummarylocaleff_color="${GREEN}"if(($(echo"${efficiency}<${MIN_EFFICIENCY}"|bc-l2>/dev/null||echo0)));theneff_color="${RED}"fiecho"┌─Phase${nodes}:${nodes}node(s)"echo"│Requests:${total_reqs}"echo"│RPS:${actual_rps}"echo"│P95:${p95}ms"echo"│Success:${success}"echo-e"│Efficiency:${eff_color}${efficiency}%${NC}"echo"└──────────────────────────"donereport+="]"#Overallverdictlocalpass=trueif[[${#results[@]}-ge2]];then#Checkifthelastphasemeetsminimumefficiencylocallast_file="${results[-1]}"locallast_nodeslast_nodes=$(cat"${last_file}"|jq-r'.node_count')locallast_rpslast_rps=$(cat"${last_file}"|jq-r'.results.total_requests')localduration_secsduration_secs=$(echo"${TEST_DURATION}"|sed's/m/*60/;s/s//'|bc2>/dev/null||echo"120")localactual_last_rpsactual_last_rps=$(echo"${last_rps}/${duration_secs}"|bc2>/dev/null||echo"0")if[["${baseline_rps}"-gt0&&"${last_nodes}"-gt1]];thenlocalfinal_efffinal_eff=$(echo"scale=0;(${actual_last_rps}*100)/(${baseline_rps}*${last_nodes})"|bc2>/dev/null||echo"0")if[["${final_eff}"-lt"${MIN_EFFICIENCY}"]];thenpass=falsefififireport+=",\"verdict\":\"$(${pass}&&echo'PASS'||echo'FAIL')\""report+=",\"min_efficiency_required\":${MIN_EFFICIENCY}"report+="}"#Writereportmkdir-p"${RESULTS_DIR}"echo"${report}"|jq'.'>"${REPORT_FILE}"ok"Reportwrittento:${REPORT_FILE}"echo""if${pass};thenecho"═══════════════════════════════════════════════════════"ok"HORIZONTALSCALINGVALIDATION:PASSED"echo"═══════════════════════════════════════════════════════"elseecho"═══════════════════════════════════════════════════════"fail"HORIZONTALSCALINGVALIDATION:FAILED"fail"Scalingefficiencybelow${MIN_EFFICIENCY}%threshold"echo"═══════════════════════════════════════════════════════"exit1fi}#───Main─────────────────────────────────────────────────────main(){echo""echo"╔══════════════════════════════════════════════════════════╗"echo"║Alfred—HorizontalScalingValidation(T210)║"echo"║Target:${TARGET_RPS}req/s×${TEST_DURATION}perphase║"echo"║Min.ScalingEfficiency:${MIN_EFFICIENCY}%║"echo"╚══════════════════════════════════════════════════════════╝"echo""check_prereqsmkdir-p"${RESULTS_DIR}"#CleanupfromanypreviousruntrapcleanupEXITcleanup#Buildbuild_images#Runphasesif[[-n"${PHASE_ONLY}"]];thenrun_phase"${PHASE_ONLY}"elserun_phase1run_phase2run_phase3fi#Analyzeanalyze_results}main"$@"