import{textSummary}from'https://jslib.k6.io/k6-summary/0.0.2/index.js';import{check}from'k6';importhttpfrom'k6/http';import{Counter,Gauge,Rate,Trend}from'k6/metrics';//───Configuration───────────────────────────────────────────constGATEWAY_URL=__ENV.GATEWAY_URL||'http://localhost:8080';constNODE_COUNT=parseInt(__ENV.NODE_COUNT||'1');constTEST_DURATION=__ENV.TEST_DURATION||'2m';constTARGET_RPS=parseInt(__ENV.TARGET_RPS||'500');//───CustomMetrics──────────────────────────────────────────constgatewayOverhead=newTrend('gateway_overhead_ms',true);constsuccessRate=newRate('success_rate');consterrorCount=newCounter('error_count');constthroughput=newCounter('actual_throughput');constnodeCountGauge=newGauge('node_count');constscalingEfficiency=newGauge('scaling_efficiency_pct');//───TestOptions────────────────────────────────────────────exportconstoptions={scenarios:{//Constantarrivalrate—fixedloadregardlessofresponsetimescaling_test:{executor:'constant-arrival-rate',rate:TARGET_RPS,timeUnit:'1s',duration:TEST_DURATION,preAllocatedVUs:Math.max(50,TARGET_RPS*2),maxVUs:TARGET_RPS*5,},},thresholds:{//Baselinethresholds—appliestoallnodecounts'http_req_duration':['p(95)<500'],'success_rate':['rate>0.95'],'error_count':['count<100'],//Scaling-specific:P95shouldnotdegradewithmorenodes'gateway_overhead_ms':['p(95)<200'],},//Tagallmetricswithnodecountforcomparisontags:{nodes:`${NODE_COUNT}`,},};//───TestSetup──────────────────────────────────────────────exportfunctionsetup(){//VerifythegatewayishealthyconsthealthRes=http.get(`${GATEWAY_URL}/healthz`);check(healthRes,{'gatewayishealthy':(r)=>r.status===200,});console.log(`\n╔══════════════════════════════════════════╗`);console.log(`║HORIZONTALSCALINGTEST—${NODE_COUNT}NODE(S)║`);console.log(`║Target:${TARGET_RPS}req/sfor${TEST_DURATION}║`);console.log(`║Gateway:${GATEWAY_URL}║`);console.log(`╚══════════════════════════════════════════╝\n`);nodeCountGauge.add(NODE_COUNT);return{startTime:Date.now(),nodeCount:NODE_COUNT};}//───MainTestFunction──────────────────────────────────────exportdefaultfunction(data){consttestType=selectTestType();switch(testType){case'models':testModelsList();break;case'chat':testChatCompletion();break;case'health':testHealthCheck();break;case'providers':testProviderHealth();break;default:testModelsList();}}//───TestEndpoints──────────────────────────────────────────functiontestModelsList(){conststart=Date.now();constres=http.get(`${GATEWAY_URL}/v1/models`,{headers:{'Authorization':'Bearertest-scaling-key','Content-Type':'application/json',},tags:{endpoint:'models',nodes:`${NODE_COUNT}`},});recordMetrics(res,start);}functiontestChatCompletion(){constpayload=JSON.stringify({model:'gpt-4o',messages:[{role:'user',content:'Hello,thisisascalingtest.'},],max_tokens:50,});conststart=Date.now();constres=http.post(`${GATEWAY_URL}/v1/chat/completions`,payload,{headers:{'Authorization':'Bearertest-scaling-key','Content-Type':'application/json',},tags:{endpoint:'chat',nodes:`${NODE_COUNT}`},});recordMetrics(res,start);}functiontestHealthCheck(){conststart=Date.now();constres=http.get(`${GATEWAY_URL}/healthz`,{tags:{endpoint:'health',nodes:`${NODE_COUNT}`},});recordMetrics(res,start);}functiontestProviderHealth(){conststart=Date.now();constres=http.get(`${GATEWAY_URL}/v1/providers/health`,{headers:{'Authorization':'Bearertest-scaling-key',},tags:{endpoint:'provider_health',nodes:`${NODE_COUNT}`},});recordMetrics(res,start);}//───Helpers─────────────────────────────────────────────────functionselectTestType(){//Weighteddistribution:40%chat,30%models,20%health,10%providersconstrand=Math.random();if(rand<0.4)return'chat';if(rand<0.7)return'models';if(rand<0.9)return'health';return'providers';}functionrecordMetrics(res,startMs){constoverhead=Date.now()-startMs;gatewayOverhead.add(overhead);throughput.add(1);constsuccess=res.status>=200&&res.status<500;successRate.add(success);if(!success){errorCount.add(1);}check(res,{'statusisacceptable':(r)=>r.status>=200&&r.status<500,});}//───Teardown&Reporting────────────────────────────────────exportfunctionteardown(data){constduration=(Date.now()-data.startTime)/1000;console.log(`\n╔══════════════════════════════════════════╗`);console.log(`║TESTCOMPLETE—${data.nodeCount}NODE(S)║`);console.log(`║Duration:${duration.toFixed(1)}s║`);console.log(`╚══════════════════════════════════════════╝\n`);}exportfunctionhandleSummary(data){constmetrics=data.metrics;constnodeCount=NODE_COUNT;//Extractkeymetricsconstsummary={node_count:nodeCount,timestamp:newDate().toISOString(),target_rps:TARGET_RPS,results:{total_requests:metrics.http_reqs?metrics.http_reqs.values.count:0,actual_rps:metrics.http_reqs?(metrics.http_reqs.values.count/(parseFloat(TEST_DURATION)||120)).toFixed(2):0,p50_latency_ms:metrics.http_req_duration?metrics.http_req_duration.values['p(50)']:0,p95_latency_ms:metrics.http_req_duration?metrics.http_req_duration.values['p(95)']:0,p99_latency_ms:metrics.http_req_duration?metrics.http_req_duration.values['p(99)']:0,avg_latency_ms:metrics.http_req_duration?metrics.http_req_duration.values.avg:0,max_latency_ms:metrics.http_req_duration?metrics.http_req_duration.values.max:0,success_rate:metrics.success_rate?metrics.success_rate.values.rate:0,error_count:metrics.error_count?metrics.error_count.values.count:0,gateway_overhead_p95:metrics.gateway_overhead_ms?metrics.gateway_overhead_ms.values['p(95)']:0,},};//Calculatescalingefficiencyifpreviousresultsexist//Efficiency=(throughput_N/(throughput_1*N))*100//Perfectlinearscaling=100%constresultPath=`/results/scaling_${nodeCount}_nodes.json`;return{stdout:textSummary(data,{indent:'',enableColors:true}),[resultPath]:JSON.stringify(summary,null,2),};}