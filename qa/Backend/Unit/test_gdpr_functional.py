importjsonimportuuidfromdatetimeimportdatetime,timezonefromdecimalimportDecimalimportpytestfromfastapi.testclientimportTestClientfromsqlalchemyimporttextfromsqlmodelimportSessionfromapp.modelsimportRequestLog,User#───GDPRAuthTests─────────────────────────────────────────classTestGDPRFunctional:"""VerifyGDPRendpointsperformrealdatabaseoperations."""def_create_test_subject(self,session:Session)->User:"""Createadatasubjectwithassociateddataforerasuretesting."""fromapp.logicimportAuthManager_,key_hash=AuthManager.generate_api_key()subject=User(id=uuid.uuid4(),email="subject@example.com",name="TestSubject",api_key_hash=key_hash,is_admin=False,personal_quota=Decimal("500.00"),used_tokens=Decimal("50.00"),)session.add(subject)session.commit()session.refresh(subject)#Createrequestlogsforthisuserforiinrange(3):log=RequestLog(id=uuid.uuid4(),user_id=subject.id,model="gpt-4",provider="openai",prompt_tokens=100,completion_tokens=50,total_tokens=150,cost_credits=Decimal("0.005"),quota_source="personal",messages_json=json.dumps({"role":"user","content":f"Secretprompt{i}"}),response_content=f"Secretresponse{i}",)session.add(log)session.commit()returnsubjectdeftest_erasure_actually_erases_data(self,test_client:TestClient,admin_api_key,session:Session):"""Art.17:ErasureendpointmustactuallyeraseuserPIIandpromptcontent."""subject=self._create_test_subject(session)response=test_client.post("/gdpr/erasure",headers=admin_api_key,json={"subject_email":"subject@example.com","subject_id":str(subject.id),"reason":"Userrequesteddatadeletion","requester_email":"admin@example.com","include_audit_content":True,"include_cached_responses":False,"include_analytics":False,},)assertresponse.status_code==200data=response.json()assertdata["status"]in("completed","partial")assertdata["prompt_contents_erased"]>=3assertdata["verification_hash"]#non-emptyhash#Verifytheactualdatabasewasmodifiedsession.expire_all()#Checkuserprofileiserasederased_user=session.get(User,subject.id)asserterased_userisnotNone#shellpreservedforauditFKasserterased_user.name=="[ERASED]"assert"@deleted.alfred.local"inerased_user.emailasserterased_user.api_key_hash=="[ERASED]"#Checkrequestlogcontentiserased#SQLAlchemystoresUUIDsas32-charhex(nodashes)inSQLiteuid_hex=subject.id.hexlogs=session.exec(text("SELECTmessages_json,response_contentFROMrequest_logsWHEREuser_id=:uid"),params={"uid":uid_hex},).fetchall()assertlen(logs)>=3,f"Expected>=3erasedlogs,got{len(logs)}"forlog_rowinlogs:assertlog_row[0]=="[ERASED-GDPR]"assertlog_row[1]=="[ERASED-GDPR]"deftest_erasure_creates_audit_trail(self,test_client:TestClient,admin_api_key,session:Session):"""Art.17:Erasuremustcreateanimmutableauditlogentry."""subject=self._create_test_subject(session)response=test_client.post("/gdpr/erasure",headers=admin_api_key,json={"subject_email":"subject@example.com","subject_id":str(subject.id),"reason":"GDPRrequest","requester_email":"admin@example.com",},)assertresponse.status_code==200erasure_id=response.json()["erasure_id"]#Verifyauditlogentrywascreatedsession.expire_all()audit_entry=session.exec(text("SELECTaction,details_jsonFROMaudit_logs""WHEREaction='gdpr.erasure'ORDERBYsequence_numberDESCLIMIT1")).first()assertaudit_entryisnotNoneassertaudit_entry[0]=="gdpr.erasure"details=json.loads(audit_entry[1])assertdetails["erasure_id"]==erasure_idassertdetails["event_type"]=="GDPR_ERASURE"deftest_subject_access_returns_real_counts(self,test_client:TestClient,admin_api_key,session:Session):"""Art.15:SubjectaccessmustreturnactualrecordcountsfromDB."""subject=self._create_test_subject(session)response=test_client.post("/gdpr/subject-access",headers=admin_api_key,json={"subject_email":"subject@example.com","subject_id":str(subject.id),"requester_email":"admin@example.com",},)assertresponse.status_code==200data=response.json()assertdata["record_counts"]["user_profile"]==1assertdata["record_counts"]["request_logs"]>=3assertdata["record_counts"]["api_keys"]>=1deftest_portability_exports_real_data(self,test_client:TestClient,admin_api_key,session:Session):"""Art.20:Portabilitymustexportactualuserdata."""subject=self._create_test_subject(session)response=test_client.post("/gdpr/portability",headers=admin_api_key,json={"subject_email":"subject@example.com","subject_id":str(subject.id),"format":"json",},)assertresponse.status_code==200data=response.json()#Verifyprofiledataisrealassertdata["data"]["profile"]["email"]=="subject@example.com"assertdata["data"]["profile"]["name"]=="TestSubject"#Verifyrequesthistoryispopulatedassertlen(data["data"]["request_history"])>=3assertdata["data"]["request_history"][0]["model"]=="gpt-4"#Verifycostsummaryassertdata["data"]["cost_summary"]["total_requests"]>=3deftest_erasure_status_found(self,test_client:TestClient,admin_api_key,session:Session):"""StatusendpointshouldfindacompletederasurebyID."""subject=self._create_test_subject(session)#Performerasureresp=test_client.post("/gdpr/erasure",headers=admin_api_key,json={"subject_email":"subject@example.com","reason":"Test","requester_email":"admin@example.com",},)erasure_id=resp.json()["erasure_id"]#Checkstatusstatus_resp=test_client.get(f"/gdpr/status/{erasure_id}",headers=admin_api_key,)assertstatus_resp.status_code==200assertstatus_resp.json()["status"]=="completed"deftest_erasure_status_not_found(self,test_client:TestClient,admin_api_key):"""Statusendpointshouldreturnnot_foundforunknownerasureIDs."""fake_id=str(uuid.uuid4())response=test_client.get(f"/gdpr/status/{fake_id}",headers=admin_api_key,)assertresponse.status_code==200assertresponse.json()["status"]=="not_found"deftest_erasure_unknown_subject(self,test_client:TestClient,admin_api_key):"""Erasureofnon-existentusershouldcompletewithzerorecords."""response=test_client.post("/gdpr/erasure",headers=admin_api_key,json={"subject_email":"nonexistent@example.com","reason":"Test","requester_email":"admin@example.com","include_audit_content":True,"include_cached_responses":False,"include_analytics":False,},)assertresponse.status_code==200data=response.json()#Shouldcomplete(auditlogisstillwritten)butwithminimalrecordsassertdata["prompt_contents_erased"]==0