importuuidimportpytestfromfastapi.testclientimportTestClientfromsqlalchemyimporttextfromsqlmodelimportSessionfromapp.auditimport(GENESIS_HASH,AuditLogWriter,HashChainVerifier,compute_entry_hash,)#───compute_entry_hashdeterminism──────────────────────────classTestComputeEntryHash:"""VerifytheSHA-256hashcomputationisdeterministicandcorrect."""deftest_deterministic_same_inputs(self):"""Sameinputsalwaysproducethesamehash."""kwargs=dict(sequence_number=1,action="user.login",actor_user_id="abc-123",actor_type="user",target_type="session",target_id="sess-001",details_json='{"ip":"1.2.3.4"}',previous_hash=GENESIS_HASH,created_at="2025-01-01T00:00:00+00:00",)h1=compute_entry_hash(**kwargs)h2=compute_entry_hash(**kwargs)asserth1==h2assertlen(h1)==64#SHA-256hexdigestdeftest_different_action_produces_different_hash(self):"""Changingonefieldchangesthehash."""base=dict(sequence_number=1,action="user.login",actor_user_id=None,actor_type="user",target_type=None,target_id=None,details_json=None,previous_hash=GENESIS_HASH,created_at="2025-01-01T00:00:00+00:00",)h1=compute_entry_hash(**base)h2=compute_entry_hash(**{**base,"action":"user.logout"})asserth1!=h2deftest_different_sequence_number_produces_different_hash(self):base=dict(sequence_number=1,action="user.login",actor_user_id=None,actor_type="user",target_type=None,target_id=None,details_json=None,previous_hash=GENESIS_HASH,created_at="2025-01-01T00:00:00+00:00",)h1=compute_entry_hash(**base)h2=compute_entry_hash(**{**base,"sequence_number":2})asserth1!=h2deftest_different_previous_hash_produces_different_hash(self):"""Changingprevious_hashchangestheentryhash(chainproperty)."""base=dict(sequence_number=5,action="wallet.deduct",actor_user_id="user-1",actor_type="user",target_type="wallet",target_id="w-1",details_json='{"amount":10}',previous_hash=GENESIS_HASH,created_at="2025-06-01T12:00:00+00:00",)h1=compute_entry_hash(**base)h2=compute_entry_hash(**{**base,"previous_hash":"a"*64})asserth1!=h2deftest_none_fields_handled(self):"""Noneoptionalfieldsdon'tcrash;producevalidhash."""h=compute_entry_hash(sequence_number=1,action="system.startup",actor_user_id=None,actor_type="system",target_type=None,target_id=None,details_json=None,previous_hash=GENESIS_HASH,created_at="2025-01-01T00:00:00+00:00",)assertisinstance(h,str)assertlen(h)==64#───AuditLogWriterchaincorrectness────────────────────────classTestAuditLogWriter:"""Verifythewritercreatesproperlychainedhashentries."""deftest_first_entry_uses_genesis_hash(self,session:Session):"""Firstauditentry'sprevious_hashshouldbeGENESIS_HASH."""writer=AuditLogWriter(session)result=writer.log_sync(action="system.startup",actor_type="system")assertresult["sequence_number"]==1assertlen(result["entry_hash"])==64#ReadbackfromDBrow=session.exec(text("SELECTprevious_hash,entry_hashFROMaudit_logsWHEREsequence_number=1")).first()assertrowisnotNoneassertrow[0]==GENESIS_HASHdeftest_chain_continuation(self,session:Session):"""Secondentry'sprevious_hash==firstentry'sentry_hash."""writer=AuditLogWriter(session)r1=writer.log_sync(action="user.login",actor_type="user")r2=writer.log_sync(action="user.logout",actor_type="user")assertr2["sequence_number"]==2#Readbothentriesrows=session.exec(text("SELECTsequence_number,previous_hash,entry_hashFROMaudit_logsORDERBYsequence_number")).fetchall()assertlen(rows)==2assertrows[1][1]==rows[0][2]#entry2.previous_hash==entry1.entry_hashdeftest_five_entry_chain(self,session:Session):"""Fiveentriesformavalidchain:eachprev_hashlinkstopriorentry_hash."""writer=AuditLogWriter(session)actions=["system.startup","user.login","wallet.deduct","wallet.refund","user.logout",]foractioninactions:writer.log_sync(action=action,actor_type="user")rows=session.exec(text("SELECTsequence_number,previous_hash,entry_hashFROMaudit_logsORDERBYsequence_number")).fetchall()assertlen(rows)==5assertrows[0][1]==GENESIS_HASH#firstentrylinkstogenesisforiinrange(1,len(rows)):assertrows[i][1]==rows[i-1][2],(f"Chainbreakatseq{rows[i][0]}:"f"prev_hash={rows[i][1][:16]}...!=priorentry_hash={rows[i-1][2][:16]}...")deftest_details_stored_as_sorted_json(self,session:Session):"""DetailsdictisstoredasdeterministicsortedJSON."""writer=AuditLogWriter(session)writer.log_sync(action="wallet.deduct",actor_user_id=uuid.uuid4(),actor_type="user",target_type="wallet",target_id="w-123",details={"amount":10,"currency":"USD","action":"deduct"},)row=session.exec(text("SELECTdetails_jsonFROMaudit_logsWHEREsequence_number=1")).first()assertrowisnotNone#Keysshouldbesortedassert'"action":"deduct"'inrow[0]assert'"amount":10'inrow[0]assert'"currency":"USD"'inrow[0]deftest_log_sync_returns_correct_structure(self,session:Session):"""log_sync()returnsid,sequence_number,andentry_hash."""writer=AuditLogWriter(session)result=writer.log_sync(action="user.create",actor_type="system")assert"id"inresultassert"sequence_number"inresultassert"entry_hash"inresultassertresult["sequence_number"]==1#VerifytheidisavalidUUIDstringuuid.UUID(result["id"])deftest_ip_and_user_agent_stored(self,session:Session):"""IPaddressanduseragentmetadataarepersisted."""writer=AuditLogWriter(session)writer.log_sync(action="user.login",actor_type="user",ip_address="192.168.1.1",user_agent="Mozilla/5.0",)row=session.exec(text("SELECTip_address,user_agentFROMaudit_logsWHEREsequence_number=1")).first()assertrowisnotNoneassertrow[0]=="192.168.1.1"assertrow[1]=="Mozilla/5.0"#───HashChainVerifier───────────────────────────────────────classTestHashChainVerifier:"""Verifythechainverifierdetectsvalidchainsandtampering."""@pytest.mark.asyncioasyncdeftest_empty_chain_is_valid(self,session:Session):"""Emptyauditlogshouldverifyasvalidwithzeroentries."""verifier=HashChainVerifier(session)result=awaitverifier.verify()assertresult["valid"]isTrueassertresult["entries_checked"]==0assertresult["first_break_at"]isNoneassertresult["errors"]==[]assert"duration_ms"inresult@pytest.mark.asyncioasyncdeftest_single_entry_chain_valid(self,session:Session):"""Singleentrychain(genesis→entry1)shouldverify."""writer=AuditLogWriter(session)writer.log_sync(action="system.startup",actor_type="system")verifier=HashChainVerifier(session)result=awaitverifier.verify()assertresult["valid"]isTrueassertresult["entries_checked"]==1@pytest.mark.asyncioasyncdeftest_ten_entry_chain_valid(self,session:Session):"""Tencorrectlychainedentriesshouldverifyasvalid."""writer=AuditLogWriter(session)foriinrange(10):writer.log_sync(action=f"test.action_{i}",actor_type="user",target_type="test",target_id=f"target-{i}",)verifier=HashChainVerifier(session)result=awaitverifier.verify()assertresult["valid"]isTrueassertresult["entries_checked"]==10assertresult["errors"]==[]@pytest.mark.asyncioasyncdeftest_detects_tampered_entry_hash(self,session:Session):"""Modifyinganentry_hashshouldbedetected."""writer=AuditLogWriter(session)foriinrange(5):writer.log_sync(action=f"test.action_{i}",actor_type="user")#Tamper:overwriteentry_hashofseq3session.exec(text("UPDATEaudit_logsSETentry_hash=:fakeWHEREsequence_number=3"),params={"fake":"deadbeef"*8},)session.commit()verifier=HashChainVerifier(session)result=awaitverifier.verify()assertresult["valid"]isFalseassertresult["entries_checked"]==5assertlen(result["errors"])>=1#Thetamperedentry(seq3)shouldbeflaggedashashmismatchassertany("seq=3"ineforeinresult["errors"])@pytest.mark.asyncioasyncdeftest_detects_tampered_previous_hash(self,session:Session):"""Modifyingprevious_hashofanentrybreaksthechainlink."""writer=AuditLogWriter(session)foriinrange(5):writer.log_sync(action=f"test.action_{i}",actor_type="user")#Tamper:overwriteprevious_hashofseq4session.exec(text("UPDATEaudit_logsSETprevious_hash=:fakeWHEREsequence_number=4"),params={"fake":"abcd1234"*8},)session.commit()verifier=HashChainVerifier(session)result=awaitverifier.verify()assertresult["valid"]isFalse#Shoulddetectchainbreakatseq4assertresult["first_break_at"]==4assertany("seq=4"ineand"Chainbreak"ineforeinresult["errors"])@pytest.mark.asyncioasyncdeftest_detects_tampered_details(self,session:Session):"""Changingdetails_jsoninvalidatesthestoredhash."""writer=AuditLogWriter(session)writer.log_sync(action="wallet.deduct",actor_type="user",details={"amount":100},)writer.log_sync(action="user.logout",actor_type="user")#Tamper:changedetailsofseq1session.exec(text("UPDATEaudit_logsSETdetails_json=:fakeWHEREsequence_number=1"),params={"fake":'{"amount":999999}'},)session.commit()verifier=HashChainVerifier(session)result=awaitverifier.verify()assertresult["valid"]isFalseassertany("seq=1"ineand"Hashmismatch"ineforeinresult["errors"])@pytest.mark.asyncioasyncdeftest_detects_tampered_action(self,session:Session):"""Changingtheactionfieldinvalidatesthestoredhash."""writer=AuditLogWriter(session)writer.log_sync(action="wallet.deduct",actor_type="user")session.exec(text("UPDATEaudit_logsSETaction=:fakeWHEREsequence_number=1"),params={"fake":"wallet.topup"},)session.commit()verifier=HashChainVerifier(session)result=awaitverifier.verify()assertresult["valid"]isFalseassertresult["first_break_at"]==1@pytest.mark.asyncioasyncdeftest_cascade_detection(self,session:Session):"""Tamperingoneentrycascades:allsubsequententriesreportchainbreak."""writer=AuditLogWriter(session)foriinrange(5):writer.log_sync(action=f"action_{i}",actor_type="user")#Tamperentry_hashatseq2→seq3andbeyondshouldalsofailsession.exec(text("UPDATEaudit_logsSETentry_hash=:fakeWHEREsequence_number=2"),params={"fake":"ff"*32},)session.commit()verifier=HashChainVerifier(session)result=awaitverifier.verify()assertresult["valid"]isFalse#Seq2hashashmismatch,seq3haschainbreak(prev_hashdoesn'tmatch)assertlen(result["errors"])>=2assertresult["first_break_at"]==2@pytest.mark.asyncioasyncdeftest_verify_returns_duration_ms(self,session:Session):"""Verificationresultincludestiminginformation."""verifier=HashChainVerifier(session)result=awaitverifier.verify()assertisinstance(result["duration_ms"],(int,float))assertresult["duration_ms"]>=0@pytest.mark.asyncioasyncdeftest_batch_boundary(self,session:Session):"""Verificationworkscorrectlyacrossbatchboundaries(batch_size=3)."""writer=AuditLogWriter(session)foriinrange(7):writer.log_sync(action=f"action_{i}",actor_type="user")verifier=HashChainVerifier(session)result=awaitverifier.verify(batch_size=3)assertresult["valid"]isTrueassertresult["entries_checked"]==7#───AdminVerificationEndpoint─────────────────────────────classTestVerifyEndpoint:"""TestthePOST/v1/admin/audit-logs/verifyendpoint."""deftest_verify_requires_auth(self,test_client:TestClient):"""Unauthenticatedrequestsarerejected."""response=test_client.post("/v1/admin/audit-logs/verify")assertresponse.status_code==401deftest_verify_empty_log(self,test_client:TestClient,admin_api_key):"""Verifyreturnsvalidforanemptyauditlog."""response=test_client.post("/v1/admin/audit-logs/verify",headers=admin_api_key,)assertresponse.status_code==200data=response.json()assertdata["valid"]isTrueassertdata["entries_checked"]>=0assert"duration_ms"indatadeftest_verify_after_writes(self,test_client:TestClient,admin_api_key,session:Session):"""Verifyreturnsvalidafterwritingseveralauditentries."""writer=AuditLogWriter(session)foriinrange(5):writer.log_sync(action=f"test.action_{i}",actor_type="system")response=test_client.post("/v1/admin/audit-logs/verify",headers=admin_api_key,)assertresponse.status_code==200data=response.json()assertdata["valid"]isTrueassertdata["entries_checked"]>=5deftest_verify_detects_tamper_via_api(self,test_client:TestClient,admin_api_key,session:Session):"""Endpointcorrectlyreportstamperingdetectedbytheverifier."""writer=AuditLogWriter(session)foriinrange(3):writer.log_sync(action=f"test.action_{i}",actor_type="system")#Tampersession.exec(text("UPDATEaudit_logsSETentry_hash=:fakeWHEREsequence_number=2"),params={"fake":"00"*32},)session.commit()response=test_client.post("/v1/admin/audit-logs/verify",headers=admin_api_key,)assertresponse.status_code==200data=response.json()assertdata["valid"]isFalseassertlen(data["errors"])>=1#───Legacylog_audit()compatibility────────────────────────classTestLegacyLogAudit:"""Verifythelegacylog_audit()functionstillworkswiththehashchain."""deftest_legacy_creates_chained_entry(self,session:Session):"""log_audit()shouldproducehash-chainedentries."""fromapp.auditimportlog_auditlog_audit(session=session,actor_user_id=uuid.uuid4(),action="user.create",target_type="user",target_id="u-1",details={"name":"TestUser"},)row=session.exec(text("SELECTprevious_hash,entry_hashFROMaudit_logsWHEREsequence_number=1")).first()assertrowisnotNoneassertrow[0]==GENESIS_HASHassertlen(row[1])==64deftest_legacy_multiple_calls_chain(self,session:Session):"""Multiplelog_audit()callsformavalidchain."""fromapp.auditimportlog_auditforiinrange(3):log_audit(session=session,actor_user_id=uuid.uuid4(),action=f"user.action_{i}",)rows=session.exec(text("SELECTsequence_number,previous_hash,entry_hashFROMaudit_logsORDERBYsequence_number")).fetchall()assertlen(rows)==3assertrows[0][1]==GENESIS_HASHforiinrange(1,len(rows)):assertrows[i][1]==rows[i-1][2]