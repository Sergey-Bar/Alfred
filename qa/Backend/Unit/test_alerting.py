importasyncioimporttimeimportuuidfromunittest.mockimportAsyncMock,MagicMock,patchimportpytestfromstarlette.testclientimportTestClient#──Fixtures──def_create_user(session,email="admin@test.com",role="admin"):"""Createatestuserandreturn(user,raw_api_key)."""importuuidasuuid_modfromdecimalimportDecimalfromapp.logicimportAuthManagerfromapp.modelsimportUserraw_key,key_hash=AuthManager.generate_api_key()user=User(id=uuid_mod.uuid4(),email=email,name="TestUser",api_key_hash=key_hash,is_admin=(role=="admin"),personal_quota=Decimal("10000"),used_tokens=Decimal("0"),)session.add(user)session.commit()session.refresh(user)returnuser,raw_keydef_auth(raw_key:str):return{"Authorization":f"Bearer{raw_key}"}#═══════════════════════════════════════════════════════════#PART1:PagerDutyProviderUnitTests#═══════════════════════════════════════════════════════════classTestPagerDutyNotifier:"""TestsforthePagerDutynotificationprovider."""def_make_event(self,event_type=None,severity="error",user_id="user-123",**kwargs):fromapp.integrations.baseimportEventType,NotificationEventreturnNotificationEvent(event_type=event_typeorEventType.SYSTEM_ERROR,title="TestAlert",message="Somethingwentwrong",severity=severity,user_id=user_id,team_name="platform",data={"provider":"openai","wallet_id":"w-1"},**kwargs,)deftest_name(self):fromapp.integrations.pagerdutyimportPagerDutyNotifierpd=PagerDutyNotifier(routing_key="test-key")assertpd.name=="pagerduty"deftest_is_configured_true(self):fromapp.integrations.pagerdutyimportPagerDutyNotifierpd=PagerDutyNotifier(routing_key="routing-abc")assertpd.is_configuredisTruedeftest_is_configured_false(self):fromapp.integrations.pagerdutyimportPagerDutyNotifierpd=PagerDutyNotifier(routing_key="")assertpd.is_configuredisFalsedeftest_supports_incident_event_types(self):fromapp.integrations.baseimportEventTypefromapp.integrations.pagerdutyimportPagerDutyNotifierpd=PagerDutyNotifier(routing_key="key")assertpd.supports_event(EventType.SYSTEM_ERROR)isTrueassertpd.supports_event(EventType.HIGH_LATENCY)isTrueassertpd.supports_event(EventType.QUOTA_EXCEEDED)isTrue#Notindefaultincidenttypesassertpd.supports_event(EventType.QUOTA_WARNING)isFalseassertpd.supports_event(EventType.APPROVAL_REQUESTED)isFalsedeftest_dedup_key_deterministic(self):fromapp.integrations.pagerdutyimportPagerDutyNotifierevent=self._make_event()key1=PagerDutyNotifier._dedup_key(event)key2=PagerDutyNotifier._dedup_key(event)assertkey1==key2assert"system_error"inkey1assert"user:user-123"inkey1deftest_dedup_key_differs_by_user(self):fromapp.integrations.pagerdutyimportPagerDutyNotifiere1=self._make_event(user_id="user-a")e2=self._make_event(user_id="user-b")assertPagerDutyNotifier._dedup_key(e1)!=PagerDutyNotifier._dedup_key(e2)deftest_build_trigger_payload(self):fromapp.integrations.pagerdutyimportPagerDutyNotifierpd=PagerDutyNotifier(routing_key="rk-123",alerts_routing_key="rk-alerts")event=self._make_event(severity="error")payload=pd._build_payload(event,action="trigger")assertpayload["routing_key"]=="rk-123"assertpayload["event_action"]=="trigger"assertpayload["payload"]["severity"]=="error"assert"[Alfred]"inpayload["payload"]["summary"]assertpayload["payload"]["source"]=="alfred-platform"assertpayload["payload"]["custom_details"]["user_id"]=="user-123"deftest_build_trigger_payload_critical_uses_alerts_key(self):fromapp.integrations.pagerdutyimportPagerDutyNotifierpd=PagerDutyNotifier(routing_key="rk-normal",alerts_routing_key="rk-critical")event=self._make_event(severity="critical")payload=pd._build_payload(event,action="trigger")#Criticalseverity→alertsroutingkeyassertpayload["routing_key"]=="rk-critical"assertpayload["payload"]["severity"]=="critical"#Criticaleventsincludeimagesassert"images"inpayloaddeftest_build_resolve_payload_no_payload_field(self):fromapp.integrations.pagerdutyimportPagerDutyNotifierpd=PagerDutyNotifier(routing_key="rk-123")event=self._make_event()payload=pd._build_payload(event,action="resolve")assertpayload["event_action"]=="resolve"#Resolveeventsdon'tincludeapayloadfieldassert"payload"notinpayload@pytest.mark.asyncioasyncdeftest_send_success(self):fromapp.integrations.pagerdutyimportPagerDutyNotifierpd=PagerDutyNotifier(routing_key="rk-123")event=self._make_event()mock_response=MagicMock()mock_response.status_code=202mock_client=AsyncMock()mock_client.is_closed=Falsemock_client.post=AsyncMock(return_value=mock_response)pd._client=mock_clientresult=awaitpd.send(event)assertresultisTruemock_client.post.assert_called_once()@pytest.mark.asyncioasyncdeftest_send_failure_retries(self):fromapp.integrations.pagerdutyimportPagerDutyNotifierpd=PagerDutyNotifier(routing_key="rk-123",max_retries=2)event=self._make_event()mock_response=MagicMock()mock_response.status_code=500mock_response.text="InternalServerError"mock_client=AsyncMock()mock_client.is_closed=Falsemock_client.post=AsyncMock(return_value=mock_response)pd._client=mock_clientwithpatch("asyncio.sleep",new_callable=AsyncMock):result=awaitpd.send(event)assertresultisFalseassertmock_client.post.call_count==2#2retries@pytest.mark.asyncioasyncdeftest_send_not_configured(self):fromapp.integrations.pagerdutyimportPagerDutyNotifierpd=PagerDutyNotifier(routing_key="")event=self._make_event()result=awaitpd.send(event)assertresultisFalse@pytest.mark.asyncioasyncdeftest_resolve_action(self):fromapp.integrations.pagerdutyimportPagerDutyNotifierpd=PagerDutyNotifier(routing_key="rk-123")event=self._make_event()mock_response=MagicMock()mock_response.status_code=202mock_client=AsyncMock()mock_client.is_closed=Falsemock_client.post=AsyncMock(return_value=mock_response)pd._client=mock_clientresult=awaitpd.resolve(event)assertresultisTrue#Checkthepayloadsenthadaction=resolvecall_kwargs=mock_client.post.call_argsimportjsonsent_payload=json.loads(call_kwargs.kwargs.get("content",call_kwargs[1].get("content",b"{}")))assertsent_payload["event_action"]=="resolve"@pytest.mark.asyncioasyncdeftest_send_batch(self):fromapp.integrations.pagerdutyimportPagerDutyNotifierpd=PagerDutyNotifier(routing_key="rk-123")mock_response=MagicMock()mock_response.status_code=202mock_client=AsyncMock()mock_client.is_closed=Falsemock_client.post=AsyncMock(return_value=mock_response)pd._client=mock_clientevents=[self._make_event()for_inrange(3)]results=awaitpd.send_batch(events)assertlen(results)==3assertall(results.values())deftest_factory_returns_none_without_key(self):fromapp.integrations.pagerdutyimportcreate_pagerduty_notifierassertcreate_pagerduty_notifier(routing_key=None)isNoneassertcreate_pagerduty_notifier(routing_key="")isNonedeftest_factory_returns_notifier_with_key(self):fromapp.integrations.pagerdutyimportPagerDutyNotifier,create_pagerduty_notifiernotifier=create_pagerduty_notifier(routing_key="rk-live")assertisinstance(notifier,PagerDutyNotifier)assertnotifier.is_configured#═══════════════════════════════════════════════════════════#PART2:SLAMonitorUnitTests#═══════════════════════════════════════════════════════════classTestSlidingWindowMetric:"""TestsfortheSlidingWindowMetrichelper."""deftest_empty_metric(self):fromapp.monitoring.sla_monitorimportSlidingWindowMetricm=SlidingWindowMetric()assertm.count==0assertm.mean==0.0assertm.percentile(95)==0.0deftest_record_and_count(self):fromapp.monitoring.sla_monitorimportSlidingWindowMetricm=SlidingWindowMetric()foriinrange(10):m.record(float(i))assertm.count==10deftest_mean(self):fromapp.monitoring.sla_monitorimportSlidingWindowMetricm=SlidingWindowMetric()forvin[10.0,20.0,30.0]:m.record(v)assertm.mean==pytest.approx(20.0)deftest_percentile_95(self):fromapp.monitoring.sla_monitorimportSlidingWindowMetricm=SlidingWindowMetric()#Record100values:1,2,...,100foriinrange(1,101):m.record(float(i))p95=m.percentile(95)#95thpercentileof1-100shouldbe~95assert94<=p95<=96deftest_window_expiry(self):fromapp.monitoring.sla_monitorimportSlidingWindowMetricm=SlidingWindowMetric(window_seconds=60)#Recordwithaveryoldtimestampold_ts=time.time()-120#2minutesagom.record(100.0,timestamp=old_ts)#Shouldnotbeinthewindowassertm.count==0deftest_rate(self):fromapp.monitoring.sla_monitorimportSlidingWindowMetricm=SlidingWindowMetric()#3hits,7missesforiinrange(10):m.record(1.0ifi<3else0.0)rate=m.rate(lambdav:v>0)assertrate==pytest.approx(30.0)deftest_clear(self):fromapp.monitoring.sla_monitorimportSlidingWindowMetricm=SlidingWindowMetric()foriinrange(5):m.record(float(i))assertm.count==5m.clear()assertm.count==0classTestSLAMonitor:"""TestsfortheSLAMonitorthresholdchecking."""def_make_monitor(self,**threshold_overrides):fromapp.monitoring.sla_monitorimportSLAMonitor,SLAThresholdsthresholds=SLAThresholds(**threshold_overrides)returnSLAMonitor(thresholds=thresholds)deftest_record_latency(self):monitor=self._make_monitor()for_inrange(20):monitor.record_latency(50.0)assertmonitor.latency.count==20deftest_record_cache_result(self):monitor=self._make_monitor()monitor.record_cache_result(hit=True)monitor.record_cache_result(hit=False)assertmonitor.cache_hits.count==2deftest_record_provider_result(self):monitor=self._make_monitor()monitor.record_provider_result("openai",success=True)monitor.record_provider_result("openai",success=False)assertmonitor.provider_errors.count==2deftest_get_current_metrics(self):monitor=self._make_monitor()for_inrange(20):monitor.record_latency(100.0)monitor.record_cache_result(hit=True)metrics=monitor.get_current_metrics()assert"p95_latency_ms"inmetricsassert"cache_hit_rate_pct"inmetricsassertmetrics["sample_count"]==20@pytest.mark.asyncioasyncdeftest_no_breach_when_healthy(self):monitor=self._make_monitor(p95_latency_ms=150.0,min_samples=5,)#Allnormalfor_inrange(20):monitor.record_latency(50.0)breaches=awaitmonitor.check_thresholds()assertlen(breaches)==0@pytest.mark.asyncioasyncdeftest_p95_latency_breach(self):monitor=self._make_monitor(p95_latency_ms=100.0,min_samples=5,)#Mostlyfast,someslowfor_inrange(90):monitor.record_latency(50.0)for_inrange(10):monitor.record_latency(200.0)#ThesepushP95above100msbreaches=awaitmonitor.check_thresholds()latency_breaches=[bforbinbreachesif"P95"inb.title]assertlen(latency_breaches)>=1assertlatency_breaches[0].data["metric"]=="p95_latency_ms"@pytest.mark.asyncioasyncdeftest_cache_hit_rate_breach(self):monitor=self._make_monitor(cache_hit_rate_pct=30.0,min_samples=5,)#Enoughlatencysamplestopassmin_samplesfor_inrange(20):monitor.record_latency(10.0)#Only10%cachehitratefor_inrange(10):monitor.record_cache_result(hit=True)for_inrange(90):monitor.record_cache_result(hit=False)breaches=awaitmonitor.check_thresholds()cache_breaches=[bforbinbreachesif"Cache"inb.title]assertlen(cache_breaches)==1assertcache_breaches[0].severity=="warning"@pytest.mark.asyncioasyncdeftest_provider_error_rate_breach(self):monitor=self._make_monitor(provider_error_rate_pct=5.0,min_samples=5,)for_inrange(20):monitor.record_latency(10.0)#30%errorratefor_inrange(7):monitor.record_provider_result("openai",success=True)for_inrange(3):monitor.record_provider_result("openai",success=False)breaches=awaitmonitor.check_thresholds()error_breaches=[bforbinbreachesif"ErrorRate"inb.title]assertlen(error_breaches)==1@pytest.mark.asyncioasyncdeftest_failover_time_breach(self):monitor=self._make_monitor(failover_time_ms=500.0,min_samples=5,)for_inrange(20):monitor.record_latency(10.0)#Slowfailovermonitor.record_failover(800.0)breaches=awaitmonitor.check_thresholds()failover_breaches=[bforbinbreachesif"Failover"inb.title]assertlen(failover_breaches)==1assertfailover_breaches[0].data["metric"]=="failover_p95_ms"@pytest.mark.asyncioasyncdeftest_dedup_suppresses_repeated_breach(self):monitor=self._make_monitor(p95_latency_ms=100.0,min_samples=5,)#Generatebreachfor_inrange(20):monitor.record_latency(200.0)breaches1=awaitmonitor.check_thresholds()assertlen(breaches1)>=1#Samebreachcheckagain—shouldbesuppressedbydedupbreaches2=awaitmonitor.check_thresholds()#Alleventsshouldbededuplicatedassertlen(breaches2)==0@pytest.mark.asyncioasyncdeftest_insufficient_samples_no_breach(self):monitor=self._make_monitor(p95_latency_ms=100.0,min_samples=50,#Highthreshold)#Only10samples(belowmin_samples)for_inrange(10):monitor.record_latency(500.0)breaches=awaitmonitor.check_thresholds()assertlen(breaches)==0deftest_get_provider_error_rates(self):monitor=self._make_monitor()monitor.record_provider_result("openai",success=True)monitor.record_provider_result("openai",success=False)monitor.record_provider_result("anthropic",success=True)rates=monitor.get_provider_error_rates()assert"openai"inratesassert"anthropic"inratesassertrates["openai"]==pytest.approx(50.0)assertrates["anthropic"]==pytest.approx(0.0)deftest_reset(self):monitor=self._make_monitor()for_inrange(10):monitor.record_latency(100.0)monitor.reset()assertmonitor.latency.count==0deftest_dashboard_latency_tracking(self):monitor=self._make_monitor()monitor.record_latency(50.0,is_dashboard=True)monitor.record_latency(100.0,is_dashboard=False)#Bothgotomainlatencyassertmonitor.latency.count==2#Onlydashboardcallgoestodashboardmetricassertmonitor.dashboard_latency.count==1classTestSLAMonitorSingleton:"""TestsfortheglobalSLAmonitorsingleton."""deftest_get_returns_consistent_instance(self):fromapp.monitoring.sla_monitorimportget_sla_monitor,reset_sla_monitorreset_sla_monitor()m1=get_sla_monitor()m2=get_sla_monitor()assertm1ism2reset_sla_monitor()deftest_reset_clears_instance(self):fromapp.monitoring.sla_monitorimportget_sla_monitor,reset_sla_monitorm1=get_sla_monitor()reset_sla_monitor()m2=get_sla_monitor()assertm1isnotm2reset_sla_monitor()#═══════════════════════════════════════════════════════════#PART3:NotificationRouterAPITests#═══════════════════════════════════════════════════════════classTestSLAMetricsEndpoint:"""TestsforGET/v1/notifications/sla/metrics."""deftest_get_metrics_requires_admin(self,test_client,session):"""Non-adminuserscannotaccessSLAmetrics."""_,raw_key=_create_user(session,email="user@test.com",role="user")resp=test_client.get("/v1/notifications/sla/metrics",headers=_auth(raw_key))assertresp.status_codein(401,403)deftest_get_metrics_admin_ok(self,test_client,session):"""AdmincanfetchSLAmetricsnapshot."""fromapp.monitoring.sla_monitorimportreset_sla_monitorreset_sla_monitor()_,raw_key=_create_user(session,email="admin@test.com",role="admin")resp=test_client.get("/v1/notifications/sla/metrics",headers=_auth(raw_key))assertresp.status_code==200data=resp.json()assertdata["status"]=="ok"assert"metrics"indataassert"p95_latency_ms"indata["metrics"]reset_sla_monitor()classTestSLAThresholdsEndpoint:"""TestsforGET/v1/notifications/sla/thresholds."""deftest_get_thresholds_admin_ok(self,test_client,session):fromapp.monitoring.sla_monitorimportreset_sla_monitorreset_sla_monitor()_,raw_key=_create_user(session,email="admin@test.com",role="admin")resp=test_client.get("/v1/notifications/sla/thresholds",headers=_auth(raw_key))assertresp.status_code==200data=resp.json()assertdata["thresholds"]["p95_latency_ms"]==150.0assertdata["thresholds"]["cache_hit_rate_pct"]==30.0reset_sla_monitor()classTestSLACheckEndpoint:"""TestsforPOST/v1/notifications/sla/check."""deftest_check_no_breaches(self,test_client,session):"""Withdefault(empty)metrics,nobreachesdetected."""fromapp.monitoring.sla_monitorimportreset_sla_monitorreset_sla_monitor()_,raw_key=_create_user(session,email="admin@test.com",role="admin")resp=test_client.post("/v1/notifications/sla/check",headers=_auth(raw_key))assertresp.status_code==200data=resp.json()assertdata["breaches_detected"]==0reset_sla_monitor()classTestPagerDutyTestEndpoint:"""TestsforPOST/v1/notifications/alerts/test-pagerduty."""deftest_pagerduty_test_no_provider(self,test_client,session):"""WithoutPDconfigured,testendpointreportsnotconfigured."""_,raw_key=_create_user(session,email="admin@test.com",role="admin")resp=test_client.post("/v1/notifications/alerts/test-pagerduty",headers=_auth(raw_key),)assertresp.status_code==200data=resp.json()assertdata["pagerduty_configured"]isFalse#═══════════════════════════════════════════════════════════#PART4:AlertDeduplicatorTests#═══════════════════════════════════════════════════════════classTestAlertDeduplicator:"""Testsforthein-memoryalertdeduplication."""def_make_event(self,event_type_str="system_error",user_id="u1"):fromapp.integrations.baseimportEventType,NotificationEventreturnNotificationEvent(event_type=EventType(event_type_str),title="Test",message="Testmessage",user_id=user_id,severity="error",)@pytest.mark.asyncioasyncdeftest_first_event_not_duplicate(self):fromapp.integrations.escalationimportAlertDeduplicatordedup=AlertDeduplicator(default_window_seconds=60)event=self._make_event()assertawaitdedup.is_duplicate(event)isFalse@pytest.mark.asyncioasyncdeftest_same_event_is_duplicate(self):fromapp.integrations.escalationimportAlertDeduplicatordedup=AlertDeduplicator(default_window_seconds=60)event=self._make_event()awaitdedup.is_duplicate(event)#First:notduplicateassertawaitdedup.is_duplicate(event)isTrue@pytest.mark.asyncioasyncdeftest_different_users_not_duplicate(self):fromapp.integrations.escalationimportAlertDeduplicatordedup=AlertDeduplicator(default_window_seconds=60)e1=self._make_event(user_id="u1")e2=self._make_event(user_id="u2")assertawaitdedup.is_duplicate(e1)isFalseassertawaitdedup.is_duplicate(e2)isFalse@pytest.mark.asyncioasyncdeftest_clear_resets_dedup(self):fromapp.integrations.escalationimportAlertDeduplicatordedup=AlertDeduplicator(default_window_seconds=60)event=self._make_event()awaitdedup.is_duplicate(event)awaitdedup.clear(event)#Afterclear,sameeventisnolongerdeduplicatedassertawaitdedup.is_duplicate(event)isFalse@pytest.mark.asyncioasyncdeftest_expired_entries_cleaned(self):fromapp.integrations.escalationimportAlertDeduplicatordedup=AlertDeduplicator(default_window_seconds=1)event=self._make_event()awaitdedup.is_duplicate(event)#Manuallyexpiretheentryforkeyinlist(dedup._memory_store.keys()):dedup._memory_store[key]=time.time()-10#Shouldnolongerbeconsideredaduplicateassertawaitdedup.is_duplicate(event)isFalse#═══════════════════════════════════════════════════════════#PART5:EscalationLadderTests#═══════════════════════════════════════════════════════════classTestEscalationLadder:"""Testsfortheescalationleveldetermination."""def_make_event(self,severity="warning",data=None):fromapp.integrations.baseimportEventType,NotificationEventreturnNotificationEvent(event_type=EventType.QUOTA_WARNING,title="QuotaWarning",message="Test",severity=severity,data=dataor{},)deftest_determine_levels_by_threshold(self):fromapp.integrations.escalationimportEscalationLadder,EscalationLevelladder=EscalationLadder()event=self._make_event()levels=ladder.determine_levels(event,threshold_pct=85)assertEscalationLevel.TEAM_LEADinlevelsdeftest_determine_levels_critical_threshold(self):fromapp.integrations.escalationimportEscalationLadder,EscalationLevelladder=EscalationLadder()event=self._make_event()levels=ladder.determine_levels(event,threshold_pct=100)assertEscalationLevel.ALL_STAKEHOLDERSinlevelsdeftest_determine_levels_by_severity_no_threshold(self):fromapp.integrations.escalationimportEscalationLadder,EscalationLevelladder=EscalationLadder()#Non-thresholdevent(nothresholdorusage_pctindata)fromapp.integrations.baseimportEventType,NotificationEventevent=NotificationEvent(event_type=EventType.SYSTEM_ERROR,title="Error",message="Systemdown",severity="critical",)levels=ladder.determine_levels(event)assertEscalationLevel.ALL_STAKEHOLDERSinlevelsdeftest_get_targets_for_event(self):fromapp.integrations.escalationimport(EscalationLadder,EscalationLevel,EscalationTarget,)ladder=EscalationLadder()ladder.add_target(EscalationTarget(level=EscalationLevel.TEAM_LEAD,emails=["lead@test.com"],slack_channels=["#team-alerts"],))event=self._make_event()targets=ladder.get_targets_for_event(event,threshold_pct=85)assertlen(targets)>=1asserttargets[0].emails==["lead@test.com"]deftest_get_all_emails(self):fromapp.integrations.escalationimport(EscalationLadder,EscalationLevel,EscalationTarget,)ladder=EscalationLadder()ladder.add_target(EscalationTarget(level=EscalationLevel.TEAM_LEAD,emails=["a@test.com"],))ladder.add_target(EscalationTarget(level=EscalationLevel.FINOPS,emails=["b@test.com"],))event=self._make_event()emails=ladder.get_all_emails(event,threshold_pct=95)assert"a@test.com"inemailsor"b@test.com"inemails#═══════════════════════════════════════════════════════════#PART6:Integration—Manager+PagerDuty#═══════════════════════════════════════════════════════════classTestNotificationManagerWithPagerDuty:"""Integrationtests:NotificationManager+PagerDutyNotifier."""@pytest.mark.asyncioasyncdeftest_emit_routes_to_pagerduty(self):fromapp.integrations.baseimportEventType,NotificationEventfromapp.integrations.managerimportNotificationManagerfromapp.integrations.pagerdutyimportPagerDutyNotifiermanager=NotificationManager()pd=PagerDutyNotifier(routing_key="rk-test")#MockHTTPcallsmock_response=MagicMock()mock_response.status_code=202mock_client=AsyncMock()mock_client.is_closed=Falsemock_client.post=AsyncMock(return_value=mock_response)pd._client=mock_clientmanager.add_provider(pd)event=NotificationEvent(event_type=EventType.SYSTEM_ERROR,title="CriticalError",message="Providerdown",severity="critical",)results=awaitmanager.emit(event)assert"pagerduty"inresultsassertresults["pagerduty"].successisTrue@pytest.mark.asyncioasyncdeftest_pagerduty_skips_unsupported_events(self):fromapp.integrations.baseimportEventType,NotificationEventfromapp.integrations.managerimportNotificationManagerfromapp.integrations.pagerdutyimportPagerDutyNotifiermanager=NotificationManager()pd=PagerDutyNotifier(routing_key="rk-test")manager.add_provider(pd)#APPROVAL_REQUESTEDisnotindefaultincidenttypesevent=NotificationEvent(event_type=EventType.APPROVAL_REQUESTED,title="ApprovalRequest",message="needsapproval",severity="info",)results=awaitmanager.emit(event)#PDshouldnothaveattemptedtosendassert"pagerduty"notinresults@pytest.mark.asyncioasyncdeftest_setup_notifications_registers_pagerduty(self):fromapp.integrations.managerimport(NotificationManager,get_notification_manager,setup_notifications,)#Resetglobalmanagerimportapp.integrations.managerasmgr_modmgr_mod._notification_manager=Nonemanager=setup_notifications(pagerduty_routing_key="rk-live")pd_providers=[pforpinmanager.providersifp.name=="pagerduty"]assertlen(pd_providers)==1#Cleanupmgr_mod._notification_manager=None#───Part9:On-CallConfig&Escalation(T261)─────────────classTestOnCallConfig:"""Testsforon-callrotationconfigurationdataclassesandfactories."""deftest_build_default_config_has_two_schedules(self):fromapp.integrations.oncallimportbuild_default_oncall_configconfig=build_default_oncall_config()assertlen(config.schedules)==2assertconfig.schedules[0].name=="alfred-primary-oncall"assertconfig.schedules[1].name=="alfred-secondary-oncall"deftest_default_config_has_five_service_mappings(self):fromapp.integrations.oncallimportbuild_default_oncall_configconfig=build_default_oncall_config()assertlen(config.service_mappings)==5names=[m.service_nameforminconfig.service_mappings]assert"alfred-gateway"innamesassert"alfred-ledger"innamesassert"alfred-auth"innamesdeftest_default_escalation_timings(self):fromapp.integrations.oncallimportbuild_default_oncall_configconfig=build_default_oncall_config()assertconfig.escalation_timings.sev1_escalate_minutes==5assertconfig.escalation_timings.sev2_escalate_minutes==15assertconfig.escalation_timings.sev3_escalate_minutes==60assertconfig.escalation_timings.sev4_queueisTruedeftest_config_to_dict_structure(self):fromapp.integrations.oncallimportbuild_default_oncall_configconfig=build_default_oncall_config()d=config.to_dict()assertd["escalation_policy"]=="alfred-escalation"assertd["num_loops"]==2assertlen(d["schedules"])==2assertlen(d["service_mappings"])==5assert"sev1_escalate_minutes"ind["escalation_timings"]deftest_schedule_fields(self):fromapp.integrations.oncallimportbuild_default_oncall_config,OnCallTierconfig=build_default_oncall_config()primary=config.schedules[0]assertprimary.tier==OnCallTier.L1_PRIMARYassertprimary.rotation_type=="weekly"assertprimary.rotation_length_days==7assertprimary.handoff_overlap_minutes==15assertprimary.max_consecutive_weeks==2assertprimary.timezone=="UTC"deftest_service_mapping_alert_types(self):fromapp.integrations.oncallimportbuild_default_oncall_configfromapp.integrations.baseimportEventTypeconfig=build_default_oncall_config()gateway=next(mforminconfig.service_mappingsifm.service_name=="alfred-gateway")assertEventType.SYSTEM_ERRORingateway.alert_typesclassTestOnCallEscalationLadder:"""Testsforon-callescalationladderbuilder."""deftest_build_ladder_has_four_levels(self):fromapp.integrations.oncallimportbuild_oncall_escalation_ladderfromapp.integrations.escalationimportEscalationLevelladder=build_oncall_escalation_ladder()#Shouldhaveemptytargetsforall4levelsforlevelinEscalationLevel:assertladder.get_target(level)isnotNonedeftest_build_ladder_with_custom_targets(self):fromapp.integrations.oncallimport(build_oncall_escalation_ladder,OnCallTier,)fromapp.integrations.escalationimportEscalationLevel,EscalationTargettargets={OnCallTier.L1_PRIMARY:EscalationTarget(level=EscalationLevel.TEAM_LEAD,emails=["oncall@alfred.ai"],slack_channels=["#oncall"],)}ladder=build_oncall_escalation_ladder(targets=targets)t=ladder.get_target(EscalationLevel.TEAM_LEAD)asserttisnotNoneassert"oncall@alfred.ai"int.emailsassert"#oncall"int.slack_channelsdeftest_ladder_determines_levels_for_event(self):fromapp.integrations.oncallimportbuild_oncall_escalation_ladderfromapp.integrations.baseimportEventType,NotificationEventfromapp.integrations.escalationimportEscalationLevelladder=build_oncall_escalation_ladder()event=NotificationEvent(event_type=EventType.QUOTA_EXCEEDED,title="Quotaexceeded",message="100%used",severity="critical",data={"threshold":100},)levels=ladder.determine_levels(event)#100%shouldtriggerall4levelsassertEscalationLevel.TEAM_LEADinlevelsassertEscalationLevel.ALL_STAKEHOLDERSinlevelsclassTestOnCallSingleton:"""Testsforon-callconfigsingletonmanagement."""deftest_get_oncall_config_returns_default(self):fromapp.integrations.oncallimportget_oncall_config,reset_oncall_configreset_oncall_config()config=get_oncall_config()assertconfig.escalation_policy_name=="alfred-escalation"deftest_set_oncall_config(self):fromapp.integrations.oncallimport(get_oncall_config,set_oncall_config,reset_oncall_config,OnCallConfig,)reset_oncall_config()custom=OnCallConfig(escalation_policy_name="custom-policy",num_loops=5)set_oncall_config(custom)assertget_oncall_config().escalation_policy_name=="custom-policy"assertget_oncall_config().num_loops==5reset_oncall_config()deftest_reset_returns_to_default(self):fromapp.integrations.oncallimport(get_oncall_config,set_oncall_config,reset_oncall_config,OnCallConfig,)set_oncall_config(OnCallConfig(escalation_policy_name="temp"))reset_oncall_config()assertget_oncall_config().escalation_policy_name=="alfred-escalation"classTestOnCallApiEndpoints:"""Testsforon-callconfigAPIendpoints."""@pytest.fixture(autouse=True)def_reset_oncall(self):fromapp.integrations.oncallimportreset_oncall_configreset_oncall_config()yieldreset_oncall_config()deftest_oncall_config_requires_admin(self,test_client,session):_,raw_key=_create_user(session,email="user-oc@test.com",role="user")resp=test_client.get("/v1/notifications/oncall/config",headers=_auth(raw_key))assertresp.status_codein(401,403)deftest_oncall_config_admin_returns_schedules(self,test_client,session):_,raw_key=_create_user(session,email="admin-oc@test.com",role="admin")resp=test_client.get("/v1/notifications/oncall/config",headers=_auth(raw_key),)assertresp.status_code==200data=resp.json()assertdata["status"]=="ok"assertlen(data["oncall"]["schedules"])==2assertdata["oncall"]["escalation_policy"]=="alfred-escalation"deftest_oncall_escalation_returns_levels(self,test_client,session):_,raw_key=_create_user(session,email="admin-oc2@test.com",role="admin")resp=test_client.get("/v1/notifications/oncall/escalation",headers=_auth(raw_key),)assertresp.status_code==200data=resp.json()assertdata["status"]=="ok"assertdata["escalation_policy"]=="alfred-escalation"assert"timings"indataassertlen(data["levels"])==4