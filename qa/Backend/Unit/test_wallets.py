importuuidfromdecimalimportDecimalimportpytestfromfastapi.testclientimportTestClientclassTestWalletAuth:"""Verifyeverywalletendpointrejectsunauthenticatedrequests."""deftest_create_wallet_no_auth(self,test_client:TestClient):response=test_client.post("/v1/wallets",json={"name":"Test"})assertresponse.status_code==401deftest_list_wallets_no_auth(self,test_client:TestClient):response=test_client.get("/v1/wallets")assertresponse.status_code==401deftest_get_wallet_no_auth(self,test_client:TestClient):fake_id=str(uuid.uuid4())response=test_client.get(f"/v1/wallets/{fake_id}")assertresponse.status_code==401deftest_update_wallet_no_auth(self,test_client:TestClient):fake_id=str(uuid.uuid4())response=test_client.patch(f"/v1/wallets/{fake_id}",json={"name":"X"})assertresponse.status_code==401deftest_delete_wallet_no_auth(self,test_client:TestClient):fake_id=str(uuid.uuid4())response=test_client.delete(f"/v1/wallets/{fake_id}")assertresponse.status_code==401deftest_get_balance_no_auth(self,test_client:TestClient):fake_id=str(uuid.uuid4())response=test_client.get(f"/v1/wallets/{fake_id}/balance")assertresponse.status_code==401deftest_deduct_no_auth(self,test_client:TestClient):fake_id=str(uuid.uuid4())response=test_client.post(f"/v1/wallets/{fake_id}/deduct",json={"amount":10.00,"request_id":"req-1"},)assertresponse.status_code==401deftest_refund_no_auth(self,test_client:TestClient):fake_id=str(uuid.uuid4())response=test_client.post(f"/v1/wallets/{fake_id}/refund",json={"amount":5.00,"original_request_id":"req-1","idempotency_key":"rfnd-1"},)assertresponse.status_code==401deftest_topup_no_auth(self,test_client:TestClient):fake_id=str(uuid.uuid4())response=test_client.post(f"/v1/wallets/{fake_id}/topup",json={"amount":100.00},)assertresponse.status_code==401deftest_list_transactions_no_auth(self,test_client:TestClient):fake_id=str(uuid.uuid4())response=test_client.get(f"/v1/wallets/{fake_id}/transactions")assertresponse.status_code==401classTestWalletCRUD:"""Testwalletcreate,read,update,deleteflows."""deftest_create_wallet(self,test_client:TestClient,admin_api_key):response=test_client.post("/v1/wallets",json={"name":"EngineeringBudget","wallet_type":"team","hard_limit":5000.00,"soft_limit_percent":80.00,},headers=admin_api_key,)assertresponse.status_code==201,f"Got{response.status_code}:{response.text}"data=response.json()assertdata["name"]=="EngineeringBudget"assertdata["wallet_type"]=="team"assertfloat(data["hard_limit"])==5000.00assertdata["status"]=="active"assertfloat(data["balance_used"])==0assert"id"indatadeftest_list_wallets(self,test_client:TestClient,admin_api_key):#Createtwowalletstest_client.post("/v1/wallets",json={"name":"WalletA","hard_limit":1000.00},headers=admin_api_key,)test_client.post("/v1/wallets",json={"name":"WalletB","hard_limit":2000.00},headers=admin_api_key,)response=test_client.get("/v1/wallets",headers=admin_api_key)assertresponse.status_code==200data=response.json()assertlen(data)>=2names=[w["name"]forwindata]assert"WalletA"innamesassert"WalletB"innamesdeftest_get_wallet(self,test_client:TestClient,admin_api_key):create_resp=test_client.post("/v1/wallets",json={"name":"GetMe","hard_limit":3000.00},headers=admin_api_key,)wallet_id=create_resp.json()["id"]response=test_client.get(f"/v1/wallets/{wallet_id}",headers=admin_api_key)assertresponse.status_code==200assertresponse.json()["name"]=="GetMe"deftest_get_wallet_not_found(self,test_client:TestClient,admin_api_key):fake_id=str(uuid.uuid4())response=test_client.get(f"/v1/wallets/{fake_id}",headers=admin_api_key)assertresponse.status_code==404deftest_update_wallet(self,test_client:TestClient,admin_api_key):create_resp=test_client.post("/v1/wallets",json={"name":"OldName","hard_limit":1000.00},headers=admin_api_key,)wallet_id=create_resp.json()["id"]response=test_client.patch(f"/v1/wallets/{wallet_id}",json={"name":"NewName","hard_limit":5000.00},headers=admin_api_key,)assertresponse.status_code==200data=response.json()assertdata["name"]=="NewName"assertfloat(data["hard_limit"])==5000.00deftest_delete_wallet(self,test_client:TestClient,admin_api_key):create_resp=test_client.post("/v1/wallets",json={"name":"ToDelete"},headers=admin_api_key,)wallet_id=create_resp.json()["id"]response=test_client.delete(f"/v1/wallets/{wallet_id}",headers=admin_api_key)assertresponse.status_code==204#Verifysoft-deleted(status=closed)get_resp=test_client.get(f"/v1/wallets/{wallet_id}",headers=admin_api_key)assertget_resp.status_code==200assertget_resp.json()["status"]=="closed"classTestWalletBalance:"""Testbalanceendpointandcalculations."""deftest_get_balance_fresh_wallet(self,test_client:TestClient,admin_api_key):create_resp=test_client.post("/v1/wallets",json={"name":"BalanceTest","hard_limit":10000.00},headers=admin_api_key,)wallet_id=create_resp.json()["id"]response=test_client.get(f"/v1/wallets/{wallet_id}/balance",headers=admin_api_key)assertresponse.status_code==200data=response.json()assertfloat(data["hard_limit"])==10000.00assertfloat(data["balance_used"])==0assertfloat(data["balance_available"])==10000.00assertdata["soft_limit_reached"]isFalseassertdata["hard_limit_reached"]isFalseclassTestWalletDeduction:"""Testatomicdeduction(T052/T053)."""def_create_wallet(self,test_client,admin_api_key,hard_limit=10000.00):resp=test_client.post("/v1/wallets",json={"name":"DeductTest","hard_limit":hard_limit},headers=admin_api_key,)assertresp.status_code==201returnresp.json()["id"]deftest_deduct_success(self,test_client:TestClient,admin_api_key):wallet_id=self._create_wallet(test_client,admin_api_key)response=test_client.post(f"/v1/wallets/{wallet_id}/deduct",json={"amount":50.00,"request_id":"req-deduct-001","model":"gpt-4o","provider":"openai",},headers=admin_api_key,)assertresponse.status_code==200data=response.json()assertdata["status"]=="deducted"#Verifybalanceupdatedbalance_resp=test_client.get(f"/v1/wallets/{wallet_id}/balance",headers=admin_api_key)balance=balance_resp.json()assertfloat(balance["balance_used"])==50.00assertfloat(balance["balance_available"])==9950.00deftest_deduct_hard_limit_exceeded(self,test_client:TestClient,admin_api_key):wallet_id=self._create_wallet(test_client,admin_api_key,hard_limit=100.00)response=test_client.post(f"/v1/wallets/{wallet_id}/deduct",json={"amount":150.00,"request_id":"req-overlimit"},headers=admin_api_key,)assertresponse.status_code==402data=response.json()#Customexceptionhandlerserializesdictdetailintomessagestringmsg=data.get("message",str(data.get("detail","")))assert"hard_limit_exceeded"inmsgordata.get("code")=="hard_limit_exceeded"deftest_deduct_idempotency(self,test_client:TestClient,admin_api_key):wallet_id=self._create_wallet(test_client,admin_api_key)idempotency_key=f"idem-{uuid.uuid4().hex[:8]}"#Firstdeductionresp1=test_client.post(f"/v1/wallets/{wallet_id}/deduct",json={"amount":25.00,"request_id":"req-idem","idempotency_key":idempotency_key},headers=admin_api_key,)assertresp1.status_code==200#Seconddeductionwithsamekey—shouldbeidempotentresp2=test_client.post(f"/v1/wallets/{wallet_id}/deduct",json={"amount":25.00,"request_id":"req-idem-2","idempotency_key":idempotency_key},headers=admin_api_key,)assertresp2.status_code==200assertresp2.json()["status"]=="already_processed"#Verifyonlyonedeductionoccurredbalance_resp=test_client.get(f"/v1/wallets/{wallet_id}/balance",headers=admin_api_key)assertfloat(balance_resp.json()["balance_used"])==25.00deftest_deduct_closed_wallet(self,test_client:TestClient,admin_api_key):wallet_id=self._create_wallet(test_client,admin_api_key)#Closethewallettest_client.delete(f"/v1/wallets/{wallet_id}",headers=admin_api_key)response=test_client.post(f"/v1/wallets/{wallet_id}/deduct",json={"amount":10.00,"request_id":"req-closed"},headers=admin_api_key,)assertresponse.status_code==403deftest_deduct_not_found(self,test_client:TestClient,admin_api_key):fake_id=str(uuid.uuid4())response=test_client.post(f"/v1/wallets/{fake_id}/deduct",json={"amount":10.00,"request_id":"req-404"},headers=admin_api_key,)assertresponse.status_code==404classTestWalletRefund:"""Testidempotentrefund(T052)."""def_create_and_deduct(self,test_client,admin_api_key):resp=test_client.post("/v1/wallets",json={"name":"RefundTest","hard_limit":10000.00},headers=admin_api_key,)wallet_id=resp.json()["id"]test_client.post(f"/v1/wallets/{wallet_id}/deduct",json={"amount":100.00,"request_id":"req-to-refund"},headers=admin_api_key,)returnwallet_iddeftest_refund_success(self,test_client:TestClient,admin_api_key):wallet_id=self._create_and_deduct(test_client,admin_api_key)response=test_client.post(f"/v1/wallets/{wallet_id}/refund",json={"amount":50.00,"original_request_id":"req-to-refund","idempotency_key":f"rfnd-{uuid.uuid4().hex[:8]}",},headers=admin_api_key,)assertresponse.status_code==200data=response.json()assertdata["status"]=="refunded"#Balanceshouldbe100-50=50usedbalance=test_client.get(f"/v1/wallets/{wallet_id}/balance",headers=admin_api_key).json()assertfloat(balance["balance_used"])==50.00deftest_refund_idempotency(self,test_client:TestClient,admin_api_key):wallet_id=self._create_and_deduct(test_client,admin_api_key)idem_key=f"rfnd-idem-{uuid.uuid4().hex[:8]}"#Firstrefundresp1=test_client.post(f"/v1/wallets/{wallet_id}/refund",json={"amount":30.00,"original_request_id":"req-to-refund","idempotency_key":idem_key},headers=admin_api_key,)assertresp1.status_code==200#Secondrefundwithsamekeyresp2=test_client.post(f"/v1/wallets/{wallet_id}/refund",json={"amount":30.00,"original_request_id":"req-to-refund","idempotency_key":idem_key},headers=admin_api_key,)assertresp2.status_code==200assertresp2.json()["status"]=="already_processed"classTestWalletTopUp:"""Testcreditinjection(TopUp)."""deftest_topup_success(self,test_client:TestClient,admin_api_key):#Createwalletanddeductsomecreditscreate_resp=test_client.post("/v1/wallets",json={"name":"TopUpTest","hard_limit":1000.00},headers=admin_api_key,)wallet_id=create_resp.json()["id"]test_client.post(f"/v1/wallets/{wallet_id}/deduct",json={"amount":500.00,"request_id":"req-topup-deduct"},headers=admin_api_key,)#Topupresponse=test_client.post(f"/v1/wallets/{wallet_id}/topup",json={"amount":200.00,"description":"Monthlycreditinjection"},headers=admin_api_key,)assertresponse.status_code==200data=response.json()assertdata["status"]=="topped_up"#balance_usedshouldbe500-200=300balance=test_client.get(f"/v1/wallets/{wallet_id}/balance",headers=admin_api_key).json()assertfloat(balance["balance_used"])==300.00deftest_topup_does_not_go_negative(self,test_client:TestClient,admin_api_key):"""TopUpshouldnotmakebalance_usednegative(floorat0)."""create_resp=test_client.post("/v1/wallets",json={"name":"TopUpFloor","hard_limit":1000.00},headers=admin_api_key,)wallet_id=create_resp.json()["id"]#TopUpwithnopriorspend—balance_usedshouldremain0response=test_client.post(f"/v1/wallets/{wallet_id}/topup",json={"amount":500.00},headers=admin_api_key,)assertresponse.status_code==200balance=test_client.get(f"/v1/wallets/{wallet_id}/balance",headers=admin_api_key).json()assertfloat(balance["balance_used"])==0.00classTestWalletTransactions:"""Testtransactionlisting."""deftest_list_transactions(self,test_client:TestClient,admin_api_key):create_resp=test_client.post("/v1/wallets",json={"name":"TXTest","hard_limit":10000.00},headers=admin_api_key,)wallet_id=create_resp.json()["id"]#Generatesometransactionstest_client.post(f"/v1/wallets/{wallet_id}/deduct",json={"amount":10.00,"request_id":"tx-1"},headers=admin_api_key,)test_client.post(f"/v1/wallets/{wallet_id}/deduct",json={"amount":20.00,"request_id":"tx-2"},headers=admin_api_key,)response=test_client.get(f"/v1/wallets/{wallet_id}/transactions",headers=admin_api_key)assertresponse.status_code==200data=response.json()assertlen(data)>=2classTestWalletAdminRequired:"""Verifymutationendpointsrequireadminrole,notjustauth."""def_make_non_admin_key(self,test_client):"""Createanon-adminuserkeybyusingtheadminkeytocreateauser,thenusethatuser'skey."""#Thisreliesonadifferentapproach—wetesttheendpointbychecking#thatanon-admintokenisrejectedwith403.#Inthetestharness,admin_api_keyistheonlygeneratedkey.return{"Authorization":"Bearertp-fake-non-admin-key-that-wont-exist"}deftest_create_wallet_requires_admin(self,test_client:TestClient):"""Non-adminkeyshouldberejected(401sincekeydoesn'texist)."""headers=self._make_non_admin_key(test_client)response=test_client.post("/v1/wallets",json={"name":"Test"},headers=headers)assertresponse.status_codein(401,403)deftest_update_wallet_requires_admin(self,test_client:TestClient):headers=self._make_non_admin_key(test_client)fake_id=str(uuid.uuid4())response=test_client.patch(f"/v1/wallets/{fake_id}",json={"name":"X"},headers=headers)assertresponse.status_codein(401,403)deftest_delete_wallet_requires_admin(self,test_client:TestClient):headers=self._make_non_admin_key(test_client)fake_id=str(uuid.uuid4())response=test_client.delete(f"/v1/wallets/{fake_id}",headers=headers)assertresponse.status_codein(401,403)