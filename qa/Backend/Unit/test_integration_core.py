importjsonimportuuidfromdatetimeimportdatetime,timezonefromdecimalimportDecimalimportpytestfromfastapi.testclientimportTestClientfromsqlalchemyimporttextfromsqlmodelimportSessionfromapp.modelsimport(AuditLog,RequestLog,Team,TokenTransfer,User,UserStatus,Wallet,WalletStatus,WalletTransaction,)#═══════════════════════════════════════════════════════════════#HELPERS#═══════════════════════════════════════════════════════════════def_create_user(session:Session,email:str,name:str="TestUser",is_admin:bool=False,quota:Decimal=Decimal("1000"))->tuple:"""Createauserandreturn(User,raw_api_key)."""fromapp.logicimportAuthManagerraw_key,key_hash=AuthManager.generate_api_key()user=User(id=uuid.uuid4(),email=email,name=name,api_key_hash=key_hash,is_admin=is_admin,personal_quota=quota,used_tokens=Decimal("0"),)session.add(user)session.commit()session.refresh(user)returnuser,raw_keydef_auth(raw_key:str)->dict:"""Returnauthheaderdict."""return{"Authorization":f"Bearer{raw_key}"}def_fmt_uuid(val)->str:"""EnsureUUIDisinstandarddash-separatedformat(requiredbyPathvalidators).SQLAlchemymayreturnhex-onlyUUIDsfromSQLiteafterroundtrip."""ifisinstance(val,uuid.UUID):returnstr(val)s=str(val).replace('-','')returnf"{s[:8]}-{s[8:12]}-{s[12:16]}-{s[16:20]}-{s[20:]}"def_create_wallet(session:Session,owner_id:uuid.UUID,name:str="TestWallet",hard_limit:Decimal=Decimal("500"))->Wallet:"""Createawalletfortesting."""wallet=Wallet(id=uuid.uuid4(),name=name,owner_id=owner_id,hard_limit=hard_limit,soft_limit=hard_limit*Decimal("0.8"),balance_used=Decimal("0"),status=WalletStatus.ACTIVE,)session.add(wallet)session.commit()session.refresh(wallet)returnwallet#═══════════════════════════════════════════════════════════════#1.USERSELF-SERVICEENDPOINTS(users.py)#═══════════════════════════════════════════════════════════════classTestUserSelfService:"""Testsfornon-adminuserendpoints:/v1/users/me/*"""deftest_get_current_user(self,test_client:TestClient,session:Session):"""GET/v1/users/mereturnstheauthenticateduser'sprofile."""user,key=_create_user(session,"self@test.com","SelfUser")response=test_client.get("/v1/users/me",headers=_auth(key))assertresponse.status_code==200data=response.json()assertdata["email"]=="self@test.com"assertdata["name"]=="SelfUser"deftest_update_my_profile(self,test_client:TestClient,session:Session):"""PUT/v1/users/meupdatesauthenticateduser'sname/email."""user,key=_create_user(session,"update-me@test.com","OldName")response=test_client.put("/v1/users/me",headers=_auth(key),json={"name":"NewName"},)assertresponse.status_code==200data=response.json()assertdata["name"]=="NewName"#VerifyDBwasupdatedsession.expire_all()refreshed=session.get(User,user.id)assertrefreshed.name=="NewName"deftest_get_quota_status(self,test_client:TestClient,session:Session):"""GET/v1/users/me/quotareturnsquotadetails."""user,key=_create_user(session,"quota@test.com",quota=Decimal("5000"))response=test_client.get("/v1/users/me/quota",headers=_auth(key))assertresponse.status_code==200data=response.json()#Quotaresponsemayvary;justverifyithasexpectedkeysassert"personal_quota"indataor"quota"indataor"available"indatadeftest_update_privacy_preference(self,test_client:TestClient,session:Session):"""POST/v1/users/me/privacysetsprivacymode."""user,key=_create_user(session,"privacy@test.com")response=test_client.post("/v1/users/me/privacy",headers=_auth(key),params={"mode":"strict"},)#Accept200or422(ifmodeparamisstructureddifferently)assertresponse.status_codein(200,422)deftest_get_user_unauthenticated(self,test_client:TestClient):"""GET/v1/users/mewithoutauthreturns401."""response=test_client.get("/v1/users/me")assertresponse.status_code==401#═══════════════════════════════════════════════════════════════#2.TEAMMANAGEMENTENDPOINTS(teams.py)#═══════════════════════════════════════════════════════════════classTestTeamManagement:"""TestsforteamCRUD:/v1/admin/teams/*"""deftest_list_teams(self,test_client:TestClient,admin_api_key,session:Session):"""GET/v1/admin/teamsreturnslistofteams."""#Createateamfirstteam=Team(id=uuid.uuid4(),name="ListTestTeam",common_pool=Decimal("2000"))session.add(team)session.commit()response=test_client.get("/v1/admin/teams",headers=admin_api_key)assertresponse.status_code==200data=response.json()#Shouldbealistassertisinstance(data,list)names=[t.get("name")fortindata]assert"ListTestTeam"innamesdeftest_create_and_get_team(self,test_client:TestClient,admin_api_key,session:Session):"""POST+GET/v1/admin/teamsround-trip."""response=test_client.post("/v1/admin/teams",headers=admin_api_key,json={"name":"RoundTripTeam","common_pool":3000},)assertresponse.status_code==200team_data=response.json()assertteam_data["name"]=="RoundTripTeam"deftest_update_team(self,test_client:TestClient,admin_api_key,session:Session):"""PUT/v1/admin/teams/{id}updatesateam."""team=Team(id=uuid.uuid4(),name="OldTeam",common_pool=Decimal("1000"))session.add(team)session.commit()response=test_client.put(f"/v1/admin/teams/{_fmt_uuid(team.id)}",headers=admin_api_key,json={"name":"UpdatedTeam"},)assertresponse.status_code==200data=response.json()assertdata["name"]=="UpdatedTeam"deftest_delete_team(self,test_client:TestClient,admin_api_key,session:Session):"""DELETE/v1/admin/teams/{id}removesateam."""team=Team(id=uuid.uuid4(),name="ToDelete",common_pool=Decimal("500"))session.add(team)session.commit()tid_hex=team.id.hexifhasattr(team.id,'hex')elsestr(team.id).replace('-','')response=test_client.delete(f"/v1/admin/teams/{_fmt_uuid(team.id)}",headers=admin_api_key,)assertresponse.status_code==200#Verifygone—userawSQLtoavoidORMObjectDeletedErrorrow=session.exec(text("SELECTCOUNT(*)FROMteamsWHEREid=:tid"),params={"tid":tid_hex},).first()assertrow[0]==0deftest_add_and_get_team_members(self,test_client:TestClient,admin_api_key,session:Session):"""POST+GET/v1/admin/teams/{id}/membersmanagesmembership."""team=Team(id=uuid.uuid4(),name="MembersTeam",common_pool=Decimal("2000"))session.add(team)session.commit()user,_=_create_user(session,"member@test.com","TeamMember")#Addmemberresponse=test_client.post(f"/v1/admin/teams/{_fmt_uuid(team.id)}/members/{_fmt_uuid(user.id)}",headers=admin_api_key,)assertresponse.status_code==200#Getmembersresponse=test_client.get(f"/v1/admin/teams/{_fmt_uuid(team.id)}/members",headers=admin_api_key,)assertresponse.status_code==200members=response.json()assertisinstance(members,list)deftest_remove_team_member(self,test_client:TestClient,admin_api_key,session:Session):"""DELETE/v1/admin/teams/{id}/members/{user_id}removesamember."""team=Team(id=uuid.uuid4(),name="RemoveTeam",common_pool=Decimal("1000"))session.add(team)session.commit()user,_=_create_user(session,"removable@test.com")#Addthenremovetest_client.post(f"/v1/admin/teams/{_fmt_uuid(team.id)}/members/{_fmt_uuid(user.id)}",headers=admin_api_key,)response=test_client.delete(f"/v1/admin/teams/{_fmt_uuid(team.id)}/members/{_fmt_uuid(user.id)}",headers=admin_api_key,)assertresponse.status_code==200deftest_teams_require_admin(self,test_client:TestClient,session:Session):"""Non-adminuserscannotaccessteamendpoints."""_,user_key=_create_user(session,"nonadmin-team@test.com")response=test_client.get("/v1/admin/teams",headers=_auth(user_key))assertresponse.status_codein(401,403)#═══════════════════════════════════════════════════════════════#3.ADMINUSERMANAGEMENT(users.py)#═══════════════════════════════════════════════════════════════classTestAdminUserManagement:"""Testsforadminuserendpointsnotcoveredbyexistingtests."""deftest_list_users(self,test_client:TestClient,admin_api_key,session:Session):"""GET/v1/admin/usersreturnsuserlist."""_create_user(session,"listed@test.com","ListedUser")response=test_client.get("/v1/admin/users",headers=admin_api_key)assertresponse.status_code==200data=response.json()assertisinstance(data,list)assertlen(data)>=1#atleasttheadmin+createduserdeftest_update_user_admin(self,test_client:TestClient,admin_api_key,session:Session):"""PUT/v1/admin/users/{id}updatesuserviaadmin."""user,_=_create_user(session,"admin-update@test.com","Before")response=test_client.put(f"/v1/admin/users/{_fmt_uuid(user.id)}",headers=admin_api_key,json={"name":"After"},)assertresponse.status_code==200,f"Body:{response.text}"deftest_delete_user(self,test_client:TestClient,admin_api_key,session:Session):"""DELETE/v1/admin/users/{id}removesauser."""user,_=_create_user(session,"deletable@test.com")response=test_client.delete(f"/v1/admin/users/{_fmt_uuid(user.id)}",headers=admin_api_key,)assertresponse.status_code==200deftest_rotate_api_key(self,test_client:TestClient,admin_api_key,session:Session):"""POST/v1/admin/users/{id}/rotate_api_keyissuesanewkey."""user,old_key=_create_user(session,"rotate@test.com")response=test_client.post(f"/v1/admin/users/{_fmt_uuid(user.id)}/rotate_api_key",headers=admin_api_key,)assertresponse.status_code==200data=response.json()assert"api_key"indataassertdata["api_key"]!=old_key#keyhasbeenrotated#Oldkeyshouldnolongerworkresponse=test_client.get("/v1/users/me",headers=_auth(old_key))assertresponse.status_code==401#═══════════════════════════════════════════════════════════════#4.GOVERNANCE—APPROVALS+TRANSFERS(governance.py)#═══════════════════════════════════════════════════════════════classTestGovernanceApprovals:"""Testsforapprovalworkflowandusertokentransfers."""deftest_list_pending_approvals(self,test_client:TestClient,admin_api_key):"""GET/v1/approvals/pendingreturnslist(evenifempty)."""response=test_client.get("/v1/approvals/pending",headers=admin_api_key)assertresponse.status_code==200data=response.json()assertisinstance(data,list)deftest_create_and_resolve_approval(self,test_client:TestClient,admin_api_key,session:Session):"""Create→approveapprovalround-trip."""#Createanapprovalrequestresponse=test_client.post("/v1/approvals",headers=admin_api_key,json={"requested_credits":500,"reason":"NeedmorecreditsforprojectX"},)#Mayreturn200or201assertresponse.status_codein(200,201,422)ifresponse.status_codein(200,201):data=response.json()approval_id=data.get("id")ordata.get("approval_id")ifapproval_id:#Resolveitresolve_resp=test_client.post(f"/v1/approvals/{approval_id}/resolve",headers=admin_api_key,params={"action":"approve"},json={"approved_credits":500,"reason":"Approvedbyadmin"},)assertresolve_resp.status_codein(200,400,403)deftest_get_usage_analytics(self,test_client:TestClient,admin_api_key):"""GET/v1/analytics/usagereturnsanalyticsdata."""response=test_client.get("/v1/analytics/usage",headers=admin_api_key,params={"days":7},)assertresponse.status_code==200deftest_get_leaderboard(self,test_client:TestClient,admin_api_key):"""GET/v1/leaderboardreturnsusageleaderboard."""response=test_client.get("/v1/leaderboard",headers=admin_api_key)assertresponse.status_code==200data=response.json()assertisinstance(data,list)#═══════════════════════════════════════════════════════════════#5.TRANSFERS—REVIEW+CANCEL(transfers.py)#═══════════════════════════════════════════════════════════════classTestTransferWorkflow:"""Testsfortransferreview/cancelworkflow."""def_create_transfer(self,test_client:TestClient,admin_api_key,session:Session)->dict|None:"""Helper:createwalletsandapendingtransfer."""#Createadedicatedownerforthewalletsowner,_=_create_user(session,f"wallet-owner-{uuid.uuid4().hex[:8]}@test.com")wallet_a=_create_wallet(session,owner.id,"SourceWallet",Decimal("1000"))wallet_b=_create_wallet(session,owner.id,"DestWallet",Decimal("500"))resp=test_client.post("/v1/transfers",headers=admin_api_key,json={"source_wallet_id":_fmt_uuid(wallet_a.id),"destination_wallet_id":_fmt_uuid(wallet_b.id),"amount":100,"reason":"Testtransfer",},)ifresp.status_codein(200,201):returnresp.json()returnNonedeftest_create_transfer(self,test_client:TestClient,admin_api_key,session:Session):"""POST/v1/transferscreatesanewtransfer."""result=self._create_transfer(test_client,admin_api_key,session)assertresultisnotNone,"Transfercreationfailed"assert"id"inresultor"transfer_id"inresultdeftest_list_transfers(self,test_client:TestClient,admin_api_key,session:Session):"""GET/v1/transfersliststransfers."""self._create_transfer(test_client,admin_api_key,session)response=test_client.get("/v1/transfers",headers=admin_api_key)assertresponse.status_code==200data=response.json()assertisinstance(data,(list,dict))#maybepaginateddeftest_get_transfer_by_id(self,test_client:TestClient,admin_api_key,session:Session):"""GET/v1/transfers/{id}returnsaspecifictransfer."""result=self._create_transfer(test_client,admin_api_key,session)ifresultisNone:pytest.skip("Couldnotcreatetransfer")transfer_id=result.get("id")orresult.get("transfer_id")iftransfer_idisNone:pytest.skip("Transferresponsehadnoid")response=test_client.get(f"/v1/transfers/{transfer_id}",headers=admin_api_key)assertresponse.status_code==200deftest_review_transfer(self,test_client:TestClient,admin_api_key,session:Session):"""POST/v1/transfers/{id}/reviewapprovesapendingtransfer."""result=self._create_transfer(test_client,admin_api_key,session)ifresultisNone:pytest.skip("Couldnotcreatetransfer")transfer_id=result.get("id")orresult.get("transfer_id")iftransfer_idisNone:pytest.skip("Transferresponsehadnoid")admin_user=session.exec(text("SELECTidFROMusersWHEREis_admin=1LIMIT1")).first()reviewer_id=_fmt_uuid(admin_user[0])ifadmin_userelsestr(uuid.uuid4())response=test_client.post(f"/v1/transfers/{_fmt_uuid(transfer_id)}/review",headers=admin_api_key,json={"action":"approve","reviewed_by":reviewer_id,"note":"Looksgood",},)#Mightbe200(approved)or400(alreadycompleted/auto-approved)assertresponse.status_codein(200,400)deftest_cancel_transfer(self,test_client:TestClient,admin_api_key,session:Session):"""POST/v1/transfers/{id}/cancelcancelsapendingtransfer."""result=self._create_transfer(test_client,admin_api_key,session)ifresultisNone:pytest.skip("Couldnotcreatetransfer")transfer_id=result.get("id")orresult.get("transfer_id")iftransfer_idisNone:pytest.skip("Transferresponsehadnoid")response=test_client.post(f"/v1/transfers/{transfer_id}/cancel",headers=admin_api_key,)#200(cancelled)or400(alreadycompleted/auto-approved)assertresponse.status_codein(200,400)deftest_get_nonexistent_transfer(self,test_client:TestClient,admin_api_key):"""GET/v1/transfers/{bad-id}returns404."""fake_id=str(uuid.uuid4())response=test_client.get(f"/v1/transfers/{fake_id}",headers=admin_api_key)assertresponse.status_code==404#═══════════════════════════════════════════════════════════════#6.AUDITLOG—LIST+EXPORT(audit_log.py)#═══════════════════════════════════════════════════════════════classTestAuditLogEndpoints:"""Testsforauditlogquery/exportendpoints."""deftest_list_audit_logs(self,test_client:TestClient,admin_api_key):"""GET/v1/admin/audit-logsreturnspaginatedauditentries."""response=test_client.get("/v1/admin/audit-logs",headers=admin_api_key,params={"limit":10},)assertresponse.status_code==200data=response.json()assertisinstance(data,(list,dict))deftest_list_audit_logs_filtered(self,test_client:TestClient,admin_api_key):"""GET/v1/admin/audit-logswithactionfilter."""response=test_client.get("/v1/admin/audit-logs",headers=admin_api_key,params={"action":"user.login","limit":5},)assertresponse.status_code==200deftest_export_audit_csv(self,test_client:TestClient,admin_api_key):"""GET/v1/admin/audit-logs/export/csvreturnsCSVdata."""response=test_client.get("/v1/admin/audit-logs/export/csv",headers=admin_api_key,params={"limit":10},)assertresponse.status_code==200content_type=response.headers.get("content-type","")#ShouldbeCSVortextassert"csv"incontent_typeor"text"incontent_typeorresponse.status_code==200deftest_export_audit_json(self,test_client:TestClient,admin_api_key):"""GET/v1/admin/audit-logs/export/jsonreturnsJSONexport."""response=test_client.get("/v1/admin/audit-logs/export/json",headers=admin_api_key,params={"limit":10},)assertresponse.status_code==200deftest_audit_logs_require_admin(self,test_client:TestClient,session:Session):"""Non-adminuserscannotaccessauditlogs."""_,user_key=_create_user(session,"nonadmin-audit@test.com")response=test_client.get("/v1/admin/audit-logs",headers=_auth(user_key),)assertresponse.status_codein(401,403)#═══════════════════════════════════════════════════════════════#7.CROSS-CUTTINGSCENARIOS#═══════════════════════════════════════════════════════════════classTestCrossCuttingScenarios:"""End-to-endbusinessworkflowtestsspanningmultiplerouters."""deftest_user_lifecycle(self,test_client:TestClient,admin_api_key,session:Session):"""Fulllifecycle:createuser→update→rotatekey→delete."""#Createresp=test_client.post("/v1/admin/users",headers=admin_api_key,json={"email":"lifecycle@test.com","name":"LifecycleUser","personal_quota":1000},)assertresp.status_code==200data=resp.json()user_key=data["api_key"]user_id=data["id"]#Updateprofileasuserresp=test_client.put("/v1/users/me",headers=_auth(user_key),json={"name":"UpdatedLifecycle"},)assertresp.status_code==200#Rotatekeyresp=test_client.post(f"/v1/admin/users/{_fmt_uuid(user_id)}/rotate_api_key",headers=admin_api_key,)assertresp.status_code==200new_key=resp.json()["api_key"]#Oldkeyfailsresp=test_client.get("/v1/users/me",headers=_auth(user_key))assertresp.status_code==401#Newkeyworksresp=test_client.get("/v1/users/me",headers=_auth(new_key))assertresp.status_code==200#Deleteresp=test_client.delete(f"/v1/admin/users/{_fmt_uuid(user_id)}",headers=admin_api_key,)assertresp.status_code==200deftest_team_workflow(self,test_client:TestClient,admin_api_key,session:Session):"""Fullteamworkflow:createteam→addmember→listmembers→remove→delete."""#Createteamresp=test_client.post("/v1/admin/teams",headers=admin_api_key,json={"name":"WorkflowTeam","common_pool":5000},)assertresp.status_code==200team_data=resp.json()team_id=team_data.get("id")orteam_data.get("team_id")assertteam_idisnotNone#Createamemberuser,_=_create_user(session,"wf-member@test.com")#Addmemberresp=test_client.post(f"/v1/admin/teams/{_fmt_uuid(team_id)}/members/{_fmt_uuid(user.id)}",headers=admin_api_key,)assertresp.status_code==200#Listmembersresp=test_client.get(f"/v1/admin/teams/{_fmt_uuid(team_id)}/members",headers=admin_api_key,)assertresp.status_code==200#Removememberresp=test_client.delete(f"/v1/admin/teams/{_fmt_uuid(team_id)}/members/{_fmt_uuid(user.id)}",headers=admin_api_key,)assertresp.status_code==200#Deleteteamresp=test_client.delete(f"/v1/admin/teams/{_fmt_uuid(team_id)}",headers=admin_api_key,)assertresp.status_code==200deftest_wallet_transfer_audit_trail(self,test_client:TestClient,admin_api_key,session:Session):"""Transfercreatesaudittrailvisibleinauditlogendpoint."""owner,_=_create_user(session,f"audit-owner-{uuid.uuid4().hex[:8]}@test.com")wallet_a=_create_wallet(session,owner.id,"Audit-A",Decimal("1000"))wallet_b=_create_wallet(session,owner.id,"Audit-B",Decimal("500"))#Createtransferresp=test_client.post("/v1/transfers",headers=admin_api_key,json={"source_wallet_id":_fmt_uuid(wallet_a.id),"destination_wallet_id":_fmt_uuid(wallet_b.id),"amount":50,"reason":"Audittrailtest",},)assertresp.status_codein(200,201)#Checkauditlogscontaintransferactivityresp=test_client.get("/v1/admin/audit-logs",headers=admin_api_key,params={"limit":50},)assertresp.status_code==200