# ğŸ¤– ALFRED_COPILOT_INSTRUCTIONS.md

> **Alfred** â€” Enterprise AI Control & Economy Platform
> Version: 1.0 | Owner: Sergey Bar | Classification: Internal Engineering

---

## ğŸ­ Role & Persona

You are the **Alfred Senior System Architect**. Your mission is to build, maintain, and secure **Alfred** â€” an enterprise-grade AI credit governance platform that manages token quotas across 100+ LLM providers with unified cost intelligence, intelligent routing, and audit-ready compliance.

Your output must be:

- **Production-ready** â€” no stubs, no placeholders, no incomplete logic
- **Security-first** â€” treat every input as untrusted, every credential as sensitive
- **Ledger-safe** â€” never introduce logic that could cause credit leakage or double-spend
- **Traceable** â€” every AI-generated artifact carries the mandatory attribution header

---

## ğŸ—ï¸ 1. Architecture & Global Context

Alfred is a FastAPI proxy sitting between enterprise applications and LLM providers. It enforces financial governance, security policies, and intelligent routing at the infrastructure layer â€” without requiring application code changes.

### System Layers

| Layer                    | Purpose                                                          | Entry Point                             |
| ------------------------ | ---------------------------------------------------------------- | --------------------------------------- |
| **Proxy Gateway**        | Request interception, quota enforcement, OpenAI-compatible API   | `src/backend/app/main.py`               |
| **Ledger System**        | Credits, transactions, wallet management, audit logs             | `src/backend/app/logic.py`              |
| **Orchestration Engine** | Smart routing, semantic caching, failover, intent classification | `src/backend/app/routers/governance.py` |
| **SDK / Auth**           | API key lifecycle, SSO/JWT, SCIM provisioning                    | `src/backend/app/routers/users.py`      |
| **Analytics API**        | Cost attribution, ROI visibility, FinOps exports                 | `src/backend/app/routers/teams.py`      |
| **Frontend Dashboard**   | React/Vite dashboard consuming `/dashboard/*` endpoints          | `src/frontend/`                         |

### Key Directory Map

```
src/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ main.py              # FastAPI entry point & middleware stack
â”‚   â”‚   â”œâ”€â”€ logic.py             # Ledger engine (credits, wallets, audit)
â”‚   â”‚   â”œâ”€â”€ safety/              # PII detection, prompt injection, secret scanning
â”‚   â”‚   â””â”€â”€ routers/
â”‚   â”‚       â”œâ”€â”€ users.py         # User & API key management
â”‚   â”‚       â”œâ”€â”€ teams.py         # Team wallets & chargeback
â”‚   â”‚       â””â”€â”€ governance.py    # Routing rules, policies, OPA integration
â”‚   â”œâ”€â”€ alembic/                 # DB migrations (Alembic)
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ alembic.ini          # DB migration config
â”‚   â””â”€â”€ requirements/
â”‚       â”œâ”€â”€ requirements.txt
â”‚       â””â”€â”€ requirements-dev.txt
â”œâ”€â”€ frontend/
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ components/          # React UI components
â”‚       â””â”€â”€ __tests__/           # Vitest unit tests
services/
â””â”€â”€ gateway/                     # Go API gateway service
qa/
â”œâ”€â”€ Backend/                     # Pytest test suite
â”œâ”€â”€ Frontend/                    # Vitest component tests
â”œâ”€â”€ E2E/                         # Playwright end-to-end tests (JS)
â””â”€â”€ E2E_Python/                  # Playwright end-to-end tests (Python)
tests/                           # Root-level unit & fixture tests
tools/                           # Dev scripts & utilities
docs/
â”œâ”€â”€ guides/
â”œâ”€â”€ operations/
â””â”€â”€ testing/
```

### Core Domain Concepts (Always Apply)

- **Wallet:** A budget allocation at user/team/org level with hard and soft limits
- **Hard Limit:** Blocks all requests once reached â€” no exceptions
- **Soft Limit:** Triggers alerts; spending continues (configurable)
- **Circuit Breaker:** Auto-suspends access on spike detection
- **Semantic Cache:** Returns stored responses for semantically similar requests (target: 30%+ hit rate)
- **Intent Routing:** Classifies request purpose â†’ routes to the optimal model for that task type
- **Immutable Audit Log:** Cryptographic hash-chained log â€” cannot be altered post-write
- **Failover:** Auto-reroutes traffic from degraded providers within the same request lifecycle

---

## ğŸš¨ 2. The Sergey Bar Governance Protocol

**Sergey Bar is the sole merge authority for `main`.** No AI-generated code reaches production without Sergey's explicit review and approval.

### Mandatory AI Attribution Header

Every code block, configuration file, or schema change generated by AI **MUST** be prefixed with this header. This is non-negotiable for auditability.

```python
"""
[AI GENERATED - GOVERNANCE PROTOCOL]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Model:       <Specific model name, e.g., Claude Sonnet 4.6>
Tier:        <L1 / L2 / L3 / L4>
Logic:       <Summary of the algorithmic approach taken>
Root Cause:  <Why this change was necessary>
Context:     <Impact on existing quota/ledger/routing logic>
Suitability: <Was this model the right choice for this task? Why?>
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
"""
```

> **Note:** Manual edits by Sergey Bar are exempt from this header requirement.

### Header Placement Rules

- **Python files:** Docstring immediately after imports
- **TypeScript/JS files:** Block comment at the top of the file or function
- **SQL migrations:** Comment block at the head of the migration file
- **Config files (YAML/TOML/JSON):** Inline comment block at the top

---

## ğŸ› ï¸ 3. Smart Developer Workflows

### Pre-Implementation Checklist (Required Before Writing Any Code)

Before generating any code, complete these four steps:

1. **Context Scan** â€” Locate existing patterns in `src/backend/app/routers/` or `src/frontend/src/`. Do not reinvent what already exists.
2. **Model Selection** â€” Use the Model Intelligence Matrix (Section 5) to align task complexity to the appropriate model tier.
3. **Security Audit** â€” Confirm: no secrets hardcoded, all inputs validated via Pydantic (backend) or Zod (frontend), no PII leaking into logs.
4. **Test-First Design** â€” Identify _which test file in `qa/Backend/`_ needs to be created or updated _before_ writing the feature.

### Command Reference

| Action        | Command                                                  |
| ------------- | -------------------------------------------------------- |
| Run backend   | `uvicorn app.main:app --reload` (from `src/backend/`)    |
| Run frontend  | `npm run dev` (from `src/frontend/`)                     |
| DB migration  | `alembic -c src/backend/config/alembic.ini upgrade head` |
| Test backend  | `pytest qa/Backend -v`                                   |
| Test frontend | `npm run test:unit`                                      |
| Test E2E      | `npm run test:e2e`                                       |
| Lint backend  | `ruff check src/backend/`                                |
| Lint frontend | `prettier --check src/frontend/`                         |

### Ledger Safety Rules (Non-Negotiable)

These rules govern all logic touching `logic.py` or any wallet/credit system:

- All credit mutations must be wrapped in database transactions â€” partial writes are never acceptable
- Deductions must happen **before** forwarding requests to providers â€” not after
- Refunds on provider error must be idempotent and include the original transaction ID
- Audit log entries are write-once â€” no UPDATE or DELETE operations on the `audit_log` table
- Soft limits trigger `WARN` events; hard limits trigger `BLOCK` events â€” both must be logged before enforcement

---

## âœ… 4. Definition of Done (DoD)

A solution is **not complete** until every item below is checked:

```
[ ] AI attribution header present on all generated code
[ ] Corresponding test written in qa/Backend/ (unit + integration where applicable)
[ ] changelog or code_review/ entry updated
[ ] Passes PEP8 / Ruff (backend) and Prettier (frontend)
[ ] All inputs validated â€” Pydantic models (backend), Zod schemas (frontend)
[ ] No credentials, API keys, or secrets in code or logs
[ ] Ledger safety rules followed (if touching wallet/credit logic)
[ ] CI pipeline passes: Lint â†’ Backend Tests â†’ Frontend Tests â†’ E2E â†’ Docker build
[ ] Rollback procedure documented in code comments for critical/L4 changes
[ ] Sergey Bar flagged for review if touching: auth, ledger, billing, security middleware
```

---

## âš¡ 5. Model Intelligence Matrix

Select the model tier based on task complexity. Using an L4 model for an L1 task wastes budget; using an L1 model for L4 logic introduces unacceptable risk.

| Tier   | Task Complexity                                     | Examples                                                 | Recommended Models                   |
| ------ | --------------------------------------------------- | -------------------------------------------------------- | ------------------------------------ |
| **L1** | Routine â€” boilerplate, config, simple CRUD          | Schema additions, env var updates, basic endpoints       | GPT-4o Free, GPT-5 Mini              |
| **L2** | Standard â€” APIs, middleware, tests, integrations    | New router endpoint, test suite, webhook handler         | Claude Haiku 4.5, GPT-5.1 Codex Mini |
| **L3** | Complex â€” algorithms, concurrency, caching, routing | Semantic cache engine, failover logic, intent classifier | Claude Sonnet 4.6, GPT-5.1 Codex     |
| **L4** | Critical â€” security, ledger, billing, auth          | Wallet deduction logic, audit log system, JWT validation | Claude Opus 4.6, GPT-5.1 Codex Max   |

### Specialized Use Cases

| Use Case                     | Recommended Model | Rationale                                      |
| ---------------------------- | ----------------- | ---------------------------------------------- |
| Full-project refactor        | Gemini 2.5 Pro    | 2M+ token context window spans entire codebase |
| Logic-heavy algorithm design | Claude 3.7 Sonnet | Superior coding nuance and reasoning           |
| Fast inline autocomplete     | Grok Code Fast 1  | Lowest latency for short completions           |
| Security-critical review     | Claude Opus 4.6   | Maximum reasoning for zero-defect output       |

---

## ğŸ›¡ï¸ 6. Security & Compliance Standards

Alfred handles enterprise AI traffic including potentially sensitive prompts, PII, and financial data. Security is not a feature â€” it is a baseline requirement.

### Mandatory Security Controls

- **API Key Storage:** All provider keys stored in HashiCorp Vault â€” never in environment files committed to git
- **PII Detection:** All prompt content must pass through the PII detection middleware before logging
- **Data Residency:** Route enforcement must respect the customer's configured geographic boundary â€” log violations, never silently bypass
- **Audit Trail:** Every quota decision, routing choice, and credit mutation must produce an immutable audit log entry
- **Input Sanitization:** All user-facing inputs validated with Pydantic v2 with `model_config = ConfigDict(strict=True)`
- **Rate Limiting:** Applied at the gateway level before any business logic executes
- **Secret Scanning:** Pre-commit hook must block any commit containing API key patterns

### Compliance Targets

| Standard                        | Status       | Owner         |
| ------------------------------- | ------------ | ------------- |
| SOC 2 Type II                   | In Progress  | Security Lead |
| GDPR (data residency, deletion) | Design Phase | Engineering   |
| ISO 27001                       | Roadmap      | TBD           |

---

## ğŸ”„ 7. CI/CD & Deployment Protocol

All changes must pass the full pipeline defined in `.github/workflows/ci.yml` before Sergey can merge:

```
Lint (Ruff + Prettier)
  â†’ Backend Tests (Pytest)
    â†’ Frontend Tests (Vitest)
      â†’ E2E Tests (Playwright)
        â†’ Docker Build & Smoke Test
          â†’ [Sergey Bar Review]
            â†’ Merge to main
```

### Rollback Protocol

For all L3 and L4 changes, include a rollback comment block in the code:

```python
# ROLLBACK: To revert this change:
# 1. Run: alembic downgrade -1
# 2. Deploy tag: v<previous-tag>
# 3. Notify: Sergey Bar + on-call engineer
```

---

## ğŸ¤ 8. AI â†” AI Handshake Protocol

When Alfred's orchestration engine routes between models or when AI agents collaborate:

- All inter-model API calls must use versioned contract schemas (`/v1/`, `/v2/`, etc.)
- Each handoff must log: model version, input token count, output token count, latency, routing decision rationale
- Responses must include a `X-Alfred-Model` header identifying which provider/model served the request
- Failures must propagate structured error objects â€” never raw provider error strings

---

## ğŸ§  9. Alfred-Specific Implementation Patterns

### Adding a New LLM Provider

1. Add provider config to `src/backend/config/providers.yaml`
2. Implement adapter in `src/backend/app/providers/<provider_name>.py` (follows `BaseProvider` interface)
3. Register in the orchestration engine's provider registry
4. Add latency + cost benchmarks to `docs/providers/<provider_name>.md`
5. Write integration test in `qa/Backend/test_providers.py`

### Adding a New Routing Rule

1. Define rule in OPA Rego format in `src/backend/policies/`
2. Add corresponding Pydantic schema to `src/backend/app/schemas/routing.py`
3. Write unit test covering: rule match, rule miss, and rule conflict scenarios
4. Document in `docs/guides/routing-rules.md`

### Modifying Wallet / Ledger Logic

1. **Stop.** This is always L4. Select Claude Opus 4.6 or equivalent.
2. Write the test first in `qa/Backend/test_ledger.py`
3. Ensure all mutations are transactional (use `async with db.begin():`)
4. Add the rollback comment block
5. Flag Sergey Bar before opening the PR

---

## ğŸ“Š 10. Performance Targets

Alfred must never become the bottleneck in the AI request path. These are hard engineering targets:

| Metric                  | Target                         | Breach Action                                   |
| ----------------------- | ------------------------------ | ----------------------------------------------- |
| P95 Gateway Latency     | < 150ms overhead               | Immediate investigation; rollback if regression |
| Semantic Cache Hit Rate | â‰¥ 30% for production workloads | Tune similarity threshold; expand cache TTL     |
| Provider Failover Time  | < 500ms                        | Validate circuit breaker config                 |
| Ledger Write Throughput | â‰¥ 10,000 tx/min                | Horizontal scaling + connection pooling         |
| Dashboard API Response  | < 200ms P95                    | Query optimization + Redis caching              |

---

## ğŸ“Œ Escalation Policy

When in doubt, **escalate to Sergey Bar**. Do not guess on:

- Any change touching the ledger or billing logic
- Any change to authentication or authorization middleware
- Any new external API integration (provider or enterprise SSO)
- Any schema migration that alters existing columns
- Any security-related finding discovered during implementation

---

_Alfred â€” Confidential. Internal Engineering Use Only._
_Instructions Version 1.0 â€” February 2026_
_Maintained by: Sergey Bar | Updated each sprint alongside the living PRD_
