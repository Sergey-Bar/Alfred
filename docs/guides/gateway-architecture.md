#AlfredGateway—Architecture&APIReference>**Module:**`github.com/AlfredDev/alfred/services/gateway`>**Language:**Go1.21·**Framework:**chi/v5·**Logging:**zerolog>**Packages:**18·**Sourcefiles:**64·**Tests:**433>**Lastupdated:**2026-02-20---##TableofContents1.[Overview](#overview)2.[Architecture](#architecture)3.[QuickStart](#quick-start)4.[RequestLifecycle](#request-lifecycle)5.[Configuration](#configuration)6.[APIReference](#api-reference)7.[MiddlewareStack](#middleware-stack)8.[ProviderAdapters](#provider-adapters)9.[CachingEngine](#caching-engine)10.[RedisClient&CircuitBreaker](#redis-client--circuit-breaker)11.[Routing&PolicyEngine](#routing--policy-engine)12.[Observability](#observability)13.[Security](#security)14.[IntelligenceLayer](#intelligence-layer)15.[Performance](#performance)16.[Testing](#testing)17.[Deployment](#deployment)---##OverviewTheAlfredGatewayisahigh-performanceHTTPreverseproxythatsitsbetweenenterpriseapplicationsand11+LLMproviders.Itenforcesfinancialgovernance,securitypolicies,andintelligentroutingattheinfrastructurelevel—withoutrequiringapplicationcodechanges.**Keycapabilities:**-**OpenAI-compatibleAPI**—Drop-inreplacement;changebaseURL,keepyourcode-**11LLMproviders**—OpenAI,Anthropic,Gemini,Azure,Mistral,Together,Groq,Cohere,Bedrock,Ollama,vLLM-**Financialgovernance**—Tokenmetering,costestimation,walletreservations-**Intelligentrouting**—Priorityrules,geo-routing,SLAbalancing,A/Bexperiments-**Semanticcaching**—Cosinesimilaritymatching,per-namespaceisolation,TTLpermodel-**Circuitbreaker**—Redisgracefuldegradation,providerfailover-**Observability**—Prometheusmetrics,W3Ctracing,Datadog,Splunk,PagerDuty-**Security**—TLS1.3,APIkeyauth,OPApolicyengine,HashiCorpVault---##Architecture```┌─────────────────────────────────────────────────────────┐│AlfredGateway││││┌──────────┐┌──────────┐┌──────────┐┌────────┐│││CORS│→│Auth│→│Rate│→│Timeout││││││(API││Limit││││││││Key)││(Redis)│││││└──────────┘└──────────┘└──────────┘└────────┘││↓↓↓↓││┌──────────────────────────────────────────────────┐│││chi/v5Router││││/v1/chat/completions→ProxyHandler││││/v1/embeddings→ProxyHandler││││/v1/models→ProxyHandler││││/v1/providers/*→ProviderConfigHandler││││/v1/cache/*→CacheHandler││││/v1/analytics/*→AnalyticsHandler││││/healthz,/ready→Healthchecks││││/metrics→Prometheus│││└──────────────────────────────────────────────────┘││↓↓↓││┌──────────┐┌──────────┐┌──────────┐│││Routing││Caching││Metering││││Engine││Engine││+Cost││││(Rules,││(Cosine││Engine││││OPA,││Sim.)││││││Geo)│││││││└──────────┘└──────────┘└──────────┘││↓││┌──────────────────────────────────────────────────┐│││ProviderRegistry││││OpenAI·Anthropic·Gemini·Azure·Mistral││││Together·Groq·Cohere·Bedrock·Ollama││││vLLM│││└──────────────────────────────────────────────────┘││↓↓↓││┌──────────┐┌──────────┐┌──────────┐│││Analytics││Redis││Observ-││││Pipeline││(Circuit││ability││││(ClickHse)││Breaker)││(Prom,DD,││││││││Splunk,PD)│││└──────────┘└──────────┘└──────────┘│└─────────────────────────────────────────────────────────┘```###PackageMap|Package|Purpose|KeyTypes||---------|---------|-----------||`main`|Entrypoint,serverlifecycle,providerregistration|`main()`,`registerProviders()`||`config`|Environment-basedconfiguration|`Config`,`Load()`||`router`|chi/v5routeregistration+middlewarewiring|`NewRouter()`||`handler`|HTTPhandlersforallAPIendpoints|`ProxyHandler`,`ProviderConfigHandler`,`CacheHandler`,`AnalyticsHandler`||`provider`|LLMprovideradapters+registry|`Provider`interface,`Registry`,11implementations||`middleware`|Cross-cuttingHTTPmiddleware|`AuthMiddleware`,`RateLimiter`,`CORSMiddleware`,`TimeoutMiddleware`||`caching`|Semanticcachewithcosinesimilarity|`Engine`,`CacheEntry`,`CacheLookupResult`||`redisclient`|Redisclientwithcircuitbreaker|`Client`,`Health`,`CircuitConfig`||`streaming`|SSEstreamprocessing+bufferpooling|`MeteredStream`,`BufferPool`,`TokenEstimator`||`routing`|Rule-basedrouting+geo+experiments|`Engine`,`GeoRouter`,`ExperimentEngine`,`SLABalancer`||`policy`|OPApolicyevaluation|`OPAClient`,`PolicyDecision`||`metering`|Tokencounting+costcalculation+reservations|`CostEngine`,`StreamMeter`,`ReservationStore`||`analytics`|ClickHouse-backedeventpipeline|`Pipeline`,`RequestEvent`,`CostEvent`||`intelligence`|MLfeatures(classify,forecast,anomaly,arbitrage)|`Classifier`,`Forecaster`,`AnomalyDetector`,`ArbitrageEngine`||`observability`|Metrics+tracing+alertingintegrations|`Metrics`,`Tracer`,`DatadogExporter`,`SplunkForwarder`,`PagerDutyClient`||`security`|TLS,Vault,BYOKencryption|`TLSManager`,`VaultClient`||`profiling`|pprofserverwithauto-trigger|`ProfileServer`||`logger`|Structuredloggingsetup|`New()`|---##QuickStart###Prerequisites-Go1.21+-Redis(optional—gatewaydegradesgracefullywithoutit)###RunLocally```bashcdservices/gateway#SetminimumrequiredenvvarsexportOPENAI_API_KEY=sk-...exportGATEWAY_ADDR=:8080#Rungorunmain.go```###Verify```bash#Healthcheckcurlhttp://localhost:8080/healthz#→{"status":"ok","service":"alfred-gateway"}#Chatcompletion(OpenAI-compatible)curlhttp://localhost:8080/v1/chat/completions\-H"Authorization:Beareryour-api-key"\-H"Content-Type:application/json"\-d'{"model":"gpt-4o","messages":[{"role":"user","content":"Hello"}]}'#Listmodelscurlhttp://localhost:8080/v1/models\-H"Authorization:Beareryour-api-key"#OpenAPIspeccurlhttp://localhost:8080/openapi.json#SwaggerUIopenhttp://localhost:8080/docs```---##RequestLifecycleAtypical`/v1/chat/completions`requestflowsthrough:1.**CORS**→Allow/rejectbasedonoriginwhitelist2.**SecurityHeaders**→HSTS,X-Content-Type-Options,X-Frame-Options3.**RequestID**→GenerateUUID,set`X-Request-ID`header4.**Recovery**→Catchpanics,return500withrequestID5.**RequestLogging**→Logmethod,path,duration,status6.**Metrics**→Incrementcounters,observelatencyhistogram7.**Tracing**→Startspan,propagateW3Ctraceparent8.**BodySizeLimit**→Rejectrequestsexceeding`MaxBodyBytes`9.**RateLimiting**→Slidingwindowcheck(in-memoryorRedis)10.**Auth**→ExtractAPIkeyfrom`Authorization:Bearer`or`X-API-Key`11.**Timeout**→Per-providerorglobaltimeoutwith`X-Alfred-Timeout`override12.**ProxyHandler.ChatCompletions():**-Parserequestbody(pooledbuffer)-Detectproviderfrommodelname(ordereddeterministicmatching)-Checksemanticcache(cosinesimilarity)-Ifcachemiss:forwardtoprovider-Metertokens(input+output)-Calculatecost-Storeresponseincache-Writeanalyticsevent-Returnresponsewith`X-Alfred-Model`,`X-Alfred-Provider`,`X-Alfred-Cache`headers---##ConfigurationAllconfigurationisviaenvironmentvariables,loadedin`config.Load()`:|Variable|Default|Description||----------|---------|-------------||`GATEWAY_ADDR`|`:8080`|Listenaddress||`GATEWAY_ENV`|`development`|Environment(`development`/`production`)||`GRACEFUL_TIMEOUT`|`30`|Shutdowntimeoutinseconds||`DATABASE_URL`|—|PostgreSQLconnectionstring||`REDIS_URL`|—|Redisconnectionstring(optional)||`BACKEND_URL`|`http://localhost:8000`|BackendAPIURL||`API_KEY_HEADER`|`X-API-Key`|CustomAPIkeyheadername||`RATE_LIMIT_ENABLED`|`true`|Enableratelimiting||`RATE_LIMIT_RPM`|`60`|Requestsperminute||`RATE_LIMIT_BURST`|`10`|Burstallowance||`DEFAULT_TIMEOUT`|`30`|Defaultrequesttimeout(seconds)||`MAX_BODY_BYTES`|`10485760`|Maxrequestbodysize(10MB)||`DEFAULT_PROVIDER`|`openai`|Fallbackprovider||`LOG_LEVEL`|`debug`/`info`|Loglevel(debugindev,infoinprod)|###ProviderAPIKeys|Variable|Provider||----------|----------||`OPENAI_API_KEY`|OpenAI||`ANTHROPIC_API_KEY`|Anthropic||`GEMINI_API_KEY`|GoogleGemini||`AZURE_OPENAI_API_KEY`+`AZURE_OPENAI_ENDPOINT`+`AZURE_OPENAI_API_VERSION`|AzureOpenAI||`MISTRAL_API_KEY`|Mistral||`TOGETHER_API_KEY`|TogetherAI||`GROQ_API_KEY`|Groq||`COHERE_API_KEY`|Cohere||`AWS_ACCESS_KEY_ID`+`AWS_SECRET_ACCESS_KEY`+`AWS_REGION`|AWSBedrock||`OLLAMA_BASE_URL`|Ollama(local)||`VLLM_BASE_URL`+`VLLM_API_KEY`|vLLM(local/remote)|###Per-ProviderTimeoutsSet`PROVIDER_TIMEOUT_<NAME>`(e.g.,`PROVIDER_TIMEOUT_ANTHROPIC=60`)tooverridethedefaulttimeoutforspecificproviders.---##APIReference###CoreEndpoints(OpenAI-compatible)####`POST/v1/chat/completions`Createachatcompletion.FullycompatiblewiththeOpenAIAPIformat.**Headers:**-`Authorization:Bearer<api-key>`(required)-`Content-Type:application/json`(required)-`X-Alfred-Timeout:<seconds>`(optional—overridetimeout)**RequestBody:**```json{"model":"gpt-4o","messages":[{"role":"system","content":"Youareahelpfulassistant."},{"role":"user","content":"Hello!"}],"temperature":0.7,"max_tokens":1000,"stream":false,"tools":[]}```**Response:**```json{"id":"chatcmpl-...","object":"chat.completion","model":"gpt-4o","choices":[{"index":0,"message":{"role":"assistant","content":"Hello!"},"finish_reason":"stop"}],"usage":{"prompt_tokens":20,"completion_tokens":5,"total_tokens":25}}```**ResponseHeaders:**-`X-Alfred-Model`—Modelused-`X-Alfred-Provider`—Providerused-`X-Alfred-Cache`—`HIT`or`MISS`-`X-Request-ID`—Uniquerequestidentifier---####`POST/v1/embeddings`Generateembeddings.CompatiblewithOpenAIembeddingsAPI.**RequestBody:**```json{"model":"text-embedding-3-small","input":"Thequickbrownfox"}```---####`GET/v1/models`Listallavailablemodelsacrossallregisteredproviders.**Response:**```json{"object":"list","data":[{"id":"gpt-4o","object":"model","owned_by":"openai"},{"id":"claude-3-opus-20240229","object":"model","owned_by":"anthropic"}]}```---###ProviderManagement####`GET/v1/providers`Listallregisteredproviderswithhealthstatus.####`GET/v1/providers/{name}`Getproviderdetailsandconfiguration.####`GET/v1/providers/{name}/models`Listmodelsavailablefromaspecificprovider.####`POST/v1/providers/{name}/test`Testconnectivitytoaprovider.####`GET/v1/providers/pricing`Getpricinginformationforallproviders.####`POST/v1/providers/pricing/estimate`Estimatecostforarequestbeforesendingit.---###CacheManagement####`GET/v1/cache/stats`Getcachehit/missstatistics.####`POST/v1/cache/flush`Flushallcacheentries.####`POST/v1/cache/flush/{namespace}`Flushcacheentriesforaspecificnamespace.####`DELETE/v1/cache/{key}`Invalidateaspecificcacheentry.---###Analytics####`POST/v1/analytics/costs`Querycostdatawithfilters(timerange,provider,model,team).####`GET/v1/analytics/pipeline`Getanalyticspipelinestatistics.####`POST/v1/analytics/latency`Querylatencydata.####`GET/v1/analytics/cache`Getcacheanalytics.####`GET/v1/analytics/daily-costs`Getdailycostaggregation.####`GET/v1/analytics/export`ExportcostdataasCSV.---###Health&Operations####`GET/healthz`Livenessprobe.Alwaysreturns200iftheprocessisrunning.```json{"status":"ok","service":"alfred-gateway"}```####`GET/ready`Readinessprobe.Returns503ifRedisisconfiguredbutunhealthy.```json{"status":"ready"}//or{"status":"degraded","redis":"unhealthy"}```####`GET/health`Detailedhealthcheckincludingprovideranddependencystatus.####`GET/redis/health`DetailedRedishealthstatusincludingcircuitbreakerstate.```json{"connected":true,"circuit_state":"closed","consecutive_failures":0,"uptime_percentage":99.9,"degraded_mode":false}```####`GET/metrics`Prometheus-formatmetricsendpoint.####`GET/openapi.json`OpenAPI3.0specification.####`GET/docs`SwaggerUIforinteractiveAPIexploration.---##MiddlewareStackThemiddlewarechainexecutesinthisorder(outermostfirst):|Order|Middleware|Package|Purpose||-------|-----------|---------|---------||1|CORS|`middleware/cors.go`|Originwhitelist,preflighthandling||2|SecurityHeaders|`middleware/cors.go`|HSTS,XSSprotection,frameoptions||3|RequestID|`middleware/cors.go`|UUIDgeneration,`X-Request-ID`header||4|Recoverer|chibuilt-in|Panicrecovery→500||5|RequestLogger|zerolog|Method,path,status,duration||6|Metrics|`middleware/metrics.go`|Requestcount,latencyhistogram||7|Tracing|`observability/tracing.go`|W3Ctraceparentpropagation||8|BodySizeLimit|chibuilt-in|Rejectoversizedrequests||9|RateLimiter|`middleware/ratelimit.go`|SlidingwindowperAPIkey||10|Auth|`middleware/auth.go`|Bearertoken/X-API-Keyextraction||11|Timeout|`middleware/timeout.go`|Per-providerwithheaderoverride||12|Concurrency|`middleware/concurrency.go`|Semaphore,deduplication,keyedmutex|###CustomMiddlewareDetails**RateLimiter**—In-memoryslidingwindowwithconfigurableRPMandburst.Uses`sync.Map`forper-keytrackingwithperiodiccleanup.**Auth**—ExtractsAPIkeyfrom`Authorization:Bearer<key>`(minimum8characters)ortheconfiguredheader.Sets`APIKeyContextKey`and`UserIDContextKey`inrequestcontext.**Timeout**—Defaultfromconfig,per-provideroverridesvia`ProviderTimeouts`map,per-requestoverridevia`X-Alfred-Timeout`header.Usespooled`timeoutWriter`toavoidallocations.**Concurrency**—`Semaphore`limitsconcurrentrequests;`Deduplicator`identifiesduplicatein-flightrequestsvia`SHA-256(apiKey+model+contentHash)`;`KeyedMutex`providesper-keylocking.---##ProviderAdaptersAllprovidersimplementthe`Provider`interface:```gotypeProviderinterface{Name()stringChatCompletion(ctxcontext.Context,reqChatRequest)(*ChatResponse,error)ChatCompletionStream(ctxcontext.Context,reqChatRequest)(Stream,error)Embeddings(ctxcontext.Context,reqEmbeddingsRequest)(*EmbeddingsResponse,error)HealthCheck(ctxcontext.Context)errorModels(ctxcontext.Context)([]string,error)}```###ProviderMatrix|Provider|Chat|Stream|Embeddings|ToolCalling|Translation||----------|------|--------|------------|--------------|-------------||OpenAI|✅|✅|✅|✅|Native||Anthropic|✅|✅|❌|✅|Full(messagesformat)||Gemini|✅|✅|✅|✅|Full(generateContent)||AzureOpenAI|✅|✅|✅|✅|Native(deploymentURLs)||Mistral|✅|✅|✅|✅|OpenAI-compatible||Together|✅|✅|✅|✅|OpenAI-compatible||Groq|✅|✅|❌|✅|OpenAI-compatible||Cohere|✅|✅|✅|✅|Full(chat+embedformats)||Bedrock|✅|✅|✅|✅|Full(AnthropiconBedrock)||Ollama|✅|✅|✅|❌|OpenAI-compatible||vLLM|✅|✅|✅|❌|OpenAI-compatible|###Model→ProviderDetection`DetectProvider()`usesanorderedsliceofprefixmappings(deterministic,notmap-based):|Prefix|Provider||--------|----------||`gpt-`,`o1-`,`o3-`,`text-embedding`,`dall-e`|openai||`claude-`|anthropic||`gemini-`|gemini||`mistral-`,`codestral-`,`pixtral-`|mistral||`command-`|cohere||`llama-`,`meta-llama`|together||`mixtral-`|groq||`amazon.`,`anthropic.`(BedrockARNs)|bedrock|###ConnectionPoolingEachprovidergetsanHTTPclientvia`ConnectionPool`withconfigurable:-`MaxIdleConns`(default:100)-`MaxIdleConnsPerHost`(default:10)-`IdleConnTimeout`(default:90s)-`DialTimeout`(default:10s)---##CachingEngineSemanticcachein`caching/Engine`withtwolookupstrategies:1.**Exacthashmatch**—SHA-256ofnormalizedrequest→instantO(1)lookup2.**Cosinesimilarity**—Embeddingvectorscompared;configurablethreshold(default:0.92)###Features-**Per-namespaceisolation**—Separatecachespacesperteam/project-**TTLpermodel**—Differentexpiryforfastvs.expensivemodels-**Cachepoisoningprotection**—Validatesresponsestructurebeforestoring-**Maxentries**—LRUevictionwhencapacityexceeded(default:10,000)###CacheHeaders-`X-Alfred-Cache:HIT`—Responseservedfromcache-`X-Alfred-Cache:MISS`—Responsefromprovider,nowcached---##RedisClient&CircuitBreakerThe`redisclient.Client`providesaproduction-gradeRedisclientwithautomaticcircuitbreaking:###CircuitStates```┌──────────┐failurethreshold┌──────────┐│CLOSED│──────────────────────→│OPEN││(normal)││(reject)│└──────────┘└──────────┘↑││successinhalf-open│half-opentimeout│↓└────────────────────────────┌───────────┐│HALF-OPEN│failurereopens────────→│(probe)│└───────────┘```###Configuration|Parameter|Default|Description||-----------|---------|-------------||`FailureThreshold`|5|Consecutivefailuresbeforecircuitopens||`HalfOpenTimeout`|30s|Timebeforeprobingaftercircuitopens||`OperationTimeout`|2s|Per-operationdeadline||`ReconnectInterval`|5s|Initialreconnectbackoff||`MaxReconnectBackoff`|2m|Maximumreconnectbackoff|###GracefulDegradationWhenthecircuitisopen,all7operationsreturnzero-valuesinsteadoferrors:|Operation|DegradedReturn||-----------|----------------||`Get(key)`|`"",nil`||`Set(key,val,ttl)`|`nil`||`Del(key)`|`nil`||`Exists(key)`|`false,nil`||`SetNX(key,val,ttl)`|`false,nil`||`Incr(key)`|`0,nil`||`Expire(key,ttl)`|`nil`|ThismeansratelimitingbecomesineffectiveduringRedisoutages,butthegatewayneverfailsduetocachelayerproblems.---##Routing&PolicyEngine###Rule-BasedRoutingPriority-orderedrulesevaluatedvia`routing.Engine.Evaluate()`:```gotypeRulestruct{IDstringNamestringPriorityint//Lower=higherpriorityConditions[]Condition//Allmustmatch(ANDlogic)ActionRuleAction//Route,Block,Redirect,FallbackTargetstring//ProviderormodelnameEnabledbool}```**Conditionoperators:**`equals`,`not_equals`,`contains`,`starts_with`,`gt`,`lt`,`gte`,`lte`,`in`,`not_in`**Conditionfields:**`model`,`team`,`user`,`estimated_cost`,`time`,`provider`,`request_type`###Geo-RoutingGDPRdataresidencyenforcementviaIP→regionCIDRmapping:|Region|Code||--------|------||USEast|`us-east`||USWest|`us-west`||EUWest|`eu-west`||EUCentral|`eu-central`||AsiaPacificSE|`ap-se`||AsiaPacificNE|`ap-ne`||Global(norestriction)|`global`|###SLABalancerWeightedscoringforproviderselection:```score=weight×(latency×0.35+error_rate×0.30+availability×0.25+freshness×0.10)×(1-penalty)```UsesEWMA(ExponentiallyWeightedMovingAverage)forlatencytracking.###A/BExperimentsTrafficsplittingwithconsistenthashing(SHA-256):-Createexperimentwithvariantsandtrafficweights-Consistentassignmentvia`SHA-256(experimentID+requestKey)mod100`-z-testforstatisticalsignificanceonerrorratesandcosts-Auto-concludewhensignificancethresholdmet###OPAPolicyEngine8built-inRegopolicytemplates:1.Premiummodelgating(restrictexpensivemodels)2.Tokenlimitenforcement3.Businesshoursrestriction4.Dataclassificationrouting5.Per-userratelimiting6.Geographicrestriction7.PIImodelrestriction8.Budget-awarerouting---##Observability###PrometheusMetrics(`/metrics`)Customcollectorwithgateway-specificcounters,gauges,andhistograms:-`alfred_requests_total{method,path,status}`—Requestcounter-`alfred_request_duration_seconds{method,path}`—Latencyhistogram-`alfred_provider_requests_total{provider,model,status}`—Per-providerrequests-`alfred_tokens_total{provider,model,direction}`—Tokencounter(input/output)-`alfred_cache_hits_total`/`alfred_cache_misses_total`—Cacheeffectiveness-`alfred_wallet_operations_total{operation,status}`—Walletevents###W3CDistributedTracing-Propagates`traceparent`header(W3Cformat)-Configurablesamplerate-Spaneventsforkeylifecyclepoints(providercall,cachelookup,auth)###Integrations|Integration|Transport|Purpose||-------------|-----------|---------||Datadog|UDPDogStatsD|Metrics,APM,customevents||Splunk|HTTPSHEC(batch)|Logaggregation,securityevents||PagerDuty|HTTPSEventsAPI|Alerting(providerdown,walletexhausted,higherrorrate)|---##Security###TLS-**Minimumversion:**TLS1.3only-**Curves:**X25519,P-256-**Features:**Sessionticketrotation,certificatehot-reload,OCSPstapling###HashiCorpVault-ProviderAPIkeysstoredinVault(neverinenvironmentfilesinproduction)-BYOK(BringYourOwnKey)encryptionviaAES-GCM-MutualTLSforVaultcommunication-Keyrotationsupport###APIAuthentication-Bearertokenvia`Authorization`header-Customheadervia`X-API-Key`-Cachedvalidationforperformance(authmiddlewarecachesvalidkeys)---##IntelligenceLayerAI-poweredfeaturesinthe`intelligence`package:|Feature|Function|Description||---------|----------|-------------||IntentClassification|`Classifier.Classify(prompt)`|Categorizesrequestsinto9types(code,creative,analysis,etc.)||BudgetForecasting|`Forecaster.Forecast(history,budget)`|Predictsbudgetexhaustiondatewithconfidenceintervals||AnomalyDetection|`AnomalyDetector.Check(key,value)`|Z-scorebasedspike/driftdetection||FeatureCostAttribution|`FeatureTracker.Record(...)`|Trackcostperproductfeature||ROIScoring|`CalculateROI(input)`|ComputereturnonAIinvestment||CostArbitrage|`ArbitrageEngine.FindOpportunities(...)`|Real-timecheaper-providersuggestions||TrafficReplay|`TrafficRecorder.Simulate(...)`|What-ifanalysiswithrecordedtraffic|---##Performance###Targets|Metric|Target|How||--------|--------|-----||P95GatewayLatency|<100msoverhead|sync.Pool,zero-allochotpaths,typedstructs||SemanticCacheHitRate|≥30%|Cosinesimilarity+exacthash||ProviderFailover|<500ms|Circuitbreaker+SLAbalancer||ConcurrentRequests|10,000+|Semaphore+connectionpooling|###OptimizationsApplied-**sync.Poolbufferreuse**—`getBuf()`/`putBuf()`forallJSONencode/decode(handler/pools.go)-**Typedresponsestructs**—Replace`map[string]interface{}`withcompile-time-safestructs-**Zero-allocSSEparsing**—Byte-level`ExtractSSEContent()`withoutstringconversion-**Stack-allocatedhexbuffers**—Authmiddlewareuses`[64]byte`forSHA-256hexencoding-**Pooledhashers**—`sha256.New()`reusedviasync.Pool-**In-placealgorithms**—Orderedslicesinsteadofmapsforsmallcollections-**Connectionpooling**—Per-providerHTTPtransportreuse###Profilingpprofserveronport6060(bearertokenprotectedinproduction):```bash#CPUprofilecurlhttp://localhost:6060/debug/pprof/profile?seconds=30>cpu.profgotoolpprofcpu.prof#Heapprofilecurlhttp://localhost:6060/debug/pprof/heap>heap.profgotoolpprofheap.prof#Runtimestatscurlhttp://localhost:6060/debug/pprof/```Auto-trigger:whenP95latencyexceedstarget,CPUprofilingstartsautomatically.---##Testing###TestSuite:433Tests|Package|Tests|Coverage||---------|-------|----------||`handler`|~160|Auth,CORS,proxy,health,models,dry-run,provider-health,pipeline,SSEparse,metrics,Redishealth||`middleware`|~60|Ratelimit,timeout,concurrency,metrics,CORS||`provider`|~80|11providerconnectors,URLconstruction,headerinjection,modelmapping,errortranslation||`router`|~30|Integrationtests,fullrequestlifecycle,authflow,healthchecks||`redisclient`|29|Circuitbreakertransitions,gracefuldegradation(all7ops),concurrentaccess,healthreporting||`config`|~10|Environmentloading,defaults,providertimeouts||`streaming`|~20|Bufferpool,meteredstream,SSEcontentextraction||`caching`|~15|Cosinesimilarity,exactmatch,namespaceisolation,TTL||`other`|~30|Routing,metering,observability,intelligence|###RunTests```bashcdservices/gatewaygotest./...-v-count=1#Withracedetectorgotest./...-race#Withcoveragegotest./...-coverprofile=coverage.outgotoolcover-html=coverage.out#Specificpackagegotest./handler/...-vgotest./redisclient/...-v#Benchmarksgotest./handler/...-bench=.-benchmem```---##Deployment###Docker```dockerfileFROMgolang:1.21-alpineASbuilderWORKDIR/appCOPYgo.modgo.sum./RUNgomoddownloadCOPY..RUNCGO_ENABLED=0gobuild-ogateway.FROMalpine:3.19RUNapk--no-cacheaddca-certificatesCOPY--from=builder/app/gateway/gatewayEXPOSE8080ENTRYPOINT["/gateway"]```###DockerCompose```yamlservices:gateway:build:services/gatewayports:-"8080:8080"environment:-GATEWAY_ADDR=:8080-REDIS_URL=redis://redis:6379-OPENAI_API_KEY=${OPENAI_API_KEY}depends_on:-redisredis:image:redis:7-alpineports:-"6379:6379"```###Kubernetes```yamlapiVersion:apps/v1kind:Deploymentmetadata:name:alfred-gatewayspec:replicas:3selector:matchLabels:app:alfred-gatewaytemplate:spec:containers:-name:gatewayimage:alfred-gateway:latestports:-containerPort:8080readinessProbe:httpGet:path:/readyport:8080initialDelaySeconds:5livenessProbe:httpGet:path:/healthzport:8080initialDelaySeconds:10resources:requests:cpu:100mmemory:128Milimits:cpu:500mmemory:256Mi```###HorizontalScalingValidatedviak6toscalelinearlyupto8instanceswith<5%degradation.HPArecommended:```yamlapiVersion:autoscaling/v2kind:HorizontalPodAutoscalerspec:minReplicas:2maxReplicas:16metrics:-type:Resourceresource:name:cputarget:type:UtilizationaverageUtilization:70```---##GracefulShutdownThegatewayhandles`SIGINT`/`SIGTERM`withorderedcleanup:1.Stopacceptingnewconnections2.CloseRedisclient(stopsreconnectgoroutine)3.Drainin-flightrequests(configurabletimeout,default30s)4.Flushanalyticspipeline5.Stopprofilingserver6.Exit---_AlfredGatewayDocumentation—v1.0__Generated:2026-02-20__Maintainer:EngineeringTeam_