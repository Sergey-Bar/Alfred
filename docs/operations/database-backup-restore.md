#AlfredDatabaseBackup&RestoreAutomation>**Classification:**Internal—Operations>**Owner:**SergeyBar+DevOpsTeam>**RTOTarget:**15minutes>**RPOTarget:**1hour(hourlybackups)>**SOC2Control:**CC9.1-02—Testedbackup/restoreprocedures---##1.OverviewAlfredusesPostgreSQL15asitsprimarydatastore.Thebackupautomationprovides:-**Hourly**automatedbackupsviacron-**SHA-256**checksumverificationforintegrity-**S3**uploadforoff-sitestorage-**Parallelrestore**(4workers)forfastrecovery-**Monthly**verificationtestsforSOC2compliance---##2.QuickStart###TakeaBackup```bash#DirectPostgreSQLbackup./devops/scripts/backup_database.sh#DockerComposebackup./devops/scripts/backup_database.sh--docker#Schema-onlybackup./devops/scripts/backup_database.sh--schema-only#Backup+uploadtoS3S3_BUCKET=alfred-backups./devops/scripts/backup_database.sh--upload-s3```###RestorefromBackup```bash#Restorelatestlocalbackup./devops/scripts/restore_database.sh--latest#Restorespecificfile./devops/scripts/restore_database.sh/var/backups/alfred/alfred_ao_20260215_120000.dump#RestorefromS3S3_BUCKET=alfred-backups./devops/scripts/restore_database.sh--from-s3alfred_ao_20260215_120000.dump#DockerComposerestore./devops/scripts/restore_database.sh--docker--latest#Verify-only(norestore)./devops/scripts/restore_database.sh--verify-onlybackup.dump```###InstallAutomatedHourlyBackups```bash./devops/scripts/backup_database.sh--install-cron```---##3.ConfigurationAllsettingsarecontrolledviaenvironmentvariables:|Variable|Default|Description||-----------------------|---------------------|--------------------------------------||`PGHOST`|`localhost`|PostgreSQLhost||`PGPORT`|`5432`|PostgreSQLport||`PGUSER`|`postgres`|Databaseuser||`PGPASSWORD`|`postgres`|Databasepassword||`PGDATABASE`|`ao`|Databasename||`BACKUP_DIR`|`/var/backups/alfred`|Localbackupdirectory||`BACKUP_RETENTION_DAYS`|`7`|Daystokeeplocalbackups||`BACKUP_FORMAT`|`custom`|`custom`(pg_restore)or`plain`(SQL)||`S3_BUCKET`|(empty)|S3bucketforremotestorage||`S3_PREFIX`|`alfred/backups`|S3keyprefix||`DOCKER_CONTAINER`|(auto-detect)|Dockercontainerfor`--docker`mode||`PRODUCTION`|`false`|Requireinteractiveconfirmation||`CONFIRM_RESTORE`|`true`|Skipinteractiveprompt(automation)|---##4.BackupStrategy###RetentionPolicy|Tier|Frequency|Retention|Storage||-------|-----------------|---------|----------------||Hourly|Everyhour|24hours|Local+S3||Daily|Onceat00:00UTC|7days|S3||Weekly|Sunday00:00UTC|4weeks|S3(Standard-IA)||Monthly|1stofmonth|12months|S3(Glacier)|###FileNamingConvention```alfred_{database}_{YYYYMMDD_HHMMSS}.dump#Customformat(pg_restore)alfred_{database}_{YYYYMMDD_HHMMSS}.sha256#Checksumfilealfred_{database}_{YYYYMMDD_HHMMSS}_schema.dump#Schema-onlyalfred_latest.dump#Symlinktolatest```---##5.RestoreProcedure###StandardRestore(15-minRTO)Therestorescriptexecutesfourphases:1.**Pre-restorevalidation**—Verifybackupintegrity(checksum+pg_restore-l)2.**Terminateconnections**—KillactiveconnectionstotargetDB3.**Dropandrecreate**—Cleanslateforthedatabase4.**Parallelrestore**—pg_restorewith`--jobs=4`forspeed###Post-RestoreChecklistAfterrestorecompletes,verify:-[]Criticaltablespresent(`user`,`team`,`audit_log`,`request_log`,`token_transfer`)-[]Rowcountsmatchexpectedvalues-[]Auditlogchainintegrity:`POST/v1/admin/audit-logs/verify`-[]Applicationhealth:`GET/health`-[]Runsmoketests:`pytestqa/Backend/Unit/test_api.py-v`###ProductionSafetyForproductionrestores:1.Set`PRODUCTION=true`—requirestyping"RESTORE"toconfirm2.Orset`CONFIRM_RESTORE=true`forautomatedpipelines3.ThescriptterminatesALLactiveDBconnectionsbeforerestore---##6.SOC2VerificationRuntheverificationtestmonthly:```bash./devops/scripts/verify_backup_restore.sh```Thistest:1.Createsatestdatabasewithknowndata2.Runsthebackupscript3.Verifiesthechecksum4.Restorestoaseparatedatabase5.Validatesalldataintegrity(rowcounts,values,JSONB)6.MeasuresrestoredurationagainstRTO7.Cleansuptestdatabases**RecordresultsintheSOC2evidencelog.**---##7.S3LifecycleConfigurationRequiredS3bucketconfigurationforcostoptimization:```json{"Rules":[{"ID":"alfred-backup-lifecycle","Status":"Enabled","Filter":{"Prefix":"alfred/backups/"},"Transitions":[{"Days":30,"StorageClass":"STANDARD_IA"},{"Days":90,"StorageClass":"GLACIER"}],"Expiration":{"Days":365}}]}```Apply:`awss3apiput-bucket-lifecycle-configuration--bucketalfred-backups--lifecycle-configurationfile://lifecycle.json`---##8.Monitoring&Alerting###BackupHealthChecks|Check|Frequency|AlertOn||---------------------|-------------|---------------------||Lastbackupage|Every2hours|Nobackupin>2hours||Backupfilesize|Eachbackup|Size<50%ofaverage||Checksumverification|Eachbackup|Checksummismatch||S3upload|Eachbackup|Uploadfailure||Monthlyrestoretest|Monthly|Testfailure|###IntegrationwithAlfredSLAMonitorThebackupstatuscanbereportedtotheSLAmonitor:```bash#ReportbackupsuccesstoAlfredcurl-XPOSThttp://localhost:8080/v1/notifications/send\-H"Authorization:Bearer$ADMIN_KEY"\-H"Content-Type:application/json"\-d'{"type":"backup_success","message":"Hourlybackupcompleted"}'```---##9.Troubleshooting###CommonIssues|Issue|Cause|Fix||---------------------------------|------------------------------|--------------------------------------||`pg_dump:connectionrefused`|PostgreSQLnotrunning|StartPostgreSQL/checkPGHOST||`pg_restore:roledoesnotexist`|MissingDBuser|`--no-owner--no-privileges`(default)||`Checksummismatch`|Corrupttransferordiskerror|Re-runbackup;checkdiskhealth||`RTOexceeded`|Largedatabase|Increase`--jobs`,upgradediskI/O||`S3uploadfailed`|Missingcredentials|`awsconfigure`orcheckIAMrole|###ManualEmergencyRestoreIfscriptsfail,manualrestore:```bash#1.Downloadbackupawss3cps3://alfred-backups/alfred/backups/alfred_ao_latest.dump/tmp/#2.Terminateconnectionspsql-Upostgres-dpostgres-c\"SELECTpg_terminate_backend(pid)FROMpg_stat_activityWHEREdatname='ao';"#3.Dropandrecreatepsql-Upostgres-dpostgres-c"DROPDATABASEIFEXISTSao;"psql-Upostgres-dpostgres-c"CREATEDATABASEaoOWNERpostgres;"#4.Restorepg_restore-Upostgres-dao--no-owner--no-privileges--jobs=4/tmp/alfred_ao_latest.dump#5.Verifypsql-Upostgres-dao-c"SELECTCOUNT(*)FROM\"user\";"```---_AlfredDatabaseBackup&Restore—InternalUseOnly__Version1.0—February2026__Maintainedby:SergeyBar+DevOpsTeam_