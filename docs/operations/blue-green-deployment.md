#Blue-GreenDeploymentPipeline>**SprintTask:**T252|**Priority:**P0|**Classification:**ProductionOperations>>[AIGENERATED-GOVERNANCEPROTOCOL]>Model:ClaudeOpus4.6|Tier:L3|Task:T252documentation---##OverviewAlfredusesa**blue-greendeployment**strategytoachievezero-downtimereleases.Twoidenticaldeploymentslots(blueandgreen)runsimultaneously,withtrafficroutedtotheactiveslotviaKubernetesServiceselectors.Newversionsdeploytotheinactiveslot,undergohealthvalidation,andtrafficswitchesinstantly.###KeyGuarantees|Guarantee|Implementation||---------------------|----------------------------------------||Zerodowntime|Serviceselectorswapisinstant||Instantrollback|PatchServicebacktooldslot(<5s)||Healthvalidation|Readiness+liveness+startupprobes||Poddisruptionbudget|Backend:min1available;Gateway:min2||Gracefulshutdown|60sterminationgraceperiod|---##Architecture```┌─────────────────────┐│Ingress/LB│└──────────┬──────────┘│┌──────────▼──────────┐│K8sService││selector:││slot:blue←────│──Toggleto"green"└──┬──────────────┬───┘││┌──────────▼──┐┌──────▼──────────┐│Deployment││Deployment││BLUE││GREEN││(active)││(standby/new)││replicas:2││replicas:2│└─────────────┘└──────────────────┘```###DeploymentFlow```Phase1:Detectactiveslot(blueorgreen)↓Phase2:DeploynewimagetoINACTIVEslot↓Phase3:Healthvalidation(readiness+customchecks)↓Phase4:Switchtraffic(patchServiceselector)↓Phase5:Post-switchmonitoring(30sobservationwindow)↓Phase6:Optional:scaledownoldslot```---##Usage###Prerequisites```bash#Ensurekubectlisconfiguredfortargetclusterkubectlcluster-infokubectlgetnamespacealfred#Verifycurrentdeploymentstatekubectlgetdeployments-nalfred-lapp=alfred-backendkubectlgetsvc-nalfredalfred-backend-ojsonpath='{.spec.selector.slot}'```###DeployNewVersion```bash#Deploynewbackendversiondevops/scripts/blue_green_deploy.sh\--backend-imagealfredai/backend:v2.1.0#Deploybothbackendandgatewaydevops/scripts/blue_green_deploy.sh\--backend-imagealfredai/backend:v2.1.0\--gateway-imagealfredai/gateway:v2.1.0#Deploywithcleanup(scaledownoldslotaftervalidation)devops/scripts/blue_green_deploy.sh\--backend-imagealfredai/backend:v2.1.0\--scale-down-old#Dryrun(previewwithoutchanges)devops/scripts/blue_green_deploy.sh\--backend-imagealfredai/backend:v2.1.0\--dry-run```###RollbackRollbackisinstant—simplyswitchtheServiceselectorback:```bash#Checkwhichslotisactivekubectlgetsvcalfred-backend-nalfred-ojsonpath='{.spec.selector.slot}'#Switchtooppositeslot(e.g.,backtoblue)kubectlpatchsvcalfred-backend-nalfred\-p'{"spec":{"selector":{"slot":"blue"}}}'kubectlpatchsvcalfred-gateway-nalfred\-p'{"spec":{"selector":{"slot":"blue"}}}'#Verifyrollbackkubectlgetsvc-nalfred-owide```---##KubernetesResources###Manifests|File|Purpose||---------------------------------------------|--------------------------------------||`tools/helm/alfred/templates/blue-green.yaml`|Blue/greenDeployments,Services,PDBs||`devops/scripts/blue_green_deploy.sh`|Deploymentautomationscript|###Services-`alfred-backend`—Routestoactivebackendslot(port8000)-`alfred-gateway`—Routestoactivegatewayslot(port8080)###Deployments-`alfred-backend-blue`/`alfred-backend-green`—Backendslots-`alfred-gateway-blue`/`alfred-gateway-green`—Gatewayslots###PodDisruptionBudgets-`alfred-backend-pdb`—Minimum1availableduringdisruption-`alfred-gateway-pdb`—Minimum2availableduringdisruption---##HealthChecksEachdeploymentincludesthreeprobetypes:|Probe|Backend|Gateway|Purpose||---------|---------------------------------------|----------------------------------------|----------------------||Startup|`GET/health`(3sinterval,30retries)|`GET/healthz`(3sinterval,30retries)|Slow-starttolerance||Readiness|`GET/health`(5sinterval)|`GET/ready`(5sinterval)|Trafficrouting||Liveness|`GET/health`(10sinterval)|`GET/healthz`(10sinterval)|Restartunhealthypods|---##MonitoringDuringDeployment###KeyMetricstoWatch```bash#Watchpodstatusduringrolloutkubectlgetpods-nalfred-lapp=alfred-backend-w#Checkrolloutstatuskubectlrolloutstatusdeployment/alfred-backend-green-nalfred#Monitorerrorrates(Prometheus)#alfred_gateway_requests_total{status=~"5.."}#alfred_gateway_request_duration_ms```###Post-DeploymentChecklist```[]Healthendpointsreturn200onnewslot[]Errorrate<1%for5minutesafterswitch[]P95latencywithinSLA(<150msgatewayoverhead)[]No502/503errorsduringtransition[]Oldslotavailableforrollback(unless--scale-down-old)```---##CI/CDIntegration###GitHubActionsExample```yaml-name:Blue-GreenDeployrun:|devops/scripts/blue_green_deploy.sh\--backend-imagealfredai/backend:${{github.sha}}\--gateway-imagealfredai/gateway:${{github.sha}}\--health-retries60\--validation-time60env:KUBECONFIG:${{secrets.KUBECONFIG}}```---##ROLLBACK```bash#ROLLBACK:Torevertablue-greendeployment:#1.kubectlpatchsvcalfred-backend-nalfred-p'{"spec":{"selector":{"slot":"<old-slot>"}}}'#2.kubectlpatchsvcalfred-gateway-nalfred-p'{"spec":{"selector":{"slot":"<old-slot>"}}}'#3.Verify:kubectlgetsvc-nalfred-owide#4.Notify:SergeyBar+on-callengineer```