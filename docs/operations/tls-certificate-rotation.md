#TLS1.3Enforcement&CertificateRotation>**SprintTask:**T220|**Priority:**P0|**Classification:**Security-Critical>>[AIGENERATED-GOVERNANCEPROTOCOL]>Model:ClaudeOpus4.6|Tier:L4|Task:T220documentation---##OverviewAlfredenforces**TLS1.3astheminimumprotocolversion**acrossallpublicandinternalendpoints.NoTLS1.2fallbackispermitted.Certificatelifecycleisfullyautomatedvia**cert-manager**withLet'sEncryptACMEintegration.###SecurityGuarantees|Requirement|Implementation||-----------------------|--------------------------------------------------||MinimumTLSversion|**TLS1.3only**—no1.2fallback||Keyexchange|X25519(primary),ECDSAP-256(fallback)||Certificatealgorithm|ECDSAP-256(`rotationPolicy:Always`)||HSTS|max-age=63072000,includeSubDomains,preload||OCSPstapling|Enabledatingressandgateway||Sessionticketrotation|Every6hours(3-keywindow)||Certificaterenewal|30daysbeforeexpiry(automated)||InternalmTLS|ECDSAP-256,30-dayrotation,7-dayrenewalwindow|---##Architecture```┌─────────────────────────────────────────────────────────┐│Internet│││││┌─────────▼──────────┐│││NginxIngress││││TLS1.3ONLY││││HSTS+OCSP││││cert-managerTLS│││└──┬──────┬─────┬──┘│││││││┌─────▼┐┌──▼──┐┌▼──────┐│││Front││Back││Gateway│←mTLS│││end││end││(Go)│between││└──────┘└──┬──┘└───┬───┘services││││││┌────▼────────▼────┐│││InternalCA││││(cert-manager)│││└──────────────────┘│└─────────────────────────────────────────────────────────┘```---##Components###1.NginxIngressTLSHardeningTheHelmvaluesenforceTLS1.3attheingresslayer:```yamlingress:annotations:#TLS1.3only—nodowngradenginx.ingress.kubernetes.io/ssl-protocols:"TLSv1.3"nginx.ingress.kubernetes.io/ssl-ciphers:>-TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256nginx.ingress.kubernetes.io/ssl-prefer-server-ciphers:"true"#HSTSpreloadnginx.ingress.kubernetes.io/hsts:"true"nginx.ingress.kubernetes.io/hsts-max-age:"63072000"nginx.ingress.kubernetes.io/hsts-include-subdomains:"true"nginx.ingress.kubernetes.io/hsts-preload:"true"#OCSPstaplingnginx.ingress.kubernetes.io/enable-ocsp:"true"```###2.cert-managerCertificateLifecyclecert-managerhandlesallcertificateoperations:|Certificate|Type|Duration|RenewalWindow|Algorithm||---------------------|--------------------|--------|---------------------|-----------||`alfred-tls`|Let'sEncrypt(ACME)|90days|30daysbeforeexpiry|ECDSAP-256||`alfred-mtls-gateway`|InternalCA|30days|7daysbeforeexpiry|ECDSAP-256||`alfred-mtls-backend`|InternalCA|30days|7daysbeforeexpiry|ECDSAP-256||`alfred-internal-ca`|Self-signedroot|10years|1yearbeforeexpiry|ECDSAP-256|###3.GatewayGoTLSModuleTheGogatewayenforcesTLS1.3attheapplicationlevel:```go//security/tls.go—TLSManagertlsCfg:=&tls.Config{MinVersion:tls.VersionTLS13,MaxVersion:tls.VersionTLS13,CurvePreferences:[]tls.CurveID{tls.X25519,//fastesttls.CurveP256,//NISTfallback},GetCertificate:m.getCertificate,//hot-reloadsupport}```Features:-**Certificatehot-reload**:Checksdiskevery5minutesforupdatedcerts-**Sessionticketrotation**:3-keywindowrotatedevery6hours-**Healthcheckendpoint**:Reportscertexpirystatus-**RejectTLS<1.3**:Constructorreturnserrorif`MinVersion<TLS1.3`---##CertificateRotationAutomation###AutomaticRotation(cert-manager)cert-managerrunsasaKubernetescontrollerandhandlesthefullACMEflow:```1.cert-managerdetectscertificatenearingexpiry(30daysout)2.CreatesanewCertificateRequest→ACMEOrder→Challenge3.SolvesHTTP-01orDNS-01challengewithLet'sEncrypt4.ReceivesnewcertificateandupdatestheK8sSecret5.NginxIngressControllerdetectsSecretchange→reloadsTLS6.GatewayTLSManagerdetectsnewcertfile→hot-reloads```###MonitoringCertificateHealth```bash#Checkcertificatestatuskubectlgetcertificates-nalfredkubectldescribecertificatealfred-tls-nalfred#Checkcertificateexpiryecho|openssls_client-connectalfred.example.com:4432>/dev/null|\opensslx509-noout-dates-subject#VerifyTLS1.3isenforcedopenssls_client-connectalfred.example.com:443-tls1_22>&1|grep-i"error"#Expected:handshakefailure(TLS1.2rejected)openssls_client-connectalfred.example.com:443-tls1_32>&1|grep"Protocol"#Expected:TLSv1.3```###ManualCertificateRotationIfyouneedtoforceanimmediaterotation:```bash#Forcecert-managertorenewkubectldeletesecretalfred-tls-nalfredkubectlcert-managerrenewalfred-tls-nalfred#Verifynewcertificatekubectlgetcertificatealfred-tls-nalfred-ojsonpath='{.status.notAfter}'```---##Deployment###Prerequisites```bash#Installcert-manager(v1.14+)kubectlapply-fhttps://github.com/cert-manager/cert-manager/releases/download/v1.14.4/cert-manager.yaml#Verifyinstallationkubectlgetpods-ncert-manager```###DeployTLSConfiguration```bash#Deploywithcert-managerenabledhelmupgrade--installalfredtools/helm/alfred\--namespacealfred\--setcertManager.enabled=true\--setcertManager.email="security@alfred.ai"\--setcertManager.dnsNames[0]="alfred.example.com"\--setcertManager.dnsNames[1]="*.alfred.example.com"#Forwildcardcerts(requiresDNS-01solver)helmupgrade--installalfredtools/helm/alfred\--namespacealfred\--setcertManager.dns01.enabled=true\--setcertManager.dns01.route53.enabled=true\--setcertManager.dns01.route53.region=us-east-1```###EnableGatewayTLS(Optional—fordirectTLStermination)```bash#EnvironmentvariablesforthegatewaypodexportALFRED_TLS_ENABLED=trueexportALFRED_TLS_CERT_FILE=/certs/tls.crtexportALFRED_TLS_KEY_FILE=/certs/tls.key```---##ValidationChecklist```[x]TLS1.3istheminimumversionatingress(ssl-protocols:TLSv1.3)[x]TLS1.2connectionsarerejected(nofallback)[x]HSTSheaderspresentwithpreloaddirective[x]OCSPstaplingenabled[x]CertificateusesECDSAP-256[x]cert-managerClusterIssuerconfiguredforLet'sEncrypt[x]Certificaterenewalautomated(30daysbeforeexpiry)[x]InternalmTLSbetweengateway↔backend(ECDSAP-256,30-dayrotation)[x]GatewayTLSManagerenforcesTLS1.3atGolevel[x]Sessionticketrotationevery6hours[x]Certificatehealthcheckavailableformonitoring[x]NoTLS1.0/1.1anywhereinthestack```---##IncidentResponseSee[INC-13:CertificateExpiry/TLSFailure](incident-response-playbook.md#inc-13-certificate-expiry--tls-failure)intheincidentresponseplaybookforemergencyprocedures.###QuickTroubleshooting|Symptom|LikelyCause|Fix||------------------------------|---------------------------|-------------------------------------------------||`SSL_ERROR_EXPIRED_CERT_ALERT`|cert-managerrenewalfailed|`kubectlcert-managerrenewalfred-tls-nalfred`||TLS1.2clientsrejected|Bydesign—TLS1.3only|Upgradeclient||`noTLScertificateloaded`|Certfilenotmounted|Checkvolumemountsinpodspec||cert-managerpodcrash-looping|MissingCRDsorpermissions|Reinstallcert-manager|---##ComplianceMapping|Requirement|Control|Status||------------------|---------------------------------------|--------------||SOC2CC6.1|TLS1.3enforced,noweakprotocols|✅Implemented||SOC2CC6.7|Certificatelifecycleautomated|✅Implemented||PCIDSS4.0§4.2.1|Strongcryptographyfordataintransit|✅Implemented||NISTSP800-52r2|TLS1.3recommended|✅Implemented|---##ROLLBACK```#ROLLBACK:TorevertTLS1.3enforcement:#1.Editvalues.yaml:changessl-protocolsto"TLSv1.2TLSv1.3"#2.helmupgrade--installalfredtools/helm/alfred-nalfred#3.Verify:openssls_client-connectalfred.example.com:443-tls1_2#4.Notify:SergeyBar+on-callengineer#WARNING:DowngradingtoTLS1.2reducessecurityposture.```