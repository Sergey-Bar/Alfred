#AlfredDisasterRecoveryRunbook[AIGENERATED-GOVERNANCEPROTOCOL]──────────────────────────────────────────────────────────────Model:ClaudeOpus4.6Tier:L2Logic:Comprehensivedisasterrecoveryprocedures.RootCause:SprinttaskT198—DRrunbookdocumentation.Context:Enablesrapidrecoveryfromvariousfailurescenarios.Suitability:L2—Standardoperationsdocumentation.──────────────────────────────────────────────────────────────##1.Overview###1.1PurposeThisrunbookprovidesstep-by-stepproceduresforrecoveringtheAlfredplatformfromvariousdisasterscenarios.Itisdesignedtominimizedowntimeanddatalosswhileensuringservicecontinuity.###1.2RecoveryObjectives|Metric|Target|Tier1(Critical)|Tier2(Standard)||----------------------------------|-------|-----------------|-----------------||**RTO**(RecoveryTimeObjective)|4hours|1hour|4hours||**RPO**(RecoveryPointObjective)|1hour|15minutes|1hour||**MTTR**(MeanTimetoRecovery)|2hours|30minutes|2hours|###1.3ServiceTiers|Tier|Services|Priority||------|-----------------------------------|-------------------------||Tier1|Gateway,Ledger,Authentication|Critical—RestoreFirst||Tier2|Dashboard,Analytics,Notifications|Standard—RestoreSecond||Tier3|Reports,Non-essentialAPIs|Deferrable|##2.ContactList###2.1InternalContacts|Role|Name|Phone|Email||-------------------|----------------|---------------|----------------||IncidentCommander|On-callrotation|PagerDuty|oncall@alfred.ai||SecurityLead|SergeyBar|+1-xxx-xxx-xxxx|sergey@alfred.ai||InfrastructureLead|TBD|+1-xxx-xxx-xxxx|infra@alfred.ai||VPEngineering|TBD|+1-xxx-xxx-xxxx|vpeng@alfred.ai|###2.2ExternalContacts|Service|Contact|Phone|AccountID||-----------|------------------|-----|----------------||AWSSupport|EnterpriseSupport|-|xxxx-xxxx-xxxx||GCPSupport|PremiumSupport|-|alfred-prod-xxxx||Cloudflare|StatusPage|-|alfred-xxxx||PagerDuty|-|-|alfred|###2.3EscalationPath```Level1:On-callEngineer(0-15min)↓Level2:InfrastructureLead(15-30min)↓Level3:SecurityLead+VPEngineering(30-60min)↓Level4:ExecutiveTeam(60+min)```##3.DisasterScenarios###3.1ScenarioMatrix|Scenario|Probability|Impact|RecoveryTime|Section||--------------------------|-----------|--------|-------------|-------||Singlezonefailure|Medium|Low|Auto-recovery|4.1||Regionfailure|Low|High|1-2hours|4.2||Databasecorruption|VeryLow|Critical|2-4hours|4.3||Ransomware/Securitybreach|VeryLow|Critical|4-8hours|4.4||Cloudprovideroutage|VeryLow|Critical|2-4hours|4.5||DDoSattack|Medium|Medium|30min|4.6||Certificateexpiry|Low|High|15min|4.7||Secretrotationfailure|Low|Medium|30min|4.8|##4.RecoveryProcedures###4.1SingleZoneFailure**Trigger:**Healthchecksfailinoneavailabilityzone.**AutomaticRecovery:**1.Loadbalancerremovesunhealthyinstances2.Auto-scalinglaunchesreplacementsinhealthyzones3.Trafficredistributesautomatically**ManualVerification:**```bash#Checkinstancehealthkubectlgetpods-nalfred-owide#Checkloadbalancertargetsawselbv2describe-target-health--target-group-arn<arn>#Verifytrafficdistributionkubectltoppods-nalfred```**Noactionrequiredunlessautomaticrecoveryfails.**###4.2RegionFailure**Trigger:**Entirecloudregionbecomesunavailable.**Prerequisites:**-Multi-regiondeploymentenabled-DNSfailoverconfigured-Cross-regiondatabasereplicationactive**RecoverySteps:**1.**DeclareIncident**(5min)```-Pageincidentcommander-Createincidentchannel#incident-YYYYMMDD-region-Updatestatuspage:"Investigating"```2.**ActivateFailoverRegion**(15min)```bash#Verifysecondaryregionhealthkubectl--context=dr-regiongetpods-nalfred#Promotereadreplicatoprimaryawsrdspromote-read-replica--db-instance-identifieralfred-dr-replica#Updateapplicationconfigurationkubectl--context=dr-regionsetenvdeployment/alfred-backend\DATABASE_URL=$DR_DATABASE_URL```3.**UpdateDNS**(5min)```bash#FailovertoDRregion(Route53)awsroute53change-resource-record-sets\--hosted-zone-id<zone>\--change-batchfile://dr-failover.json#OruseCloudflarecurl-XPATCH"https://api.cloudflare.com/client/v4/zones/<zone>/dns_records/<id>"\-H"Authorization:Bearer$CF_TOKEN"\-d'{"content":"<dr-region-ip>"}'```4.**VerifyServices**(15min)```bash#Testauthenticationcurlhttps://api.alfred.ai/health#Testcriticalpaths./scripts/smoke_test.sh--env=production```5.**UpdateStatusPage**(2min)```Status:"Operatingindisasterrecoverymode"```###4.3DatabaseCorruption**Trigger:**Dataintegrityerrors,applicationerrorsindicatingbaddata.**RecoverySteps:**1.**IsolatetheIssue**(5min)```bash#Checkforactivewritespsql-h$DB_HOST-c"SELECT*FROMpg_stat_activityWHEREstate='active';"#Ifneeded,stopapplicationwriteskubectlscaledeploymentalfred-backend--replicas=0```2.**AssessCorruption**(15min)```sql--CheckforcorruptionSELECTpg_stat_user_tables.relname,n_dead_tup,n_live_tupFROMpg_stat_user_tables;--VerifyauditlogintegritySELECTid,prev_hash,encode(sha256(concat(prev_hash,user_id::text,action,timestamp::text)::bytea),'hex')ascalculated_hash,hashFROMaudit_logWHEREhash!=encode(sha256(concat(prev_hash,user_id::text,action,timestamp::text)::bytea),'hex')LIMIT10;```3.**Point-in-TimeRecovery**(1-2hours)```bash#Listavailablesnapshotsawsrdsdescribe-db-snapshots--db-instance-identifieralfred-prod#Orlistpoint-in-timerecoverywindowawsrdsdescribe-db-instances--db-instance-identifieralfred-prod\--query'DBInstances[0].LatestRestorableTime'#Restoretonewinstanceawsrdsrestore-db-instance-to-point-in-time\--source-db-instance-identifieralfred-prod\--target-db-instance-identifieralfred-prod-recovered\--restore-time2024-01-15T14:30:00Z#Waitforrestorationawsrdswaitdb-instance-available\--db-instance-identifieralfred-prod-recovered```4.**ValidateData**(30min)```bash#Rundatavalidationscriptspythontools/validate_db.py--connection=$RECOVERED_DB_URL#Verifywalletbalancespsql-h$RECOVERED_DB-c"SELECTSUM(balance)FROMwallets;"```5.**Cutover**(15min)```bash#Updateapplicationtouserecovereddatabasekubectlsetenvdeployment/alfred-backend\DATABASE_URL=$RECOVERED_DB_URL#Restartapplicationkubectlrolloutrestartdeployment/alfred-backend```###4.4SecurityBreach/Ransomware**Trigger:**Securityalert,suspiciousactivity,ransomdemand.**CRITICAL:Donotpayransom.Donotnegotiate.****RecoverySteps:**1.**ContainImmediately**(5min)```bash#ISOLATE:Blockallexternalaccesskubectlapply-fk8s/emergency-network-policy.yaml#RevokeallAPIkeyspsql-c"UPDATEapi_keysSETis_active=false,revoked_at=NOW();"#RotateJWTsecretkubectlcreatesecretgenericjwt-secret--from-literal=secret=$(opensslrand-hex32)--dry-run=client-oyaml|kubectlapply-f-```2.**PreserveEvidence**(15min)```bash#Snapshotallvolumesawsec2create-snapshots--instance-specificationInstanceId=<id>,ExcludeBootVolume=false#Exportlogsawslogscreate-export-task--log-group-namealfred-prod\--destination-bucketsecurity-incident-logs\--from$(date-d'24hoursago'+%s)000--to$(date+%s)000#DoNOTmodifyrunninginstances—forensicanalysisneeded```3.**ContactSecurityLead**(Immediate)```-CallSergeyBardirectly-DonotdiscussoverSlack/email(maybecompromised)-Prepareforlawenforcementinvolvement```4.**CleanEnvironmentDeployment**(2-4hours)```bash#Deployfromverifiedcleaninfrastructureterraformapply-var-file=clean-deployment.tfvars#Restorefrompre-breachbackup#(Identifybreachtimestampfirstviasecurityanalysis)#RegenerateALLcredentials./scripts/rotate_all_secrets.sh```5.**Post-Incident**-Fullsecurityaudit-Customernotification(ifrequiredbylaw)-Incidentreportandpostmortem###4.5CloudProviderOutage**Trigger:**Cloudproviderstatuspageshowsoutage.**IfMulti-Cloud:**```bash#Failovertosecondarycloud./scripts/failover_cloud_provider.sh--target=gcp```**IfSingle-Cloud:**```1.Monitorproviderstatuspage2.Communicatewithcustomersviastatuspage3.Noactionpossibleuntilproviderrecovers4.Considertemporaryread-onlymodeifpartialserviceavailable```###4.6DDoSAttack**Trigger:**Trafficspike,servicedegradation,Cloudflarealerts.**RecoverySteps:**1.**ActivateDDoSProtection**(5min)```bash#EnableCloudflare"UnderAttack"modecurl-XPATCH"https://api.cloudflare.com/client/v4/zones/<zone>/settings/security_level"\-H"Authorization:Bearer$CF_TOKEN"\-d'{"value":"under_attack"}'#Enableratelimitingruleskubectlapply-fk8s/rate-limit-strict.yaml```2.**BlockAttackSources**(10min)```bash#Analyzetrafficpatternskubectllogs-lapp=gateway--tail=10000|grep-E"client_ip"|sort|uniq-c|sort-rn|head-50#BlockviaWAFrules#AddIPrangestoCloudflareblocklist```3.**ScaleCapacity**(10min)```bash#Increasereplicacountkubectlscaledeploymentalfred-gateway--replicas=20#Scaledatabaseconnections#Temporarilyincreaseconnectionpool```4.**RestoreNormalMode**(Afterattacksubsides)```bash#Disable"UnderAttack"modecurl-XPATCH"https://api.cloudflare.com/client/v4/zones/<zone>/settings/security_level"\-H"Authorization:Bearer$CF_TOKEN"\-d'{"value":"high"}'```###4.7CertificateExpiry**Trigger:**SSLerrors,cert-manageralerts.**RecoverySteps:**1.**CheckCertificateStatus**(2min)```bash#Checkexpiryecho|openssls_client-servernameapi.alfred.ai-connectapi.alfred.ai:4432>/dev/null|opensslx509-noout-dates#Checkcert-managerkubectlgetcertificates-nalfredkubectldescribecertificatealfred-tls-nalfred```2.**ForceRenewal**(5min)```bash#Deleteexistingcertificatetotriggerrenewalkubectldeletecertificatealfred-tls-nalfred#Ormanuallytriggerkubectlcert-managerrenewalfred-tls-nalfred#Waitforissuancekubectlwait--for=condition=Readycertificate/alfred-tls-nalfred--timeout=300s```3.**ManualCertificate**(Ifautomatedfails)```bash#GenerateviaLet'sEncryptCLIcertbotcertonly--dns-cloudflare--dns-cloudflare-credentials~/.secrets/cloudflare.ini\-dapi.alfred.ai-dapp.alfred.ai#ImporttoKuberneteskubectlcreatesecrettlsalfred-tls\--cert=/etc/letsencrypt/live/api.alfred.ai/fullchain.pem\--key=/etc/letsencrypt/live/api.alfred.ai/privkey.pem\--dry-run=client-oyaml|kubectlapply-f-```###4.8SecretRotationFailure**Trigger:**Vaulterrors,authenticationfailuresafterrotation.**RecoverySteps:**1.**IdentifyAffectedSecret**(5min)```bash#CheckVaultstatusvaultstatus#Listrecentsecretversionsvaultkvmetadatagetsecret/alfred/prod/database```2.**RollbacktoPreviousVersion**(5min)```bash#Getpreviousversionvaultkvget-version=2secret/alfred/prod/database#Rollbackvaultkvrollback-version=2secret/alfred/prod/database```3.**ResyncApplications**(5min)```bash#Restartpodstopickupnewsecretskubectlrolloutrestartdeploymentalfred-backendkubectlrolloutrestartdeploymentalfred-gateway```##5.CommunicationTemplates###5.1InternalIncidentNotification```INCIDENTDECLARED:[SeverityLevel]Time:YYYY-MM-DDHH:MMUTCImpact:[Description]IncidentCommander:[Name]Channel:#incident-YYYYMMDD-[name]CurrentStatus:InvestigatingETAforUpdate:[Time]```###5.2CustomerStatusPageUpdate```[ServiceDisruption]-InvestigatingWearecurrentlyinvestigatingreportsof[issuedescription].Impact:[Affectedservices]Status:InvestigatingWewillprovideanupdatewithin30minutes.```###5.3ResolutionNotification```[Resolved]-[IssueDescription]Theissueaffecting[services]hasbeenresolved.Duration:[Starttime]-[Endtime](XhoursYminutes)RootCause:[Briefdescription]Resolution:[Actiontaken]Weapologizeforanyinconvenience.Adetailedpostmortemwillbesharedwithin48hours.```##6.TestingSchedule|TestType|Frequency|LastTested|NextTest||------------------|---------|-----------|----------||Failoverdrill|Quarterly|YYYY-MM-DD|YYYY-MM-DD||Backuprestoration|Monthly|YYYY-MM-DD|YYYY-MM-DD||FullDRexercise|Annually|YYYY-MM-DD|YYYY-MM-DD||Tabletopexercise|Quarterly|YYYY-MM-DD|YYYY-MM-DD|##7.Appendix###A.EmergencyNetworkPolicy```yaml#k8s/emergency-network-policy.yamlapiVersion:networking.k8s.io/v1kind:NetworkPolicymetadata:name:emergency-lockdownnamespace:alfredspec:podSelector:{}policyTypes:-Ingress-Egressingress:[]#Blockallingressegress:-to:-namespaceSelector:matchLabels:name:kube-system```###B.DRFailoverDNS```json//dr-failover.json{"Changes":[{"Action":"UPSERT","ResourceRecordSet":{"Name":"api.alfred.ai","Type":"A","AliasTarget":{"HostedZoneId":"<dr-region-zone>","DNSName":"<dr-region-lb>","EvaluateTargetHealth":true}}}]}```###C.RunbookChangelog|Date|Version|Author|Changes||----------|-------|-------------------|---------------||2024-01-XX|1.0|InfrastructureTeam|Initialrunbook|---**Classification:**Internal—OperationsTeam**ReviewFrequency:**Quarterly**Owner:**InfrastructureLead