#AlfredLogAggregation&Search>**Classification:**Internal—Operations>**Owner:**SergeyBar+DevOpsTeam>**Stack:**GrafanaLoki+Promtail+Prometheus+Grafana---##1.OverviewAlfred'sobservabilitystackprovidescentralizedlogaggregationandsearchacrossallservices:|Component|Role|Port||--------------|------------------------------|----||**Loki**|Logstorage&queryengine|3100||**Promtail**|Logcollector(Docker+files)|9080||**Prometheus**|Metricscollection|9090||**Grafana**|Visualization&dashboards|3000|---##2.QuickStart###LaunchtheObservabilityStack```bashcddevops/observabilitydockercompose-fdocker-compose.observability.yamlup-d```###AccessGrafana-**URL:**http://localhost:3000-**Username:**`admin`(or`GRAFANA_ADMIN_USER`)-**Password:**`alfred-admin`(or`GRAFANA_ADMIN_PASSWORD`)###SearchLogsinGrafana1.Goto**Explore**→select**Loki**datasource2.UseLogQLqueries(examplesbelow)---##3.LogQLQueryExamples###BasicQueries```logql#Alllogsfromthebackendservice{service="backend"}#Error-levellogsonly{service="backend"}|="ERROR"#Logsfromaspecificcontainer{container="alfred-gateway-1"}#LogsmentioningauserID{service="backend"}|="user_id=abc123"```###AdvancedQueries```logql#ParseJSONlogsandfilterbylevel{service="backend"}|json|level="error"#Findslowrequests(>500ms){service="gateway"}|json|latency>500#Counterrorsperproviderinlasthoursumby(provider)(count_over_time({service="gateway"}|json|level="error"[1h]))#Rateof5xxerrorssum(rate({service="backend"}|="status_code=5"[5m]))#Quotaexceededevents{service="backend"}|="QUOTA_EXCEEDED"#PIIdetectionhits{service="backend"}|="pii_detected"```###OperationalQueries```logql#Allauditlogwrites{service="backend"}|="audit_log"|="write"#Providerfailoverevents{service="gateway"}|="failover"|json#Creditdeductionevents{service="backend"}|="deduct"|json|__error__=""#Healthcheckfailures{service="backend"}|="health"|="unhealthy"```---##4.Architecture```┌──────────────┐┌──────────────┐┌──────────────┐│Alfred││Alfred││PostgreSQL││Backend││Gateway(Go)││/Redis││(FastAPI)│││││└──────┬───────┘└──────┬───────┘└──────┬───────┘││││stdout/files│stdout/files│exporters│││▼▼▼┌──────────────────────────────────────────────┐│Promtail(collector)││-Dockersocketdiscovery││-Filetail(/var/log/alfred/*.log)││-Labelenrichment(service,level,etc.)││-Healthchecklogfiltering│└──────────────────────┬───────────────────────┘│push▼┌─────────────────┐│GrafanaLoki││-7-dayretention││-TSDBindex││-Compaction│└────────┬────────┘│query▼┌─────────────────┐┌────────────┐│Grafana│◄─────│Prometheus││-Dashboards││-Metrics││-Explore││-15dret.││-Alerts│└────────────┘└─────────────────┘```---##5.LogLabelsPromtailenricheslogswiththeselabelsforefficientquerying:|Label|Source|ExampleValues||-----------|---------------------------|--------------------------------------||`service`|DockerComposeservicename|`backend`,`gateway`,`postgres`||`container`|Containername|`alfred-backend-1`||`level`|ParsedfromlogJSON/text|`info`,`warning`,`error`,`critical`||`logger`|Pythonloggername|`app.routers.proxy`,`app.logic`||`provider`|LLMprovider(gatewaylogs)|`openai`,`anthropic`,`gemini`||`job`|Promtailjobname|`docker`,`alfred-backend`,`system`|---##6.Retention&Storage|Setting|Value||---------------------|----------------------------------------------------||Logretention|7days(configurablein`loki-config.yaml`)||Metricsretention|15days(Prometheus`--storage.tsdb.retention.time`)||Compactioninterval|10minutes||Maxqueryrange|30days||Maxentriesperquery|5000||Ingestionrate|10MB/s|---##7.GrafanaAlertsConfigurealertsinGrafanaforcriticallogpatterns:|Alert|LogQLQuery|Severity||-----------------|-------------------------------------------------------------------|--------||Errorratespike|`sum(rate({service="backend"}\|json\|level="error"[5m]))>10`|Warning||Nologsreceived|`absent_over_time({service="backend"}[10m])`|Critical||Auditchainbreak|`{service="backend"}\|="AUDIT_CHAIN_BREAK"`|Critical||PIIdetected|`{service="backend"}\|="pii_detected"`|Warning||Providerdown|`{service="gateway"}\|="provider_unavailable"`|Error|---##8.IntegrationwithAlfredStack###ConnecttoMainDockerComposeTorunalongsidethemainAlfredstack:```bash#StartAlfredservicesdockercomposeup-d#Startobservabilitystack(separatenetwork,connectsviahost)cddevops/observabilitydockercompose-fdocker-compose.observability.yamlup-d```###StructuredLogginginAlfredBackendAlfred'sPythonbackendshouldusestructuredJSONlogging:```pythonimportloggingimportjsonclassJSONFormatter(logging.Formatter):defformat(self,record):returnjson.dumps({"timestamp":self.formatTime(record),"level":record.levelname,"name":record.name,"message":record.getMessage(),"request_id":getattr(record,"request_id",None),"user_id":getattr(record,"user_id",None),})```---##9.Troubleshooting|Issue|Fix||------------------------|-----------------------------------------------------------||NologsinGrafana|CheckPromtail:`curlhttp://localhost:9080/targets`||Lokinotready|Checkhealth:`curlhttp://localhost:3100/ready`||Highcardinalitywarning|Reducelabelsin`promtail-config.yaml`||Slowqueries|Addtimerangefilter,reduce`max_entries_limit_per_query`||Dockersocketpermission|Addpromtailusertodockergroup|---_AlfredLogAggregation—InternalUseOnly__Version1.0—February2026_