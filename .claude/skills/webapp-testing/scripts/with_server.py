#!/usr/bin/envpython3"""Startoneormoreservers,waitforthemtobeready,runacommand,thencleanup.Usage:#Singleserverpythonscripts/with_server.py--server"npmrundev"--port5173--pythonautomation.pypythonscripts/with_server.py--server"npmstart"--port3000--pythontest.py#Multipleserverspythonscripts/with_server.py\--server"cdbackend&&pythonserver.py"--port3000\--server"cdfrontend&&npmrundev"--port5173\--pythontest.py"""importsubprocessimportsocketimporttimeimportsysimportargparsedefis_server_ready(port,timeout=30):"""Waitforservertobereadybypollingtheport."""start_time=time.time()whiletime.time()-start_time<timeout:try:withsocket.create_connection(('localhost',port),timeout=1):returnTrueexcept(socket.error,ConnectionRefusedError):time.sleep(0.5)returnFalsedefmain():parser=argparse.ArgumentParser(description='Runcommandwithoneormoreservers')parser.add_argument('--server',action='append',dest='servers',required=True,help='Servercommand(canberepeated)')parser.add_argument('--port',action='append',dest='ports',type=int,required=True,help='Portforeachserver(mustmatch--servercount)')parser.add_argument('--timeout',type=int,default=30,help='Timeoutinsecondsperserver(default:30)')parser.add_argument('command',nargs=argparse.REMAINDER,help='Commandtorunafterserver(s)ready')args=parser.parse_args()#Removethe'--'separatorifpresentifargs.commandandargs.command[0]=='--':args.command=args.command[1:]ifnotargs.command:print("Error:Nocommandspecifiedtorun")sys.exit(1)#Parseserverconfigurationsiflen(args.servers)!=len(args.ports):print("Error:Numberof--serverand--portargumentsmustmatch")sys.exit(1)servers=[]forcmd,portinzip(args.servers,args.ports):servers.append({'cmd':cmd,'port':port})server_processes=[]try:#Startallserversfori,serverinenumerate(servers):print(f"Startingserver{i+1}/{len(servers)}:{server['cmd']}")#Useshell=Truetosupportcommandswithcdand&&process=subprocess.Popen(server['cmd'],shell=True,stdout=subprocess.PIPE,stderr=subprocess.PIPE)server_processes.append(process)#Waitforthisservertobereadyprint(f"Waitingforserveronport{server['port']}...")ifnotis_server_ready(server['port'],timeout=args.timeout):raiseRuntimeError(f"Serverfailedtostartonport{server['port']}within{args.timeout}s")print(f"Serverreadyonport{server['port']}")print(f"\nAll{len(servers)}server(s)ready")#Runthecommandprint(f"Running:{''.join(args.command)}\n")result=subprocess.run(args.command)sys.exit(result.returncode)finally:#Cleanupallserversprint(f"\nStopping{len(server_processes)}server(s)...")fori,processinenumerate(server_processes):try:process.terminate()process.wait(timeout=5)exceptsubprocess.TimeoutExpired:process.kill()process.wait()print(f"Server{i+1}stopped")print("Allserversstopped")if__name__=='__main__':main()