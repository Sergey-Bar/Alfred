import{c as W,b as ee,a as _,j as e}from"./index-DmO1ypIk.js";import{r as s}from"./vendor-CoKE50sv.js";import{v as te,E as ae,p as B,X as S,u as se,t as re,f as le,e as ne,A as ie}from"./icons-UwgmH0ZI.js";const C={pending:{label:"Pending",color:"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/40 dark:text-yellow-400"},approved:{label:"Approved",color:"bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-400"},rejected:{label:"Rejected",color:"bg-red-100 text-red-800 dark:bg-red-900/40 dark:text-red-400"},expired:{label:"Expired",color:"bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400"},cancelled:{label:"Cancelled",color:"bg-gray-100 text-gray-500 dark:bg-gray-700 dark:text-gray-500"}},f=20;function xe(){const{user:T}=W(),{showToast:j}=ee(),[G,R]=s.useState([]),[O,U]=s.useState([]),[X,I]=s.useState(!0),[D,N]=s.useState(null),[n,H]=s.useState("all"),[v,Y]=s.useState("all"),[m,A]=s.useState(""),[u,E]=s.useState(""),[c,d]=s.useState(1),[g,Z]=s.useState(0),[i,k]=s.useState(null),[P,J]=s.useState({top:0,left:0}),w=s.useRef(null),[K,h]=s.useState(!1),[l,p]=s.useState({toUserId:"",amount:"",reason:""}),[F,L]=s.useState(!1);s.useEffect(()=>{b(),M()},[c]);async function M(){try{const t=await _.getUsersSimple();U(t.users||t||[])}catch(t){U([]),N(t?.message||"Failed to load users")}}async function Q(t){if(t.preventDefault(),!l.toUserId||!l.amount){j("Please select a recipient and enter an amount","error");return}try{L(!0),await _.createTransfer(l.toUserId,parseInt(l.amount),l.reason),j("Transfer successful!","success"),h(!1),p({toUserId:"",amount:"",reason:""}),b()}catch(r){j(r.message||"Transfer failed","error")}finally{L(!1)}}async function b(){try{I(!0);const t=await _.getTransferHistory({page:c,pageSize:f,status:v!=="all"?v:void 0}),r=t.transfers||t.recent_transfers||t,x=(Array.isArray(r)?r:[]).map(a=>({...a,from_user_name:a.sender||a.from_user_name,to_user_name:a.recipient||a.to_user_name,from_user_id:a.sender_id||a.from_user_id||null,to_user_id:a.recipient_id||a.to_user_id||null,from_user_email:a.sender_email||a.from_user_email||null,to_user_email:a.recipient_email||a.to_user_email||null,created_at:a.timestamp||a.created_at,status:a.status||"approved"}));R(x),Z(t.total??x.length)}catch(t){N(t?.message||"Failed to load transfers"),R([])}finally{I(!1)}}function V(t){return new Date(t).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"})}const $=T?.name||"",o=G.filter(t=>!(n==="sent"&&t.from_user_name!==$||n==="received"&&t.to_user_name!==$||m&&new Date(t.created_at)<new Date(m)||u&&new Date(t.created_at)>new Date(u+"T23:59:59"))),y=Math.max(1,Math.ceil(g/f));function z(t,r,x,a){const q=t.currentTarget.getBoundingClientRect();J({top:q.bottom+window.scrollY+8,left:q.left+window.scrollX}),k({name:r,type:x,email:x==="sender"?a.from_user_email:a.to_user_email,userId:x==="sender"?a.from_user_id:a.to_user_id})}return s.useEffect(()=>{function t(r){w.current&&!w.current.contains(r.target)&&k(null)}return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[]),X?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Credit Reallocation"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:"Manage and track credit reallocations between users"})]}),e.jsxs("button",{onClick:()=>h(!0),className:"btn btn-primary flex items-center",children:[e.jsx(te,{className:"h-5 w-5 mr-2"}),"Reallocate Credits"]})]}),D&&e.jsxs("div",{className:"mb-4 p-3 bg-yellow-50 text-yellow-700 rounded-lg text-sm flex items-center justify-between",children:[e.jsxs("div",{children:["API error: ",D,". Demo data not used."]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:()=>{N(null),b(),M()},className:"btn btn-primary",children:"Retry"}),e.jsx("a",{href:"mailto:support@example.com",className:"btn btn-secondary",children:"Contact Support"})]})]}),e.jsx("div",{className:"card mb-6",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[e.jsx(ae,{className:"h-5 w-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 block mb-1",children:"Direction"}),e.jsx("div",{className:"flex space-x-2",children:["all","sent","received"].map(t=>e.jsx("button",{onClick:()=>{H(t),d(1)},className:`px-3 py-1 text-sm rounded-full ${n===t?"bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-400 font-medium":"bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:t.charAt(0).toUpperCase()+t.slice(1)},t))})]}),e.jsxs("div",{className:"border-l border-gray-200 dark:border-gray-600 pl-4",children:[e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 block mb-1",children:"Status"}),e.jsx("div",{className:"flex space-x-2",children:["all","pending","approved","rejected","expired"].map(t=>e.jsx("button",{onClick:()=>{Y(t),d(1),b()},className:`px-3 py-1 text-sm rounded-full ${v===t?"bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-400 font-medium":"bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:t.charAt(0).toUpperCase()+t.slice(1)},t))})]}),e.jsxs("div",{className:"border-l border-gray-200 dark:border-gray-600 pl-4",children:[e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 block mb-1",children:"Date Range"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(B,{className:"absolute left-2 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx("input",{type:"date",value:m,onChange:t=>{A(t.target.value),d(1)},className:"input pl-8 py-1 text-sm w-36",placeholder:"From"})]}),e.jsx("span",{className:"text-gray-400 text-sm",children:"to"}),e.jsxs("div",{className:"relative",children:[e.jsx(B,{className:"absolute left-2 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx("input",{type:"date",value:u,onChange:t=>{E(t.target.value),d(1)},className:"input pl-8 py-1 text-sm w-36",placeholder:"To"})]}),(m||u)&&e.jsx("button",{onClick:()=>{A(""),E(""),d(1)},className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300",children:e.jsx(S,{className:"h-4 w-4"})})]})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-8",children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("p",{className:"stat-value",children:o.length}),e.jsxs("p",{className:"stat-label",children:[n==="all"?"Total":n==="sent"?"Sent":"Received"," Transfers"]})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("p",{className:"stat-value",children:o.reduce((t,r)=>t+(r.amount||0),0).toLocaleString()}),e.jsxs("p",{className:"stat-label",children:["Total Credits ",n==="sent"?"Sent":n==="received"?"Received":"Reallocated"]})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("p",{className:"stat-value",children:o.length>0?Math.round(o.reduce((t,r)=>t+(r.amount||0),0)/o.length).toLocaleString():0}),e.jsx("p",{className:"stat-label",children:"Average Reallocation"})]})]}),e.jsxs("div",{className:"card relative",children:[e.jsxs("div",{className:"space-y-4",children:[o.map(t=>e.jsxs("div",{className:"flex items-center p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("button",{onClick:r=>z(r,t.from_user_name,"sender",t),className:"font-medium text-gray-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400 cursor-pointer transition-colors text-left",children:t.from_user_name}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Sender"})]}),e.jsx("div",{className:"flex items-center px-6",children:e.jsxs("div",{className:"flex items-center bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-400 px-4 py-2 rounded-full",children:[e.jsx("span",{className:"font-semibold mr-2",children:t.amount?.toLocaleString()}),e.jsx(se,{className:"h-4 w-4"})]})}),e.jsxs("div",{className:"flex-1 text-right",children:[e.jsx("button",{onClick:r=>z(r,t.to_user_name,"recipient",t),className:"font-medium text-gray-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400 cursor-pointer transition-colors text-right",children:t.to_user_name}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Recipient"})]}),e.jsxs("div",{className:"ml-6 text-right w-56",children:[e.jsx("div",{className:"flex items-center justify-end gap-2 mb-1",children:t.status&&C[t.status]&&e.jsxs("span",{className:`inline-flex items-center px-2 py-0.5 text-xs font-medium rounded-full ${C[t.status].color}`,children:[t.status==="pending"&&e.jsx(re,{className:"h-3 w-3 mr-1"}),C[t.status].label]})}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300 truncate",children:t.reason||"No reason provided"}),e.jsx("p",{className:"text-xs text-gray-400 dark:text-gray-500 mt-1",children:V(t.created_at)})]})]},t.id)),o.length===0&&e.jsx("div",{className:"text-center py-12 text-gray-500 dark:text-gray-400",children:n==="all"?"No reallocations found":`No ${n} reallocations found`})]}),y>1&&e.jsxs("div",{className:"flex items-center justify-between mt-6 pt-4 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:["Showing ",Math.min((c-1)*f+1,g),"â€“",Math.min(c*f,g)," of ",g," transfers"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>d(t=>Math.max(1,t-1)),disabled:c===1,className:"btn btn-secondary flex items-center px-3 py-1.5 text-sm disabled:opacity-40",children:[e.jsx(le,{className:"h-4 w-4 mr-1"})," Prev"]}),e.jsxs("span",{className:"text-sm text-gray-600 dark:text-gray-300 px-2",children:["Page ",c," of ",y]}),e.jsxs("button",{onClick:()=>d(t=>Math.min(y,t+1)),disabled:c===y,className:"btn btn-secondary flex items-center px-3 py-1.5 text-sm disabled:opacity-40",children:["Next ",e.jsx(ne,{className:"h-4 w-4 ml-1"})]})]})]})]}),i&&e.jsxs("div",{ref:w,className:"fixed z-50 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 p-4 min-w-64",style:{top:P.top,left:P.left},children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-white",children:[i.type==="sender"?"Sender":"Recipient"," Info"]}),e.jsx("button",{onClick:()=>k(null),className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300",children:e.jsx(S,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Name"}),e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-white",children:i.name})]}),i.email&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Email"}),e.jsx("p",{className:"text-sm text-gray-700 dark:text-gray-300",children:i.email})]}),i.userId&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"User ID"}),e.jsx("p",{className:"text-sm text-gray-700 dark:text-gray-300 font-mono",children:i.userId})]}),!i.email&&!i.userId&&e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 italic",children:"No additional info available"})]})]}),K&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-900 dark:text-white flex items-center",children:[e.jsx(ie,{className:"h-6 w-6 mr-2 text-blue-500"}),"Reallocate Credits"]}),e.jsx("button",{onClick:()=>h(!1),className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300",children:e.jsx(S,{className:"h-6 w-6"})})]}),e.jsxs("form",{onSubmit:Q,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Recipient"}),e.jsxs("select",{value:l.toUserId,onChange:t=>p({...l,toUserId:t.target.value}),className:"input w-full",required:!0,children:[e.jsx("option",{value:"",children:"Select a user..."}),O.filter(t=>t.user_id!==T?.id).map(t=>e.jsxs("option",{value:t.user_id,children:[t.name," (",t.email,")"]},t.user_id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Amount (credits)"}),e.jsx("input",{type:"number",min:"1",value:l.amount,onChange:t=>p({...l,amount:t.target.value}),className:"input w-full",placeholder:"Enter credit amount",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Reason (optional)"}),e.jsx("textarea",{value:l.reason,onChange:t=>p({...l,reason:t.target.value}),className:"input w-full",rows:3,placeholder:"Business justification for this reallocation"})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>h(!1),className:"btn btn-secondary",children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:F,children:F?"Processing...":"Reallocate Credits"})]})]})]})})]})}export{xe as default};
