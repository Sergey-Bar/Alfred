#!/usr/bin/envbash#─────────────────────────────────────────────────────────────set-euopipefail#───Configuration───────────────────────────────────────────NAMESPACE="${NAMESPACE:-alfred}"BACKEND_IMAGE="${BACKEND_IMAGE:-}"GATEWAY_IMAGE="${GATEWAY_IMAGE:-}"HEALTH_CHECK_RETRIES="${HEALTH_CHECK_RETRIES:-30}"HEALTH_CHECK_INTERVAL="${HEALTH_CHECK_INTERVAL:-5}"VALIDATION_DURATION="${VALIDATION_DURATION:-30}"SCALE_DOWN_OLD="${SCALE_DOWN_OLD:-false}"DRY_RUN="${DRY_RUN:-false}"#ColorsRED='\033[0;31m'GREEN='\033[0;32m'YELLOW='\033[1;33m'BLUE='\033[0;34m'NC='\033[0m'#───Functions───────────────────────────────────────────────log(){echo-e"${BLUE}[$(date+'%Y-%m-%d%H:%M:%S')]${NC}$*";}ok(){echo-e"${GREEN}[✓]${NC}$*";}warn(){echo-e"${YELLOW}[!]${NC}$*";}err(){echo-e"${RED}[✗]${NC}$*">&2;}die(){err"$@";exit1;}#Getthecurrentlyactiveslotforaserviceget_active_slot(){localservice="$1"kubectlgetsvc"$service"-n"$NAMESPACE"\-ojsonpath='{.spec.selector.slot}'2>/dev/null||echo"blue"}#Gettheinactiveslotget_inactive_slot(){localactive="$1"if["$active"="blue"];thenecho"green";elseecho"blue";fi}#Updatedeploymentimageupdate_deployment(){localname="$1"localimage="$2"log"Updating$namewithimage:$image"if["$DRY_RUN"="true"];thenlog"[DRYRUN]kubectlsetimagedeployment/$namebackend=$image-n$NAMESPACE"return0fikubectlsetimage"deployment/$name""*=$image"-n"$NAMESPACE"--record}#Waitfordeploymentrolloutwait_for_rollout(){localname="$1"localtimeout="${2:-120}"log"Waitingforrollout:$name(timeout:${timeout}s)"if["$DRY_RUN"="true"];thenlog"[DRYRUN]kubectlrolloutstatusdeployment/$name-n$NAMESPACE--timeout=${timeout}s"return0fikubectlrolloutstatus"deployment/$name"-n"$NAMESPACE"--timeout="${timeout}s"||{err"Rollouttimedoutfor$name"return1}}#Healthcheckviaport-forwardhealth_check(){localservice_name="$1"localtarget_slot="$2"localhealth_path="${3:-/health}"localport="${4:-8000}"localretries="$HEALTH_CHECK_RETRIES"log"Healthchecking${service_name}-${target_slot}${health_path}..."if["$DRY_RUN"="true"];thenlog"[DRYRUN]Wouldcheckhealthof${service_name}-${target_slot}"return0fi#Useatemporarypodtocheckhealthwithintheclusterforiin$(seq1"$retries");dolocalpodpod=$(kubectlgetpods-n"$NAMESPACE"\-l"app=$service_name,slot=$target_slot"\-ojsonpath='{.items[0].metadata.name}'2>/dev/null)if[-z"$pod"];thenwarn"Attempt$i/$retries:Nopodsfoundfor${service_name}/${target_slot}"sleep"$HEALTH_CHECK_INTERVAL"continuefilocalstatusstatus=$(kubectlexec-n"$NAMESPACE""$pod"--\wget-qO--T5"http://localhost:${port}${health_path}"2>/dev/null||true)ifecho"$status"|grep-q'"status"';thenok"Healthcheckpassedfor${service_name}-${target_slot}"return0fiwarn"Attempt$i/$retries:Healthcheckpending..."sleep"$HEALTH_CHECK_INTERVAL"doneerr"HealthcheckFAILEDfor${service_name}-${target_slot}after$retriesattempts"return1}#SwitchtrafficbyupdatingServiceselectorswitch_traffic(){localservice="$1"localtarget_slot="$2"log"Switching$servicetraffictoslot:$target_slot"if["$DRY_RUN"="true"];thenlog"[DRYRUN]kubectlpatchsvc$service-n$NAMESPACE-p'{\"spec\":{\"selector\":{\"slot\":\"$target_slot\"}}}'"return0fikubectlpatchsvc"$service"-n"$NAMESPACE"\-p"{\"spec\":{\"selector\":{\"slot\":\"$target_slot\"}}}"||{err"Failedtoswitchtrafficfor$service"return1}ok"Trafficswitched:$service→$target_slot"}#Scaledownoldslotscale_down(){localname="$1"localreplicas="${2:-0}"log"Scalingdown$nameto$replicasreplicas"if["$DRY_RUN"="true"];thenlog"[DRYRUN]kubectlscaledeployment/$name--replicas=$replicas-n$NAMESPACE"return0fikubectlscale"deployment/$name"--replicas="$replicas"-n"$NAMESPACE"ok"Scaled$nameto$replicas"}#Rollback:switchtrafficbacktooldslotrollback(){localold_slot="$1"warn"ROLLBACKinitiated—switchingtrafficbackto$old_slot"switch_traffic"alfred-backend""$old_slot"switch_traffic"alfred-gateway""$old_slot"ok"Rollbackcomplete—trafficrestoredto$old_slot"exit1}#───Main────────────────────────────────────────────────────usage(){cat<<EOFAlfredBlue-GreenDeploymentScript(T252)Usage:$0[options]Options:--backend-imageIMAGEDockerimageforbackend(e.g.,alfredai/backend:v2.0.0)--gateway-imageIMAGEDockerimageforgateway(e.g.,alfredai/gateway:v2.0.0)--namespaceNSKubernetesnamespace(default:alfred)--health-retriesNHealthcheckretries(default:30)--health-intervalNSecondsbetweenhealthchecks(default:5)--validation-timeNSecondstoobserveafterswitch(default:30)--scale-down-oldScaledownoldslotaftervalidation--dry-runPrintactionswithoutexecuting-h,--helpShowthishelpExamples:#Deploynewbackendversion$0--backend-imagealfredai/backend:v2.1.0#Deploybothservices$0--backend-imagealfredai/backend:v2.1.0--gateway-imagealfredai/gateway:v2.1.0#Dryrun$0--backend-imagealfredai/backend:v2.1.0--dry-runEOF}#Parseargumentswhile[[$#-gt0]];docase"$1"in--backend-image)BACKEND_IMAGE="$2";shift2;;--gateway-image)GATEWAY_IMAGE="$2";shift2;;--namespace)NAMESPACE="$2";shift2;;--health-retries)HEALTH_CHECK_RETRIES="$2";shift2;;--health-interval)HEALTH_CHECK_INTERVAL="$2";shift2;;--validation-time)VALIDATION_DURATION="$2";shift2;;--scale-down-old)SCALE_DOWN_OLD="true";shift;;--dry-run)DRY_RUN="true";shift;;-h|--help)usage;exit0;;*)die"Unknownoption:$1";;esacdone#Validateif[-z"$BACKEND_IMAGE"]&&[-z"$GATEWAY_IMAGE"];thendie"Atleastoneof--backend-imageor--gateway-imagemustbespecified"fiecho""echo"╔════════════════════════════════════════════════════════════╗"echo"║AlfredBlue-GreenDeploymentPipeline(T252)║"echo"╚════════════════════════════════════════════════════════════╝"echo""#───Phase1:DetectCurrentState──────────────────────────log"Phase1:Detectingcurrentdeploymentstate..."BACKEND_ACTIVE=$(get_active_slot"alfred-backend")BACKEND_TARGET=$(get_inactive_slot"$BACKEND_ACTIVE")GATEWAY_ACTIVE=$(get_active_slot"alfred-gateway")GATEWAY_TARGET=$(get_inactive_slot"$GATEWAY_ACTIVE")ok"Backend:active=$BACKEND_ACTIVE,deployingto=$BACKEND_TARGET"ok"Gateway:active=$GATEWAY_ACTIVE,deployingto=$GATEWAY_TARGET"if["$DRY_RUN"="true"];thenwarn"DRYRUNMODE—nochangeswillbemade"fiecho""#───Phase2:DeploytoInactiveSlot───────────────────────log"Phase2:Deployingtoinactiveslots..."if[-n"$BACKEND_IMAGE"];thenupdate_deployment"alfred-backend-$BACKEND_TARGET""$BACKEND_IMAGE"wait_for_rollout"alfred-backend-$BACKEND_TARGET"180fiif[-n"$GATEWAY_IMAGE"];thenupdate_deployment"alfred-gateway-$GATEWAY_TARGET""$GATEWAY_IMAGE"wait_for_rollout"alfred-gateway-$GATEWAY_TARGET"120fiok"Phase2complete:Deploymentsupdated"echo""#───Phase3:HealthValidation──────────────────────────────log"Phase3:Validatinghealthonnewslot..."if[-n"$BACKEND_IMAGE"];thenhealth_check"alfred-backend""$BACKEND_TARGET""/health""8000"||{err"Backendhealthcheckfailed—abortingdeployment"exit1}fiif[-n"$GATEWAY_IMAGE"];thenhealth_check"alfred-gateway""$GATEWAY_TARGET""/healthz""8080"||{err"Gatewayhealthcheckfailed—abortingdeployment"exit1}fiok"Phase3complete:Allhealthcheckspassed"echo""#───Phase4:SwitchTraffic────────────────────────────────log"Phase4:Switchingproductiontraffic..."if[-n"$BACKEND_IMAGE"];thenswitch_traffic"alfred-backend""$BACKEND_TARGET"fiif[-n"$GATEWAY_IMAGE"];thenswitch_traffic"alfred-gateway""$GATEWAY_TARGET"fiok"Phase4complete:Trafficswitched"echo""#───Phase5:Post-SwitchValidation────────────────────────log"Phase5:Monitoringfor${VALIDATION_DURATION}s..."if["$DRY_RUN"!="true"];thensleep"$VALIDATION_DURATION"#Re-checkhealthafterswitchVALIDATION_OK=trueif[-n"$BACKEND_IMAGE"];thenhealth_check"alfred-backend""$BACKEND_TARGET""/health""8000"||VALIDATION_OK=falsefiif[-n"$GATEWAY_IMAGE"];thenhealth_check"alfred-gateway""$GATEWAY_TARGET""/healthz""8080"||VALIDATION_OK=falsefiif["$VALIDATION_OK"!="true"];thenrollback"$BACKEND_ACTIVE"fifiok"Phase5complete:Post-switchvalidationpassed"echo""#───Phase6:Cleanup(Optional)────────────────────────────if["$SCALE_DOWN_OLD"="true"];thenlog"Phase6:Scalingdownoldslot..."if[-n"$BACKEND_IMAGE"];thenscale_down"alfred-backend-$BACKEND_ACTIVE"0fiif[-n"$GATEWAY_IMAGE"];thenscale_down"alfred-gateway-$GATEWAY_ACTIVE"0fiok"Oldslotsscaleddown"elselog"Phase6:Keepingoldslotrunning(use--scale-down-oldtocleanup)"warn"Oldslot($BACKEND_ACTIVE)isstillrunning—instantrollbackavailable"fiecho""echo"╔════════════════════════════════════════════════════════════╗"echo"║✅Blue-GreenDeploymentComplete!║"echo"╠════════════════════════════════════════════════════════════╣"echo"║Activeslot:$BACKEND_TARGET║"echo"║Rollback:$0--rollback-to$BACKEND_ACTIVE║"echo"╚════════════════════════════════════════════════════════════╝"