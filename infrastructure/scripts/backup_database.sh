#!/usr/bin/envbashset-euopipefail#───Configuration(overrideviaenvvars)───────────────────PGHOST="${PGHOST:-localhost}"PGPORT="${PGPORT:-5432}"PGUSER="${PGUSER:-postgres}"PGPASSWORD="${PGPASSWORD:-postgres}"PGDATABASE="${PGDATABASE:-ao}"BACKUP_DIR="${BACKUP_DIR:-/var/backups/alfred}"BACKUP_RETENTION_DAYS="${BACKUP_RETENTION_DAYS:-7}"BACKUP_RETENTION_HOURLY="${BACKUP_RETENTION_HOURLY:-24}"S3_BUCKET="${S3_BUCKET:-}"S3_PREFIX="${S3_PREFIX:-alfred/backups}"TIMESTAMP=$(date-u+"%Y%m%d_%H%M%S")BACKUP_FORMAT="${BACKUP_FORMAT:-custom}"#custom(pg_restore)orplain(SQL)LOG_FILE="${BACKUP_DIR}/backup.log"#───ColorOutput────────────────────────────────────────────RED='\033[0;31m'GREEN='\033[0;32m'YELLOW='\033[1;33m'NC='\033[0m'log_info(){echo-e"${GREEN}[INFO]${NC}$(date-u+%H:%M:%S)$*"|tee-a"$LOG_FILE";}log_warn(){echo-e"${YELLOW}[WARN]${NC}$(date-u+%H:%M:%S)$*"|tee-a"$LOG_FILE";}log_error(){echo-e"${RED}[ERROR]${NC}$(date-u+%H:%M:%S)$*"|tee-a"$LOG_FILE";}#───Pre-flightChecks──────────────────────────────────────preflight(){mkdir-p"$BACKUP_DIR"if!command-vpg_dump&>/dev/null;thenlog_error"pg_dumpnotfound.Installpostgresql-client."exit1fiif!PGPASSWORD="$PGPASSWORD"pg_isready-h"$PGHOST"-p"$PGPORT"-U"$PGUSER"-d"$PGDATABASE"-q2>/dev/null;thenlog_error"CannotconnecttoPostgreSQLat${PGHOST}:${PGPORT}/${PGDATABASE}"exit1filog_info"Pre-flightOK:PostgreSQLreachableat${PGHOST}:${PGPORT}/${PGDATABASE}"}#───BackupFunction────────────────────────────────────────do_backup(){localschema_only="${1:-false}"localext="dump"localformat_flag="-Fc"if["$BACKUP_FORMAT"="plain"];thenext="sql"format_flag="-Fp"filocalbackup_name="alfred_${PGDATABASE}_${TIMESTAMP}"if["$schema_only"="true"];thenbackup_name="${backup_name}_schema"filocalbackup_file="${BACKUP_DIR}/${backup_name}.${ext}"localchecksum_file="${BACKUP_DIR}/${backup_name}.sha256"log_info"Startingbackup:${backup_name}.${ext}"log_info"Host:${PGHOST}:${PGPORT}|DB:${PGDATABASE}|Format:${BACKUP_FORMAT}"localstart_timestart_time=$(date+%s)localdump_args=(-h"$PGHOST"-p"$PGPORT"-U"$PGUSER""$format_flag"--verbose--no-password)if["$schema_only"="true"];thendump_args+=(--schema-only)fidump_args+=("$PGDATABASE")PGPASSWORD="$PGPASSWORD"pg_dump"${dump_args[@]}">"$backup_file"2>>"$LOG_FILE"localend_timeend_time=$(date+%s)localduration=$((end_time-start_time))localsizesize=$(du-h"$backup_file"|cut-f1)#GenerateSHA-256checksumsha256sum"$backup_file">"$checksum_file"log_info"Backupcomplete:${backup_file}"log_info"Size:${size}|Duration:${duration}s"log_info"Checksum:$(cat"$checksum_file")"#Createlatestsymlinklocallatest_link="${BACKUP_DIR}/alfred_latest.${ext}"ln-sf"$backup_file""$latest_link"echo"$backup_file"}#───UploadtoS3───────────────────────────────────────────upload_s3(){localbackup_file="$1"if[-z"$S3_BUCKET"];thenlog_warn"S3_BUCKETnotset,skippingS3upload"return0fiif!command-vaws&>/dev/null;thenlog_error"AWSCLInotfound.InstallawscliforS3upload."return1filocals3_path="s3://${S3_BUCKET}/${S3_PREFIX}/$(basename"$backup_file")"localchecksum_file="${backup_file%.dump}.sha256"[!-f"$checksum_file"]&&checksum_file="${backup_file%.sql}.sha256"log_info"UploadingtoS3:${s3_path}"awss3cp"$backup_file""$s3_path"\--storage-classSTANDARD_IA\--metadata"timestamp=${TIMESTAMP},database=${PGDATABASE}"\2>>"$LOG_FILE"if[-f"$checksum_file"];thenawss3cp"$checksum_file""${s3_path}.sha256"2>>"$LOG_FILE"filog_info"S3uploadcomplete:${s3_path}"}#───RetentionCleanup──────────────────────────────────────cleanup_old_backups(){log_info"Cleaningupbackupsolderthan${BACKUP_RETENTION_DAYS}days..."localcountcount=$(find"$BACKUP_DIR"-name"alfred_*.dump"-o-name"alfred_*.sql"-mtime+"$BACKUP_RETENTION_DAYS"2>/dev/null|wc-l)find"$BACKUP_DIR"\(-name"alfred_*.dump"-o-name"alfred_*.sql"-o-name"alfred_*.sha256"\)\-mtime+"$BACKUP_RETENTION_DAYS"\-delete2>/dev/null||truelog_info"Removed${count}oldbackupfiles"#AlsocleanS3ifconfiguredif[-n"$S3_BUCKET"]&&command-vaws&>/dev/null;thenlog_info"CleaningoldS3backups(lifecyclepolicyrecommendedinstead)"fi}#───InstallCronJob───────────────────────────────────────install_cron(){localscript_pathscript_path=$(readlink-f"$0")localcron_entry="0****${script_path}>>${LOG_FILE}2>&1"#Checkifalreadyinstalledifcrontab-l2>/dev/null|grep-q"alfred_backup\|backup_database.sh";thenlog_warn"Cronjobalreadyexists.Updating..."crontab-l2>/dev/null|grep-v"alfred_backup\|backup_database.sh"|crontab-fi(crontab-l2>/dev/null;echo"#AlfredDBbackup(hourly)-T256";echo"$cron_entry")|crontab-log_info"Cronjobinstalled:hourlybackup"log_info"Entry:${cron_entry}"log_info"Verify:crontab-l"}#───DockerSupport──────────────────────────────────────────do_docker_backup(){localcontainer="${DOCKER_CONTAINER:-$(dockercomposeps-qpostgres2>/dev/null||echo"")}"if[-z"$container"];thenlog_error"Nopostgrescontainerfound.SetDOCKER_CONTAINERorensuredockercomposeisrunning."exit1filocalbackup_name="alfred_${PGDATABASE}_${TIMESTAMP}.dump"localbackup_file="${BACKUP_DIR}/${backup_name}"localchecksum_file="${BACKUP_DIR}/${backup_name%.dump}.sha256"mkdir-p"$BACKUP_DIR"log_info"StartingDockerbackupfromcontainer:${container}"localstart_timestart_time=$(date+%s)dockerexec"$container"pg_dump\-U"$PGUSER"\-Fc\"$PGDATABASE">"$backup_file"2>>"$LOG_FILE"localend_timeend_time=$(date+%s)localduration=$((end_time-start_time))localsizesize=$(du-h"$backup_file"|cut-f1)sha256sum"$backup_file">"$checksum_file"log_info"Dockerbackupcomplete:${backup_file}"log_info"Size:${size}|Duration:${duration}s"echo"$backup_file"}#───Main────────────────────────────────────────────────────main(){localschema_only=falselocalupload_s3=falselocalinstall_cron_flag=falselocaldocker_mode=falseforargin"$@";docase"$arg"in--schema-only)schema_only=true;;--upload-s3)upload_s3=true;;--install-cron)install_cron_flag=true;;--docker)docker_mode=true;;--help|-h)echo"Usage:$0[--schema-only][--upload-s3][--install-cron][--docker]"echo""echo"Environmentvariables:"echo"PGHOST,PGPORT,PGUSER,PGPASSWORD,PGDATABASE"echo"BACKUP_DIRBackupdirectory(default:/var/backups/alfred)"echo"BACKUP_RETENTION_DAYSDaystokeepbackups(default:7)"echo"S3_BUCKETS3bucketforremotestorage"echo"S3_PREFIXS3keyprefix(default:alfred/backups)"echo"DOCKER_CONTAINERDockercontainernameforpg_dump"exit0;;*)log_error"Unknownargument:$arg";exit1;;esacdoneif["$install_cron_flag"="true"];theninstall_cronexit0fimkdir-p"$BACKUP_DIR"localbackup_fileif["$docker_mode"="true"];thenbackup_file=$(do_docker_backup)elsepreflightbackup_file=$(do_backup"$schema_only")fiif["$upload_s3"="true"];thenupload_s3"$backup_file"ficleanup_old_backupslog_info"=========================================="log_info"Backuppipelinecomplete"log_info"File:${backup_file}"log_info"=========================================="}main"$@"