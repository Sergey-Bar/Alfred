#!/usr/bin/envbashset-euopipefail#───Configuration(overrideviaenvvars)───────────────────PGHOST="${PGHOST:-localhost}"PGPORT="${PGPORT:-5432}"PGUSER="${PGUSER:-postgres}"PGPASSWORD="${PGPASSWORD:-postgres}"PGDATABASE="${PGDATABASE:-ao}"BACKUP_DIR="${BACKUP_DIR:-/var/backups/alfred}"S3_BUCKET="${S3_BUCKET:-}"S3_PREFIX="${S3_PREFIX:-alfred/backups}"LOG_FILE="${BACKUP_DIR}/restore.log"#Safety:requireexplicitconfirmationforproductionCONFIRM_RESTORE="${CONFIRM_RESTORE:-false}"PRODUCTION="${PRODUCTION:-false}"#───ColorOutput────────────────────────────────────────────RED='\033[0;31m'GREEN='\033[0;32m'YELLOW='\033[1;33m'CYAN='\033[0;36m'NC='\033[0m'log_info(){echo-e"${GREEN}[INFO]${NC}$(date-u+%H:%M:%S)$*"|tee-a"$LOG_FILE";}log_warn(){echo-e"${YELLOW}[WARN]${NC}$(date-u+%H:%M:%S)$*"|tee-a"$LOG_FILE";}log_error(){echo-e"${RED}[ERROR]${NC}$(date-u+%H:%M:%S)$*"|tee-a"$LOG_FILE";}log_step(){echo-e"${CYAN}[STEP]${NC}$(date-u+%H:%M:%S)$*"|tee-a"$LOG_FILE";}#───Pre-flightChecks──────────────────────────────────────preflight(){mkdir-p"$BACKUP_DIR"if!command-vpg_restore&>/dev/null;thenlog_error"pg_restorenotfound.Installpostgresql-client."exit1fiif!PGPASSWORD="$PGPASSWORD"pg_isready-h"$PGHOST"-p"$PGPORT"-U"$PGUSER"-q2>/dev/null;thenlog_error"CannotconnecttoPostgreSQLat${PGHOST}:${PGPORT}"exit1filog_info"Pre-flightOK:PostgreSQLreachable"}#───VerifyBackupIntegrity────────────────────────────────verify_backup(){localbackup_file="$1"if[!-f"$backup_file"];thenlog_error"Backupfilenotfound:${backup_file}"return1filocalsizesize=$(du-h"$backup_file"|cut-f1)log_info"Backupfile:${backup_file}(${size})"#Checkfiletypelocalfile_typefile_type=$(file-b"$backup_file"2>/dev/null||echo"unknown")log_info"Filetype:${file_type}"#Verifychecksumif.sha256fileexistslocalchecksum_file="${backup_file%.dump}.sha256"[!-f"$checksum_file"]&&checksum_file="${backup_file}.sha256"if[-f"$checksum_file"];thenlog_step"VerifyingSHA-256checksum..."ifsha256sum-c"$checksum_file"2>/dev/null;thenlog_info"Checksumverification:PASSED"elselog_error"Checksumverification:FAILED"return1fielselog_warn"Nochecksumfilefound.Skippingintegritycheck."fi#Forcustomformat,trylistingcontentsif[["$backup_file"==*.dump]];thenlog_step"Listingbackupcontents..."ifPGPASSWORD="$PGPASSWORD"pg_restore-l"$backup_file">/dev/null2>&1;thenlocaltable_counttable_count=$(PGPASSWORD="$PGPASSWORD"pg_restore-l"$backup_file"2>/dev/null|grep-c"TABLE"||echo"0")log_info"Backupcontains~${table_count}tables"log_info"Backupintegrity:OK"elselog_error"pg_restore-lfailed.Backupmaybecorrupt."return1fifireturn0}#───DownloadfromS3───────────────────────────────────────fetch_from_s3(){localbackup_name="$1"locallocal_path="${BACKUP_DIR}/${backup_name}"if[-z"$S3_BUCKET"];thenlog_error"S3_BUCKETnotset"exit1fiif!command-vaws&>/dev/null;thenlog_error"AWSCLInotfound"exit1filocals3_path="s3://${S3_BUCKET}/${S3_PREFIX}/${backup_name}"log_step"DownloadingfromS3:${s3_path}"awss3cp"$s3_path""$local_path"2>>"$LOG_FILE"#Alsofetchchecksumifavailableawss3cp"${s3_path}.sha256""${local_path}.sha256"2>/dev/null||truelog_info"Downloaded:${local_path}"echo"$local_path"}#───ProductionSafetyCheck────────────────────────────────safety_check(){if["$PRODUCTION"="true"]&&["$CONFIRM_RESTORE"!="true"];thenecho""echo-e"${RED}╔═══════════════════════════════════════════════════╗${NC}"echo-e"${RED}║⚠️PRODUCTIONRESTORE—DESTRUCTIVEOPERATION║${NC}"echo-e"${RED}╠═══════════════════════════════════════════════════╣${NC}"echo-e"${RED}║Database:${PGDATABASE}║${NC}"echo-e"${RED}║Host:${PGHOST}:${PGPORT}║${NC}"echo-e"${RED}║║${NC}"echo-e"${RED}║ThiswillDROPandRECREATEthedatabase.║${NC}"echo-e"${RED}║ALLexistingdatawillbeLOST.║${NC}"echo-e"${RED}╚═══════════════════════════════════════════════════╝${NC}"echo""read-p"Type'RESTORE'toconfirm:"confirmif["$confirm"!="RESTORE"];thenlog_info"Restorecancelledbyuser"exit0fifi}#───RestoreFunction───────────────────────────────────────do_restore(){localbackup_file="$1"log_step"Phase1/4:Pre-restorevalidation"verify_backup"$backup_file"||exit1safety_checklocalstart_timestart_time=$(date+%s)log_step"Phase2/4:Terminatingactiveconnections"PGPASSWORD="$PGPASSWORD"psql-h"$PGHOST"-p"$PGPORT"-U"$PGUSER"-dpostgres-c\"SELECTpg_terminate_backend(pid)FROMpg_stat_activityWHEREdatname='${PGDATABASE}'ANDpid<>pg_backend_pid();"\2>>"$LOG_FILE"||truelog_step"Phase3/4:Droppingandrecreatingdatabase"PGPASSWORD="$PGPASSWORD"psql-h"$PGHOST"-p"$PGPORT"-U"$PGUSER"-dpostgres-c\"DROPDATABASEIFEXISTS${PGDATABASE};"2>>"$LOG_FILE"PGPASSWORD="$PGPASSWORD"psql-h"$PGHOST"-p"$PGPORT"-U"$PGUSER"-dpostgres-c\"CREATEDATABASE${PGDATABASE}OWNER${PGUSER};"2>>"$LOG_FILE"log_step"Phase4/4:Restoringfrombackup"if[["$backup_file"==*.dump]];thenPGPASSWORD="$PGPASSWORD"pg_restore\-h"$PGHOST"\-p"$PGPORT"\-U"$PGUSER"\-d"$PGDATABASE"\--verbose\--no-owner\--no-privileges\--jobs=4\"$backup_file"2>>"$LOG_FILE"||true#pg_restorereturnsnon-zeroforwarnings;checkDBstateinsteadelif[["$backup_file"==*.sql]];thenPGPASSWORD="$PGPASSWORD"psql\-h"$PGHOST"\-p"$PGPORT"\-U"$PGUSER"\-d"$PGDATABASE"\-f"$backup_file"2>>"$LOG_FILE"elselog_error"Unknownbackupformat:${backup_file}"exit1filocalend_timeend_time=$(date+%s)localduration=$((end_time-start_time))log_info"Restorecompletein${duration}seconds"#Post-restoreverificationpost_restore_verify}#───DockerRestore──────────────────────────────────────────do_docker_restore(){localbackup_file="$1"localcontainer="${DOCKER_CONTAINER:-$(dockercomposeps-qpostgres2>/dev/null||echo"")}"if[-z"$container"];thenlog_error"Nopostgrescontainerfound"exit1filog_step"Phase1/3:Verifyingbackup"verify_backup"$backup_file"||exit1safety_checklocalstart_timestart_time=$(date+%s)log_step"Phase2/3:Droppingandrecreatingdatabaseincontainer"dockerexec"$container"psql-U"$PGUSER"-dpostgres-c\"SELECTpg_terminate_backend(pid)FROMpg_stat_activityWHEREdatname='${PGDATABASE}'ANDpid<>pg_backend_pid();"\2>/dev/null||truedockerexec"$container"psql-U"$PGUSER"-dpostgres-c\"DROPDATABASEIFEXISTS${PGDATABASE};"2>>"$LOG_FILE"dockerexec"$container"psql-U"$PGUSER"-dpostgres-c\"CREATEDATABASE${PGDATABASE}OWNER${PGUSER};"2>>"$LOG_FILE"log_step"Phase3/3:Restoringfrombackup"cat"$backup_file"|dockerexec-i"$container"pg_restore\-U"$PGUSER"\-d"$PGDATABASE"\--verbose\--no-owner\--no-privileges\--jobs=2\2>>"$LOG_FILE"||truelocalend_timeend_time=$(date+%s)localduration=$((end_time-start_time))log_info"Dockerrestorecompletein${duration}seconds"}#───Post-RestoreVerification───────────────────────────────post_restore_verify(){log_step"Post-restoreverification..."#Checktablecountlocaltable_counttable_count=$(PGPASSWORD="$PGPASSWORD"psql-h"$PGHOST"-p"$PGPORT"-U"$PGUSER"-d"$PGDATABASE"-tAc\"SELECTCOUNT(*)FROMinformation_schema.tablesWHEREtable_schema='public';"2>/dev/null||echo"0")log_info"Tablesrestored:${table_count}"#Checkcriticaltablesexistlocalcritical_tables=("user""team""audit_log""request_log""token_transfer")fortablein"${critical_tables[@]}";dolocalexistsexists=$(PGPASSWORD="$PGPASSWORD"psql-h"$PGHOST"-p"$PGPORT"-U"$PGUSER"-d"$PGDATABASE"-tAc\"SELECTEXISTS(SELECT1FROMinformation_schema.tablesWHEREtable_schema='public'ANDtable_name='${table}');"2>/dev/null||echo"f")if["$exists"="t"];thenlog_info"✓Table'${table}'present"elselog_warn"✗Table'${table}'missing"fidone#Checkrowcountsforcriticaltableslog_info"Rowcounts:"fortablein"${critical_tables[@]}";dolocalcountcount=$(PGPASSWORD="$PGPASSWORD"psql-h"$PGHOST"-p"$PGPORT"-U"$PGUSER"-d"$PGDATABASE"-tAc\"SELECTCOUNT(*)FROM\"${table}\";"2>/dev/null||echo"N/A")log_info"${table}:${count}rows"donelog_info"Post-restoreverificationcomplete"log_info"IMPORTANT:Verifyauditlogchainintegrity:"log_info"curl-XPOSThttp://localhost:8080/v1/admin/audit-logs/verify-H'Authorization:Bearer<admin-key>'"}#───FindLatestBackup─────────────────────────────────────find_latest(){locallatestlatest=$(ls-t"${BACKUP_DIR}"/alfred_*.dump2>/dev/null|head-1)if[-z"$latest"];thenlatest=$(ls-t"${BACKUP_DIR}"/alfred_*.sql2>/dev/null|head-1)fiif[-z"$latest"];thenlog_error"Nobackupfilesfoundin${BACKUP_DIR}"exit1fiecho"$latest"}#───Main────────────────────────────────────────────────────main(){localverify_only=falselocalfrom_s3=falselocaluse_latest=falselocaldocker_mode=falselocalbackup_file=""forargin"$@";docase"$arg"in--verify-only)verify_only=true;;--from-s3)from_s3=true;;--latest)use_latest=true;;--docker)docker_mode=true;;--help|-h)echo"Usage:$0[options][backup_file]"echo""echo"Options:"echo"--latestRestorethemostrecentlocalbackup"echo"--from-s3DownloadbackupfromS3beforerestore"echo"--verify-onlyOnlyverifybackupintegrity,don'trestore"echo"--dockerRestoreintoDockercontainer"echo""echo"Environmentvariables:"echo"PGHOST,PGPORT,PGUSER,PGPASSWORD,PGDATABASE"echo"BACKUP_DIRBackupdirectory(default:/var/backups/alfred)"echo"S3_BUCKETS3bucketforremotestorage"echo"PRODUCTION=trueRequireinteractiveconfirmation"echo"CONFIRM_RESTORE=trueSkipinteractiveprompt(forautomation)"exit0;;--*)log_error"Unknownoption:$arg";exit1;;*)backup_file="$arg";;esacdonemkdir-p"$BACKUP_DIR"#Determinebackupfileif["$use_latest"="true"];thenbackup_file=$(find_latest)log_info"Usinglatestbackup:${backup_file}"elif["$from_s3"="true"]&&[-n"$backup_file"];thenbackup_file=$(fetch_from_s3"$backup_file")fiif[-z"$backup_file"];thenlog_error"Nobackupfilespecified.Use--latestorprovideafilepath."echo"Usage:$0[--latest|--from-s3<name>|<file>]"exit1fiif["$verify_only"="true"];thenverify_backup"$backup_file"exit$?fiif["$docker_mode"="true"];thendo_docker_restore"$backup_file"elsepreflightdo_restore"$backup_file"filog_info"=========================================="log_info"Restorepipelinecomplete"log_info"Target:${PGHOST}:${PGPORT}/${PGDATABASE}"log_info"=========================================="}main"$@"