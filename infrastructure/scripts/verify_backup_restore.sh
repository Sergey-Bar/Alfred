#!/usr/bin/envbashset-euopipefail#───Configuration───────────────────────────────────────────PGHOST="${PGHOST:-localhost}"PGPORT="${PGPORT:-5432}"PGUSER="${PGUSER:-postgres}"PGPASSWORD="${PGPASSWORD:-postgres}"PGDATABASE="${PGDATABASE:-ao}"TEST_DB="alfred_backup_test_$$"BACKUP_DIR="${BACKUP_DIR:-/tmp/alfred_backup_test}"SCRIPT_DIR="$(cd"$(dirname"${BASH_SOURCE[0]}")"&&pwd)"#───ColorOutput────────────────────────────────────────────RED='\033[0;31m'GREEN='\033[0;32m'YELLOW='\033[1;33m'NC='\033[0m'pass(){echo-e"${GREEN}[PASS]${NC}$*";}fail(){echo-e"${RED}[FAIL]${NC}$*";FAILURES=$((FAILURES+1));}info(){echo-e"${YELLOW}[TEST]${NC}$*";}FAILURES=0TESTS=0#───Cleanup─────────────────────────────────────────────────cleanup(){info"Cleaningup..."PGPASSWORD="$PGPASSWORD"psql-h"$PGHOST"-p"$PGPORT"-U"$PGUSER"-dpostgres-c\"DROPDATABASEIFEXISTS${TEST_DB};"2>/dev/null||truePGPASSWORD="$PGPASSWORD"psql-h"$PGHOST"-p"$PGPORT"-U"$PGUSER"-dpostgres-c\"DROPDATABASEIFEXISTS${TEST_DB}_restored;"2>/dev/null||truerm-rf"$BACKUP_DIR"2>/dev/null||true}trapcleanupEXIT#───TestRunner─────────────────────────────────────────────run_test(){localname="$1"TESTS=$((TESTS+1))info"Test${TESTS}:${name}"}#───Test1:BackupScriptCreatesValidDump────────────────test_backup_creates_dump(){run_test"Backupscriptcreatesvaliddumpfile"#CreatetestdatabasewithknowndataPGPASSWORD="$PGPASSWORD"psql-h"$PGHOST"-p"$PGPORT"-U"$PGUSER"-dpostgres-c\"CREATEDATABASE${TEST_DB};"2>/dev/nullPGPASSWORD="$PGPASSWORD"psql-h"$PGHOST"-p"$PGPORT"-U"$PGUSER"-d"$TEST_DB"<<EOFCREATETABLEtest_users(idSERIALPRIMARYKEY,nameVARCHAR(100)NOTNULL,emailVARCHAR(255)UNIQUENOTNULL,creditsDECIMAL(12,2)DEFAULT0.00,created_atTIMESTAMPDEFAULTNOW());CREATETABLEtest_audit_log(idSERIALPRIMARYKEY,actionVARCHAR(50)NOTNULL,user_idINTREFERENCEStest_users(id),detailsJSONB,created_atTIMESTAMPDEFAULTNOW());INSERTINTOtest_users(name,email,credits)VALUES('Alice','alice@test.com',1000.00),('Bob','bob@test.com',500.50),('Charlie','charlie@test.com',250.75);INSERTINTOtest_audit_log(action,user_id,details)VALUES('create_user',1,'{"source":"test"}'),('deduct_credits',2,'{"amount":100.00}'),('topup',3,'{"amount":250.75}');EOFmkdir-p"$BACKUP_DIR"#RunbackupPGDATABASE="$TEST_DB"BACKUP_DIR="$BACKUP_DIR"\bash"${SCRIPT_DIR}/backup_database.sh"2>/dev/null#Verifydumpfileexistslocaldump_countdump_count=$(find"$BACKUP_DIR"-name"alfred_*.dump"|wc-l)if["$dump_count"-gt0];thenpass"Dumpfilecreated(${dump_count}files)"elsefail"Nodumpfilecreated"return1fi#Verifychecksumfileexistslocalchecksum_countchecksum_count=$(find"$BACKUP_DIR"-name"*.sha256"|wc-l)if["$checksum_count"-gt0];thenpass"Checksumfilecreated"elsefail"Nochecksumfilecreated"fi}#───Test2:ChecksumVerificationPasses────────────────────test_checksum_verification(){run_test"SHA-256checksumverificationpasses"localdump_filedump_file=$(find"$BACKUP_DIR"-name"alfred_*.dump"|head-1)localchecksum_file="${dump_file%.dump}.sha256"if[!-f"$checksum_file"];then#Tryalternatenamingchecksum_file=$(find"$BACKUP_DIR"-name"*.sha256"|head-1)fiif[-f"$checksum_file"];thencd"$BACKUP_DIR"ifsha256sum-c"$checksum_file"2>/dev/null;thenpass"Checksummatches"elsefail"Checksummismatch"ficd->/dev/nullelsefail"Nochecksumfiletoverify"fi}#───Test3:pg_restoreCanReadDump────────────────────────test_dump_readable(){run_test"pg_restorecanlistdumpcontents"localdump_filedump_file=$(find"$BACKUP_DIR"-name"alfred_*.dump"|head-1)ifpg_restore-l"$dump_file">/dev/null2>&1;thenlocaltable_counttable_count=$(pg_restore-l"$dump_file"2>/dev/null|grep-c"TABLE"||echo"0")pass"Dumpreadable(${table_count}tables)"elsefail"pg_restorecannotreaddump"fi}#───Test4:RestoreRecoversAllData──────────────────────test_restore_recovers_data(){run_test"Restorerecoversalldatacorrectly"localdump_filedump_file=$(find"$BACKUP_DIR"-name"alfred_*.dump"|head-1)#CreaterestorationtargetPGPASSWORD="$PGPASSWORD"psql-h"$PGHOST"-p"$PGPORT"-U"$PGUSER"-dpostgres-c\"CREATEDATABASE${TEST_DB}_restored;"2>/dev/null#RestorePGPASSWORD="$PGPASSWORD"pg_restore\-h"$PGHOST"\-p"$PGPORT"\-U"$PGUSER"\-d"${TEST_DB}_restored"\--no-owner\--no-privileges\"$dump_file"2>/dev/null||true#Verifyusercountlocaluser_countuser_count=$(PGPASSWORD="$PGPASSWORD"psql-h"$PGHOST"-p"$PGPORT"-U"$PGUSER"-d"${TEST_DB}_restored"-tAc\"SELECTCOUNT(*)FROMtest_users;"2>/dev/null)if["$user_count"="3"];thenpass"Usercountmatches(3)"elsefail"Usercountmismatch:expected3,got${user_count}"fi#Verifyspecificdatalocalalice_creditsalice_credits=$(PGPASSWORD="$PGPASSWORD"psql-h"$PGHOST"-p"$PGPORT"-U"$PGUSER"-d"${TEST_DB}_restored"-tAc\"SELECTcreditsFROMtest_usersWHEREemail='alice@test.com';"2>/dev/null|tr-d'')if["$alice_credits"="1000.00"];thenpass"Creditvaluespreserved(Alice=1000.00)"elsefail"Creditvalueschanged:expected1000.00,got${alice_credits}"fi#Verifyauditlogcountlocalaudit_countaudit_count=$(PGPASSWORD="$PGPASSWORD"psql-h"$PGHOST"-p"$PGPORT"-U"$PGUSER"-d"${TEST_DB}_restored"-tAc\"SELECTCOUNT(*)FROMtest_audit_log;"2>/dev/null)if["$audit_count"="3"];thenpass"Auditlogentriespreserved(3)"elsefail"Auditlogcountmismatch:expected3,got${audit_count}"fi#VerifyJSONBdatalocaljsonb_datajsonb_data=$(PGPASSWORD="$PGPASSWORD"psql-h"$PGHOST"-p"$PGPORT"-U"$PGUSER"-d"${TEST_DB}_restored"-tAc\"SELECTdetails->>'source'FROMtest_audit_logWHEREaction='create_user';"2>/dev/null|tr-d'')if["$jsonb_data"="test"];thenpass"JSONBdatapreservedcorrectly"elsefail"JSONBdatachanged:expected'test',got'${jsonb_data}'"fi}#───Test5:RestoreDurationUnderRTO─────────────────────test_restore_under_rto(){run_test"Restorecompletesunder15-minuteRTO"#ForthissmalltestDB,restoreshouldbenear-instant#Inproduction,thisvalidatestheRTOSLAlocalrto_seconds=900#15minuteslocalstart_timestart_time=$(date+%s)localdump_filedump_file=$(find"$BACKUP_DIR"-name"alfred_*.dump"|head-1)#DropandrecreatePGPASSWORD="$PGPASSWORD"psql-h"$PGHOST"-p"$PGPORT"-U"$PGUSER"-dpostgres-c\"DROPDATABASEIFEXISTS${TEST_DB}_restored;"2>/dev/nullPGPASSWORD="$PGPASSWORD"psql-h"$PGHOST"-p"$PGPORT"-U"$PGUSER"-dpostgres-c\"CREATEDATABASE${TEST_DB}_restored;"2>/dev/nullPGPASSWORD="$PGPASSWORD"pg_restore\-h"$PGHOST"\-p"$PGPORT"\-U"$PGUSER"\-d"${TEST_DB}_restored"\--no-owner\--no-privileges\--jobs=4\"$dump_file"2>/dev/null||truelocalend_timeend_time=$(date+%s)localduration=$((end_time-start_time))if["$duration"-lt"$rto_seconds"];thenpass"Restorecompletedin${duration}s(RTO:${rto_seconds}s)"elsefail"Restoretook${duration}s,exceeds${rto_seconds}sRTO"fi}#───Test6:LatestSymlinkWorks───────────────────────────test_latest_symlink(){run_test"Latestbackupsymlinkisupdated"if[-L"${BACKUP_DIR}/alfred_latest.dump"];thenpass"Latestsymlinkexistsandisvalid"elsefail"Latestsymlinknotfound"fi}#───Main────────────────────────────────────────────────────main(){echo""echo"╔═══════════════════════════════════════════════════╗"echo"║AlfredBackup/RestoreVerificationTest║"echo"║SOC2CC9.1-02—MonthlyBackupValidation║"echo"╚═══════════════════════════════════════════════════╝"echo""#Pre-flightif!PGPASSWORD="$PGPASSWORD"pg_isready-h"$PGHOST"-p"$PGPORT"-U"$PGUSER"-q2>/dev/null;thenecho-e"${RED}CannotconnecttoPostgreSQLat${PGHOST}:${PGPORT}${NC}"echo"EnsurePostgreSQLisrunningorsetPGHOST/PGPORT/PGUSER/PGPASSWORD"exit1fi#Runteststest_backup_creates_dumptest_checksum_verificationtest_dump_readabletest_restore_recovers_datatest_restore_under_rtotest_latest_symlink#Summaryecho""echo"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"if["$FAILURES"-eq0];thenecho-e"${GREEN}All${TESTS}testspassed!${NC}"echo"Backup/restoreverification:PASSED"echo"Date:$(date-u+"%Y-%m-%d%H:%M:%SUTC")"elseecho-e"${RED}${FAILURES}/${TESTS}testsFAILED${NC}"echo"Backup/restoreverification:FAILED"exit1fiecho"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"}main"$@"