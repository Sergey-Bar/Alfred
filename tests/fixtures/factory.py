from__future__importannotationsimporthashlibimportsecretsimportstringimportuuidfromdatetimeimportdatetime,timedelta,timezonefromtypingimportAnyclassFactory:"""TestdatafactoryforAlfreddomainobjects.Allmethodsreturnplaindictsbydefaultformaximumportabilityacrossunit,integration,andE2Etestsuites.Use`as_model=True`whereORMmodelinstancesareneeded(requiresapp.modelsimport)."""_counter:int=0@classmethoddef_next_id(cls)->int:cls._counter+=1returncls._counter@classmethoddefreset(cls)->None:"""Resettheinternalcounterfordeterministictestruns."""cls._counter=0#───Users──────────────────────────────────────────────@classmethoddefuser(cls,**overrides:Any)->dict[str,Any]:"""Createarealisticuserdict."""idx=cls._next_id()defaults={"id":idx,"email":f"user{idx}@acme-corp.com","name":f"TestUser{idx}","api_key_hash":hashlib.sha256(f"sk-test-{idx}".encode()).hexdigest(),"is_admin":False,"status":"active","personal_quota":10000.0,"used_tokens":0.0,"team_id":None,"created_at":datetime.now(timezone.utc).isoformat(),}defaults.update(overrides)returndefaults@classmethoddefadmin_user(cls,**overrides:Any)->dict[str,Any]:"""Createanadminuserdict."""returncls.user(is_admin=True,name=f"Admin{cls._counter}",**overrides)@classmethoddefusers(cls,count:int=5,**overrides:Any)->list[dict[str,Any]]:"""Createmultipleusers."""return[cls.user(**overrides)for_inrange(count)]#───APIKeys───────────────────────────────────────────@classmethoddefapi_key(cls,prefix:str="sk-alfred")->tuple[str,str]:"""GeneratearealisticAPIkeyanditshash.Returns(plaintext_key,sha256_hash)."""random_part="".join(secrets.choice(string.ascii_letters+string.digits)for_inrange(48))key=f"{prefix}-{random_part}"key_hash=hashlib.sha256(key.encode()).hexdigest()returnkey,key_hash@classmethoddefauth_header(cls,key:str|None=None)->dict[str,str]:"""CreateanAuthorizationheaderdict."""ifkeyisNone:key,_=cls.api_key()return{"Authorization":f"Bearer{key}"}#───Teams──────────────────────────────────────────────@classmethoddefteam(cls,**overrides:Any)->dict[str,Any]:"""Createarealisticteamdict."""idx=cls._next_id()defaults={"id":idx,"name":f"EngineeringTeam{idx}","vacation_share_percentage":10.0,"common_pool":50000.0,"used_pool":0.0,"created_at":datetime.now(timezone.utc).isoformat(),}defaults.update(overrides)returndefaults@classmethoddefteams(cls,count:int=3,**overrides:Any)->list[dict[str,Any]]:"""Createmultipleteams."""return[cls.team(**overrides)for_inrange(count)]#───Wallets────────────────────────────────────────────@classmethoddefwallet(cls,**overrides:Any)->dict[str,Any]:"""Createawalletdictwithhard/softlimits."""idx=cls._next_id()defaults={"id":idx,"owner_type":"user","owner_id":idx,"balance":10000.0,"hard_limit":15000.0,"soft_limit":12000.0,"currency":"credits","status":"active","created_at":datetime.now(timezone.utc).isoformat(),}defaults.update(overrides)returndefaults@classmethoddefteam_wallet(cls,team_id:int=1,**overrides:Any)->dict[str,Any]:"""Createateam-scopedwallet."""returncls.wallet(owner_type="team",owner_id=team_id,balance=50000.0,**overrides)#───Transactions───────────────────────────────────────@classmethoddeftransaction(cls,**overrides:Any)->dict[str,Any]:"""Createaledgertransactiondict."""idx=cls._next_id()defaults={"id":str(uuid.uuid4()),"user_id":1,"wallet_id":1,"amount":-2.5,"balance_after":9997.5,"type":"deduction","model":"gpt-4o","provider":"openai","prompt_tokens":150,"completion_tokens":80,"total_tokens":230,"request_id":f"req-{uuid.uuid4().hex[:12]}","created_at":datetime.now(timezone.utc).isoformat(),}defaults.update(overrides)returndefaults@classmethoddeftransactions(cls,count:int=10,user_id:int=1,**overrides:Any,)->list[dict[str,Any]]:"""Createasequenceoftransactionswithrealisticprogression."""txns=[]balance=overrides.pop("starting_balance",10000.0)foriinrange(count):amount=round(-((i+1)*0.5+1.0),2)balance=round(balance+amount,2)txn=cls.transaction(user_id=user_id,amount=amount,balance_after=balance,created_at=(datetime.now(timezone.utc)-timedelta(hours=count-i)).isoformat(),**overrides,)txns.append(txn)returntxns#───ChatRequests(OpenAI-compatible)──────────────────@classmethoddefchat_request(cls,**overrides:Any)->dict[str,Any]:"""CreateanOpenAI-compatiblechatcompletionrequest."""defaults={"model":"gpt-4o","messages":[{"role":"system","content":"Youareahelpfulassistant."},{"role":"user","content":"WhatisthecapitalofFrance?"},],"temperature":0.7,"max_tokens":256,"stream":False,}defaults.update(overrides)returndefaults@classmethoddefstreaming_chat_request(cls,**overrides:Any)->dict[str,Any]:"""Createastreamingchatrequest."""returncls.chat_request(stream=True,**overrides)@classmethoddefchat_request_with_tools(cls,**overrides:Any)->dict[str,Any]:"""Createachatrequestwithfunctioncallingtools."""tools=[{"type":"function","function":{"name":"get_weather","description":"Getthecurrentweatherinalocation","parameters":{"type":"object","properties":{"location":{"type":"string","description":"Cityname,e.g.SanFrancisco,CA",},"unit":{"type":"string","enum":["celsius","fahrenheit"],},},"required":["location"],},},}]returncls.chat_request(tools=tools,**overrides)@classmethoddefmulti_turn_conversation(cls,turns:int=4,**overrides:Any)->dict[str,Any]:"""Createamulti-turnconversationrequest."""messages=[{"role":"system","content":"Youareahelpfulcodingassistant."}]user_msgs=["HowdoIcreateaRESTAPIinPython?","Canyouaddauthenticationtoit?","Howaboutratelimiting?","Nowaddtestsforeverything.","Whataboutdeployment?","HowdoImonitoritinproduction?",]assistant_msgs=["YoucanuseFastAPItocreateaRESTAPI...","Forauthentication,IrecommendJWTtokens...","Youcanuseslowapioracustommiddleware...","Here'sapytestsetupforyourAPI...","IrecommendDocker+Kubernetes...","UsePrometheus+Grafanaformetrics...",]foriinrange(min(turns,len(user_msgs))):messages.append({"role":"user","content":user_msgs[i]})ifi<turns-1:messages.append({"role":"assistant","content":assistant_msgs[i]})returncls.chat_request(messages=messages,**overrides)#───EmbeddingRequests─────────────────────────────────@classmethoddefembedding_request(cls,**overrides:Any)->dict[str,Any]:"""CreateanOpenAI-compatibleembeddingsrequest."""defaults={"model":"text-embedding-ada-002","input":"AlfredisanenterpriseAIcreditgovernanceplatform.",}defaults.update(overrides)returndefaults@classmethoddefbatch_embedding_request(cls,count:int=5,**overrides:Any)->dict[str,Any]:"""Createabatchembeddingsrequestwithmultipleinputs."""inputs=["AlfredmanagestokenquotasacrossLLMproviders.","Semanticcachingreducescostsby30%.","Wallethardlimitsblockrequestswhenreached.","Circuitbreakerauto-suspendsonspikedetection.","Intentroutingclassifiesrequestpurpose.","Immutableauditlogsusecryptographichashchains.","Failoverreroutestrafficfromdegradedproviders.","Ratelimitingisappliedatthegatewaylevel.",]returncls.embedding_request(input=inputs[:count],**overrides)#───ChatResponses(formocking)──────────────────────@classmethoddefchat_response(cls,**overrides:Any)->dict[str,Any]:"""Createarealisticchatcompletionresponseformocking."""defaults={"id":f"chatcmpl-{uuid.uuid4().hex[:24]}","object":"chat.completion","created":int(datetime.now(timezone.utc).timestamp()),"model":"gpt-4o-2024-08-06","choices":[{"index":0,"message":{"role":"assistant","content":"ThecapitalofFranceisParis.",},"finish_reason":"stop",}],"usage":{"prompt_tokens":25,"completion_tokens":8,"total_tokens":33,},}defaults.update(overrides)returndefaults@classmethoddefembedding_response(cls,dimensions:int=1536,**overrides:Any)->dict[str,Any]:"""Createarealisticembeddingsresponseformocking."""defaults={"object":"list","data":[{"object":"embedding","index":0,"embedding":[0.001]*dimensions,}],"model":"text-embedding-ada-002","usage":{"prompt_tokens":8,"total_tokens":8},}defaults.update(overrides)returndefaults#───ProviderConfigs───────────────────────────────────@classmethoddefprovider_config(cls,name:str="openai",**overrides:Any)->dict[str,Any]:"""Createaproviderconfigurationdict."""configs={"openai":{"name":"openai","base_url":"https://api.openai.com/v1","api_key":"sk-test-openai-key","models":["gpt-4o","gpt-4o-mini","gpt-3.5-turbo"],"timeout_seconds":30,"max_retries":2,"supports_streaming":True,"supports_tools":True,},"anthropic":{"name":"anthropic","base_url":"https://api.anthropic.com/v1","api_key":"sk-ant-test-key","models":["claude-3-opus-20240229","claude-3-sonnet-20240229","claude-3-haiku-20240307"],"timeout_seconds":60,"max_retries":2,"supports_streaming":True,"supports_tools":True,},"google":{"name":"google","base_url":"https://generativelanguage.googleapis.com/v1","api_key":"test-google-key","models":["gemini-pro","gemini-1.5-pro"],"timeout_seconds":30,"max_retries":1,"supports_streaming":True,"supports_tools":False,},}config=configs.get(name,configs["openai"]).copy()config.update(overrides)returnconfig#───AuditLogEntries──────────────────────────────────@classmethoddefaudit_entry(cls,**overrides:Any)->dict[str,Any]:"""Createanauditlogentrydict."""idx=cls._next_id()defaults={"id":idx,"event_type":"DEDUCTION","user_id":1,"resource_type":"wallet","resource_id":"1","action":"credit_deduction","details":{"model":"gpt-4o","tokens":230,"cost":2.5,"request_id":f"req-{uuid.uuid4().hex[:12]}",},"ip_address":"10.0.0.1","user_agent":"python-requests/2.31.0","created_at":datetime.now(timezone.utc).isoformat(),"previous_hash":hashlib.sha256(f"prev-{idx}".encode()).hexdigest(),}defaults.update(overrides)returndefaults#───Policy/RoutingRules─────────────────────────────@classmethoddefrouting_rule(cls,**overrides:Any)->dict[str,Any]:"""Createaroutingruledict."""idx=cls._next_id()defaults={"id":idx,"name":f"route-rule-{idx}","priority":100,"conditions":{"model_pattern":"gpt-*","team_id":None,"min_tokens":0,},"action":{"provider":"openai","fallback_provider":"anthropic","timeout_override":None,},"enabled":True,}defaults.update(overrides)returndefaults@classmethoddefpolicy(cls,**overrides:Any)->dict[str,Any]:"""CreateanOPA-compatiblepolicydict."""idx=cls._next_id()defaults={"id":idx,"name":f"policy-{idx}","description":f"Testpolicy{idx}","rego":'packagealfred\ndefaultallow=true',"enabled":True,"created_at":datetime.now(timezone.utc).isoformat(),}defaults.update(overrides)returndefaults